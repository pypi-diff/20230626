# Comparing `tmp/callisto-jupyter-d1-0.0.7.tar.gz` & `tmp/callisto-jupyter-d1-0.0.9.tar.gz`

## filetype from file(1)

```diff
@@ -1 +1 @@
-gzip compressed data, was "callisto-jupyter-d1-0.0.7.tar", last modified: Sat Aug 13 19:11:04 2022, max compression
+gzip compressed data, was "callisto-jupyter-d1-0.0.9.tar", last modified: Mon Oct 31 16:11:58 2022, max compression
```

## Comparing `callisto-jupyter-d1-0.0.7.tar` & `callisto-jupyter-d1-0.0.9.tar`

### file list

```diff
@@ -1,103 +1,116 @@
-drwxr-xr-x   0 teamcity  (1001) teamcity  (1001)        0 2022-08-13 19:11:04.528177 callisto-jupyter-d1-0.0.7/
--rw-r--r--   0 teamcity  (1001) teamcity  (1001)     5576 2022-08-13 19:11:04.528177 callisto-jupyter-d1-0.0.7/PKG-INFO
--rw-r--r--   0 teamcity  (1001) teamcity  (1001)     5130 2022-04-28 17:18:02.000000 callisto-jupyter-d1-0.0.7/README.md
-drwxr-xr-x   0 teamcity  (1001) teamcity  (1001)        0 2022-08-13 19:11:04.524177 callisto-jupyter-d1-0.0.7/callisto_jupyter_d1.egg-info/
--rw-r--r--   0 teamcity  (1001) teamcity  (1001)     5576 2022-08-13 19:11:04.000000 callisto-jupyter-d1-0.0.7/callisto_jupyter_d1.egg-info/PKG-INFO
--rw-r--r--   0 teamcity  (1001) teamcity  (1001)     2810 2022-08-13 19:11:04.000000 callisto-jupyter-d1-0.0.7/callisto_jupyter_d1.egg-info/SOURCES.txt
--rw-r--r--   0 teamcity  (1001) teamcity  (1001)        1 2022-08-13 19:11:04.000000 callisto-jupyter-d1-0.0.7/callisto_jupyter_d1.egg-info/dependency_links.txt
--rw-r--r--   0 teamcity  (1001) teamcity  (1001)      472 2022-08-13 19:11:04.000000 callisto-jupyter-d1-0.0.7/callisto_jupyter_d1.egg-info/requires.txt
--rw-r--r--   0 teamcity  (1001) teamcity  (1001)       11 2022-08-13 19:11:04.000000 callisto-jupyter-d1-0.0.7/callisto_jupyter_d1.egg-info/top_level.txt
-drwxr-xr-x   0 teamcity  (1001) teamcity  (1001)        0 2022-08-13 19:11:04.524177 callisto-jupyter-d1-0.0.7/jupyter_d1/
--rw-r--r--   0 teamcity  (1001) teamcity  (1001)      116 2022-07-25 16:30:25.000000 callisto-jupyter-d1-0.0.7/jupyter_d1/__init__.py
--rw-r--r--   0 teamcity  (1001) teamcity  (1001)      787 2022-04-28 17:18:02.000000 callisto-jupyter-d1-0.0.7/jupyter_d1/commands.py
--rw-r--r--   0 teamcity  (1001) teamcity  (1001)     1290 2022-08-04 01:55:05.000000 callisto-jupyter-d1-0.0.7/jupyter_d1/d1_response.py
--rw-r--r--   0 teamcity  (1001) teamcity  (1001)     7831 2022-08-04 01:55:05.000000 callisto-jupyter-d1-0.0.7/jupyter_d1/dav.py
--rw-r--r--   0 teamcity  (1001) teamcity  (1001)     1815 2022-08-04 01:55:05.000000 callisto-jupyter-d1-0.0.7/jupyter_d1/dav_auth.py
--rw-r--r--   0 teamcity  (1001) teamcity  (1001)     3170 2022-04-28 17:18:02.000000 callisto-jupyter-d1-0.0.7/jupyter_d1/deps.py
-drwxr-xr-x   0 teamcity  (1001) teamcity  (1001)        0 2022-08-13 19:11:04.524177 callisto-jupyter-d1-0.0.7/jupyter_d1/kernels/
--rw-r--r--   0 teamcity  (1001) teamcity  (1001)      513 2022-04-28 17:18:02.000000 callisto-jupyter-d1-0.0.7/jupyter_d1/kernels/__init__.py
--rw-r--r--   0 teamcity  (1001) teamcity  (1001)      479 2022-06-02 16:30:42.000000 callisto-jupyter-d1-0.0.7/jupyter_d1/kernels/kernel_definition.py
-drwxr-xr-x   0 teamcity  (1001) teamcity  (1001)        0 2022-08-13 19:11:04.524177 callisto-jupyter-d1-0.0.7/jupyter_d1/kernels/python/
--rw-r--r--   0 teamcity  (1001) teamcity  (1001)      727 2022-06-02 16:30:42.000000 callisto-jupyter-d1-0.0.7/jupyter_d1/kernels/python/__init__.py
-drwxr-xr-x   0 teamcity  (1001) teamcity  (1001)        0 2022-08-13 19:11:04.524177 callisto-jupyter-d1-0.0.7/jupyter_d1/kernels/python/startup/
--rw-r--r--   0 teamcity  (1001) teamcity  (1001)        0 2022-06-06 22:30:03.000000 callisto-jupyter-d1-0.0.7/jupyter_d1/kernels/python/startup/__init__.py
--rw-r--r--   0 teamcity  (1001) teamcity  (1001)      110 2022-06-02 16:30:42.000000 callisto-jupyter-d1-0.0.7/jupyter_d1/kernels/python/startup/callisto_startup.py
--rw-r--r--   0 teamcity  (1001) teamcity  (1001)     2658 2022-05-19 20:47:01.000000 callisto-jupyter-d1-0.0.7/jupyter_d1/kernels/python/vars_manager.py
--rw-r--r--   0 teamcity  (1001) teamcity  (1001)      772 2022-04-28 17:18:02.000000 callisto-jupyter-d1-0.0.7/jupyter_d1/kernels/python/workdir_manager.py
-drwxr-xr-x   0 teamcity  (1001) teamcity  (1001)        0 2022-08-13 19:11:04.524177 callisto-jupyter-d1-0.0.7/jupyter_d1/kernels/r/
--rw-r--r--   0 teamcity  (1001) teamcity  (1001)      440 2022-04-28 17:18:02.000000 callisto-jupyter-d1-0.0.7/jupyter_d1/kernels/r/__init__.py
--rw-r--r--   0 teamcity  (1001) teamcity  (1001)     3718 2022-05-19 20:47:01.000000 callisto-jupyter-d1-0.0.7/jupyter_d1/kernels/r/vars_manager.py
--rw-r--r--   0 teamcity  (1001) teamcity  (1001)      731 2022-04-28 17:18:02.000000 callisto-jupyter-d1-0.0.7/jupyter_d1/kernels/r/workdir_manager.py
--rw-r--r--   0 teamcity  (1001) teamcity  (1001)     1204 2022-05-12 19:45:30.000000 callisto-jupyter-d1-0.0.7/jupyter_d1/kernels/vars_manager.py
--rw-r--r--   0 teamcity  (1001) teamcity  (1001)      981 2022-04-28 17:18:02.000000 callisto-jupyter-d1-0.0.7/jupyter_d1/kernels/workdir_manager.py
-drwxr-xr-x   0 teamcity  (1001) teamcity  (1001)        0 2022-08-13 19:11:04.524177 callisto-jupyter-d1-0.0.7/jupyter_d1/kernels/zsh/
--rw-r--r--   0 teamcity  (1001) teamcity  (1001)      452 2022-04-28 17:18:02.000000 callisto-jupyter-d1-0.0.7/jupyter_d1/kernels/zsh/__init__.py
--rw-r--r--   0 teamcity  (1001) teamcity  (1001)     1208 2022-05-12 19:45:30.000000 callisto-jupyter-d1-0.0.7/jupyter_d1/kernels/zsh/vars_manager.py
--rw-r--r--   0 teamcity  (1001) teamcity  (1001)      688 2022-04-28 17:18:02.000000 callisto-jupyter-d1-0.0.7/jupyter_d1/kernels/zsh/workdir_manager.py
--rw-r--r--   0 teamcity  (1001) teamcity  (1001)     4152 2022-08-11 21:20:20.000000 callisto-jupyter-d1-0.0.7/jupyter_d1/main.py
-drwxr-xr-x   0 teamcity  (1001) teamcity  (1001)        0 2022-08-13 19:11:04.528177 callisto-jupyter-d1-0.0.7/jupyter_d1/models/
--rw-r--r--   0 teamcity  (1001) teamcity  (1001)      224 2022-04-28 17:18:02.000000 callisto-jupyter-d1-0.0.7/jupyter_d1/models/JSONType.py
--rw-r--r--   0 teamcity  (1001) teamcity  (1001)        0 2022-04-28 17:18:02.000000 callisto-jupyter-d1-0.0.7/jupyter_d1/models/__init__.py
--rw-r--r--   0 teamcity  (1001) teamcity  (1001)       72 2022-04-28 17:18:02.000000 callisto-jupyter-d1-0.0.7/jupyter_d1/models/base_wrapper.py
--rw-r--r--   0 teamcity  (1001) teamcity  (1001)      696 2022-04-28 17:18:02.000000 callisto-jupyter-d1-0.0.7/jupyter_d1/models/cell.py
--rw-r--r--   0 teamcity  (1001) teamcity  (1001)      149 2022-04-28 17:18:02.000000 callisto-jupyter-d1-0.0.7/jupyter_d1/models/code_complete.py
--rw-r--r--   0 teamcity  (1001) teamcity  (1001)      993 2022-04-28 17:18:02.000000 callisto-jupyter-d1-0.0.7/jupyter_d1/models/environment_info.py
--rw-r--r--   0 teamcity  (1001) teamcity  (1001)      143 2022-04-28 17:18:02.000000 callisto-jupyter-d1-0.0.7/jupyter_d1/models/execution_state.py
--rw-r--r--   0 teamcity  (1001) teamcity  (1001)     1014 2022-04-28 17:18:02.000000 callisto-jupyter-d1-0.0.7/jupyter_d1/models/kernel.py
--rw-r--r--   0 teamcity  (1001) teamcity  (1001)      311 2022-04-28 17:18:02.000000 callisto-jupyter-d1-0.0.7/jupyter_d1/models/kernel_message.py
--rw-r--r--   0 teamcity  (1001) teamcity  (1001)      477 2022-04-28 17:18:02.000000 callisto-jupyter-d1-0.0.7/jupyter_d1/models/kernel_spec.py
--rw-r--r--   0 teamcity  (1001) teamcity  (1001)      447 2022-05-12 19:45:30.000000 callisto-jupyter-d1-0.0.7/jupyter_d1/models/kernel_variable.py
--rw-r--r--   0 teamcity  (1001) teamcity  (1001)      273 2022-04-28 17:18:02.000000 callisto-jupyter-d1-0.0.7/jupyter_d1/models/notebook.py
--rw-r--r--   0 teamcity  (1001) teamcity  (1001)      313 2022-04-28 17:18:02.000000 callisto-jupyter-d1-0.0.7/jupyter_d1/models/permission.py
--rw-r--r--   0 teamcity  (1001) teamcity  (1001)       77 2022-04-28 17:18:02.000000 callisto-jupyter-d1-0.0.7/jupyter_d1/models/scratch.py
--rw-r--r--   0 teamcity  (1001) teamcity  (1001)      883 2022-04-28 17:18:02.000000 callisto-jupyter-d1-0.0.7/jupyter_d1/models/server_stats.py
--rw-r--r--   0 teamcity  (1001) teamcity  (1001)      236 2022-04-28 17:18:02.000000 callisto-jupyter-d1-0.0.7/jupyter_d1/models/token.py
-drwxr-xr-x   0 teamcity  (1001) teamcity  (1001)        0 2022-08-13 19:11:04.528177 callisto-jupyter-d1-0.0.7/jupyter_d1/routers/
--rw-r--r--   0 teamcity  (1001) teamcity  (1001)        0 2022-04-28 17:18:02.000000 callisto-jupyter-d1-0.0.7/jupyter_d1/routers/__init__.py
--rw-r--r--   0 teamcity  (1001) teamcity  (1001)     1897 2022-08-04 01:55:05.000000 callisto-jupyter-d1-0.0.7/jupyter_d1/routers/convert.py
--rw-r--r--   0 teamcity  (1001) teamcity  (1001)      225 2022-04-28 17:18:02.000000 callisto-jupyter-d1-0.0.7/jupyter_d1/routers/hello.py
--rw-r--r--   0 teamcity  (1001) teamcity  (1001)     2013 2022-08-04 01:53:09.000000 callisto-jupyter-d1-0.0.7/jupyter_d1/routers/kernels.py
--rw-r--r--   0 teamcity  (1001) teamcity  (1001)     1687 2022-04-28 17:18:02.000000 callisto-jupyter-d1-0.0.7/jupyter_d1/routers/login.py
--rw-r--r--   0 teamcity  (1001) teamcity  (1001)    28239 2022-08-11 19:07:59.000000 callisto-jupyter-d1-0.0.7/jupyter_d1/routers/notebooks.py
--rw-r--r--   0 teamcity  (1001) teamcity  (1001)     1353 2022-08-04 01:55:05.000000 callisto-jupyter-d1-0.0.7/jupyter_d1/routers/rclone.py
--rw-r--r--   0 teamcity  (1001) teamcity  (1001)     3613 2022-06-14 13:50:52.000000 callisto-jupyter-d1-0.0.7/jupyter_d1/routers/server.py
--rw-r--r--   0 teamcity  (1001) teamcity  (1001)      631 2022-04-28 17:18:02.000000 callisto-jupyter-d1-0.0.7/jupyter_d1/security.py
--rw-r--r--   0 teamcity  (1001) teamcity  (1001)     6701 2022-07-13 14:35:24.000000 callisto-jupyter-d1-0.0.7/jupyter_d1/settings.py
-drwxr-xr-x   0 teamcity  (1001) teamcity  (1001)        0 2022-08-13 19:11:04.528177 callisto-jupyter-d1-0.0.7/jupyter_d1/signals/
--rw-r--r--   0 teamcity  (1001) teamcity  (1001)     4725 2022-05-25 19:15:08.000000 callisto-jupyter-d1-0.0.7/jupyter_d1/signals/__init__.py
-drwxr-xr-x   0 teamcity  (1001) teamcity  (1001)        0 2022-08-13 19:11:04.528177 callisto-jupyter-d1-0.0.7/jupyter_d1/storage/
--rw-r--r--   0 teamcity  (1001) teamcity  (1001)      597 2022-04-28 17:18:02.000000 callisto-jupyter-d1-0.0.7/jupyter_d1/storage/__init__.py
--rw-r--r--   0 teamcity  (1001) teamcity  (1001)     4160 2022-06-14 13:50:52.000000 callisto-jupyter-d1-0.0.7/jupyter_d1/storage/environment_dump.py
--rw-r--r--   0 teamcity  (1001) teamcity  (1001)     2565 2022-08-04 01:55:05.000000 callisto-jupyter-d1-0.0.7/jupyter_d1/storage/kernel_listener.py
--rw-r--r--   0 teamcity  (1001) teamcity  (1001)     1418 2022-06-14 13:50:52.000000 callisto-jupyter-d1-0.0.7/jupyter_d1/storage/kernel_logger.py
--rw-r--r--   0 teamcity  (1001) teamcity  (1001)     4196 2022-08-04 01:55:05.000000 callisto-jupyter-d1-0.0.7/jupyter_d1/storage/kernel_manager.py
--rw-r--r--   0 teamcity  (1001) teamcity  (1001)    43421 2022-08-11 19:00:50.000000 callisto-jupyter-d1-0.0.7/jupyter_d1/storage/notebook_manager.py
--rw-r--r--   0 teamcity  (1001) teamcity  (1001)     4807 2022-05-06 13:40:15.000000 callisto-jupyter-d1-0.0.7/jupyter_d1/storage/notebook_validator.py
--rw-r--r--   0 teamcity  (1001) teamcity  (1001)     4382 2022-08-04 01:55:05.000000 callisto-jupyter-d1-0.0.7/jupyter_d1/storage/stats_manager.py
-drwxr-xr-x   0 teamcity  (1001) teamcity  (1001)        0 2022-08-13 19:11:04.528177 callisto-jupyter-d1-0.0.7/jupyter_d1/tests/
--rw-r--r--   0 teamcity  (1001) teamcity  (1001)        0 2022-05-25 14:50:24.000000 callisto-jupyter-d1-0.0.7/jupyter_d1/tests/__init__.py
--rw-r--r--   0 teamcity  (1001) teamcity  (1001)     3495 2022-08-04 01:53:09.000000 callisto-jupyter-d1-0.0.7/jupyter_d1/tests/conftest.py
--rw-r--r--   0 teamcity  (1001) teamcity  (1001)      832 2022-05-25 14:50:24.000000 callisto-jupyter-d1-0.0.7/jupyter_d1/tests/test_commands.py
--rw-r--r--   0 teamcity  (1001) teamcity  (1001)     2843 2022-08-04 01:55:05.000000 callisto-jupyter-d1-0.0.7/jupyter_d1/tests/test_convert.py
--rw-r--r--   0 teamcity  (1001) teamcity  (1001)    23464 2022-08-04 01:55:05.000000 callisto-jupyter-d1-0.0.7/jupyter_d1/tests/test_dav.py
--rw-r--r--   0 teamcity  (1001) teamcity  (1001)      412 2022-05-25 14:50:24.000000 callisto-jupyter-d1-0.0.7/jupyter_d1/tests/test_hello.py
--rw-r--r--   0 teamcity  (1001) teamcity  (1001)     3633 2022-08-04 03:31:25.000000 callisto-jupyter-d1-0.0.7/jupyter_d1/tests/test_kernels.py
--rw-r--r--   0 teamcity  (1001) teamcity  (1001)     1003 2022-08-04 01:55:05.000000 callisto-jupyter-d1-0.0.7/jupyter_d1/tests/test_login.py
--rw-r--r--   0 teamcity  (1001) teamcity  (1001)    59705 2022-08-11 22:55:49.000000 callisto-jupyter-d1-0.0.7/jupyter_d1/tests/test_notebooks.py
--rw-r--r--   0 teamcity  (1001) teamcity  (1001)   132054 2022-08-11 23:02:17.000000 callisto-jupyter-d1-0.0.7/jupyter_d1/tests/test_notebooks_websocket.py
--rw-r--r--   0 teamcity  (1001) teamcity  (1001)     3701 2022-08-04 01:53:09.000000 callisto-jupyter-d1-0.0.7/jupyter_d1/tests/test_rclone.py
--rw-r--r--   0 teamcity  (1001) teamcity  (1001)      330 2022-05-25 14:50:24.000000 callisto-jupyter-d1-0.0.7/jupyter_d1/tests/test_settings.py
--rw-r--r--   0 teamcity  (1001) teamcity  (1001)     8347 2022-08-04 01:55:05.000000 callisto-jupyter-d1-0.0.7/jupyter_d1/tests/test_stats.py
--rw-r--r--   0 teamcity  (1001) teamcity  (1001)    13023 2022-05-25 14:50:24.000000 callisto-jupyter-d1-0.0.7/jupyter_d1/tests/test_undo.py
--rw-r--r--   0 teamcity  (1001) teamcity  (1001)     4691 2022-05-25 14:50:24.000000 callisto-jupyter-d1-0.0.7/jupyter_d1/tests/test_undo_manager.py
--rw-r--r--   0 teamcity  (1001) teamcity  (1001)     4821 2022-08-11 22:55:49.000000 callisto-jupyter-d1-0.0.7/jupyter_d1/tests/utils.py
-drwxr-xr-x   0 teamcity  (1001) teamcity  (1001)        0 2022-08-13 19:11:04.528177 callisto-jupyter-d1-0.0.7/jupyter_d1/undo_manager/
--rw-r--r--   0 teamcity  (1001) teamcity  (1001)       79 2022-04-28 17:18:02.000000 callisto-jupyter-d1-0.0.7/jupyter_d1/undo_manager/__init__.py
--rw-r--r--   0 teamcity  (1001) teamcity  (1001)     5105 2022-04-28 17:18:02.000000 callisto-jupyter-d1-0.0.7/jupyter_d1/undo_manager/undo_manager.py
--rw-r--r--   0 teamcity  (1001) teamcity  (1001)     1622 2022-08-04 01:55:05.000000 callisto-jupyter-d1-0.0.7/jupyter_d1/utils.py
--rw-r--r--   0 teamcity  (1001) teamcity  (1001)      462 2022-08-04 01:55:05.000000 callisto-jupyter-d1-0.0.7/jupyter_d1/uvicorn_worker.py
--rw-r--r--   0 teamcity  (1001) teamcity  (1001)       93 2022-04-28 17:18:02.000000 callisto-jupyter-d1-0.0.7/jupyter_d1_install_kernels
--rw-r--r--   0 teamcity  (1001) teamcity  (1001)       39 2022-04-28 17:18:02.000000 callisto-jupyter-d1-0.0.7/jupyter_d1_test
--rw-r--r--   0 teamcity  (1001) teamcity  (1001)       38 2022-08-13 19:11:04.528177 callisto-jupyter-d1-0.0.7/setup.cfg
--rw-r--r--   0 teamcity  (1001) teamcity  (1001)     1475 2022-08-12 17:18:02.000000 callisto-jupyter-d1-0.0.7/setup.py
--rwxr-xr-x   0 teamcity  (1001) teamcity  (1001)     2398 2022-08-04 01:53:09.000000 callisto-jupyter-d1-0.0.7/start_jupyter_d1
+drwxr-xr-x   0 teamcity  (1001) teamcity  (1001)        0 2022-10-31 16:11:58.970027 callisto-jupyter-d1-0.0.9/
+-rw-r--r--   0 teamcity  (1001) teamcity  (1001)     5580 2022-10-31 16:11:58.970027 callisto-jupyter-d1-0.0.9/PKG-INFO
+-rw-r--r--   0 teamcity  (1001) teamcity  (1001)     5134 2022-10-11 21:17:53.000000 callisto-jupyter-d1-0.0.9/README.md
+drwxr-xr-x   0 teamcity  (1001) teamcity  (1001)        0 2022-10-31 16:11:58.962027 callisto-jupyter-d1-0.0.9/callisto_jupyter_d1.egg-info/
+-rw-r--r--   0 teamcity  (1001) teamcity  (1001)     5580 2022-10-31 16:11:58.000000 callisto-jupyter-d1-0.0.9/callisto_jupyter_d1.egg-info/PKG-INFO
+-rw-r--r--   0 teamcity  (1001) teamcity  (1001)     3208 2022-10-31 16:11:58.000000 callisto-jupyter-d1-0.0.9/callisto_jupyter_d1.egg-info/SOURCES.txt
+-rw-r--r--   0 teamcity  (1001) teamcity  (1001)        1 2022-10-31 16:11:58.000000 callisto-jupyter-d1-0.0.9/callisto_jupyter_d1.egg-info/dependency_links.txt
+-rw-r--r--   0 teamcity  (1001) teamcity  (1001)      496 2022-10-31 16:11:58.000000 callisto-jupyter-d1-0.0.9/callisto_jupyter_d1.egg-info/requires.txt
+-rw-r--r--   0 teamcity  (1001) teamcity  (1001)       11 2022-10-31 16:11:58.000000 callisto-jupyter-d1-0.0.9/callisto_jupyter_d1.egg-info/top_level.txt
+drwxr-xr-x   0 teamcity  (1001) teamcity  (1001)        0 2022-10-31 16:11:58.962027 callisto-jupyter-d1-0.0.9/jupyter_d1/
+-rw-r--r--   0 teamcity  (1001) teamcity  (1001)      193 2022-10-12 12:50:15.000000 callisto-jupyter-d1-0.0.9/jupyter_d1/__init__.py
+-rw-r--r--   0 teamcity  (1001) teamcity  (1001)      787 2022-04-28 17:18:02.000000 callisto-jupyter-d1-0.0.9/jupyter_d1/commands.py
+-rw-r--r--   0 teamcity  (1001) teamcity  (1001)     1290 2022-08-04 01:55:05.000000 callisto-jupyter-d1-0.0.9/jupyter_d1/d1_response.py
+-rw-r--r--   0 teamcity  (1001) teamcity  (1001)     7835 2022-08-19 14:12:02.000000 callisto-jupyter-d1-0.0.9/jupyter_d1/dav.py
+-rw-r--r--   0 teamcity  (1001) teamcity  (1001)     1815 2022-08-04 01:55:05.000000 callisto-jupyter-d1-0.0.9/jupyter_d1/dav_auth.py
+drwxr-xr-x   0 teamcity  (1001) teamcity  (1001)        0 2022-10-31 16:11:58.966027 callisto-jupyter-d1-0.0.9/jupyter_d1/dependency/
+-rw-r--r--   0 teamcity  (1001) teamcity  (1001)      720 2022-09-19 17:29:14.000000 callisto-jupyter-d1-0.0.9/jupyter_d1/dependency/__init__.py
+-rw-r--r--   0 teamcity  (1001) teamcity  (1001)      709 2022-09-19 17:29:14.000000 callisto-jupyter-d1-0.0.9/jupyter_d1/dependency/dependency_manager.py
+drwxr-xr-x   0 teamcity  (1001) teamcity  (1001)        0 2022-10-31 16:11:58.966027 callisto-jupyter-d1-0.0.9/jupyter_d1/dependency/python/
+-rw-r--r--   0 teamcity  (1001) teamcity  (1001)       64 2022-08-15 20:30:15.000000 callisto-jupyter-d1-0.0.9/jupyter_d1/dependency/python/__init__.py
+-rw-r--r--   0 teamcity  (1001) teamcity  (1001)     8133 2022-10-11 13:55:30.000000 callisto-jupyter-d1-0.0.9/jupyter_d1/dependency/python/dependency_manager.py
+-rw-r--r--   0 teamcity  (1001) teamcity  (1001)     3170 2022-04-28 17:18:02.000000 callisto-jupyter-d1-0.0.9/jupyter_d1/deps.py
+drwxr-xr-x   0 teamcity  (1001) teamcity  (1001)        0 2022-10-31 16:11:58.966027 callisto-jupyter-d1-0.0.9/jupyter_d1/kernels/
+-rw-r--r--   0 teamcity  (1001) teamcity  (1001)      513 2022-04-28 17:18:02.000000 callisto-jupyter-d1-0.0.9/jupyter_d1/kernels/__init__.py
+-rw-r--r--   0 teamcity  (1001) teamcity  (1001)      565 2022-08-22 16:51:57.000000 callisto-jupyter-d1-0.0.9/jupyter_d1/kernels/kernel_definition.py
+drwxr-xr-x   0 teamcity  (1001) teamcity  (1001)        0 2022-10-31 16:11:58.966027 callisto-jupyter-d1-0.0.9/jupyter_d1/kernels/python/
+-rw-r--r--   0 teamcity  (1001) teamcity  (1001)      800 2022-08-22 16:51:57.000000 callisto-jupyter-d1-0.0.9/jupyter_d1/kernels/python/__init__.py
+drwxr-xr-x   0 teamcity  (1001) teamcity  (1001)        0 2022-10-31 16:11:58.966027 callisto-jupyter-d1-0.0.9/jupyter_d1/kernels/python/startup/
+-rw-r--r--   0 teamcity  (1001) teamcity  (1001)        0 2022-06-06 22:30:03.000000 callisto-jupyter-d1-0.0.9/jupyter_d1/kernels/python/startup/__init__.py
+-rw-r--r--   0 teamcity  (1001) teamcity  (1001)      110 2022-06-02 16:30:42.000000 callisto-jupyter-d1-0.0.9/jupyter_d1/kernels/python/startup/callisto_startup.py
+-rw-r--r--   0 teamcity  (1001) teamcity  (1001)     2913 2022-08-17 14:54:16.000000 callisto-jupyter-d1-0.0.9/jupyter_d1/kernels/python/vars_manager.py
+-rw-r--r--   0 teamcity  (1001) teamcity  (1001)      772 2022-04-28 17:18:02.000000 callisto-jupyter-d1-0.0.9/jupyter_d1/kernels/python/workdir_manager.py
+drwxr-xr-x   0 teamcity  (1001) teamcity  (1001)        0 2022-10-31 16:11:58.966027 callisto-jupyter-d1-0.0.9/jupyter_d1/kernels/r/
+-rw-r--r--   0 teamcity  (1001) teamcity  (1001)      513 2022-08-22 16:51:57.000000 callisto-jupyter-d1-0.0.9/jupyter_d1/kernels/r/__init__.py
+-rw-r--r--   0 teamcity  (1001) teamcity  (1001)     3769 2022-08-17 14:54:16.000000 callisto-jupyter-d1-0.0.9/jupyter_d1/kernels/r/vars_manager.py
+-rw-r--r--   0 teamcity  (1001) teamcity  (1001)      731 2022-04-28 17:18:02.000000 callisto-jupyter-d1-0.0.9/jupyter_d1/kernels/r/workdir_manager.py
+-rw-r--r--   0 teamcity  (1001) teamcity  (1001)     1255 2022-08-17 14:54:16.000000 callisto-jupyter-d1-0.0.9/jupyter_d1/kernels/vars_manager.py
+-rw-r--r--   0 teamcity  (1001) teamcity  (1001)      981 2022-04-28 17:18:02.000000 callisto-jupyter-d1-0.0.9/jupyter_d1/kernels/workdir_manager.py
+drwxr-xr-x   0 teamcity  (1001) teamcity  (1001)        0 2022-10-31 16:11:58.966027 callisto-jupyter-d1-0.0.9/jupyter_d1/kernels/zsh/
+-rw-r--r--   0 teamcity  (1001) teamcity  (1001)      525 2022-08-22 16:51:57.000000 callisto-jupyter-d1-0.0.9/jupyter_d1/kernels/zsh/__init__.py
+-rw-r--r--   0 teamcity  (1001) teamcity  (1001)     1259 2022-08-17 14:54:16.000000 callisto-jupyter-d1-0.0.9/jupyter_d1/kernels/zsh/vars_manager.py
+-rw-r--r--   0 teamcity  (1001) teamcity  (1001)      688 2022-04-28 17:18:02.000000 callisto-jupyter-d1-0.0.9/jupyter_d1/kernels/zsh/workdir_manager.py
+-rw-r--r--   0 teamcity  (1001) teamcity  (1001)       57 2022-08-30 20:00:37.000000 callisto-jupyter-d1-0.0.9/jupyter_d1/logger.py
+-rw-r--r--   0 teamcity  (1001) teamcity  (1001)     4817 2022-09-19 17:29:14.000000 callisto-jupyter-d1-0.0.9/jupyter_d1/main.py
+drwxr-xr-x   0 teamcity  (1001) teamcity  (1001)        0 2022-10-31 16:11:58.966027 callisto-jupyter-d1-0.0.9/jupyter_d1/models/
+-rw-r--r--   0 teamcity  (1001) teamcity  (1001)      224 2022-04-28 17:18:02.000000 callisto-jupyter-d1-0.0.9/jupyter_d1/models/JSONType.py
+-rw-r--r--   0 teamcity  (1001) teamcity  (1001)        0 2022-04-28 17:18:02.000000 callisto-jupyter-d1-0.0.9/jupyter_d1/models/__init__.py
+-rw-r--r--   0 teamcity  (1001) teamcity  (1001)       72 2022-04-28 17:18:02.000000 callisto-jupyter-d1-0.0.9/jupyter_d1/models/base_wrapper.py
+-rw-r--r--   0 teamcity  (1001) teamcity  (1001)      696 2022-04-28 17:18:02.000000 callisto-jupyter-d1-0.0.9/jupyter_d1/models/cell.py
+-rw-r--r--   0 teamcity  (1001) teamcity  (1001)      149 2022-04-28 17:18:02.000000 callisto-jupyter-d1-0.0.9/jupyter_d1/models/code_complete.py
+-rw-r--r--   0 teamcity  (1001) teamcity  (1001)      688 2022-09-19 17:29:14.000000 callisto-jupyter-d1-0.0.9/jupyter_d1/models/dependency.py
+-rw-r--r--   0 teamcity  (1001) teamcity  (1001)     1101 2022-10-12 12:50:15.000000 callisto-jupyter-d1-0.0.9/jupyter_d1/models/environment_info.py
+-rw-r--r--   0 teamcity  (1001) teamcity  (1001)      143 2022-04-28 17:18:02.000000 callisto-jupyter-d1-0.0.9/jupyter_d1/models/execution_state.py
+-rw-r--r--   0 teamcity  (1001) teamcity  (1001)     1014 2022-04-28 17:18:02.000000 callisto-jupyter-d1-0.0.9/jupyter_d1/models/kernel.py
+-rw-r--r--   0 teamcity  (1001) teamcity  (1001)      311 2022-04-28 17:18:02.000000 callisto-jupyter-d1-0.0.9/jupyter_d1/models/kernel_message.py
+-rw-r--r--   0 teamcity  (1001) teamcity  (1001)      492 2022-08-18 21:35:51.000000 callisto-jupyter-d1-0.0.9/jupyter_d1/models/kernel_spec.py
+-rw-r--r--   0 teamcity  (1001) teamcity  (1001)      499 2022-08-17 14:54:16.000000 callisto-jupyter-d1-0.0.9/jupyter_d1/models/kernel_variable.py
+-rw-r--r--   0 teamcity  (1001) teamcity  (1001)      273 2022-04-28 17:18:02.000000 callisto-jupyter-d1-0.0.9/jupyter_d1/models/notebook.py
+-rw-r--r--   0 teamcity  (1001) teamcity  (1001)      313 2022-04-28 17:18:02.000000 callisto-jupyter-d1-0.0.9/jupyter_d1/models/permission.py
+-rw-r--r--   0 teamcity  (1001) teamcity  (1001)       77 2022-04-28 17:18:02.000000 callisto-jupyter-d1-0.0.9/jupyter_d1/models/scratch.py
+-rw-r--r--   0 teamcity  (1001) teamcity  (1001)      883 2022-04-28 17:18:02.000000 callisto-jupyter-d1-0.0.9/jupyter_d1/models/server_stats.py
+-rw-r--r--   0 teamcity  (1001) teamcity  (1001)      236 2022-04-28 17:18:02.000000 callisto-jupyter-d1-0.0.9/jupyter_d1/models/token.py
+drwxr-xr-x   0 teamcity  (1001) teamcity  (1001)        0 2022-10-31 16:11:58.966027 callisto-jupyter-d1-0.0.9/jupyter_d1/routers/
+-rw-r--r--   0 teamcity  (1001) teamcity  (1001)        0 2022-04-28 17:18:02.000000 callisto-jupyter-d1-0.0.9/jupyter_d1/routers/__init__.py
+-rw-r--r--   0 teamcity  (1001) teamcity  (1001)     1897 2022-09-19 17:29:14.000000 callisto-jupyter-d1-0.0.9/jupyter_d1/routers/convert.py
+-rw-r--r--   0 teamcity  (1001) teamcity  (1001)     5070 2022-09-19 17:29:14.000000 callisto-jupyter-d1-0.0.9/jupyter_d1/routers/dependencies.py
+-rw-r--r--   0 teamcity  (1001) teamcity  (1001)      225 2022-04-28 17:18:02.000000 callisto-jupyter-d1-0.0.9/jupyter_d1/routers/hello.py
+-rw-r--r--   0 teamcity  (1001) teamcity  (1001)     3237 2022-09-19 17:29:14.000000 callisto-jupyter-d1-0.0.9/jupyter_d1/routers/kernels.py
+-rw-r--r--   0 teamcity  (1001) teamcity  (1001)     1687 2022-04-28 17:18:02.000000 callisto-jupyter-d1-0.0.9/jupyter_d1/routers/login.py
+-rw-r--r--   0 teamcity  (1001) teamcity  (1001)    28015 2022-09-19 17:29:14.000000 callisto-jupyter-d1-0.0.9/jupyter_d1/routers/notebooks.py
+-rw-r--r--   0 teamcity  (1001) teamcity  (1001)     1353 2022-09-19 17:29:14.000000 callisto-jupyter-d1-0.0.9/jupyter_d1/routers/rclone.py
+-rw-r--r--   0 teamcity  (1001) teamcity  (1001)     3653 2022-10-11 21:17:53.000000 callisto-jupyter-d1-0.0.9/jupyter_d1/routers/server.py
+-rw-r--r--   0 teamcity  (1001) teamcity  (1001)      631 2022-04-28 17:18:02.000000 callisto-jupyter-d1-0.0.9/jupyter_d1/security.py
+-rw-r--r--   0 teamcity  (1001) teamcity  (1001)     7664 2022-10-11 21:17:53.000000 callisto-jupyter-d1-0.0.9/jupyter_d1/settings.py
+drwxr-xr-x   0 teamcity  (1001) teamcity  (1001)        0 2022-10-31 16:11:58.966027 callisto-jupyter-d1-0.0.9/jupyter_d1/signals/
+-rw-r--r--   0 teamcity  (1001) teamcity  (1001)     4627 2022-09-19 17:29:14.000000 callisto-jupyter-d1-0.0.9/jupyter_d1/signals/__init__.py
+drwxr-xr-x   0 teamcity  (1001) teamcity  (1001)        0 2022-10-31 16:11:58.966027 callisto-jupyter-d1-0.0.9/jupyter_d1/storage/
+-rw-r--r--   0 teamcity  (1001) teamcity  (1001)      711 2022-09-19 17:29:14.000000 callisto-jupyter-d1-0.0.9/jupyter_d1/storage/__init__.py
+-rw-r--r--   0 teamcity  (1001) teamcity  (1001)     2670 2022-09-19 17:29:14.000000 callisto-jupyter-d1-0.0.9/jupyter_d1/storage/background_kernel_runner.py
+-rw-r--r--   0 teamcity  (1001) teamcity  (1001)     4213 2022-10-11 21:17:53.000000 callisto-jupyter-d1-0.0.9/jupyter_d1/storage/environment_dump.py
+-rw-r--r--   0 teamcity  (1001) teamcity  (1001)     2645 2022-08-15 20:01:25.000000 callisto-jupyter-d1-0.0.9/jupyter_d1/storage/kernel_listener.py
+-rw-r--r--   0 teamcity  (1001) teamcity  (1001)     1418 2022-06-14 13:50:52.000000 callisto-jupyter-d1-0.0.9/jupyter_d1/storage/kernel_logger.py
+-rw-r--r--   0 teamcity  (1001) teamcity  (1001)    10165 2022-09-19 17:29:14.000000 callisto-jupyter-d1-0.0.9/jupyter_d1/storage/kernel_manager.py
+-rw-r--r--   0 teamcity  (1001) teamcity  (1001)    46425 2022-09-19 17:29:14.000000 callisto-jupyter-d1-0.0.9/jupyter_d1/storage/notebook_manager.py
+-rw-r--r--   0 teamcity  (1001) teamcity  (1001)     4807 2022-05-06 13:40:15.000000 callisto-jupyter-d1-0.0.9/jupyter_d1/storage/notebook_validator.py
+-rw-r--r--   0 teamcity  (1001) teamcity  (1001)     4382 2022-08-04 01:55:05.000000 callisto-jupyter-d1-0.0.9/jupyter_d1/storage/stats_manager.py
+drwxr-xr-x   0 teamcity  (1001) teamcity  (1001)        0 2022-10-31 16:11:58.970027 callisto-jupyter-d1-0.0.9/jupyter_d1/tests/
+-rw-r--r--   0 teamcity  (1001) teamcity  (1001)     1497 2022-10-11 13:55:30.000000 callisto-jupyter-d1-0.0.9/jupyter_d1/tests/D1TestClient.py
+-rw-r--r--   0 teamcity  (1001) teamcity  (1001)        0 2022-05-25 14:50:24.000000 callisto-jupyter-d1-0.0.9/jupyter_d1/tests/__init__.py
+-rw-r--r--   0 teamcity  (1001) teamcity  (1001)     3425 2022-10-11 13:55:30.000000 callisto-jupyter-d1-0.0.9/jupyter_d1/tests/conftest.py
+-rw-r--r--   0 teamcity  (1001) teamcity  (1001)      832 2022-05-25 14:50:24.000000 callisto-jupyter-d1-0.0.9/jupyter_d1/tests/test_commands.py
+-rw-r--r--   0 teamcity  (1001) teamcity  (1001)     2975 2022-10-11 13:55:30.000000 callisto-jupyter-d1-0.0.9/jupyter_d1/tests/test_convert.py
+-rw-r--r--   0 teamcity  (1001) teamcity  (1001)    28270 2022-10-11 13:55:30.000000 callisto-jupyter-d1-0.0.9/jupyter_d1/tests/test_dav.py
+-rw-r--r--   0 teamcity  (1001) teamcity  (1001)    12134 2022-10-11 13:55:30.000000 callisto-jupyter-d1-0.0.9/jupyter_d1/tests/test_dependencies.py
+-rw-r--r--   0 teamcity  (1001) teamcity  (1001)      412 2022-05-25 14:50:24.000000 callisto-jupyter-d1-0.0.9/jupyter_d1/tests/test_hello.py
+-rw-r--r--   0 teamcity  (1001) teamcity  (1001)     9588 2022-10-11 13:55:30.000000 callisto-jupyter-d1-0.0.9/jupyter_d1/tests/test_kernels.py
+-rw-r--r--   0 teamcity  (1001) teamcity  (1001)     1107 2022-10-11 13:55:30.000000 callisto-jupyter-d1-0.0.9/jupyter_d1/tests/test_login.py
+-rw-r--r--   0 teamcity  (1001) teamcity  (1001)    61041 2022-10-11 13:55:30.000000 callisto-jupyter-d1-0.0.9/jupyter_d1/tests/test_notebooks.py
+-rw-r--r--   0 teamcity  (1001) teamcity  (1001)   154172 2022-10-11 13:55:30.000000 callisto-jupyter-d1-0.0.9/jupyter_d1/tests/test_notebooks_websocket.py
+-rw-r--r--   0 teamcity  (1001) teamcity  (1001)     3263 2022-10-11 13:55:30.000000 callisto-jupyter-d1-0.0.9/jupyter_d1/tests/test_rclone.py
+-rw-r--r--   0 teamcity  (1001) teamcity  (1001)      330 2022-05-25 14:50:24.000000 callisto-jupyter-d1-0.0.9/jupyter_d1/tests/test_settings.py
+-rw-r--r--   0 teamcity  (1001) teamcity  (1001)     8093 2022-10-11 21:17:53.000000 callisto-jupyter-d1-0.0.9/jupyter_d1/tests/test_stats.py
+-rw-r--r--   0 teamcity  (1001) teamcity  (1001)    13354 2022-10-11 13:55:30.000000 callisto-jupyter-d1-0.0.9/jupyter_d1/tests/test_undo.py
+-rw-r--r--   0 teamcity  (1001) teamcity  (1001)     4691 2022-05-25 14:50:24.000000 callisto-jupyter-d1-0.0.9/jupyter_d1/tests/test_undo_manager.py
+-rw-r--r--   0 teamcity  (1001) teamcity  (1001)     5660 2022-10-11 13:55:30.000000 callisto-jupyter-d1-0.0.9/jupyter_d1/tests/utils.py
+drwxr-xr-x   0 teamcity  (1001) teamcity  (1001)        0 2022-10-31 16:11:58.970027 callisto-jupyter-d1-0.0.9/jupyter_d1/undo_manager/
+-rw-r--r--   0 teamcity  (1001) teamcity  (1001)       79 2022-04-28 17:18:02.000000 callisto-jupyter-d1-0.0.9/jupyter_d1/undo_manager/__init__.py
+-rw-r--r--   0 teamcity  (1001) teamcity  (1001)     5105 2022-04-28 17:18:02.000000 callisto-jupyter-d1-0.0.9/jupyter_d1/undo_manager/undo_manager.py
+-rw-r--r--   0 teamcity  (1001) teamcity  (1001)     1772 2022-08-15 20:01:25.000000 callisto-jupyter-d1-0.0.9/jupyter_d1/utils.py
+-rw-r--r--   0 teamcity  (1001) teamcity  (1001)      904 2022-09-19 17:29:14.000000 callisto-jupyter-d1-0.0.9/jupyter_d1/uvicorn_worker.py
+-rw-r--r--   0 teamcity  (1001) teamcity  (1001)      128 2022-10-18 18:04:58.000000 callisto-jupyter-d1-0.0.9/jupyter_d1/version.py
+-rw-r--r--   0 teamcity  (1001) teamcity  (1001)       93 2022-04-28 17:18:02.000000 callisto-jupyter-d1-0.0.9/jupyter_d1_install_kernels
+-rw-r--r--   0 teamcity  (1001) teamcity  (1001)       39 2022-04-28 17:18:02.000000 callisto-jupyter-d1-0.0.9/jupyter_d1_test
+-rw-r--r--   0 teamcity  (1001) teamcity  (1001)       38 2022-10-31 16:11:58.970027 callisto-jupyter-d1-0.0.9/setup.cfg
+-rw-r--r--   0 teamcity  (1001) teamcity  (1001)     1716 2022-10-12 15:48:42.000000 callisto-jupyter-d1-0.0.9/setup.py
+-rwxr-xr-x   0 teamcity  (1001) teamcity  (1001)     2760 2022-08-31 21:17:31.000000 callisto-jupyter-d1-0.0.9/start_jupyter_d1
```

### Comparing `callisto-jupyter-d1-0.0.7/PKG-INFO` & `callisto-jupyter-d1-0.0.9/PKG-INFO`

 * *Files 1% similar despite different names*

```diff
@@ -1,10 +1,10 @@
 Metadata-Version: 2.1
 Name: callisto-jupyter-d1
-Version: 0.0.7
+Version: 0.0.9
 Summary: Jupyter D1 Server for Callisto
 Home-page: https://callistoapp.com
 Author: Oak City Labs
 Author-email: team@oakcity.io
 Classifier: Programming Language :: Python :: 3
 Classifier: License :: OSI Approved :: MIT License
 Classifier: Operating System :: OS Independent
@@ -120,8 +120,10 @@
 
 * Use the shared secret from the server command line to get an access token
    * curl -H "Authorization: <SHARED_SECRET>" http://127.0.0.1:<port_number>/login/access-token
    * returns {"token":{"access_token":"**ACCESS_TOKEN**","token_type":"bearer"}}
 * Use the returned access token for subsequent requests
    * curl -H "Authorization: Bearer <**ACCESS_TOKEN**>" http://127.0.0.1:<port_number>/notebooks
 
+  
+
```

### Comparing `callisto-jupyter-d1-0.0.7/README.md` & `callisto-jupyter-d1-0.0.9/README.md`

 * *Files 1% similar despite different names*

```diff
@@ -105,8 +105,10 @@
 
 * Use the shared secret from the server command line to get an access token
    * curl -H "Authorization: <SHARED_SECRET>" http://127.0.0.1:<port_number>/login/access-token
    * returns {"token":{"access_token":"**ACCESS_TOKEN**","token_type":"bearer"}}
 * Use the returned access token for subsequent requests
    * curl -H "Authorization: Bearer <**ACCESS_TOKEN**>" http://127.0.0.1:<port_number>/notebooks
 
+  
+
```

### Comparing `callisto-jupyter-d1-0.0.7/callisto_jupyter_d1.egg-info/PKG-INFO` & `callisto-jupyter-d1-0.0.9/callisto_jupyter_d1.egg-info/PKG-INFO`

 * *Files 1% similar despite different names*

```diff
@@ -1,10 +1,10 @@
 Metadata-Version: 2.1
 Name: callisto-jupyter-d1
-Version: 0.0.7
+Version: 0.0.9
 Summary: Jupyter D1 Server for Callisto
 Home-page: https://callistoapp.com
 Author: Oak City Labs
 Author-email: team@oakcity.io
 Classifier: Programming Language :: Python :: 3
 Classifier: License :: OSI Approved :: MIT License
 Classifier: Operating System :: OS Independent
@@ -120,8 +120,10 @@
 
 * Use the shared secret from the server command line to get an access token
    * curl -H "Authorization: <SHARED_SECRET>" http://127.0.0.1:<port_number>/login/access-token
    * returns {"token":{"access_token":"**ACCESS_TOKEN**","token_type":"bearer"}}
 * Use the returned access token for subsequent requests
    * curl -H "Authorization: Bearer <**ACCESS_TOKEN**>" http://127.0.0.1:<port_number>/notebooks
 
+  
+
```

### Comparing `callisto-jupyter-d1-0.0.7/callisto_jupyter_d1.egg-info/SOURCES.txt` & `callisto-jupyter-d1-0.0.9/callisto_jupyter_d1.egg-info/SOURCES.txt`

 * *Files 9% similar despite different names*

```diff
@@ -10,19 +10,25 @@
 callisto_jupyter_d1.egg-info/top_level.txt
 jupyter_d1/__init__.py
 jupyter_d1/commands.py
 jupyter_d1/d1_response.py
 jupyter_d1/dav.py
 jupyter_d1/dav_auth.py
 jupyter_d1/deps.py
+jupyter_d1/logger.py
 jupyter_d1/main.py
 jupyter_d1/security.py
 jupyter_d1/settings.py
 jupyter_d1/utils.py
 jupyter_d1/uvicorn_worker.py
+jupyter_d1/version.py
+jupyter_d1/dependency/__init__.py
+jupyter_d1/dependency/dependency_manager.py
+jupyter_d1/dependency/python/__init__.py
+jupyter_d1/dependency/python/dependency_manager.py
 jupyter_d1/kernels/__init__.py
 jupyter_d1/kernels/kernel_definition.py
 jupyter_d1/kernels/vars_manager.py
 jupyter_d1/kernels/workdir_manager.py
 jupyter_d1/kernels/python/__init__.py
 jupyter_d1/kernels/python/vars_manager.py
 jupyter_d1/kernels/python/workdir_manager.py
@@ -35,47 +41,52 @@
 jupyter_d1/kernels/zsh/vars_manager.py
 jupyter_d1/kernels/zsh/workdir_manager.py
 jupyter_d1/models/JSONType.py
 jupyter_d1/models/__init__.py
 jupyter_d1/models/base_wrapper.py
 jupyter_d1/models/cell.py
 jupyter_d1/models/code_complete.py
+jupyter_d1/models/dependency.py
 jupyter_d1/models/environment_info.py
 jupyter_d1/models/execution_state.py
 jupyter_d1/models/kernel.py
 jupyter_d1/models/kernel_message.py
 jupyter_d1/models/kernel_spec.py
 jupyter_d1/models/kernel_variable.py
 jupyter_d1/models/notebook.py
 jupyter_d1/models/permission.py
 jupyter_d1/models/scratch.py
 jupyter_d1/models/server_stats.py
 jupyter_d1/models/token.py
 jupyter_d1/routers/__init__.py
 jupyter_d1/routers/convert.py
+jupyter_d1/routers/dependencies.py
 jupyter_d1/routers/hello.py
 jupyter_d1/routers/kernels.py
 jupyter_d1/routers/login.py
 jupyter_d1/routers/notebooks.py
 jupyter_d1/routers/rclone.py
 jupyter_d1/routers/server.py
 jupyter_d1/signals/__init__.py
 jupyter_d1/storage/__init__.py
+jupyter_d1/storage/background_kernel_runner.py
 jupyter_d1/storage/environment_dump.py
 jupyter_d1/storage/kernel_listener.py
 jupyter_d1/storage/kernel_logger.py
 jupyter_d1/storage/kernel_manager.py
 jupyter_d1/storage/notebook_manager.py
 jupyter_d1/storage/notebook_validator.py
 jupyter_d1/storage/stats_manager.py
+jupyter_d1/tests/D1TestClient.py
 jupyter_d1/tests/__init__.py
 jupyter_d1/tests/conftest.py
 jupyter_d1/tests/test_commands.py
 jupyter_d1/tests/test_convert.py
 jupyter_d1/tests/test_dav.py
+jupyter_d1/tests/test_dependencies.py
 jupyter_d1/tests/test_hello.py
 jupyter_d1/tests/test_kernels.py
 jupyter_d1/tests/test_login.py
 jupyter_d1/tests/test_notebooks.py
 jupyter_d1/tests/test_notebooks_websocket.py
 jupyter_d1/tests/test_rclone.py
 jupyter_d1/tests/test_settings.py
```

### Comparing `callisto-jupyter-d1-0.0.7/jupyter_d1/commands.py` & `callisto-jupyter-d1-0.0.9/jupyter_d1/commands.py`

 * *Files identical despite different names*

### Comparing `callisto-jupyter-d1-0.0.7/jupyter_d1/d1_response.py` & `callisto-jupyter-d1-0.0.9/jupyter_d1/d1_response.py`

 * *Files identical despite different names*

### Comparing `callisto-jupyter-d1-0.0.7/jupyter_d1/dav.py` & `callisto-jupyter-d1-0.0.9/jupyter_d1/dav.py`

 * *Files 0% similar despite different names*

```diff
@@ -1,26 +1,26 @@
 import asyncio
 import platform
 from typing import Dict, List
 from uuid import UUID
 
 from asyncblink import signal  # type: ignore
 from fastapi.logger import logger
-from watchdog.observers.api import ObservedWatch  # type: ignore
 from wsgidav.wsgidav_app import WsgiDAVApp  # type: ignore
 
 from .settings import settings
 from .signals import WATCHDOG_FILE_SYSTEM_EVENT
 
 try:
     if not settings.WATCHDOG_ENABLED:
         raise ImportError("settings.WATCHDOG_ENABLED is False")
     from watchdog.events import FileSystemEvent  # type: ignore
     from watchdog.events import PatternMatchingEventHandler
     from watchdog.observers import Observer  # type: ignore
+    from watchdog.observers.api import ObservedWatch  # type: ignore
 
     has_watchdog = True
     logger.debug("Successfully loaded watchdog.")
 except ImportError as e:
     has_watchdog = False
     logger.debug(f"Watchdog disabled.  Failed to import - {e}")
```

### Comparing `callisto-jupyter-d1-0.0.7/jupyter_d1/dav_auth.py` & `callisto-jupyter-d1-0.0.9/jupyter_d1/dav_auth.py`

 * *Files identical despite different names*

### Comparing `callisto-jupyter-d1-0.0.7/jupyter_d1/deps.py` & `callisto-jupyter-d1-0.0.9/jupyter_d1/deps.py`

 * *Files identical despite different names*

### Comparing `callisto-jupyter-d1-0.0.7/jupyter_d1/kernels/__init__.py` & `callisto-jupyter-d1-0.0.9/jupyter_d1/kernels/__init__.py`

 * *Files identical despite different names*

### Comparing `callisto-jupyter-d1-0.0.7/jupyter_d1/kernels/python/workdir_manager.py` & `callisto-jupyter-d1-0.0.9/jupyter_d1/kernels/python/workdir_manager.py`

 * *Files identical despite different names*

### Comparing `callisto-jupyter-d1-0.0.7/jupyter_d1/kernels/r/vars_manager.py` & `callisto-jupyter-d1-0.0.9/jupyter_d1/kernels/r/vars_manager.py`

 * *Files 5% similar despite different names*

```diff
@@ -59,15 +59,17 @@
         return raw_get_vars_code.format(
             load_callistor_code=get_load_callistor_code(
                 settings.LOAD_CALLISTOR_FROM_GITHUB
             ),
             abbrev_len=settings.VAR_ABBREV_LEN,
         )
 
-    def get_single_var_code(self, var_name: str) -> str:
+    def get_single_var_code(
+        self, var_name: str, page_size: Optional[int], page: int
+    ) -> str:
         return raw_get_single_var_code.format(
             load_callistor_code=get_load_callistor_code(
                 settings.LOAD_CALLISTOR_FROM_GITHUB
             ),
             var_name=var_name,
         )
```

### Comparing `callisto-jupyter-d1-0.0.7/jupyter_d1/kernels/r/workdir_manager.py` & `callisto-jupyter-d1-0.0.9/jupyter_d1/kernels/r/workdir_manager.py`

 * *Files identical despite different names*

### Comparing `callisto-jupyter-d1-0.0.7/jupyter_d1/kernels/vars_manager.py` & `callisto-jupyter-d1-0.0.9/jupyter_d1/kernels/vars_manager.py`

 * *Files 2% similar despite different names*

```diff
@@ -13,15 +13,17 @@
         self._tmp_vars = []
 
     @abstractmethod
     def get_vars_code(self) -> str:
         raise NotImplementedError
 
     @abstractmethod
-    def get_single_var_code(self, var_name: str) -> str:
+    def get_single_var_code(
+        self, var_name: str, page_size: Optional[int], page: int
+    ) -> str:
         raise NotImplementedError
 
     @abstractmethod
     def parse_vars_response(
         self, vars_response: NotebookNode
     ) -> List[KernelVariable]:
         raise NotImplementedError
```

### Comparing `callisto-jupyter-d1-0.0.7/jupyter_d1/kernels/workdir_manager.py` & `callisto-jupyter-d1-0.0.9/jupyter_d1/kernels/workdir_manager.py`

 * *Files identical despite different names*

### Comparing `callisto-jupyter-d1-0.0.7/jupyter_d1/kernels/zsh/vars_manager.py` & `callisto-jupyter-d1-0.0.9/jupyter_d1/kernels/zsh/vars_manager.py`

 * *Files 11% similar despite different names*

```diff
@@ -11,15 +11,17 @@
 """  # noqa
 
 
 class ZshVarsManager(VarsManager):
     def get_vars_code(self) -> str:
         return raw_get_vars_code
 
-    def get_single_var_code(self, var_name: str) -> str:
+    def get_single_var_code(
+        self, var_name: str, page_size: Optional[int], page: int
+    ) -> str:
         return ""
 
     def parse_vars_response(
         self, vars_response: NotebookNode
     ) -> List[KernelVariable]:
         vars = []
         try:
```

### Comparing `callisto-jupyter-d1-0.0.7/jupyter_d1/kernels/zsh/workdir_manager.py` & `callisto-jupyter-d1-0.0.9/jupyter_d1/kernels/zsh/workdir_manager.py`

 * *Files identical despite different names*

### Comparing `callisto-jupyter-d1-0.0.7/jupyter_d1/main.py` & `callisto-jupyter-d1-0.0.9/jupyter_d1/main.py`

 * *Files 26% similar despite different names*

```diff
@@ -1,29 +1,38 @@
 import asyncio
 import logging
 import sys
+from typing import Optional
 
 from asyncblink import signal  # type: ignore
 from fastapi import Depends, FastAPI, Request
-from fastapi.logger import logger
 from fastapi.middleware.wsgi import WSGIMiddleware
 from starlette.responses import JSONResponse
 from uvicorn.main import Server  # type: ignore
 
 from jupyter_d1.signals import APP_LOG, APP_SHUTDOWN, APP_STARTUP
 
 from .d1_response import D1Response
 from .dav import dav, dav_manager
 from .deps import read_access
-from .routers import convert, hello, kernels, login, notebooks, rclone, server
+from .logger import logger
+from .routers import (
+    convert,
+    dependencies,
+    hello,
+    kernels,
+    login,
+    notebooks,
+    rclone,
+    server,
+)
 from .settings import settings
-from .storage import stats_manager
+from .storage import kmanager, stats_manager
 from .storage.notebook_manager import NBMException
 
-
 # Monkey patch the uvicorn exit handler. The standard
 # uvicorn 'shutdown' event comes too late to properly
 # shutdown active websockets. There are no other hooks
 # so this is the only way to do so.
 # See https://stackoverflow.com/a/59887076/436040
 uvicorn_handle_exit = Server.handle_exit
 
@@ -32,48 +41,61 @@
     logger.debug("Sending APP_SHUTDOWN signal")
     signal(APP_SHUTDOWN).send()
     uvicorn_handle_exit(self, *args, **kwargs)
 
 
 Server.handle_exit = handle_exit
 
+# Begin logging setup
+
+# Logs from other libraries will propagate up to the root logger
+root_logger = logging.getLogger()
+root_logger.setLevel(settings.LOG_LEVEL)
+
+formatter = logging.Formatter(
+    "%(asctime)s - %(name)s - %(levelname)s - %(message)s"
+)
+
 
 class AsyncBlinkHandler(logging.Handler):
     def __init__(self, level=logging.NOTSET):
         super().__init__(level=level)
 
     def emit(self, record):
         msg = self.format(record)
         signal(APP_LOG).send(msg=msg)
 
 
-formatter = logging.Formatter(
-    "%(asctime)s - %(name)s - %(levelname)s - " "%(message)s"
-)
-handler = AsyncBlinkHandler()
-handler.setFormatter(formatter)
-logger.setLevel(logging.DEBUG)
-logger.addHandler(handler)
+async_blink_handler = AsyncBlinkHandler()
+async_blink_handler.setFormatter(formatter)
+logger.addHandler(async_blink_handler)
+
+stdout_handler = logging.StreamHandler(sys.stdout)
+stdout_handler.setFormatter(formatter)
+logger.addHandler(stdout_handler)
+
+# Begin FastAPI setup
 
-logging.getLogger("wsgidav").addHandler(logging.StreamHandler(sys.stdout))
+rclone_stats_task: Optional[asyncio.Task] = None
+server_stats_task: Optional[asyncio.Task] = None
 
 app = FastAPI(default_response_class=D1Response)
 app.mount("/dav", WSGIMiddleware(dav))
 
-# Begin FastAPI setup
-
-rclone_stats_task = None
-server_stats_task = None
-
 
 @app.on_event("startup")
 def startup_event():
     logger.debug(f"App startup")
     signal(APP_STARTUP).send()
     loop = asyncio.get_event_loop()
+
+    kmanager.warmup_kernels(
+        settings.WARMUP_KERNEL_NAMES, settings.PREWARMED_KERNELS_FILE
+    )
+
     if settings.RCLONE_STATS_POLL:
         global rclone_stats_task
         global server_stats_task
         rclone_stats_task = loop.create_task(rclone.stats_periodic())
         server_stats_task = loop.create_task(
             stats_manager.server_stats_periodic()
         )
@@ -91,14 +113,15 @@
 
     try:
         server_stats_task.cancel()
     except Exception:
         pass
 
     dav_manager.stop_watchdog()
+    kmanager.shutdown_warmups()
 
 
 not_found_resp = {
     "error": "NOT_FOUND",
     "reason": "Not found.",
     "detail": None,
 }
@@ -115,14 +138,22 @@
     prefix="/notebooks",
     tags=["notebooks"],
     dependencies=[Depends(read_access)],
     responses={404: not_found_resp},
 )
 
 app.include_router(
+    dependencies.router,
+    prefix="/dependencies",
+    tags=["dependencies"],
+    dependencies=[Depends(read_access)],
+    responses={404: not_found_resp},
+)
+
+app.include_router(
     convert.router,
     prefix="/convert",
     tags=["convert"],
     dependencies=[Depends(read_access)],
     responses={404: not_found_resp},
 )
```

### Comparing `callisto-jupyter-d1-0.0.7/jupyter_d1/models/cell.py` & `callisto-jupyter-d1-0.0.9/jupyter_d1/models/cell.py`

 * *Files identical despite different names*

### Comparing `callisto-jupyter-d1-0.0.7/jupyter_d1/models/environment_info.py` & `callisto-jupyter-d1-0.0.9/jupyter_d1/models/environment_info.py`

 * *Files 16% similar despite different names*

```diff
@@ -36,23 +36,29 @@
     environ: Dict[str, Any]
 
 
 class CondaInfo(BaseModel):
     version: str
 
 
+class Version(BaseModel):
+    major: int
+    minor: int
+    micro: int
+    
+    
+class VersionWrapper(BaseWrapper):
+    version: Version
+
+
 class EnvironmentInfo(BaseModel):
     os: OSInfo
     python: PythonInfo
     config: Dict[str, Any]
     process: ProcessInfo
     conda: Optional[CondaInfo]
     cores: int
-    version: int
+    version: Optional[Version]
 
 
 class EnvironmentInfoWrapper(BaseWrapper):
     environment_info: EnvironmentInfo
-
-
-class Version(BaseModel):
-    version: int
```

### Comparing `callisto-jupyter-d1-0.0.7/jupyter_d1/models/kernel.py` & `callisto-jupyter-d1-0.0.9/jupyter_d1/models/kernel.py`

 * *Files identical despite different names*

### Comparing `callisto-jupyter-d1-0.0.7/jupyter_d1/models/server_stats.py` & `callisto-jupyter-d1-0.0.9/jupyter_d1/models/server_stats.py`

 * *Files identical despite different names*

### Comparing `callisto-jupyter-d1-0.0.7/jupyter_d1/routers/convert.py` & `callisto-jupyter-d1-0.0.9/jupyter_d1/routers/convert.py`

 * *Ordering differences only*

 * *Files 2% similar despite different names*

```diff
@@ -1,11 +1,11 @@
 import shutil
+import traceback
 from pathlib import Path
 from tempfile import NamedTemporaryFile
-import traceback
 
 from fastapi import APIRouter, File, HTTPException, UploadFile, status
 from fastapi.logger import logger
 from jupytext.cli import jupytext  # type: ignore
 from starlette.responses import StreamingResponse
 
 from ..d1_response import D1Response
```

### Comparing `callisto-jupyter-d1-0.0.7/jupyter_d1/routers/login.py` & `callisto-jupyter-d1-0.0.9/jupyter_d1/routers/login.py`

 * *Files identical despite different names*

### Comparing `callisto-jupyter-d1-0.0.7/jupyter_d1/routers/notebooks.py` & `callisto-jupyter-d1-0.0.9/jupyter_d1/routers/notebooks.py`

 * *Files 2% similar despite different names*

```diff
@@ -1,36 +1,35 @@
 import json
 from os import path
 from pathlib import Path
 from typing import Any, Dict, List, Optional
 from uuid import UUID
 
+import jsonschema
 from asyncblink import signal  # type: ignore
 from fastapi import (
     APIRouter,
     BackgroundTasks,
     Depends,
     HTTPException,
+    Query,
     Request,
     Response,
     WebSocket,
     status,
-    Query,
 )
 from fastapi.encoders import jsonable_encoder
 from fastapi.logger import logger
-import jsonschema
 
 from jupyter_d1.signals import (
     CELL_ADDED,
     CELL_DELETED,
     CELL_EXECUTION_INPUT,
     CELL_EXECUTION_REPLY,
     CELL_EXECUTION_REQUEST,
-    CELL_STREAM,
     CELL_UPDATE,
     COMPLETE_REPLY,
     CONTROL_CHANNEL,
     HB_CHANNEL,
     HISTORY_REPLY,
     IOPUB_CHANNEL,
     KERNEL_INTERRUPTED,
@@ -350,17 +349,25 @@
 
 
 @router.get(
     "/{uuid}/vars/{var_name}",
     dependencies=[Depends(write_access)],
     response_model=KernelVariableWrapper,
 )
-async def get_notebook_single_var(uuid: UUID, var_name: str):
+async def get_notebook_single_var(
+    uuid: UUID, var_name: str, page_size: Optional[int] = -1, page: int = 0
+):
     """Get details on a single var defined in the kernel."""
-    single_var = await manager.get_kernel_var_details(uuid, var_name)
+    if page_size is None or page_size == 0:
+        page_size = None
+    elif page_size < 0:
+        page_size = settings.VAR_DEFAULT_PAGE_SIZE
+    single_var = await manager.get_kernel_var_details(
+        uuid, var_name, page_size=page_size, page=page
+    )
     if single_var is None:
         raise HTTPException(404, f"Variable {var_name} not found")
     return KernelVariableWrapper(single_var=single_var)
 
 
 @router.patch(
     "/{uuid}/cells/{cell_uuid}",
@@ -593,27 +600,29 @@
     directory: Optional[str] = None,
     overwrite: bool = False,
     just_metadata: bool = Query(
         False,
         description="Just update the in-memory"
         " notebook's metadata, dont save or delete any files. Used by the local "
         "environment on Callisto Mac/iPad, where file operations are handled in "
-        "swift"
+        "swift",
     ),
 ):
     """
     Rename a notebook, save it, and update it's name and path in its metadata
     """
-    path_info = format_file_path(directory, filename, overwrite or just_metadata)
+    path_info = format_file_path(
+        directory, filename, overwrite or just_metadata
+    )
     await manager.save_notebook_as(
         uuid,
         path_info["directory"],
         path_info["filename"],
         delete_old=not just_metadata,
-        just_metadata=just_metadata
+        just_metadata=just_metadata,
     )
     return NotebookPath(path=path_info["absolute_path"])
 
 
 @router.websocket("/{uuid}/ws/stream")
 async def websocket_stream(
     uuid: UUID,
@@ -685,27 +694,14 @@
         if notebook_id == uuid:
             wrapper_dict = {"cell_delete": cells}
             wrapper_string = json.dumps(wrapper_dict, cls=D1Encoder)
             cell_update_queue.append(wrapper_string)
 
     signal(CELL_DELETED).connect(receive_cell_deleted)
 
-    async def receive_cell_stream(
-        sender, output, notebook_id, cell_id, **kwargs
-    ):
-        logger.debug("receiving CELL_STREAM")
-        if notebook_id == uuid:
-            wrapper_dict = {
-                "cell_stream": {"output": output, "cell_id": cell_id}
-            }
-            wrapper_string = json.dumps(wrapper_dict, cls=D1Encoder)
-            cell_update_queue.append(wrapper_string)
-
-    signal(CELL_STREAM).connect(receive_cell_stream)
-
     async def receive_cell_execution_reply(
         sender, execution_count, notebook_id, cell_id, parent_id, **kwargs
     ):
         logger.debug("receiving CELL_EXECUTION_REPLY")
         if notebook_id == uuid:
             wrapper_dict = {
                 "cell_execution_reply": {
```

### Comparing `callisto-jupyter-d1-0.0.7/jupyter_d1/routers/rclone.py` & `callisto-jupyter-d1-0.0.9/jupyter_d1/routers/rclone.py`

 * *Ordering differences only*

 * *Files 9% similar despite different names*

```diff
@@ -1,15 +1,15 @@
 import asyncio
+import functools
 from typing import Any
 
 import requests
 from asyncblink import signal  # type: ignore
 from fastapi import APIRouter, Depends, Request
 from fastapi.concurrency import run_in_threadpool
-import functools
 
 from jupyter_d1.signals import RCLONE_UPDATE
 
 from ..d1_response import D1Response
 from ..deps import write_access
 from ..settings import settings
```

### Comparing `callisto-jupyter-d1-0.0.7/jupyter_d1/routers/server.py` & `callisto-jupyter-d1-0.0.9/jupyter_d1/routers/server.py`

 * *Files 10% similar despite different names*

```diff
@@ -2,36 +2,36 @@
 from typing import Any
 
 from asyncblink import signal  # type: ignore
 from fastapi import APIRouter, Depends, WebSocket
 
 from ..d1_response import D1Encoder
 from ..deps import read_access_websocket
-from ..models.environment_info import EnvironmentInfoWrapper, Version
+from ..models.environment_info import EnvironmentInfoWrapper, VersionWrapper, Version
 from ..models.server_stats import ServerStatsListWrapper, ServerStatsWrapper
-from ..settings import settings
+from ..version import version_dict
 from ..signals import (
     APP_LOG,
     NOTEBOOKS_UPDATED,
     RCLONE_UPDATE,
     SERVER_STATS_UPDATE,
     WATCHDOG_FILE_SYSTEM_EVENT,
 )
 from ..storage import environment_dump, stats_manager
 from ..utils import websocket_poll
 
 router = APIRouter()
 
 
-@router.get("/version", response_model=Version)
+@router.get("/version", response_model=VersionWrapper)
 def get_server_version() -> Any:
     """
     Get D1 server version number
     """
-    return Version(version=settings.VERSION)
+    return VersionWrapper(version=Version(**version_dict))
 
 
 @router.get("/stats", response_model=ServerStatsListWrapper)
 def get_server_stats(limit: int = 100, skip: int = 0) -> Any:
     """
     Get server stats about memory, cpu, disk, and gpu
     """
```

### Comparing `callisto-jupyter-d1-0.0.7/jupyter_d1/security.py` & `callisto-jupyter-d1-0.0.9/jupyter_d1/security.py`

 * *Files identical despite different names*

### Comparing `callisto-jupyter-d1-0.0.7/jupyter_d1/settings.py` & `callisto-jupyter-d1-0.0.9/jupyter_d1/settings.py`

 * *Files 20% similar despite different names*

```diff
@@ -2,22 +2,26 @@
 import os
 import platform
 import secrets
 from pathlib import Path
 from typing import Any, Dict, List, Optional
 
 from pydantic import BaseSettings, validator
+from .version import version
 
 callisto_env = os.getenv("CALLISTO_ENV", "dev").lower()
 dotenv_file = f"{callisto_env}.env"
 
 
 class Settings(BaseSettings):
     pretty_name: str = "Jupyter D1"
-    VERSION: int = 1
+    VERSION: str = version
+
+    LOG_LEVEL: str = "WARNING"
+
     OAUTH_TOKEN_URL: str = "/login/access-token"
     META_INFO_FILE: Optional[str] = None
     META_INFO: Dict[str, Any] = {}
 
     @validator("META_INFO", pre=True)
     def get_meta_info(
         cls, v: Dict[str, Any], values: Dict[str, Any]
@@ -162,17 +166,44 @@
         if meta_info is not None and "env" in meta_info:
             if meta_info["env"] == "test":
                 return True
         if platform.system().startswith("Darwin"):
             return False
         return True
 
+    DEFAULT_KERNEL_NAME: Optional[str] = None
+
+    @validator("DEFAULT_KERNEL_NAME", pre=True)
+    def get_default_kernel_name(
+        cls, v: Optional[str], values: Dict[str, Any]
+    ) -> Optional[str]:
+        if v is None and callisto_env in ("staging", "prod"):
+            return "conda-env-callisto-py"
+        return v
+
+    WARMUP_KERNEL_NAMES: List[str] = []
+
+    @validator("WARMUP_KERNEL_NAMES", pre=True)
+    def get_warmup_kernel_names(
+        cls, v: List[str], values: Dict[str, Any]
+    ) -> List[str]:
+        if callisto_env in ("staging", "prod"):
+            return list(
+                set(v + ["conda-env-callisto-py", "conda-env-callisto-r"])
+            )
+        return v
+
+    # A system service runs on startup to attempt to prewarm kernels
+    # and writes its results to a file
+    PREWARMED_KERNELS_FILE: Optional[str] = None
+
     # Number of elements (approximately) at which to abbreviate variables
     # in the variable explorer
     VAR_ABBREV_LEN: int = 50
+    VAR_DEFAULT_PAGE_SIZE: int = 50
 
     LOAD_CALLISTOR_FROM_GITHUB: bool = True
     CALLISTOR_GITHUB_BRANCH: str = "dev"
 
     @validator("CALLISTOR_GITHUB_BRANCH", pre=True)
     def get_callistor_branch(
         cls, v: Optional[str], values: Dict[str, Any]
```

### Comparing `callisto-jupyter-d1-0.0.7/jupyter_d1/signals/__init__.py` & `callisto-jupyter-d1-0.0.9/jupyter_d1/signals/__init__.py`

 * *Files 3% similar despite different names*

```diff
@@ -15,21 +15,14 @@
 # The signal will be emitted with these kwargs:
 #    * cell - The nbformat.notebooknode.NotebookNode object that is the cell
 #    * notebook_id - The uuid of the notebook that the cell belongs to
 CELL_UPDATE = "cell_update"
 CELL_ADDED = "cell_added"
 CELL_DELETED = "cell_deleted"
 
-# Signal fired when a cell produces stream output
-# The signal will be emitted with these kwargs:
-#    * output - The nbformat-style cell output
-#    * notebook_id - The uuid of the notebook that the cell belongs to
-#    * cell_id - The uuid of the cell
-CELL_STREAM = "cell_stream"
-
 # Signal fired when a cell execution_count gets updated
 # The signal will be emitted with these kwargs:
 #    * execution_count - the int execution count for the cell
 #    * notebook_id - The uuid of the notebook that the cell belongs to
 #    * cell_id - The uuid of the cell
 #    * parent_id - The message_id of the original execution request
 CELL_EXECUTION_REPLY = "cell_execution_reply"
@@ -92,14 +85,19 @@
 COMPLETE_REPLY = "complete_reply"
 
 HISTORY_REPLY = "history_reply"
 METADATA_UPDATE = "metadata_update"
 KERNEL_RESTARTED = "kernel_restarted"
 KERNEL_INTERRUPTED = "kernel_interrupted"
 
+DEPENDENCIES_RECEIVED = "dependencies_received"
+DEPENDENCIES_UPDATE = "dependencies_update"
+DEPENDENCIES_COMPLETE = "dependencies_complete"
+DEPENDENCIES_FAILED = "dependencies_failed"
+
 # Signals fired when notebook is added to or removed from notebook manager
 # The signal will be emitted with these kwargs:
 #    * notebooks - The dict of notebook uuid to notebook nodes from the
 #                  notebook manager
 NOTEBOOKS_UPDATED = "notebook_updated"
 
 # FastAPI lifecycle events
```

### Comparing `callisto-jupyter-d1-0.0.7/jupyter_d1/storage/__init__.py` & `callisto-jupyter-d1-0.0.9/jupyter_d1/storage/__init__.py`

 * *Files 26% similar despite different names*

```diff
@@ -1,17 +1,20 @@
 from ..settings import settings
+from .background_kernel_runner import BackgroundKernelRunner
 from .environment_dump import EnvironmentDump
 from .kernel_logger import KernelLogger
 from .kernel_manager import KernelManager
 from .notebook_manager import NBMException  # noqa
 from .notebook_manager import NotebookManager
 from .stats_manager import StatsManager
 
 kmanager = KernelManager()
 manager = NotebookManager(kmanager)
+bg_kernel_runner = BackgroundKernelRunner(kmanager)
+
 stats_manager = StatsManager(
     settings.SERVER_STATS_POLLING_INTERVAL * settings.SERVER_STATS_TTL * 60
 )
 environment_dump = EnvironmentDump()
 
 # Instantiate a logger to echo out the messages from the kernels
 klogger = KernelLogger()
```

### Comparing `callisto-jupyter-d1-0.0.7/jupyter_d1/storage/environment_dump.py` & `callisto-jupyter-d1-0.0.9/jupyter_d1/storage/environment_dump.py`

 * *Files 3% similar despite different names*

```diff
@@ -13,21 +13,23 @@
     has_psutil = True
     logger.debug("Successfully loaded psutil.")
 except ImportError:
     has_psutil = False
     logger.debug("Failed to load psutil.  Disabling.")
 from typing import Any, Dict, Optional
 
+from ..version import version_dict
 from ..models.environment_info import (
     CondaInfo,
     EnvironmentInfo,
     OSInfo,
     ProcessInfo,
     PythonInfo,
     PythonVersionInfo,
+    Version
 )
 from ..settings import settings
 
 # Based on
 # https://github.com/Runscope/healthcheck/blob/master/healthcheck/__init__.py
 
 
@@ -40,15 +42,15 @@
         return EnvironmentInfo(
             os=self.get_os(),
             python=self.get_python(),
             config=self.get_config(),
             process=self.get_process(),
             conda=self.get_conda(),
             cores=cpu_count,
-            version=settings.VERSION,
+            version=Version(**version_dict)
         )
 
     def get_os(self) -> OSInfo:
         raw_name = platform.system()
         name = raw_name
         if raw_name.startswith("Darwin"):
             name = "macOS"
```

### Comparing `callisto-jupyter-d1-0.0.7/jupyter_d1/storage/kernel_listener.py` & `callisto-jupyter-d1-0.0.9/jupyter_d1/storage/kernel_listener.py`

 * *Files 3% similar despite different names*

```diff
@@ -14,27 +14,30 @@
 
 class KernelListener:
     def __init__(self, client, kernel_id):
         self.client = client
         self.kernel_id = kernel_id
         self.should_listen = True
         # Strong reference to the asyncio task running this listener,
-        # set it when you create the task so it doesn't get garbage collected.
+        # set when the task is created so it doesn't get garbage collected.
         # see the docs:
         # https://docs.python.org/3/library/asyncio-task.html#asyncio.create_task
         self.asyncio_task = None
         self.iopub_signal = signal(IOPUB_CHANNEL)
         self.shell_signal = signal(SHELL_CHANNEL)
         self.stdin_signal = signal(STDIN_CHANNEL)
         self.hb_signal = signal(HB_CHANNEL)
         self.control_signal = signal(CONTROL_CHANNEL)
 
         # stop listening if the fastapi app shuts down
         signal(APP_SHUTDOWN).connect(self.shutdown_listener)
 
+    def run(self):
+        self.asyncio_task = asyncio.create_task(self.listen())
+
     async def shutdown_listener(self, *args, **kwargs):
         self.should_listen = False
 
     async def listen(self):
         while self.should_listen:
             if await self.client.iopub_channel.msg_ready():
                 iopub_msg = await self.client.get_iopub_msg()
```

### Comparing `callisto-jupyter-d1-0.0.7/jupyter_d1/storage/kernel_logger.py` & `callisto-jupyter-d1-0.0.9/jupyter_d1/storage/kernel_logger.py`

 * *Files identical despite different names*

### Comparing `callisto-jupyter-d1-0.0.7/jupyter_d1/storage/notebook_manager.py` & `callisto-jupyter-d1-0.0.9/jupyter_d1/storage/notebook_manager.py`

 * *Files 6% similar despite different names*

```diff
@@ -1,30 +1,29 @@
 import asyncio
 import json
 import os
 from datetime import datetime
 from enum import Enum, auto
 from pathlib import Path
-from typing import Any, Dict, List, Optional
-from uuid import UUID
+from typing import Any, Dict, List, Optional, Tuple
+from uuid import UUID, uuid4
 
 import nbformat  # type: ignore
 from asyncblink import signal  # type: ignore
-from fastapi.logger import logger
 from fastapi.concurrency import run_in_threadpool
+from fastapi.logger import logger
 
 from jupyter_d1.commands import execute_d1_command
 from jupyter_d1.dav import dav_manager
 from jupyter_d1.signals import (
     CELL_ADDED,
     CELL_DELETED,
     CELL_EXECUTION_INPUT,
     CELL_EXECUTION_REPLY,
     CELL_EXECUTION_REQUEST,
-    CELL_STREAM,
     CELL_UPDATE,
     COMPLETE_REPLY,
     CONTROL_CHANNEL,
     HB_CHANNEL,
     HISTORY_REPLY,
     IOPUB_CHANNEL,
     KERNEL_INTERRUPTED,
@@ -89,14 +88,15 @@
     HISTORY_REQUEST = auto()
 
 
 class NotebookCommand:
     def __init__(self, command_type: CommandType, notebook_id: UUID, **kwargs):
         self.type = command_type
         self.notebook_id = notebook_id
+        self.execution_count: Optional[int] = None
         self.extras = kwargs
 
 
 class Notebook:
     def __init__(
         self,
         node: NotebookNode,
@@ -270,14 +270,19 @@
 
     def get_notebook(self, uuid: UUID) -> Notebook:
         nb = self.notebooks.get(uuid)
         if nb is None:
             raise NBMException(NBMErrorCode.notebook_not_found, uuid)
         return nb
 
+    def get_notebook_kernelspec(
+        self, uuid: UUID
+    ) -> Tuple[str, Dict[str, Any]]:
+        return self.kmanager.get_kernelspec(uuid)
+
     def get_notebook_node(self, uuid: UUID) -> NotebookNode:
         return self.get_notebook(uuid).node
 
     def get_notebook_json(self, uuid: UUID) -> str:
         node = self.get_notebook(uuid).node
         return nbformat.writes(node, default=D1Encoder().default)
 
@@ -320,22 +325,15 @@
 
         # Find the spec name
         if kspec_name is None:
             try:
                 kspec_name = notebook_node.metadata.kernelspec.name
             except AttributeError:
                 kspec_name = None
-        available_names = self.kmanager.kernel_names()
-        if kspec_name in available_names:
-            working_kspec_name = kspec_name
-        else:
-            # if there's no matching kernel_name, default to a `python` kernel
-            working_kspec_name = list(
-                filter(lambda x: "python" in x, available_names)
-            ).pop()
+
         working_kspec_name, kernelspec = self.kmanager.get_kernelspec_by_name(
             kspec_name
         )
 
         work_dir = notebook_node.metadata.jupyter_d1.working_directory
 
         kernel_definition = get_kernel_definition(
@@ -534,37 +532,39 @@
         code = vars_manager.get_vars_code()
         msg_id = await self.kmanager.execute(uuid, code, store_history=False)
         self.msg_to_command[msg_id] = NotebookCommand(
             CommandType.VARS_REQUEST, uuid
         )
 
     async def get_kernel_var_details(
-        self, nb_id: UUID, var_name: str
+        self, nb_id: UUID, var_name: str, page_size: Optional[int], page: int
     ) -> Optional[KernelVariable]:
         notebook = self.get_notebook(nb_id)
         uuid = notebook.node.metadata.jupyter_d1.uuid
         vars_manager = notebook.vars_manager
         if vars_manager is None:
             return None
-        code = vars_manager.get_single_var_code(var_name)
+        code = vars_manager.get_single_var_code(
+            var_name, page_size=page_size, page=page
+        )
         msg_id = await self.kmanager.execute(uuid, code, store_history=False)
         self.msg_to_command[msg_id] = NotebookCommand(
-            CommandType.VAR_DETAIL_REQUEST, uuid, var_name=var_name
+            CommandType.VAR_DETAIL_REQUEST, uuid, var_name=var_name, page=page
         )
         single_var_details: Optional[KernelVariable] = None
         waiting = True
 
         def receive_var_details(
             sender: Any,
             notebook_id: UUID,
-            var_name_inc: str,
+            parent_msg_id: str,
             single_var: KernelVariable,
             **kwargs,
         ):
-            if nb_id == notebook_id and var_name_inc == var_name:
+            if nb_id == notebook_id and parent_msg_id == msg_id:
                 nonlocal single_var_details
                 nonlocal waiting
                 single_var_details = single_var
                 waiting = False
 
         signal(VAR_DETAILS).connect(receive_var_details)
 
@@ -916,14 +916,16 @@
             for command in commands:
                 execute_d1_command(command)
         return output
 
     async def receive_channel_message(
         self, sender, msg, kernel_id, channel, **kwargs
     ):
+        if kernel_id not in self.notebooks.keys():
+            return
         logger.debug("nb_manager received channel message")
         parent_header = msg.get("parent_header")
         msg_type = msg.get("msg_type")
         content = msg.get("content")
         if parent_header is None:
             logger.debug("Can't get parent header")
             return
@@ -942,22 +944,21 @@
         nb_id = command.notebook_id
         if command.type == CommandType.CELL_EXECUTION:
             cell_id = command.extras["cell_id"]
             cell = self.find_cell(command.notebook_id, cell_id)
 
         if msg_type == "execute_reply" and content is not None:
             if command.type == CommandType.CELL_EXECUTION:
-                execution_count = content["execution_count"]
-                cell.execution_count = execution_count
+                command.execution_count = content.get("execution_count", None)
                 logger.debug(
                     f"nb_manager posting CELL_EXECUTION_REPLY - execute_reply"
                 )
                 signal(CELL_EXECUTION_REPLY).send(
                     cell_id=cell_id,
-                    execution_count=execution_count,
+                    execution_count=command.execution_count,
                     notebook_id=nb_id,
                     parent_id=parent_id,
                 )
             if (
                 "status" in content
                 and content["status"] == "ok"
                 and "payload" in content
@@ -967,14 +968,15 @@
                         signal(PAYLOAD_PAGE).send(
                             msg_id=parent_id,
                             notebook_id=nb_id,
                             data=payload_item["data"],
                             start=payload_item["start"],
                         )
         elif msg_type == "execute_input":
+            command.execution_count = content.get("execution_count", None)
             if command.type == CommandType.CELL_EXECUTION:
                 signal(CELL_EXECUTION_INPUT).send(
                     notebook_id=nb_id,
                     parent_id=parent_id,
                     content=content,
                 )
         elif (
@@ -1005,26 +1007,20 @@
                     CommandType.VARS_REQUEST,
                     CommandType.VAR_DETAIL_REQUEST,
                     CommandType.UPDATE_WORKDIR_REQUEST,
                 ]
                 if command.type not in suppress_stream_commands:
                     output = self.extract_d1_commands(output)
             if command.type == CommandType.CELL_EXECUTION:
-                if "outputs" not in cell:
-                    cell.outputs = []
-                cell.outputs.append(output)
+                self.append_cell_output(cell, output)
                 if "execution_count" in output:
-                    cell.execution_count = output.execution_count
+                    command.execution_count = output.execution_count
+                    cell.execution_count = command.execution_count
                 logger.debug(f"nb_manager posting CELL_UPDATE - {msg_type}")
-                if msg_type == "stream":
-                    signal(CELL_STREAM).send(
-                        output=output, notebook_id=nb_id, cell_id=cell_id
-                    )
-                else:
-                    signal(CELL_UPDATE).send(cells=[cell], notebook_id=nb_id)
+                signal(CELL_UPDATE).send(cells=[cell], notebook_id=nb_id)
             elif command.type == CommandType.SCRATCH_EXECUTION:
                 logger.debug(f"nb_manager posting SCRATCH_UPDATE - {msg_type}")
                 signal(SCRATCH_UPDATE).send(
                     msg_id=parent_id, notebook_id=nb_id, output=output
                 )
             elif command.type == CommandType.VARS_REQUEST:
                 vars_manager = self.get_vars_manager(nb_id)
@@ -1038,15 +1034,15 @@
                 if (
                     output.output_type in ("stream", "display_data")
                     and vars_manager is not None
                 ):
                     single_var = vars_manager.parse_single_var_response(output)
                     signal(VAR_DETAILS).send(
                         notebook_id=nb_id,
-                        var_name_inc=command.extras.get("var_name", None),
+                        parent_msg_id=parent_id,
                         single_var=single_var,
                     )
             elif command.type in (
                 CommandType.UPDATE_WORKDIR_REQUEST,
                 CommandType.CHANGE_WORKDIR_REQUEST,
             ):
                 workdir_manager = self.get_workdir_manager(nb_id)
@@ -1074,14 +1070,16 @@
                     cell.outputs = []
                     # The has_run flag is used so we only reset the cell
                     # output the first time this cell is "busy" as a result of
                     # this particular Command (another "busy" status and a
                     # "shutdown_reply" message are emitted on behalf of this
                     # Command on kernel restart)
                     command.extras["has_run"] = True
+                if execution_state == ExecutionState.idle:
+                    cell.execution_count = command.execution_count
                 signal(CELL_UPDATE).send(cells=[cell], notebook_id=nb_id)
                 if execution_state == ExecutionState.idle:
                     notebook = self.notebooks.get(nb_id, None)
                     if notebook is not None and notebook.autosave:
                         await self.save_notebook(uuid=nb_id)
             elif command.type == CommandType.SCRATCH_EXECUTION:
                 logger.debug("nb_manager posting SCRATCH_UPDATE - status")
@@ -1137,21 +1135,23 @@
                             if notebook is not None and notebook.autosave:
                                 await self.save_notebook(uuid=nb_id)
                             self.change_dav_workdir(nb_id, resolved_workdir)
                             signal(METADATA_UPDATE).send(
                                 notebook_id=nb_id, metadata=metadata
                             )
 
-            # If something just finished running, update kernel vars
+            # If something just finished running, update last idle
             if execution_state == ExecutionState.idle:
                 self.last_idle = datetime.utcnow()
 
-                if command.type not in (
-                    CommandType.UPDATE_WORKDIR_REQUEST,
-                    CommandType.CHANGE_WORKDIR_REQUEST,
+                # If it was user code that just finished running,
+                # update kernel vars and working directory
+                if command.type in (
+                    CommandType.CELL_EXECUTION,
+                    CommandType.SCRATCH_EXECUTION,
                 ):
                     await self.update_kernel_workdir(nb_id)
                     await self.update_kernel_vars(nb_id)
 
     def is_idle(self):
         for notebook in self.notebooks.values():
             for cell in notebook.node.cells:
@@ -1164,7 +1164,81 @@
             if command.extras.get("execution_state", None) not in (
                 ExecutionState.idle,
                 None,
             ):
                 return False
 
         return True
+
+    def append_cell_output(self, cell, output):
+        # Works like the classic jupyter client, see append_stream() in
+        # https://github.com/jupyter/nbclassic/blob/main/nbclassic/static/notebook/js/outputarea.js
+
+        if "outputs" not in cell:
+            cell.outputs = []
+
+        # If the new output isn't a stream type, just append and skip the rest
+        if output.output_type != "stream":
+            cell.outputs.append(output)
+            return
+
+        # New list, just append and go
+        if len(cell.outputs) == 0:
+            # 'normalize' whatever jupyter kernel spit out
+            output.text = self.collapse_carriage_return(output.text)
+            cell.outputs.append(output)
+            return
+
+        # Same name, add on to the existing output
+        lastOutput = cell.outputs[-1]
+        if lastOutput.name == output.name:
+            new_multi = self.append_to_multiline(lastOutput.text, output.text)
+            new_multi = self.collapse_carriage_return(new_multi)
+            lastOutput.text = new_multi
+        else:
+            # Not the same name, so add as new
+            # 'normalize' whatever jupyter kernel spit out
+            output.text = self.collapse_carriage_return(output.text)
+            cell.outputs.append(output)
+
+    def multiline_to_list(self, blob):
+        # If the blob is just a string, promote it to a list of strings,
+        # otherwise assume it is already a list of strings
+        if isinstance(blob, str):
+            blob = [blob]
+        return blob
+
+    def collapse_carriage_return(self, blob):
+        # Works like the classic jupyter client, see fixCarriageReturn() in
+        # https://github.com/jupyter/nbclassic/blob/main/nbclassic/static/base/js/utils.js
+
+        blob = self.multiline_to_list(blob)
+
+        # Make one big string with <token> separators we can split back out
+        # at the end to get the same strings if there are no \r chars
+        token = f"___TOKEN___{str(uuid4())}___"  # random token
+        joined = token.join(blob).replace("\r\n", "\n")  # make CR NL just NL
+
+        lines = joined.split("\n")
+        new_lines = []
+        for line in lines:
+            # Check for trailing \r.  Want to preserve that for merging with,
+            # future additions, but don't erase the current line
+            has_trailing_cr = line.endswith("\r")
+            if has_trailing_cr:
+                line = line[:-1]  # strip trailing \r before split
+            chunks = line.split("\r")
+            last = chunks[-1]
+            if has_trailing_cr:
+                last = last + "\r"  # restore trailing CR
+            new_lines.append(last)
+
+        new_joined = "\n".join(new_lines)
+        new_blob = new_joined.split(token)
+        return new_blob
+
+    def append_to_multiline(self, blob, newBlob):
+        blob = self.multiline_to_list(blob)
+        newBlob = self.multiline_to_list(newBlob)
+        blob.extend(newBlob)
+
+        return blob
```

### Comparing `callisto-jupyter-d1-0.0.7/jupyter_d1/storage/notebook_validator.py` & `callisto-jupyter-d1-0.0.9/jupyter_d1/storage/notebook_validator.py`

 * *Files identical despite different names*

### Comparing `callisto-jupyter-d1-0.0.7/jupyter_d1/storage/stats_manager.py` & `callisto-jupyter-d1-0.0.9/jupyter_d1/storage/stats_manager.py`

 * *Files identical despite different names*

### Comparing `callisto-jupyter-d1-0.0.7/jupyter_d1/tests/conftest.py` & `callisto-jupyter-d1-0.0.9/jupyter_d1/tests/conftest.py`

 * *Files 20% similar despite different names*

```diff
@@ -1,64 +1,62 @@
 import logging
 import os
 import shutil
+import tempfile
 import unittest
 from pathlib import Path
 from typing import AsyncGenerator, Dict, Generator
 
 import pytest  # type: ignore
-from async_asgi_testclient import (
-    TestClient as WebSocketTestClient,  # type: ignore
-)
 import pytest_asyncio
 from fastapi.logger import logger
-from fastapi.testclient import TestClient
 
 from jupyter_d1 import app
 from jupyter_d1.settings import settings
 
+from .D1TestClient import TestClient
 from .utils import (
     get_permissionless_token_headers,
     get_readonly_token_headers,
     get_superuser_token_headers,
 )
 
 enable_logger_output = False
 # enable_logger_output = True
 
 
-@pytest.fixture()
-def client() -> Generator:
-    with TestClient(app) as c:
+@pytest_asyncio.fixture()
+async def client() -> AsyncGenerator:
+    async with TestClient(app) as c:
         yield c
 
 
-@pytest.fixture()
-def superuser_token_headers(client: TestClient) -> Dict[str, str]:
-    return get_superuser_token_headers(client)
+@pytest_asyncio.fixture()
+async def superuser_token_headers(client: TestClient) -> Dict[str, str]:
+    return await get_superuser_token_headers(client)
 
 
 @pytest.fixture()
 def readonly_token_headers(client: TestClient) -> Dict[str, str]:
     return get_readonly_token_headers()
 
 
 @pytest.fixture()
 def permissionless_token_headers(client: TestClient) -> Dict[str, str]:
     return get_permissionless_token_headers()
 
 
-@pytest.fixture(scope="function")
-def clear_notebooks(
+@pytest_asyncio.fixture(scope="function")
+async def clear_notebooks(
     client: TestClient, superuser_token_headers: Dict[str, str]
-) -> Generator:
+) -> AsyncGenerator:
     yield
-    response = client.delete("/notebooks", headers=superuser_token_headers)
+    response = await client.delete("/notebooks", headers=superuser_token_headers)
     assert response.status_code == 204
-    response = client.get("/notebooks", headers=superuser_token_headers)
+    response = await client.get("/notebooks", headers=superuser_token_headers)
     assert response.status_code == 200
 
 
 @pytest.fixture(scope="function")
 def clear_notebook_directory(
     client: TestClient, superuser_token_headers: Dict[str, str]
 ) -> Generator:
@@ -74,32 +72,34 @@
                 elif os.path.isdir(file_path):
                     shutil.rmtree(file_path)
             except Exception as e:
                 print("Failed to delete %s. Reason: %s" % (file_path, e))
 
 
 @pytest.fixture(scope="function")
-def clear_notebook_directory_2() -> Generator:
-    workdir = Path("/tmp/test_nb_2/")
-    workdir.mkdir(parents=True, exist_ok=True)
+def other_notebook_directory() -> Generator:
+    with tempfile.TemporaryDirectory() as tmpdirname:
+        yield tmpdirname
+
+
+@pytest_asyncio.fixture(scope="function")
+async def clear_bg_kernel_runner() -> AsyncGenerator:
     yield
-    for filename in os.listdir(workdir):
-        file_path = os.path.join(workdir, filename)
-        try:
-            if os.path.isfile(file_path) or os.path.islink(file_path):
-                os.unlink(file_path)
-            elif os.path.isdir(file_path):
-                shutil.rmtree(file_path)
-        except Exception as e:
-            print("Failed to delete %s. Reason: %s" % (file_path, e))
+    import jupyter_d1.storage as storage
+    import jupyter_d1.dependency as dependency
+
+    dependency.dependency_managers = {}
+    await storage.bg_kernel_runner.clear()
+    await storage.kmanager.shutdown_all()
+    storage.kmanager.shutdown_warmups()
 
 
 @pytest_asyncio.fixture
 async def websocket_client() -> AsyncGenerator:
-    async with WebSocketTestClient(app) as c:
+    async with TestClient(app) as c:
         yield c
 
 
 @pytest.fixture()
 def ututils() -> unittest.TestCase:
     """Unittest TestCase so we can use useful things like assertCountEquals"""
     return unittest.TestCase()
```

### Comparing `callisto-jupyter-d1-0.0.7/jupyter_d1/tests/test_commands.py` & `callisto-jupyter-d1-0.0.9/jupyter_d1/tests/test_commands.py`

 * *Files identical despite different names*

### Comparing `callisto-jupyter-d1-0.0.7/jupyter_d1/tests/test_convert.py` & `callisto-jupyter-d1-0.0.9/jupyter_d1/tests/test_convert.py`

 * *Files 8% similar despite different names*

```diff
@@ -1,57 +1,61 @@
+import json
+import tempfile
 from io import StringIO
 from typing import Dict
-import json
 
-from fastapi.testclient import TestClient
+import pytest  # type: ignore
 from pytest_mock import MockFixture
 
+from .D1TestClient import TestClient
 from .utils import compare_cells
 
 
 def compare_notebooks(actual, expected):
     resp_cells = actual.pop("cells")
     expected_cells = expected.pop("cells")
     assert len(resp_cells) == len(expected_cells)
     for idx in range(len(resp_cells)):
         compare_cells(resp_cells[idx], expected_cells[idx])
 
     # Notebooks should match with the cells popped
     assert actual == expected
 
 
-def test_convert_rmd_to_ipynb(
+@pytest.mark.asyncio
+async def test_convert_rmd_to_ipynb(
     client: TestClient,
     readonly_token_headers: Dict[str, str],
 ) -> None:
     with open("jupyter_d1/tests/notebooks/worldpop.Rmd", "rb") as f1:
-        response = client.post(
+        response = await client.post(
             "/convert/rmd_to_ipynb",
             files={"file": ("worldpop.Rmd", f1)},
             headers=readonly_token_headers,
         )
         with open("jupyter_d1/tests/notebooks/worldpop.ipynb", "rb") as f2:
-            with open("/tmp/response.json", "wb") as ff:
+            with tempfile.TemporaryFile() as ff:
                 ff.write(response.content)
             resp_nb = json.loads(response.content.decode("utf-8"))
             expected_nb = json.load(f2)
             compare_notebooks(resp_nb, expected_nb)
 
     assert (
         response.headers["content-disposition"]
         == 'attachment; filename="worldpop.ipynb"'
     )
 
 
-def test_convert_rmd_with_R_to_ipynb(
+@pytest.mark.asyncio
+async def test_convert_rmd_with_R_to_ipynb(
     client: TestClient,
     readonly_token_headers: Dict[str, str],
 ) -> None:
     with open("jupyter_d1/tests/notebooks/rmd_example.Rmd", "rb") as f1:
-        response = client.post(
+        response = await client.post(
             "/convert/rmd_to_ipynb",
             files={"file": ("rmd_example.Rmd", f1)},
             headers=readonly_token_headers,
         )
         with open("jupyter_d1/tests/notebooks/rmd_example.ipynb", "rb") as f2:
             resp_nb = json.loads(response.content.decode("utf-8"))
             expected_nb = json.load(f2)
@@ -59,23 +63,24 @@
 
     assert (
         response.headers["content-disposition"]
         == 'attachment; filename="rmd_example.ipynb"'
     )
 
 
-def test_convert_rmd_to_ipynb_bogus_file(
+@pytest.mark.asyncio
+async def test_convert_rmd_to_ipynb_bogus_file(
     client: TestClient,
     readonly_token_headers: Dict[str, str],
     mocker: MockFixture,
 ) -> None:
     mock_jupytext = mocker.patch("jupyter_d1.routers.convert.jupytext")
     mock_jupytext.side_effect = KeyError("it did not work")
 
-    response = client.post(
+    response = await client.post(
         "/convert/rmd_to_ipynb",
         files={
             "file": (
                 "meta_info.json",
                 StringIO("%%%5not valid file\n````{{yurp}}\nprint(g)\n```"),
             )
         },
```

### Comparing `callisto-jupyter-d1-0.0.7/jupyter_d1/tests/test_dav.py` & `callisto-jupyter-d1-0.0.9/jupyter_d1/tests/test_dav.py`

 * *Files 8% similar despite different names*

```diff
@@ -1,142 +1,144 @@
 import asyncio
 import os
 import pathlib
 import platform
 import shutil
+import tempfile
 from typing import Dict
 from unittest import TestCase
 
 import pytest  # type: ignore
-from async_asgi_testclient import (
-    TestClient as WebSocketTestClient,  # type: ignore
-)
 from fastapi import WebSocket
-from fastapi.testclient import TestClient
-from pytest_mock import MockFixture  # type: ignore
 
 from jupyter_d1.settings import settings
 
+from .D1TestClient import TestClient
 from .test_notebooks_websocket import upload_notebook
 from .utils import (
     get_permissionless_token,
     get_read_only_token,
     get_superuser_token,
+    resolve,
     wait_for_event,
-    workdir_1,
 )
 
 is_mac = platform.system().startswith("Darwin")
 
+pytestmark = pytest.mark.asyncio
+
 
 class TestDav:
-    def test_dav_auth(
+    async def test_dav_auth(
         self,
         client: TestClient,
     ):
-        response = client.get("/dav")
+        response = await client.get("/dav/")
         assert response.status_code == 401
 
-        response = client.get(f"/dav/", auth=(get_permissionless_token(), ""))
+        response = await client.get(f"/dav/", auth=(get_permissionless_token(), ""))
         assert response.status_code == 401
 
         # Alias of / to ROOT_DIR was removed, make sure it doesn't work
-        response = client.get(f"/dav/", auth=(get_read_only_token(), ""))
+        response = await client.get(f"/dav/", auth=(get_read_only_token(), ""))
         assert response.status_code == 404
 
-        response = client.get(
+        response = await client.get(
             f"/dav{settings.ROOT_DIR}", auth=(get_read_only_token(), "")
         )
         assert response.status_code == 200
 
-        response = client.get(
+        response = await client.get(
             f"/dav{settings.ROOT_DIR}", auth=(get_superuser_token(), "")
         )
         assert response.status_code == 200
 
-    def test_dav_provider_added_for_notebook(
+    async def test_dav_provider_added_for_notebook(
         self, client: TestClient, superuser_token_headers: Dict[str, str]
     ):
         shutil.copyfile(
             "jupyter_d1/tests/notebooks/simple.ipynb",
             "jupyter_d1/tests/notebooks/simple_copy.ipynb",
         )
         other_directory = f"{os.getcwd()}/jupyter_d1/tests/notebooks"
         token = get_read_only_token()
-        response = client.get(f"/dav{other_directory}", auth=(token, ""))
+        response = await client.get(f"/dav{other_directory}", auth=(token, ""))
         assert response.status_code == 404
 
         path = f"{other_directory}/simple_copy.ipynb"
-        response = client.get(
+        response = await client.get(
             f"/notebooks/open/?filepath={path}",
             headers=superuser_token_headers,
         )
         assert response.status_code == 201
         resp_json = response.json()["notebook"]
         uuid = resp_json["metadata"]["jupyter_d1"]["uuid"]
 
         assert (
             resp_json["metadata"]["jupyter_d1"]["working_directory"]
             == other_directory
         )
-        response = client.get(f"/dav{other_directory}", auth=(token, ""))
+        response = await client.get(f"/dav{other_directory}", auth=(token, ""))
         assert response.status_code == 200
 
-        response = client.delete(
+        response = await client.delete(
             f"/notebooks/{uuid}", headers=superuser_token_headers
         )
         assert response.status_code == 204
 
-        response = client.get(f"/dav{other_directory}", auth=(token, ""))
+        response = await client.get(f"/dav{other_directory}", auth=(token, ""))
         assert response.status_code == 404
 
         os.remove("jupyter_d1/tests/notebooks/simple_copy.ipynb")
 
-    def test_dav_provider_added_for_notebook_set_working_dir(
+    async def test_dav_provider_added_for_notebook_set_working_dir(
         self, client: TestClient, superuser_token_headers: Dict[str, str]
     ):
         shutil.copyfile(
             "jupyter_d1/tests/notebooks/simple.ipynb",
             "jupyter_d1/tests/notebooks/simple_copy.ipynb",
         )
         other_directory = f"{os.getcwd()}/jupyter_d1/tests/notebooks"
-        working_dir = "/tmp"
-        resolved_work_dir = str(pathlib.Path(working_dir).resolve())
-        token = get_read_only_token()
-        response = client.get(f"/dav{resolved_work_dir}", auth=(token, ""))
-        assert response.status_code == 404
-
-        path = f"{other_directory}/simple_copy.ipynb"
-        response = client.get(
-            f"/notebooks/open/?filepath={path}",
-            headers=superuser_token_headers,
-            params={"working_directory": working_dir},
-        )
-        assert response.status_code == 201
-        resp_json = response.json()["notebook"]
-        uuid = resp_json["metadata"]["jupyter_d1"]["uuid"]
-
-        assert (
-            resp_json["metadata"]["jupyter_d1"]["working_directory"]
-            == resolved_work_dir
-        )
-        response = client.get(f"/dav{resolved_work_dir}", auth=(token, ""))
-        assert response.status_code == 200
+        with tempfile.TemporaryDirectory() as working_dir:
+            resolved_work_dir = str(pathlib.Path(working_dir).resolve())
+            token = get_read_only_token()
+            response = await client.get(f"/dav{resolved_work_dir}", auth=(token, ""))
+            assert response.status_code == 404
+
+            path = f"{other_directory}/simple_copy.ipynb"
+            response = await client.get(
+                f"/notebooks/open/",
+                headers=superuser_token_headers,
+                params={
+                    "working_directory": working_dir,
+                    "filepath": path,
+                },
+            )
+            assert response.status_code == 201
+            resp_json = response.json()["notebook"]
+            uuid = resp_json["metadata"]["jupyter_d1"]["uuid"]
+
+            assert (
+                resp_json["metadata"]["jupyter_d1"]["working_directory"]
+                == resolved_work_dir
+            )
+            response = await client.get(f"/dav{resolved_work_dir}", auth=(token, ""))
+            assert response.status_code == 200
 
-        response = client.delete(
-            f"/notebooks/{uuid}", headers=superuser_token_headers
-        )
-        assert response.status_code == 204
+            response = await client.delete(
+                f"/notebooks/{uuid}", headers=superuser_token_headers
+            )
+            assert response.status_code == 204
 
-        response = client.get(f"/dav{resolved_work_dir}", auth=(token, ""))
-        assert response.status_code == 404
+            response = await client.get(f"/dav{resolved_work_dir}", auth=(token, ""))
+            assert response.status_code == 404
 
-        os.remove("jupyter_d1/tests/notebooks/simple_copy.ipynb")
+            os.remove("jupyter_d1/tests/notebooks/simple_copy.ipynb")
 
-    def test_dav_provider_notebook_in_subdirectory(
+    async def test_dav_provider_notebook_in_subdirectory(
         self, client: TestClient, superuser_token_headers: Dict[str, str]
     ):
         """
         If notebook is in subdirectory of d1's working directory,
         dav should work regardless of whether the notebook is open.
         """
         pathlib.Path(f"{settings.ROOT_DIR}/some_nbs").mkdir(exist_ok=True)
@@ -144,47 +146,47 @@
             "jupyter_d1/tests/notebooks/simple.ipynb",
             f"{settings.ROOT_DIR}/some_nbs/simple_copy.ipynb",
         )
 
         nb_dir = f"{settings.ROOT_DIR}/some_nbs"
         working_dir = f"{settings.ROOT_DIR}/some_nbs"
         token = get_read_only_token()
-        response = client.get(f"/dav{working_dir}", auth=(token, ""))
+        response = await client.get(f"/dav{working_dir}", auth=(token, ""))
         assert response.status_code == 200
 
         path = f"{nb_dir}/simple_copy.ipynb"
-        response = client.get(
+        response = await client.get(
             f"/notebooks/open/?filepath={path}",
             headers=superuser_token_headers,
         )
         assert response.status_code == 201
         resp_json = response.json()["notebook"]
         uuid = resp_json["metadata"]["jupyter_d1"]["uuid"]
 
         assert (
             resp_json["metadata"]["jupyter_d1"]["working_directory"]
             == working_dir
         )
-        response = client.get(f"/dav{working_dir}", auth=(token, ""))
+        response = await client.get(f"/dav{working_dir}", auth=(token, ""))
         assert response.status_code == 200
 
-        response = client.delete(
+        response = await client.delete(
             f"/notebooks/{uuid}", headers=superuser_token_headers
         )
         assert response.status_code == 204
 
-        response = client.get(f"/dav{working_dir}", auth=(token, ""))
+        response = await client.get(f"/dav{working_dir}", auth=(token, ""))
         assert response.status_code == 200
 
         shutil.rmtree(f"{settings.ROOT_DIR}/some_nbs")
 
 
 @pytest.mark.asyncio
 @pytest.mark.usefixtures(
-    "clear_notebook_directory", "clear_notebook_directory_2"
+    "clear_notebook_directory"
 )
 class TestWatchdogWebSocket:
     async def clear_websocket_queue(self, websocket, wait_for=0.3):
         while True:
             try:
                 await asyncio.wait_for(websocket.receive_json(), wait_for)
             except Exception:
@@ -241,40 +243,29 @@
                     "src_path": f"{directory}/new_file",
                     "dest_path": None,
                 }
             },
         ]
         ututils.assertCountEqual([resp1, resp2], expected)
 
-    async def test_create_dir(
+    async def test_create(
         self,
-        websocket_client: WebSocketTestClient,
+        client: TestClient,
         superuser_token_headers: Dict[str, str],
         ututils: TestCase,
-        mocker: MockFixture,
     ):
-        async with websocket_client.websocket_connect(
+        async with client.websocket_connect(
             f"/server/ws", headers=superuser_token_headers
         ) as websocket:
             await self.create_dir(websocket, ututils)
-
-    async def test_create_file(
-        self,
-        websocket_client: WebSocketTestClient,
-        superuser_token_headers: Dict[str, str],
-        ututils: TestCase,
-    ):
-        async with websocket_client.websocket_connect(
-            f"/server/ws", headers=superuser_token_headers
-        ) as websocket:
             await self.create_file(websocket, ututils)
 
     async def test_modified_file(
         self,
-        websocket_client: WebSocketTestClient,
+        websocket_client: TestClient,
         superuser_token_headers: Dict[str, str],
         ututils: TestCase,
     ):
         async with websocket_client.websocket_connect(
             f"/server/ws", headers=superuser_token_headers
         ) as websocket:
             await self.clear_websocket_queue(websocket)
@@ -295,15 +286,15 @@
             for _ in expected:
                 resps.append(await wait_for_event(websocket, "watchdog_event"))
             for resp in resps:
                 assert expected.pop(expected.index(resp)) is not None
 
     async def test_deleted_file(
         self,
-        websocket_client: WebSocketTestClient,
+        websocket_client: TestClient,
         superuser_token_headers: Dict[str, str],
         ututils: TestCase,
     ):
         async with websocket_client.websocket_connect(
             f"/server/ws", headers=superuser_token_headers
         ) as websocket:
             await self.clear_websocket_queue(websocket)
@@ -345,15 +336,15 @@
                         }
                     }
                 )
             ututils.assertCountEqual(resps, expected)
 
     async def test_nested_updates(
         self,
-        websocket_client: WebSocketTestClient,
+        websocket_client: TestClient,
         superuser_token_headers: Dict[str, str],
         ututils: TestCase,
     ):
         async with websocket_client.websocket_connect(
             f"/server/ws", headers=superuser_token_headers
         ) as websocket:
             await self.clear_websocket_queue(websocket)
@@ -397,241 +388,357 @@
                     }
                 )
             else:
                 expected.append(
                     {
                         "watchdog_event": {
                             "event_type": "modified",
-                            "src_path": "/tmp/jupyter_d1_test",
+                            "src_path": settings.ROOT_DIR,
                             "dest_path": None,
                         }
                     }
                 )
             resps = []
             for _ in expected:
                 resps.append(await wait_for_event(websocket, "watchdog_event"))
             ututils.assertCountEqual(resps, expected)
 
     async def test_added_for_notebook(
         self,
-        websocket_client: WebSocketTestClient,
+        websocket_client: TestClient,
         superuser_token_headers: Dict[str, str],
     ):
         """
         Monitor new workdir for notebook, and stop monitoring when changed.
         """
         async with websocket_client.websocket_connect(
             f"/server/ws", headers=superuser_token_headers
         ) as websocket:
-            new_workdir = workdir_1
+            with tempfile.TemporaryDirectory() as new_workdir:
+                new_workdir = resolve(new_workdir)
 
-            # Should not get notified of directory changes yet
-            await self.clear_websocket_queue(websocket)
-            os.mkdir(f"{new_workdir}/new_dir")
-            with pytest.raises(AssertionError):
-                await wait_for_event(websocket, "watchdog_event")
-
-            # Upload notebook, workdir same as root dir
-            uuid = await upload_notebook(
-                websocket_client,
-                superuser_token_headers,
-            )
+                # Should not get notified of directory changes yet
+                await self.clear_websocket_queue(websocket)
+                os.mkdir(f"{new_workdir}/new_dir")
+                with pytest.raises(AssertionError):
+                    await wait_for_event(websocket, "watchdog_event")
+
+                # Upload notebook, workdir same as root dir
+                uuid = await upload_notebook(
+                    websocket_client,
+                    superuser_token_headers,
+                )
 
-            # Change nb workdir
-            response = await websocket_client.patch(
-                f"/notebooks/{uuid}/change_working_directory",
-                headers=superuser_token_headers,
-                query_string={"directory": new_workdir},
-            )
-            assert response.status_code == 200
+                await self.clear_websocket_queue(websocket)
 
-            # Make sure new nb workdir is now monitored for changes
-            await self.clear_websocket_queue(websocket)
-            os.mkdir(f"{new_workdir}/new_dir2")
-            event = await wait_for_event(websocket, "watchdog_event")
-            assert event == {
-                "watchdog_event": {
-                    "event_type": "created",
-                    "src_path": f"{new_workdir}/new_dir2",
-                    "dest_path": None,
+                # Change nb workdir
+                response = await websocket_client.patch(
+                    f"/notebooks/{uuid}/change_working_directory",
+                    headers=superuser_token_headers,
+                    query_string={"directory": new_workdir},
+                )
+                assert response.status_code == 200
+
+                event = await wait_for_event(websocket, "watchdog_event")
+                assert event == {
+                    "watchdog_event": {
+                        "event_type": "modified",
+                        "src_path": f"{settings.ROOT_DIR}/simple.ipynb",
+                        "dest_path": None,
+                    }
                 }
-            }
+                await self.clear_websocket_queue(websocket)
 
-            # Change nb workdir back to root dir
-            response = await websocket_client.patch(
-                f"/notebooks/{uuid}/change_working_directory",
-                headers=superuser_token_headers,
-                query_string={"directory": settings.ROOT_DIR},
-            )
-            assert response.status_code == 200
+                # Make sure new nb workdir is now monitored for changes
+                os.mkdir(f"{new_workdir}/new_dir2")
+                event = await wait_for_event(websocket, "watchdog_event")
+                assert event == {
+                    "watchdog_event": {
+                        "event_type": "created",
+                        "src_path": f"{new_workdir}/new_dir2",
+                        "dest_path": None,
+                    }
+                }
 
-            # Make sure previous nb workdir is no longer monitored
-            await self.clear_websocket_queue(websocket)
-            os.mkdir(f"{new_workdir}/new_dir3")
-            with pytest.raises(AssertionError):
-                await wait_for_event(websocket, "watchdog_event")
+                event = await wait_for_event(websocket, "watchdog_event")
+                assert event == {
+                    "watchdog_event": {
+                        "event_type": "modified",
+                        "src_path": new_workdir,
+                        "dest_path": None,
+                    }
+                }
+
+                # Change nb workdir back to root dir
+                response = await websocket_client.patch(
+                    f"/notebooks/{uuid}/change_working_directory",
+                    headers=superuser_token_headers,
+                    query_string={"directory": settings.ROOT_DIR},
+                )
+                assert response.status_code == 200
+
+                event = await wait_for_event(websocket, "watchdog_event")
+                assert event == {
+                    "watchdog_event": {
+                        "event_type": "modified",
+                        "src_path": f"{settings.ROOT_DIR}/simple.ipynb",
+                        "dest_path": None,
+                    }
+                }
+                await self.clear_websocket_queue(websocket)
+
+                # Make sure previous nb workdir is no longer monitored
+                os.mkdir(f"{new_workdir}/new_dir3")
+                with pytest.raises(
+                    (AssertionError, asyncio.exceptions.TimeoutError)
+                ):
+                    event = await wait_for_event(websocket, "watchdog_event")
 
     async def test_change_monitored_directory(
         self,
-        websocket_client: WebSocketTestClient,
+        websocket_client: TestClient,
         superuser_token_headers: Dict[str, str],
     ):
         """Monitor more specific directory when possible"""
         async with websocket_client.websocket_connect(
             f"/server/ws", headers=superuser_token_headers
         ) as websocket:
-            new_workdir = workdir_1
+            with tempfile.TemporaryDirectory() as new_workdir:
+                new_workdir = resolve(new_workdir)
 
-            # Should not get notified of directory changes yet
-            await self.clear_websocket_queue(websocket)
-            os.mkdir(f"{new_workdir}/new_dir")
-            with pytest.raises(AssertionError):
-                await wait_for_event(websocket, "watchdog_event")
-
-            # Upload notebook, workdir same as root dir
-            uuid = await upload_notebook(
-                websocket_client, superuser_token_headers
-            )
+                # Should not get notified of directory changes yet
+                await self.clear_websocket_queue(websocket)
+                os.mkdir(f"{new_workdir}/new_dir")
+                with pytest.raises(AssertionError):
+                    await wait_for_event(websocket, "watchdog_event")
+
+                # Upload notebook, workdir same as root dir
+                uuid = await upload_notebook(
+                    websocket_client, superuser_token_headers
+                )
 
-            # Change nb workdir
-            response = await websocket_client.patch(
-                f"/notebooks/{uuid}/change_working_directory",
-                headers=superuser_token_headers,
-                query_string={"directory": new_workdir},
-            )
-            assert response.status_code == 200
+                await self.clear_websocket_queue(websocket)
 
-            # Make sure new nb workdir is now monitored for changes
-            await self.clear_websocket_queue(websocket)
-            os.mkdir(f"{new_workdir}/new_dir2")
-            event = await wait_for_event(websocket, "watchdog_event")
-            assert event == {
-                "watchdog_event": {
-                    "event_type": "created",
-                    "src_path": f"{new_workdir}/new_dir2",
-                    "dest_path": None,
+                # Change nb workdir
+                response = await websocket_client.patch(
+                    f"/notebooks/{uuid}/change_working_directory",
+                    headers=superuser_token_headers,
+                    query_string={"directory": new_workdir},
+                )
+                assert response.status_code == 200
+
+                event = await wait_for_event(websocket, "watchdog_event")
+                assert event == {
+                    "watchdog_event": {
+                        "event_type": "modified",
+                        "src_path": f"{settings.ROOT_DIR}/simple.ipynb",
+                        "dest_path": None,
+                    }
                 }
-            }
 
-            # Change nb workdir to sub directory
-            response = await websocket_client.patch(
-                f"/notebooks/{uuid}/change_working_directory",
-                headers=superuser_token_headers,
-                query_string={"directory": f"{new_workdir}/new_dir"},
-            )
-            assert response.status_code == 200
+                await self.clear_websocket_queue(websocket)
 
-            # Make sure parent dir is no longer monitored
-            await self.clear_websocket_queue(websocket)
-            os.mkdir(f"{new_workdir}/new_dir3")
-            with pytest.raises(AssertionError):
-                await wait_for_event(websocket, "watchdog_event")
+                # Make sure new nb workdir is now monitored for changes
+                os.mkdir(f"{new_workdir}/new_dir2")
+                event = await wait_for_event(websocket, "watchdog_event")
+                assert event == {
+                    "watchdog_event": {
+                        "event_type": "created",
+                        "src_path": f"{new_workdir}/new_dir2",
+                        "dest_path": None,
+                    }
+                }
 
-            # Make sure sub dir is now monitored for changes
-            await self.clear_websocket_queue(websocket)
-            os.mkdir(f"{new_workdir}/new_dir/newer_dir")
-            event = await wait_for_event(websocket, "watchdog_event")
-            assert event == {
-                "watchdog_event": {
-                    "event_type": "created",
-                    "src_path": f"{new_workdir}/new_dir/newer_dir",
-                    "dest_path": None,
+                event = await wait_for_event(websocket, "watchdog_event")
+                assert event == {
+                    "watchdog_event": {
+                        "event_type": "modified",
+                        "src_path": new_workdir,
+                        "dest_path": None,
+                    }
+                }
+
+                # Change nb workdir to sub directory
+                response = await websocket_client.patch(
+                    f"/notebooks/{uuid}/change_working_directory",
+                    headers=superuser_token_headers,
+                    query_string={"directory": f"{new_workdir}/new_dir"},
+                )
+                assert response.status_code == 200
+
+                event = await wait_for_event(websocket, "watchdog_event")
+                assert event == {
+                    "watchdog_event": {
+                        "event_type": "modified",
+                        "src_path": f"{settings.ROOT_DIR}/simple.ipynb",
+                        "dest_path": None,
+                    }
+                }
+
+                await self.clear_websocket_queue(websocket)
+
+                # Make sure parent dir is no longer monitored
+                os.mkdir(f"{new_workdir}/new_dir3")
+                with pytest.raises(
+                    (AssertionError, asyncio.exceptions.TimeoutError)
+                ):
+                    await wait_for_event(websocket, "watchdog_event")
+
+                # Make sure sub dir is now monitored for changes
+                await self.clear_websocket_queue(websocket)
+                os.mkdir(f"{new_workdir}/new_dir/newer_dir")
+                event = await wait_for_event(websocket, "watchdog_event")
+                assert event == {
+                    "watchdog_event": {
+                        "event_type": "created",
+                        "src_path": f"{new_workdir}/new_dir/newer_dir",
+                        "dest_path": None,
+                    }
                 }
-            }
 
     async def test_multiple_notebooks(
         self,
-        websocket_client: WebSocketTestClient,
+        websocket_client: TestClient,
         superuser_token_headers: Dict[str, str],
     ):
         """
         Multiple notebooks, one with workdir that is parent dir of the other's
         workdir. Then switch the parent workdir to a sub dir, make sure both
         subdirs are still monitored, but not the parent
         """
         async with websocket_client.websocket_connect(
             f"/server/ws", headers=superuser_token_headers
         ) as websocket:
-            new_workdir = workdir_1
+            with tempfile.TemporaryDirectory() as new_workdir:
+                new_workdir = resolve(new_workdir)
 
-            # Should not get notified of directory changes yet
-            await self.clear_websocket_queue(websocket)
-            os.mkdir(f"{new_workdir}/new_dir")
-            with pytest.raises(AssertionError):
-                await wait_for_event(websocket, "watchdog_event")
-
-            # Upload notebook, workdir same as root dir
-            uuid = await upload_notebook(
-                websocket_client,
-                superuser_token_headers,
-            )
-            uuid2 = await upload_notebook(
-                websocket_client,
-                superuser_token_headers,
-                filename="other_simple.ipynb",
-            )
-            await asyncio.sleep(3.0)
+                # Should not get notified of directory changes yet
+                await self.clear_websocket_queue(websocket)
+                os.mkdir(f"{new_workdir}/new_dir")
+                with pytest.raises(AssertionError):
+                    await wait_for_event(websocket, "watchdog_event")
+
+                # Upload notebook, workdir same as root dir
+                uuid = await upload_notebook(
+                    websocket_client,
+                    superuser_token_headers,
+                )
+                uuid2 = await upload_notebook(
+                    websocket_client,
+                    superuser_token_headers,
+                    filename="other_simple.ipynb",
+                )
+                await asyncio.sleep(3.0)
+                await self.clear_websocket_queue(websocket)
 
-            # Change nb workdir
-            response = await websocket_client.patch(
-                f"/notebooks/{uuid}/change_working_directory",
-                headers=superuser_token_headers,
-                query_string={"directory": new_workdir},
-            )
-            assert response.status_code == 200
-            response = await websocket_client.patch(
-                f"/notebooks/{uuid2}/change_working_directory",
-                headers=superuser_token_headers,
-                query_string={"directory": f"{new_workdir}/new_dir"},
-            )
-            assert response.status_code == 200
+                # Change nb workdir
+                response = await websocket_client.patch(
+                    f"/notebooks/{uuid}/change_working_directory",
+                    headers=superuser_token_headers,
+                    query_string={"directory": new_workdir},
+                )
+                assert response.status_code == 200
 
-            # Make sure new nb workdir is now monitored for changes
-            await self.clear_websocket_queue(websocket)
-            await asyncio.sleep(10.0)
-            os.mkdir(f"{new_workdir}/new_dir2")
-            event = await wait_for_event(websocket, "watchdog_event")
-            assert event == {
-                "watchdog_event": {
-                    "event_type": "created",
-                    "src_path": f"{new_workdir}/new_dir2",
-                    "dest_path": None,
+                event = await wait_for_event(websocket, "watchdog_event")
+                assert event == {
+                    "watchdog_event": {
+                        "event_type": "modified",
+                        "src_path": f"{settings.ROOT_DIR}/simple.ipynb",
+                        "dest_path": None,
+                    }
                 }
-            }
 
-            # Change nb workdir to sub directory
-            response = await websocket_client.patch(
-                f"/notebooks/{uuid}/change_working_directory",
-                headers=superuser_token_headers,
-                query_string={"directory": f"{new_workdir}/new_dir2"},
-            )
-            assert response.status_code == 200
+                await self.clear_websocket_queue(websocket)
 
-            # Make sure parent dir is no longer monitored
-            await self.clear_websocket_queue(websocket)
-            os.mkdir(f"{new_workdir}/new_dir3")
-            with pytest.raises(AssertionError):
-                await wait_for_event(websocket, "watchdog_event")
+                response = await websocket_client.patch(
+                    f"/notebooks/{uuid2}/change_working_directory",
+                    headers=superuser_token_headers,
+                    query_string={"directory": f"{new_workdir}/new_dir"},
+                )
+                assert response.status_code == 200
 
-            # Make sure sub dir is still monitored for changes
-            await self.clear_websocket_queue(websocket)
-            os.mkdir(f"{new_workdir}/new_dir/newer_dir")
-            event = await wait_for_event(websocket, "watchdog_event")
-            assert event == {
-                "watchdog_event": {
-                    "event_type": "created",
-                    "src_path": f"{new_workdir}/new_dir/newer_dir",
-                    "dest_path": None,
+                event = await wait_for_event(websocket, "watchdog_event")
+                assert event == {
+                    "watchdog_event": {
+                        "event_type": "modified",
+                        "src_path": f"{settings.ROOT_DIR}/other_simple.ipynb",
+                        "dest_path": None,
+                    }
                 }
-            }
 
-            # Make sure other sub dir is now also monitored for changes
-            await self.clear_websocket_queue(websocket)
-            os.mkdir(f"{new_workdir}/new_dir2/newer_dir2")
-            event = await wait_for_event(websocket, "watchdog_event")
-            assert event == {
-                "watchdog_event": {
-                    "event_type": "created",
-                    "src_path": f"{new_workdir}/new_dir2/newer_dir2",
-                    "dest_path": None,
+                await self.clear_websocket_queue(websocket)
+
+                # Make sure new nb workdir is now monitored for changes
+                os.mkdir(f"{new_workdir}/new_dir2")
+                event = await wait_for_event(websocket, "watchdog_event")
+                assert event == {
+                    "watchdog_event": {
+                        "event_type": "created",
+                        "src_path": f"{new_workdir}/new_dir2",
+                        "dest_path": None,
+                    }
+                }
+
+                event = await wait_for_event(websocket, "watchdog_event")
+                assert event == {
+                    "watchdog_event": {
+                        "event_type": "modified",
+                        "src_path": new_workdir,
+                        "dest_path": None,
+                    }
+                }
+
+                # Change nb workdir to sub directory
+                response = await websocket_client.patch(
+                    f"/notebooks/{uuid}/change_working_directory",
+                    headers=superuser_token_headers,
+                    query_string={"directory": f"{new_workdir}/new_dir2"},
+                )
+                assert response.status_code == 200
+
+                event = await wait_for_event(websocket, "watchdog_event")
+                assert event == {
+                    "watchdog_event": {
+                        "event_type": "modified",
+                        "src_path": f"{settings.ROOT_DIR}/simple.ipynb",
+                        "dest_path": None,
+                    }
+                }
+
+                await self.clear_websocket_queue(websocket)
+
+                # Make sure parent dir is no longer monitored
+                os.mkdir(f"{new_workdir}/new_dir3")
+                with pytest.raises(
+                    (AssertionError, asyncio.exceptions.TimeoutError)
+                ):
+                    await wait_for_event(websocket, "watchdog_event")
+
+                # Make sure sub dir is still monitored for changes
+                os.mkdir(f"{new_workdir}/new_dir/newer_dir")
+                event = await wait_for_event(websocket, "watchdog_event")
+                assert event == {
+                    "watchdog_event": {
+                        "event_type": "created",
+                        "src_path": f"{new_workdir}/new_dir/newer_dir",
+                        "dest_path": None,
+                    }
+                }
+                event = await wait_for_event(websocket, "watchdog_event")
+                assert event == {
+                    "watchdog_event": {
+                        "event_type": "modified",
+                        "src_path": f"{new_workdir}/new_dir",
+                        "dest_path": None,
+                    }
+                }
+
+                # Make sure other sub dir is now also monitored for changes
+                os.mkdir(f"{new_workdir}/new_dir2/newer_dir2")
+                event = await wait_for_event(websocket, "watchdog_event")
+                assert event == {
+                    "watchdog_event": {
+                        "event_type": "created",
+                        "src_path": f"{new_workdir}/new_dir2/newer_dir2",
+                        "dest_path": None,
+                    }
                 }
-            }
```

### Comparing `callisto-jupyter-d1-0.0.7/jupyter_d1/tests/test_login.py` & `callisto-jupyter-d1-0.0.9/jupyter_d1/tests/test_login.py`

 * *Files 22% similar despite different names*

```diff
@@ -1,32 +1,36 @@
 from typing import Dict
 
-from fastapi.testclient import TestClient
+import pytest  # type: ignore
 
+from .D1TestClient import TestClient
 
-def test_get_access_token(client: TestClient) -> None:
-    r = client.get(f"/login/access-token", headers={"Authorization": "bogus"})
+
+@pytest.mark.asyncio
+async def test_get_access_token(client: TestClient) -> None:
+    r = await client.get(f"/login/access-token", headers={"Authorization": "bogus"})
     assert r.status_code == 401
 
-    r = client.get(f"/login/access-token")
+    r = await client.get(f"/login/access-token")
     assert r.status_code == 401
 
-    r = client.get(
+    r = await client.get(
         f"/login/access-token", headers={"Authorization": "test9token_4"}
     )
     tokens = r.json()["token"]
     assert r.status_code == 200
     assert "access_token" in tokens
     assert tokens["access_token"]
 
 
-def test_use_access_token(
+@pytest.mark.asyncio
+async def test_use_access_token(
     client: TestClient, superuser_token_headers: Dict[str, str]
 ) -> None:
-    r = client.post(
+    r = await client.post(
         f"/login/test-token",
         headers=superuser_token_headers,
     )
     result = r.json()["permission"]
     assert r.status_code == 200
     assert result["id"] == -1
     assert result["user_id"] == -1
```

### Comparing `callisto-jupyter-d1-0.0.7/jupyter_d1/tests/test_notebooks.py` & `callisto-jupyter-d1-0.0.9/jupyter_d1/tests/test_notebooks.py`

 * *Files 16% similar despite different names*

```diff
@@ -1,131 +1,134 @@
 import json
 import os
 import pathlib
 from typing import Dict, Tuple
 
 import pytest  # type: ignore
-from fastapi.testclient import TestClient
 
 from jupyter_d1.settings import settings
+
+from .D1TestClient import TestClient
 from .utils import msg_id_lengths
 
+pytestmark = pytest.mark.asyncio
+
 
-def upload_notebook(
+async def upload_notebook(
     client: TestClient,
     token_headers: Dict[str, str],
     filename: str = "simple.ipynb",
 ) -> str:
     nb_filename = f"jupyter_d1/tests/notebooks/{filename}"
     nb_json = open(nb_filename).read()
-    response = client.post(
+    response = await client.post(
         "/notebooks/upload",
         params={"filename": filename},
         data=nb_json,
         headers=token_headers,
     )
     assert response.status_code == 201
     path = response.json()["path"]
 
-    response = client.get(
+    response = await client.get(
         f"/notebooks/open/?filepath={path}", headers=token_headers
     )
     assert response.status_code == 201
     resp_json = response.json()["notebook"]
     uuid = resp_json["metadata"]["jupyter_d1"]["uuid"]
     return uuid
 
 
 @pytest.mark.usefixtures("clear_notebooks", "clear_notebook_directory")
 class TestNotebook:
-    def test_notebook(
+    async def test_notebook(
         self, client: TestClient, superuser_token_headers: Dict[str, str]
     ):
-        uuid = upload_notebook(client, superuser_token_headers)
-        response = client.get(
+        uuid = await upload_notebook(client, superuser_token_headers)
+        response = await client.get(
             f"/notebooks/{uuid}", headers=superuser_token_headers
         )
         assert response.status_code == 200
         nb = response.json()["notebook"]
         assert "cells" in nb.keys()
         assert "metadata" in nb.keys()
         assert "nbformat" in nb.keys()
         assert "nbformat_minor" in nb.keys()
         assert nb["metadata"]["jupyter_d1"]["uuid"] == uuid
 
-    def test_notebooks(
+    async def test_notebooks(
         self, client: TestClient, superuser_token_headers: Dict[str, str]
     ):
-        uuid = upload_notebook(client, superuser_token_headers, "simple.ipynb")
-        uuid2 = upload_notebook(
+        uuid = await upload_notebook(client, superuser_token_headers, "simple.ipynb")
+        uuid2 = await upload_notebook(
             client, superuser_token_headers, "other_simple.ipynb"
         )
-        response = client.get("/notebooks", headers=superuser_token_headers)
+        response = await client.get("/notebooks", headers=superuser_token_headers)
         assert response.status_code == 200
         resp_json = response.json()
         notebooks = resp_json["notebooks"]
         assert len(notebooks) == 2
 
         ret_uuid = notebooks[0]["metadata"]["jupyter_d1"]["uuid"]
         ret_uuid2 = notebooks[1]["metadata"]["jupyter_d1"]["uuid"]
         assert uuid != uuid2
         assert set([uuid, uuid2]) == set([ret_uuid, ret_uuid2])
 
-    def test_delete_notebooks(
+    async def test_delete_notebooks(
         self, client: TestClient, superuser_token_headers: Dict[str, str]
     ):
-        upload_notebook(client, superuser_token_headers, "simple.ipynb")
-        upload_notebook(client, superuser_token_headers, "other_simple.ipynb")
-        response = client.get("/notebooks", headers=superuser_token_headers)
+        await upload_notebook(client, superuser_token_headers, "simple.ipynb")
+        await upload_notebook(client, superuser_token_headers, "other_simple.ipynb")
+        response = await client.get("/notebooks", headers=superuser_token_headers)
         assert response.status_code == 200
         resp_json = response.json()["notebooks"]
         assert len(resp_json) == 2
 
-        response = client.delete("/notebooks", headers=superuser_token_headers)
+        response = await client.delete("/notebooks", headers=superuser_token_headers)
         assert response.status_code == 204
 
-        response = client.get("/notebooks", headers=superuser_token_headers)
+        response = await client.get("/notebooks", headers=superuser_token_headers)
         assert response.status_code == 200
         resp_json = response.json()["notebooks"]
         assert len(resp_json) == 0
 
-    def test_delete_notebook(
+    async def test_delete_notebook(
         self, client: TestClient, superuser_token_headers: Dict[str, str]
     ):
-        uuid = upload_notebook(client, superuser_token_headers, "simple.ipynb")
-        uuid2 = upload_notebook(
+        uuid = await upload_notebook(client, superuser_token_headers, "simple.ipynb")
+        uuid2 = await upload_notebook(
             client, superuser_token_headers, "other_simple.ipynb"
         )
-        response = client.get("/notebooks", headers=superuser_token_headers)
+        response = await client.get("/notebooks", headers=superuser_token_headers)
         assert response.status_code == 200
         resp_json = response.json()["notebooks"]
         assert len(resp_json) == 2
         ret_uuid = resp_json[0]["metadata"]["jupyter_d1"]["uuid"]
         ret_uuid2 = resp_json[1]["metadata"]["jupyter_d1"]["uuid"]
         assert set([uuid, uuid2]) == set([ret_uuid, ret_uuid2])
 
         # delete the first one
-        response = client.delete(
+        response = await client.delete(
             f"/notebooks/{uuid}", headers=superuser_token_headers
         )
         assert response.status_code == 204
 
-        response = client.get("/notebooks", headers=superuser_token_headers)
+        response = await client.get("/notebooks", headers=superuser_token_headers)
         assert response.status_code == 200
         resp_json = response.json()["notebooks"]
         assert len(resp_json) == 1
         # remaining notebook should have uuid2
         assert resp_json[0]["metadata"]["jupyter_d1"]["uuid"] == uuid2
 
-    def test_cells(
+    async def test_cells(
         self, client: TestClient, superuser_token_headers: Dict[str, str]
     ):
-        uuid = upload_notebook(client, superuser_token_headers, "simple.ipynb")
+        uuid = await upload_notebook(client, superuser_token_headers, "simple.ipynb")
 
-        response = client.get(
+        response = await client.get(
             f"/notebooks/{uuid}/cells", headers=superuser_token_headers
         )
         assert response.status_code == 200
         cells = response.json()["cells"]
         assert len(cells) == 4
 
         for cell in cells:
@@ -137,56 +140,56 @@
         assert cell0["cell_type"] == "markdown"
         assert cell0["source"] == "## Simple Test Notebook"
 
         cell1 = cells[1]
         assert cell1["cell_type"] == "code"
         assert cell1["source"] == 'print("Larry the Llama")'
 
-    def test_one_cell(
+    async def test_one_cell(
         self, client: TestClient, superuser_token_headers: Dict[str, str]
     ):
-        uuid = upload_notebook(client, superuser_token_headers, "simple.ipynb")
+        uuid = await upload_notebook(client, superuser_token_headers, "simple.ipynb")
 
-        response = client.get(
+        response = await client.get(
             f"/notebooks/{uuid}/cells", headers=superuser_token_headers
         )
         assert response.status_code == 200
         cells = response.json()["cells"]
 
         cell1 = cells[1]
         cell1_uuid = cell1["metadata"]["jupyter_d1"]["uuid"]
 
-        response = client.get(
+        response = await client.get(
             f"/notebooks/{uuid}/cells/{cell1_uuid}",
             headers=superuser_token_headers,
         )
         assert response.status_code == 200
 
         cell = response.json()["cell"]
         uuid = cell["metadata"]["jupyter_d1"]["uuid"]
         assert uuid == cell1_uuid
         assert cell["cell_type"] == "code"
         assert cell["source"] == 'print("Larry the Llama")'
 
-    def test_patch_cell(
+    async def test_patch_cell(
         self, client: TestClient, superuser_token_headers: Dict[str, str]
     ):
-        uuid = upload_notebook(client, superuser_token_headers, "simple.ipynb")
+        uuid = await upload_notebook(client, superuser_token_headers, "simple.ipynb")
 
-        response = client.get(
+        response = await client.get(
             f"/notebooks/{uuid}/cells", headers=superuser_token_headers
         )
         assert response.status_code == 200
         cells = response.json()["cells"]
 
         cell1 = cells[1]
         cell1_uuid = cell1["metadata"]["jupyter_d1"]["uuid"]
 
         new_source = 'hello = "world"'
-        response = client.patch(
+        response = await client.patch(
             f"/notebooks/{uuid}/cells/{cell1_uuid}",
             headers=superuser_token_headers,
             json={"source": new_source},
         )
         assert response.status_code == 200
         # check that the returned cell has the new source
         cell = response.json()["cell"]
@@ -198,29 +201,29 @@
         assert (
             file_nb["cells"][1]["metadata"]["jupyter_d1"]["uuid"]
             == cell["metadata"]["jupyter_d1"]["uuid"]
         )
         assert file_nb["cells"][1]["source"][0] == new_source
 
         # check that retrieving the cell has has the new source
-        response = client.get(
+        response = await client.get(
             f"/notebooks/{uuid}/cells/{cell1_uuid}",
             headers=superuser_token_headers,
         )
         assert response.status_code == 200
         cell = response.json()["cell"]
         assert cell["source"] == new_source
 
-    def test_create_cell(
+    async def test_create_cell(
         self, client: TestClient, superuser_token_headers: Dict[str, str]
     ):
-        uuid = upload_notebook(client, superuser_token_headers, "simple.ipynb")
+        uuid = await upload_notebook(client, superuser_token_headers, "simple.ipynb")
 
         # get the existing cells
-        response = client.get(
+        response = await client.get(
             f"/notebooks/{uuid}/cells", headers=superuser_token_headers
         )
         assert response.status_code == 200
         cells = response.json()["cells"]
         orig_uuids = list(
             map(lambda x: x["metadata"]["jupyter_d1"]["uuid"], cells)
         )
@@ -231,15 +234,15 @@
         # add a new cell before index 1
         src = "__**Hello Callist**__"
         params = {
             "before": before_uuid,
             "cell_type": "markdown",
             "source": src,
         }
-        response = client.post(
+        response = await client.post(
             f"/notebooks/{uuid}/cells",
             json=params,
             headers=superuser_token_headers,
         )
         assert response.status_code == 201
         new_cell = response.json()["cell"]
         assert new_cell["cell_type"] == "markdown"
@@ -256,75 +259,75 @@
             file_nb = json.loads(f.read())
         assert (
             file_nb["cells"][1]["metadata"]["jupyter_d1"]["uuid"]
             == new_cell["metadata"]["jupyter_d1"]["uuid"]
         )
 
         # get the new list of cells
-        response = client.get(
+        response = await client.get(
             f"/notebooks/{uuid}/cells", headers=superuser_token_headers
         )
         new_cells = response.json()["cells"]
         new_uuids = list(
             map(lambda x: x["metadata"]["jupyter_d1"]["uuid"], new_cells)
         )
         assert len(new_uuids) == 5
 
         # assert the new list of uuids is the old list with the new uuid
         assert new_uuids == orig_uuids
 
         # add a new cell at the end (omit position parameter)
-        response = client.post(
+        response = await client.post(
             f"/notebooks/{uuid}/cells",
             json={},
             headers=superuser_token_headers,
         )
         assert response.status_code == 201
         new_cell = response.json()["cell"]
 
         new_cell_uuid = new_cell["metadata"]["jupyter_d1"]["uuid"]
         assert len(new_cell_uuid) == 36
 
         # insert the new uuid into the original list
         orig_uuids.append(new_cell_uuid)
 
         # get the new list of cells
-        response = client.get(
+        response = await client.get(
             f"/notebooks/{uuid}/cells", headers=superuser_token_headers
         )
         new_cells = response.json()["cells"]
         new_uuids = list(
             map(lambda x: x["metadata"]["jupyter_d1"]["uuid"], new_cells)
         )
 
         # assert the new list of uuids is the old list with the new uuid
         assert new_uuids == orig_uuids
 
-    def test_move_cell(
+    async def test_move_cell(
         self, client: TestClient, superuser_token_headers: Dict[str, str]
     ):
-        uuid = upload_notebook(client, superuser_token_headers, "simple.ipynb")
+        uuid = await upload_notebook(client, superuser_token_headers, "simple.ipynb")
 
         # get the existing cells
-        response = client.get(
+        response = await client.get(
             f"/notebooks/{uuid}/cells", headers=superuser_token_headers
         )
         assert response.status_code == 200
         cells = response.json()["cells"]
         orig_uuids = list(
             map(lambda x: x["metadata"]["jupyter_d1"]["uuid"], cells)
         )
 
         assert len(orig_uuids) == 4
         # move the third cell 'before' the second cell (swap positions)
         move_uuid = orig_uuids[2]  # place the new cell before position 1
         before_uuid = orig_uuids[1]  # place the new cell before position 1
 
         params = {"before": before_uuid}
-        response = client.get(
+        response = await client.get(
             f"/notebooks/{uuid}/cells/{move_uuid}/move",
             params=params,
             headers=superuser_token_headers,
         )
         assert response.status_code == 204
 
         # This is the expected reordering
@@ -342,55 +345,55 @@
             map(
                 lambda x: x["metadata"]["jupyter_d1"]["uuid"], file_nb["cells"]
             )
         )
         assert file_uuids == reordered_uuids
 
         # get the new list of cells
-        response = client.get(
+        response = await client.get(
             f"/notebooks/{uuid}/cells", headers=superuser_token_headers
         )
         new_cells = response.json()["cells"]
         new_uuids = list(
             map(lambda x: x["metadata"]["jupyter_d1"]["uuid"], new_cells)
         )
         assert len(new_uuids) == 4
 
         # assert the new list of uuids is the old list with the new uuid
         assert new_uuids == reordered_uuids
 
         move_uuid = reordered_uuids[0]
         # move the first cell to the end (omit position parameter)
-        response = client.get(
+        response = await client.get(
             f"/notebooks/{uuid}/cells/{move_uuid}/move",
             headers=superuser_token_headers,
         )
         assert response.status_code == 204
 
         # final list just has the first cell moved to the end
         final_uuids = [
             reordered_uuids[1],
             reordered_uuids[2],
             reordered_uuids[3],
             reordered_uuids[0],
         ]
 
         # get the new list of cells
-        response = client.get(
+        response = await client.get(
             f"/notebooks/{uuid}/cells", headers=superuser_token_headers
         )
         new_cells = response.json()["cells"]
         new_uuids = list(
             map(lambda x: x["metadata"]["jupyter_d1"]["uuid"], new_cells)
         )
 
         # assert the new list of uuids is the old list with the new uuid
         assert new_uuids == final_uuids
 
-    def _test_merge_cells(
+    async def _test_merge_cells(
         self,
         client: TestClient,
         superuser_token_headers: Dict[str, str],
         uuid: str,
         position: int,
         above: bool,
         cell_types: Tuple[str, str],
@@ -399,291 +402,291 @@
             position_1 = position - 1
             position_2 = position
         else:
             position_1 = position
             position_2 = position + 1
 
         # get the existing cells
-        response = client.get(
+        response = await client.get(
             f"/notebooks/{uuid}/cells", headers=superuser_token_headers
         )
         assert response.status_code == 200
         cells = response.json()["cells"]
         assert len(cells) == 4
         cell_uuid = cells[position]["metadata"]["jupyter_d1"]["uuid"]
         cell_1_source = cells[position_1]["source"]
         assert cells[position_1]["cell_type"] == cell_types[0]
         cell_2_source = cells[position_2]["source"]
         assert cells[position_2]["cell_type"] == cell_types[1]
 
         params = {}
         if above:
             params["above"] = True
-        response = client.get(
+        response = await client.get(
             f"/notebooks/{uuid}/cells/{cell_uuid}/merge",
             params=params,
             headers=superuser_token_headers,
         )
         assert response.status_code == 204
 
-        response = client.get(
+        response = await client.get(
             f"/notebooks/{uuid}/cells", headers=superuser_token_headers
         )
         assert response.status_code == 200
         cells = response.json()["cells"]
         assert len(cells) == 3
         cell = cells[position_1]
         assert cell["source"] == f"{cell_1_source}\n{cell_2_source}"
         assert cell["cell_type"] == cell_types[1 if above else 0]
         assert cell["metadata"]["jupyter_d1"]["uuid"] == cell_uuid
 
-        response = client.get(
+        response = await client.get(
             f"/notebooks/{uuid}/undo", headers=superuser_token_headers
         )
         assert response.status_code == 204
 
-        response = client.get(
+        response = await client.get(
             f"/notebooks/{uuid}/cells", headers=superuser_token_headers
         )
         assert response.status_code == 200
         cells = response.json()["cells"]
         assert len(cells) == 4
         assert cells[position]["metadata"]["jupyter_d1"]["uuid"] == cell_uuid
         assert cells[position_1]["source"] == cell_1_source
         assert cells[position_1]["cell_type"] == cell_types[0]
         assert cells[position_2]["source"] == cell_2_source
         assert cells[position_2]["cell_type"] == cell_types[1]
 
-        response = client.get(
+        response = await client.get(
             f"/notebooks/{uuid}/redo", headers=superuser_token_headers
         )
         assert response.status_code == 204
 
-        response = client.get(
+        response = await client.get(
             f"/notebooks/{uuid}/cells", headers=superuser_token_headers
         )
         assert response.status_code == 200
         cells = response.json()["cells"]
         assert len(cells) == 3
         cell = cells[position_1]
         assert cell["source"] == f"{cell_1_source}\n{cell_2_source}"
         assert cell["cell_type"] == cell_types[1 if above else 0]
         assert cell["metadata"]["jupyter_d1"]["uuid"] == cell_uuid
 
-    def test_merge_cells(
+    async def test_merge_cells(
         self, client: TestClient, superuser_token_headers: Dict[str, str]
     ):
-        uuid = upload_notebook(client, superuser_token_headers, "simple.ipynb")
-        self._test_merge_cells(
+        uuid = await upload_notebook(client, superuser_token_headers, "simple.ipynb")
+        await self._test_merge_cells(
             client,
             superuser_token_headers,
             uuid=uuid,
             position=1,
             above=False,
             cell_types=("code", "code"),
         )
 
-    def test_merge_cells_above(
+    async def test_merge_cells_above(
         self, client: TestClient, superuser_token_headers: Dict[str, str]
     ):
-        uuid = upload_notebook(client, superuser_token_headers, "simple.ipynb")
-        self._test_merge_cells(
+        uuid = await upload_notebook(client, superuser_token_headers, "simple.ipynb")
+        await self._test_merge_cells(
             client,
             superuser_token_headers,
             uuid=uuid,
             position=1,
             above=True,
             cell_types=("markdown", "code"),
         )
 
-    def test_merge_first_2_cells(
+    async def test_merge_first_2_cells(
         self, client: TestClient, superuser_token_headers: Dict[str, str]
     ):
-        uuid = upload_notebook(client, superuser_token_headers, "simple.ipynb")
-        self._test_merge_cells(
+        uuid = await upload_notebook(client, superuser_token_headers, "simple.ipynb")
+        await self._test_merge_cells(
             client,
             superuser_token_headers,
             uuid=uuid,
             position=0,
             above=False,
             cell_types=("markdown", "code"),
         )
 
-    def test_merge_last_2_cells(
+    async def test_merge_last_2_cells(
         self, client: TestClient, superuser_token_headers: Dict[str, str]
     ):
-        uuid = upload_notebook(client, superuser_token_headers, "simple.ipynb")
-        self._test_merge_cells(
+        uuid = await upload_notebook(client, superuser_token_headers, "simple.ipynb")
+        await self._test_merge_cells(
             client,
             superuser_token_headers,
             uuid=uuid,
             position=3,
             above=True,
             cell_types=("code", "code"),
         )
 
-    def _test_split_cell(
+    async def _test_split_cell(
         self,
         client: TestClient,
         superuser_token_headers: Dict[str, str],
         uuid: str,
         position: int,
         split_location: int,
         expected_sources: Tuple[str, str],
         cell_type: str,
     ):
         # get the existing cells
-        response = client.get(
+        response = await client.get(
             f"/notebooks/{uuid}/cells", headers=superuser_token_headers
         )
         assert response.status_code == 200
         cells = response.json()["cells"]
         assert len(cells) == 4
         cell_uuid = cells[position]["metadata"]["jupyter_d1"]["uuid"]
         original_source = cells[position]["source"]
         assert cells[position]["cell_type"] == cell_type
 
-        response = client.get(
+        response = await client.get(
             f"/notebooks/{uuid}/cells/{cell_uuid}/split",
             params={"split_location": split_location},
             headers=superuser_token_headers,
         )
         assert response.status_code == 204
 
-        response = client.get(
+        response = await client.get(
             f"/notebooks/{uuid}/cells", headers=superuser_token_headers
         )
         assert response.status_code == 200
         cells = response.json()["cells"]
         assert len(cells) == 5
         assert cells[position]["source"] == expected_sources[0]
         assert cells[position]["cell_type"] == cell_type
         assert cells[position + 1]["source"] == expected_sources[1]
         assert cells[position + 1]["cell_type"] == cell_type
         assert cells[position]["metadata"]["jupyter_d1"]["uuid"] == cell_uuid
 
-        response = client.get(
+        response = await client.get(
             f"/notebooks/{uuid}/undo", headers=superuser_token_headers
         )
         assert response.status_code == 204
 
-        response = client.get(
+        response = await client.get(
             f"/notebooks/{uuid}/cells", headers=superuser_token_headers
         )
         assert response.status_code == 200
         cells = response.json()["cells"]
         assert len(cells) == 4
         assert cells[position]["metadata"]["jupyter_d1"]["uuid"] == cell_uuid
         assert cells[position]["source"] == original_source
         assert cells[position]["cell_type"] == cell_type
 
-        response = client.get(
+        response = await client.get(
             f"/notebooks/{uuid}/redo", headers=superuser_token_headers
         )
         assert response.status_code == 204
 
-        response = client.get(
+        response = await client.get(
             f"/notebooks/{uuid}/cells", headers=superuser_token_headers
         )
         assert response.status_code == 200
         cells = response.json()["cells"]
         assert len(cells) == 5
         assert cells[position]["source"] == expected_sources[0]
         assert cells[position]["cell_type"] == cell_type
         assert cells[position + 1]["source"] == expected_sources[1]
         assert cells[position + 1]["cell_type"] == cell_type
         assert cells[position]["metadata"]["jupyter_d1"]["uuid"] == cell_uuid
 
-    def test_split_cell(
+    async def test_split_cell(
         self, client: TestClient, superuser_token_headers: Dict[str, str]
     ):
-        uuid = upload_notebook(client, superuser_token_headers, "simple.ipynb")
-        self._test_split_cell(
+        uuid = await upload_notebook(client, superuser_token_headers, "simple.ipynb")
+        await self._test_split_cell(
             client,
             superuser_token_headers,
             uuid=uuid,
             position=2,
             split_location=2,
             expected_sources=("2+", "5"),
             cell_type="code",
         )
 
-    def test_split_first_cell(
+    async def test_split_first_cell(
         self, client: TestClient, superuser_token_headers: Dict[str, str]
     ):
-        uuid = upload_notebook(client, superuser_token_headers, "simple.ipynb")
-        self._test_split_cell(
+        uuid = await upload_notebook(client, superuser_token_headers, "simple.ipynb")
+        await self._test_split_cell(
             client,
             superuser_token_headers,
             uuid=uuid,
             position=0,
             split_location=11,
             expected_sources=("## Simple T", "est Notebook"),
             cell_type="markdown",
         )
 
-    def test_split_last_cell(
+    async def test_split_last_cell(
         self, client: TestClient, superuser_token_headers: Dict[str, str]
     ):
-        uuid = upload_notebook(client, superuser_token_headers, "simple.ipynb")
-        self._test_split_cell(
+        uuid = await upload_notebook(client, superuser_token_headers, "simple.ipynb")
+        await self._test_split_cell(
             client,
             superuser_token_headers,
             uuid=uuid,
             position=3,
             split_location=0,
             expected_sources=("", ""),
             cell_type="code",
         )
 
-    def test_round_trip(
+    async def test_round_trip(
         self, client: TestClient, superuser_token_headers: Dict[str, str]
     ):
         """
         Check that when a notebook is uploaded, it gets a UUID.
         Then when it is download, uploaded and downloaded again,
         the UUID is different.
         """
         # initial upload
-        uuid = upload_notebook(client, superuser_token_headers, "simple.ipynb")
+        uuid = await upload_notebook(client, superuser_token_headers, "simple.ipynb")
 
         # download the notebook, now with uuid
-        response = client.get(
+        response = await client.get(
             f"/notebooks/{uuid}", headers=superuser_token_headers
         )
         assert response.status_code == 200
         notebook = response.json()["notebook"]
         data = json.dumps(notebook)
         dl1_uuid = notebook["metadata"]["jupyter_d1"]["uuid"]
         assert uuid == dl1_uuid
         assert (
             notebook["metadata"]["jupyter_d1"]["path"]
             == f"{settings.ROOT_DIR}/simple.ipynb"
         )
         assert notebook["metadata"]["jupyter_d1"]["name"] == "simple"
 
         # delete the notebook on the server
-        response = client.delete(
+        response = await client.delete(
             f"/notebooks/{uuid}", headers=superuser_token_headers
         )
         assert response.status_code == 204
 
         # upload the downloaded notebook, fail because file exists
-        response = client.post(
+        response = await client.post(
             "/notebooks/upload",
             params={"filename": "simple.ipynb"},
             data=data,
             headers=superuser_token_headers,
         )
         assert response.status_code == 400
         path = response.json()["detail"] == "File alreaady exists"
 
         # upload the downloaded notebook with different name,
         # complete with uuid
-        response = client.post(
+        response = await client.post(
             "/notebooks/upload",
             params={"filename": "isimple.ipynb"},
             data=data,
             headers=superuser_token_headers,
         )
         assert response.status_code == 201
         path = response.json()["path"]
@@ -696,15 +699,15 @@
         assert (
             nb["metadata"]["jupyter_d1"]["path"]
             == f"{settings.ROOT_DIR}/isimple.ipynb"
         )
         assert nb["metadata"]["jupyter_d1"]["name"] == "isimple"
 
         # Open notebook, check that uuid changes again
-        response = client.get(
+        response = await client.get(
             f"/notebooks/open/?filepath={path}",
             headers=superuser_token_headers,
         )
         assert response.status_code == 201
         notebook = response.json()["notebook"]
         open_uuid = notebook["metadata"]["jupyter_d1"]["uuid"]
         assert uuid != open_uuid
@@ -724,36 +727,36 @@
             nb["metadata"]["jupyter_d1"]["path"]
             == f"{settings.ROOT_DIR}/isimple.ipynb"
         )
         assert nb["metadata"]["jupyter_d1"]["name"] == "isimple"
 
         # finally, get the notebook again and make sure the
         # uuid is the same as when opened
-        response = client.get(
+        response = await client.get(
             f"/notebooks/{open_uuid}", headers=superuser_token_headers
         )
         assert response.status_code == 200
         notebook = response.json()["notebook"]
         dl2_uuid = notebook["metadata"]["jupyter_d1"]["uuid"]
         assert open_uuid == dl2_uuid
 
-    def test_cell_state_reset(
+    async def test_cell_state_reset(
         self, client: TestClient, superuser_token_headers: Dict[str, str]
     ):
         """
         Check that when a notebook is uploaded, cells states get reset to
         idle and execution counts are reset
         """
         # initial upload
-        uuid = upload_notebook(
+        uuid = await upload_notebook(
             client, superuser_token_headers, "stateful_simple.ipynb"
         )
 
         # download the notebook
-        response = client.get(
+        response = await client.get(
             f"/notebooks/{uuid}", headers=superuser_token_headers
         )
         assert response.status_code == 200
         notebook = response.json()["notebook"]
         dl1_uuid = notebook["metadata"]["jupyter_d1"]["uuid"]
         assert uuid == dl1_uuid
         assert (
@@ -766,61 +769,61 @@
             if "jupyter_d1" in cell["metadata"]:
                 d1_data = cell["metadata"]["jupyter_d1"]
                 if "execution_state" in d1_data:
                     assert d1_data["execution_state"] == "idle"
             if "execution_count" in cell:
                 assert cell["execution_count"] is None
 
-    def test_get_bogus_notebook(
+    async def test_get_bogus_notebook(
         self, client: TestClient, superuser_token_headers: Dict[str, str]
     ):
         "Test error condition when downloading an non-existent notebook."
         from uuid import uuid4
 
         uuid = uuid4()
-        response = client.get(
+        response = await client.get(
             f"/notebooks/{uuid}", headers=superuser_token_headers
         )
         assert response.status_code == 404
         resp_json = response.json()
         assert resp_json["error"] == "NOTEBOOK_NOT_FOUND"
         assert resp_json["reason"] == f"Notebook not found with uuid: {uuid}"
         assert resp_json["detail"] is None
 
-    def test_get_bogus_cell(
+    async def test_get_bogus_cell(
         self, client: TestClient, superuser_token_headers: Dict[str, str]
     ):
         "Test error condition when downloading an non-existent cell."
-        uuid = upload_notebook(client, superuser_token_headers, "simple.ipynb")
+        uuid = await upload_notebook(client, superuser_token_headers, "simple.ipynb")
         from uuid import uuid4
 
         cell_uuid = uuid4()
-        response = client.get(
+        response = await client.get(
             f"/notebooks/{uuid}/cells/{cell_uuid}",
             headers=superuser_token_headers,
         )
         assert response.status_code == 404
         resp_json = response.json()
         assert resp_json["error"] == "CELL_NOT_FOUND"
         assert resp_json["reason"] == f"Cell not found with uuid: {cell_uuid}"
         assert resp_json["detail"] is None
 
-    def test_bogus_kernel(
+    async def test_bogus_kernel(
         self, client: TestClient, superuser_token_headers: Dict[str, str]
     ):
         "Test notebook upload that has an unsupported kernel."
-        upload_notebook(client, superuser_token_headers, "weird_kernel.ipynb")
+        await upload_notebook(client, superuser_token_headers, "weird_kernel.ipynb")
 
-    def test_upload_to_directory(
+    async def test_upload_to_directory(
         self, client: TestClient, superuser_token_headers: Dict[str, str]
     ):
         os.mkdir(f"{settings.ROOT_DIR}/aproject")
         with open(f"jupyter_d1/tests/notebooks/simple.ipynb", "r") as f:
             nb_raw = f.read()
-        response = client.post(
+        response = await client.post(
             "/notebooks/upload",
             params={"directory": "aproject", "filename": "koy"},
             data=nb_raw,
             headers=superuser_token_headers,
         )
         assert response.status_code == 201
         path = response.json()["path"]
@@ -832,96 +835,99 @@
         assert file_uuid is not None
         assert (
             nb["metadata"]["jupyter_d1"]["path"]
             == f"{settings.ROOT_DIR}/{path}"
         )
         assert nb["metadata"]["jupyter_d1"]["name"] == "koy"
 
-        response = client.get(
+        response = await client.get(
             f"/notebooks/open/?filepath={path}",
             headers=superuser_token_headers,
         )
 
         assert response.status_code == 201
         nb = response.json()["notebook"]
         uuid = nb["metadata"]["jupyter_d1"]["uuid"]
         assert uuid != file_uuid
         assert (
             nb["metadata"]["jupyter_d1"]["path"]
             == f"{settings.ROOT_DIR}/{path}"
         )
         assert nb["metadata"]["jupyter_d1"]["name"] == "koy"
 
-    def test_upload_to_directory_fail(
+    async def test_upload_to_directory_fail(
         self, client: TestClient, superuser_token_headers: Dict[str, str]
     ):
         with open(f"jupyter_d1/tests/notebooks/simple.ipynb", "r") as f:
             nb = json.loads(f.read())
-        response = client.post(
+        response = await client.post(
             "/notebooks/upload",
             params={"directory": "aproject", "filename": "koy"},
             data=nb,
             headers=superuser_token_headers,
         )
         assert response.status_code == 404
         assert (
             response.json()["detail"]
             == f"Directory does not exist {settings.ROOT_DIR}/aproject"
         )
 
-    def test_working_directory(
+    async def test_working_directory(
         self, client: TestClient, superuser_token_headers: Dict[str, str]
     ):
         nb_filename = f"jupyter_d1/tests/notebooks/simple.ipynb"
         nb_json = open(nb_filename).read()
-        response = client.post(
+        response = await client.post(
             "/notebooks/upload",
             params={"filename": "name.ipynb"},
             data=nb_json,
             headers=superuser_token_headers,
         )
         assert response.status_code == 201
         assert response.json()["path"] == "name.ipynb"
-        response = client.get(
+        response = await client.get(
             "/notebooks/open/?filepath=name.ipynb",
             headers=superuser_token_headers,
         )
         assert response.status_code == 201
         resp_json = response.json()
         assert (
             resp_json["notebook"]["metadata"]["jupyter_d1"][
                 "working_directory"
             ]
             == settings.ROOT_DIR
         )
         uuid = resp_json["notebook"]["metadata"]["jupyter_d1"]["uuid"]
-        response = client.delete(
+        response = await client.delete(
             f"/notebooks/{uuid}", data=nb_json, headers=superuser_token_headers
         )
         assert response.status_code == 204
 
-        response = client.get(
-            "/notebooks/open/?filepath=name.ipynb",
+        response = await client.get(
+            "/notebooks/open/",
             headers=superuser_token_headers,
-            params={"working_directory": "/tmp"},
+            params={
+                "filepath": "name.ipynb",
+                "working_directory": "/tmp",
+            },
         )
         assert response.json()["notebook"]["metadata"]["jupyter_d1"][
             "working_directory"
         ] == str(pathlib.Path("/tmp").resolve())
 
-    def test_upload_and_open_in_memory_no_working_dir_specified(
+    async def test_upload_and_open_in_memory_no_working_dir_specified(
         self, client: TestClient, superuser_token_headers: Dict[str, str]
     ):
         """
         Working directory should default to root dir,
         notebook should not be saved on disk.
         """
         nb_filename = f"jupyter_d1/tests/notebooks/simple.ipynb"
         nb_json = open(nb_filename).read()
-        response = client.post(
+        response = await client.post(
             "/notebooks/upload_and_open",
             params={"filename": "name.ipynb", "autosave": "False"},
             data=nb_json,
             headers=superuser_token_headers,
         )
         assert response.status_code == 201
         resp_json = response.json()
@@ -934,45 +940,45 @@
         uuid = resp_json["notebook"]["metadata"]["jupyter_d1"]["uuid"]
 
         # Do an action that would save the notebook if autosave was true
         cell1_uuid = resp_json["notebook"]["cells"][1]["metadata"][
             "jupyter_d1"
         ]["uuid"]
         new_source = 'hello = "world"'
-        response = client.patch(
+        response = await client.patch(
             f"/notebooks/{uuid}/cells/{cell1_uuid}",
             headers=superuser_token_headers,
             json={"source": new_source},
         )
         assert response.status_code == 200
 
         assert not os.path.exists(f"{settings.ROOT_DIR}/name.ipynb")
 
-        response = client.get("/notebooks", headers=superuser_token_headers)
+        response = await client.get("/notebooks", headers=superuser_token_headers)
         assert response.status_code == 200
         resp_json = response.json()
         notebooks = resp_json["notebooks"]
         assert len(notebooks) == 1
         assert notebooks[0]["metadata"]["jupyter_d1"]["uuid"] == uuid
         assert (
             notebooks[0]["metadata"]["jupyter_d1"]["working_directory"]
             == settings.ROOT_DIR
         )
 
-    def test_upload_and_open_in_memory_file_exists_but_its_fine(
+    async def test_upload_and_open_in_memory_file_exists_but_its_fine(
         self, client: TestClient, superuser_token_headers: Dict[str, str]
     ):
         """
         Opening notebook in memory when file exists should work fine.
         """
         nb_filename = f"jupyter_d1/tests/notebooks/simple.ipynb"
         nb_json = open(nb_filename).read()
         with open(f"{settings.ROOT_DIR}/name.ipynb", "w") as f:
             f.write(nb_json)
-        response = client.post(
+        response = await client.post(
             "/notebooks/upload_and_open",
             params={"filename": "name.ipynb", "autosave": "False"},
             data=nb_json,
             headers=superuser_token_headers,
         )
         assert response.status_code == 201
         resp_json = response.json()
@@ -982,35 +988,35 @@
             ]
             == settings.ROOT_DIR
         )
         uuid = resp_json["notebook"]["metadata"]["jupyter_d1"]["uuid"]
 
         assert os.path.exists(f"{settings.ROOT_DIR}/name.ipynb")
 
-        response = client.get("/notebooks", headers=superuser_token_headers)
+        response = await client.get("/notebooks", headers=superuser_token_headers)
         assert response.status_code == 200
         resp_json = response.json()
         notebooks = resp_json["notebooks"]
         assert len(notebooks) == 1
         assert notebooks[0]["metadata"]["jupyter_d1"]["uuid"] == uuid
         assert (
             notebooks[0]["metadata"]["jupyter_d1"]["working_directory"]
             == settings.ROOT_DIR
         )
 
-    def test_upload_and_open_in_memory_working_dir_specified(
+    async def test_upload_and_open_in_memory_working_dir_specified(
         self, client: TestClient, superuser_token_headers: Dict[str, str]
     ):
         """
         Working directory should be set to specified directory,
         notebook should not be saved on disk.
         """
         nb_filename = f"jupyter_d1/tests/notebooks/simple.ipynb"
         nb_json = open(nb_filename).read()
-        response = client.post(
+        response = await client.post(
             "/notebooks/upload_and_open",
             params={
                 "filename": "name.ipynb",
                 "autosave": "False",
                 "working_directory": f"{os.getcwd()}/jupyter_d1"
                 "/tests/notebooks",
             },
@@ -1029,35 +1035,35 @@
 
         assert not os.path.exists(f"{settings.ROOT_DIR}/name.ipynb")
         # This should be impossible, but might as well check it
         assert not os.path.exists(
             f"{os.getcwd()}/jupyter_d1/tests/notebooks/name.ipynb"
         )
 
-        response = client.get("/notebooks", headers=superuser_token_headers)
+        response = await client.get("/notebooks", headers=superuser_token_headers)
         assert response.status_code == 200
         resp_json = response.json()
         notebooks = resp_json["notebooks"]
         assert len(notebooks) == 1
         assert notebooks[0]["metadata"]["jupyter_d1"]["uuid"] == uuid
         assert (
             notebooks[0]["metadata"]["jupyter_d1"]["working_directory"]
             == f"{os.getcwd()}/jupyter_d1/tests/notebooks"
         )
 
-    def test_upload_and_open_no_working_dir_specified(
+    async def test_upload_and_open_no_working_dir_specified(
         self, client: TestClient, superuser_token_headers: Dict[str, str]
     ):
         """
         Working directory should default to root dir,
         notebook should be saved on disk.
         """
         nb_filename = f"jupyter_d1/tests/notebooks/simple.ipynb"
         nb_json = open(nb_filename).read()
-        response = client.post(
+        response = await client.post(
             "/notebooks/upload_and_open",
             params={"filename": "name.ipynb"},
             data=nb_json,
             headers=superuser_token_headers,
         )
         assert response.status_code == 201
         resp_json = response.json()
@@ -1067,39 +1073,39 @@
             ]
             == settings.ROOT_DIR
         )
         uuid = resp_json["notebook"]["metadata"]["jupyter_d1"]["uuid"]
 
         assert os.path.exists(f"{settings.ROOT_DIR}/name.ipynb")
 
-        response = client.get("/notebooks", headers=superuser_token_headers)
+        response = await client.get("/notebooks", headers=superuser_token_headers)
         assert response.status_code == 200
         resp_json = response.json()
         notebooks = resp_json["notebooks"]
         assert len(notebooks) == 1
         assert notebooks[0]["metadata"]["jupyter_d1"]["uuid"] == uuid
         assert (
             notebooks[0]["metadata"]["jupyter_d1"]["working_directory"]
             == settings.ROOT_DIR
         )
 
-    def test_upload_and_open_working_dir_defaults_to_root_dir(
+    async def test_upload_and_open_working_dir_defaults_to_root_dir(
         self, client: TestClient, superuser_token_headers: Dict[str, str]
     ):
         """
         Working directory should default to root dir,
         notebook should be saved on disk.
         """
         try:
             os.remove(f"{os.getcwd()}/jupyter_d1/tests/notebooks/name.ipynb")
         except Exception:
             pass
         nb_filename = f"jupyter_d1/tests/notebooks/simple.ipynb"
         nb_json = open(nb_filename).read()
-        response = client.post(
+        response = await client.post(
             "/notebooks/upload_and_open",
             params={
                 "filename": "name.ipynb",
                 "directory": f"{os.getcwd()}/jupyter_d1/tests/notebooks",
             },
             data=nb_json,
             headers=superuser_token_headers,
@@ -1114,40 +1120,40 @@
         )
         uuid = resp_json["notebook"]["metadata"]["jupyter_d1"]["uuid"]
 
         assert os.path.exists(
             f"{os.getcwd()}/jupyter_d1/tests/notebooks/name.ipynb"
         )
 
-        response = client.get("/notebooks", headers=superuser_token_headers)
+        response = await client.get("/notebooks", headers=superuser_token_headers)
         assert response.status_code == 200
         resp_json = response.json()
         notebooks = resp_json["notebooks"]
         assert len(notebooks) == 1
         assert notebooks[0]["metadata"]["jupyter_d1"]["uuid"] == uuid
         assert (
             notebooks[0]["metadata"]["jupyter_d1"]["working_directory"]
             == f"{os.getcwd()}/jupyter_d1/tests/notebooks"
         )
         os.remove(f"{os.getcwd()}/jupyter_d1/tests/notebooks/name.ipynb")
 
-    def test_upload_and_open_working_dir_defaults_to_dir(
+    async def test_upload_and_open_working_dir_defaults_to_dir(
         self, client: TestClient, superuser_token_headers: Dict[str, str]
     ):
         """
         Working directory should default to directory provided (where notebook
         is also saved), notebook should be saved on disk.
         """
         try:
             os.remove(f"{os.getcwd()}/jupyter_d1/tests/notebooks/name.ipynb")
         except Exception:
             pass
         nb_filename = f"jupyter_d1/tests/notebooks/simple.ipynb"
         nb_json = open(nb_filename).read()
-        response = client.post(
+        response = await client.post(
             "/notebooks/upload_and_open",
             params={
                 "filename": "name.ipynb",
                 "directory": f"{os.getcwd()}/jupyter_d1/tests/notebooks",
             },
             data=nb_json,
             headers=superuser_token_headers,
@@ -1162,40 +1168,40 @@
         )
         uuid = resp_json["notebook"]["metadata"]["jupyter_d1"]["uuid"]
 
         assert os.path.exists(
             f"{os.getcwd()}/jupyter_d1/tests/notebooks/name.ipynb"
         )
 
-        response = client.get("/notebooks", headers=superuser_token_headers)
+        response = await client.get("/notebooks", headers=superuser_token_headers)
         assert response.status_code == 200
         resp_json = response.json()
         notebooks = resp_json["notebooks"]
         assert len(notebooks) == 1
         assert notebooks[0]["metadata"]["jupyter_d1"]["uuid"] == uuid
         assert (
             notebooks[0]["metadata"]["jupyter_d1"]["working_directory"]
             == f"{os.getcwd()}/jupyter_d1/tests/notebooks"
         )
         os.remove(f"{os.getcwd()}/jupyter_d1/tests/notebooks/name.ipynb")
 
-    def test_upload_and_open_working_directory_specified(
+    async def test_upload_and_open_working_directory_specified(
         self, client: TestClient, superuser_token_headers: Dict[str, str]
     ):
         """
         Working directory should be set to provided working dir,
         notebook should be saved on disk.
         """
         try:
             os.remove(f"{os.getcwd()}/jupyter_d1/tests/notebooks/name.ipynb")
         except Exception:
             pass
         nb_filename = f"jupyter_d1/tests/notebooks/simple.ipynb"
         nb_json = open(nb_filename).read()
-        response = client.post(
+        response = await client.post(
             "/notebooks/upload_and_open",
             params={
                 "filename": "name.ipynb",
                 "directory": f"{os.getcwd()}/jupyter_d1/tests/notebooks",
                 "working_directory": "/tmp",
             },
             data=nb_json,
@@ -1208,75 +1214,78 @@
         ] == str(pathlib.Path("/tmp").resolve())
         uuid = resp_json["notebook"]["metadata"]["jupyter_d1"]["uuid"]
 
         assert os.path.exists(
             f"{os.getcwd()}/jupyter_d1/tests/notebooks/name.ipynb"
         )
 
-        response = client.get("/notebooks", headers=superuser_token_headers)
+        response = await client.get("/notebooks", headers=superuser_token_headers)
         assert response.status_code == 200
         resp_json = response.json()
         notebooks = resp_json["notebooks"]
         assert len(notebooks) == 1
         assert notebooks[0]["metadata"]["jupyter_d1"]["uuid"] == uuid
         assert notebooks[0]["metadata"]["jupyter_d1"][
             "working_directory"
         ] == str(pathlib.Path("/tmp").resolve())
         os.remove(f"{os.getcwd()}/jupyter_d1/tests/notebooks/name.ipynb")
 
-    def test_open_notebook_file_twice_returns_same_notebook(
+    async def test_open_notebook_file_twice_returns_same_notebook(
         self, client: TestClient, superuser_token_headers: Dict[str, str]
     ):
         """Opening a notebook twice returns an error"""
         nb_filename = f"jupyter_d1/tests/notebooks/simple.ipynb"
         nb_json = open(nb_filename).read()
-        response = client.post(
+        response = await client.post(
             "/notebooks/upload",
             params={"filename": "name.ipynb"},
             data=nb_json,
             headers=superuser_token_headers,
         )
         assert response.status_code == 201
         assert response.json()["path"] == "name.ipynb"
-        response = client.get(
+        response = await client.get(
             "/notebooks/open/?filepath=name.ipynb",
             headers=superuser_token_headers,
         )
         assert response.status_code == 201
         metadata = response.json()["notebook"]["metadata"]["jupyter_d1"]
         assert metadata["working_directory"] == settings.ROOT_DIR
         uuid = metadata["uuid"]
 
-        response = client.get(
-            "/notebooks/open/?filepath=name.ipynb",
+        response = await client.get(
+            "/notebooks/open/",
             headers=superuser_token_headers,
-            params={"working_directory": "/tmp"},
+            params={
+                "filepath": "name.ipynb",
+                "working_directory": "/tmp",
+            },
         )
         assert response.status_code == 201
         metadata = response.json()["notebook"]["metadata"]["jupyter_d1"]
         assert metadata["working_directory"] == settings.ROOT_DIR
         assert metadata["uuid"] == uuid
 
-        response = client.get("/notebooks", headers=superuser_token_headers)
+        response = await client.get("/notebooks", headers=superuser_token_headers)
         assert response.status_code == 200
         resp_json = response.json()
         notebooks = resp_json["notebooks"]
         assert len(notebooks) == 1
         assert notebooks[0]["metadata"]["jupyter_d1"]["uuid"] == uuid
         assert (
             notebooks[0]["metadata"]["jupyter_d1"]["working_directory"]
             == settings.ROOT_DIR
         )
 
-    def test_upload_and_open_notebook_twice_returns_same_notebook(
+    async def test_upload_and_open_notebook_twice_returns_same_notebook(
         self, client: TestClient, superuser_token_headers: Dict[str, str]
     ):
         nb_filename = f"jupyter_d1/tests/notebooks/simple.ipynb"
         nb_json = open(nb_filename).read()
-        response = client.post(
+        response = await client.post(
             "/notebooks/upload_and_open",
             params={"autosave": "False"},
             data=nb_json,
             headers=superuser_token_headers,
         )
         assert response.status_code == 201
         resp_json = response.json()
@@ -1286,15 +1295,15 @@
             ]
             == settings.ROOT_DIR
         )
         uuid = resp_json["notebook"]["metadata"]["jupyter_d1"]["uuid"]
 
         assert not os.path.exists(f"{settings.ROOT_DIR}/name.ipynb")
 
-        response = client.post(
+        response = await client.post(
             "/notebooks/upload_and_open",
             params={"autosave": "False", "working_directory": "/tmp"},
             data=json.dumps(resp_json["notebook"]),
             headers=superuser_token_headers,
         )
         assert response.status_code == 201
         resp_json = response.json()
@@ -1302,75 +1311,75 @@
             resp_json["notebook"]["metadata"]["jupyter_d1"][
                 "working_directory"
             ]
             == settings.ROOT_DIR
         )
         assert resp_json["notebook"]["metadata"]["jupyter_d1"]["uuid"] == uuid
 
-        response = client.get("/notebooks", headers=superuser_token_headers)
+        response = await client.get("/notebooks", headers=superuser_token_headers)
         assert response.status_code == 200
         resp_json = response.json()
         notebooks = resp_json["notebooks"]
         assert len(notebooks) == 1
         assert notebooks[0]["metadata"]["jupyter_d1"]["uuid"] == uuid
         assert (
             notebooks[0]["metadata"]["jupyter_d1"]["working_directory"]
             == settings.ROOT_DIR
         )
 
-    def test_upload_invalid_notebook(
+    async def test_upload_invalid_notebook(
         self, client: TestClient, superuser_token_headers: Dict[str, str]
     ):
         """
         Invalid notebook should return 400, and not cause a 500
         """
-        response = client.post(
+        response = await client.post(
             "/notebooks/upload",
             params={"filename": "name.ipynb", "autosave": "False"},
             data="{}",
             headers=superuser_token_headers,
         )
         assert response.status_code == 400
         assert (
             response.json()["detail"] == "Failed to parse notebook: "
             "<class 'jsonschema.exceptions.ValidationError'> Notebook could"
             " not be converted from version 1 to version 2 because it's"
             " missing a key: cells"
         )
 
-    def test_open_invalid_notebook(
+    async def test_open_invalid_notebook(
         self, client: TestClient, superuser_token_headers: Dict[str, str]
     ):
         """
         Invalid notebook should return 400, and not cause a 500
         """
         with open(f"{settings.ROOT_DIR}/name1l.ipynb", "w") as f:
             f.write("{}")
 
-        response = client.get(
+        response = await client.get(
             "/notebooks/open/",
             params={"filepath": "name1l.ipynb"},
             data="{}",
             headers=superuser_token_headers,
         )
         assert response.status_code == 400
         assert (
             response.json()["detail"] == "Failed to parse notebook: "
             "<class 'jsonschema.exceptions.ValidationError'> Notebook could"
             " not be converted from version 1 to version 2 because it's"
             " missing a key: cells"
         )
 
-    def test_upload_and_open_invalid_notebook(
+    async def test_upload_and_open_invalid_notebook(
         self, client: TestClient, superuser_token_headers: Dict[str, str]
     ):
         """
         Invalid notebook should return 400, and not cause a 500
         """
-        response = client.post(
+        response = await client.post(
             "/notebooks/upload_and_open",
             params={"filename": "name.ipynb", "autosave": "False"},
             data="{}",
             headers=superuser_token_headers,
         )
         assert response.status_code == 400
         assert (
@@ -1379,257 +1388,257 @@
             " not be converted from version 1 to version 2 because it's"
             " missing a key: cells"
         )
 
 
 @pytest.mark.usefixtures("clear_notebooks", "clear_notebook_directory")
 class TestNotebookPermissions:
-    def test_notebooks(
+    async def test_notebooks(
         self,
         client: TestClient,
         superuser_token_headers: Dict[str, str],
         readonly_token_headers: Dict[str, str],
         permissionless_token_headers: Dict[str, str],
     ):
-        upload_notebook(client, superuser_token_headers, "simple.ipynb")
-        upload_notebook(client, superuser_token_headers, "other_simple.ipynb")
-        response = client.get(
+        await upload_notebook(client, superuser_token_headers, "simple.ipynb")
+        await upload_notebook(client, superuser_token_headers, "other_simple.ipynb")
+        response = await client.get(
             "/notebooks", headers=permissionless_token_headers
         )
         assert response.status_code == 403
-        response = client.get("/notebooks", headers=readonly_token_headers)
+        response = await client.get("/notebooks", headers=readonly_token_headers)
         assert response.status_code == 200
 
-    def test_notebook(
+    async def test_notebook(
         self,
         client: TestClient,
         readonly_token_headers: Dict[str, str],
         permissionless_token_headers: Dict[str, str],
         superuser_token_headers: Dict[str, str],
     ):
-        uuid = upload_notebook(client, superuser_token_headers)
-        response = client.get(
+        uuid = await upload_notebook(client, superuser_token_headers)
+        response = await client.get(
             f"/notebooks/{uuid}", headers=permissionless_token_headers
         )
         assert response.status_code == 403
-        response = client.get(
+        response = await client.get(
             f"/notebooks/{uuid}", headers=readonly_token_headers
         )
         assert response.status_code == 200
 
-    def test_delete_notebooks(
+    async def test_delete_notebooks(
         self,
         client: TestClient,
         readonly_token_headers: Dict[str, str],
         superuser_token_headers: Dict[str, str],
     ):
-        upload_notebook(client, superuser_token_headers, "simple.ipynb")
-        upload_notebook(client, superuser_token_headers, "other_simple.ipynb")
-        response = client.delete("/notebooks", headers=readonly_token_headers)
+        await upload_notebook(client, superuser_token_headers, "simple.ipynb")
+        await upload_notebook(client, superuser_token_headers, "other_simple.ipynb")
+        response = await client.delete("/notebooks", headers=readonly_token_headers)
         assert response.status_code == 403
-        response = client.delete("/notebooks", headers=superuser_token_headers)
+        response = await client.delete("/notebooks", headers=superuser_token_headers)
         assert response.status_code == 204
 
-    def test_delete_notebook(
+    async def test_delete_notebook(
         self,
         client: TestClient,
         readonly_token_headers: Dict[str, str],
         superuser_token_headers: Dict[str, str],
     ):
-        uuid = upload_notebook(client, superuser_token_headers, "simple.ipynb")
-        response = client.delete(
+        uuid = await upload_notebook(client, superuser_token_headers, "simple.ipynb")
+        response = await client.delete(
             f"/notebooks/{uuid}", headers=readonly_token_headers
         )
         assert response.status_code == 403
-        response = client.delete(
+        response = await client.delete(
             f"/notebooks/{uuid}", headers=superuser_token_headers
         )
         assert response.status_code == 204
 
-    def test_cells(
+    async def test_cells(
         self,
         client: TestClient,
         readonly_token_headers: Dict[str, str],
         permissionless_token_headers: Dict[str, str],
         superuser_token_headers: Dict[str, str],
     ):
-        uuid = upload_notebook(client, superuser_token_headers, "simple.ipynb")
+        uuid = await upload_notebook(client, superuser_token_headers, "simple.ipynb")
 
-        response = client.get(
+        response = await client.get(
             f"/notebooks/{uuid}/cells", headers=permissionless_token_headers
         )
         assert response.status_code == 403
-        response = client.get(
+        response = await client.get(
             f"/notebooks/{uuid}/cells", headers=readonly_token_headers
         )
         assert response.status_code == 200
 
-    def test_one_cell(
+    async def test_one_cell(
         self,
         client: TestClient,
         readonly_token_headers: Dict[str, str],
         permissionless_token_headers: Dict[str, str],
         superuser_token_headers: Dict[str, str],
     ):
-        uuid = upload_notebook(client, superuser_token_headers, "simple.ipynb")
+        uuid = await upload_notebook(client, superuser_token_headers, "simple.ipynb")
 
-        response = client.get(
+        response = await client.get(
             f"/notebooks/{uuid}/cells", headers=readonly_token_headers
         )
         assert response.status_code == 200
         cell1_uuid = response.json()["cells"][1]["metadata"]["jupyter_d1"][
             "uuid"
         ]
 
-        response = client.get(
+        response = await client.get(
             f"/notebooks/{uuid}/cells/{cell1_uuid}",
             headers=permissionless_token_headers,
         )
         assert response.status_code == 403
-        response = client.get(
+        response = await client.get(
             f"/notebooks/{uuid}/cells/{cell1_uuid}",
             headers=readonly_token_headers,
         )
         assert response.status_code == 200
 
-    def test_patch_cell(
+    async def test_patch_cell(
         self,
         client: TestClient,
         readonly_token_headers: Dict[str, str],
         superuser_token_headers: Dict[str, str],
     ):
-        uuid = upload_notebook(client, superuser_token_headers, "simple.ipynb")
+        uuid = await upload_notebook(client, superuser_token_headers, "simple.ipynb")
 
-        response = client.get(
+        response = await client.get(
             f"/notebooks/{uuid}/cells", headers=superuser_token_headers
         )
         assert response.status_code == 200
         cell1_uuid = response.json()["cells"][1]["metadata"]["jupyter_d1"][
             "uuid"
         ]
 
         new_source = 'hello = "world"'
-        response = client.patch(
+        response = await client.patch(
             f"/notebooks/{uuid}/cells/{cell1_uuid}",
             headers=readonly_token_headers,
             json={"source": new_source},
         )
         assert response.status_code == 403
-        response = client.patch(
+        response = await client.patch(
             f"/notebooks/{uuid}/cells/{cell1_uuid}",
             headers=superuser_token_headers,
             json={"source": new_source},
         )
         assert response.status_code == 200
 
-    def test_patch_and_execute_cell(
+    async def test_patch_and_execute_cell(
         self,
         client: TestClient,
         readonly_token_headers: Dict[str, str],
         superuser_token_headers: Dict[str, str],
     ):
-        uuid = upload_notebook(client, superuser_token_headers, "simple.ipynb")
+        uuid = await upload_notebook(client, superuser_token_headers, "simple.ipynb")
 
-        response = client.get(
+        response = await client.get(
             f"/notebooks/{uuid}/cells", headers=superuser_token_headers
         )
         assert response.status_code == 200
         cell1_uuid = response.json()["cells"][1]["metadata"]["jupyter_d1"][
             "uuid"
         ]
 
         new_source = 'hello = "world"'
-        response = client.patch(
+        response = await client.patch(
             f"/notebooks/{uuid}/cells/{cell1_uuid}/execute",
             headers=readonly_token_headers,
             json={"source": new_source},
         )
         assert response.status_code == 403
-        response = client.patch(
+        response = await client.patch(
             f"/notebooks/{uuid}/cells/{cell1_uuid}/execute",
             headers=superuser_token_headers,
             json={"source": new_source},
         )
         assert response.status_code == 200
 
         uuid = response.json()["cell"]["metadata"]["jupyter_d1"]["uuid"]
         assert len(uuid) == 36
         message_id = response.json()["kernel_message"]["message_id"]
         assert len(message_id) in msg_id_lengths
 
-    def test_create_cell(
+    async def test_create_cell(
         self,
         client: TestClient,
         readonly_token_headers: Dict[str, str],
         superuser_token_headers: Dict[str, str],
     ):
-        uuid = upload_notebook(client, superuser_token_headers, "simple.ipynb")
+        uuid = await upload_notebook(client, superuser_token_headers, "simple.ipynb")
 
         # add a new cell
         src = "__**Hello Callist**__"
         params = {"cell_type": "markdown", "source": src}
-        response = client.post(
+        response = await client.post(
             f"/notebooks/{uuid}/cells",
             json=params,
             headers=readonly_token_headers,
         )
         assert response.status_code == 403
-        response = client.post(
+        response = await client.post(
             f"/notebooks/{uuid}/cells",
             json=params,
             headers=superuser_token_headers,
         )
         assert response.status_code == 201
 
-    def test_move_cell(
+    async def test_move_cell(
         self,
         client: TestClient,
         readonly_token_headers: Dict[str, str],
         superuser_token_headers: Dict[str, str],
     ):
-        uuid = upload_notebook(client, superuser_token_headers, "simple.ipynb")
+        uuid = await upload_notebook(client, superuser_token_headers, "simple.ipynb")
 
         # get the existing cells
-        response = client.get(
+        response = await client.get(
             f"/notebooks/{uuid}/cells", headers=superuser_token_headers
         )
         assert response.status_code == 200
         move_uuid = response.json()["cells"][2]["metadata"]["jupyter_d1"][
             "uuid"
         ]
 
-        response = client.get(
+        response = await client.get(
             f"/notebooks/{uuid}/cells/{move_uuid}/move",
             headers=readonly_token_headers,
         )
         assert response.status_code == 403
-        response = client.get(
+        response = await client.get(
             f"/notebooks/{uuid}/cells/{move_uuid}/move",
             headers=superuser_token_headers,
         )
         assert response.status_code == 204
 
-    def test_upload_notebook(
+    async def test_upload_notebook(
         self,
         client: TestClient,
         readonly_token_headers: Dict[str, str],
         superuser_token_headers: Dict[str, str],
     ):
         nb_filename = f"jupyter_d1/tests/notebooks/simple.ipynb"
         nb_json = open(nb_filename).read()
-        response = client.post(
+        response = await client.post(
             "/notebooks/upload", data=nb_json, headers=readonly_token_headers
         )
         assert response.status_code == 403
-        response = client.post(
+        response = await client.post(
             "/notebooks/upload",
             params={"filename": "name.ipynb"},
             data=nb_json,
             headers=superuser_token_headers,
         )
         assert response.status_code == 201
         assert response.json()["path"] == "name.ipynb"
-        response = client.get(
+        response = await client.get(
             "/notebooks/open/?filepath=name.ipynb",
             headers=superuser_token_headers,
         )
         assert response.status_code == 201
```

### Comparing `callisto-jupyter-d1-0.0.7/jupyter_d1/tests/test_notebooks_websocket.py` & `callisto-jupyter-d1-0.0.9/jupyter_d1/tests/test_notebooks_websocket.py`

 * *Files 4% similar despite different names*

```diff
@@ -1,8254 +1,9636 @@
 00000000: 696d 706f 7274 2061 7379 6e63 696f 0a69  import asyncio.i
 00000010: 6d70 6f72 7420 6261 7365 3634 0a69 6d70  mport base64.imp
 00000020: 6f72 7420 6f73 0a69 6d70 6f72 7420 7061  ort os.import pa
 00000030: 7468 6c69 620a 696d 706f 7274 2073 6875  thlib.import shu
 00000040: 7469 6c0a 6672 6f6d 2064 6174 6574 696d  til.from datetim
 00000050: 6520 696d 706f 7274 2064 6174 6574 696d  e import datetim
 00000060: 650a 6672 6f6d 2074 7970 696e 6720 696d  e.from typing im
-00000070: 706f 7274 2041 6e79 2c20 4173 796e 6347  port Any, AsyncG
-00000080: 656e 6572 6174 6f72 2c20 4469 6374 2c20  enerator, Dict, 
-00000090: 4c69 7374 2c20 4f70 7469 6f6e 616c 0a66  List, Optional.f
-000000a0: 726f 6d20 756e 6974 7465 7374 2e6d 6f63  rom unittest.moc
-000000b0: 6b20 696d 706f 7274 2063 616c 6c0a 0a23  k import call..#
-000000c0: 2066 726f 6d20 6661 7374 6170 692e 7465   from fastapi.te
-000000d0: 7374 636c 6965 6e74 2069 6d70 6f72 7420  stclient import 
-000000e0: 5465 7374 436c 6965 6e74 0a69 6d70 6f72  TestClient.impor
-000000f0: 7420 7079 7465 7374 2020 2320 7479 7065  t pytest  # type
-00000100: 3a20 6967 6e6f 7265 0a66 726f 6d20 6173  : ignore.from as
-00000110: 796e 635f 6173 6769 5f74 6573 7463 6c69  ync_asgi_testcli
-00000120: 656e 7420 696d 706f 7274 2054 6573 7443  ent import TestC
-00000130: 6c69 656e 740a 696d 706f 7274 2070 7974  lient.import pyt
-00000140: 6573 745f 6173 796e 6369 6f20 2023 2074  est_asyncio  # t
-00000150: 7970 653a 2069 676e 6f72 650a 6672 6f6d  ype: ignore.from
-00000160: 2070 7974 6573 745f 6d6f 636b 2069 6d70   pytest_mock imp
-00000170: 6f72 7420 4d6f 636b 4669 7874 7572 6520  ort MockFixture 
-00000180: 2023 2074 7970 653a 2069 676e 6f72 650a   # type: ignore.
-00000190: 0a66 726f 6d20 6a75 7079 7465 725f 6431  .from jupyter_d1
-000001a0: 2069 6d70 6f72 7420 6170 700a 6672 6f6d   import app.from
-000001b0: 206a 7570 7974 6572 5f64 312e 7365 7474   jupyter_d1.sett
-000001c0: 696e 6773 2069 6d70 6f72 7420 7365 7474  ings import sett
-000001d0: 696e 6773 0a0a 6672 6f6d 202e 7574 696c  ings..from .util
-000001e0: 7320 696d 706f 7274 2028 0a20 2020 2063  s import (.    c
-000001f0: 6f6c 6c65 6374 5f77 6562 736f 636b 6574  ollect_websocket
-00000200: 5f6d 6573 7361 6765 732c 0a20 2020 2066  _messages,.    f
-00000210: 696c 7465 725f 7765 6273 6f63 6b65 745f  ilter_websocket_
-00000220: 636f 6c6c 6563 7469 6f6e 2c0a 2020 2020  collection,.    
-00000230: 6765 745f 7375 7065 7275 7365 725f 746f  get_superuser_to
-00000240: 6b65 6e2c 0a20 2020 2072 6563 6569 7665  ken,.    receive
-00000250: 5f6a 736f 6e2c 0a20 2020 2077 6169 745f  _json,.    wait_
-00000260: 666f 725f 6576 656e 742c 0a20 2020 2077  for_event,.    w
-00000270: 6f72 6b64 6972 5f31 2c0a 2020 2020 636f  orkdir_1,.    co
-00000280: 6d70 6172 655f 6365 6c6c 732c 0a20 2020  mpare_cells,.   
-00000290: 206d 7367 5f69 645f 6c65 6e67 7468 732c   msg_id_lengths,
-000002a0: 0a29 0a0a 2320 416c 6c20 7465 7374 2063  .)..# All test c
-000002b0: 6f72 6f75 7469 6e65 7320 7769 6c6c 2062  oroutines will b
-000002c0: 6520 7472 6561 7465 6420 6173 206d 6172  e treated as mar
-000002d0: 6b65 642e 0a23 2070 7974 6573 746d 6172  ked..# pytestmar
-000002e0: 6b20 3d20 7079 7465 7374 2e6d 6172 6b2e  k = pytest.mark.
-000002f0: 6173 796e 6369 6f0a 0a57 4542 534f 434b  asyncio..WEBSOCK
-00000300: 4554 5f53 4c45 4550 5f54 494d 4520 3d20  ET_SLEEP_TIME = 
-00000310: 312e 310a 0a0a 4070 7974 6573 745f 6173  1.1...@pytest_as
-00000320: 796e 6369 6f2e 6669 7874 7572 6528 290a  yncio.fixture().
-00000330: 6173 796e 6320 6465 6620 636c 6965 6e74  async def client
-00000340: 2829 202d 3e20 4173 796e 6347 656e 6572  () -> AsyncGener
-00000350: 6174 6f72 3a0a 2020 2020 6173 796e 6320  ator:.    async 
-00000360: 7769 7468 2054 6573 7443 6c69 656e 7428  with TestClient(
-00000370: 6170 7029 2061 7320 633a 0a20 2020 2020  app) as c:.     
-00000380: 2020 2079 6965 6c64 2063 0a0a 0a40 7079     yield c...@py
-00000390: 7465 7374 5f61 7379 6e63 696f 2e66 6978  test_asyncio.fix
-000003a0: 7475 7265 2829 0a61 7379 6e63 2064 6566  ture().async def
-000003b0: 2073 7570 6572 7573 6572 5f74 6f6b 656e   superuser_token
-000003c0: 5f68 6561 6465 7273 2863 6c69 656e 743a  _headers(client:
-000003d0: 2054 6573 7443 6c69 656e 7429 202d 3e20   TestClient) -> 
-000003e0: 4469 6374 5b73 7472 2c20 7374 725d 3a0a  Dict[str, str]:.
-000003f0: 2020 2020 7220 3d20 6177 6169 7420 636c      r = await cl
-00000400: 6965 6e74 2e67 6574 280a 2020 2020 2020  ient.get(.      
-00000410: 2020 222f 6c6f 6769 6e2f 6163 6365 7373    "/login/access
-00000420: 2d74 6f6b 656e 222c 2068 6561 6465 7273  -token", headers
-00000430: 3d7b 2241 7574 686f 7269 7a61 7469 6f6e  ={"Authorization
-00000440: 223a 2022 7465 7374 3974 6f6b 656e 5f34  ": "test9token_4
-00000450: 227d 0a20 2020 2029 0a20 2020 2074 6f6b  "}.    ).    tok
-00000460: 656e 203d 2072 2e6a 736f 6e28 295b 2274  en = r.json()["t
-00000470: 6f6b 656e 225d 5b22 6163 6365 7373 5f74  oken"]["access_t
-00000480: 6f6b 656e 225d 0a20 2020 2068 6561 6465  oken"].    heade
-00000490: 7273 203d 207b 2241 7574 686f 7269 7a61  rs = {"Authoriza
-000004a0: 7469 6f6e 223a 2066 2242 6561 7265 7220  tion": f"Bearer 
-000004b0: 7b74 6f6b 656e 7d22 7d0a 2020 2020 7265  {token}"}.    re
-000004c0: 7475 726e 2068 6561 6465 7273 0a0a 0a40  turn headers...@
-000004d0: 7079 7465 7374 5f61 7379 6e63 696f 2e66  pytest_asyncio.f
-000004e0: 6978 7475 7265 2873 636f 7065 3d22 6675  ixture(scope="fu
-000004f0: 6e63 7469 6f6e 2229 0a61 7379 6e63 2064  nction").async d
-00000500: 6566 2063 6c65 6172 5f6e 6f74 6562 6f6f  ef clear_noteboo
-00000510: 6b73 280a 2020 2020 636c 6965 6e74 3a20  ks(.    client: 
-00000520: 5465 7374 436c 6965 6e74 2c20 7375 7065  TestClient, supe
-00000530: 7275 7365 725f 746f 6b65 6e5f 6865 6164  ruser_token_head
-00000540: 6572 733a 2044 6963 745b 7374 722c 2073  ers: Dict[str, s
-00000550: 7472 5d0a 2920 2d3e 2041 7379 6e63 4765  tr].) -> AsyncGe
-00000560: 6e65 7261 746f 723a 0a20 2020 2079 6965  nerator:.    yie
-00000570: 6c64 0a20 2020 2072 6573 706f 6e73 6520  ld.    response 
-00000580: 3d20 6177 6169 7420 636c 6965 6e74 2e64  = await client.d
-00000590: 656c 6574 6528 0a20 2020 2020 2020 2022  elete(.        "
-000005a0: 2f6e 6f74 6562 6f6f 6b73 222c 2068 6561  /notebooks", hea
-000005b0: 6465 7273 3d73 7570 6572 7573 6572 5f74  ders=superuser_t
-000005c0: 6f6b 656e 5f68 6561 6465 7273 0a20 2020  oken_headers.   
-000005d0: 2029 0a20 2020 2061 7373 6572 7420 7265   ).    assert re
-000005e0: 7370 6f6e 7365 2e73 7461 7475 735f 636f  sponse.status_co
-000005f0: 6465 203d 3d20 3230 340a 2020 2020 7265  de == 204.    re
-00000600: 7370 6f6e 7365 203d 2061 7761 6974 2063  sponse = await c
-00000610: 6c69 656e 742e 6765 7428 222f 6e6f 7465  lient.get("/note
-00000620: 626f 6f6b 7322 2c20 6865 6164 6572 733d  books", headers=
-00000630: 7375 7065 7275 7365 725f 746f 6b65 6e5f  superuser_token_
-00000640: 6865 6164 6572 7329 0a20 2020 2061 7373  headers).    ass
-00000650: 6572 7420 7265 7370 6f6e 7365 2e73 7461  ert response.sta
-00000660: 7475 735f 636f 6465 203d 3d20 3230 300a  tus_code == 200.
-00000670: 0a0a 6173 796e 6320 6465 6620 7570 6c6f  ..async def uplo
-00000680: 6164 5f6e 6f74 6562 6f6f 6b28 0a20 2020  ad_notebook(.   
-00000690: 2063 6c69 656e 743a 2054 6573 7443 6c69   client: TestCli
-000006a0: 656e 742c 0a20 2020 2074 6f6b 656e 5f68  ent,.    token_h
-000006b0: 6561 6465 7273 3a20 4469 6374 5b73 7472  eaders: Dict[str
-000006c0: 2c20 7374 725d 2c0a 2020 2020 6669 6c65  , str],.    file
-000006d0: 6e61 6d65 3a20 7374 7220 3d20 2273 696d  name: str = "sim
-000006e0: 706c 652e 6970 796e 6222 2c0a 2920 2d3e  ple.ipynb",.) ->
-000006f0: 2073 7472 3a0a 2020 2020 6e62 5f66 696c   str:.    nb_fil
-00000700: 656e 616d 6520 3d20 6622 6a75 7079 7465  ename = f"jupyte
-00000710: 725f 6431 2f74 6573 7473 2f6e 6f74 6562  r_d1/tests/noteb
-00000720: 6f6f 6b73 2f7b 6669 6c65 6e61 6d65 7d22  ooks/{filename}"
-00000730: 0a20 2020 206e 625f 6a73 6f6e 203d 206f  .    nb_json = o
-00000740: 7065 6e28 6e62 5f66 696c 656e 616d 6529  pen(nb_filename)
-00000750: 2e72 6561 6428 290a 2020 2020 7265 7370  .read().    resp
-00000760: 6f6e 7365 203d 2061 7761 6974 2063 6c69  onse = await cli
-00000770: 656e 742e 706f 7374 280a 2020 2020 2020  ent.post(.      
-00000780: 2020 222f 6e6f 7465 626f 6f6b 732f 7570    "/notebooks/up
-00000790: 6c6f 6164 222c 0a20 2020 2020 2020 2071  load",.        q
-000007a0: 7565 7279 5f73 7472 696e 673d 7b22 6669  uery_string={"fi
-000007b0: 6c65 6e61 6d65 223a 2066 696c 656e 616d  lename": filenam
-000007c0: 657d 2c0a 2020 2020 2020 2020 6461 7461  e},.        data
-000007d0: 3d6e 625f 6a73 6f6e 2c0a 2020 2020 2020  =nb_json,.      
-000007e0: 2020 6865 6164 6572 733d 746f 6b65 6e5f    headers=token_
-000007f0: 6865 6164 6572 732c 0a20 2020 2029 0a20  headers,.    ). 
-00000800: 2020 2061 7373 6572 7420 7265 7370 6f6e     assert respon
-00000810: 7365 2e73 7461 7475 735f 636f 6465 203d  se.status_code =
-00000820: 3d20 3230 310a 2020 2020 7061 7468 203d  = 201.    path =
-00000830: 2072 6573 706f 6e73 652e 6a73 6f6e 2829   response.json()
-00000840: 5b22 7061 7468 225d 0a0a 2020 2020 7265  ["path"]..    re
-00000850: 7370 6f6e 7365 203d 2061 7761 6974 2063  sponse = await c
-00000860: 6c69 656e 742e 6765 7428 0a20 2020 2020  lient.get(.     
-00000870: 2020 2066 222f 6e6f 7465 626f 6f6b 732f     f"/notebooks/
-00000880: 6f70 656e 2f3f 6669 6c65 7061 7468 3d7b  open/?filepath={
-00000890: 7061 7468 7d22 2c20 6865 6164 6572 733d  path}", headers=
-000008a0: 746f 6b65 6e5f 6865 6164 6572 730a 2020  token_headers.  
-000008b0: 2020 290a 2020 2020 6173 7365 7274 2072    ).    assert r
-000008c0: 6573 706f 6e73 652e 7374 6174 7573 5f63  esponse.status_c
-000008d0: 6f64 6520 3d3d 2032 3031 0a20 2020 2072  ode == 201.    r
-000008e0: 6573 705f 6a73 6f6e 203d 2072 6573 706f  esp_json = respo
-000008f0: 6e73 652e 6a73 6f6e 2829 5b22 6e6f 7465  nse.json()["note
-00000900: 626f 6f6b 225d 0a20 2020 2075 7569 6420  book"].    uuid 
-00000910: 3d20 7265 7370 5f6a 736f 6e5b 226d 6574  = resp_json["met
-00000920: 6164 6174 6122 5d5b 226a 7570 7974 6572  adata"]["jupyter
-00000930: 5f64 3122 5d5b 2275 7569 6422 5d0a 0a20  _d1"]["uuid"].. 
-00000940: 2020 2023 2047 6976 6520 6b65 726e 656c     # Give kernel
-00000950: 2074 696d 6520 746f 2066 756c 6c79 2073   time to fully s
-00000960: 7461 7274 2c20 6b65 726e 656c 206d 6573  tart, kernel mes
-00000970: 7361 6765 7320 6361 6e20 6765 740a 2020  sages can get.  
-00000980: 2020 2320 6472 6f70 7065 6420 6f74 6865    # dropped othe
-00000990: 7277 6973 650a 2020 2020 6177 6169 7420  rwise.    await 
-000009a0: 6173 796e 6369 6f2e 736c 6565 7028 3229  asyncio.sleep(2)
-000009b0: 0a20 2020 2072 6574 7572 6e20 7575 6964  .    return uuid
-000009c0: 0a0a 0a64 6566 2061 7373 6572 745f 6365  ...def assert_ce
-000009d0: 6c6c 5f70 6f73 6974 696f 6e73 2863 656c  ll_positions(cel
-000009e0: 6c73 3a20 4c69 7374 5b44 6963 745b 7374  ls: List[Dict[st
-000009f0: 722c 2041 6e79 5d5d 293a 0a20 2020 2061  r, Any]]):.    a
-00000a00: 7373 6572 7420 5b63 5b22 6d65 7461 6461  ssert [c["metada
-00000a10: 7461 225d 5b22 6a75 7079 7465 725f 6431  ta"]["jupyter_d1
-00000a20: 225d 5b22 706f 7369 7469 6f6e 225d 2066  "]["position"] f
-00000a30: 6f72 2063 2069 6e20 6365 6c6c 735d 203d  or c in cells] =
-00000a40: 3d20 6c69 7374 280a 2020 2020 2020 2020  = list(.        
-00000a50: 7261 6e67 6528 302c 206c 656e 2863 656c  range(0, len(cel
-00000a60: 6c73 2929 0a20 2020 2029 0a0a 0a40 7079  ls)).    )...@py
-00000a70: 7465 7374 2e6d 6172 6b2e 7573 6566 6978  test.mark.usefix
-00000a80: 7475 7265 7328 2263 6c65 6172 5f6e 6f74  tures("clear_not
-00000a90: 6562 6f6f 6b73 222c 2022 636c 6561 725f  ebooks", "clear_
-00000aa0: 6e6f 7465 626f 6f6b 5f64 6972 6563 746f  notebook_directo
-00000ab0: 7279 2229 0a63 6c61 7373 2054 6573 744e  ry").class TestN
-00000ac0: 6f74 6562 6f6f 6b57 6562 536f 636b 6574  otebookWebSocket
-00000ad0: 3a0a 2020 2020 4070 7974 6573 742e 6d61  :.    @pytest.ma
-00000ae0: 726b 2e61 7379 6e63 696f 0a20 2020 2061  rk.asyncio.    a
-00000af0: 7379 6e63 2064 6566 2074 6573 745f 6e6f  sync def test_no
-00000b00: 7465 626f 6f6b 5f63 656c 6c5f 6578 6563  tebook_cell_exec
-00000b10: 7574 6528 0a20 2020 2020 2020 2073 656c  ute(.        sel
-00000b20: 662c 2063 6c69 656e 743a 2054 6573 7443  f, client: TestC
-00000b30: 6c69 656e 742c 2073 7570 6572 7573 6572  lient, superuser
-00000b40: 5f74 6f6b 656e 5f68 6561 6465 7273 3a20  _token_headers: 
-00000b50: 4469 6374 5b73 7472 2c20 7374 725d 0a20  Dict[str, str]. 
-00000b60: 2020 2029 3a0a 2020 2020 2020 2020 7575     ):.        uu
-00000b70: 6964 203d 2061 7761 6974 2075 706c 6f61  id = await uploa
-00000b80: 645f 6e6f 7465 626f 6f6b 2863 6c69 656e  d_notebook(clien
-00000b90: 742c 2073 7570 6572 7573 6572 5f74 6f6b  t, superuser_tok
-00000ba0: 656e 5f68 6561 6465 7273 290a 0a20 2020  en_headers)..   
-00000bb0: 2020 2020 2072 6573 706f 6e73 6520 3d20       response = 
-00000bc0: 6177 6169 7420 636c 6965 6e74 2e67 6574  await client.get
-00000bd0: 280a 2020 2020 2020 2020 2020 2020 6622  (.            f"
-00000be0: 2f6e 6f74 6562 6f6f 6b73 2f7b 7575 6964  /notebooks/{uuid
-00000bf0: 7d2f 6365 6c6c 7322 2c20 6865 6164 6572  }/cells", header
-00000c00: 733d 7375 7065 7275 7365 725f 746f 6b65  s=superuser_toke
-00000c10: 6e5f 6865 6164 6572 730a 2020 2020 2020  n_headers.      
-00000c20: 2020 290a 2020 2020 2020 2020 6173 7365    ).        asse
-00000c30: 7274 2072 6573 706f 6e73 652e 7374 6174  rt response.stat
-00000c40: 7573 5f63 6f64 6520 3d3d 2032 3030 0a20  us_code == 200. 
-00000c50: 2020 2020 2020 2063 656c 6c73 203d 2072         cells = r
-00000c60: 6573 706f 6e73 652e 6a73 6f6e 2829 5b22  esponse.json()["
-00000c70: 6365 6c6c 7322 5d0a 0a20 2020 2020 2020  cells"]..       
-00000c80: 2063 656c 6c20 3d20 6365 6c6c 735b 325d   cell = cells[2]
-00000c90: 0a20 2020 2020 2020 2063 656c 6c5f 7575  .        cell_uu
-00000ca0: 6964 203d 2063 656c 6c5b 226d 6574 6164  id = cell["metad
-00000cb0: 6174 6122 5d5b 226a 7570 7974 6572 5f64  ata"]["jupyter_d
-00000cc0: 3122 5d5b 2275 7569 6422 5d0a 0a20 2020  1"]["uuid"]..   
-00000cd0: 2020 2020 2061 7379 6e63 2077 6974 6820       async with 
-00000ce0: 636c 6965 6e74 2e77 6562 736f 636b 6574  client.websocket
-00000cf0: 5f63 6f6e 6e65 6374 280a 2020 2020 2020  _connect(.      
-00000d00: 2020 2020 2020 6622 2f6e 6f74 6562 6f6f        f"/noteboo
-00000d10: 6b73 2f7b 7575 6964 7d2f 7773 2f6e 6f74  ks/{uuid}/ws/not
-00000d20: 6562 6f6f 6b22 2c20 6865 6164 6572 733d  ebook", headers=
-00000d30: 7375 7065 7275 7365 725f 746f 6b65 6e5f  superuser_token_
-00000d40: 6865 6164 6572 730a 2020 2020 2020 2020  headers.        
-00000d50: 2920 6173 2077 6562 736f 636b 6574 3a0a  ) as websocket:.
-00000d60: 0a20 2020 2020 2020 2020 2020 2061 7761  .            awa
-00000d70: 6974 2061 7379 6e63 696f 2e73 6c65 6570  it asyncio.sleep
-00000d80: 2857 4542 534f 434b 4554 5f53 4c45 4550  (WEBSOCKET_SLEEP
-00000d90: 5f54 494d 4529 0a0a 2020 2020 2020 2020  _TIME)..        
-00000da0: 2020 2020 7265 7370 6f6e 7365 203d 2061      response = a
-00000db0: 7761 6974 2063 6c69 656e 742e 6765 7428  wait client.get(
-00000dc0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00000dd0: 2066 222f 6e6f 7465 626f 6f6b 732f 7b75   f"/notebooks/{u
-00000de0: 7569 647d 2f63 656c 6c73 2f7b 6365 6c6c  uid}/cells/{cell
-00000df0: 5f75 7569 647d 2f65 7865 6375 7465 222c  _uuid}/execute",
-00000e00: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00000e10: 2068 6561 6465 7273 3d73 7570 6572 7573   headers=superus
-00000e20: 6572 5f74 6f6b 656e 5f68 6561 6465 7273  er_token_headers
-00000e30: 2c0a 2020 2020 2020 2020 2020 2020 290a  ,.            ).
-00000e40: 2020 2020 2020 2020 2020 2020 6173 7365              asse
-00000e50: 7274 2072 6573 706f 6e73 652e 7374 6174  rt response.stat
-00000e60: 7573 5f63 6f64 6520 3d3d 2032 3030 0a20  us_code == 200. 
-00000e70: 2020 2020 2020 2020 2020 206d 7367 5f69             msg_i
-00000e80: 6420 3d20 7265 7370 6f6e 7365 2e6a 736f  d = response.jso
-00000e90: 6e28 295b 226b 6572 6e65 6c5f 6d65 7373  n()["kernel_mess
-00000ea0: 6167 6522 5d5b 226d 6573 7361 6765 5f69  age"]["message_i
-00000eb0: 6422 5d0a 0a20 2020 2020 2020 2020 2020  d"]..           
-00000ec0: 2023 2066 6972 7374 2074 776f 2063 6875   # first two chu
-00000ed0: 6e6b 7320 7265 6365 6976 6564 2073 686f  nks received sho
-00000ee0: 756c 6420 6265 2061 2065 7865 6375 7469  uld be a executi
-00000ef0: 6f6e 2063 6f75 6e74 2075 7064 6174 6520  on count update 
-00000f00: 616e 640a 2020 2020 2020 2020 2020 2020  and.            
-00000f10: 2320 6365 6c6c 5f75 7064 6174 6520 7769  # cell_update wi
-00000f20: 7468 2061 6e20 6578 6563 7574 696f 6e5f  th an execution_
-00000f30: 7374 6174 6520 6f66 2027 6275 7379 2720  state of 'busy' 
-00000f40: 7768 656e 2070 726f 6365 7373 696e 670a  when processing.
-00000f50: 2020 2020 2020 2020 2020 2020 2320 7374              # st
-00000f60: 6172 7473 2e20 4f72 6465 7220 6973 2076  arts. Order is v
-00000f70: 6172 6961 626c 652c 2073 6f20 6865 7265  ariable, so here
-00000f80: 2077 6520 6861 6e64 6c65 2065 6974 6865   we handle eithe
-00000f90: 7220 6f72 6465 722e 0a20 2020 2020 2020  r order..       
-00000fa0: 2020 2020 2064 6566 2061 7373 6572 745f       def assert_
-00000fb0: 6a73 6f6e 5f63 6f6e 7465 6e74 2864 6174  json_content(dat
-00000fc0: 612c 2065 7865 6375 7469 6f6e 5f63 6f75  a, execution_cou
-00000fd0: 6e74 3d4e 6f6e 6529 3a0a 2020 2020 2020  nt=None):.      
-00000fe0: 2020 2020 2020 2020 2020 6966 2022 6365            if "ce
-00000ff0: 6c6c 5f75 7064 6174 6522 2069 6e20 6461  ll_update" in da
-00001000: 7461 3a0a 2020 2020 2020 2020 2020 2020  ta:.            
-00001010: 2020 2020 2020 2020 6365 6c6c 5f64 6174          cell_dat
-00001020: 6120 3d20 6461 7461 5b22 6365 6c6c 5f75  a = data["cell_u
-00001030: 7064 6174 6522 5d5b 305d 0a20 2020 2020  pdate"][0].     
-00001040: 2020 2020 2020 2020 2020 2020 2020 2064                 d
-00001050: 315f 6d65 7461 6461 7461 203d 2063 656c  1_metadata = cel
-00001060: 6c5f 6461 7461 5b22 6d65 7461 6461 7461  l_data["metadata
-00001070: 225d 5b22 6a75 7079 7465 725f 6431 225d  "]["jupyter_d1"]
-00001080: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00001090: 2020 2020 2061 7373 6572 7420 6431 5f6d       assert d1_m
-000010a0: 6574 6164 6174 615b 2265 7865 6375 7469  etadata["executi
-000010b0: 6f6e 5f73 7461 7465 225d 203d 3d20 2262  on_state"] == "b
-000010c0: 7573 7922 0a20 2020 2020 2020 2020 2020  usy".           
-000010d0: 2020 2020 2020 2020 2061 7373 6572 7420           assert 
-000010e0: 6431 5f6d 6574 6164 6174 615b 2275 7569  d1_metadata["uui
-000010f0: 6422 5d20 3d3d 2063 656c 6c5f 7575 6964  d"] == cell_uuid
-00001100: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00001110: 2020 2020 2061 7373 6572 7420 6365 6c6c       assert cell
-00001120: 5f64 6174 615b 2265 7865 6375 7469 6f6e  _data["execution
-00001130: 5f63 6f75 6e74 225d 203d 3d20 6578 6563  _count"] == exec
-00001140: 7574 696f 6e5f 636f 756e 740a 2020 2020  ution_count.    
-00001150: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00001160: 7265 7475 726e 204e 6f6e 650a 2020 2020  return None.    
-00001170: 2020 2020 2020 2020 2020 2020 656c 6966              elif
-00001180: 2022 6365 6c6c 5f65 7865 6375 7469 6f6e   "cell_execution
-00001190: 5f72 6570 6c79 2220 696e 2064 6174 613a  _reply" in data:
-000011a0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-000011b0: 2020 2020 2061 7373 6572 7420 6461 7461       assert data
-000011c0: 5b22 6365 6c6c 5f65 7865 6375 7469 6f6e  ["cell_execution
-000011d0: 5f72 6570 6c79 225d 5b22 6578 6563 7574  _reply"]["execut
-000011e0: 696f 6e5f 636f 756e 7422 5d20 3d3d 2031  ion_count"] == 1
+00000070: 706f 7274 2041 6e79 2c20 4469 6374 2c20  port Any, Dict, 
+00000080: 4c69 7374 2c20 4f70 7469 6f6e 616c 0a66  List, Optional.f
+00000090: 726f 6d20 756e 6974 7465 7374 2e6d 6f63  rom unittest.moc
+000000a0: 6b20 696d 706f 7274 2063 616c 6c0a 0a23  k import call..#
+000000b0: 2066 726f 6d20 6661 7374 6170 692e 7465   from fastapi.te
+000000c0: 7374 636c 6965 6e74 2069 6d70 6f72 7420  stclient import 
+000000d0: 5465 7374 436c 6965 6e74 0a69 6d70 6f72  TestClient.impor
+000000e0: 7420 7079 7465 7374 2020 2320 7479 7065  t pytest  # type
+000000f0: 3a20 6967 6e6f 7265 0a66 726f 6d20 7079  : ignore.from py
+00000100: 7465 7374 5f6d 6f63 6b20 696d 706f 7274  test_mock import
+00000110: 204d 6f63 6b46 6978 7475 7265 2020 2320   MockFixture  # 
+00000120: 7479 7065 3a20 6967 6e6f 7265 0a0a 6672  type: ignore..fr
+00000130: 6f6d 206a 7570 7974 6572 5f64 312e 7365  om jupyter_d1.se
+00000140: 7474 696e 6773 2069 6d70 6f72 7420 7365  ttings import se
+00000150: 7474 696e 6773 0a0a 6672 6f6d 202e 4431  ttings..from .D1
+00000160: 5465 7374 436c 6965 6e74 2069 6d70 6f72  TestClient impor
+00000170: 7420 5465 7374 436c 6965 6e74 0a66 726f  t TestClient.fro
+00000180: 6d20 2e75 7469 6c73 2069 6d70 6f72 7420  m .utils import 
+00000190: 280a 2020 2020 636f 6c6c 6563 745f 7765  (.    collect_we
+000001a0: 6273 6f63 6b65 745f 6d65 7373 6167 6573  bsocket_messages
+000001b0: 2c0a 2020 2020 636f 6d70 6172 655f 6365  ,.    compare_ce
+000001c0: 6c6c 732c 0a20 2020 2066 696c 7465 725f  lls,.    filter_
+000001d0: 7765 6273 6f63 6b65 745f 636f 6c6c 6563  websocket_collec
+000001e0: 7469 6f6e 2c0a 2020 2020 6765 745f 7375  tion,.    get_su
+000001f0: 7065 7275 7365 725f 746f 6b65 6e2c 0a20  peruser_token,. 
+00000200: 2020 206d 7367 5f69 645f 6c65 6e67 7468     msg_id_length
+00000210: 732c 0a20 2020 2072 6563 6569 7665 5f6a  s,.    receive_j
+00000220: 736f 6e2c 0a20 2020 2072 6573 6f6c 7665  son,.    resolve
+00000230: 2c0a 2020 2020 7761 6974 5f66 6f72 5f65  ,.    wait_for_e
+00000240: 7665 6e74 2c0a 290a 0a23 2041 6c6c 2074  vent,.)..# All t
+00000250: 6573 7420 636f 726f 7574 696e 6573 2077  est coroutines w
+00000260: 696c 6c20 6265 2074 7265 6174 6564 2061  ill be treated a
+00000270: 7320 6d61 726b 6564 2e0a 2320 7079 7465  s marked..# pyte
+00000280: 7374 6d61 726b 203d 2070 7974 6573 742e  stmark = pytest.
+00000290: 6d61 726b 2e61 7379 6e63 696f 0a0a 5745  mark.asyncio..WE
+000002a0: 4253 4f43 4b45 545f 534c 4545 505f 5449  BSOCKET_SLEEP_TI
+000002b0: 4d45 203d 2031 2e31 0a0a 0a61 7379 6e63  ME = 1.1...async
+000002c0: 2064 6566 2075 706c 6f61 645f 6e6f 7465   def upload_note
+000002d0: 626f 6f6b 280a 2020 2020 636c 6965 6e74  book(.    client
+000002e0: 3a20 5465 7374 436c 6965 6e74 2c0a 2020  : TestClient,.  
+000002f0: 2020 746f 6b65 6e5f 6865 6164 6572 733a    token_headers:
+00000300: 2044 6963 745b 7374 722c 2073 7472 5d2c   Dict[str, str],
+00000310: 0a20 2020 2066 696c 656e 616d 653a 2073  .    filename: s
+00000320: 7472 203d 2022 7369 6d70 6c65 2e69 7079  tr = "simple.ipy
+00000330: 6e62 222c 0a29 202d 3e20 7374 723a 0a20  nb",.) -> str:. 
+00000340: 2020 206e 625f 6669 6c65 6e61 6d65 203d     nb_filename =
+00000350: 2066 226a 7570 7974 6572 5f64 312f 7465   f"jupyter_d1/te
+00000360: 7374 732f 6e6f 7465 626f 6f6b 732f 7b66  sts/notebooks/{f
+00000370: 696c 656e 616d 657d 220a 2020 2020 6e62  ilename}".    nb
+00000380: 5f6a 736f 6e20 3d20 6f70 656e 286e 625f  _json = open(nb_
+00000390: 6669 6c65 6e61 6d65 292e 7265 6164 2829  filename).read()
+000003a0: 0a20 2020 2072 6573 706f 6e73 6520 3d20  .    response = 
+000003b0: 6177 6169 7420 636c 6965 6e74 2e70 6f73  await client.pos
+000003c0: 7428 0a20 2020 2020 2020 2022 2f6e 6f74  t(.        "/not
+000003d0: 6562 6f6f 6b73 2f75 706c 6f61 6422 2c0a  ebooks/upload",.
+000003e0: 2020 2020 2020 2020 7175 6572 795f 7374          query_st
+000003f0: 7269 6e67 3d7b 2266 696c 656e 616d 6522  ring={"filename"
+00000400: 3a20 6669 6c65 6e61 6d65 7d2c 0a20 2020  : filename},.   
+00000410: 2020 2020 2064 6174 613d 6e62 5f6a 736f       data=nb_jso
+00000420: 6e2c 0a20 2020 2020 2020 2068 6561 6465  n,.        heade
+00000430: 7273 3d74 6f6b 656e 5f68 6561 6465 7273  rs=token_headers
+00000440: 2c0a 2020 2020 290a 2020 2020 6173 7365  ,.    ).    asse
+00000450: 7274 2072 6573 706f 6e73 652e 7374 6174  rt response.stat
+00000460: 7573 5f63 6f64 6520 3d3d 2032 3031 0a20  us_code == 201. 
+00000470: 2020 2070 6174 6820 3d20 7265 7370 6f6e     path = respon
+00000480: 7365 2e6a 736f 6e28 295b 2270 6174 6822  se.json()["path"
+00000490: 5d0a 0a20 2020 2072 6573 706f 6e73 6520  ]..    response 
+000004a0: 3d20 6177 6169 7420 636c 6965 6e74 2e67  = await client.g
+000004b0: 6574 280a 2020 2020 2020 2020 6622 2f6e  et(.        f"/n
+000004c0: 6f74 6562 6f6f 6b73 2f6f 7065 6e2f 3f66  otebooks/open/?f
+000004d0: 696c 6570 6174 683d 7b70 6174 687d 222c  ilepath={path}",
+000004e0: 2068 6561 6465 7273 3d74 6f6b 656e 5f68   headers=token_h
+000004f0: 6561 6465 7273 0a20 2020 2029 0a20 2020  eaders.    ).   
+00000500: 2061 7373 6572 7420 7265 7370 6f6e 7365   assert response
+00000510: 2e73 7461 7475 735f 636f 6465 203d 3d20  .status_code == 
+00000520: 3230 310a 2020 2020 7265 7370 5f6a 736f  201.    resp_jso
+00000530: 6e20 3d20 7265 7370 6f6e 7365 2e6a 736f  n = response.jso
+00000540: 6e28 295b 226e 6f74 6562 6f6f 6b22 5d0a  n()["notebook"].
+00000550: 2020 2020 7575 6964 203d 2072 6573 705f      uuid = resp_
+00000560: 6a73 6f6e 5b22 6d65 7461 6461 7461 225d  json["metadata"]
+00000570: 5b22 6a75 7079 7465 725f 6431 225d 5b22  ["jupyter_d1"]["
+00000580: 7575 6964 225d 0a0a 2020 2020 2320 4769  uuid"]..    # Gi
+00000590: 7665 206b 6572 6e65 6c20 7469 6d65 2074  ve kernel time t
+000005a0: 6f20 6675 6c6c 7920 7374 6172 742c 206b  o fully start, k
+000005b0: 6572 6e65 6c20 6d65 7373 6167 6573 2063  ernel messages c
+000005c0: 616e 2067 6574 0a20 2020 2023 2064 726f  an get.    # dro
+000005d0: 7070 6564 206f 7468 6572 7769 7365 0a20  pped otherwise. 
+000005e0: 2020 2061 7761 6974 2061 7379 6e63 696f     await asyncio
+000005f0: 2e73 6c65 6570 2832 290a 2020 2020 7265  .sleep(2).    re
+00000600: 7475 726e 2075 7569 640a 0a0a 6465 6620  turn uuid...def 
+00000610: 6173 7365 7274 5f63 656c 6c5f 706f 7369  assert_cell_posi
+00000620: 7469 6f6e 7328 6365 6c6c 733a 204c 6973  tions(cells: Lis
+00000630: 745b 4469 6374 5b73 7472 2c20 416e 795d  t[Dict[str, Any]
+00000640: 5d29 3a0a 2020 2020 6173 7365 7274 205b  ]):.    assert [
+00000650: 635b 226d 6574 6164 6174 6122 5d5b 226a  c["metadata"]["j
+00000660: 7570 7974 6572 5f64 3122 5d5b 2270 6f73  upyter_d1"]["pos
+00000670: 6974 696f 6e22 5d20 666f 7220 6320 696e  ition"] for c in
+00000680: 2063 656c 6c73 5d20 3d3d 206c 6973 7428   cells] == list(
+00000690: 0a20 2020 2020 2020 2072 616e 6765 2830  .        range(0
+000006a0: 2c20 6c65 6e28 6365 6c6c 7329 290a 2020  , len(cells)).  
+000006b0: 2020 290a 0a0a 4070 7974 6573 742e 6d61    )...@pytest.ma
+000006c0: 726b 2e75 7365 6669 7874 7572 6573 2822  rk.usefixtures("
+000006d0: 636c 6561 725f 6e6f 7465 626f 6f6b 7322  clear_notebooks"
+000006e0: 2c20 2263 6c65 6172 5f6e 6f74 6562 6f6f  , "clear_noteboo
+000006f0: 6b5f 6469 7265 6374 6f72 7922 290a 636c  k_directory").cl
+00000700: 6173 7320 5465 7374 4e6f 7465 626f 6f6b  ass TestNotebook
+00000710: 5765 6253 6f63 6b65 743a 0a20 2020 2040  WebSocket:.    @
+00000720: 7079 7465 7374 2e6d 6172 6b2e 6173 796e  pytest.mark.asyn
+00000730: 6369 6f0a 2020 2020 6173 796e 6320 6465  cio.    async de
+00000740: 6620 7465 7374 5f6e 6f74 6562 6f6f 6b5f  f test_notebook_
+00000750: 6365 6c6c 5f65 7865 6375 7465 280a 2020  cell_execute(.  
+00000760: 2020 2020 2020 7365 6c66 2c20 636c 6965        self, clie
+00000770: 6e74 3a20 5465 7374 436c 6965 6e74 2c20  nt: TestClient, 
+00000780: 7375 7065 7275 7365 725f 746f 6b65 6e5f  superuser_token_
+00000790: 6865 6164 6572 733a 2044 6963 745b 7374  headers: Dict[st
+000007a0: 722c 2073 7472 5d0a 2020 2020 293a 0a20  r, str].    ):. 
+000007b0: 2020 2020 2020 2075 7569 6420 3d20 6177         uuid = aw
+000007c0: 6169 7420 7570 6c6f 6164 5f6e 6f74 6562  ait upload_noteb
+000007d0: 6f6f 6b28 636c 6965 6e74 2c20 7375 7065  ook(client, supe
+000007e0: 7275 7365 725f 746f 6b65 6e5f 6865 6164  ruser_token_head
+000007f0: 6572 7329 0a0a 2020 2020 2020 2020 7265  ers)..        re
+00000800: 7370 6f6e 7365 203d 2061 7761 6974 2063  sponse = await c
+00000810: 6c69 656e 742e 6765 7428 0a20 2020 2020  lient.get(.     
+00000820: 2020 2020 2020 2066 222f 6e6f 7465 626f         f"/notebo
+00000830: 6f6b 732f 7b75 7569 647d 2f63 656c 6c73  oks/{uuid}/cells
+00000840: 222c 2068 6561 6465 7273 3d73 7570 6572  ", headers=super
+00000850: 7573 6572 5f74 6f6b 656e 5f68 6561 6465  user_token_heade
+00000860: 7273 0a20 2020 2020 2020 2029 0a20 2020  rs.        ).   
+00000870: 2020 2020 2061 7373 6572 7420 7265 7370       assert resp
+00000880: 6f6e 7365 2e73 7461 7475 735f 636f 6465  onse.status_code
+00000890: 203d 3d20 3230 300a 2020 2020 2020 2020   == 200.        
+000008a0: 6365 6c6c 7320 3d20 7265 7370 6f6e 7365  cells = response
+000008b0: 2e6a 736f 6e28 295b 2263 656c 6c73 225d  .json()["cells"]
+000008c0: 0a0a 2020 2020 2020 2020 6365 6c6c 203d  ..        cell =
+000008d0: 2063 656c 6c73 5b32 5d0a 2020 2020 2020   cells[2].      
+000008e0: 2020 6365 6c6c 5f75 7569 6420 3d20 6365    cell_uuid = ce
+000008f0: 6c6c 5b22 6d65 7461 6461 7461 225d 5b22  ll["metadata"]["
+00000900: 6a75 7079 7465 725f 6431 225d 5b22 7575  jupyter_d1"]["uu
+00000910: 6964 225d 0a0a 2020 2020 2020 2020 6173  id"]..        as
+00000920: 796e 6320 7769 7468 2063 6c69 656e 742e  ync with client.
+00000930: 7765 6273 6f63 6b65 745f 636f 6e6e 6563  websocket_connec
+00000940: 7428 0a20 2020 2020 2020 2020 2020 2066  t(.            f
+00000950: 222f 6e6f 7465 626f 6f6b 732f 7b75 7569  "/notebooks/{uui
+00000960: 647d 2f77 732f 6e6f 7465 626f 6f6b 222c  d}/ws/notebook",
+00000970: 2068 6561 6465 7273 3d73 7570 6572 7573   headers=superus
+00000980: 6572 5f74 6f6b 656e 5f68 6561 6465 7273  er_token_headers
+00000990: 0a20 2020 2020 2020 2029 2061 7320 7765  .        ) as we
+000009a0: 6273 6f63 6b65 743a 0a0a 2020 2020 2020  bsocket:..      
+000009b0: 2020 2020 2020 6177 6169 7420 6173 796e        await asyn
+000009c0: 6369 6f2e 736c 6565 7028 5745 4253 4f43  cio.sleep(WEBSOC
+000009d0: 4b45 545f 534c 4545 505f 5449 4d45 290a  KET_SLEEP_TIME).
+000009e0: 0a20 2020 2020 2020 2020 2020 2072 6573  .            res
+000009f0: 706f 6e73 6520 3d20 6177 6169 7420 636c  ponse = await cl
+00000a00: 6965 6e74 2e67 6574 280a 2020 2020 2020  ient.get(.      
+00000a10: 2020 2020 2020 2020 2020 6622 2f6e 6f74            f"/not
+00000a20: 6562 6f6f 6b73 2f7b 7575 6964 7d2f 6365  ebooks/{uuid}/ce
+00000a30: 6c6c 732f 7b63 656c 6c5f 7575 6964 7d2f  lls/{cell_uuid}/
+00000a40: 6578 6563 7574 6522 2c0a 2020 2020 2020  execute",.      
+00000a50: 2020 2020 2020 2020 2020 6865 6164 6572            header
+00000a60: 733d 7375 7065 7275 7365 725f 746f 6b65  s=superuser_toke
+00000a70: 6e5f 6865 6164 6572 732c 0a20 2020 2020  n_headers,.     
+00000a80: 2020 2020 2020 2029 0a20 2020 2020 2020         ).       
+00000a90: 2020 2020 2061 7373 6572 7420 7265 7370       assert resp
+00000aa0: 6f6e 7365 2e73 7461 7475 735f 636f 6465  onse.status_code
+00000ab0: 203d 3d20 3230 300a 2020 2020 2020 2020   == 200.        
+00000ac0: 2020 2020 6d73 675f 6964 203d 2072 6573      msg_id = res
+00000ad0: 706f 6e73 652e 6a73 6f6e 2829 5b22 6b65  ponse.json()["ke
+00000ae0: 726e 656c 5f6d 6573 7361 6765 225d 5b22  rnel_message"]["
+00000af0: 6d65 7373 6167 655f 6964 225d 0a0a 2020  message_id"]..  
+00000b00: 2020 2020 2020 2020 2020 2320 6669 7273            # firs
+00000b10: 7420 7477 6f20 6368 756e 6b73 2072 6563  t two chunks rec
+00000b20: 6569 7665 6420 7368 6f75 6c64 2062 6520  eived should be 
+00000b30: 6120 6578 6563 7574 696f 6e20 636f 756e  a execution coun
+00000b40: 7420 7570 6461 7465 2061 6e64 0a20 2020  t update and.   
+00000b50: 2020 2020 2020 2020 2023 2063 656c 6c5f           # cell_
+00000b60: 7570 6461 7465 2077 6974 6820 616e 2065  update with an e
+00000b70: 7865 6375 7469 6f6e 5f73 7461 7465 206f  xecution_state o
+00000b80: 6620 2762 7573 7927 2077 6865 6e20 7072  f 'busy' when pr
+00000b90: 6f63 6573 7369 6e67 0a20 2020 2020 2020  ocessing.       
+00000ba0: 2020 2020 2023 2073 7461 7274 732e 204f       # starts. O
+00000bb0: 7264 6572 2069 7320 7661 7269 6162 6c65  rder is variable
+00000bc0: 2c20 736f 2068 6572 6520 7765 2068 616e  , so here we han
+00000bd0: 646c 6520 6569 7468 6572 206f 7264 6572  dle either order
+00000be0: 2e0a 2020 2020 2020 2020 2020 2020 6465  ..            de
+00000bf0: 6620 6173 7365 7274 5f6a 736f 6e5f 636f  f assert_json_co
+00000c00: 6e74 656e 7428 6461 7461 2c20 6578 6563  ntent(data, exec
+00000c10: 7574 696f 6e5f 636f 756e 743d 4e6f 6e65  ution_count=None
+00000c20: 293a 0a20 2020 2020 2020 2020 2020 2020  ):.             
+00000c30: 2020 2069 6620 2263 656c 6c5f 7570 6461     if "cell_upda
+00000c40: 7465 2220 696e 2064 6174 613a 0a20 2020  te" in data:.   
+00000c50: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00000c60: 2063 656c 6c5f 6461 7461 203d 2064 6174   cell_data = dat
+00000c70: 615b 2263 656c 6c5f 7570 6461 7465 225d  a["cell_update"]
+00000c80: 5b30 5d0a 2020 2020 2020 2020 2020 2020  [0].            
+00000c90: 2020 2020 2020 2020 6431 5f6d 6574 6164          d1_metad
+00000ca0: 6174 6120 3d20 6365 6c6c 5f64 6174 615b  ata = cell_data[
+00000cb0: 226d 6574 6164 6174 6122 5d5b 226a 7570  "metadata"]["jup
+00000cc0: 7974 6572 5f64 3122 5d0a 2020 2020 2020  yter_d1"].      
+00000cd0: 2020 2020 2020 2020 2020 2020 2020 6173                as
+00000ce0: 7365 7274 2064 315f 6d65 7461 6461 7461  sert d1_metadata
+00000cf0: 5b22 6578 6563 7574 696f 6e5f 7374 6174  ["execution_stat
+00000d00: 6522 5d20 3d3d 2022 6275 7379 220a 2020  e"] == "busy".  
+00000d10: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00000d20: 2020 6173 7365 7274 2064 315f 6d65 7461    assert d1_meta
+00000d30: 6461 7461 5b22 7575 6964 225d 203d 3d20  data["uuid"] == 
+00000d40: 6365 6c6c 5f75 7569 640a 2020 2020 2020  cell_uuid.      
+00000d50: 2020 2020 2020 2020 2020 2020 2020 6173                as
+00000d60: 7365 7274 2063 656c 6c5f 6461 7461 5b22  sert cell_data["
+00000d70: 6578 6563 7574 696f 6e5f 636f 756e 7422  execution_count"
+00000d80: 5d20 3d3d 2065 7865 6375 7469 6f6e 5f63  ] == execution_c
+00000d90: 6f75 6e74 0a20 2020 2020 2020 2020 2020  ount.           
+00000da0: 2020 2020 2020 2020 2072 6574 7572 6e20           return 
+00000db0: 4e6f 6e65 0a20 2020 2020 2020 2020 2020  None.           
+00000dc0: 2020 2020 2065 6c69 6620 2263 656c 6c5f       elif "cell_
+00000dd0: 6578 6563 7574 696f 6e5f 7265 706c 7922  execution_reply"
+00000de0: 2069 6e20 6461 7461 3a0a 2020 2020 2020   in data:.      
+00000df0: 2020 2020 2020 2020 2020 2020 2020 6173                as
+00000e00: 7365 7274 2064 6174 615b 2263 656c 6c5f  sert data["cell_
+00000e10: 6578 6563 7574 696f 6e5f 7265 706c 7922  execution_reply"
+00000e20: 5d5b 2265 7865 6375 7469 6f6e 5f63 6f75  ]["execution_cou
+00000e30: 6e74 225d 203d 3d20 310a 2020 2020 2020  nt"] == 1.      
+00000e40: 2020 2020 2020 2020 2020 2020 2020 6173                as
+00000e50: 7365 7274 2064 6174 615b 2263 656c 6c5f  sert data["cell_
+00000e60: 6578 6563 7574 696f 6e5f 7265 706c 7922  execution_reply"
+00000e70: 5d5b 2263 656c 6c5f 6964 225d 203d 3d20  ]["cell_id"] == 
+00000e80: 6365 6c6c 5f75 7569 640a 2020 2020 2020  cell_uuid.      
+00000e90: 2020 2020 2020 2020 2020 2020 2020 6173                as
+00000ea0: 7365 7274 2064 6174 615b 2263 656c 6c5f  sert data["cell_
+00000eb0: 6578 6563 7574 696f 6e5f 7265 706c 7922  execution_reply"
+00000ec0: 5d5b 2270 6172 656e 745f 6964 225d 203d  ]["parent_id"] =
+00000ed0: 3d20 6d73 675f 6964 0a20 2020 2020 2020  = msg_id.       
+00000ee0: 2020 2020 2020 2020 2020 2020 2072 6574               ret
+00000ef0: 7572 6e20 310a 2020 2020 2020 2020 2020  urn 1.          
+00000f00: 2020 2020 2020 656c 7365 3a0a 2020 2020        else:.    
+00000f10: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00000f20: 7261 6973 6520 4173 7365 7274 696f 6e45  raise AssertionE
+00000f30: 7272 6f72 2866 2275 6e65 7870 6563 7465  rror(f"unexpecte
+00000f40: 6420 6365 6c6c 2074 7970 653a 207b 6461  d cell type: {da
+00000f50: 7461 7d22 290a 0a20 2020 2020 2020 2020  ta}")..         
+00000f60: 2020 2064 6174 6120 3d20 6177 6169 7420     data = await 
+00000f70: 7265 6365 6976 655f 6a73 6f6e 280a 2020  receive_json(.  
+00000f80: 2020 2020 2020 2020 2020 2020 2020 7765                we
+00000f90: 6273 6f63 6b65 742c 206d 7367 5f74 7970  bsocket, msg_typ
+00000fa0: 6573 3d5b 2263 656c 6c5f 7570 6461 7465  es=["cell_update
+00000fb0: 222c 2022 6365 6c6c 5f65 7865 6375 7469  ", "cell_executi
+00000fc0: 6f6e 5f72 6570 6c79 225d 0a20 2020 2020  on_reply"].     
+00000fd0: 2020 2020 2020 2029 0a20 2020 2020 2020         ).       
+00000fe0: 2020 2020 2065 7865 635f 636f 756e 7420       exec_count 
+00000ff0: 3d20 6173 7365 7274 5f6a 736f 6e5f 636f  = assert_json_co
+00001000: 6e74 656e 7428 6461 7461 290a 2020 2020  ntent(data).    
+00001010: 2020 2020 2020 2020 6461 7461 203d 2061          data = a
+00001020: 7761 6974 2072 6563 6569 7665 5f6a 736f  wait receive_jso
+00001030: 6e28 0a20 2020 2020 2020 2020 2020 2020  n(.             
+00001040: 2020 2077 6562 736f 636b 6574 2c20 6d73     websocket, ms
+00001050: 675f 7479 7065 733d 5b22 6365 6c6c 5f75  g_types=["cell_u
+00001060: 7064 6174 6522 2c20 2263 656c 6c5f 6578  pdate", "cell_ex
+00001070: 6563 7574 696f 6e5f 7265 706c 7922 5d0a  ecution_reply"].
+00001080: 2020 2020 2020 2020 2020 2020 290a 2020              ).  
+00001090: 2020 2020 2020 2020 2020 6173 7365 7274            assert
+000010a0: 5f6a 736f 6e5f 636f 6e74 656e 7428 6461  _json_content(da
+000010b0: 7461 2c20 6578 6563 5f63 6f75 6e74 290a  ta, exec_count).
+000010c0: 0a20 2020 2020 2020 2020 2020 2023 2074  .            # t
+000010d0: 6869 7264 2063 6875 6e6b 2072 6563 6569  hird chunk recei
+000010e0: 7665 6420 7368 6f75 6c64 2062 6520 6120  ved should be a 
+000010f0: 6365 6c6c 5f75 7064 6174 6520 7769 7468  cell_update with
+00001100: 0a20 2020 2020 2020 2020 2020 2023 2074  .            # t
+00001110: 6865 206e 6577 206f 7574 7075 742c 2061  he new output, a
+00001120: 6e64 2061 6e20 6578 6563 7574 696f 6e5f  nd an execution_
+00001130: 7374 6174 6520 6f66 2027 6275 7379 270a  state of 'busy'.
+00001140: 2020 2020 2020 2020 2020 2020 2320 7369              # si
+00001150: 6e63 6520 6974 2069 7320 7374 696c 6c20  nce it is still 
+00001160: 7072 6f63 6573 7369 6e67 0a20 2020 2020  processing.     
+00001170: 2020 2020 2020 2064 6174 6120 3d20 6177         data = aw
+00001180: 6169 7420 7265 6365 6976 655f 6a73 6f6e  ait receive_json
+00001190: 2877 6562 736f 636b 6574 2c20 6d73 675f  (websocket, msg_
+000011a0: 7479 7065 733d 5b22 6365 6c6c 5f75 7064  types=["cell_upd
+000011b0: 6174 6522 5d29 0a20 2020 2020 2020 2020  ate"]).         
+000011c0: 2020 2065 7870 6563 7465 6420 3d20 7b0a     expected = {.
+000011d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000011e0: 2263 656c 6c5f 7570 6461 7465 223a 205b  "cell_update": [
 000011f0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00001200: 2020 2020 2061 7373 6572 7420 6461 7461       assert data
-00001210: 5b22 6365 6c6c 5f65 7865 6375 7469 6f6e  ["cell_execution
-00001220: 5f72 6570 6c79 225d 5b22 6365 6c6c 5f69  _reply"]["cell_i
-00001230: 6422 5d20 3d3d 2063 656c 6c5f 7575 6964  d"] == cell_uuid
-00001240: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00001250: 2020 2020 2061 7373 6572 7420 6461 7461       assert data
-00001260: 5b22 6365 6c6c 5f65 7865 6375 7469 6f6e  ["cell_execution
-00001270: 5f72 6570 6c79 225d 5b22 7061 7265 6e74  _reply"]["parent
-00001280: 5f69 6422 5d20 3d3d 206d 7367 5f69 640a  _id"] == msg_id.
+00001200: 2020 2020 207b 0a20 2020 2020 2020 2020       {.         
+00001210: 2020 2020 2020 2020 2020 2020 2020 2022                 "
+00001220: 6365 6c6c 5f74 7970 6522 3a20 2263 6f64  cell_type": "cod
+00001230: 6522 2c0a 2020 2020 2020 2020 2020 2020  e",.            
+00001240: 2020 2020 2020 2020 2020 2020 2265 7865              "exe
+00001250: 6375 7469 6f6e 5f63 6f75 6e74 223a 2031  cution_count": 1
+00001260: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
+00001270: 2020 2020 2020 2020 2020 226d 6574 6164            "metad
+00001280: 6174 6122 3a20 7b0a 2020 2020 2020 2020  ata": {.        
 00001290: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000012a0: 2020 2020 7265 7475 726e 2031 0a20 2020      return 1.   
-000012b0: 2020 2020 2020 2020 2020 2020 2065 6c73               els
-000012c0: 653a 0a20 2020 2020 2020 2020 2020 2020  e:.             
-000012d0: 2020 2020 2020 2072 6169 7365 2041 7373         raise Ass
-000012e0: 6572 7469 6f6e 4572 726f 7228 6622 756e  ertionError(f"un
-000012f0: 6578 7065 6374 6564 2063 656c 6c20 7479  expected cell ty
-00001300: 7065 3a20 7b64 6174 617d 2229 0a0a 2020  pe: {data}")..  
-00001310: 2020 2020 2020 2020 2020 6461 7461 203d            data =
-00001320: 2061 7761 6974 2072 6563 6569 7665 5f6a   await receive_j
-00001330: 736f 6e28 0a20 2020 2020 2020 2020 2020  son(.           
-00001340: 2020 2020 2077 6562 736f 636b 6574 2c20       websocket, 
-00001350: 6d73 675f 7479 7065 733d 5b22 6365 6c6c  msg_types=["cell
-00001360: 5f75 7064 6174 6522 2c20 2263 656c 6c5f  _update", "cell_
-00001370: 6578 6563 7574 696f 6e5f 7265 706c 7922  execution_reply"
-00001380: 5d0a 2020 2020 2020 2020 2020 2020 290a  ].            ).
-00001390: 2020 2020 2020 2020 2020 2020 6578 6563              exec
-000013a0: 5f63 6f75 6e74 203d 2061 7373 6572 745f  _count = assert_
-000013b0: 6a73 6f6e 5f63 6f6e 7465 6e74 2864 6174  json_content(dat
-000013c0: 6129 0a20 2020 2020 2020 2020 2020 2064  a).            d
-000013d0: 6174 6120 3d20 6177 6169 7420 7265 6365  ata = await rece
-000013e0: 6976 655f 6a73 6f6e 280a 2020 2020 2020  ive_json(.      
-000013f0: 2020 2020 2020 2020 2020 7765 6273 6f63            websoc
-00001400: 6b65 742c 206d 7367 5f74 7970 6573 3d5b  ket, msg_types=[
-00001410: 2263 656c 6c5f 7570 6461 7465 222c 2022  "cell_update", "
-00001420: 6365 6c6c 5f65 7865 6375 7469 6f6e 5f72  cell_execution_r
-00001430: 6570 6c79 225d 0a20 2020 2020 2020 2020  eply"].         
-00001440: 2020 2029 0a20 2020 2020 2020 2020 2020     ).           
-00001450: 2061 7373 6572 745f 6a73 6f6e 5f63 6f6e   assert_json_con
-00001460: 7465 6e74 2864 6174 612c 2065 7865 635f  tent(data, exec_
-00001470: 636f 756e 7429 0a0a 2020 2020 2020 2020  count)..        
-00001480: 2020 2020 2320 7468 6972 6420 6368 756e      # third chun
-00001490: 6b20 7265 6365 6976 6564 2073 686f 756c  k received shoul
-000014a0: 6420 6265 2061 2063 656c 6c5f 7570 6461  d be a cell_upda
-000014b0: 7465 2077 6974 680a 2020 2020 2020 2020  te with.        
-000014c0: 2020 2020 2320 7468 6520 6e65 7720 6f75      # the new ou
-000014d0: 7470 7574 2c20 616e 6420 616e 2065 7865  tput, and an exe
-000014e0: 6375 7469 6f6e 5f73 7461 7465 206f 6620  cution_state of 
-000014f0: 2762 7573 7927 0a20 2020 2020 2020 2020  'busy'.         
-00001500: 2020 2023 2073 696e 6365 2069 7420 6973     # since it is
-00001510: 2073 7469 6c6c 2070 726f 6365 7373 696e   still processin
-00001520: 670a 2020 2020 2020 2020 2020 2020 6461  g.            da
-00001530: 7461 203d 2061 7761 6974 2072 6563 6569  ta = await recei
-00001540: 7665 5f6a 736f 6e28 7765 6273 6f63 6b65  ve_json(websocke
-00001550: 742c 206d 7367 5f74 7970 6573 3d5b 2263  t, msg_types=["c
-00001560: 656c 6c5f 7570 6461 7465 225d 290a 2020  ell_update"]).  
-00001570: 2020 2020 2020 2020 2020 6578 7065 6374            expect
-00001580: 6564 203d 207b 0a20 2020 2020 2020 2020  ed = {.         
-00001590: 2020 2020 2020 2022 6365 6c6c 5f75 7064         "cell_upd
-000015a0: 6174 6522 3a20 5b0a 2020 2020 2020 2020  ate": [.        
-000015b0: 2020 2020 2020 2020 2020 2020 7b0a 2020              {.  
-000015c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000015d0: 2020 2020 2020 2263 656c 6c5f 7479 7065        "cell_type
-000015e0: 223a 2022 636f 6465 222c 0a20 2020 2020  ": "code",.     
-000015f0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00001600: 2020 2022 6578 6563 7574 696f 6e5f 636f     "execution_co
-00001610: 756e 7422 3a20 312c 0a20 2020 2020 2020  unt": 1,.       
-00001620: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00001630: 2022 6d65 7461 6461 7461 223a 207b 0a20   "metadata": {. 
-00001640: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00001650: 2020 2020 2020 2020 2020 2022 6a75 7079             "jupy
-00001660: 7465 725f 6431 223a 207b 0a20 2020 2020  ter_d1": {.     
-00001670: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00001680: 2020 2020 2020 2020 2020 2022 706f 7369             "posi
-00001690: 7469 6f6e 223a 2032 2c0a 2020 2020 2020  tion": 2,.      
-000016a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000016b0: 2020 2020 2020 2020 2020 2275 7569 6422            "uuid"
-000016c0: 3a20 6365 6c6c 5f75 7569 642c 0a20 2020  : cell_uuid,.   
-000016d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000016e0: 2020 2020 2020 2020 2020 2020 2022 6e6f               "no
-000016f0: 7465 626f 6f6b 5f75 7569 6422 3a20 7575  tebook_uuid": uu
-00001700: 6964 2c0a 2020 2020 2020 2020 2020 2020  id,.            
-00001710: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00001720: 2020 2020 2265 7865 6375 7469 6f6e 5f73      "execution_s
-00001730: 7461 7465 223a 2022 6275 7379 222c 0a20  tate": "busy",. 
-00001740: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00001750: 2020 2020 2020 2020 2020 207d 0a20 2020             }.   
-00001760: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00001770: 2020 2020 207d 2c0a 2020 2020 2020 2020       },.        
-00001780: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00001790: 226f 7574 7075 7473 223a 205b 0a20 2020  "outputs": [.   
-000017a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000017b0: 2020 2020 2020 2020 207b 0a20 2020 2020           {.     
-000017c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000017d0: 2020 2020 2020 2020 2020 2022 6461 7461             "data
-000017e0: 223a 207b 2274 6578 742f 706c 6169 6e22  ": {"text/plain"
-000017f0: 3a20 2237 227d 2c0a 2020 2020 2020 2020  : "7"},.        
-00001800: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00001810: 2020 2020 2020 2020 2265 7865 6375 7469          "executi
-00001820: 6f6e 5f63 6f75 6e74 223a 2031 2c0a 2020  on_count": 1,.  
-00001830: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00001840: 2020 2020 2020 2020 2020 2020 2020 226d                "m
-00001850: 6574 6164 6174 6122 3a20 7b7d 2c0a 2020  etadata": {},.  
-00001860: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00001870: 2020 2020 2020 2020 2020 2020 2020 226f                "o
-00001880: 7574 7075 745f 7479 7065 223a 2022 6578  utput_type": "ex
-00001890: 6563 7574 655f 7265 7375 6c74 222c 0a20  ecute_result",. 
-000018a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000018b0: 2020 2020 2020 2020 2020 207d 0a20 2020             }.   
-000018c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000018d0: 2020 2020 205d 2c0a 2020 2020 2020 2020       ],.        
-000018e0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000018f0: 2273 6f75 7263 6522 3a20 2232 2b35 222c  "source": "2+5",
-00001900: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00001910: 2020 2020 207d 0a20 2020 2020 2020 2020       }.         
-00001920: 2020 2020 2020 205d 0a20 2020 2020 2020         ].       
-00001930: 2020 2020 207d 0a0a 2020 2020 2020 2020       }..        
-00001940: 2020 2020 2320 6672 6f6d 2070 7072 696e      # from pprin
-00001950: 7420 696d 706f 7274 2070 7072 696e 740a  t import pprint.
-00001960: 2020 2020 2020 2020 2020 2020 2320 7072              # pr
-00001970: 696e 7428 2264 6174 6122 290a 2020 2020  int("data").    
-00001980: 2020 2020 2020 2020 2320 7070 7269 6e74          # pprint
-00001990: 2864 6174 6129 0a20 2020 2020 2020 2020  (data).         
-000019a0: 2020 2023 2070 7269 6e74 2822 6578 7065     # print("expe
-000019b0: 6374 6564 2229 0a20 2020 2020 2020 2020  cted").         
-000019c0: 2020 2023 2070 7072 696e 7428 6578 7065     # pprint(expe
-000019d0: 6374 6564 290a 2020 2020 2020 2020 2020  cted).          
-000019e0: 2020 6173 7365 7274 2064 6174 6120 3d3d    assert data ==
-000019f0: 2065 7870 6563 7465 640a 0a20 2020 2020   expected..     
-00001a00: 2020 2020 2020 2023 2074 6869 7264 2063         # third c
-00001a10: 6875 6e6b 2072 6563 6569 7665 6420 7368  hunk received sh
-00001a20: 6f75 6c64 2062 6520 6120 6365 6c6c 5f75  ould be a cell_u
-00001a30: 7064 6174 6520 7769 7468 0a20 2020 2020  pdate with.     
-00001a40: 2020 2020 2020 2023 2061 6e20 6578 6563         # an exec
-00001a50: 7574 696f 6e5f 7374 6174 6520 6f66 2027  ution_state of '
-00001a60: 6964 6c65 2720 6265 6375 6173 6520 6974  idle' becuase it
-00001a70: 2773 2061 6c6c 2064 6f6e 650a 2020 2020  's all done.    
-00001a80: 2020 2020 2020 2020 6461 7461 203d 2061          data = a
-00001a90: 7761 6974 2072 6563 6569 7665 5f6a 736f  wait receive_jso
-00001aa0: 6e28 7765 6273 6f63 6b65 742c 206d 7367  n(websocket, msg
-00001ab0: 5f74 7970 6573 3d5b 2263 656c 6c5f 7570  _types=["cell_up
-00001ac0: 6461 7465 225d 290a 2020 2020 2020 2020  date"]).        
-00001ad0: 2020 2020 6431 5f6d 6574 6164 6174 6120      d1_metadata 
-00001ae0: 3d20 6461 7461 5b22 6365 6c6c 5f75 7064  = data["cell_upd
-00001af0: 6174 6522 5d5b 305d 5b22 6d65 7461 6461  ate"][0]["metada
-00001b00: 7461 225d 5b22 6a75 7079 7465 725f 6431  ta"]["jupyter_d1
-00001b10: 225d 0a20 2020 2020 2020 2020 2020 2061  "].            a
-00001b20: 7373 6572 7420 6431 5f6d 6574 6164 6174  ssert d1_metadat
-00001b30: 615b 2265 7865 6375 7469 6f6e 5f73 7461  a["execution_sta
-00001b40: 7465 225d 203d 3d20 2269 646c 6522 0a0a  te"] == "idle"..
-00001b50: 2020 2020 2020 2020 2020 2020 6461 7461              data
-00001b60: 203d 2061 7761 6974 2072 6563 6569 7665   = await receive
-00001b70: 5f6a 736f 6e28 7765 6273 6f63 6b65 742c  _json(websocket,
-00001b80: 206d 7367 5f74 7970 6573 3d5b 2276 6172   msg_types=["var
-00001b90: 7322 5d29 0a20 2020 2020 2020 2020 2020  s"]).           
-00001ba0: 2061 7373 6572 7420 6c65 6e28 6461 7461   assert len(data
-00001bb0: 5b22 7661 7273 225d 2920 3d3d 2031 340a  ["vars"]) == 14.
-00001bc0: 0a20 2020 2040 7079 7465 7374 2e6d 6172  .    @pytest.mar
-00001bd0: 6b2e 6173 796e 6369 6f0a 2020 2020 6173  k.asyncio.    as
-00001be0: 796e 6320 6465 6620 7465 7374 5f6e 6f74  ync def test_not
-00001bf0: 6562 6f6f 6b5f 7365 7175 656e 7469 616c  ebook_sequential
-00001c00: 5f65 7865 6375 7465 280a 2020 2020 2020  _execute(.      
-00001c10: 2020 7365 6c66 2c20 636c 6965 6e74 3a20    self, client: 
-00001c20: 5465 7374 436c 6965 6e74 2c20 7375 7065  TestClient, supe
-00001c30: 7275 7365 725f 746f 6b65 6e5f 6865 6164  ruser_token_head
-00001c40: 6572 733a 2044 6963 745b 7374 722c 2073  ers: Dict[str, s
-00001c50: 7472 5d0a 2020 2020 293a 0a20 2020 2020  tr].    ):.     
-00001c60: 2020 2075 7569 6420 3d20 6177 6169 7420     uuid = await 
-00001c70: 7570 6c6f 6164 5f6e 6f74 6562 6f6f 6b28  upload_notebook(
-00001c80: 636c 6965 6e74 2c20 7375 7065 7275 7365  client, superuse
-00001c90: 725f 746f 6b65 6e5f 6865 6164 6572 7329  r_token_headers)
-00001ca0: 0a0a 2020 2020 2020 2020 7265 7370 6f6e  ..        respon
-00001cb0: 7365 203d 2061 7761 6974 2063 6c69 656e  se = await clien
-00001cc0: 742e 6765 7428 0a20 2020 2020 2020 2020  t.get(.         
-00001cd0: 2020 2066 222f 6e6f 7465 626f 6f6b 732f     f"/notebooks/
-00001ce0: 7b75 7569 647d 2f63 656c 6c73 222c 2068  {uuid}/cells", h
-00001cf0: 6561 6465 7273 3d73 7570 6572 7573 6572  eaders=superuser
-00001d00: 5f74 6f6b 656e 5f68 6561 6465 7273 0a20  _token_headers. 
-00001d10: 2020 2020 2020 2029 0a20 2020 2020 2020         ).       
-00001d20: 2061 7373 6572 7420 7265 7370 6f6e 7365   assert response
-00001d30: 2e73 7461 7475 735f 636f 6465 203d 3d20  .status_code == 
-00001d40: 3230 300a 2020 2020 2020 2020 6365 6c6c  200.        cell
-00001d50: 7320 3d20 7265 7370 6f6e 7365 2e6a 736f  s = response.jso
-00001d60: 6e28 295b 2263 656c 6c73 225d 0a0a 2020  n()["cells"]..  
-00001d70: 2020 2020 2020 6365 6c6c 5f75 7569 6431        cell_uuid1
-00001d80: 203d 2063 656c 6c73 5b31 5d5b 226d 6574   = cells[1]["met
-00001d90: 6164 6174 6122 5d5b 226a 7570 7974 6572  adata"]["jupyter
-00001da0: 5f64 3122 5d5b 2275 7569 6422 5d0a 2020  _d1"]["uuid"].  
-00001db0: 2020 2020 2020 6365 6c6c 5f75 7569 6432        cell_uuid2
-00001dc0: 203d 2063 656c 6c73 5b32 5d5b 226d 6574   = cells[2]["met
-00001dd0: 6164 6174 6122 5d5b 226a 7570 7974 6572  adata"]["jupyter
-00001de0: 5f64 3122 5d5b 2275 7569 6422 5d0a 2020  _d1"]["uuid"].  
-00001df0: 2020 2020 2020 6365 6c6c 5f75 7569 6433        cell_uuid3
-00001e00: 203d 2063 656c 6c73 5b33 5d5b 226d 6574   = cells[3]["met
-00001e10: 6164 6174 6122 5d5b 226a 7570 7974 6572  adata"]["jupyter
-00001e20: 5f64 3122 5d5b 2275 7569 6422 5d0a 0a20  _d1"]["uuid"].. 
-00001e30: 2020 2020 2020 2063 6f64 6531 203d 2022         code1 = "
-00001e40: 2222 696d 706f 7274 2074 696d 653b 2074  ""import time; t
-00001e50: 696d 652e 736c 6565 7028 312e 3129 3b20  ime.sleep(1.1); 
-00001e60: 7072 696e 7428 2263 6865 636b 706f 696e  print("checkpoin
-00001e70: 7431 2229 2222 220a 2020 2020 2020 2020  t1")""".        
-00001e80: 636f 6465 3220 3d20 2222 2269 6d70 6f72  code2 = """impor
-00001e90: 7420 7469 6d65 3b20 7469 6d65 2e73 6c65  t time; time.sle
-00001ea0: 6570 2831 2e32 293b 2070 7269 6e74 2822  ep(1.2); print("
-00001eb0: 6368 6563 6b70 6f69 6e74 3222 2922 2222  checkpoint2")"""
-00001ec0: 0a20 2020 2020 2020 2063 6f64 6533 203d  .        code3 =
-00001ed0: 2022 2222 696d 706f 7274 2074 696d 653b   """import time;
-00001ee0: 2074 696d 652e 736c 6565 7028 312e 3329   time.sleep(1.3)
-00001ef0: 3b20 7072 696e 7428 2263 6865 636b 706f  ; print("checkpo
-00001f00: 696e 7433 2229 2222 220a 0a20 2020 2020  int3")"""..     
-00001f10: 2020 2070 6172 616d 7331 203d 207b 2273     params1 = {"s
-00001f20: 6f75 7263 6522 3a20 636f 6465 317d 0a20  ource": code1}. 
-00001f30: 2020 2020 2020 2070 6172 616d 7332 203d         params2 =
-00001f40: 207b 2273 6f75 7263 6522 3a20 636f 6465   {"source": code
-00001f50: 327d 0a20 2020 2020 2020 2070 6172 616d  2}.        param
-00001f60: 7333 203d 207b 2273 6f75 7263 6522 3a20  s3 = {"source": 
-00001f70: 636f 6465 337d 0a0a 2020 2020 2020 2020  code3}..        
-00001f80: 7265 7370 3120 3d20 6177 6169 7420 636c  resp1 = await cl
-00001f90: 6965 6e74 2e70 6174 6368 280a 2020 2020  ient.patch(.    
-00001fa0: 2020 2020 2020 2020 6622 2f6e 6f74 6562          f"/noteb
-00001fb0: 6f6f 6b73 2f7b 7575 6964 7d2f 6365 6c6c  ooks/{uuid}/cell
-00001fc0: 732f 7b63 656c 6c5f 7575 6964 317d 222c  s/{cell_uuid1}",
-00001fd0: 0a20 2020 2020 2020 2020 2020 206a 736f  .            jso
-00001fe0: 6e3d 7061 7261 6d73 312c 0a20 2020 2020  n=params1,.     
-00001ff0: 2020 2020 2020 2068 6561 6465 7273 3d73         headers=s
-00002000: 7570 6572 7573 6572 5f74 6f6b 656e 5f68  uperuser_token_h
-00002010: 6561 6465 7273 2c0a 2020 2020 2020 2020  eaders,.        
-00002020: 290a 2020 2020 2020 2020 6173 7365 7274  ).        assert
-00002030: 2072 6573 7031 2e73 7461 7475 735f 636f   resp1.status_co
-00002040: 6465 203d 3d20 3230 300a 0a20 2020 2020  de == 200..     
-00002050: 2020 2072 6573 7032 203d 2061 7761 6974     resp2 = await
-00002060: 2063 6c69 656e 742e 7061 7463 6828 0a20   client.patch(. 
-00002070: 2020 2020 2020 2020 2020 2066 222f 6e6f             f"/no
-00002080: 7465 626f 6f6b 732f 7b75 7569 647d 2f63  tebooks/{uuid}/c
-00002090: 656c 6c73 2f7b 6365 6c6c 5f75 7569 6432  ells/{cell_uuid2
-000020a0: 7d22 2c0a 2020 2020 2020 2020 2020 2020  }",.            
-000020b0: 6a73 6f6e 3d70 6172 616d 7332 2c0a 2020  json=params2,.  
-000020c0: 2020 2020 2020 2020 2020 6865 6164 6572            header
-000020d0: 733d 7375 7065 7275 7365 725f 746f 6b65  s=superuser_toke
-000020e0: 6e5f 6865 6164 6572 732c 0a20 2020 2020  n_headers,.     
-000020f0: 2020 2029 0a20 2020 2020 2020 2061 7373     ).        ass
-00002100: 6572 7420 7265 7370 322e 7374 6174 7573  ert resp2.status
-00002110: 5f63 6f64 6520 3d3d 2032 3030 0a0a 2020  _code == 200..  
-00002120: 2020 2020 2020 7265 7370 3320 3d20 6177        resp3 = aw
-00002130: 6169 7420 636c 6965 6e74 2e70 6174 6368  ait client.patch
-00002140: 280a 2020 2020 2020 2020 2020 2020 6622  (.            f"
-00002150: 2f6e 6f74 6562 6f6f 6b73 2f7b 7575 6964  /notebooks/{uuid
-00002160: 7d2f 6365 6c6c 732f 7b63 656c 6c5f 7575  }/cells/{cell_uu
-00002170: 6964 337d 222c 0a20 2020 2020 2020 2020  id3}",.         
-00002180: 2020 206a 736f 6e3d 7061 7261 6d73 332c     json=params3,
-00002190: 0a20 2020 2020 2020 2020 2020 2068 6561  .            hea
-000021a0: 6465 7273 3d73 7570 6572 7573 6572 5f74  ders=superuser_t
-000021b0: 6f6b 656e 5f68 6561 6465 7273 2c0a 2020  oken_headers,.  
-000021c0: 2020 2020 2020 290a 2020 2020 2020 2020        ).        
-000021d0: 6173 7365 7274 2072 6573 7033 2e73 7461  assert resp3.sta
-000021e0: 7475 735f 636f 6465 203d 3d20 3230 300a  tus_code == 200.
-000021f0: 0a20 2020 2020 2020 2061 7379 6e63 2077  .        async w
-00002200: 6974 6820 636c 6965 6e74 2e77 6562 736f  ith client.webso
-00002210: 636b 6574 5f63 6f6e 6e65 6374 280a 2020  cket_connect(.  
-00002220: 2020 2020 2020 2020 2020 6622 2f6e 6f74            f"/not
-00002230: 6562 6f6f 6b73 2f7b 7575 6964 7d2f 7773  ebooks/{uuid}/ws
-00002240: 2f6e 6f74 6562 6f6f 6b22 2c20 6865 6164  /notebook", head
-00002250: 6572 733d 7375 7065 7275 7365 725f 746f  ers=superuser_to
-00002260: 6b65 6e5f 6865 6164 6572 730a 2020 2020  ken_headers.    
-00002270: 2020 2020 2920 6173 2077 6562 736f 636b      ) as websock
-00002280: 6574 3a0a 2020 2020 2020 2020 2020 2020  et:.            
-00002290: 7061 7373 0a0a 2020 2020 2020 2020 2020  pass..          
-000022a0: 2020 2320 6177 6169 7420 6173 796e 6369    # await asynci
-000022b0: 6f2e 736c 6565 7028 5745 4253 4f43 4b45  o.sleep(WEBSOCKE
-000022c0: 545f 534c 4545 505f 5449 4d45 290a 2020  T_SLEEP_TIME).  
-000022d0: 2020 2020 2020 2020 2020 6177 6169 7420            await 
-000022e0: 6173 796e 6369 6f2e 736c 6565 7028 332e  asyncio.sleep(3.
-000022f0: 3529 0a0a 2020 2020 2020 2020 2020 2020  5)..            
-00002300: 7265 7370 6f6e 7365 203d 2061 7761 6974  response = await
-00002310: 2063 6c69 656e 742e 6765 7428 0a20 2020   client.get(.   
-00002320: 2020 2020 2020 2020 2020 2020 2066 222f               f"/
-00002330: 6e6f 7465 626f 6f6b 732f 7b75 7569 647d  notebooks/{uuid}
-00002340: 2f63 656c 6c73 2f7b 6365 6c6c 5f75 7569  /cells/{cell_uui
-00002350: 6431 7d2f 6578 6563 7574 6522 2c0a 2020  d1}/execute",.  
-00002360: 2020 2020 2020 2020 2020 2020 2020 6865                he
-00002370: 6164 6572 733d 7375 7065 7275 7365 725f  aders=superuser_
-00002380: 746f 6b65 6e5f 6865 6164 6572 732c 0a20  token_headers,. 
-00002390: 2020 2020 2020 2020 2020 2029 0a20 2020             ).   
-000023a0: 2020 2020 2020 2020 2061 7373 6572 7420           assert 
-000023b0: 7265 7370 6f6e 7365 2e73 7461 7475 735f  response.status_
-000023c0: 636f 6465 203d 3d20 3230 300a 2020 2020  code == 200.    
-000023d0: 2020 2020 2020 2020 7265 7370 6f6e 7365          response
-000023e0: 203d 2061 7761 6974 2063 6c69 656e 742e   = await client.
-000023f0: 6765 7428 0a20 2020 2020 2020 2020 2020  get(.           
-00002400: 2020 2020 2066 222f 6e6f 7465 626f 6f6b       f"/notebook
-00002410: 732f 7b75 7569 647d 2f63 656c 6c73 2f7b  s/{uuid}/cells/{
-00002420: 6365 6c6c 5f75 7569 6432 7d2f 6578 6563  cell_uuid2}/exec
-00002430: 7574 6522 2c0a 2020 2020 2020 2020 2020  ute",.          
-00002440: 2020 2020 2020 6865 6164 6572 733d 7375        headers=su
-00002450: 7065 7275 7365 725f 746f 6b65 6e5f 6865  peruser_token_he
-00002460: 6164 6572 732c 0a20 2020 2020 2020 2020  aders,.         
-00002470: 2020 2029 0a20 2020 2020 2020 2020 2020     ).           
-00002480: 2061 7373 6572 7420 7265 7370 6f6e 7365   assert response
-00002490: 2e73 7461 7475 735f 636f 6465 203d 3d20  .status_code == 
-000024a0: 3230 300a 2020 2020 2020 2020 2020 2020  200.            
-000024b0: 7265 7370 6f6e 7365 203d 2061 7761 6974  response = await
-000024c0: 2063 6c69 656e 742e 6765 7428 0a20 2020   client.get(.   
-000024d0: 2020 2020 2020 2020 2020 2020 2066 222f               f"/
-000024e0: 6e6f 7465 626f 6f6b 732f 7b75 7569 647d  notebooks/{uuid}
-000024f0: 2f63 656c 6c73 2f7b 6365 6c6c 5f75 7569  /cells/{cell_uui
-00002500: 6433 7d2f 6578 6563 7574 6522 2c0a 2020  d3}/execute",.  
-00002510: 2020 2020 2020 2020 2020 2020 2020 6865                he
-00002520: 6164 6572 733d 7375 7065 7275 7365 725f  aders=superuser_
-00002530: 746f 6b65 6e5f 6865 6164 6572 732c 0a20  token_headers,. 
-00002540: 2020 2020 2020 2020 2020 2029 0a20 2020             ).   
-00002550: 2020 2020 2020 2020 2061 7373 6572 7420           assert 
-00002560: 7265 7370 6f6e 7365 2e73 7461 7475 735f  response.status_
-00002570: 636f 6465 203d 3d20 3230 300a 0a20 2020  code == 200..   
-00002580: 2020 2020 2020 2020 2023 204d 6573 7361           # Messa
-00002590: 6765 7320 6f6e 2074 6865 2077 6562 2073  ges on the web s
-000025a0: 6f63 6b65 7420 6361 6e20 6172 7269 7665  ocket can arrive
-000025b0: 2069 6e20 6120 736c 6967 6874 6c79 2064   in a slightly d
-000025c0: 6966 6665 7265 6e74 0a20 2020 2020 2020  ifferent.       
-000025d0: 2020 2020 2023 206f 7264 6572 2066 726f       # order fro
-000025e0: 6d20 7275 6e20 746f 2072 756e 2e20 2054  m run to run.  T
-000025f0: 6865 2027 6365 6c6c 5f75 7064 6174 6527  he 'cell_update'
-00002600: 206d 6573 7361 6765 7320 6172 7269 7665   messages arrive
-00002610: 2061 7272 6f75 6e64 0a20 2020 2020 2020   arround.       
-00002620: 2020 2020 2023 2074 6865 2073 616d 6520       # the same 
-00002630: 7469 6d65 2061 7320 736f 6d65 206f 6620  time as some of 
-00002640: 7468 6520 6365 6c6c 5f65 7865 6375 7469  the cell_executi
-00002650: 6f6e 206d 6573 7361 6765 732e 2020 4974  on messages.  It
-00002660: 2064 6f65 736e 2774 0a20 2020 2020 2020   doesn't.       
-00002670: 2020 2020 2023 2072 6561 6c6c 7920 6d61       # really ma
-00002680: 7474 6572 2c20 6275 7420 6974 206d 616b  tter, but it mak
-00002690: 6573 2074 6573 7469 6e67 2074 7269 636b  es testing trick
-000026a0: 792e 2020 466f 7220 6120 7374 6162 6c65  y.  For a stable
-000026b0: 2074 6573 742c 0a20 2020 2020 2020 2020   test,.         
-000026c0: 2020 2023 2067 6174 6865 7220 616c 6c20     # gather all 
-000026d0: 7468 6520 7265 7370 6f6e 7365 7320 616e  the responses an
-000026e0: 6420 7370 6c69 7420 7468 656d 2069 6e74  d split them int
-000026f0: 6f20 7477 6f20 6c69 7374 732c 206f 6e65  o two lists, one
-00002700: 2066 6f72 0a20 2020 2020 2020 2020 2020   for.           
-00002710: 2023 2063 656c 6c5f 7570 6461 7465 206d   # cell_update m
-00002720: 6573 7361 6765 7320 616e 6420 6f6e 6520  essages and one 
-00002730: 666f 7220 616c 6c20 7468 6520 6f74 6865  for all the othe
-00002740: 7273 2e0a 0a20 2020 2020 2020 2020 2020  rs...           
-00002750: 2023 2054 6865 206d 6f73 7420 696d 706f   # The most impo
-00002760: 7274 616e 7420 7468 696e 6720 666f 7220  rtant thing for 
-00002770: 7468 6973 2074 6573 7420 6973 2074 6861  this test is tha
-00002780: 7420 616c 6c20 7468 650a 2020 2020 2020  t all the.      
-00002790: 2020 2020 2020 2320 2263 656c 6c5f 6578        # "cell_ex
-000027a0: 6563 7574 696f 6e5f 7265 7175 6573 7422  ecution_request"
-000027b0: 206d 6573 7361 6765 7320 6172 7269 7665   messages arrive
-000027c0: 2066 6972 7374 2061 7320 7468 6520 6365   first as the ce
-000027d0: 6c6c 7320 6172 650a 2020 2020 2020 2020  lls are.        
-000027e0: 2020 2020 2320 7175 6575 6564 2066 6f72      # queued for
-000027f0: 2065 7865 6375 7469 6f6e 2061 6e64 2074   execution and t
-00002800: 6865 2022 6365 6c6c 5f65 7865 6375 7469  he "cell_executi
-00002810: 6f6e 5f69 6e70 7574 222c 0a20 2020 2020  on_input",.     
-00002820: 2020 2020 2020 2023 2022 6365 6c6c 5f65         # "cell_e
-00002830: 7865 6375 7469 6f6e 5f72 6570 6c79 222c  xecution_reply",
-00002840: 2065 7463 206d 6573 7361 6765 7320 7368   etc messages sh
-00002850: 6f77 2075 7020 6c61 7465 7220 6173 2074  ow up later as t
-00002860: 6865 2063 656c 6c73 0a20 2020 2020 2020  he cells.       
-00002870: 2020 2020 2023 2061 7265 2070 726f 6365       # are proce
-00002880: 7373 6564 2e0a 0a20 2020 2020 2020 2020  ssed...         
-00002890: 2020 2063 656c 6c5f 7570 6461 7465 5f6d     cell_update_m
-000028a0: 7367 7320 3d20 5b5d 0a20 2020 2020 2020  sgs = [].       
-000028b0: 2020 2020 206e 6f6e 5f63 656c 6c5f 7570       non_cell_up
-000028c0: 6461 7465 5f6d 7367 7320 3d20 5b5d 0a20  date_msgs = []. 
-000028d0: 2020 2020 2020 2020 2020 2066 6f72 2069             for i
-000028e0: 2069 6e20 7261 6e67 6528 3139 293a 0a20   in range(19):. 
-000028f0: 2020 2020 2020 2020 2020 2020 2020 2064                 d
-00002900: 6174 6120 3d20 6177 6169 7420 7265 6365  ata = await rece
-00002910: 6976 655f 6a73 6f6e 2877 6562 736f 636b  ive_json(websock
-00002920: 6574 290a 2020 2020 2020 2020 2020 2020  et).            
-00002930: 2020 2020 6966 2022 6365 6c6c 5f75 7064      if "cell_upd
-00002940: 6174 6522 2069 6e20 6461 7461 2e6b 6579  ate" in data.key
-00002950: 7328 293a 0a20 2020 2020 2020 2020 2020  s():.           
-00002960: 2020 2020 2020 2020 2063 656c 6c5f 7570           cell_up
-00002970: 6461 7465 5f6d 7367 732e 6170 7065 6e64  date_msgs.append
-00002980: 2864 6174 6129 0a20 2020 2020 2020 2020  (data).         
-00002990: 2020 2020 2020 2065 6c73 653a 0a20 2020         else:.   
-000029a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000029b0: 206e 6f6e 5f63 656c 6c5f 7570 6461 7465   non_cell_update
-000029c0: 5f6d 7367 732e 6170 7065 6e64 2864 6174  _msgs.append(dat
-000029d0: 6129 0a0a 2020 2020 2020 2020 2020 2020  a)..            
-000029e0: 2320 7368 6f75 6c64 2067 6574 2074 6872  # should get thr
-000029f0: 6565 2065 7865 6375 7469 6f6e 2072 6571  ee execution req
-00002a00: 7565 7374 730a 2020 2020 2020 2020 2020  uests.          
-00002a10: 2020 6461 7461 203d 206e 6f6e 5f63 656c    data = non_cel
-00002a20: 6c5f 7570 6461 7465 5f6d 7367 732e 706f  l_update_msgs.po
-00002a30: 7028 3029 0a20 2020 2020 2020 2020 2020  p(0).           
-00002a40: 2061 7373 6572 7420 2263 656c 6c5f 6578   assert "cell_ex
-00002a50: 6563 7574 696f 6e5f 7265 7175 6573 7422  ecution_request"
-00002a60: 2069 6e20 6461 7461 2e6b 6579 7328 290a   in data.keys().
-00002a70: 2020 2020 2020 2020 2020 2020 6d73 675f              msg_
-00002a80: 6964 3120 3d20 6461 7461 5b22 6365 6c6c  id1 = data["cell
-00002a90: 5f65 7865 6375 7469 6f6e 5f72 6571 7565  _execution_reque
-00002aa0: 7374 225d 5b22 6d65 7373 6167 655f 6964  st"]["message_id
-00002ab0: 225d 0a20 2020 2020 2020 2020 2020 2061  "].            a
-00002ac0: 7373 6572 7420 6c65 6e28 6d73 675f 6964  ssert len(msg_id
-00002ad0: 3129 2069 6e20 6d73 675f 6964 5f6c 656e  1) in msg_id_len
-00002ae0: 6774 6873 0a0a 2020 2020 2020 2020 2020  gths..          
-00002af0: 2020 6461 7461 203d 206e 6f6e 5f63 656c    data = non_cel
-00002b00: 6c5f 7570 6461 7465 5f6d 7367 732e 706f  l_update_msgs.po
-00002b10: 7028 3029 0a20 2020 2020 2020 2020 2020  p(0).           
-00002b20: 2061 7373 6572 7420 2263 656c 6c5f 6578   assert "cell_ex
-00002b30: 6563 7574 696f 6e5f 7265 7175 6573 7422  ecution_request"
-00002b40: 2069 6e20 6461 7461 2e6b 6579 7328 290a   in data.keys().
-00002b50: 2020 2020 2020 2020 2020 2020 6d73 675f              msg_
-00002b60: 6964 3220 3d20 6461 7461 5b22 6365 6c6c  id2 = data["cell
-00002b70: 5f65 7865 6375 7469 6f6e 5f72 6571 7565  _execution_reque
-00002b80: 7374 225d 5b22 6d65 7373 6167 655f 6964  st"]["message_id
-00002b90: 225d 0a20 2020 2020 2020 2020 2020 2061  "].            a
-00002ba0: 7373 6572 7420 6c65 6e28 6d73 675f 6964  ssert len(msg_id
-00002bb0: 3229 2069 6e20 6d73 675f 6964 5f6c 656e  2) in msg_id_len
-00002bc0: 6774 6873 0a0a 2020 2020 2020 2020 2020  gths..          
-00002bd0: 2020 6461 7461 203d 206e 6f6e 5f63 656c    data = non_cel
-00002be0: 6c5f 7570 6461 7465 5f6d 7367 732e 706f  l_update_msgs.po
-00002bf0: 7028 3029 0a20 2020 2020 2020 2020 2020  p(0).           
-00002c00: 2061 7373 6572 7420 2263 656c 6c5f 6578   assert "cell_ex
-00002c10: 6563 7574 696f 6e5f 7265 7175 6573 7422  ecution_request"
-00002c20: 2069 6e20 6461 7461 2e6b 6579 7328 290a   in data.keys().
-00002c30: 2020 2020 2020 2020 2020 2020 6d73 675f              msg_
-00002c40: 6964 3320 3d20 6461 7461 5b22 6365 6c6c  id3 = data["cell
-00002c50: 5f65 7865 6375 7469 6f6e 5f72 6571 7565  _execution_reque
-00002c60: 7374 225d 5b22 6d65 7373 6167 655f 6964  st"]["message_id
-00002c70: 225d 0a20 2020 2020 2020 2020 2020 2061  "].            a
-00002c80: 7373 6572 7420 6c65 6e28 6d73 675f 6964  ssert len(msg_id
-00002c90: 3329 2069 6e20 6d73 675f 6964 5f6c 656e  3) in msg_id_len
-00002ca0: 6774 6873 0a0a 2020 2020 2020 2020 2020  gths..          
-00002cb0: 2020 2320 6365 6c6c 2075 7064 6174 6520    # cell update 
-00002cc0: 666f 7220 7468 6520 6669 7273 7420 6578  for the first ex
-00002cd0: 6563 7574 696e 6720 6365 6c6c 0a20 2020  ecuting cell.   
-00002ce0: 2020 2020 2020 2020 2064 6174 6120 3d20           data = 
-00002cf0: 6365 6c6c 5f75 7064 6174 655f 6d73 6773  cell_update_msgs
-00002d00: 2e70 6f70 2830 290a 2020 2020 2020 2020  .pop(0).        
-00002d10: 2020 2020 6173 7365 7274 2022 6365 6c6c      assert "cell
-00002d20: 5f75 7064 6174 6522 2069 6e20 6461 7461  _update" in data
-00002d30: 2e6b 6579 7328 290a 2020 2020 2020 2020  .keys().        
-00002d40: 2020 2020 6173 7365 7274 2028 0a20 2020      assert (.   
-00002d50: 2020 2020 2020 2020 2020 2020 2064 6174               dat
-00002d60: 615b 2263 656c 6c5f 7570 6461 7465 225d  a["cell_update"]
-00002d70: 5b30 5d5b 226d 6574 6164 6174 6122 5d5b  [0]["metadata"][
-00002d80: 226a 7570 7974 6572 5f64 3122 5d5b 2275  "jupyter_d1"]["u
-00002d90: 7569 6422 5d0a 2020 2020 2020 2020 2020  uid"].          
-00002da0: 2020 2020 2020 3d3d 2063 656c 6c5f 7575        == cell_uu
-00002db0: 6964 310a 2020 2020 2020 2020 2020 2020  id1.            
-00002dc0: 290a 0a20 2020 2020 2020 2020 2020 2023  )..            #
-00002dd0: 2063 656c 6c5f 6578 6563 7574 696f 6e5f   cell_execution_
-00002de0: 696e 7075 7420 666f 7220 7468 6520 6669  input for the fi
-00002df0: 7273 7420 6365 6c6c 2773 2063 6f64 6520  rst cell's code 
-00002e00: 6265 696e 6720 6578 6563 7574 6564 0a20  being executed. 
-00002e10: 2020 2020 2020 2020 2020 2064 6174 6120             data 
-00002e20: 3d20 6e6f 6e5f 6365 6c6c 5f75 7064 6174  = non_cell_updat
-00002e30: 655f 6d73 6773 2e70 6f70 2830 290a 2020  e_msgs.pop(0).  
-00002e40: 2020 2020 2020 2020 2020 6173 7365 7274            assert
-00002e50: 2022 6365 6c6c 5f65 7865 6375 7469 6f6e   "cell_execution
-00002e60: 5f69 6e70 7574 2220 696e 2064 6174 610a  _input" in data.
-00002e70: 2020 2020 2020 2020 2020 2020 6173 7365              asse
-00002e80: 7274 2028 0a20 2020 2020 2020 2020 2020  rt (.           
-00002e90: 2020 2020 2064 6174 615b 2263 656c 6c5f       data["cell_
-00002ea0: 6578 6563 7574 696f 6e5f 696e 7075 7422  execution_input"
-00002eb0: 5d5b 2263 6f6e 7465 6e74 225d 5b22 636f  ]["content"]["co
-00002ec0: 6465 225d 203d 3d20 636f 6465 310a 2020  de"] == code1.  
-00002ed0: 2020 2020 2020 2020 2020 292c 2066 2746            ), f'F
-00002ee0: 6169 6c65 6420 746f 2066 696e 6420 227b  ailed to find "{
-00002ef0: 636f 6465 317d 2220 696e 2063 656c 6c5f  code1}" in cell_
-00002f00: 7374 7265 616d 2064 6174 613a 207b 6461  stream data: {da
-00002f10: 7461 7d27 0a20 2020 2020 2020 2020 2020  ta}'.           
-00002f20: 2061 7373 6572 7420 280a 2020 2020 2020   assert (.      
-00002f30: 2020 2020 2020 2020 2020 6461 7461 5b22            data["
-00002f40: 6365 6c6c 5f65 7865 6375 7469 6f6e 5f69  cell_execution_i
-00002f50: 6e70 7574 225d 5b22 7061 7265 6e74 5f69  nput"]["parent_i
-00002f60: 6422 5d20 3d3d 206d 7367 5f69 6431 0a20  d"] == msg_id1. 
-00002f70: 2020 2020 2020 2020 2020 2029 2c20 6622             ), f"
-00002f80: 4661 696c 6564 2074 6f20 6669 6e64 2065  Failed to find e
-00002f90: 7870 6563 7465 6420 7061 7265 6e74 5f69  xpected parent_i
-00002fa0: 6422 0a0a 2020 2020 2020 2020 2020 2020  d"..            
-00002fb0: 2320 7374 7265 616d 206f 7574 7075 7420  # stream output 
-00002fc0: 666f 7220 7468 6520 6669 7273 7420 6365  for the first ce
-00002fd0: 6c6c 2773 2065 7865 6375 7469 6f6e 0a20  ll's execution. 
-00002fe0: 2020 2020 2020 2020 2020 2064 6174 6120             data 
-00002ff0: 3d20 6e6f 6e5f 6365 6c6c 5f75 7064 6174  = non_cell_updat
-00003000: 655f 6d73 6773 2e70 6f70 2830 290a 2020  e_msgs.pop(0).  
-00003010: 2020 2020 2020 2020 2020 6173 7365 7274            assert
-00003020: 2022 6365 6c6c 5f73 7472 6561 6d22 2069   "cell_stream" i
-00003030: 6e20 6461 7461 2e6b 6579 7328 290a 2020  n data.keys().  
-00003040: 2020 2020 2020 2020 2020 6173 7365 7274            assert
-00003050: 2028 0a20 2020 2020 2020 2020 2020 2020   (.             
-00003060: 2020 2064 6174 615b 2263 656c 6c5f 7374     data["cell_st
-00003070: 7265 616d 225d 5b22 6f75 7470 7574 225d  ream"]["output"]
-00003080: 5b22 7465 7874 225d 203d 3d20 2263 6865  ["text"] == "che
-00003090: 636b 706f 696e 7431 5c6e 220a 2020 2020  ckpoint1\n".    
-000030a0: 2020 2020 2020 2020 292c 2066 2246 6169          ), f"Fai
-000030b0: 6c65 6420 746f 2066 696e 6420 6368 6563  led to find chec
-000030c0: 6b70 6f69 6e74 3120 696e 2063 656c 6c5f  kpoint1 in cell_
-000030d0: 7374 7265 616d 2064 6174 613a 207b 6461  stream data: {da
-000030e0: 7461 7d22 0a0a 2020 2020 2020 2020 2020  ta}"..          
-000030f0: 2020 2320 6578 6563 7574 696f 6e5f 7265    # execution_re
-00003100: 706c 7920 666f 7220 7468 6520 656e 6420  ply for the end 
-00003110: 6f66 2074 6865 2066 6972 7374 2063 656c  of the first cel
-00003120: 6c27 7320 6578 6563 7574 696f 6e0a 2020  l's execution.  
-00003130: 2020 2020 2020 2020 2020 6461 7461 203d            data =
-00003140: 206e 6f6e 5f63 656c 6c5f 7570 6461 7465   non_cell_update
-00003150: 5f6d 7367 732e 706f 7028 3029 0a20 2020  _msgs.pop(0).   
-00003160: 2020 2020 2020 2020 2061 7373 6572 7420           assert 
-00003170: 2263 656c 6c5f 6578 6563 7574 696f 6e5f  "cell_execution_
-00003180: 7265 706c 7922 2069 6e20 6461 7461 2e6b  reply" in data.k
-00003190: 6579 7328 290a 2020 2020 2020 2020 2020  eys().          
-000031a0: 2020 6173 7365 7274 2064 6174 615b 2263    assert data["c
-000031b0: 656c 6c5f 6578 6563 7574 696f 6e5f 7265  ell_execution_re
-000031c0: 706c 7922 5d5b 2270 6172 656e 745f 6964  ply"]["parent_id
-000031d0: 225d 203d 3d20 6d73 675f 6964 310a 0a20  "] == msg_id1.. 
-000031e0: 2020 2020 2020 2020 2020 2023 2063 656c             # cel
-000031f0: 6c20 7570 6461 7465 2077 6974 6820 7468  l update with th
-00003200: 6520 7265 7375 6c74 7320 6f66 2074 6865  e results of the
-00003210: 2066 6972 7374 2063 656c 6c27 7320 6578   first cell's ex
-00003220: 6563 7574 696f 6e0a 2020 2020 2020 2020  ecution.        
-00003230: 2020 2020 6461 7461 203d 2063 656c 6c5f      data = cell_
-00003240: 7570 6461 7465 5f6d 7367 732e 706f 7028  update_msgs.pop(
-00003250: 3029 0a20 2020 2020 2020 2020 2020 2061  0).            a
-00003260: 7373 6572 7420 2263 656c 6c5f 7570 6461  ssert "cell_upda
-00003270: 7465 2220 696e 2064 6174 612e 6b65 7973  te" in data.keys
-00003280: 2829 0a20 2020 2020 2020 2020 2020 2061  ().            a
-00003290: 7373 6572 7420 280a 2020 2020 2020 2020  ssert (.        
-000032a0: 2020 2020 2020 2020 6461 7461 5b22 6365          data["ce
-000032b0: 6c6c 5f75 7064 6174 6522 5d5b 305d 5b22  ll_update"][0]["
-000032c0: 6d65 7461 6461 7461 225d 5b22 6a75 7079  metadata"]["jupy
-000032d0: 7465 725f 6431 225d 5b22 7575 6964 225d  ter_d1"]["uuid"]
-000032e0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-000032f0: 203d 3d20 6365 6c6c 5f75 7569 6431 0a20   == cell_uuid1. 
-00003300: 2020 2020 2020 2020 2020 2029 0a0a 2020             )..  
-00003310: 2020 2020 2020 2020 2020 2320 6365 6c6c            # cell
-00003320: 2075 7064 6174 6520 666f 7220 7468 6520   update for the 
-00003330: 6265 6769 6e69 6e67 206f 6620 7468 6520  begining of the 
-00003340: 7365 636f 6e64 2063 656c 6c27 7320 6578  second cell's ex
-00003350: 6563 7574 696f 6e0a 2020 2020 2020 2020  ecution.        
-00003360: 2020 2020 6461 7461 203d 2063 656c 6c5f      data = cell_
-00003370: 7570 6461 7465 5f6d 7367 732e 706f 7028  update_msgs.pop(
-00003380: 3029 0a20 2020 2020 2020 2020 2020 2061  0).            a
-00003390: 7373 6572 7420 2263 656c 6c5f 7570 6461  ssert "cell_upda
-000033a0: 7465 2220 696e 2064 6174 612e 6b65 7973  te" in data.keys
-000033b0: 2829 0a20 2020 2020 2020 2020 2020 2061  ().            a
-000033c0: 7373 6572 7420 280a 2020 2020 2020 2020  ssert (.        
-000033d0: 2020 2020 2020 2020 6461 7461 5b22 6365          data["ce
-000033e0: 6c6c 5f75 7064 6174 6522 5d5b 305d 5b22  ll_update"][0]["
-000033f0: 6d65 7461 6461 7461 225d 5b22 6a75 7079  metadata"]["jupy
-00003400: 7465 725f 6431 225d 5b22 7575 6964 225d  ter_d1"]["uuid"]
-00003410: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00003420: 203d 3d20 6365 6c6c 5f75 7569 6432 0a20   == cell_uuid2. 
-00003430: 2020 2020 2020 2020 2020 2029 0a0a 2020             )..  
-00003440: 2020 2020 2020 2020 2020 2320 6365 6c6c            # cell
-00003450: 5f69 6e70 7574 2075 7064 6174 6520 7769  _input update wi
-00003460: 7468 2074 6865 2073 6563 6f6e 6420 6365  th the second ce
-00003470: 6c6c 2773 2063 6f64 6520 6265 696e 6720  ll's code being 
-00003480: 6578 6563 7574 6564 0a20 2020 2020 2020  executed.       
-00003490: 2020 2020 2064 6174 6120 3d20 6e6f 6e5f       data = non_
-000034a0: 6365 6c6c 5f75 7064 6174 655f 6d73 6773  cell_update_msgs
-000034b0: 2e70 6f70 2830 290a 2020 2020 2020 2020  .pop(0).        
-000034c0: 2020 2020 6173 7365 7274 2022 6365 6c6c      assert "cell
-000034d0: 5f65 7865 6375 7469 6f6e 5f69 6e70 7574  _execution_input
-000034e0: 2220 696e 2064 6174 610a 2020 2020 2020  " in data.      
-000034f0: 2020 2020 2020 6173 7365 7274 2028 0a20        assert (. 
-00003500: 2020 2020 2020 2020 2020 2020 2020 2064                 d
-00003510: 6174 615b 2263 656c 6c5f 6578 6563 7574  ata["cell_execut
-00003520: 696f 6e5f 696e 7075 7422 5d5b 2263 6f6e  ion_input"]["con
-00003530: 7465 6e74 225d 5b22 636f 6465 225d 203d  tent"]["code"] =
-00003540: 3d20 636f 6465 320a 2020 2020 2020 2020  = code2.        
-00003550: 2020 2020 292c 2066 2746 6169 6c65 6420      ), f'Failed 
-00003560: 746f 2066 696e 6420 227b 636f 6465 327d  to find "{code2}
-00003570: 2220 696e 2063 656c 6c5f 7374 7265 616d  " in cell_stream
-00003580: 2064 6174 613a 207b 6461 7461 7d27 0a20   data: {data}'. 
-00003590: 2020 2020 2020 2020 2020 2061 7373 6572             asser
-000035a0: 7420 280a 2020 2020 2020 2020 2020 2020  t (.            
-000035b0: 2020 2020 6461 7461 5b22 6365 6c6c 5f65      data["cell_e
-000035c0: 7865 6375 7469 6f6e 5f69 6e70 7574 225d  xecution_input"]
-000035d0: 5b22 7061 7265 6e74 5f69 6422 5d20 3d3d  ["parent_id"] ==
-000035e0: 206d 7367 5f69 6432 0a20 2020 2020 2020   msg_id2.       
-000035f0: 2020 2020 2029 2c20 6622 4661 696c 6564       ), f"Failed
-00003600: 2074 6f20 6669 6e64 2065 7870 6563 7465   to find expecte
-00003610: 6420 7061 7265 6e74 5f69 6422 0a0a 2020  d parent_id"..  
-00003620: 2020 2020 2020 2020 2020 2320 7374 7265            # stre
-00003630: 616d 206f 7574 7075 7420 6f66 2074 6865  am output of the
-00003640: 2073 6563 6f6e 6420 6365 6c6c 2773 2065   second cell's e
-00003650: 7865 6375 7469 6f6e 0a20 2020 2020 2020  xecution.       
-00003660: 2020 2020 2064 6174 6120 3d20 6e6f 6e5f       data = non_
-00003670: 6365 6c6c 5f75 7064 6174 655f 6d73 6773  cell_update_msgs
-00003680: 2e70 6f70 2830 290a 2020 2020 2020 2020  .pop(0).        
-00003690: 2020 2020 6173 7365 7274 2022 6365 6c6c      assert "cell
-000036a0: 5f73 7472 6561 6d22 2069 6e20 6461 7461  _stream" in data
-000036b0: 2e6b 6579 7328 290a 2020 2020 2020 2020  .keys().        
-000036c0: 2020 2020 6173 7365 7274 2028 0a20 2020      assert (.   
-000036d0: 2020 2020 2020 2020 2020 2020 2064 6174               dat
-000036e0: 615b 2263 656c 6c5f 7374 7265 616d 225d  a["cell_stream"]
-000036f0: 5b22 6f75 7470 7574 225d 5b22 7465 7874  ["output"]["text
-00003700: 225d 203d 3d20 2263 6865 636b 706f 696e  "] == "checkpoin
-00003710: 7432 5c6e 220a 2020 2020 2020 2020 2020  t2\n".          
-00003720: 2020 292c 2066 2246 6169 6c65 6420 746f    ), f"Failed to
-00003730: 2066 696e 6420 6368 6563 6b70 6f69 6e74   find checkpoint
-00003740: 3220 696e 2063 656c 6c5f 7374 7265 616d  2 in cell_stream
-00003750: 2064 6174 613a 207b 6461 7461 7d22 0a0a   data: {data}"..
-00003760: 2020 2020 2020 2020 2020 2020 2320 6578              # ex
-00003770: 6563 7475 696f 6e5f 7265 706c 7920 666f  ectuion_reply fo
-00003780: 7220 7468 6520 656e 6420 6f66 2074 6865  r the end of the
-00003790: 2073 6563 6f6e 6420 6365 6c6c 2773 2065   second cell's e
-000037a0: 7865 6375 7469 6f6e 0a20 2020 2020 2020  xecution.       
-000037b0: 2020 2020 2064 6174 6120 3d20 6e6f 6e5f       data = non_
-000037c0: 6365 6c6c 5f75 7064 6174 655f 6d73 6773  cell_update_msgs
-000037d0: 2e70 6f70 2830 290a 2020 2020 2020 2020  .pop(0).        
-000037e0: 2020 2020 6173 7365 7274 2022 6365 6c6c      assert "cell
-000037f0: 5f65 7865 6375 7469 6f6e 5f72 6570 6c79  _execution_reply
-00003800: 2220 696e 2064 6174 612e 6b65 7973 2829  " in data.keys()
-00003810: 0a20 2020 2020 2020 2020 2020 2061 7373  .            ass
-00003820: 6572 7420 6461 7461 5b22 6365 6c6c 5f65  ert data["cell_e
-00003830: 7865 6375 7469 6f6e 5f72 6570 6c79 225d  xecution_reply"]
-00003840: 5b22 7061 7265 6e74 5f69 6422 5d20 3d3d  ["parent_id"] ==
-00003850: 206d 7367 5f69 6432 0a0a 2020 2020 2020   msg_id2..      
-00003860: 2020 2020 2020 2320 6365 6c6c 5f75 7064        # cell_upd
-00003870: 6174 6520 7769 7468 2074 6865 2072 6573  ate with the res
-00003880: 756c 7473 206f 6620 7468 6520 7365 636f  ults of the seco
-00003890: 6e64 2063 656c 6c0a 2020 2020 2020 2020  nd cell.        
-000038a0: 2020 2020 6461 7461 203d 2063 656c 6c5f      data = cell_
-000038b0: 7570 6461 7465 5f6d 7367 732e 706f 7028  update_msgs.pop(
-000038c0: 3029 0a20 2020 2020 2020 2020 2020 2061  0).            a
-000038d0: 7373 6572 7420 2263 656c 6c5f 7570 6461  ssert "cell_upda
-000038e0: 7465 2220 696e 2064 6174 612e 6b65 7973  te" in data.keys
-000038f0: 2829 0a20 2020 2020 2020 2020 2020 2061  ().            a
-00003900: 7373 6572 7420 280a 2020 2020 2020 2020  ssert (.        
-00003910: 2020 2020 2020 2020 6461 7461 5b22 6365          data["ce
-00003920: 6c6c 5f75 7064 6174 6522 5d5b 305d 5b22  ll_update"][0]["
-00003930: 6d65 7461 6461 7461 225d 5b22 6a75 7079  metadata"]["jupy
-00003940: 7465 725f 6431 225d 5b22 7575 6964 225d  ter_d1"]["uuid"]
-00003950: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00003960: 203d 3d20 6365 6c6c 5f75 7569 6432 0a20   == cell_uuid2. 
-00003970: 2020 2020 2020 2020 2020 2029 0a0a 2020             )..  
-00003980: 2020 2020 2020 2020 2020 2320 6365 6c6c            # cell
-00003990: 5f75 7064 6174 6520 6173 2074 6865 2074  _update as the t
-000039a0: 6869 7264 2063 656c 6c20 6265 6769 6e73  hird cell begins
-000039b0: 2065 7865 6375 7469 6f6e 0a20 2020 2020   execution.     
-000039c0: 2020 2020 2020 2064 6174 6120 3d20 6365         data = ce
-000039d0: 6c6c 5f75 7064 6174 655f 6d73 6773 2e70  ll_update_msgs.p
-000039e0: 6f70 2830 290a 2020 2020 2020 2020 2020  op(0).          
-000039f0: 2020 6173 7365 7274 2022 6365 6c6c 5f75    assert "cell_u
-00003a00: 7064 6174 6522 2069 6e20 6461 7461 2e6b  pdate" in data.k
-00003a10: 6579 7328 290a 2020 2020 2020 2020 2020  eys().          
-00003a20: 2020 6173 7365 7274 2028 0a20 2020 2020    assert (.     
-00003a30: 2020 2020 2020 2020 2020 2064 6174 615b             data[
-00003a40: 2263 656c 6c5f 7570 6461 7465 225d 5b30  "cell_update"][0
-00003a50: 5d5b 226d 6574 6164 6174 6122 5d5b 226a  ]["metadata"]["j
-00003a60: 7570 7974 6572 5f64 3122 5d5b 2275 7569  upyter_d1"]["uui
-00003a70: 6422 5d0a 2020 2020 2020 2020 2020 2020  d"].            
-00003a80: 2020 2020 3d3d 2063 656c 6c5f 7575 6964      == cell_uuid
-00003a90: 330a 2020 2020 2020 2020 2020 2020 290a  3.            ).
-00003aa0: 0a20 2020 2020 2020 2020 2020 2023 2063  .            # c
-00003ab0: 656c 6c5f 6578 6563 7574 696f 6e5f 696e  ell_execution_in
-00003ac0: 7075 7420 7769 7468 2074 6869 7264 2063  put with third c
-00003ad0: 656c 6c20 636f 6465 2061 626f 7574 2074  ell code about t
-00003ae0: 6f20 6265 2065 7865 6375 7465 640a 2020  o be executed.  
-00003af0: 2020 2020 2020 2020 2020 6461 7461 203d            data =
-00003b00: 206e 6f6e 5f63 656c 6c5f 7570 6461 7465   non_cell_update
-00003b10: 5f6d 7367 732e 706f 7028 3029 0a20 2020  _msgs.pop(0).   
-00003b20: 2020 2020 2020 2020 2061 7373 6572 7420           assert 
-00003b30: 2263 656c 6c5f 6578 6563 7574 696f 6e5f  "cell_execution_
-00003b40: 696e 7075 7422 2069 6e20 6461 7461 0a20  input" in data. 
-00003b50: 2020 2020 2020 2020 2020 2061 7373 6572             asser
-00003b60: 7420 280a 2020 2020 2020 2020 2020 2020  t (.            
-00003b70: 2020 2020 6461 7461 5b22 6365 6c6c 5f65      data["cell_e
-00003b80: 7865 6375 7469 6f6e 5f69 6e70 7574 225d  xecution_input"]
-00003b90: 5b22 636f 6e74 656e 7422 5d5b 2263 6f64  ["content"]["cod
-00003ba0: 6522 5d20 3d3d 2063 6f64 6533 0a20 2020  e"] == code3.   
-00003bb0: 2020 2020 2020 2020 2029 2c20 6627 4661           ), f'Fa
-00003bc0: 696c 6564 2074 6f20 6669 6e64 2022 7b63  iled to find "{c
-00003bd0: 6f64 6533 7d22 2069 6e20 6365 6c6c 5f73  ode3}" in cell_s
-00003be0: 7472 6561 6d20 6461 7461 3a20 7b64 6174  tream data: {dat
-00003bf0: 617d 270a 2020 2020 2020 2020 2020 2020  a}'.            
-00003c00: 6173 7365 7274 2028 0a20 2020 2020 2020  assert (.       
-00003c10: 2020 2020 2020 2020 2064 6174 615b 2263           data["c
-00003c20: 656c 6c5f 6578 6563 7574 696f 6e5f 696e  ell_execution_in
-00003c30: 7075 7422 5d5b 2270 6172 656e 745f 6964  put"]["parent_id
-00003c40: 225d 203d 3d20 6d73 675f 6964 330a 2020  "] == msg_id3.  
-00003c50: 2020 2020 2020 2020 2020 292c 2066 2246            ), f"F
-00003c60: 6169 6c65 6420 746f 2066 696e 6420 6578  ailed to find ex
-00003c70: 7065 6374 6564 2070 6172 656e 745f 6964  pected parent_id
-00003c80: 220a 0a20 2020 2020 2020 2020 2020 2023  "..            #
-00003c90: 2073 7472 6561 6d20 6f75 7470 7574 206f   stream output o
-00003ca0: 6620 7468 6520 7468 6972 6420 6365 6c6c  f the third cell
-00003cb0: 0a20 2020 2020 2020 2020 2020 2064 6174  .            dat
-00003cc0: 6120 3d20 6e6f 6e5f 6365 6c6c 5f75 7064  a = non_cell_upd
-00003cd0: 6174 655f 6d73 6773 2e70 6f70 2830 290a  ate_msgs.pop(0).
-00003ce0: 2020 2020 2020 2020 2020 2020 6173 7365              asse
-00003cf0: 7274 2022 6365 6c6c 5f73 7472 6561 6d22  rt "cell_stream"
-00003d00: 2069 6e20 6461 7461 2e6b 6579 7328 290a   in data.keys().
-00003d10: 2020 2020 2020 2020 2020 2020 6173 7365              asse
-00003d20: 7274 2028 0a20 2020 2020 2020 2020 2020  rt (.           
-00003d30: 2020 2020 2064 6174 615b 2263 656c 6c5f       data["cell_
-00003d40: 7374 7265 616d 225d 5b22 6f75 7470 7574  stream"]["output
-00003d50: 225d 5b22 7465 7874 225d 203d 3d20 2263  "]["text"] == "c
-00003d60: 6865 636b 706f 696e 7433 5c6e 220a 2020  heckpoint3\n".  
-00003d70: 2020 2020 2020 2020 2020 292c 2066 2246            ), f"F
-00003d80: 6169 6c65 6420 746f 2066 696e 6420 6368  ailed to find ch
-00003d90: 6563 6b70 6f69 6e74 3320 696e 2063 656c  eckpoint3 in cel
-00003da0: 6c5f 7374 7265 616d 2064 6174 613a 207b  l_stream data: {
-00003db0: 6461 7461 7d22 0a0a 2020 2020 2020 2020  data}"..        
-00003dc0: 2020 2020 2320 6578 6563 7574 696f 6e20      # execution 
-00003dd0: 7265 706c 7920 666f 7220 6669 6e69 7368  reply for finish
-00003de0: 696e 6720 7468 6520 7468 6972 6420 6365  ing the third ce
-00003df0: 6c6c 2773 2065 7865 6375 7469 6f6e 0a20  ll's execution. 
-00003e00: 2020 2020 2020 2020 2020 2064 6174 6120             data 
-00003e10: 3d20 6e6f 6e5f 6365 6c6c 5f75 7064 6174  = non_cell_updat
-00003e20: 655f 6d73 6773 2e70 6f70 2830 290a 2020  e_msgs.pop(0).  
-00003e30: 2020 2020 2020 2020 2020 6173 7365 7274            assert
-00003e40: 2022 6365 6c6c 5f65 7865 6375 7469 6f6e   "cell_execution
-00003e50: 5f72 6570 6c79 2220 696e 2064 6174 612e  _reply" in data.
-00003e60: 6b65 7973 2829 0a20 2020 2020 2020 2020  keys().         
-00003e70: 2020 2061 7373 6572 7420 6461 7461 5b22     assert data["
-00003e80: 6365 6c6c 5f65 7865 6375 7469 6f6e 5f72  cell_execution_r
-00003e90: 6570 6c79 225d 5b22 7061 7265 6e74 5f69  eply"]["parent_i
-00003ea0: 6422 5d20 3d3d 206d 7367 5f69 6433 0a0a  d"] == msg_id3..
-00003eb0: 2020 2020 2020 2020 2020 2020 2320 6365              # ce
-00003ec0: 6c6c 5f75 7064 6174 6520 666f 7220 6365  ll_update for ce
-00003ed0: 6c6c 2074 6872 6565 2077 6974 6820 7468  ll three with th
-00003ee0: 6520 6f75 7470 7574 0a20 2020 2020 2020  e output.       
-00003ef0: 2020 2020 2064 6174 6120 3d20 6365 6c6c       data = cell
-00003f00: 5f75 7064 6174 655f 6d73 6773 2e70 6f70  _update_msgs.pop
-00003f10: 2830 290a 2020 2020 2020 2020 2020 2020  (0).            
-00003f20: 6173 7365 7274 2022 6365 6c6c 5f75 7064  assert "cell_upd
-00003f30: 6174 6522 2069 6e20 6461 7461 2e6b 6579  ate" in data.key
-00003f40: 7328 290a 2020 2020 2020 2020 2020 2020  s().            
-00003f50: 6173 7365 7274 2028 0a20 2020 2020 2020  assert (.       
-00003f60: 2020 2020 2020 2020 2064 6174 615b 2263           data["c
-00003f70: 656c 6c5f 7570 6461 7465 225d 5b30 5d5b  ell_update"][0][
-00003f80: 226d 6574 6164 6174 6122 5d5b 226a 7570  "metadata"]["jup
-00003f90: 7974 6572 5f64 3122 5d5b 2275 7569 6422  yter_d1"]["uuid"
-00003fa0: 5d0a 2020 2020 2020 2020 2020 2020 2020  ].              
-00003fb0: 2020 3d3d 2063 656c 6c5f 7575 6964 330a    == cell_uuid3.
-00003fc0: 2020 2020 2020 2020 2020 2020 290a 0a20              ).. 
-00003fd0: 2020 2020 2020 2020 2020 2023 2076 6172             # var
-00003fe0: 2075 7064 6174 650a 2020 2020 2020 2020   update.        
-00003ff0: 2020 2020 6461 7461 203d 206e 6f6e 5f63      data = non_c
-00004000: 656c 6c5f 7570 6461 7465 5f6d 7367 732e  ell_update_msgs.
-00004010: 706f 7028 3029 0a20 2020 2020 2020 2020  pop(0).         
-00004020: 2020 2061 7373 6572 7420 2276 6172 7322     assert "vars"
-00004030: 2069 6e20 6461 7461 2e6b 6579 7328 290a   in data.keys().
-00004040: 0a20 2020 2040 7079 7465 7374 2e6d 6172  .    @pytest.mar
-00004050: 6b2e 6173 796e 6369 6f0a 2020 2020 6173  k.asyncio.    as
-00004060: 796e 6320 6465 6620 7465 7374 5f63 656c  ync def test_cel
-00004070: 6c5f 7061 7463 685f 616e 645f 6578 6563  l_patch_and_exec
-00004080: 7574 6528 0a20 2020 2020 2020 2073 656c  ute(.        sel
-00004090: 662c 2063 6c69 656e 743a 2054 6573 7443  f, client: TestC
-000040a0: 6c69 656e 742c 2073 7570 6572 7573 6572  lient, superuser
-000040b0: 5f74 6f6b 656e 5f68 6561 6465 7273 3a20  _token_headers: 
-000040c0: 4469 6374 5b73 7472 2c20 7374 725d 0a20  Dict[str, str]. 
-000040d0: 2020 2029 3a0a 2020 2020 2020 2020 7575     ):.        uu
-000040e0: 6964 203d 2061 7761 6974 2075 706c 6f61  id = await uploa
-000040f0: 645f 6e6f 7465 626f 6f6b 280a 2020 2020  d_notebook(.    
-00004100: 2020 2020 2020 2020 636c 6965 6e74 2c20          client, 
-00004110: 7375 7065 7275 7365 725f 746f 6b65 6e5f  superuser_token_
-00004120: 6865 6164 6572 732c 2022 7369 6d70 6c65  headers, "simple
-00004130: 2e69 7079 6e62 220a 2020 2020 2020 2020  .ipynb".        
-00004140: 290a 0a20 2020 2020 2020 2023 2067 6574  )..        # get
-00004150: 2061 6e20 6578 6973 7469 6e67 2063 656c   an existing cel
-00004160: 6c0a 2020 2020 2020 2020 7265 7370 6f6e  l.        respon
-00004170: 7365 203d 2061 7761 6974 2063 6c69 656e  se = await clien
-00004180: 742e 6765 7428 0a20 2020 2020 2020 2020  t.get(.         
-00004190: 2020 2066 222f 6e6f 7465 626f 6f6b 732f     f"/notebooks/
-000041a0: 7b75 7569 647d 2f63 656c 6c73 222c 2068  {uuid}/cells", h
-000041b0: 6561 6465 7273 3d73 7570 6572 7573 6572  eaders=superuser
-000041c0: 5f74 6f6b 656e 5f68 6561 6465 7273 0a20  _token_headers. 
-000041d0: 2020 2020 2020 2029 0a20 2020 2020 2020         ).       
-000041e0: 2061 7373 6572 7420 7265 7370 6f6e 7365   assert response
-000041f0: 2e73 7461 7475 735f 636f 6465 203d 3d20  .status_code == 
-00004200: 3230 300a 2020 2020 2020 2020 6365 6c6c  200.        cell
-00004210: 7320 3d20 7265 7370 6f6e 7365 2e6a 736f  s = response.jso
-00004220: 6e28 295b 2263 656c 6c73 225d 0a20 2020  n()["cells"].   
-00004230: 2020 2020 2061 7373 6572 7420 6365 6c6c       assert cell
-00004240: 735b 315d 5b22 736f 7572 6365 225d 203d  s[1]["source"] =
-00004250: 3d20 2770 7269 6e74 2822 4c61 7272 7920  = 'print("Larry 
-00004260: 7468 6520 4c6c 616d 6122 2927 0a0a 2020  the Llama")'..  
-00004270: 2020 2020 2020 6365 6c6c 5f75 7569 6420        cell_uuid 
-00004280: 3d20 6365 6c6c 735b 315d 5b22 6d65 7461  = cells[1]["meta
-00004290: 6461 7461 225d 5b22 6a75 7079 7465 725f  data"]["jupyter_
-000042a0: 6431 225d 5b22 7575 6964 225d 0a0a 2020  d1"]["uuid"]..  
-000042b0: 2020 2020 2020 7061 7261 6d73 203d 207b        params = {
-000042c0: 2273 6f75 7263 6522 3a20 2237 2d39 227d  "source": "7-9"}
-000042d0: 0a20 2020 2020 2020 2072 6573 706f 6e73  .        respons
-000042e0: 6520 3d20 6177 6169 7420 636c 6965 6e74  e = await client
-000042f0: 2e70 6174 6368 280a 2020 2020 2020 2020  .patch(.        
-00004300: 2020 2020 6622 2f6e 6f74 6562 6f6f 6b73      f"/notebooks
-00004310: 2f7b 7575 6964 7d2f 6365 6c6c 732f 7b63  /{uuid}/cells/{c
-00004320: 656c 6c5f 7575 6964 7d22 2c0a 2020 2020  ell_uuid}",.    
-00004330: 2020 2020 2020 2020 6a73 6f6e 3d70 6172          json=par
-00004340: 616d 732c 0a20 2020 2020 2020 2020 2020  ams,.           
-00004350: 2068 6561 6465 7273 3d73 7570 6572 7573   headers=superus
-00004360: 6572 5f74 6f6b 656e 5f68 6561 6465 7273  er_token_headers
-00004370: 2c0a 2020 2020 2020 2020 290a 2020 2020  ,.        ).    
-00004380: 2020 2020 6173 7365 7274 2072 6573 706f      assert respo
-00004390: 6e73 652e 7374 6174 7573 5f63 6f64 6520  nse.status_code 
-000043a0: 3d3d 2032 3030 0a0a 2020 2020 2020 2020  == 200..        
-000043b0: 7265 7370 6f6e 7365 203d 2061 7761 6974  response = await
-000043c0: 2063 6c69 656e 742e 6765 7428 0a20 2020   client.get(.   
-000043d0: 2020 2020 2020 2020 2066 222f 6e6f 7465           f"/note
-000043e0: 626f 6f6b 732f 7b75 7569 647d 2f76 6172  books/{uuid}/var
-000043f0: 7322 2c20 6865 6164 6572 733d 7375 7065  s", headers=supe
-00004400: 7275 7365 725f 746f 6b65 6e5f 6865 6164  ruser_token_head
-00004410: 6572 730a 2020 2020 2020 2020 290a 2020  ers.        ).  
-00004420: 2020 2020 2020 6173 7365 7274 2072 6573        assert res
-00004430: 706f 6e73 652e 7374 6174 7573 5f63 6f64  ponse.status_cod
-00004440: 6520 3d3d 2032 3030 0a20 2020 2020 2020  e == 200.       
-00004450: 2061 7373 6572 7420 6c65 6e28 7265 7370   assert len(resp
-00004460: 6f6e 7365 2e6a 736f 6e28 295b 2276 6172  onse.json()["var
-00004470: 7322 5d29 203d 3d20 300a 0a20 2020 2020  s"]) == 0..     
-00004480: 2020 2061 7379 6e63 2077 6974 6820 636c     async with cl
-00004490: 6965 6e74 2e77 6562 736f 636b 6574 5f63  ient.websocket_c
-000044a0: 6f6e 6e65 6374 280a 2020 2020 2020 2020  onnect(.        
-000044b0: 2020 2020 6622 2f6e 6f74 6562 6f6f 6b73      f"/notebooks
-000044c0: 2f7b 7575 6964 7d2f 7773 2f6e 6f74 6562  /{uuid}/ws/noteb
-000044d0: 6f6f 6b22 2c20 6865 6164 6572 733d 7375  ook", headers=su
-000044e0: 7065 7275 7365 725f 746f 6b65 6e5f 6865  peruser_token_he
-000044f0: 6164 6572 730a 2020 2020 2020 2020 2920  aders.        ) 
-00004500: 6173 2077 6562 736f 636b 6574 3a0a 2020  as websocket:.  
-00004510: 2020 2020 2020 2020 2020 6177 6169 7420            await 
-00004520: 6173 796e 6369 6f2e 736c 6565 7028 5745  asyncio.sleep(WE
-00004530: 4253 4f43 4b45 545f 534c 4545 505f 5449  BSOCKET_SLEEP_TI
-00004540: 4d45 290a 0a20 2020 2020 2020 2020 2020  ME)..           
-00004550: 2072 6573 706f 6e73 6520 3d20 6177 6169   response = awai
-00004560: 7420 636c 6965 6e74 2e70 6174 6368 280a  t client.patch(.
+000012a0: 2020 2020 226a 7570 7974 6572 5f64 3122      "jupyter_d1"
+000012b0: 3a20 7b0a 2020 2020 2020 2020 2020 2020  : {.            
+000012c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000012d0: 2020 2020 2270 6f73 6974 696f 6e22 3a20      "position": 
+000012e0: 322c 0a20 2020 2020 2020 2020 2020 2020  2,.             
+000012f0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00001300: 2020 2022 7575 6964 223a 2063 656c 6c5f     "uuid": cell_
+00001310: 7575 6964 2c0a 2020 2020 2020 2020 2020  uuid,.          
+00001320: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00001330: 2020 2020 2020 226e 6f74 6562 6f6f 6b5f        "notebook_
+00001340: 7575 6964 223a 2075 7569 642c 0a20 2020  uuid": uuid,.   
+00001350: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00001360: 2020 2020 2020 2020 2020 2020 2022 6578               "ex
+00001370: 6563 7574 696f 6e5f 7374 6174 6522 3a20  ecution_state": 
+00001380: 2262 7573 7922 2c0a 2020 2020 2020 2020  "busy",.        
+00001390: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000013a0: 2020 2020 7d0a 2020 2020 2020 2020 2020      }.          
+000013b0: 2020 2020 2020 2020 2020 2020 2020 7d2c                },
+000013c0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+000013d0: 2020 2020 2020 2020 2022 6f75 7470 7574           "output
+000013e0: 7322 3a20 5b0a 2020 2020 2020 2020 2020  s": [.          
+000013f0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00001400: 2020 7b0a 2020 2020 2020 2020 2020 2020    {.            
+00001410: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00001420: 2020 2020 2264 6174 6122 3a20 7b22 7465      "data": {"te
+00001430: 7874 2f70 6c61 696e 223a 2022 3722 7d2c  xt/plain": "7"},
+00001440: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00001450: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00001460: 2022 6578 6563 7574 696f 6e5f 636f 756e   "execution_coun
+00001470: 7422 3a20 312c 0a20 2020 2020 2020 2020  t": 1,.         
+00001480: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00001490: 2020 2020 2020 2022 6d65 7461 6461 7461         "metadata
+000014a0: 223a 207b 7d2c 0a20 2020 2020 2020 2020  ": {},.         
+000014b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000014c0: 2020 2020 2020 2022 6f75 7470 7574 5f74         "output_t
+000014d0: 7970 6522 3a20 2265 7865 6375 7465 5f72  ype": "execute_r
+000014e0: 6573 756c 7422 2c0a 2020 2020 2020 2020  esult",.        
+000014f0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00001500: 2020 2020 7d0a 2020 2020 2020 2020 2020      }.          
+00001510: 2020 2020 2020 2020 2020 2020 2020 5d2c                ],
+00001520: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00001530: 2020 2020 2020 2020 2022 736f 7572 6365           "source
+00001540: 223a 2022 322b 3522 2c0a 2020 2020 2020  ": "2+5",.      
+00001550: 2020 2020 2020 2020 2020 2020 2020 7d0a                }.
+00001560: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00001570: 5d0a 2020 2020 2020 2020 2020 2020 7d0a  ].            }.
+00001580: 0a20 2020 2020 2020 2020 2020 2023 2066  .            # f
+00001590: 726f 6d20 7070 7269 6e74 2069 6d70 6f72  rom pprint impor
+000015a0: 7420 7070 7269 6e74 0a20 2020 2020 2020  t pprint.       
+000015b0: 2020 2020 2023 2070 7269 6e74 2822 6461       # print("da
+000015c0: 7461 2229 0a20 2020 2020 2020 2020 2020  ta").           
+000015d0: 2023 2070 7072 696e 7428 6461 7461 290a   # pprint(data).
+000015e0: 2020 2020 2020 2020 2020 2020 2320 7072              # pr
+000015f0: 696e 7428 2265 7870 6563 7465 6422 290a  int("expected").
+00001600: 2020 2020 2020 2020 2020 2020 2320 7070              # pp
+00001610: 7269 6e74 2865 7870 6563 7465 6429 0a20  rint(expected). 
+00001620: 2020 2020 2020 2020 2020 2061 7373 6572             asser
+00001630: 7420 6461 7461 203d 3d20 6578 7065 6374  t data == expect
+00001640: 6564 0a0a 2020 2020 2020 2020 2020 2020  ed..            
+00001650: 2320 7468 6972 6420 6368 756e 6b20 7265  # third chunk re
+00001660: 6365 6976 6564 2073 686f 756c 6420 6265  ceived should be
+00001670: 2061 2063 656c 6c5f 7570 6461 7465 2077   a cell_update w
+00001680: 6974 680a 2020 2020 2020 2020 2020 2020  ith.            
+00001690: 2320 616e 2065 7865 6375 7469 6f6e 5f73  # an execution_s
+000016a0: 7461 7465 206f 6620 2769 646c 6527 2062  tate of 'idle' b
+000016b0: 6563 7561 7365 2069 7427 7320 616c 6c20  ecuase it's all 
+000016c0: 646f 6e65 0a20 2020 2020 2020 2020 2020  done.           
+000016d0: 2064 6174 6120 3d20 6177 6169 7420 7265   data = await re
+000016e0: 6365 6976 655f 6a73 6f6e 2877 6562 736f  ceive_json(webso
+000016f0: 636b 6574 2c20 6d73 675f 7479 7065 733d  cket, msg_types=
+00001700: 5b22 6365 6c6c 5f75 7064 6174 6522 5d29  ["cell_update"])
+00001710: 0a20 2020 2020 2020 2020 2020 2064 315f  .            d1_
+00001720: 6d65 7461 6461 7461 203d 2064 6174 615b  metadata = data[
+00001730: 2263 656c 6c5f 7570 6461 7465 225d 5b30  "cell_update"][0
+00001740: 5d5b 226d 6574 6164 6174 6122 5d5b 226a  ]["metadata"]["j
+00001750: 7570 7974 6572 5f64 3122 5d0a 2020 2020  upyter_d1"].    
+00001760: 2020 2020 2020 2020 6173 7365 7274 2064          assert d
+00001770: 315f 6d65 7461 6461 7461 5b22 6578 6563  1_metadata["exec
+00001780: 7574 696f 6e5f 7374 6174 6522 5d20 3d3d  ution_state"] ==
+00001790: 2022 6964 6c65 220a 0a20 2020 2020 2020   "idle"..       
+000017a0: 2020 2020 2064 6174 6120 3d20 6177 6169       data = awai
+000017b0: 7420 7265 6365 6976 655f 6a73 6f6e 2877  t receive_json(w
+000017c0: 6562 736f 636b 6574 2c20 6d73 675f 7479  ebsocket, msg_ty
+000017d0: 7065 733d 5b22 7661 7273 225d 290a 2020  pes=["vars"]).  
+000017e0: 2020 2020 2020 2020 2020 6173 7365 7274            assert
+000017f0: 206c 656e 2864 6174 615b 2276 6172 7322   len(data["vars"
+00001800: 5d29 203d 3d20 3134 0a0a 2020 2020 4070  ]) == 14..    @p
+00001810: 7974 6573 742e 6d61 726b 2e61 7379 6e63  ytest.mark.async
+00001820: 696f 0a20 2020 2061 7379 6e63 2064 6566  io.    async def
+00001830: 2074 6573 745f 6e6f 7465 626f 6f6b 5f73   test_notebook_s
+00001840: 6571 7565 6e74 6961 6c5f 6578 6563 7574  equential_execut
+00001850: 6528 0a20 2020 2020 2020 2073 656c 662c  e(.        self,
+00001860: 2063 6c69 656e 743a 2054 6573 7443 6c69   client: TestCli
+00001870: 656e 742c 2073 7570 6572 7573 6572 5f74  ent, superuser_t
+00001880: 6f6b 656e 5f68 6561 6465 7273 3a20 4469  oken_headers: Di
+00001890: 6374 5b73 7472 2c20 7374 725d 0a20 2020  ct[str, str].   
+000018a0: 2029 3a0a 2020 2020 2020 2020 7575 6964   ):.        uuid
+000018b0: 203d 2061 7761 6974 2075 706c 6f61 645f   = await upload_
+000018c0: 6e6f 7465 626f 6f6b 2863 6c69 656e 742c  notebook(client,
+000018d0: 2073 7570 6572 7573 6572 5f74 6f6b 656e   superuser_token
+000018e0: 5f68 6561 6465 7273 290a 0a20 2020 2020  _headers)..     
+000018f0: 2020 2072 6573 706f 6e73 6520 3d20 6177     response = aw
+00001900: 6169 7420 636c 6965 6e74 2e67 6574 280a  ait client.get(.
+00001910: 2020 2020 2020 2020 2020 2020 6622 2f6e              f"/n
+00001920: 6f74 6562 6f6f 6b73 2f7b 7575 6964 7d2f  otebooks/{uuid}/
+00001930: 6365 6c6c 7322 2c20 6865 6164 6572 733d  cells", headers=
+00001940: 7375 7065 7275 7365 725f 746f 6b65 6e5f  superuser_token_
+00001950: 6865 6164 6572 730a 2020 2020 2020 2020  headers.        
+00001960: 290a 2020 2020 2020 2020 6173 7365 7274  ).        assert
+00001970: 2072 6573 706f 6e73 652e 7374 6174 7573   response.status
+00001980: 5f63 6f64 6520 3d3d 2032 3030 0a20 2020  _code == 200.   
+00001990: 2020 2020 2063 656c 6c73 203d 2072 6573       cells = res
+000019a0: 706f 6e73 652e 6a73 6f6e 2829 5b22 6365  ponse.json()["ce
+000019b0: 6c6c 7322 5d0a 0a20 2020 2020 2020 2063  lls"]..        c
+000019c0: 656c 6c5f 7575 6964 3120 3d20 6365 6c6c  ell_uuid1 = cell
+000019d0: 735b 315d 5b22 6d65 7461 6461 7461 225d  s[1]["metadata"]
+000019e0: 5b22 6a75 7079 7465 725f 6431 225d 5b22  ["jupyter_d1"]["
+000019f0: 7575 6964 225d 0a20 2020 2020 2020 2063  uuid"].        c
+00001a00: 656c 6c5f 7575 6964 3220 3d20 6365 6c6c  ell_uuid2 = cell
+00001a10: 735b 325d 5b22 6d65 7461 6461 7461 225d  s[2]["metadata"]
+00001a20: 5b22 6a75 7079 7465 725f 6431 225d 5b22  ["jupyter_d1"]["
+00001a30: 7575 6964 225d 0a20 2020 2020 2020 2063  uuid"].        c
+00001a40: 656c 6c5f 7575 6964 3320 3d20 6365 6c6c  ell_uuid3 = cell
+00001a50: 735b 335d 5b22 6d65 7461 6461 7461 225d  s[3]["metadata"]
+00001a60: 5b22 6a75 7079 7465 725f 6431 225d 5b22  ["jupyter_d1"]["
+00001a70: 7575 6964 225d 0a0a 2020 2020 2020 2020  uuid"]..        
+00001a80: 636f 6465 3120 3d20 2222 2269 6d70 6f72  code1 = """impor
+00001a90: 7420 7469 6d65 3b20 7469 6d65 2e73 6c65  t time; time.sle
+00001aa0: 6570 2831 2e31 293b 2070 7269 6e74 2822  ep(1.1); print("
+00001ab0: 6368 6563 6b70 6f69 6e74 3122 2922 2222  checkpoint1")"""
+00001ac0: 0a20 2020 2020 2020 2063 6f64 6532 203d  .        code2 =
+00001ad0: 2022 2222 696d 706f 7274 2074 696d 653b   """import time;
+00001ae0: 2074 696d 652e 736c 6565 7028 312e 3229   time.sleep(1.2)
+00001af0: 3b20 7072 696e 7428 2263 6865 636b 706f  ; print("checkpo
+00001b00: 696e 7432 2229 2222 220a 2020 2020 2020  int2")""".      
+00001b10: 2020 636f 6465 3320 3d20 2222 2269 6d70    code3 = """imp
+00001b20: 6f72 7420 7469 6d65 3b20 7469 6d65 2e73  ort time; time.s
+00001b30: 6c65 6570 2831 2e33 293b 2070 7269 6e74  leep(1.3); print
+00001b40: 2822 6368 6563 6b70 6f69 6e74 3322 2922  ("checkpoint3")"
+00001b50: 2222 0a0a 2020 2020 2020 2020 7061 7261  ""..        para
+00001b60: 6d73 3120 3d20 7b22 736f 7572 6365 223a  ms1 = {"source":
+00001b70: 2063 6f64 6531 7d0a 2020 2020 2020 2020   code1}.        
+00001b80: 7061 7261 6d73 3220 3d20 7b22 736f 7572  params2 = {"sour
+00001b90: 6365 223a 2063 6f64 6532 7d0a 2020 2020  ce": code2}.    
+00001ba0: 2020 2020 7061 7261 6d73 3320 3d20 7b22      params3 = {"
+00001bb0: 736f 7572 6365 223a 2063 6f64 6533 7d0a  source": code3}.
+00001bc0: 0a20 2020 2020 2020 2072 6573 7031 203d  .        resp1 =
+00001bd0: 2061 7761 6974 2063 6c69 656e 742e 7061   await client.pa
+00001be0: 7463 6828 0a20 2020 2020 2020 2020 2020  tch(.           
+00001bf0: 2066 222f 6e6f 7465 626f 6f6b 732f 7b75   f"/notebooks/{u
+00001c00: 7569 647d 2f63 656c 6c73 2f7b 6365 6c6c  uid}/cells/{cell
+00001c10: 5f75 7569 6431 7d22 2c0a 2020 2020 2020  _uuid1}",.      
+00001c20: 2020 2020 2020 6a73 6f6e 3d70 6172 616d        json=param
+00001c30: 7331 2c0a 2020 2020 2020 2020 2020 2020  s1,.            
+00001c40: 6865 6164 6572 733d 7375 7065 7275 7365  headers=superuse
+00001c50: 725f 746f 6b65 6e5f 6865 6164 6572 732c  r_token_headers,
+00001c60: 0a20 2020 2020 2020 2029 0a20 2020 2020  .        ).     
+00001c70: 2020 2061 7373 6572 7420 7265 7370 312e     assert resp1.
+00001c80: 7374 6174 7573 5f63 6f64 6520 3d3d 2032  status_code == 2
+00001c90: 3030 0a0a 2020 2020 2020 2020 7265 7370  00..        resp
+00001ca0: 3220 3d20 6177 6169 7420 636c 6965 6e74  2 = await client
+00001cb0: 2e70 6174 6368 280a 2020 2020 2020 2020  .patch(.        
+00001cc0: 2020 2020 6622 2f6e 6f74 6562 6f6f 6b73      f"/notebooks
+00001cd0: 2f7b 7575 6964 7d2f 6365 6c6c 732f 7b63  /{uuid}/cells/{c
+00001ce0: 656c 6c5f 7575 6964 327d 222c 0a20 2020  ell_uuid2}",.   
+00001cf0: 2020 2020 2020 2020 206a 736f 6e3d 7061           json=pa
+00001d00: 7261 6d73 322c 0a20 2020 2020 2020 2020  rams2,.         
+00001d10: 2020 2068 6561 6465 7273 3d73 7570 6572     headers=super
+00001d20: 7573 6572 5f74 6f6b 656e 5f68 6561 6465  user_token_heade
+00001d30: 7273 2c0a 2020 2020 2020 2020 290a 2020  rs,.        ).  
+00001d40: 2020 2020 2020 6173 7365 7274 2072 6573        assert res
+00001d50: 7032 2e73 7461 7475 735f 636f 6465 203d  p2.status_code =
+00001d60: 3d20 3230 300a 0a20 2020 2020 2020 2072  = 200..        r
+00001d70: 6573 7033 203d 2061 7761 6974 2063 6c69  esp3 = await cli
+00001d80: 656e 742e 7061 7463 6828 0a20 2020 2020  ent.patch(.     
+00001d90: 2020 2020 2020 2066 222f 6e6f 7465 626f         f"/notebo
+00001da0: 6f6b 732f 7b75 7569 647d 2f63 656c 6c73  oks/{uuid}/cells
+00001db0: 2f7b 6365 6c6c 5f75 7569 6433 7d22 2c0a  /{cell_uuid3}",.
+00001dc0: 2020 2020 2020 2020 2020 2020 6a73 6f6e              json
+00001dd0: 3d70 6172 616d 7333 2c0a 2020 2020 2020  =params3,.      
+00001de0: 2020 2020 2020 6865 6164 6572 733d 7375        headers=su
+00001df0: 7065 7275 7365 725f 746f 6b65 6e5f 6865  peruser_token_he
+00001e00: 6164 6572 732c 0a20 2020 2020 2020 2029  aders,.        )
+00001e10: 0a20 2020 2020 2020 2061 7373 6572 7420  .        assert 
+00001e20: 7265 7370 332e 7374 6174 7573 5f63 6f64  resp3.status_cod
+00001e30: 6520 3d3d 2032 3030 0a0a 2020 2020 2020  e == 200..      
+00001e40: 2020 6173 796e 6320 7769 7468 2063 6c69    async with cli
+00001e50: 656e 742e 7765 6273 6f63 6b65 745f 636f  ent.websocket_co
+00001e60: 6e6e 6563 7428 0a20 2020 2020 2020 2020  nnect(.         
+00001e70: 2020 2066 222f 6e6f 7465 626f 6f6b 732f     f"/notebooks/
+00001e80: 7b75 7569 647d 2f77 732f 6e6f 7465 626f  {uuid}/ws/notebo
+00001e90: 6f6b 222c 2068 6561 6465 7273 3d73 7570  ok", headers=sup
+00001ea0: 6572 7573 6572 5f74 6f6b 656e 5f68 6561  eruser_token_hea
+00001eb0: 6465 7273 0a20 2020 2020 2020 2029 2061  ders.        ) a
+00001ec0: 7320 7765 6273 6f63 6b65 743a 0a20 2020  s websocket:.   
+00001ed0: 2020 2020 2020 2020 2070 6173 730a 0a20           pass.. 
+00001ee0: 2020 2020 2020 2020 2020 2023 2061 7761             # awa
+00001ef0: 6974 2061 7379 6e63 696f 2e73 6c65 6570  it asyncio.sleep
+00001f00: 2857 4542 534f 434b 4554 5f53 4c45 4550  (WEBSOCKET_SLEEP
+00001f10: 5f54 494d 4529 0a20 2020 2020 2020 2020  _TIME).         
+00001f20: 2020 2061 7761 6974 2061 7379 6e63 696f     await asyncio
+00001f30: 2e73 6c65 6570 2833 2e35 290a 0a20 2020  .sleep(3.5)..   
+00001f40: 2020 2020 2020 2020 2072 6573 706f 6e73           respons
+00001f50: 6520 3d20 6177 6169 7420 636c 6965 6e74  e = await client
+00001f60: 2e67 6574 280a 2020 2020 2020 2020 2020  .get(.          
+00001f70: 2020 2020 2020 6622 2f6e 6f74 6562 6f6f        f"/noteboo
+00001f80: 6b73 2f7b 7575 6964 7d2f 6365 6c6c 732f  ks/{uuid}/cells/
+00001f90: 7b63 656c 6c5f 7575 6964 317d 2f65 7865  {cell_uuid1}/exe
+00001fa0: 6375 7465 222c 0a20 2020 2020 2020 2020  cute",.         
+00001fb0: 2020 2020 2020 2068 6561 6465 7273 3d73         headers=s
+00001fc0: 7570 6572 7573 6572 5f74 6f6b 656e 5f68  uperuser_token_h
+00001fd0: 6561 6465 7273 2c0a 2020 2020 2020 2020  eaders,.        
+00001fe0: 2020 2020 290a 2020 2020 2020 2020 2020      ).          
+00001ff0: 2020 6173 7365 7274 2072 6573 706f 6e73    assert respons
+00002000: 652e 7374 6174 7573 5f63 6f64 6520 3d3d  e.status_code ==
+00002010: 2032 3030 0a20 2020 2020 2020 2020 2020   200.           
+00002020: 2072 6573 706f 6e73 6520 3d20 6177 6169   response = awai
+00002030: 7420 636c 6965 6e74 2e67 6574 280a 2020  t client.get(.  
+00002040: 2020 2020 2020 2020 2020 2020 2020 6622                f"
+00002050: 2f6e 6f74 6562 6f6f 6b73 2f7b 7575 6964  /notebooks/{uuid
+00002060: 7d2f 6365 6c6c 732f 7b63 656c 6c5f 7575  }/cells/{cell_uu
+00002070: 6964 327d 2f65 7865 6375 7465 222c 0a20  id2}/execute",. 
+00002080: 2020 2020 2020 2020 2020 2020 2020 2068                 h
+00002090: 6561 6465 7273 3d73 7570 6572 7573 6572  eaders=superuser
+000020a0: 5f74 6f6b 656e 5f68 6561 6465 7273 2c0a  _token_headers,.
+000020b0: 2020 2020 2020 2020 2020 2020 290a 2020              ).  
+000020c0: 2020 2020 2020 2020 2020 6173 7365 7274            assert
+000020d0: 2072 6573 706f 6e73 652e 7374 6174 7573   response.status
+000020e0: 5f63 6f64 6520 3d3d 2032 3030 0a20 2020  _code == 200.   
+000020f0: 2020 2020 2020 2020 2072 6573 706f 6e73           respons
+00002100: 6520 3d20 6177 6169 7420 636c 6965 6e74  e = await client
+00002110: 2e67 6574 280a 2020 2020 2020 2020 2020  .get(.          
+00002120: 2020 2020 2020 6622 2f6e 6f74 6562 6f6f        f"/noteboo
+00002130: 6b73 2f7b 7575 6964 7d2f 6365 6c6c 732f  ks/{uuid}/cells/
+00002140: 7b63 656c 6c5f 7575 6964 337d 2f65 7865  {cell_uuid3}/exe
+00002150: 6375 7465 222c 0a20 2020 2020 2020 2020  cute",.         
+00002160: 2020 2020 2020 2068 6561 6465 7273 3d73         headers=s
+00002170: 7570 6572 7573 6572 5f74 6f6b 656e 5f68  uperuser_token_h
+00002180: 6561 6465 7273 2c0a 2020 2020 2020 2020  eaders,.        
+00002190: 2020 2020 290a 2020 2020 2020 2020 2020      ).          
+000021a0: 2020 6173 7365 7274 2072 6573 706f 6e73    assert respons
+000021b0: 652e 7374 6174 7573 5f63 6f64 6520 3d3d  e.status_code ==
+000021c0: 2032 3030 0a0a 2020 2020 2020 2020 2020   200..          
+000021d0: 2020 2320 4d65 7373 6167 6573 206f 6e20    # Messages on 
+000021e0: 7468 6520 7765 6220 736f 636b 6574 2063  the web socket c
+000021f0: 616e 2061 7272 6976 6520 696e 2061 2073  an arrive in a s
+00002200: 6c69 6768 746c 7920 6469 6666 6572 656e  lightly differen
+00002210: 740a 2020 2020 2020 2020 2020 2020 2320  t.            # 
+00002220: 6f72 6465 7220 6672 6f6d 2072 756e 2074  order from run t
+00002230: 6f20 7275 6e2e 2020 5468 6520 2763 656c  o run.  The 'cel
+00002240: 6c5f 7570 6461 7465 2720 6d65 7373 6167  l_update' messag
+00002250: 6573 2061 7272 6976 6520 6172 726f 756e  es arrive arroun
+00002260: 640a 2020 2020 2020 2020 2020 2020 2320  d.            # 
+00002270: 7468 6520 7361 6d65 2074 696d 6520 6173  the same time as
+00002280: 2073 6f6d 6520 6f66 2074 6865 2063 656c   some of the cel
+00002290: 6c5f 6578 6563 7574 696f 6e20 6d65 7373  l_execution mess
+000022a0: 6167 6573 2e20 2049 7420 646f 6573 6e27  ages.  It doesn'
+000022b0: 740a 2020 2020 2020 2020 2020 2020 2320  t.            # 
+000022c0: 7265 616c 6c79 206d 6174 7465 722c 2062  really matter, b
+000022d0: 7574 2069 7420 6d61 6b65 7320 7465 7374  ut it makes test
+000022e0: 696e 6720 7472 6963 6b79 2e20 2046 6f72  ing tricky.  For
+000022f0: 2061 2073 7461 626c 6520 7465 7374 2c0a   a stable test,.
+00002300: 2020 2020 2020 2020 2020 2020 2320 6761              # ga
+00002310: 7468 6572 2061 6c6c 2074 6865 2072 6573  ther all the res
+00002320: 706f 6e73 6573 2061 6e64 2073 706c 6974  ponses and split
+00002330: 2074 6865 6d20 696e 746f 2074 776f 206c   them into two l
+00002340: 6973 7473 2c20 6f6e 6520 666f 720a 2020  ists, one for.  
+00002350: 2020 2020 2020 2020 2020 2320 6365 6c6c            # cell
+00002360: 5f75 7064 6174 6520 6d65 7373 6167 6573  _update messages
+00002370: 2061 6e64 206f 6e65 2066 6f72 2061 6c6c   and one for all
+00002380: 2074 6865 206f 7468 6572 732e 0a0a 2020   the others...  
+00002390: 2020 2020 2020 2020 2020 2320 5468 6520            # The 
+000023a0: 6d6f 7374 2069 6d70 6f72 7461 6e74 2074  most important t
+000023b0: 6869 6e67 2066 6f72 2074 6869 7320 7465  hing for this te
+000023c0: 7374 2069 7320 7468 6174 2061 6c6c 2074  st is that all t
+000023d0: 6865 0a20 2020 2020 2020 2020 2020 2023  he.            #
+000023e0: 2022 6365 6c6c 5f65 7865 6375 7469 6f6e   "cell_execution
+000023f0: 5f72 6571 7565 7374 2220 6d65 7373 6167  _request" messag
+00002400: 6573 2061 7272 6976 6520 6669 7273 7420  es arrive first 
+00002410: 6173 2074 6865 2063 656c 6c73 2061 7265  as the cells are
+00002420: 0a20 2020 2020 2020 2020 2020 2023 2071  .            # q
+00002430: 7565 7565 6420 666f 7220 6578 6563 7574  ueued for execut
+00002440: 696f 6e20 616e 6420 7468 6520 2263 656c  ion and the "cel
+00002450: 6c5f 6578 6563 7574 696f 6e5f 696e 7075  l_execution_inpu
+00002460: 7422 2c0a 2020 2020 2020 2020 2020 2020  t",.            
+00002470: 2320 2263 656c 6c5f 6578 6563 7574 696f  # "cell_executio
+00002480: 6e5f 7265 706c 7922 2c20 6574 6320 6d65  n_reply", etc me
+00002490: 7373 6167 6573 2073 686f 7720 7570 206c  ssages show up l
+000024a0: 6174 6572 2061 7320 7468 6520 6365 6c6c  ater as the cell
+000024b0: 730a 2020 2020 2020 2020 2020 2020 2320  s.            # 
+000024c0: 6172 6520 7072 6f63 6573 7365 642e 0a0a  are processed...
+000024d0: 2020 2020 2020 2020 2020 2020 6365 6c6c              cell
+000024e0: 5f75 7064 6174 655f 6d73 6773 203d 205b  _update_msgs = [
+000024f0: 5d0a 2020 2020 2020 2020 2020 2020 6e6f  ].            no
+00002500: 6e5f 6365 6c6c 5f75 7064 6174 655f 6d73  n_cell_update_ms
+00002510: 6773 203d 205b 5d0a 2020 2020 2020 2020  gs = [].        
+00002520: 2020 2020 666f 7220 6920 696e 2072 616e      for i in ran
+00002530: 6765 2831 3929 3a0a 2020 2020 2020 2020  ge(19):.        
+00002540: 2020 2020 2020 2020 6461 7461 203d 2061          data = a
+00002550: 7761 6974 2072 6563 6569 7665 5f6a 736f  wait receive_jso
+00002560: 6e28 7765 6273 6f63 6b65 7429 0a20 2020  n(websocket).   
+00002570: 2020 2020 2020 2020 2020 2020 2069 6620               if 
+00002580: 2263 656c 6c5f 7570 6461 7465 2220 696e  "cell_update" in
+00002590: 2064 6174 612e 6b65 7973 2829 3a0a 2020   data.keys():.  
+000025a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000025b0: 2020 6365 6c6c 5f75 7064 6174 655f 6d73    cell_update_ms
+000025c0: 6773 2e61 7070 656e 6428 6461 7461 290a  gs.append(data).
+000025d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000025e0: 656c 7365 3a0a 2020 2020 2020 2020 2020  else:.          
+000025f0: 2020 2020 2020 2020 2020 6e6f 6e5f 6365            non_ce
+00002600: 6c6c 5f75 7064 6174 655f 6d73 6773 2e61  ll_update_msgs.a
+00002610: 7070 656e 6428 6461 7461 290a 0a20 2020  ppend(data)..   
+00002620: 2020 2020 2020 2020 2023 2073 686f 756c           # shoul
+00002630: 6420 6765 7420 7468 7265 6520 6578 6563  d get three exec
+00002640: 7574 696f 6e20 7265 7175 6573 7473 0a20  ution requests. 
+00002650: 2020 2020 2020 2020 2020 2064 6174 6120             data 
+00002660: 3d20 6e6f 6e5f 6365 6c6c 5f75 7064 6174  = non_cell_updat
+00002670: 655f 6d73 6773 2e70 6f70 2830 290a 2020  e_msgs.pop(0).  
+00002680: 2020 2020 2020 2020 2020 6173 7365 7274            assert
+00002690: 2022 6365 6c6c 5f65 7865 6375 7469 6f6e   "cell_execution
+000026a0: 5f72 6571 7565 7374 2220 696e 2064 6174  _request" in dat
+000026b0: 612e 6b65 7973 2829 0a20 2020 2020 2020  a.keys().       
+000026c0: 2020 2020 206d 7367 5f69 6431 203d 2064       msg_id1 = d
+000026d0: 6174 615b 2263 656c 6c5f 6578 6563 7574  ata["cell_execut
+000026e0: 696f 6e5f 7265 7175 6573 7422 5d5b 226d  ion_request"]["m
+000026f0: 6573 7361 6765 5f69 6422 5d0a 2020 2020  essage_id"].    
+00002700: 2020 2020 2020 2020 6173 7365 7274 206c          assert l
+00002710: 656e 286d 7367 5f69 6431 2920 696e 206d  en(msg_id1) in m
+00002720: 7367 5f69 645f 6c65 6e67 7468 730a 0a20  sg_id_lengths.. 
+00002730: 2020 2020 2020 2020 2020 2064 6174 6120             data 
+00002740: 3d20 6e6f 6e5f 6365 6c6c 5f75 7064 6174  = non_cell_updat
+00002750: 655f 6d73 6773 2e70 6f70 2830 290a 2020  e_msgs.pop(0).  
+00002760: 2020 2020 2020 2020 2020 6173 7365 7274            assert
+00002770: 2022 6365 6c6c 5f65 7865 6375 7469 6f6e   "cell_execution
+00002780: 5f72 6571 7565 7374 2220 696e 2064 6174  _request" in dat
+00002790: 612e 6b65 7973 2829 0a20 2020 2020 2020  a.keys().       
+000027a0: 2020 2020 206d 7367 5f69 6432 203d 2064       msg_id2 = d
+000027b0: 6174 615b 2263 656c 6c5f 6578 6563 7574  ata["cell_execut
+000027c0: 696f 6e5f 7265 7175 6573 7422 5d5b 226d  ion_request"]["m
+000027d0: 6573 7361 6765 5f69 6422 5d0a 2020 2020  essage_id"].    
+000027e0: 2020 2020 2020 2020 6173 7365 7274 206c          assert l
+000027f0: 656e 286d 7367 5f69 6432 2920 696e 206d  en(msg_id2) in m
+00002800: 7367 5f69 645f 6c65 6e67 7468 730a 0a20  sg_id_lengths.. 
+00002810: 2020 2020 2020 2020 2020 2064 6174 6120             data 
+00002820: 3d20 6e6f 6e5f 6365 6c6c 5f75 7064 6174  = non_cell_updat
+00002830: 655f 6d73 6773 2e70 6f70 2830 290a 2020  e_msgs.pop(0).  
+00002840: 2020 2020 2020 2020 2020 6173 7365 7274            assert
+00002850: 2022 6365 6c6c 5f65 7865 6375 7469 6f6e   "cell_execution
+00002860: 5f72 6571 7565 7374 2220 696e 2064 6174  _request" in dat
+00002870: 612e 6b65 7973 2829 0a20 2020 2020 2020  a.keys().       
+00002880: 2020 2020 206d 7367 5f69 6433 203d 2064       msg_id3 = d
+00002890: 6174 615b 2263 656c 6c5f 6578 6563 7574  ata["cell_execut
+000028a0: 696f 6e5f 7265 7175 6573 7422 5d5b 226d  ion_request"]["m
+000028b0: 6573 7361 6765 5f69 6422 5d0a 2020 2020  essage_id"].    
+000028c0: 2020 2020 2020 2020 6173 7365 7274 206c          assert l
+000028d0: 656e 286d 7367 5f69 6433 2920 696e 206d  en(msg_id3) in m
+000028e0: 7367 5f69 645f 6c65 6e67 7468 730a 0a20  sg_id_lengths.. 
+000028f0: 2020 2020 2020 2020 2020 2023 2063 656c             # cel
+00002900: 6c20 7570 6461 7465 2066 6f72 2074 6865  l update for the
+00002910: 2066 6972 7374 2065 7865 6375 7469 6e67   first executing
+00002920: 2063 656c 6c0a 2020 2020 2020 2020 2020   cell.          
+00002930: 2020 6461 7461 203d 2063 656c 6c5f 7570    data = cell_up
+00002940: 6461 7465 5f6d 7367 732e 706f 7028 3029  date_msgs.pop(0)
+00002950: 0a20 2020 2020 2020 2020 2020 2061 7373  .            ass
+00002960: 6572 7420 2263 656c 6c5f 7570 6461 7465  ert "cell_update
+00002970: 2220 696e 2064 6174 612e 6b65 7973 2829  " in data.keys()
+00002980: 0a20 2020 2020 2020 2020 2020 2061 7373  .            ass
+00002990: 6572 7420 280a 2020 2020 2020 2020 2020  ert (.          
+000029a0: 2020 2020 2020 6461 7461 5b22 6365 6c6c        data["cell
+000029b0: 5f75 7064 6174 6522 5d5b 305d 5b22 6d65  _update"][0]["me
+000029c0: 7461 6461 7461 225d 5b22 6a75 7079 7465  tadata"]["jupyte
+000029d0: 725f 6431 225d 5b22 7575 6964 225d 0a20  r_d1"]["uuid"]. 
+000029e0: 2020 2020 2020 2020 2020 2020 2020 203d                 =
+000029f0: 3d20 6365 6c6c 5f75 7569 6431 0a20 2020  = cell_uuid1.   
+00002a00: 2020 2020 2020 2020 2029 0a0a 2020 2020           )..    
+00002a10: 2020 2020 2020 2020 2320 6365 6c6c 5f65          # cell_e
+00002a20: 7865 6375 7469 6f6e 5f69 6e70 7574 2066  xecution_input f
+00002a30: 6f72 2074 6865 2066 6972 7374 2063 656c  or the first cel
+00002a40: 6c27 7320 636f 6465 2062 6569 6e67 2065  l's code being e
+00002a50: 7865 6375 7465 640a 2020 2020 2020 2020  xecuted.        
+00002a60: 2020 2020 6461 7461 203d 206e 6f6e 5f63      data = non_c
+00002a70: 656c 6c5f 7570 6461 7465 5f6d 7367 732e  ell_update_msgs.
+00002a80: 706f 7028 3029 0a20 2020 2020 2020 2020  pop(0).         
+00002a90: 2020 2061 7373 6572 7420 2263 656c 6c5f     assert "cell_
+00002aa0: 6578 6563 7574 696f 6e5f 696e 7075 7422  execution_input"
+00002ab0: 2069 6e20 6461 7461 0a20 2020 2020 2020   in data.       
+00002ac0: 2020 2020 2061 7373 6572 7420 280a 2020       assert (.  
+00002ad0: 2020 2020 2020 2020 2020 2020 2020 6461                da
+00002ae0: 7461 5b22 6365 6c6c 5f65 7865 6375 7469  ta["cell_executi
+00002af0: 6f6e 5f69 6e70 7574 225d 5b22 636f 6e74  on_input"]["cont
+00002b00: 656e 7422 5d5b 2263 6f64 6522 5d20 3d3d  ent"]["code"] ==
+00002b10: 2063 6f64 6531 0a20 2020 2020 2020 2020   code1.         
+00002b20: 2020 2029 2c20 6627 4661 696c 6564 2074     ), f'Failed t
+00002b30: 6f20 6669 6e64 2022 7b63 6f64 6531 7d22  o find "{code1}"
+00002b40: 2069 6e20 2064 6174 613a 207b 6461 7461   in  data: {data
+00002b50: 7d27 0a20 2020 2020 2020 2020 2020 2061  }'.            a
+00002b60: 7373 6572 7420 280a 2020 2020 2020 2020  ssert (.        
+00002b70: 2020 2020 2020 2020 6461 7461 5b22 6365          data["ce
+00002b80: 6c6c 5f65 7865 6375 7469 6f6e 5f69 6e70  ll_execution_inp
+00002b90: 7574 225d 5b22 7061 7265 6e74 5f69 6422  ut"]["parent_id"
+00002ba0: 5d20 3d3d 206d 7367 5f69 6431 0a20 2020  ] == msg_id1.   
+00002bb0: 2020 2020 2020 2020 2029 2c20 6622 4661           ), f"Fa
+00002bc0: 696c 6564 2074 6f20 6669 6e64 2065 7870  iled to find exp
+00002bd0: 6563 7465 6420 7061 7265 6e74 5f69 6422  ected parent_id"
+00002be0: 0a0a 2020 2020 2020 2020 2020 2020 2320  ..            # 
+00002bf0: 7374 7265 616d 206f 7574 7075 7420 6e6f  stream output no
+00002c00: 7720 7365 6e64 7320 6120 6365 6c6c 5f75  w sends a cell_u
+00002c10: 7064 6174 650a 2020 2020 2020 2020 2020  pdate.          
+00002c20: 2020 6461 7461 203d 2063 656c 6c5f 7570    data = cell_up
+00002c30: 6461 7465 5f6d 7367 732e 706f 7028 3029  date_msgs.pop(0)
+00002c40: 0a20 2020 2020 2020 2020 2020 2061 7373  .            ass
+00002c50: 6572 7420 2263 656c 6c5f 7570 6461 7465  ert "cell_update
+00002c60: 2220 696e 2064 6174 612e 6b65 7973 2829  " in data.keys()
+00002c70: 0a20 2020 2020 2020 2020 2020 2061 7373  .            ass
+00002c80: 6572 7420 6461 7461 5b22 6365 6c6c 5f75  ert data["cell_u
+00002c90: 7064 6174 6522 5d5b 305d 5b22 6f75 7470  pdate"][0]["outp
+00002ca0: 7574 7322 5d5b 305d 5b22 7465 7874 225d  uts"][0]["text"]
+00002cb0: 203d 3d20 5b0a 2020 2020 2020 2020 2020   == [.          
+00002cc0: 2020 2020 2020 2263 6865 636b 706f 696e        "checkpoin
+00002cd0: 7431 5c6e 220a 2020 2020 2020 2020 2020  t1\n".          
+00002ce0: 2020 5d2c 2066 2246 6169 6c65 6420 746f    ], f"Failed to
+00002cf0: 2066 696e 6420 6368 6563 6b70 6f69 6e74   find checkpoint
+00002d00: 3120 696e 2063 656c 6c5f 7570 6461 7465  1 in cell_update
+00002d10: 2064 6174 613a 207b 6461 7461 7d22 0a0a   data: {data}"..
+00002d20: 2020 2020 2020 2020 2020 2020 2320 6578              # ex
+00002d30: 6563 7574 696f 6e5f 7265 706c 7920 666f  ecution_reply fo
+00002d40: 7220 7468 6520 656e 6420 6f66 2074 6865  r the end of the
+00002d50: 2066 6972 7374 2063 656c 6c27 7320 6578   first cell's ex
+00002d60: 6563 7574 696f 6e0a 2020 2020 2020 2020  ecution.        
+00002d70: 2020 2020 6461 7461 203d 206e 6f6e 5f63      data = non_c
+00002d80: 656c 6c5f 7570 6461 7465 5f6d 7367 732e  ell_update_msgs.
+00002d90: 706f 7028 3029 0a20 2020 2020 2020 2020  pop(0).         
+00002da0: 2020 2061 7373 6572 7420 2263 656c 6c5f     assert "cell_
+00002db0: 6578 6563 7574 696f 6e5f 7265 706c 7922  execution_reply"
+00002dc0: 2069 6e20 6461 7461 2e6b 6579 7328 290a   in data.keys().
+00002dd0: 2020 2020 2020 2020 2020 2020 6173 7365              asse
+00002de0: 7274 2064 6174 615b 2263 656c 6c5f 6578  rt data["cell_ex
+00002df0: 6563 7574 696f 6e5f 7265 706c 7922 5d5b  ecution_reply"][
+00002e00: 2270 6172 656e 745f 6964 225d 203d 3d20  "parent_id"] == 
+00002e10: 6d73 675f 6964 310a 0a20 2020 2020 2020  msg_id1..       
+00002e20: 2020 2020 2023 2063 656c 6c20 7570 6461       # cell upda
+00002e30: 7465 2077 6974 6820 7468 6520 7265 7375  te with the resu
+00002e40: 6c74 7320 6f66 2074 6865 2066 6972 7374  lts of the first
+00002e50: 2063 656c 6c27 7320 6578 6563 7574 696f   cell's executio
+00002e60: 6e0a 2020 2020 2020 2020 2020 2020 6461  n.            da
+00002e70: 7461 203d 2063 656c 6c5f 7570 6461 7465  ta = cell_update
+00002e80: 5f6d 7367 732e 706f 7028 3029 0a20 2020  _msgs.pop(0).   
+00002e90: 2020 2020 2020 2020 2061 7373 6572 7420           assert 
+00002ea0: 2263 656c 6c5f 7570 6461 7465 2220 696e  "cell_update" in
+00002eb0: 2064 6174 612e 6b65 7973 2829 0a20 2020   data.keys().   
+00002ec0: 2020 2020 2020 2020 2061 7373 6572 7420           assert 
+00002ed0: 280a 2020 2020 2020 2020 2020 2020 2020  (.              
+00002ee0: 2020 6461 7461 5b22 6365 6c6c 5f75 7064    data["cell_upd
+00002ef0: 6174 6522 5d5b 305d 5b22 6d65 7461 6461  ate"][0]["metada
+00002f00: 7461 225d 5b22 6a75 7079 7465 725f 6431  ta"]["jupyter_d1
+00002f10: 225d 5b22 7575 6964 225d 0a20 2020 2020  "]["uuid"].     
+00002f20: 2020 2020 2020 2020 2020 203d 3d20 6365             == ce
+00002f30: 6c6c 5f75 7569 6431 0a20 2020 2020 2020  ll_uuid1.       
+00002f40: 2020 2020 2029 0a0a 2020 2020 2020 2020       )..        
+00002f50: 2020 2020 2320 6365 6c6c 2075 7064 6174      # cell updat
+00002f60: 6520 666f 7220 7468 6520 6265 6769 6e69  e for the begini
+00002f70: 6e67 206f 6620 7468 6520 7365 636f 6e64  ng of the second
+00002f80: 2063 656c 6c27 7320 6578 6563 7574 696f   cell's executio
+00002f90: 6e0a 2020 2020 2020 2020 2020 2020 6461  n.            da
+00002fa0: 7461 203d 2063 656c 6c5f 7570 6461 7465  ta = cell_update
+00002fb0: 5f6d 7367 732e 706f 7028 3029 0a20 2020  _msgs.pop(0).   
+00002fc0: 2020 2020 2020 2020 2061 7373 6572 7420           assert 
+00002fd0: 2263 656c 6c5f 7570 6461 7465 2220 696e  "cell_update" in
+00002fe0: 2064 6174 612e 6b65 7973 2829 0a20 2020   data.keys().   
+00002ff0: 2020 2020 2020 2020 2061 7373 6572 7420           assert 
+00003000: 280a 2020 2020 2020 2020 2020 2020 2020  (.              
+00003010: 2020 6461 7461 5b22 6365 6c6c 5f75 7064    data["cell_upd
+00003020: 6174 6522 5d5b 305d 5b22 6d65 7461 6461  ate"][0]["metada
+00003030: 7461 225d 5b22 6a75 7079 7465 725f 6431  ta"]["jupyter_d1
+00003040: 225d 5b22 7575 6964 225d 0a20 2020 2020  "]["uuid"].     
+00003050: 2020 2020 2020 2020 2020 203d 3d20 6365             == ce
+00003060: 6c6c 5f75 7569 6432 0a20 2020 2020 2020  ll_uuid2.       
+00003070: 2020 2020 2029 0a0a 2020 2020 2020 2020       )..        
+00003080: 2020 2020 2320 6365 6c6c 5f69 6e70 7574      # cell_input
+00003090: 2075 7064 6174 6520 7769 7468 2074 6865   update with the
+000030a0: 2073 6563 6f6e 6420 6365 6c6c 2773 2063   second cell's c
+000030b0: 6f64 6520 6265 696e 6720 6578 6563 7574  ode being execut
+000030c0: 6564 0a20 2020 2020 2020 2020 2020 2064  ed.            d
+000030d0: 6174 6120 3d20 6e6f 6e5f 6365 6c6c 5f75  ata = non_cell_u
+000030e0: 7064 6174 655f 6d73 6773 2e70 6f70 2830  pdate_msgs.pop(0
+000030f0: 290a 2020 2020 2020 2020 2020 2020 6173  ).            as
+00003100: 7365 7274 2022 6365 6c6c 5f65 7865 6375  sert "cell_execu
+00003110: 7469 6f6e 5f69 6e70 7574 2220 696e 2064  tion_input" in d
+00003120: 6174 610a 2020 2020 2020 2020 2020 2020  ata.            
+00003130: 6173 7365 7274 2028 0a20 2020 2020 2020  assert (.       
+00003140: 2020 2020 2020 2020 2064 6174 615b 2263           data["c
+00003150: 656c 6c5f 6578 6563 7574 696f 6e5f 696e  ell_execution_in
+00003160: 7075 7422 5d5b 2263 6f6e 7465 6e74 225d  put"]["content"]
+00003170: 5b22 636f 6465 225d 203d 3d20 636f 6465  ["code"] == code
+00003180: 320a 2020 2020 2020 2020 2020 2020 292c  2.            ),
+00003190: 2066 2746 6169 6c65 6420 746f 2066 696e   f'Failed to fin
+000031a0: 6420 227b 636f 6465 327d 2220 696e 2063  d "{code2}" in c
+000031b0: 656c 6c5f 7570 6461 7465 2064 6174 613a  ell_update data:
+000031c0: 207b 6461 7461 7d27 0a20 2020 2020 2020   {data}'.       
+000031d0: 2020 2020 2061 7373 6572 7420 280a 2020       assert (.  
+000031e0: 2020 2020 2020 2020 2020 2020 2020 6461                da
+000031f0: 7461 5b22 6365 6c6c 5f65 7865 6375 7469  ta["cell_executi
+00003200: 6f6e 5f69 6e70 7574 225d 5b22 7061 7265  on_input"]["pare
+00003210: 6e74 5f69 6422 5d20 3d3d 206d 7367 5f69  nt_id"] == msg_i
+00003220: 6432 0a20 2020 2020 2020 2020 2020 2029  d2.            )
+00003230: 2c20 6622 4661 696c 6564 2074 6f20 6669  , f"Failed to fi
+00003240: 6e64 2065 7870 6563 7465 6420 7061 7265  nd expected pare
+00003250: 6e74 5f69 6422 0a0a 2020 2020 2020 2020  nt_id"..        
+00003260: 2020 2020 2320 7374 7265 616d 206f 7574      # stream out
+00003270: 7075 7420 6f66 2074 6865 2073 6563 6f6e  put of the secon
+00003280: 6420 6365 6c6c 2773 2065 7865 6375 7469  d cell's executi
+00003290: 6f6e 0a20 2020 2020 2020 2020 2020 2064  on.            d
+000032a0: 6174 6120 3d20 6365 6c6c 5f75 7064 6174  ata = cell_updat
+000032b0: 655f 6d73 6773 2e70 6f70 2830 290a 2020  e_msgs.pop(0).  
+000032c0: 2020 2020 2020 2020 2020 6173 7365 7274            assert
+000032d0: 2022 6365 6c6c 5f75 7064 6174 6522 2069   "cell_update" i
+000032e0: 6e20 6461 7461 2e6b 6579 7328 290a 2020  n data.keys().  
+000032f0: 2020 2020 2020 2020 2020 6173 7365 7274            assert
+00003300: 2064 6174 615b 2263 656c 6c5f 7570 6461   data["cell_upda
+00003310: 7465 225d 5b30 5d5b 226f 7574 7075 7473  te"][0]["outputs
+00003320: 225d 5b30 5d5b 2274 6578 7422 5d20 3d3d  "][0]["text"] ==
+00003330: 205b 0a20 2020 2020 2020 2020 2020 2020   [.             
+00003340: 2020 2022 6368 6563 6b70 6f69 6e74 325c     "checkpoint2\
+00003350: 6e22 0a20 2020 2020 2020 2020 2020 205d  n".            ]
+00003360: 2c20 6622 4661 696c 6564 2074 6f20 6669  , f"Failed to fi
+00003370: 6e64 2063 6865 636b 706f 696e 7432 2069  nd checkpoint2 i
+00003380: 6e20 6365 6c6c 5f75 7064 6174 6520 6461  n cell_update da
+00003390: 7461 3a20 7b64 6174 617d 220a 0a20 2020  ta: {data}"..   
+000033a0: 2020 2020 2020 2020 2023 2065 7865 6374           # exect
+000033b0: 7569 6f6e 5f72 6570 6c79 2066 6f72 2074  uion_reply for t
+000033c0: 6865 2065 6e64 206f 6620 7468 6520 7365  he end of the se
+000033d0: 636f 6e64 2063 656c 6c27 7320 6578 6563  cond cell's exec
+000033e0: 7574 696f 6e0a 2020 2020 2020 2020 2020  ution.          
+000033f0: 2020 6461 7461 203d 206e 6f6e 5f63 656c    data = non_cel
+00003400: 6c5f 7570 6461 7465 5f6d 7367 732e 706f  l_update_msgs.po
+00003410: 7028 3029 0a20 2020 2020 2020 2020 2020  p(0).           
+00003420: 2061 7373 6572 7420 2263 656c 6c5f 6578   assert "cell_ex
+00003430: 6563 7574 696f 6e5f 7265 706c 7922 2069  ecution_reply" i
+00003440: 6e20 6461 7461 2e6b 6579 7328 290a 2020  n data.keys().  
+00003450: 2020 2020 2020 2020 2020 6173 7365 7274            assert
+00003460: 2064 6174 615b 2263 656c 6c5f 6578 6563   data["cell_exec
+00003470: 7574 696f 6e5f 7265 706c 7922 5d5b 2270  ution_reply"]["p
+00003480: 6172 656e 745f 6964 225d 203d 3d20 6d73  arent_id"] == ms
+00003490: 675f 6964 320a 0a20 2020 2020 2020 2020  g_id2..         
+000034a0: 2020 2023 2063 656c 6c5f 7570 6461 7465     # cell_update
+000034b0: 2077 6974 6820 7468 6520 7265 7375 6c74   with the result
+000034c0: 7320 6f66 2074 6865 2073 6563 6f6e 6420  s of the second 
+000034d0: 6365 6c6c 0a20 2020 2020 2020 2020 2020  cell.           
+000034e0: 2064 6174 6120 3d20 6365 6c6c 5f75 7064   data = cell_upd
+000034f0: 6174 655f 6d73 6773 2e70 6f70 2830 290a  ate_msgs.pop(0).
+00003500: 2020 2020 2020 2020 2020 2020 6173 7365              asse
+00003510: 7274 2022 6365 6c6c 5f75 7064 6174 6522  rt "cell_update"
+00003520: 2069 6e20 6461 7461 2e6b 6579 7328 290a   in data.keys().
+00003530: 2020 2020 2020 2020 2020 2020 6173 7365              asse
+00003540: 7274 2028 0a20 2020 2020 2020 2020 2020  rt (.           
+00003550: 2020 2020 2064 6174 615b 2263 656c 6c5f       data["cell_
+00003560: 7570 6461 7465 225d 5b30 5d5b 226d 6574  update"][0]["met
+00003570: 6164 6174 6122 5d5b 226a 7570 7974 6572  adata"]["jupyter
+00003580: 5f64 3122 5d5b 2275 7569 6422 5d0a 2020  _d1"]["uuid"].  
+00003590: 2020 2020 2020 2020 2020 2020 2020 3d3d                ==
+000035a0: 2063 656c 6c5f 7575 6964 320a 2020 2020   cell_uuid2.    
+000035b0: 2020 2020 2020 2020 290a 0a20 2020 2020          )..     
+000035c0: 2020 2020 2020 2023 2063 656c 6c5f 7570         # cell_up
+000035d0: 6461 7465 2061 7320 7468 6520 7468 6972  date as the thir
+000035e0: 6420 6365 6c6c 2062 6567 696e 7320 6578  d cell begins ex
+000035f0: 6563 7574 696f 6e0a 2020 2020 2020 2020  ecution.        
+00003600: 2020 2020 6461 7461 203d 2063 656c 6c5f      data = cell_
+00003610: 7570 6461 7465 5f6d 7367 732e 706f 7028  update_msgs.pop(
+00003620: 3029 0a20 2020 2020 2020 2020 2020 2061  0).            a
+00003630: 7373 6572 7420 2263 656c 6c5f 7570 6461  ssert "cell_upda
+00003640: 7465 2220 696e 2064 6174 612e 6b65 7973  te" in data.keys
+00003650: 2829 0a20 2020 2020 2020 2020 2020 2061  ().            a
+00003660: 7373 6572 7420 280a 2020 2020 2020 2020  ssert (.        
+00003670: 2020 2020 2020 2020 6461 7461 5b22 6365          data["ce
+00003680: 6c6c 5f75 7064 6174 6522 5d5b 305d 5b22  ll_update"][0]["
+00003690: 6d65 7461 6461 7461 225d 5b22 6a75 7079  metadata"]["jupy
+000036a0: 7465 725f 6431 225d 5b22 7575 6964 225d  ter_d1"]["uuid"]
+000036b0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+000036c0: 203d 3d20 6365 6c6c 5f75 7569 6433 0a20   == cell_uuid3. 
+000036d0: 2020 2020 2020 2020 2020 2029 0a0a 2020             )..  
+000036e0: 2020 2020 2020 2020 2020 2320 6365 6c6c            # cell
+000036f0: 5f65 7865 6375 7469 6f6e 5f69 6e70 7574  _execution_input
+00003700: 2077 6974 6820 7468 6972 6420 6365 6c6c   with third cell
+00003710: 2063 6f64 6520 6162 6f75 7420 746f 2062   code about to b
+00003720: 6520 6578 6563 7574 6564 0a20 2020 2020  e executed.     
+00003730: 2020 2020 2020 2064 6174 6120 3d20 6e6f         data = no
+00003740: 6e5f 6365 6c6c 5f75 7064 6174 655f 6d73  n_cell_update_ms
+00003750: 6773 2e70 6f70 2830 290a 2020 2020 2020  gs.pop(0).      
+00003760: 2020 2020 2020 6173 7365 7274 2022 6365        assert "ce
+00003770: 6c6c 5f65 7865 6375 7469 6f6e 5f69 6e70  ll_execution_inp
+00003780: 7574 2220 696e 2064 6174 610a 2020 2020  ut" in data.    
+00003790: 2020 2020 2020 2020 6173 7365 7274 2028          assert (
+000037a0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+000037b0: 2064 6174 615b 2263 656c 6c5f 6578 6563   data["cell_exec
+000037c0: 7574 696f 6e5f 696e 7075 7422 5d5b 2263  ution_input"]["c
+000037d0: 6f6e 7465 6e74 225d 5b22 636f 6465 225d  ontent"]["code"]
+000037e0: 203d 3d20 636f 6465 330a 2020 2020 2020   == code3.      
+000037f0: 2020 2020 2020 292c 2066 2746 6169 6c65        ), f'Faile
+00003800: 6420 746f 2066 696e 6420 227b 636f 6465  d to find "{code
+00003810: 337d 2220 696e 2063 656c 6c5f 7570 6461  3}" in cell_upda
+00003820: 7465 2064 6174 613a 207b 6461 7461 7d27  te data: {data}'
+00003830: 0a20 2020 2020 2020 2020 2020 2061 7373  .            ass
+00003840: 6572 7420 280a 2020 2020 2020 2020 2020  ert (.          
+00003850: 2020 2020 2020 6461 7461 5b22 6365 6c6c        data["cell
+00003860: 5f65 7865 6375 7469 6f6e 5f69 6e70 7574  _execution_input
+00003870: 225d 5b22 7061 7265 6e74 5f69 6422 5d20  "]["parent_id"] 
+00003880: 3d3d 206d 7367 5f69 6433 0a20 2020 2020  == msg_id3.     
+00003890: 2020 2020 2020 2029 2c20 6622 4661 696c         ), f"Fail
+000038a0: 6564 2074 6f20 6669 6e64 2065 7870 6563  ed to find expec
+000038b0: 7465 6420 7061 7265 6e74 5f69 6422 0a0a  ted parent_id"..
+000038c0: 2020 2020 2020 2020 2020 2020 2320 7374              # st
+000038d0: 7265 616d 206f 7574 7075 7420 6f66 2074  ream output of t
+000038e0: 6865 2074 6869 7264 2063 656c 6c0a 2020  he third cell.  
+000038f0: 2020 2020 2020 2020 2020 6461 7461 203d            data =
+00003900: 2063 656c 6c5f 7570 6461 7465 5f6d 7367   cell_update_msg
+00003910: 732e 706f 7028 3029 0a20 2020 2020 2020  s.pop(0).       
+00003920: 2020 2020 2061 7373 6572 7420 2263 656c       assert "cel
+00003930: 6c5f 7570 6461 7465 2220 696e 2064 6174  l_update" in dat
+00003940: 612e 6b65 7973 2829 0a20 2020 2020 2020  a.keys().       
+00003950: 2020 2020 2061 7373 6572 7420 6461 7461       assert data
+00003960: 5b22 6365 6c6c 5f75 7064 6174 6522 5d5b  ["cell_update"][
+00003970: 305d 5b22 6f75 7470 7574 7322 5d5b 305d  0]["outputs"][0]
+00003980: 5b22 7465 7874 225d 203d 3d20 5b0a 2020  ["text"] == [.  
+00003990: 2020 2020 2020 2020 2020 2020 2020 2263                "c
+000039a0: 6865 636b 706f 696e 7433 5c6e 220a 2020  heckpoint3\n".  
+000039b0: 2020 2020 2020 2020 2020 5d2c 2066 2246            ], f"F
+000039c0: 6169 6c65 6420 746f 2066 696e 6420 6368  ailed to find ch
+000039d0: 6563 6b70 6f69 6e74 3320 696e 2063 656c  eckpoint3 in cel
+000039e0: 6c5f 7570 6461 7465 2064 6174 613a 207b  l_update data: {
+000039f0: 6461 7461 7d22 0a0a 2020 2020 2020 2020  data}"..        
+00003a00: 2020 2020 2320 6578 6563 7574 696f 6e20      # execution 
+00003a10: 7265 706c 7920 666f 7220 6669 6e69 7368  reply for finish
+00003a20: 696e 6720 7468 6520 7468 6972 6420 6365  ing the third ce
+00003a30: 6c6c 2773 2065 7865 6375 7469 6f6e 0a20  ll's execution. 
+00003a40: 2020 2020 2020 2020 2020 2064 6174 6120             data 
+00003a50: 3d20 6e6f 6e5f 6365 6c6c 5f75 7064 6174  = non_cell_updat
+00003a60: 655f 6d73 6773 2e70 6f70 2830 290a 2020  e_msgs.pop(0).  
+00003a70: 2020 2020 2020 2020 2020 6173 7365 7274            assert
+00003a80: 2022 6365 6c6c 5f65 7865 6375 7469 6f6e   "cell_execution
+00003a90: 5f72 6570 6c79 2220 696e 2064 6174 612e  _reply" in data.
+00003aa0: 6b65 7973 2829 0a20 2020 2020 2020 2020  keys().         
+00003ab0: 2020 2061 7373 6572 7420 6461 7461 5b22     assert data["
+00003ac0: 6365 6c6c 5f65 7865 6375 7469 6f6e 5f72  cell_execution_r
+00003ad0: 6570 6c79 225d 5b22 7061 7265 6e74 5f69  eply"]["parent_i
+00003ae0: 6422 5d20 3d3d 206d 7367 5f69 6433 0a0a  d"] == msg_id3..
+00003af0: 2020 2020 2020 2020 2020 2020 2320 6365              # ce
+00003b00: 6c6c 5f75 7064 6174 6520 666f 7220 6365  ll_update for ce
+00003b10: 6c6c 2074 6872 6565 2077 6974 6820 7468  ll three with th
+00003b20: 6520 6f75 7470 7574 0a20 2020 2020 2020  e output.       
+00003b30: 2020 2020 2064 6174 6120 3d20 6365 6c6c       data = cell
+00003b40: 5f75 7064 6174 655f 6d73 6773 2e70 6f70  _update_msgs.pop
+00003b50: 2830 290a 2020 2020 2020 2020 2020 2020  (0).            
+00003b60: 6173 7365 7274 2022 6365 6c6c 5f75 7064  assert "cell_upd
+00003b70: 6174 6522 2069 6e20 6461 7461 2e6b 6579  ate" in data.key
+00003b80: 7328 290a 2020 2020 2020 2020 2020 2020  s().            
+00003b90: 6173 7365 7274 2028 0a20 2020 2020 2020  assert (.       
+00003ba0: 2020 2020 2020 2020 2064 6174 615b 2263           data["c
+00003bb0: 656c 6c5f 7570 6461 7465 225d 5b30 5d5b  ell_update"][0][
+00003bc0: 226d 6574 6164 6174 6122 5d5b 226a 7570  "metadata"]["jup
+00003bd0: 7974 6572 5f64 3122 5d5b 2275 7569 6422  yter_d1"]["uuid"
+00003be0: 5d0a 2020 2020 2020 2020 2020 2020 2020  ].              
+00003bf0: 2020 3d3d 2063 656c 6c5f 7575 6964 330a    == cell_uuid3.
+00003c00: 2020 2020 2020 2020 2020 2020 290a 0a20              ).. 
+00003c10: 2020 2020 2020 2020 2020 2023 2076 6172             # var
+00003c20: 2075 7064 6174 650a 2020 2020 2020 2020   update.        
+00003c30: 2020 2020 6461 7461 203d 206e 6f6e 5f63      data = non_c
+00003c40: 656c 6c5f 7570 6461 7465 5f6d 7367 732e  ell_update_msgs.
+00003c50: 706f 7028 3029 0a20 2020 2020 2020 2020  pop(0).         
+00003c60: 2020 2061 7373 6572 7420 2276 6172 7322     assert "vars"
+00003c70: 2069 6e20 6461 7461 2e6b 6579 7328 290a   in data.keys().
+00003c80: 0a20 2020 2040 7079 7465 7374 2e6d 6172  .    @pytest.mar
+00003c90: 6b2e 6173 796e 6369 6f0a 2020 2020 6173  k.asyncio.    as
+00003ca0: 796e 6320 6465 6620 7465 7374 5f63 656c  ync def test_cel
+00003cb0: 6c5f 7061 7463 685f 616e 645f 6578 6563  l_patch_and_exec
+00003cc0: 7574 6528 0a20 2020 2020 2020 2073 656c  ute(.        sel
+00003cd0: 662c 2063 6c69 656e 743a 2054 6573 7443  f, client: TestC
+00003ce0: 6c69 656e 742c 2073 7570 6572 7573 6572  lient, superuser
+00003cf0: 5f74 6f6b 656e 5f68 6561 6465 7273 3a20  _token_headers: 
+00003d00: 4469 6374 5b73 7472 2c20 7374 725d 0a20  Dict[str, str]. 
+00003d10: 2020 2029 3a0a 2020 2020 2020 2020 7575     ):.        uu
+00003d20: 6964 203d 2061 7761 6974 2075 706c 6f61  id = await uploa
+00003d30: 645f 6e6f 7465 626f 6f6b 280a 2020 2020  d_notebook(.    
+00003d40: 2020 2020 2020 2020 636c 6965 6e74 2c20          client, 
+00003d50: 7375 7065 7275 7365 725f 746f 6b65 6e5f  superuser_token_
+00003d60: 6865 6164 6572 732c 2022 7369 6d70 6c65  headers, "simple
+00003d70: 2e69 7079 6e62 220a 2020 2020 2020 2020  .ipynb".        
+00003d80: 290a 0a20 2020 2020 2020 2023 2067 6574  )..        # get
+00003d90: 2061 6e20 6578 6973 7469 6e67 2063 656c   an existing cel
+00003da0: 6c0a 2020 2020 2020 2020 7265 7370 6f6e  l.        respon
+00003db0: 7365 203d 2061 7761 6974 2063 6c69 656e  se = await clien
+00003dc0: 742e 6765 7428 0a20 2020 2020 2020 2020  t.get(.         
+00003dd0: 2020 2066 222f 6e6f 7465 626f 6f6b 732f     f"/notebooks/
+00003de0: 7b75 7569 647d 2f63 656c 6c73 222c 2068  {uuid}/cells", h
+00003df0: 6561 6465 7273 3d73 7570 6572 7573 6572  eaders=superuser
+00003e00: 5f74 6f6b 656e 5f68 6561 6465 7273 0a20  _token_headers. 
+00003e10: 2020 2020 2020 2029 0a20 2020 2020 2020         ).       
+00003e20: 2061 7373 6572 7420 7265 7370 6f6e 7365   assert response
+00003e30: 2e73 7461 7475 735f 636f 6465 203d 3d20  .status_code == 
+00003e40: 3230 300a 2020 2020 2020 2020 6365 6c6c  200.        cell
+00003e50: 7320 3d20 7265 7370 6f6e 7365 2e6a 736f  s = response.jso
+00003e60: 6e28 295b 2263 656c 6c73 225d 0a20 2020  n()["cells"].   
+00003e70: 2020 2020 2061 7373 6572 7420 6365 6c6c       assert cell
+00003e80: 735b 315d 5b22 736f 7572 6365 225d 203d  s[1]["source"] =
+00003e90: 3d20 2770 7269 6e74 2822 4c61 7272 7920  = 'print("Larry 
+00003ea0: 7468 6520 4c6c 616d 6122 2927 0a0a 2020  the Llama")'..  
+00003eb0: 2020 2020 2020 6365 6c6c 5f75 7569 6420        cell_uuid 
+00003ec0: 3d20 6365 6c6c 735b 315d 5b22 6d65 7461  = cells[1]["meta
+00003ed0: 6461 7461 225d 5b22 6a75 7079 7465 725f  data"]["jupyter_
+00003ee0: 6431 225d 5b22 7575 6964 225d 0a0a 2020  d1"]["uuid"]..  
+00003ef0: 2020 2020 2020 7061 7261 6d73 203d 207b        params = {
+00003f00: 2273 6f75 7263 6522 3a20 2237 2d39 227d  "source": "7-9"}
+00003f10: 0a20 2020 2020 2020 2072 6573 706f 6e73  .        respons
+00003f20: 6520 3d20 6177 6169 7420 636c 6965 6e74  e = await client
+00003f30: 2e70 6174 6368 280a 2020 2020 2020 2020  .patch(.        
+00003f40: 2020 2020 6622 2f6e 6f74 6562 6f6f 6b73      f"/notebooks
+00003f50: 2f7b 7575 6964 7d2f 6365 6c6c 732f 7b63  /{uuid}/cells/{c
+00003f60: 656c 6c5f 7575 6964 7d22 2c0a 2020 2020  ell_uuid}",.    
+00003f70: 2020 2020 2020 2020 6a73 6f6e 3d70 6172          json=par
+00003f80: 616d 732c 0a20 2020 2020 2020 2020 2020  ams,.           
+00003f90: 2068 6561 6465 7273 3d73 7570 6572 7573   headers=superus
+00003fa0: 6572 5f74 6f6b 656e 5f68 6561 6465 7273  er_token_headers
+00003fb0: 2c0a 2020 2020 2020 2020 290a 2020 2020  ,.        ).    
+00003fc0: 2020 2020 6173 7365 7274 2072 6573 706f      assert respo
+00003fd0: 6e73 652e 7374 6174 7573 5f63 6f64 6520  nse.status_code 
+00003fe0: 3d3d 2032 3030 0a0a 2020 2020 2020 2020  == 200..        
+00003ff0: 7265 7370 6f6e 7365 203d 2061 7761 6974  response = await
+00004000: 2063 6c69 656e 742e 6765 7428 0a20 2020   client.get(.   
+00004010: 2020 2020 2020 2020 2066 222f 6e6f 7465           f"/note
+00004020: 626f 6f6b 732f 7b75 7569 647d 2f76 6172  books/{uuid}/var
+00004030: 7322 2c20 6865 6164 6572 733d 7375 7065  s", headers=supe
+00004040: 7275 7365 725f 746f 6b65 6e5f 6865 6164  ruser_token_head
+00004050: 6572 730a 2020 2020 2020 2020 290a 2020  ers.        ).  
+00004060: 2020 2020 2020 6173 7365 7274 2072 6573        assert res
+00004070: 706f 6e73 652e 7374 6174 7573 5f63 6f64  ponse.status_cod
+00004080: 6520 3d3d 2032 3030 0a20 2020 2020 2020  e == 200.       
+00004090: 2061 7373 6572 7420 6c65 6e28 7265 7370   assert len(resp
+000040a0: 6f6e 7365 2e6a 736f 6e28 295b 2276 6172  onse.json()["var
+000040b0: 7322 5d29 203d 3d20 300a 0a20 2020 2020  s"]) == 0..     
+000040c0: 2020 2061 7379 6e63 2077 6974 6820 636c     async with cl
+000040d0: 6965 6e74 2e77 6562 736f 636b 6574 5f63  ient.websocket_c
+000040e0: 6f6e 6e65 6374 280a 2020 2020 2020 2020  onnect(.        
+000040f0: 2020 2020 6622 2f6e 6f74 6562 6f6f 6b73      f"/notebooks
+00004100: 2f7b 7575 6964 7d2f 7773 2f6e 6f74 6562  /{uuid}/ws/noteb
+00004110: 6f6f 6b22 2c20 6865 6164 6572 733d 7375  ook", headers=su
+00004120: 7065 7275 7365 725f 746f 6b65 6e5f 6865  peruser_token_he
+00004130: 6164 6572 730a 2020 2020 2020 2020 2920  aders.        ) 
+00004140: 6173 2077 6562 736f 636b 6574 3a0a 2020  as websocket:.  
+00004150: 2020 2020 2020 2020 2020 6177 6169 7420            await 
+00004160: 6173 796e 6369 6f2e 736c 6565 7028 5745  asyncio.sleep(WE
+00004170: 4253 4f43 4b45 545f 534c 4545 505f 5449  BSOCKET_SLEEP_TI
+00004180: 4d45 290a 0a20 2020 2020 2020 2020 2020  ME)..           
+00004190: 2072 6573 706f 6e73 6520 3d20 6177 6169   response = awai
+000041a0: 7420 636c 6965 6e74 2e70 6174 6368 280a  t client.patch(.
+000041b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000041c0: 6622 2f6e 6f74 6562 6f6f 6b73 2f7b 7575  f"/notebooks/{uu
+000041d0: 6964 7d2f 6365 6c6c 732f 7b63 656c 6c5f  id}/cells/{cell_
+000041e0: 7575 6964 7d2f 6578 6563 7574 6522 2c0a  uuid}/execute",.
+000041f0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00004200: 6a73 6f6e 3d70 6172 616d 732c 0a20 2020  json=params,.   
+00004210: 2020 2020 2020 2020 2020 2020 2068 6561               hea
+00004220: 6465 7273 3d73 7570 6572 7573 6572 5f74  ders=superuser_t
+00004230: 6f6b 656e 5f68 6561 6465 7273 2c0a 2020  oken_headers,.  
+00004240: 2020 2020 2020 2020 2020 290a 2020 2020            ).    
+00004250: 2020 2020 2020 2020 6173 7365 7274 2072          assert r
+00004260: 6573 706f 6e73 652e 7374 6174 7573 5f63  esponse.status_c
+00004270: 6f64 6520 3d3d 2032 3030 0a0a 2020 2020  ode == 200..    
+00004280: 2020 2020 2020 2020 6578 7065 6374 6564          expected
+00004290: 203d 207b 0a20 2020 2020 2020 2020 2020   = {.           
+000042a0: 2020 2020 2022 6365 6c6c 5f75 7064 6174       "cell_updat
+000042b0: 6522 3a20 5b0a 2020 2020 2020 2020 2020  e": [.          
+000042c0: 2020 2020 2020 2020 2020 7b0a 2020 2020            {.    
+000042d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000042e0: 2020 2020 2263 656c 6c5f 7479 7065 223a      "cell_type":
+000042f0: 2022 636f 6465 222c 0a20 2020 2020 2020   "code",.       
+00004300: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00004310: 2022 6578 6563 7574 696f 6e5f 636f 756e   "execution_coun
+00004320: 7422 3a20 312c 0a20 2020 2020 2020 2020  t": 1,.         
+00004330: 2020 2020 2020 2020 2020 2020 2020 2022                 "
+00004340: 6d65 7461 6461 7461 223a 207b 0a20 2020  metadata": {.   
+00004350: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00004360: 2020 2020 2020 2020 2022 6a75 7079 7465           "jupyte
+00004370: 725f 6431 223a 207b 0a20 2020 2020 2020  r_d1": {.       
+00004380: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00004390: 2020 2020 2020 2020 2022 706f 7369 7469           "positi
+000043a0: 6f6e 223a 2031 2c0a 2020 2020 2020 2020  on": 1,.        
+000043b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000043c0: 2020 2020 2020 2020 2275 7569 6422 3a20          "uuid": 
+000043d0: 6365 6c6c 5f75 7569 642c 0a20 2020 2020  cell_uuid,.     
+000043e0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000043f0: 2020 2020 2020 2020 2020 2022 6e6f 7465             "note
+00004400: 626f 6f6b 5f75 7569 6422 3a20 7575 6964  book_uuid": uuid
+00004410: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
+00004420: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00004430: 2020 2265 7865 6375 7469 6f6e 5f73 7461    "execution_sta
+00004440: 7465 223a 2022 6275 7379 222c 0a20 2020  te": "busy",.   
+00004450: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00004460: 2020 2020 2020 2020 207d 0a20 2020 2020           }.     
+00004470: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00004480: 2020 207d 2c0a 2020 2020 2020 2020 2020     },.          
+00004490: 2020 2020 2020 2020 2020 2020 2020 226f                "o
+000044a0: 7574 7075 7473 223a 205b 0a20 2020 2020  utputs": [.     
+000044b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000044c0: 2020 2020 2020 207b 0a20 2020 2020 2020         {.       
+000044d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000044e0: 2020 2020 2020 2020 2022 6461 7461 223a           "data":
+000044f0: 207b 2274 6578 742f 706c 6169 6e22 3a20   {"text/plain": 
+00004500: 222d 3222 7d2c 0a20 2020 2020 2020 2020  "-2"},.         
+00004510: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00004520: 2020 2020 2020 2022 6578 6563 7574 696f         "executio
+00004530: 6e5f 636f 756e 7422 3a20 312c 0a20 2020  n_count": 1,.   
+00004540: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00004550: 2020 2020 2020 2020 2020 2020 2022 6d65               "me
+00004560: 7461 6461 7461 223a 207b 7d2c 0a20 2020  tadata": {},.   
 00004570: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00004580: 6622 2f6e 6f74 6562 6f6f 6b73 2f7b 7575  f"/notebooks/{uu
-00004590: 6964 7d2f 6365 6c6c 732f 7b63 656c 6c5f  id}/cells/{cell_
-000045a0: 7575 6964 7d2f 6578 6563 7574 6522 2c0a  uuid}/execute",.
+00004580: 2020 2020 2020 2020 2020 2020 2022 6f75               "ou
+00004590: 7470 7574 5f74 7970 6522 3a20 2265 7865  tput_type": "exe
+000045a0: 6375 7465 5f72 6573 756c 7422 2c0a 2020  cute_result",.  
 000045b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000045c0: 6a73 6f6e 3d70 6172 616d 732c 0a20 2020  json=params,.   
-000045d0: 2020 2020 2020 2020 2020 2020 2068 6561               hea
-000045e0: 6465 7273 3d73 7570 6572 7573 6572 5f74  ders=superuser_t
-000045f0: 6f6b 656e 5f68 6561 6465 7273 2c0a 2020  oken_headers,.  
-00004600: 2020 2020 2020 2020 2020 290a 2020 2020            ).    
-00004610: 2020 2020 2020 2020 6173 7365 7274 2072          assert r
-00004620: 6573 706f 6e73 652e 7374 6174 7573 5f63  esponse.status_c
-00004630: 6f64 6520 3d3d 2032 3030 0a0a 2020 2020  ode == 200..    
-00004640: 2020 2020 2020 2020 6578 7065 6374 6564          expected
-00004650: 203d 207b 0a20 2020 2020 2020 2020 2020   = {.           
-00004660: 2020 2020 2022 6365 6c6c 5f75 7064 6174       "cell_updat
-00004670: 6522 3a20 5b0a 2020 2020 2020 2020 2020  e": [.          
-00004680: 2020 2020 2020 2020 2020 7b0a 2020 2020            {.    
-00004690: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000046a0: 2020 2020 2263 656c 6c5f 7479 7065 223a      "cell_type":
-000046b0: 2022 636f 6465 222c 0a20 2020 2020 2020   "code",.       
-000046c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000046d0: 2022 6578 6563 7574 696f 6e5f 636f 756e   "execution_coun
-000046e0: 7422 3a20 312c 0a20 2020 2020 2020 2020  t": 1,.         
-000046f0: 2020 2020 2020 2020 2020 2020 2020 2022                 "
-00004700: 6d65 7461 6461 7461 223a 207b 0a20 2020  metadata": {.   
-00004710: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00004720: 2020 2020 2020 2020 2022 6a75 7079 7465           "jupyte
-00004730: 725f 6431 223a 207b 0a20 2020 2020 2020  r_d1": {.       
-00004740: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00004750: 2020 2020 2020 2020 2022 706f 7369 7469           "positi
-00004760: 6f6e 223a 2031 2c0a 2020 2020 2020 2020  on": 1,.        
-00004770: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00004780: 2020 2020 2020 2020 2275 7569 6422 3a20          "uuid": 
-00004790: 6365 6c6c 5f75 7569 642c 0a20 2020 2020  cell_uuid,.     
-000047a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000047b0: 2020 2020 2020 2020 2020 2022 6e6f 7465             "note
-000047c0: 626f 6f6b 5f75 7569 6422 3a20 7575 6964  book_uuid": uuid
-000047d0: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
-000047e0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000047f0: 2020 2265 7865 6375 7469 6f6e 5f73 7461    "execution_sta
-00004800: 7465 223a 2022 6275 7379 222c 0a20 2020  te": "busy",.   
-00004810: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00004820: 2020 2020 2020 2020 207d 0a20 2020 2020           }.     
-00004830: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00004840: 2020 207d 2c0a 2020 2020 2020 2020 2020     },.          
-00004850: 2020 2020 2020 2020 2020 2020 2020 226f                "o
-00004860: 7574 7075 7473 223a 205b 0a20 2020 2020  utputs": [.     
-00004870: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00004880: 2020 2020 2020 207b 0a20 2020 2020 2020         {.       
-00004890: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000048a0: 2020 2020 2020 2020 2022 6461 7461 223a           "data":
-000048b0: 207b 2274 6578 742f 706c 6169 6e22 3a20   {"text/plain": 
-000048c0: 222d 3222 7d2c 0a20 2020 2020 2020 2020  "-2"},.         
-000048d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000048e0: 2020 2020 2020 2022 6578 6563 7574 696f         "executio
-000048f0: 6e5f 636f 756e 7422 3a20 312c 0a20 2020  n_count": 1,.   
-00004900: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00004910: 2020 2020 2020 2020 2020 2020 2022 6d65               "me
-00004920: 7461 6461 7461 223a 207b 7d2c 0a20 2020  tadata": {},.   
-00004930: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00004940: 2020 2020 2020 2020 2020 2020 2022 6f75               "ou
-00004950: 7470 7574 5f74 7970 6522 3a20 2265 7865  tput_type": "exe
-00004960: 6375 7465 5f72 6573 756c 7422 2c0a 2020  cute_result",.  
-00004970: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00004980: 2020 2020 2020 2020 2020 7d0a 2020 2020            }.    
-00004990: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000049a0: 2020 2020 5d2c 0a20 2020 2020 2020 2020      ],.         
-000049b0: 2020 2020 2020 2020 2020 2020 2020 2022                 "
-000049c0: 736f 7572 6365 223a 2022 372d 3922 2c0a  source": "7-9",.
-000049d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000049e0: 2020 2020 7d0a 2020 2020 2020 2020 2020      }.          
-000049f0: 2020 2020 2020 5d0a 2020 2020 2020 2020        ].        
-00004a00: 2020 2020 7d0a 0a20 2020 2020 2020 2020      }..         
-00004a10: 2020 2070 6174 6368 5f6a 736f 6e20 3d20     patch_json = 
-00004a20: 7265 7370 6f6e 7365 2e6a 736f 6e28 290a  response.json().
-00004a30: 2020 2020 2020 2020 2020 2020 2320 7265              # re
-00004a40: 7370 6f6e 7365 2073 686f 756c 6420 636f  sponse should co
-00004a50: 6e74 6169 6e20 626f 7468 2074 6865 2027  ntain both the '
-00004a60: 6365 6c6c 272c 276b 6572 6e65 6c5f 6d65  cell','kernel_me
-00004a70: 7373 6167 6527 2077 7261 7070 6572 730a  ssage' wrappers.
-00004a80: 2020 2020 2020 2020 2020 2020 6173 7365              asse
-00004a90: 7274 2022 6365 6c6c 2220 696e 2070 6174  rt "cell" in pat
-00004aa0: 6368 5f6a 736f 6e2e 6b65 7973 2829 0a20  ch_json.keys(). 
-00004ab0: 2020 2020 2020 2020 2020 206d 7367 5f69             msg_i
-00004ac0: 6420 3d20 7265 7370 6f6e 7365 2e6a 736f  d = response.jso
-00004ad0: 6e28 295b 226b 6572 6e65 6c5f 6d65 7373  n()["kernel_mess
-00004ae0: 6167 6522 5d5b 226d 6573 7361 6765 5f69  age"]["message_i
-00004af0: 6422 5d0a 2020 2020 2020 2020 2020 2020  d"].            
-00004b00: 6173 7365 7274 206c 656e 286d 7367 5f69  assert len(msg_i
-00004b10: 6429 2069 6e20 6d73 675f 6964 5f6c 656e  d) in msg_id_len
-00004b20: 6774 6873 0a0a 2020 2020 2020 2020 2020  gths..          
-00004b30: 2020 6578 6563 5f72 6570 6c79 203d 2061    exec_reply = a
-00004b40: 7761 6974 2072 6563 6569 7665 5f6a 736f  wait receive_jso
-00004b50: 6e28 0a20 2020 2020 2020 2020 2020 2020  n(.             
-00004b60: 2020 2077 6562 736f 636b 6574 2c20 6d73     websocket, ms
-00004b70: 675f 7479 7065 733d 5b22 6365 6c6c 5f65  g_types=["cell_e
-00004b80: 7865 6375 7469 6f6e 5f72 6570 6c79 225d  xecution_reply"]
-00004b90: 0a20 2020 2020 2020 2020 2020 2029 0a20  .            ). 
-00004ba0: 2020 2020 2020 2020 2020 2061 7373 6572             asser
-00004bb0: 7420 6578 6563 5f72 6570 6c79 5b22 6365  t exec_reply["ce
-00004bc0: 6c6c 5f65 7865 6375 7469 6f6e 5f72 6570  ll_execution_rep
-00004bd0: 6c79 225d 5b22 6365 6c6c 5f69 6422 5d20  ly"]["cell_id"] 
-00004be0: 3d3d 2063 656c 6c5f 7575 6964 0a20 2020  == cell_uuid.   
-00004bf0: 2020 2020 2020 2020 2061 7373 6572 7420           assert 
-00004c00: 6578 6563 5f72 6570 6c79 5b22 6365 6c6c  exec_reply["cell
-00004c10: 5f65 7865 6375 7469 6f6e 5f72 6570 6c79  _execution_reply
-00004c20: 225d 5b22 7061 7265 6e74 5f69 6422 5d20  "]["parent_id"] 
-00004c30: 3d3d 206d 7367 5f69 640a 0a20 2020 2020  == msg_id..     
-00004c40: 2020 2020 2020 2064 6174 6120 3d20 6177         data = aw
-00004c50: 6169 7420 7265 6365 6976 655f 6a73 6f6e  ait receive_json
-00004c60: 2877 6562 736f 636b 6574 2c20 6d73 675f  (websocket, msg_
-00004c70: 7479 7065 733d 5b22 6365 6c6c 5f75 7064  types=["cell_upd
-00004c80: 6174 6522 5d29 0a20 2020 2020 2020 2020  ate"]).         
-00004c90: 2020 2061 7373 6572 7420 6461 7461 203d     assert data =
-00004ca0: 3d20 6578 7065 6374 6564 0a0a 2020 2020  = expected..    
-00004cb0: 4070 7974 6573 742e 6d61 726b 2e61 7379  @pytest.mark.asy
-00004cc0: 6e63 696f 0a20 2020 2061 7379 6e63 2064  ncio.    async d
-00004cd0: 6566 2074 6573 745f 6e6f 7465 626f 6f6b  ef test_notebook
-00004ce0: 5f63 656c 6c5f 6164 6428 0a20 2020 2020  _cell_add(.     
-00004cf0: 2020 2073 656c 662c 2063 6c69 656e 743a     self, client:
-00004d00: 2054 6573 7443 6c69 656e 742c 2073 7570   TestClient, sup
-00004d10: 6572 7573 6572 5f74 6f6b 656e 5f68 6561  eruser_token_hea
-00004d20: 6465 7273 3a20 4469 6374 5b73 7472 2c20  ders: Dict[str, 
-00004d30: 7374 725d 0a20 2020 2029 3a0a 2020 2020  str].    ):.    
-00004d40: 2020 2020 7575 6964 203d 2061 7761 6974      uuid = await
-00004d50: 2075 706c 6f61 645f 6e6f 7465 626f 6f6b   upload_notebook
-00004d60: 2863 6c69 656e 742c 2073 7570 6572 7573  (client, superus
-00004d70: 6572 5f74 6f6b 656e 5f68 6561 6465 7273  er_token_headers
-00004d80: 290a 0a20 2020 2020 2020 2061 7379 6e63  )..        async
-00004d90: 2077 6974 6820 636c 6965 6e74 2e77 6562   with client.web
-00004da0: 736f 636b 6574 5f63 6f6e 6e65 6374 280a  socket_connect(.
-00004db0: 2020 2020 2020 2020 2020 2020 6622 2f6e              f"/n
-00004dc0: 6f74 6562 6f6f 6b73 2f7b 7575 6964 7d2f  otebooks/{uuid}/
-00004dd0: 7773 2f6e 6f74 6562 6f6f 6b22 2c20 6865  ws/notebook", he
-00004de0: 6164 6572 733d 7375 7065 7275 7365 725f  aders=superuser_
-00004df0: 746f 6b65 6e5f 6865 6164 6572 730a 2020  token_headers.  
-00004e00: 2020 2020 2020 2920 6173 2077 6562 736f        ) as webso
-00004e10: 636b 6574 3a0a 2020 2020 2020 2020 2020  cket:.          
-00004e20: 2020 6177 6169 7420 6173 796e 6369 6f2e    await asyncio.
-00004e30: 736c 6565 7028 5745 4253 4f43 4b45 545f  sleep(WEBSOCKET_
-00004e40: 534c 4545 505f 5449 4d45 290a 2020 2020  SLEEP_TIME).    
-00004e50: 2020 2020 2020 2020 7061 7261 6d73 203d          params =
-00004e60: 207b 0a20 2020 2020 2020 2020 2020 2020   {.             
-00004e70: 2020 2022 6365 6c6c 5f74 7970 6522 3a20     "cell_type": 
-00004e80: 226d 6172 6b64 6f77 6e22 2c0a 2020 2020  "markdown",.    
-00004e90: 2020 2020 2020 2020 2020 2020 2273 6f75              "sou
-00004ea0: 7263 6522 3a20 225f 5f2a 2a48 656c 6c6f  rce": "__**Hello
-00004eb0: 2043 616c 6c69 7374 6f21 2a2a 5f5f 222c   Callisto!**__",
-00004ec0: 0a20 2020 2020 2020 2020 2020 207d 0a20  .            }. 
-00004ed0: 2020 2020 2020 2020 2020 2072 6573 706f             respo
-00004ee0: 6e73 6520 3d20 6177 6169 7420 636c 6965  nse = await clie
-00004ef0: 6e74 2e70 6f73 7428 0a20 2020 2020 2020  nt.post(.       
-00004f00: 2020 2020 2020 2020 2066 222f 6e6f 7465           f"/note
-00004f10: 626f 6f6b 732f 7b75 7569 647d 2f63 656c  books/{uuid}/cel
-00004f20: 6c73 222c 0a20 2020 2020 2020 2020 2020  ls",.           
-00004f30: 2020 2020 206a 736f 6e3d 7061 7261 6d73       json=params
-00004f40: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
-00004f50: 2020 6865 6164 6572 733d 7375 7065 7275    headers=superu
-00004f60: 7365 725f 746f 6b65 6e5f 6865 6164 6572  ser_token_header
-00004f70: 732c 0a20 2020 2020 2020 2020 2020 2029  s,.            )
-00004f80: 0a20 2020 2020 2020 2020 2020 2061 7373  .            ass
-00004f90: 6572 7420 7265 7370 6f6e 7365 2e73 7461  ert response.sta
-00004fa0: 7475 735f 636f 6465 203d 3d20 3230 310a  tus_code == 201.
-00004fb0: 0a20 2020 2020 2020 2020 2020 2064 6174  .            dat
-00004fc0: 6120 3d20 6177 6169 7420 7265 6365 6976  a = await receiv
-00004fd0: 655f 6a73 6f6e 2877 6562 736f 636b 6574  e_json(websocket
-00004fe0: 2c20 6d73 675f 7479 7065 733d 5b22 6365  , msg_types=["ce
-00004ff0: 6c6c 5f61 6464 225d 290a 2020 2020 2020  ll_add"]).      
-00005000: 2020 2020 2020 6365 6c6c 7320 3d20 6461        cells = da
-00005010: 7461 5b22 6365 6c6c 5f61 6464 225d 0a20  ta["cell_add"]. 
-00005020: 2020 2020 2020 2020 2020 2061 7373 6572             asser
-00005030: 7420 6c65 6e28 6365 6c6c 7329 203d 3d20  t len(cells) == 
-00005040: 3520 2023 2073 686f 756c 6420 6475 6d70  5  # should dump
-00005050: 2061 6c6c 2074 6865 2063 656c 6c73 0a20   all the cells. 
-00005060: 2020 2020 2020 2020 2020 2063 656c 6c20             cell 
-00005070: 3d20 6365 6c6c 735b 2d31 5d0a 2020 2020  = cells[-1].    
-00005080: 2020 2020 2020 2020 6365 6c6c 5f75 7569          cell_uui
-00005090: 6420 3d20 6365 6c6c 5b22 6d65 7461 6461  d = cell["metada
-000050a0: 7461 225d 5b22 6a75 7079 7465 725f 6431  ta"]["jupyter_d1
-000050b0: 225d 5b22 7575 6964 225d 0a0a 2020 2020  "]["uuid"]..    
-000050c0: 2020 2020 2020 2020 6578 7065 6374 6564          expected
-000050d0: 203d 207b 0a20 2020 2020 2020 2020 2020   = {.           
-000050e0: 2020 2020 2022 6365 6c6c 5f74 7970 6522       "cell_type"
-000050f0: 3a20 226d 6172 6b64 6f77 6e22 2c0a 2020  : "markdown",.  
-00005100: 2020 2020 2020 2020 2020 2020 2020 226d                "m
-00005110: 6574 6164 6174 6122 3a20 7b0a 2020 2020  etadata": {.    
-00005120: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00005130: 226a 7570 7974 6572 5f64 3122 3a20 7b0a  "jupyter_d1": {.
-00005140: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00005150: 2020 2020 2020 2020 2270 6f73 6974 696f          "positio
-00005160: 6e22 3a20 342c 0a20 2020 2020 2020 2020  n": 4,.         
-00005170: 2020 2020 2020 2020 2020 2020 2020 2022                 "
-00005180: 7575 6964 223a 2063 656c 6c5f 7575 6964  uuid": cell_uuid
-00005190: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
-000051a0: 2020 2020 2020 2020 2020 226e 6f74 6562            "noteb
-000051b0: 6f6f 6b5f 7575 6964 223a 2075 7569 642c  ook_uuid": uuid,
-000051c0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-000051d0: 2020 2020 207d 0a20 2020 2020 2020 2020       }.         
-000051e0: 2020 2020 2020 207d 2c0a 2020 2020 2020         },.      
-000051f0: 2020 2020 2020 2020 2020 2273 6f75 7263            "sourc
-00005200: 6522 3a20 225f 5f2a 2a48 656c 6c6f 2043  e": "__**Hello C
-00005210: 616c 6c69 7374 6f21 2a2a 5f5f 222c 0a20  allisto!**__",. 
-00005220: 2020 2020 2020 2020 2020 207d 0a0a 2020             }..  
-00005230: 2020 2020 2020 2020 2020 2320 6672 6f6d            # from
-00005240: 2070 7072 696e 7420 696d 706f 7274 2070   pprint import p
-00005250: 7072 696e 740a 2020 2020 2020 2020 2020  print.          
-00005260: 2020 2320 7072 696e 7428 2264 6174 6122    # print("data"
-00005270: 290a 2020 2020 2020 2020 2020 2020 2320  ).            # 
-00005280: 7070 7269 6e74 2864 6174 6129 0a20 2020  pprint(data).   
-00005290: 2020 2020 2020 2020 2023 2070 7269 6e74           # print
-000052a0: 2822 6578 7065 6374 6564 2229 0a20 2020  ("expected").   
-000052b0: 2020 2020 2020 2020 2023 2070 7072 696e           # pprin
-000052c0: 7428 6578 7065 6374 6564 290a 2020 2020  t(expected).    
-000052d0: 2020 2020 2020 2020 636f 6d70 6172 655f          compare_
-000052e0: 6365 6c6c 7328 6365 6c6c 2c20 6578 7065  cells(cell, expe
-000052f0: 6374 6564 290a 0a20 2020 2040 7079 7465  cted)..    @pyte
-00005300: 7374 2e6d 6172 6b2e 6173 796e 6369 6f0a  st.mark.asyncio.
-00005310: 2020 2020 6173 796e 6320 6465 6620 7465      async def te
-00005320: 7374 5f6e 6f74 6562 6f6f 6b5f 6365 6c6c  st_notebook_cell
-00005330: 5f70 6174 6368 280a 2020 2020 2020 2020  _patch(.        
-00005340: 7365 6c66 2c20 636c 6965 6e74 3a20 5465  self, client: Te
-00005350: 7374 436c 6965 6e74 2c20 7375 7065 7275  stClient, superu
-00005360: 7365 725f 746f 6b65 6e5f 6865 6164 6572  ser_token_header
-00005370: 733a 2044 6963 745b 7374 722c 2073 7472  s: Dict[str, str
-00005380: 5d0a 2020 2020 293a 0a20 2020 2020 2020  ].    ):.       
-00005390: 2075 7569 6420 3d20 6177 6169 7420 7570   uuid = await up
-000053a0: 6c6f 6164 5f6e 6f74 6562 6f6f 6b28 636c  load_notebook(cl
-000053b0: 6965 6e74 2c20 7375 7065 7275 7365 725f  ient, superuser_
-000053c0: 746f 6b65 6e5f 6865 6164 6572 7329 0a0a  token_headers)..
-000053d0: 2020 2020 2020 2020 6173 796e 6320 7769          async wi
-000053e0: 7468 2063 6c69 656e 742e 7765 6273 6f63  th client.websoc
-000053f0: 6b65 745f 636f 6e6e 6563 7428 0a20 2020  ket_connect(.   
-00005400: 2020 2020 2020 2020 2066 222f 6e6f 7465           f"/note
-00005410: 626f 6f6b 732f 7b75 7569 647d 2f77 732f  books/{uuid}/ws/
-00005420: 6e6f 7465 626f 6f6b 222c 2068 6561 6465  notebook", heade
-00005430: 7273 3d73 7570 6572 7573 6572 5f74 6f6b  rs=superuser_tok
-00005440: 656e 5f68 6561 6465 7273 0a20 2020 2020  en_headers.     
-00005450: 2020 2029 2061 7320 7765 6273 6f63 6b65     ) as websocke
-00005460: 743a 0a20 2020 2020 2020 2020 2020 2061  t:.            a
-00005470: 7761 6974 2061 7379 6e63 696f 2e73 6c65  wait asyncio.sle
-00005480: 6570 2857 4542 534f 434b 4554 5f53 4c45  ep(WEBSOCKET_SLE
-00005490: 4550 5f54 494d 4529 0a0a 2020 2020 2020  EP_TIME)..      
-000054a0: 2020 2020 2020 2320 6765 7420 616e 2065        # get an e
-000054b0: 7869 7374 696e 6720 6365 6c6c 0a20 2020  xisting cell.   
-000054c0: 2020 2020 2020 2020 2072 6573 706f 6e73           respons
-000054d0: 6520 3d20 6177 6169 7420 636c 6965 6e74  e = await client
-000054e0: 2e67 6574 280a 2020 2020 2020 2020 2020  .get(.          
-000054f0: 2020 2020 2020 6622 2f6e 6f74 6562 6f6f        f"/noteboo
-00005500: 6b73 2f7b 7575 6964 7d2f 6365 6c6c 7322  ks/{uuid}/cells"
-00005510: 2c20 6865 6164 6572 733d 7375 7065 7275  , headers=superu
-00005520: 7365 725f 746f 6b65 6e5f 6865 6164 6572  ser_token_header
-00005530: 730a 2020 2020 2020 2020 2020 2020 290a  s.            ).
-00005540: 2020 2020 2020 2020 2020 2020 6173 7365              asse
-00005550: 7274 2072 6573 706f 6e73 652e 7374 6174  rt response.stat
-00005560: 7573 5f63 6f64 6520 3d3d 2032 3030 0a20  us_code == 200. 
-00005570: 2020 2020 2020 2020 2020 2063 656c 6c73             cells
-00005580: 203d 2072 6573 706f 6e73 652e 6a73 6f6e   = response.json
-00005590: 2829 5b22 6365 6c6c 7322 5d0a 2020 2020  ()["cells"].    
-000055a0: 2020 2020 2020 2020 6173 7365 7274 2063          assert c
-000055b0: 656c 6c73 5b31 5d5b 2273 6f75 7263 6522  ells[1]["source"
-000055c0: 5d20 3d3d 2027 7072 696e 7428 224c 6172  ] == 'print("Lar
-000055d0: 7279 2074 6865 204c 6c61 6d61 2229 270a  ry the Llama")'.
-000055e0: 0a20 2020 2020 2020 2020 2020 2063 656c  .            cel
-000055f0: 6c5f 7575 6964 203d 2063 656c 6c73 5b31  l_uuid = cells[1
-00005600: 5d5b 226d 6574 6164 6174 6122 5d5b 226a  ]["metadata"]["j
-00005610: 7570 7974 6572 5f64 3122 5d5b 2275 7569  upyter_d1"]["uui
-00005620: 6422 5d0a 2020 2020 2020 2020 2020 2020  d"].            
-00005630: 7061 7261 6d73 203d 207b 2273 6f75 7263  params = {"sourc
-00005640: 6522 3a20 225f 5f42 616e 616e 6120 5261  e": "__Banana Ra
-00005650: 6d61 215f 5f22 7d0a 2020 2020 2020 2020  ma!__"}.        
-00005660: 2020 2020 7265 7370 6f6e 7365 203d 2061      response = a
-00005670: 7761 6974 2063 6c69 656e 742e 7061 7463  wait client.patc
-00005680: 6828 0a20 2020 2020 2020 2020 2020 2020  h(.             
-00005690: 2020 2066 222f 6e6f 7465 626f 6f6b 732f     f"/notebooks/
-000056a0: 7b75 7569 647d 2f63 656c 6c73 2f7b 6365  {uuid}/cells/{ce
-000056b0: 6c6c 5f75 7569 647d 222c 0a20 2020 2020  ll_uuid}",.     
-000056c0: 2020 2020 2020 2020 2020 206a 736f 6e3d             json=
-000056d0: 7061 7261 6d73 2c0a 2020 2020 2020 2020  params,.        
-000056e0: 2020 2020 2020 2020 6865 6164 6572 733d          headers=
-000056f0: 7375 7065 7275 7365 725f 746f 6b65 6e5f  superuser_token_
-00005700: 6865 6164 6572 732c 0a20 2020 2020 2020  headers,.       
-00005710: 2020 2020 2029 0a20 2020 2020 2020 2020       ).         
-00005720: 2020 2061 7373 6572 7420 7265 7370 6f6e     assert respon
-00005730: 7365 2e73 7461 7475 735f 636f 6465 203d  se.status_code =
-00005740: 3d20 3230 300a 0a20 2020 2020 2020 2020  = 200..         
-00005750: 2020 2064 6174 6120 3d20 6177 6169 7420     data = await 
-00005760: 7265 6365 6976 655f 6a73 6f6e 2877 6562  receive_json(web
-00005770: 736f 636b 6574 290a 2020 2020 2020 2020  socket).        
-00005780: 2020 2020 6365 6c6c 7320 3d20 6461 7461      cells = data
-00005790: 5b22 6365 6c6c 5f75 7064 6174 6522 5d0a  ["cell_update"].
-000057a0: 2020 2020 2020 2020 2020 2020 6173 7365              asse
-000057b0: 7274 206c 656e 2863 656c 6c73 2920 3d3d  rt len(cells) ==
-000057c0: 2031 0a20 2020 2020 2020 2020 2020 2063   1.            c
-000057d0: 656c 6c20 3d20 6365 6c6c 735b 305d 0a0a  ell = cells[0]..
-000057e0: 2020 2020 2020 2020 2020 2020 6578 7065              expe
-000057f0: 6374 6564 203d 207b 0a20 2020 2020 2020  cted = {.       
-00005800: 2020 2020 2020 2020 2022 6365 6c6c 5f74           "cell_t
-00005810: 7970 6522 3a20 2263 6f64 6522 2c0a 2020  ype": "code",.  
-00005820: 2020 2020 2020 2020 2020 2020 2020 2265                "e
-00005830: 7865 6375 7469 6f6e 5f63 6f75 6e74 223a  xecution_count":
-00005840: 204e 6f6e 652c 0a20 2020 2020 2020 2020   None,.         
-00005850: 2020 2020 2020 2022 6d65 7461 6461 7461         "metadata
-00005860: 223a 207b 0a20 2020 2020 2020 2020 2020  ": {.           
-00005870: 2020 2020 2020 2020 2022 6a75 7079 7465           "jupyte
-00005880: 725f 6431 223a 207b 0a20 2020 2020 2020  r_d1": {.       
-00005890: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000058a0: 2022 6578 6563 7574 696f 6e5f 7374 6174   "execution_stat
-000058b0: 6522 3a20 2269 646c 6522 2c0a 2020 2020  e": "idle",.    
-000058c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000058d0: 2020 2020 2270 6f73 6974 696f 6e22 3a20      "position": 
-000058e0: 312c 0a20 2020 2020 2020 2020 2020 2020  1,.             
-000058f0: 2020 2020 2020 2020 2020 2022 6e6f 7465             "note
-00005900: 626f 6f6b 5f75 7569 6422 3a20 7575 6964  book_uuid": uuid
-00005910: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
-00005920: 2020 2020 2020 2020 2020 2275 7569 6422            "uuid"
-00005930: 3a20 6365 6c6c 5f75 7569 642c 0a20 2020  : cell_uuid,.   
-00005940: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00005950: 207d 0a20 2020 2020 2020 2020 2020 2020   }.             
-00005960: 2020 207d 2c0a 2020 2020 2020 2020 2020     },.          
-00005970: 2020 2020 2020 226f 7574 7075 7473 223a        "outputs":
-00005980: 205b 0a20 2020 2020 2020 2020 2020 2020   [.             
-00005990: 2020 2020 2020 207b 0a20 2020 2020 2020         {.       
-000059a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000059b0: 2022 6e61 6d65 223a 2022 7374 646f 7574   "name": "stdout
-000059c0: 222c 0a20 2020 2020 2020 2020 2020 2020  ",.             
-000059d0: 2020 2020 2020 2020 2020 2022 6f75 7470             "outp
-000059e0: 7574 5f74 7970 6522 3a20 2273 7472 6561  ut_type": "strea
-000059f0: 6d22 2c0a 2020 2020 2020 2020 2020 2020  m",.            
-00005a00: 2020 2020 2020 2020 2020 2020 2274 6578              "tex
-00005a10: 7422 3a20 224c 6172 7279 2074 6865 204c  t": "Larry the L
-00005a20: 6c61 6d61 5c6e 222c 0a20 2020 2020 2020  lama\n",.       
-00005a30: 2020 2020 2020 2020 2020 2020 207d 0a20               }. 
-00005a40: 2020 2020 2020 2020 2020 2020 2020 205d                 ]
-00005a50: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
-00005a60: 2020 2273 6f75 7263 6522 3a20 225f 5f42    "source": "__B
-00005a70: 616e 616e 6120 5261 6d61 215f 5f22 2c0a  anana Rama!__",.
-00005a80: 2020 2020 2020 2020 2020 2020 7d0a 0a20              }.. 
-00005a90: 2020 2020 2020 2020 2020 2061 7373 6572             asser
-00005aa0: 7420 6365 6c6c 203d 3d20 6578 7065 6374  t cell == expect
-00005ab0: 6564 0a0a 2020 2020 4070 7974 6573 742e  ed..    @pytest.
-00005ac0: 6d61 726b 2e61 7379 6e63 696f 0a20 2020  mark.asyncio.   
-00005ad0: 2061 7379 6e63 2064 6566 2074 6573 745f   async def test_
-00005ae0: 6e6f 7465 626f 6f6b 5f63 656c 6c5f 6465  notebook_cell_de
-00005af0: 6c65 7465 280a 2020 2020 2020 2020 7365  lete(.        se
-00005b00: 6c66 2c20 636c 6965 6e74 3a20 5465 7374  lf, client: Test
-00005b10: 436c 6965 6e74 2c20 7375 7065 7275 7365  Client, superuse
-00005b20: 725f 746f 6b65 6e5f 6865 6164 6572 733a  r_token_headers:
-00005b30: 2044 6963 745b 7374 722c 2073 7472 5d0a   Dict[str, str].
-00005b40: 2020 2020 293a 0a20 2020 2020 2020 2075      ):.        u
-00005b50: 7569 6420 3d20 6177 6169 7420 7570 6c6f  uid = await uplo
-00005b60: 6164 5f6e 6f74 6562 6f6f 6b28 636c 6965  ad_notebook(clie
-00005b70: 6e74 2c20 7375 7065 7275 7365 725f 746f  nt, superuser_to
-00005b80: 6b65 6e5f 6865 6164 6572 7329 0a0a 2020  ken_headers)..  
-00005b90: 2020 2020 2020 7265 7370 6f6e 7365 203d        response =
-00005ba0: 2061 7761 6974 2063 6c69 656e 742e 6765   await client.ge
-00005bb0: 7428 0a20 2020 2020 2020 2020 2020 2066  t(.            f
-00005bc0: 222f 6e6f 7465 626f 6f6b 732f 7b75 7569  "/notebooks/{uui
-00005bd0: 647d 2f63 656c 6c73 222c 2068 6561 6465  d}/cells", heade
-00005be0: 7273 3d73 7570 6572 7573 6572 5f74 6f6b  rs=superuser_tok
-00005bf0: 656e 5f68 6561 6465 7273 0a20 2020 2020  en_headers.     
-00005c00: 2020 2029 0a20 2020 2020 2020 2061 7373     ).        ass
-00005c10: 6572 7420 7265 7370 6f6e 7365 2e73 7461  ert response.sta
-00005c20: 7475 735f 636f 6465 203d 3d20 3230 300a  tus_code == 200.
-00005c30: 2020 2020 2020 2020 6365 6c6c 7320 3d20          cells = 
-00005c40: 7265 7370 6f6e 7365 2e6a 736f 6e28 295b  response.json()[
-00005c50: 2263 656c 6c73 225d 0a0a 2020 2020 2020  "cells"]..      
-00005c60: 2020 6365 6c6c 203d 2063 656c 6c73 5b32    cell = cells[2
-00005c70: 5d0a 2020 2020 2020 2020 6365 6c6c 5f75  ].        cell_u
-00005c80: 7569 6420 3d20 6365 6c6c 5b22 6d65 7461  uid = cell["meta
-00005c90: 6461 7461 225d 5b22 6a75 7079 7465 725f  data"]["jupyter_
-00005ca0: 6431 225d 5b22 7575 6964 225d 0a0a 2020  d1"]["uuid"]..  
-00005cb0: 2020 2020 2020 6173 7365 7274 2063 656c        assert cel
-00005cc0: 6c73 5b33 5d5b 226d 6574 6164 6174 6122  ls[3]["metadata"
-00005cd0: 5d5b 226a 7570 7974 6572 5f64 3122 5d5b  ]["jupyter_d1"][
-00005ce0: 2270 6f73 6974 696f 6e22 5d20 3d3d 2033  "position"] == 3
-00005cf0: 0a0a 2020 2020 2020 2020 6173 796e 6320  ..        async 
-00005d00: 7769 7468 2063 6c69 656e 742e 7765 6273  with client.webs
-00005d10: 6f63 6b65 745f 636f 6e6e 6563 7428 0a20  ocket_connect(. 
-00005d20: 2020 2020 2020 2020 2020 2066 222f 6e6f             f"/no
-00005d30: 7465 626f 6f6b 732f 7b75 7569 647d 2f77  tebooks/{uuid}/w
-00005d40: 732f 6e6f 7465 626f 6f6b 222c 2068 6561  s/notebook", hea
-00005d50: 6465 7273 3d73 7570 6572 7573 6572 5f74  ders=superuser_t
-00005d60: 6f6b 656e 5f68 6561 6465 7273 0a20 2020  oken_headers.   
-00005d70: 2020 2020 2029 2061 7320 7765 6273 6f63       ) as websoc
-00005d80: 6b65 743a 0a20 2020 2020 2020 2020 2020  ket:.           
-00005d90: 2061 7761 6974 2061 7379 6e63 696f 2e73   await asyncio.s
-00005da0: 6c65 6570 2857 4542 534f 434b 4554 5f53  leep(WEBSOCKET_S
-00005db0: 4c45 4550 5f54 494d 4529 0a0a 2020 2020  LEEP_TIME)..    
-00005dc0: 2020 2020 2020 2020 7265 7370 6f6e 7365          response
-00005dd0: 203d 2061 7761 6974 2063 6c69 656e 742e   = await client.
-00005de0: 6465 6c65 7465 280a 2020 2020 2020 2020  delete(.        
-00005df0: 2020 2020 2020 2020 6622 2f6e 6f74 6562          f"/noteb
-00005e00: 6f6f 6b73 2f7b 7575 6964 7d2f 6365 6c6c  ooks/{uuid}/cell
-00005e10: 732f 7b63 656c 6c5f 7575 6964 7d22 2c0a  s/{cell_uuid}",.
-00005e20: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00005e30: 6865 6164 6572 733d 7375 7065 7275 7365  headers=superuse
-00005e40: 725f 746f 6b65 6e5f 6865 6164 6572 732c  r_token_headers,
-00005e50: 0a20 2020 2020 2020 2020 2020 2029 0a20  .            ). 
-00005e60: 2020 2020 2020 2020 2020 2061 7373 6572             asser
-00005e70: 7420 7265 7370 6f6e 7365 2e73 7461 7475  t response.statu
-00005e80: 735f 636f 6465 203d 3d20 3230 340a 0a20  s_code == 204.. 
-00005e90: 2020 2020 2020 2020 2020 2064 6174 6120             data 
-00005ea0: 3d20 6177 6169 7420 7265 6365 6976 655f  = await receive_
-00005eb0: 6a73 6f6e 2877 6562 736f 636b 6574 290a  json(websocket).
-00005ec0: 0a20 2020 2020 2020 2020 2020 2064 656c  .            del
-00005ed0: 2063 656c 6c73 5b32 5d0a 2020 2020 2020   cells[2].      
-00005ee0: 2020 2020 2020 6365 6c6c 735b 325d 5b22        cells[2]["
-00005ef0: 6d65 7461 6461 7461 225d 5b22 6a75 7079  metadata"]["jupy
-00005f00: 7465 725f 6431 225d 5b22 706f 7369 7469  ter_d1"]["positi
-00005f10: 6f6e 225d 203d 2032 0a20 2020 2020 2020  on"] = 2.       
-00005f20: 2020 2020 2065 7870 6563 7465 6420 3d20       expected = 
-00005f30: 7b22 6365 6c6c 5f64 656c 6574 6522 3a20  {"cell_delete": 
-00005f40: 6365 6c6c 737d 0a0a 2020 2020 2020 2020  cells}..        
-00005f50: 2020 2020 6173 7365 7274 2064 6174 6120      assert data 
-00005f60: 3d3d 2065 7870 6563 7465 640a 0a20 2020  == expected..   
-00005f70: 2040 7079 7465 7374 2e6d 6172 6b2e 6173   @pytest.mark.as
-00005f80: 796e 6369 6f0a 2020 2020 6173 796e 6320  yncio.    async 
-00005f90: 6465 6620 7465 7374 5f6e 6f74 6562 6f6f  def test_noteboo
-00005fa0: 6b5f 6365 6c6c 5f6d 6f76 6528 0a20 2020  k_cell_move(.   
-00005fb0: 2020 2020 2073 656c 662c 2063 6c69 656e       self, clien
-00005fc0: 743a 2054 6573 7443 6c69 656e 742c 2073  t: TestClient, s
-00005fd0: 7570 6572 7573 6572 5f74 6f6b 656e 5f68  uperuser_token_h
-00005fe0: 6561 6465 7273 3a20 4469 6374 5b73 7472  eaders: Dict[str
-00005ff0: 2c20 7374 725d 0a20 2020 2029 3a0a 2020  , str].    ):.  
-00006000: 2020 2020 2020 7575 6964 203d 2061 7761        uuid = awa
-00006010: 6974 2075 706c 6f61 645f 6e6f 7465 626f  it upload_notebo
-00006020: 6f6b 2863 6c69 656e 742c 2073 7570 6572  ok(client, super
-00006030: 7573 6572 5f74 6f6b 656e 5f68 6561 6465  user_token_heade
-00006040: 7273 290a 0a20 2020 2020 2020 2061 7379  rs)..        asy
-00006050: 6e63 2077 6974 6820 636c 6965 6e74 2e77  nc with client.w
-00006060: 6562 736f 636b 6574 5f63 6f6e 6e65 6374  ebsocket_connect
-00006070: 280a 2020 2020 2020 2020 2020 2020 6622  (.            f"
-00006080: 2f6e 6f74 6562 6f6f 6b73 2f7b 7575 6964  /notebooks/{uuid
-00006090: 7d2f 7773 2f6e 6f74 6562 6f6f 6b22 2c20  }/ws/notebook", 
-000060a0: 6865 6164 6572 733d 7375 7065 7275 7365  headers=superuse
-000060b0: 725f 746f 6b65 6e5f 6865 6164 6572 730a  r_token_headers.
-000060c0: 2020 2020 2020 2020 2920 6173 2077 6562          ) as web
-000060d0: 736f 636b 6574 3a0a 2020 2020 2020 2020  socket:.        
-000060e0: 2020 2020 6177 6169 7420 6173 796e 6369      await asynci
-000060f0: 6f2e 736c 6565 7028 5745 4253 4f43 4b45  o.sleep(WEBSOCKE
-00006100: 545f 534c 4545 505f 5449 4d45 290a 0a20  T_SLEEP_TIME).. 
-00006110: 2020 2020 2020 2020 2020 2023 2067 6574             # get
-00006120: 2074 6865 2065 7869 7374 696e 6720 6365   the existing ce
-00006130: 6c6c 730a 2020 2020 2020 2020 2020 2020  lls.            
-00006140: 7265 7370 6f6e 7365 203d 2061 7761 6974  response = await
-00006150: 2063 6c69 656e 742e 6765 7428 0a20 2020   client.get(.   
-00006160: 2020 2020 2020 2020 2020 2020 2066 222f               f"/
-00006170: 6e6f 7465 626f 6f6b 732f 7b75 7569 647d  notebooks/{uuid}
-00006180: 2f63 656c 6c73 222c 2068 6561 6465 7273  /cells", headers
-00006190: 3d73 7570 6572 7573 6572 5f74 6f6b 656e  =superuser_token
-000061a0: 5f68 6561 6465 7273 0a20 2020 2020 2020  _headers.       
-000061b0: 2020 2020 2029 0a20 2020 2020 2020 2020       ).         
-000061c0: 2020 2061 7373 6572 7420 7265 7370 6f6e     assert respon
-000061d0: 7365 2e73 7461 7475 735f 636f 6465 203d  se.status_code =
-000061e0: 3d20 3230 300a 2020 2020 2020 2020 2020  = 200.          
-000061f0: 2020 6365 6c6c 7320 3d20 7265 7370 6f6e    cells = respon
-00006200: 7365 2e6a 736f 6e28 295b 2263 656c 6c73  se.json()["cells
-00006210: 225d 0a20 2020 2020 2020 2020 2020 206f  "].            o
-00006220: 7269 675f 7575 6964 7320 3d20 6c69 7374  rig_uuids = list
-00006230: 280a 2020 2020 2020 2020 2020 2020 2020  (.              
-00006240: 2020 6d61 7028 6c61 6d62 6461 2078 3a20    map(lambda x: 
-00006250: 785b 226d 6574 6164 6174 6122 5d5b 226a  x["metadata"]["j
-00006260: 7570 7974 6572 5f64 3122 5d5b 2275 7569  upyter_d1"]["uui
-00006270: 6422 5d2c 2063 656c 6c73 290a 2020 2020  d"], cells).    
-00006280: 2020 2020 2020 2020 290a 0a20 2020 2020          )..     
-00006290: 2020 2020 2020 2023 206d 6f76 6520 7468         # move th
-000062a0: 6520 6c61 7374 2063 656c 6c20 746f 2062  e last cell to b
-000062b0: 6566 6f72 6520 7468 6520 6669 7273 7420  efore the first 
-000062c0: 6365 6c6c 0a20 2020 2020 2020 2020 2020  cell.           
-000062d0: 2062 6566 6f72 655f 7575 6964 203d 206f   before_uuid = o
-000062e0: 7269 675f 7575 6964 735b 315d 0a20 2020  rig_uuids[1].   
-000062f0: 2020 2020 2020 2020 206d 6f76 655f 7575           move_uu
-00006300: 6964 203d 206f 7269 675f 7575 6964 735b  id = orig_uuids[
-00006310: 335d 0a0a 2020 2020 2020 2020 2020 2020  3]..            
-00006320: 7061 7261 6d73 203d 207b 2262 6566 6f72  params = {"befor
-00006330: 6522 3a20 6265 666f 7265 5f75 7569 647d  e": before_uuid}
-00006340: 0a20 2020 2020 2020 2020 2020 2072 6573  .            res
-00006350: 706f 6e73 6520 3d20 6177 6169 7420 636c  ponse = await cl
-00006360: 6965 6e74 2e67 6574 280a 2020 2020 2020  ient.get(.      
-00006370: 2020 2020 2020 2020 2020 6622 2f6e 6f74            f"/not
-00006380: 6562 6f6f 6b73 2f7b 7575 6964 7d2f 6365  ebooks/{uuid}/ce
-00006390: 6c6c 732f 7b6d 6f76 655f 7575 6964 7d2f  lls/{move_uuid}/
-000063a0: 6d6f 7665 222c 0a20 2020 2020 2020 2020  move",.         
-000063b0: 2020 2020 2020 2071 7565 7279 5f73 7472         query_str
-000063c0: 696e 673d 7061 7261 6d73 2c0a 2020 2020  ing=params,.    
-000063d0: 2020 2020 2020 2020 2020 2020 6865 6164              head
-000063e0: 6572 733d 7375 7065 7275 7365 725f 746f  ers=superuser_to
-000063f0: 6b65 6e5f 6865 6164 6572 732c 0a20 2020  ken_headers,.   
-00006400: 2020 2020 2020 2020 2029 0a20 2020 2020           ).     
-00006410: 2020 2020 2020 2061 7373 6572 7420 7265         assert re
-00006420: 7370 6f6e 7365 2e73 7461 7475 735f 636f  sponse.status_co
-00006430: 6465 203d 3d20 3230 340a 0a20 2020 2020  de == 204..     
-00006440: 2020 2020 2020 2064 6174 6120 3d20 6177         data = aw
-00006450: 6169 7420 7265 6365 6976 655f 6a73 6f6e  ait receive_json
-00006460: 2877 6562 736f 636b 6574 290a 2020 2020  (websocket).    
-00006470: 2020 2020 2020 2020 6365 6c6c 7320 3d20          cells = 
-00006480: 6461 7461 5b22 6365 6c6c 5f75 7064 6174  data["cell_updat
-00006490: 6522 5d0a 2020 2020 2020 2020 2020 2020  e"].            
-000064a0: 6173 7365 7274 206c 656e 2863 656c 6c73  assert len(cells
-000064b0: 2920 3d3d 2034 2020 2320 7368 6f75 6c64  ) == 4  # should
-000064c0: 2064 756d 7020 616c 6c20 7468 6520 6365   dump all the ce
-000064d0: 6c6c 730a 0a20 2020 2020 2020 2020 2020  lls..           
-000064e0: 206e 6577 5f75 7569 6473 203d 205b 5d0a   new_uuids = [].
-000064f0: 2020 2020 2020 2020 2020 2020 666f 7220              for 
-00006500: 6365 6c6c 2069 6e20 6365 6c6c 733a 0a20  cell in cells:. 
-00006510: 2020 2020 2020 2020 2020 2020 2020 2075                 u
-00006520: 7569 6420 3d20 6365 6c6c 5b22 6d65 7461  uid = cell["meta
-00006530: 6461 7461 225d 5b22 6a75 7079 7465 725f  data"]["jupyter_
-00006540: 6431 225d 5b22 7575 6964 225d 0a20 2020  d1"]["uuid"].   
-00006550: 2020 2020 2020 2020 2020 2020 206e 6577               new
-00006560: 5f75 7569 6473 2e61 7070 656e 6428 7575  _uuids.append(uu
-00006570: 6964 290a 0a20 2020 2020 2020 2020 2020  id)..           
-00006580: 2065 7870 6563 7465 645f 7575 6964 7320   expected_uuids 
-00006590: 3d20 5b0a 2020 2020 2020 2020 2020 2020  = [.            
-000065a0: 2020 2020 6f72 6967 5f75 7569 6473 5b30      orig_uuids[0
-000065b0: 5d2c 0a20 2020 2020 2020 2020 2020 2020  ],.             
-000065c0: 2020 206f 7269 675f 7575 6964 735b 335d     orig_uuids[3]
-000065d0: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
-000065e0: 2020 6f72 6967 5f75 7569 6473 5b31 5d2c    orig_uuids[1],
-000065f0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00006600: 206f 7269 675f 7575 6964 735b 325d 2c0a   orig_uuids[2],.
-00006610: 2020 2020 2020 2020 2020 2020 5d0a 2020              ].  
-00006620: 2020 2020 2020 2020 2020 6173 7365 7274            assert
-00006630: 206e 6577 5f75 7569 6473 203d 3d20 6578   new_uuids == ex
-00006640: 7065 6374 6564 5f75 7569 6473 0a0a 2020  pected_uuids..  
-00006650: 2020 2020 2020 2020 2020 2320 4368 6563            # Chec
-00006660: 6b20 6365 6c6c 2070 6f73 6974 696f 6e73  k cell positions
-00006670: 0a20 2020 2020 2020 2020 2020 2061 7373  .            ass
-00006680: 6572 745f 6365 6c6c 5f70 6f73 6974 696f  ert_cell_positio
-00006690: 6e73 2863 656c 6c73 290a 0a20 2020 2040  ns(cells)..    @
-000066a0: 7079 7465 7374 2e6d 6172 6b2e 6173 796e  pytest.mark.asyn
-000066b0: 6369 6f0a 2020 2020 6173 796e 6320 6465  cio.    async de
-000066c0: 6620 7465 7374 5f6e 6f74 6562 6f6f 6b5f  f test_notebook_
-000066d0: 6365 6c6c 735f 6d65 7267 6528 0a20 2020  cells_merge(.   
-000066e0: 2020 2020 2073 656c 662c 2063 6c69 656e       self, clien
-000066f0: 743a 2054 6573 7443 6c69 656e 742c 2073  t: TestClient, s
-00006700: 7570 6572 7573 6572 5f74 6f6b 656e 5f68  uperuser_token_h
-00006710: 6561 6465 7273 3a20 4469 6374 5b73 7472  eaders: Dict[str
-00006720: 2c20 7374 725d 0a20 2020 2029 3a0a 2020  , str].    ):.  
-00006730: 2020 2020 2020 7575 6964 203d 2061 7761        uuid = awa
-00006740: 6974 2075 706c 6f61 645f 6e6f 7465 626f  it upload_notebo
-00006750: 6f6b 2863 6c69 656e 742c 2073 7570 6572  ok(client, super
-00006760: 7573 6572 5f74 6f6b 656e 5f68 6561 6465  user_token_heade
-00006770: 7273 290a 0a20 2020 2020 2020 2061 7379  rs)..        asy
-00006780: 6e63 2077 6974 6820 636c 6965 6e74 2e77  nc with client.w
-00006790: 6562 736f 636b 6574 5f63 6f6e 6e65 6374  ebsocket_connect
-000067a0: 280a 2020 2020 2020 2020 2020 2020 6622  (.            f"
-000067b0: 2f6e 6f74 6562 6f6f 6b73 2f7b 7575 6964  /notebooks/{uuid
-000067c0: 7d2f 7773 2f6e 6f74 6562 6f6f 6b22 2c20  }/ws/notebook", 
-000067d0: 6865 6164 6572 733d 7375 7065 7275 7365  headers=superuse
-000067e0: 725f 746f 6b65 6e5f 6865 6164 6572 730a  r_token_headers.
-000067f0: 2020 2020 2020 2020 2920 6173 2077 6562          ) as web
-00006800: 736f 636b 6574 3a0a 2020 2020 2020 2020  socket:.        
-00006810: 2020 2020 6177 6169 7420 6173 796e 6369      await asynci
-00006820: 6f2e 736c 6565 7028 5745 4253 4f43 4b45  o.sleep(WEBSOCKE
-00006830: 545f 534c 4545 505f 5449 4d45 290a 0a20  T_SLEEP_TIME).. 
-00006840: 2020 2020 2020 2020 2020 2023 2067 6574             # get
-00006850: 2074 6865 2065 7869 7374 696e 6720 6365   the existing ce
-00006860: 6c6c 730a 2020 2020 2020 2020 2020 2020  lls.            
-00006870: 7265 7370 6f6e 7365 203d 2061 7761 6974  response = await
-00006880: 2063 6c69 656e 742e 6765 7428 0a20 2020   client.get(.   
-00006890: 2020 2020 2020 2020 2020 2020 2066 222f               f"/
-000068a0: 6e6f 7465 626f 6f6b 732f 7b75 7569 647d  notebooks/{uuid}
-000068b0: 2f63 656c 6c73 222c 2068 6561 6465 7273  /cells", headers
-000068c0: 3d73 7570 6572 7573 6572 5f74 6f6b 656e  =superuser_token
-000068d0: 5f68 6561 6465 7273 0a20 2020 2020 2020  _headers.       
-000068e0: 2020 2020 2029 0a20 2020 2020 2020 2020       ).         
-000068f0: 2020 2061 7373 6572 7420 7265 7370 6f6e     assert respon
-00006900: 7365 2e73 7461 7475 735f 636f 6465 203d  se.status_code =
-00006910: 3d20 3230 300a 2020 2020 2020 2020 2020  = 200.          
-00006920: 2020 6365 6c6c 7320 3d20 7265 7370 6f6e    cells = respon
-00006930: 7365 2e6a 736f 6e28 295b 2263 656c 6c73  se.json()["cells
-00006940: 225d 0a20 2020 2020 2020 2020 2020 2063  "].            c
-00006950: 656c 6c5f 7575 6964 203d 2063 656c 6c73  ell_uuid = cells
-00006960: 5b31 5d5b 226d 6574 6164 6174 6122 5d5b  [1]["metadata"][
-00006970: 226a 7570 7974 6572 5f64 3122 5d5b 2275  "jupyter_d1"]["u
-00006980: 7569 6422 5d0a 2020 2020 2020 2020 2020  uid"].          
-00006990: 2020 6365 6c6c 735b 325d 5b22 6d65 7461    cells[2]["meta
-000069a0: 6461 7461 225d 5b22 6a75 7079 7465 725f  data"]["jupyter_
-000069b0: 6431 225d 5b22 7575 6964 225d 0a20 2020  d1"]["uuid"].   
-000069c0: 2020 2020 2020 2020 206e 6578 745f 6365           next_ce
-000069d0: 6c6c 5f75 7569 6420 3d20 6365 6c6c 735b  ll_uuid = cells[
-000069e0: 335d 5b22 6d65 7461 6461 7461 225d 5b22  3]["metadata"]["
-000069f0: 6a75 7079 7465 725f 6431 225d 5b22 7575  jupyter_d1"]["uu
-00006a00: 6964 225d 0a20 2020 2020 2020 2020 2020  id"].           
-00006a10: 2061 7373 6572 7420 6365 6c6c 735b 315d   assert cells[1]
-00006a20: 5b22 736f 7572 6365 225d 203d 3d20 2770  ["source"] == 'p
-00006a30: 7269 6e74 2822 4c61 7272 7920 7468 6520  rint("Larry the 
-00006a40: 4c6c 616d 6122 2927 0a20 2020 2020 2020  Llama")'.       
-00006a50: 2020 2020 2061 7373 6572 7420 6365 6c6c       assert cell
-00006a60: 735b 325d 5b22 736f 7572 6365 225d 203d  s[2]["source"] =
-00006a70: 3d20 2232 2b35 220a 0a20 2020 2020 2020  = "2+5"..       
-00006a80: 2020 2020 2072 6573 706f 6e73 6520 3d20       response = 
-00006a90: 6177 6169 7420 636c 6965 6e74 2e67 6574  await client.get
-00006aa0: 280a 2020 2020 2020 2020 2020 2020 2020  (.              
-00006ab0: 2020 6622 2f6e 6f74 6562 6f6f 6b73 2f7b    f"/notebooks/{
-00006ac0: 7575 6964 7d2f 6365 6c6c 732f 7b63 656c  uuid}/cells/{cel
-00006ad0: 6c5f 7575 6964 7d2f 6d65 7267 6522 2c0a  l_uuid}/merge",.
-00006ae0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00006af0: 7175 6572 795f 7374 7269 6e67 3d7b 2261  query_string={"a
-00006b00: 626f 7665 223a 2046 616c 7365 7d2c 0a20  bove": False},. 
-00006b10: 2020 2020 2020 2020 2020 2020 2020 2068                 h
-00006b20: 6561 6465 7273 3d73 7570 6572 7573 6572  eaders=superuser
-00006b30: 5f74 6f6b 656e 5f68 6561 6465 7273 2c0a  _token_headers,.
-00006b40: 2020 2020 2020 2020 2020 2020 290a 2020              ).  
-00006b50: 2020 2020 2020 2020 2020 6173 7365 7274            assert
-00006b60: 2072 6573 706f 6e73 652e 7374 6174 7573   response.status
-00006b70: 5f63 6f64 6520 3d3d 2032 3034 0a0a 2020  _code == 204..  
-00006b80: 2020 2020 2020 2020 2020 6461 7461 203d            data =
-00006b90: 2061 7761 6974 2072 6563 6569 7665 5f6a   await receive_j
-00006ba0: 736f 6e28 7765 6273 6f63 6b65 7429 0a20  son(websocket). 
-00006bb0: 2020 2020 2020 2020 2020 2063 656c 6c73             cells
-00006bc0: 203d 2064 6174 615b 2263 656c 6c5f 6465   = data["cell_de
-00006bd0: 6c65 7465 225d 0a20 2020 2020 2020 2020  lete"].         
-00006be0: 2020 2061 7373 6572 7420 6c65 6e28 6365     assert len(ce
-00006bf0: 6c6c 7329 203d 3d20 330a 2020 2020 2020  lls) == 3.      
-00006c00: 2020 2020 2020 6173 7365 7274 2063 656c        assert cel
-00006c10: 6c73 5b31 5d5b 2273 6f75 7263 6522 5d20  ls[1]["source"] 
-00006c20: 3d3d 2027 7072 696e 7428 224c 6172 7279  == 'print("Larry
-00006c30: 2074 6865 204c 6c61 6d61 2229 5c6e 322b   the Llama")\n2+
-00006c40: 3527 0a20 2020 2020 2020 2020 2020 2061  5'.            a
-00006c50: 7373 6572 7420 6365 6c6c 735b 315d 5b22  ssert cells[1]["
-00006c60: 6d65 7461 6461 7461 225d 5b22 6a75 7079  metadata"]["jupy
-00006c70: 7465 725f 6431 225d 5b22 7575 6964 225d  ter_d1"]["uuid"]
-00006c80: 203d 3d20 6365 6c6c 5f75 7569 640a 2020   == cell_uuid.  
-00006c90: 2020 2020 2020 2020 2020 6173 7365 7274            assert
-00006ca0: 2063 656c 6c73 5b32 5d5b 2273 6f75 7263   cells[2]["sourc
-00006cb0: 6522 5d20 3d3d 2022 220a 2020 2020 2020  e"] == "".      
-00006cc0: 2020 2020 2020 6173 7365 7274 2063 656c        assert cel
-00006cd0: 6c73 5b32 5d5b 226d 6574 6164 6174 6122  ls[2]["metadata"
-00006ce0: 5d5b 226a 7570 7974 6572 5f64 3122 5d5b  ]["jupyter_d1"][
-00006cf0: 2275 7569 6422 5d20 3d3d 206e 6578 745f  "uuid"] == next_
-00006d00: 6365 6c6c 5f75 7569 640a 2020 2020 2020  cell_uuid.      
-00006d10: 2020 2020 2020 2320 4368 6563 6b20 6365        # Check ce
-00006d20: 6c6c 2070 6f73 6974 696f 6e73 0a20 2020  ll positions.   
-00006d30: 2020 2020 2020 2020 2061 7373 6572 745f           assert_
-00006d40: 6365 6c6c 5f70 6f73 6974 696f 6e73 2863  cell_positions(c
-00006d50: 656c 6c73 290a 0a20 2020 2040 7079 7465  ells)..    @pyte
-00006d60: 7374 2e6d 6172 6b2e 6173 796e 6369 6f0a  st.mark.asyncio.
-00006d70: 2020 2020 6173 796e 6320 6465 6620 7465      async def te
-00006d80: 7374 5f6e 6f74 6562 6f6f 6b5f 6365 6c6c  st_notebook_cell
-00006d90: 5f73 706c 6974 280a 2020 2020 2020 2020  _split(.        
-00006da0: 7365 6c66 2c20 636c 6965 6e74 3a20 5465  self, client: Te
-00006db0: 7374 436c 6965 6e74 2c20 7375 7065 7275  stClient, superu
-00006dc0: 7365 725f 746f 6b65 6e5f 6865 6164 6572  ser_token_header
-00006dd0: 733a 2044 6963 745b 7374 722c 2073 7472  s: Dict[str, str
-00006de0: 5d0a 2020 2020 293a 0a20 2020 2020 2020  ].    ):.       
-00006df0: 2075 7569 6420 3d20 6177 6169 7420 7570   uuid = await up
-00006e00: 6c6f 6164 5f6e 6f74 6562 6f6f 6b28 636c  load_notebook(cl
-00006e10: 6965 6e74 2c20 7375 7065 7275 7365 725f  ient, superuser_
-00006e20: 746f 6b65 6e5f 6865 6164 6572 7329 0a0a  token_headers)..
-00006e30: 2020 2020 2020 2020 6173 796e 6320 7769          async wi
-00006e40: 7468 2063 6c69 656e 742e 7765 6273 6f63  th client.websoc
-00006e50: 6b65 745f 636f 6e6e 6563 7428 0a20 2020  ket_connect(.   
-00006e60: 2020 2020 2020 2020 2066 222f 6e6f 7465           f"/note
-00006e70: 626f 6f6b 732f 7b75 7569 647d 2f77 732f  books/{uuid}/ws/
-00006e80: 6e6f 7465 626f 6f6b 222c 2068 6561 6465  notebook", heade
-00006e90: 7273 3d73 7570 6572 7573 6572 5f74 6f6b  rs=superuser_tok
-00006ea0: 656e 5f68 6561 6465 7273 0a20 2020 2020  en_headers.     
-00006eb0: 2020 2029 2061 7320 7765 6273 6f63 6b65     ) as websocke
-00006ec0: 743a 0a20 2020 2020 2020 2020 2020 2061  t:.            a
-00006ed0: 7761 6974 2061 7379 6e63 696f 2e73 6c65  wait asyncio.sle
-00006ee0: 6570 2857 4542 534f 434b 4554 5f53 4c45  ep(WEBSOCKET_SLE
-00006ef0: 4550 5f54 494d 4529 0a0a 2020 2020 2020  EP_TIME)..      
-00006f00: 2020 2020 2020 2320 6765 7420 7468 6520        # get the 
-00006f10: 6578 6973 7469 6e67 2063 656c 6c73 0a20  existing cells. 
-00006f20: 2020 2020 2020 2020 2020 2072 6573 706f             respo
-00006f30: 6e73 6520 3d20 6177 6169 7420 636c 6965  nse = await clie
-00006f40: 6e74 2e67 6574 280a 2020 2020 2020 2020  nt.get(.        
-00006f50: 2020 2020 2020 2020 6622 2f6e 6f74 6562          f"/noteb
-00006f60: 6f6f 6b73 2f7b 7575 6964 7d2f 6365 6c6c  ooks/{uuid}/cell
-00006f70: 7322 2c20 6865 6164 6572 733d 7375 7065  s", headers=supe
-00006f80: 7275 7365 725f 746f 6b65 6e5f 6865 6164  ruser_token_head
-00006f90: 6572 730a 2020 2020 2020 2020 2020 2020  ers.            
-00006fa0: 290a 2020 2020 2020 2020 2020 2020 6173  ).            as
-00006fb0: 7365 7274 2072 6573 706f 6e73 652e 7374  sert response.st
-00006fc0: 6174 7573 5f63 6f64 6520 3d3d 2032 3030  atus_code == 200
-00006fd0: 0a20 2020 2020 2020 2020 2020 2063 656c  .            cel
-00006fe0: 6c73 203d 2072 6573 706f 6e73 652e 6a73  ls = response.js
-00006ff0: 6f6e 2829 5b22 6365 6c6c 7322 5d0a 2020  on()["cells"].  
-00007000: 2020 2020 2020 2020 2020 6365 6c6c 5f75            cell_u
-00007010: 7569 6420 3d20 6365 6c6c 735b 315d 5b22  uid = cells[1]["
-00007020: 6d65 7461 6461 7461 225d 5b22 6a75 7079  metadata"]["jupy
-00007030: 7465 725f 6431 225d 5b22 7575 6964 225d  ter_d1"]["uuid"]
-00007040: 0a20 2020 2020 2020 2020 2020 206e 6578  .            nex
-00007050: 745f 6365 6c6c 5f75 7569 6420 3d20 6365  t_cell_uuid = ce
-00007060: 6c6c 735b 325d 5b22 6d65 7461 6461 7461  lls[2]["metadata
-00007070: 225d 5b22 6a75 7079 7465 725f 6431 225d  "]["jupyter_d1"]
-00007080: 5b22 7575 6964 225d 0a20 2020 2020 2020  ["uuid"].       
-00007090: 2020 2020 2061 7373 6572 7420 6365 6c6c       assert cell
-000070a0: 735b 315d 5b22 736f 7572 6365 225d 203d  s[1]["source"] =
-000070b0: 3d20 2770 7269 6e74 2822 4c61 7272 7920  = 'print("Larry 
-000070c0: 7468 6520 4c6c 616d 6122 2927 0a0a 2020  the Llama")'..  
-000070d0: 2020 2020 2020 2020 2020 7265 7370 6f6e            respon
-000070e0: 7365 203d 2061 7761 6974 2063 6c69 656e  se = await clien
-000070f0: 742e 6765 7428 0a20 2020 2020 2020 2020  t.get(.         
-00007100: 2020 2020 2020 2066 222f 6e6f 7465 626f         f"/notebo
-00007110: 6f6b 732f 7b75 7569 647d 2f63 656c 6c73  oks/{uuid}/cells
-00007120: 2f7b 6365 6c6c 5f75 7569 647d 2f73 706c  /{cell_uuid}/spl
-00007130: 6974 222c 0a20 2020 2020 2020 2020 2020  it",.           
-00007140: 2020 2020 2071 7565 7279 5f73 7472 696e       query_strin
-00007150: 673d 7b22 7370 6c69 745f 6c6f 6361 7469  g={"split_locati
-00007160: 6f6e 223a 2032 7d2c 0a20 2020 2020 2020  on": 2},.       
-00007170: 2020 2020 2020 2020 2068 6561 6465 7273           headers
-00007180: 3d73 7570 6572 7573 6572 5f74 6f6b 656e  =superuser_token
-00007190: 5f68 6561 6465 7273 2c0a 2020 2020 2020  _headers,.      
-000071a0: 2020 2020 2020 290a 2020 2020 2020 2020        ).        
-000071b0: 2020 2020 6173 7365 7274 2072 6573 706f      assert respo
-000071c0: 6e73 652e 7374 6174 7573 5f63 6f64 6520  nse.status_code 
-000071d0: 3d3d 2032 3034 0a0a 2020 2020 2020 2020  == 204..        
-000071e0: 2020 2020 6461 7461 203d 2061 7761 6974      data = await
-000071f0: 2072 6563 6569 7665 5f6a 736f 6e28 7765   receive_json(we
-00007200: 6273 6f63 6b65 7429 0a20 2020 2020 2020  bsocket).       
-00007210: 2020 2020 2063 656c 6c73 203d 2064 6174       cells = dat
-00007220: 615b 2263 656c 6c5f 7570 6461 7465 225d  a["cell_update"]
-00007230: 0a20 2020 2020 2020 2020 2020 2061 7373  .            ass
-00007240: 6572 7420 6c65 6e28 6365 6c6c 7329 203d  ert len(cells) =
-00007250: 3d20 350a 2020 2020 2020 2020 2020 2020  = 5.            
-00007260: 6173 7365 7274 2063 656c 6c73 5b31 5d5b  assert cells[1][
-00007270: 2273 6f75 7263 6522 5d20 3d3d 2022 7072  "source"] == "pr
-00007280: 220a 2020 2020 2020 2020 2020 2020 6173  ".            as
-00007290: 7365 7274 2063 656c 6c73 5b31 5d5b 226d  sert cells[1]["m
-000072a0: 6574 6164 6174 6122 5d5b 226a 7570 7974  etadata"]["jupyt
-000072b0: 6572 5f64 3122 5d5b 2275 7569 6422 5d20  er_d1"]["uuid"] 
-000072c0: 3d3d 2063 656c 6c5f 7575 6964 0a20 2020  == cell_uuid.   
-000072d0: 2020 2020 2020 2020 2061 7373 6572 7420           assert 
-000072e0: 6365 6c6c 735b 325d 5b22 736f 7572 6365  cells[2]["source
-000072f0: 225d 203d 3d20 2769 6e74 2822 4c61 7272  "] == 'int("Larr
-00007300: 7920 7468 6520 4c6c 616d 6122 2927 0a20  y the Llama")'. 
-00007310: 2020 2020 2020 2020 2020 2061 7373 6572             asser
-00007320: 7420 6365 6c6c 735b 325d 5b22 6d65 7461  t cells[2]["meta
-00007330: 6461 7461 225d 5b22 6a75 7079 7465 725f  data"]["jupyter_
-00007340: 6431 225d 5b22 7575 6964 225d 2069 7320  d1"]["uuid"] is 
-00007350: 6e6f 7420 4e6f 6e65 0a20 2020 2020 2020  not None.       
-00007360: 2020 2020 2061 7373 6572 7420 6365 6c6c       assert cell
-00007370: 735b 335d 5b22 6d65 7461 6461 7461 225d  s[3]["metadata"]
-00007380: 5b22 6a75 7079 7465 725f 6431 225d 5b22  ["jupyter_d1"]["
-00007390: 7575 6964 225d 203d 3d20 6e65 7874 5f63  uuid"] == next_c
-000073a0: 656c 6c5f 7575 6964 0a0a 2020 2020 2020  ell_uuid..      
-000073b0: 2020 2020 2020 2320 4368 6563 6b20 6365        # Check ce
-000073c0: 6c6c 2070 6f73 6974 696f 6e73 0a20 2020  ll positions.   
-000073d0: 2020 2020 2020 2020 2061 7373 6572 745f           assert_
-000073e0: 6365 6c6c 5f70 6f73 6974 696f 6e73 2863  cell_positions(c
-000073f0: 656c 6c73 290a 0a20 2020 2040 7079 7465  ells)..    @pyte
-00007400: 7374 2e6d 6172 6b2e 6173 796e 6369 6f0a  st.mark.asyncio.
-00007410: 2020 2020 6173 796e 6320 6465 6620 7465      async def te
-00007420: 7374 5f63 656c 6c5f 7374 7265 616d 280a  st_cell_stream(.
-00007430: 2020 2020 2020 2020 7365 6c66 2c0a 2020          self,.  
-00007440: 2020 2020 2020 636c 6965 6e74 3a20 5465        client: Te
-00007450: 7374 436c 6965 6e74 2c0a 2020 2020 2020  stClient,.      
-00007460: 2020 7265 6164 6f6e 6c79 5f74 6f6b 656e    readonly_token
-00007470: 5f68 6561 6465 7273 3a20 4469 6374 5b73  _headers: Dict[s
-00007480: 7472 2c20 7374 725d 2c0a 2020 2020 2020  tr, str],.      
-00007490: 2020 7065 726d 6973 7369 6f6e 6c65 7373    permissionless
-000074a0: 5f74 6f6b 656e 5f68 6561 6465 7273 3a20  _token_headers: 
-000074b0: 4469 6374 5b73 7472 2c20 7374 725d 2c0a  Dict[str, str],.
-000074c0: 2020 2020 2020 2020 7375 7065 7275 7365          superuse
-000074d0: 725f 746f 6b65 6e5f 6865 6164 6572 733a  r_token_headers:
-000074e0: 2044 6963 745b 7374 722c 2073 7472 5d2c   Dict[str, str],
-000074f0: 0a20 2020 2029 3a0a 2020 2020 2020 2020  .    ):.        
-00007500: 7575 6964 203d 2061 7761 6974 2075 706c  uuid = await upl
-00007510: 6f61 645f 6e6f 7465 626f 6f6b 280a 2020  oad_notebook(.  
-00007520: 2020 2020 2020 2020 2020 636c 6965 6e74            client
-00007530: 2c20 7375 7065 7275 7365 725f 746f 6b65  , superuser_toke
-00007540: 6e5f 6865 6164 6572 732c 2022 7369 6d70  n_headers, "simp
-00007550: 6c65 2e69 7079 6e62 220a 2020 2020 2020  le.ipynb".      
-00007560: 2020 290a 0a20 2020 2020 2020 2023 2067    )..        # g
-00007570: 6574 2061 6e20 6578 6973 7469 6e67 2063  et an existing c
-00007580: 656c 6c0a 2020 2020 2020 2020 7265 7370  ell.        resp
-00007590: 6f6e 7365 203d 2061 7761 6974 2063 6c69  onse = await cli
-000075a0: 656e 742e 6765 7428 0a20 2020 2020 2020  ent.get(.       
-000075b0: 2020 2020 2066 222f 6e6f 7465 626f 6f6b       f"/notebook
-000075c0: 732f 7b75 7569 647d 2f63 656c 6c73 222c  s/{uuid}/cells",
-000075d0: 2068 6561 6465 7273 3d73 7570 6572 7573   headers=superus
-000075e0: 6572 5f74 6f6b 656e 5f68 6561 6465 7273  er_token_headers
-000075f0: 0a20 2020 2020 2020 2029 0a20 2020 2020  .        ).     
-00007600: 2020 2061 7373 6572 7420 7265 7370 6f6e     assert respon
-00007610: 7365 2e73 7461 7475 735f 636f 6465 203d  se.status_code =
-00007620: 3d20 3230 300a 2020 2020 2020 2020 6365  = 200.        ce
-00007630: 6c6c 7320 3d20 7265 7370 6f6e 7365 2e6a  lls = response.j
-00007640: 736f 6e28 295b 2263 656c 6c73 225d 0a20  son()["cells"]. 
-00007650: 2020 2020 2020 2061 7373 6572 7420 6365         assert ce
-00007660: 6c6c 735b 315d 5b22 736f 7572 6365 225d  lls[1]["source"]
-00007670: 203d 3d20 2770 7269 6e74 2822 4c61 7272   == 'print("Larr
-00007680: 7920 7468 6520 4c6c 616d 6122 2927 0a0a  y the Llama")'..
-00007690: 2020 2020 2020 2020 6365 6c6c 5f75 7569          cell_uui
-000076a0: 6420 3d20 6365 6c6c 735b 315d 5b22 6d65  d = cells[1]["me
-000076b0: 7461 6461 7461 225d 5b22 6a75 7079 7465  tadata"]["jupyte
-000076c0: 725f 6431 225d 5b22 7575 6964 225d 0a20  r_d1"]["uuid"]. 
-000076d0: 2020 2020 2020 2061 7373 6572 7420 6365         assert ce
-000076e0: 6c6c 735b 315d 5b22 6578 6563 7574 696f  lls[1]["executio
-000076f0: 6e5f 636f 756e 7422 5d20 6973 204e 6f6e  n_count"] is Non
-00007700: 650a 0a20 2020 2020 2020 2070 6172 616d  e..        param
-00007710: 7320 3d20 7b0a 2020 2020 2020 2020 2020  s = {.          
-00007720: 2020 2273 6f75 7263 6522 3a20 2269 6d70    "source": "imp
-00007730: 6f72 7420 7469 6d65 5c6e 666f 7220 6920  ort time\nfor i 
-00007740: 696e 2028 2768 6572 6573 272c 2027 6127  in ('heres', 'a'
-00007750: 2c20 220a 2020 2020 2020 2020 2020 2020  , ".            
-00007760: 2227 7374 7265 616d 6f66 6461 7461 2729  "'streamofdata')
-00007770: 3a5c 6e20 2020 2070 7269 6e74 2869 295c  :\n    print(i)\
-00007780: 6e20 2020 2074 696d 652e 736c 6565 7028  n    time.sleep(
-00007790: 302e 3929 220a 2020 2020 2020 2020 7d0a  0.9)".        }.
-000077a0: 2020 2020 2020 2020 7265 7370 6f6e 7365          response
-000077b0: 203d 2061 7761 6974 2063 6c69 656e 742e   = await client.
-000077c0: 7061 7463 6828 0a20 2020 2020 2020 2020  patch(.         
-000077d0: 2020 2066 222f 6e6f 7465 626f 6f6b 732f     f"/notebooks/
-000077e0: 7b75 7569 647d 2f63 656c 6c73 2f7b 6365  {uuid}/cells/{ce
-000077f0: 6c6c 5f75 7569 647d 222c 0a20 2020 2020  ll_uuid}",.     
-00007800: 2020 2020 2020 206a 736f 6e3d 7061 7261         json=para
-00007810: 6d73 2c0a 2020 2020 2020 2020 2020 2020  ms,.            
-00007820: 6865 6164 6572 733d 7375 7065 7275 7365  headers=superuse
-00007830: 725f 746f 6b65 6e5f 6865 6164 6572 732c  r_token_headers,
-00007840: 0a20 2020 2020 2020 2029 0a20 2020 2020  .        ).     
-00007850: 2020 2061 7373 6572 7420 7265 7370 6f6e     assert respon
-00007860: 7365 2e73 7461 7475 735f 636f 6465 203d  se.status_code =
-00007870: 3d20 3230 300a 0a20 2020 2020 2020 2061  = 200..        a
-00007880: 7379 6e63 2077 6974 6820 636c 6965 6e74  sync with client
-00007890: 2e77 6562 736f 636b 6574 5f63 6f6e 6e65  .websocket_conne
-000078a0: 6374 280a 2020 2020 2020 2020 2020 2020  ct(.            
-000078b0: 6622 2f6e 6f74 6562 6f6f 6b73 2f7b 7575  f"/notebooks/{uu
-000078c0: 6964 7d2f 7773 2f6e 6f74 6562 6f6f 6b22  id}/ws/notebook"
-000078d0: 2c20 6865 6164 6572 733d 7375 7065 7275  , headers=superu
-000078e0: 7365 725f 746f 6b65 6e5f 6865 6164 6572  ser_token_header
-000078f0: 730a 2020 2020 2020 2020 2920 6173 2077  s.        ) as w
-00007900: 6562 736f 636b 6574 3a0a 2020 2020 2020  ebsocket:.      
-00007910: 2020 2020 2020 6177 6169 7420 6173 796e        await asyn
-00007920: 6369 6f2e 736c 6565 7028 5745 4253 4f43  cio.sleep(WEBSOC
-00007930: 4b45 545f 534c 4545 505f 5449 4d45 290a  KET_SLEEP_TIME).
-00007940: 0a20 2020 2020 2020 2020 2020 2072 6573  .            res
-00007950: 706f 6e73 6520 3d20 6177 6169 7420 636c  ponse = await cl
-00007960: 6965 6e74 2e67 6574 280a 2020 2020 2020  ient.get(.      
-00007970: 2020 2020 2020 2020 2020 6622 2f6e 6f74            f"/not
-00007980: 6562 6f6f 6b73 2f7b 7575 6964 7d2f 6365  ebooks/{uuid}/ce
-00007990: 6c6c 732f 7b63 656c 6c5f 7575 6964 7d2f  lls/{cell_uuid}/
-000079a0: 6578 6563 7574 6522 2c0a 2020 2020 2020  execute",.      
-000079b0: 2020 2020 2020 2020 2020 6865 6164 6572            header
-000079c0: 733d 7375 7065 7275 7365 725f 746f 6b65  s=superuser_toke
-000079d0: 6e5f 6865 6164 6572 732c 0a20 2020 2020  n_headers,.     
-000079e0: 2020 2020 2020 2029 0a20 2020 2020 2020         ).       
-000079f0: 2020 2020 2061 7373 6572 7420 7265 7370       assert resp
-00007a00: 6f6e 7365 2e73 7461 7475 735f 636f 6465  onse.status_code
-00007a10: 203d 3d20 3230 300a 0a20 2020 2020 2020   == 200..       
-00007a20: 2020 2020 206f 7574 7075 7473 203d 205b       outputs = [
-00007a30: 2268 6572 6573 222c 2022 6122 2c20 2273  "heres", "a", "s
-00007a40: 7472 6561 6d6f 6664 6174 6122 5d0a 2020  treamofdata"].  
-00007a50: 2020 2020 2020 2020 2020 6365 6c6c 5f73            cell_s
-00007a60: 7472 6561 6d73 3a20 4c69 7374 5b44 6963  treams: List[Dic
-00007a70: 745b 7374 722c 2041 6e79 5d5d 203d 205b  t[str, Any]] = [
-00007a80: 5d0a 2020 2020 2020 2020 2020 2020 7265  ].            re
-00007a90: 6365 6976 6564 5f69 6e66 6f20 3d20 7b0a  ceived_info = {.
-00007aa0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00007ab0: 2272 6563 6569 7665 645f 6365 6c6c 5f73  "received_cell_s
-00007ac0: 7472 6561 6d5f 636f 756e 7422 3a20 302c  tream_count": 0,
-00007ad0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00007ae0: 2022 7265 6365 6976 6564 5f63 656c 6c5f   "received_cell_
-00007af0: 7570 6461 7465 5f63 6f75 6e74 223a 2030  update_count": 0
-00007b00: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
-00007b10: 2020 2272 6563 6569 7665 645f 6365 6c6c    "received_cell
-00007b20: 5f65 7865 6375 7469 6f6e 223a 2046 616c  _execution": Fal
-00007b30: 7365 2c0a 2020 2020 2020 2020 2020 2020  se,.            
-00007b40: 2020 2020 2272 6563 6569 7665 645f 7661      "received_va
-00007b50: 7273 223a 2046 616c 7365 2c0a 2020 2020  rs": False,.    
-00007b60: 2020 2020 2020 2020 7d0a 0a20 2020 2020          }..     
-00007b70: 2020 2020 2020 2023 2052 6563 6569 7665         # Receive
-00007b80: 2063 656c 6c20 7374 7265 616d 206f 7574   cell stream out
-00007b90: 7075 740a 2020 2020 2020 2020 2020 2020  put.            
-00007ba0: 6173 796e 6320 6465 6620 7265 6365 6976  async def receiv
-00007bb0: 655f 6365 6c6c 5f73 7472 6561 6d28 6461  e_cell_stream(da
-00007bc0: 7461 293a 0a20 2020 2020 2020 2020 2020  ta):.           
-00007bd0: 2020 2020 2063 656c 6c5f 7374 7265 616d       cell_stream
-00007be0: 203d 2064 6174 615b 2263 656c 6c5f 7374   = data["cell_st
-00007bf0: 7265 616d 225d 0a20 2020 2020 2020 2020  ream"].         
-00007c00: 2020 2020 2020 2065 7870 6563 7465 645f         expected_
-00007c10: 6f75 7470 7574 203d 207b 0a20 2020 2020  output = {.     
-00007c20: 2020 2020 2020 2020 2020 2020 2020 2022                 "
-00007c30: 6e61 6d65 223a 2022 7374 646f 7574 222c  name": "stdout",
-00007c40: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00007c50: 2020 2020 2022 7465 7874 223a 2066 227b       "text": f"{
-00007c60: 6f75 7470 7574 732e 706f 7028 3029 7d5c  outputs.pop(0)}\
-00007c70: 6e22 2c0a 2020 2020 2020 2020 2020 2020  n",.            
-00007c80: 2020 2020 2020 2020 226f 7574 7075 745f          "output_
-00007c90: 7479 7065 223a 2022 7374 7265 616d 222c  type": "stream",
-00007ca0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00007cb0: 207d 0a20 2020 2020 2020 2020 2020 2020   }.             
-00007cc0: 2020 2061 7373 6572 7420 6365 6c6c 5f73     assert cell_s
-00007cd0: 7472 6561 6d5b 226f 7574 7075 7422 5d20  tream["output"] 
-00007ce0: 3d3d 2065 7870 6563 7465 645f 6f75 7470  == expected_outp
-00007cf0: 7574 0a20 2020 2020 2020 2020 2020 2020  ut.             
-00007d00: 2020 2061 7373 6572 7420 6365 6c6c 5f73     assert cell_s
-00007d10: 7472 6561 6d5b 2263 656c 6c5f 6964 225d  tream["cell_id"]
-00007d20: 203d 3d20 6365 6c6c 5f75 7569 640a 2020   == cell_uuid.  
-00007d30: 2020 2020 2020 2020 2020 2020 2020 7265                re
-00007d40: 6365 6976 6564 5f69 6e66 6f5b 2272 6563  ceived_info["rec
-00007d50: 6569 7665 645f 6365 6c6c 5f73 7472 6561  eived_cell_strea
-00007d60: 6d5f 636f 756e 7422 5d20 2b3d 2031 0a20  m_count"] += 1. 
-00007d70: 2020 2020 2020 2020 2020 2020 2020 2072                 r
-00007d80: 6574 7572 6e20 6578 7065 6374 6564 5f6f  eturn expected_o
-00007d90: 7574 7075 740a 0a20 2020 2020 2020 2020  utput..         
-00007da0: 2020 2061 7379 6e63 2064 6566 2072 6563     async def rec
-00007db0: 6569 7665 5f63 656c 6c5f 7570 6461 7465  eive_cell_update
-00007dc0: 2864 6174 6129 3a0a 2020 2020 2020 2020  (data):.        
-00007dd0: 2020 2020 2020 2020 6365 6c6c 5f75 7064          cell_upd
-00007de0: 6174 6520 3d20 6461 7461 5b22 6365 6c6c  ate = data["cell
-00007df0: 5f75 7064 6174 6522 5d0a 2020 2020 2020  _update"].      
-00007e00: 2020 2020 2020 2020 2020 6173 7365 7274            assert
-00007e10: 206c 656e 2863 656c 6c5f 7570 6461 7465   len(cell_update
-00007e20: 2920 3d3d 2031 0a20 2020 2020 2020 2020  ) == 1.         
-00007e30: 2020 2020 2020 2063 656c 6c5f 6431 5f64         cell_d1_d
-00007e40: 6174 6120 3d20 6365 6c6c 5f75 7064 6174  ata = cell_updat
-00007e50: 655b 305d 5b22 6d65 7461 6461 7461 225d  e[0]["metadata"]
-00007e60: 5b22 6a75 7079 7465 725f 6431 225d 0a20  ["jupyter_d1"]. 
-00007e70: 2020 2020 2020 2020 2020 2020 2020 2061                 a
-00007e80: 7373 6572 7420 6365 6c6c 5f64 315f 6461  ssert cell_d1_da
-00007e90: 7461 5b22 7575 6964 225d 203d 3d20 6365  ta["uuid"] == ce
-00007ea0: 6c6c 5f75 7569 640a 2020 2020 2020 2020  ll_uuid.        
-00007eb0: 2020 2020 2020 2020 6966 2072 6563 6569          if recei
-00007ec0: 7665 645f 696e 666f 5b22 7265 6365 6976  ved_info["receiv
-00007ed0: 6564 5f63 656c 6c5f 7570 6461 7465 5f63  ed_cell_update_c
-00007ee0: 6f75 6e74 225d 203d 3d20 303a 0a20 2020  ount"] == 0:.   
-00007ef0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00007f00: 2061 7373 6572 7420 6365 6c6c 5f64 315f   assert cell_d1_
-00007f10: 6461 7461 5b22 6578 6563 7574 696f 6e5f  data["execution_
-00007f20: 7374 6174 6522 5d20 3d3d 2022 6275 7379  state"] == "busy
-00007f30: 220a 2020 2020 2020 2020 2020 2020 2020  ".              
-00007f40: 2020 656c 7365 3a0a 2020 2020 2020 2020    else:.        
-00007f50: 2020 2020 2020 2020 2020 2020 6173 7365              asse
-00007f60: 7274 2063 656c 6c5f 6431 5f64 6174 615b  rt cell_d1_data[
-00007f70: 2265 7865 6375 7469 6f6e 5f73 7461 7465  "execution_state
-00007f80: 225d 203d 3d20 2269 646c 6522 0a20 2020  "] == "idle".   
-00007f90: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00007fa0: 2061 7373 6572 7420 6365 6c6c 5f75 7064   assert cell_upd
-00007fb0: 6174 655b 305d 5b22 6f75 7470 7574 7322  ate[0]["outputs"
-00007fc0: 5d20 3d3d 2063 656c 6c5f 7374 7265 616d  ] == cell_stream
-00007fd0: 730a 2020 2020 2020 2020 2020 2020 2020  s.              
-00007fe0: 2020 6173 7365 7274 2028 0a20 2020 2020    assert (.     
-00007ff0: 2020 2020 2020 2020 2020 2020 2020 2063                 c
-00008000: 656c 6c5f 7570 6461 7465 5b30 5d5b 2265  ell_update[0]["e
-00008010: 7865 6375 7469 6f6e 5f63 6f75 6e74 225d  xecution_count"]
-00008020: 2069 7320 4e6f 6e65 0a20 2020 2020 2020   is None.       
-00008030: 2020 2020 2020 2020 2020 2020 206f 7220               or 
-00008040: 6365 6c6c 5f75 7064 6174 655b 305d 5b22  cell_update[0]["
-00008050: 6578 6563 7574 696f 6e5f 636f 756e 7422  execution_count"
-00008060: 5d20 3d3d 2031 0a20 2020 2020 2020 2020  ] == 1.         
-00008070: 2020 2020 2020 2029 0a20 2020 2020 2020         ).       
-00008080: 2020 2020 2020 2020 2072 6563 6569 7665           receive
-00008090: 645f 696e 666f 5b22 7265 6365 6976 6564  d_info["received
-000080a0: 5f63 656c 6c5f 7570 6461 7465 5f63 6f75  _cell_update_cou
-000080b0: 6e74 225d 202b 3d20 310a 0a20 2020 2020  nt"] += 1..     
-000080c0: 2020 2020 2020 2061 7379 6e63 2064 6566         async def
-000080d0: 2072 6563 6569 7665 5f63 656c 6c5f 6578   receive_cell_ex
-000080e0: 6563 7574 696f 6e28 6461 7461 293a 0a20  ecution(data):. 
-000080f0: 2020 2020 2020 2020 2020 2020 2020 2063                 c
-00008100: 656c 6c5f 6578 6563 203d 2064 6174 615b  ell_exec = data[
-00008110: 2263 656c 6c5f 6578 6563 7574 696f 6e5f  "cell_execution_
-00008120: 7265 706c 7922 5d0a 2020 2020 2020 2020  reply"].        
-00008130: 2020 2020 2020 2020 6173 7365 7274 2063          assert c
-00008140: 656c 6c5f 6578 6563 5b22 6365 6c6c 5f69  ell_exec["cell_i
-00008150: 6422 5d20 3d3d 2063 656c 6c5f 7575 6964  d"] == cell_uuid
-00008160: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00008170: 2061 7373 6572 7420 6365 6c6c 5f65 7865   assert cell_exe
-00008180: 635b 2265 7865 6375 7469 6f6e 5f63 6f75  c["execution_cou
-00008190: 6e74 225d 203d 3d20 310a 2020 2020 2020  nt"] == 1.      
-000081a0: 2020 2020 2020 2020 2020 6173 7365 7274            assert
-000081b0: 206c 656e 2863 656c 6c5f 6578 6563 5b22   len(cell_exec["
-000081c0: 7061 7265 6e74 5f69 6422 5d29 2069 6e20  parent_id"]) in 
-000081d0: 6d73 675f 6964 5f6c 656e 6774 6873 0a20  msg_id_lengths. 
-000081e0: 2020 2020 2020 2020 2020 2020 2020 2072                 r
-000081f0: 6563 6569 7665 645f 696e 666f 5b22 7265  eceived_info["re
-00008200: 6365 6976 6564 5f63 656c 6c5f 6578 6563  ceived_cell_exec
-00008210: 7574 696f 6e22 5d20 3d20 5472 7565 0a0a  ution"] = True..
-00008220: 2020 2020 2020 2020 2020 2020 6d73 675f              msg_
-00008230: 7479 7065 7320 3d20 5b0a 2020 2020 2020  types = [.      
-00008240: 2020 2020 2020 2020 2020 2263 656c 6c5f            "cell_
-00008250: 7374 7265 616d 222c 0a20 2020 2020 2020  stream",.       
-00008260: 2020 2020 2020 2020 2022 6365 6c6c 5f75           "cell_u
-00008270: 7064 6174 6522 2c0a 2020 2020 2020 2020  pdate",.        
-00008280: 2020 2020 2020 2020 2263 656c 6c5f 6578          "cell_ex
-00008290: 6563 7574 696f 6e5f 7265 706c 7922 2c0a  ecution_reply",.
-000082a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000082b0: 2276 6172 7322 2c0a 2020 2020 2020 2020  "vars",.        
-000082c0: 2020 2020 5d0a 2020 2020 2020 2020 2020      ].          
-000082d0: 2020 666f 7220 6920 696e 2072 616e 6765    for i in range
-000082e0: 2837 293a 0a20 2020 2020 2020 2020 2020  (7):.           
-000082f0: 2020 2020 2064 6174 6120 3d20 6177 6169       data = awai
-00008300: 7420 7265 6365 6976 655f 6a73 6f6e 2877  t receive_json(w
-00008310: 6562 736f 636b 6574 2c20 6d73 675f 7479  ebsocket, msg_ty
-00008320: 7065 733d 6d73 675f 7479 7065 7329 0a20  pes=msg_types). 
-00008330: 2020 2020 2020 2020 2020 2020 2020 2069                 i
-00008340: 6620 2263 656c 6c5f 7374 7265 616d 2220  f "cell_stream" 
-00008350: 696e 2064 6174 613a 0a20 2020 2020 2020  in data:.       
-00008360: 2020 2020 2020 2020 2020 2020 2063 656c               cel
-00008370: 6c5f 7374 7265 616d 732e 6170 7065 6e64  l_streams.append
-00008380: 2861 7761 6974 2072 6563 6569 7665 5f63  (await receive_c
-00008390: 656c 6c5f 7374 7265 616d 2864 6174 6129  ell_stream(data)
-000083a0: 290a 2020 2020 2020 2020 2020 2020 2020  ).              
-000083b0: 2020 6966 2022 6365 6c6c 5f75 7064 6174    if "cell_updat
-000083c0: 6522 2069 6e20 6461 7461 3a0a 2020 2020  e" in data:.    
-000083d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000083e0: 6177 6169 7420 7265 6365 6976 655f 6365  await receive_ce
-000083f0: 6c6c 5f75 7064 6174 6528 6461 7461 290a  ll_update(data).
-00008400: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00008410: 6966 2022 6365 6c6c 5f65 7865 6375 7469  if "cell_executi
-00008420: 6f6e 5f72 6570 6c79 2220 696e 2064 6174  on_reply" in dat
-00008430: 613a 0a20 2020 2020 2020 2020 2020 2020  a:.             
-00008440: 2020 2020 2020 2061 7761 6974 2072 6563         await rec
-00008450: 6569 7665 5f63 656c 6c5f 6578 6563 7574  eive_cell_execut
-00008460: 696f 6e28 6461 7461 290a 2020 2020 2020  ion(data).      
-00008470: 2020 2020 2020 2020 2020 6966 2022 7661            if "va
-00008480: 7273 2220 696e 2064 6174 613a 0a20 2020  rs" in data:.   
-00008490: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000084a0: 2072 6563 6569 7665 645f 696e 666f 5b22   received_info["
-000084b0: 7265 6365 6976 6564 5f76 6172 7322 5d20  received_vars"] 
-000084c0: 3d20 5472 7565 0a0a 2020 2020 2020 2020  = True..        
-000084d0: 2020 2020 6173 7365 7274 2072 6563 6569      assert recei
-000084e0: 7665 645f 696e 666f 5b22 7265 6365 6976  ved_info["receiv
-000084f0: 6564 5f63 656c 6c5f 7570 6461 7465 5f63  ed_cell_update_c
-00008500: 6f75 6e74 225d 203d 3d20 320a 2020 2020  ount"] == 2.    
-00008510: 2020 2020 2020 2020 6173 7365 7274 2072          assert r
-00008520: 6563 6569 7665 645f 696e 666f 5b22 7265  eceived_info["re
-00008530: 6365 6976 6564 5f63 656c 6c5f 6578 6563  ceived_cell_exec
-00008540: 7574 696f 6e22 5d0a 2020 2020 2020 2020  ution"].        
-00008550: 2020 2020 6173 7365 7274 2072 6563 6569      assert recei
-00008560: 7665 645f 696e 666f 5b22 7265 6365 6976  ved_info["receiv
-00008570: 6564 5f76 6172 7322 5d0a 2020 2020 2020  ed_vars"].      
-00008580: 2020 2020 2020 6173 7365 7274 2072 6563        assert rec
-00008590: 6569 7665 645f 696e 666f 5b22 7265 6365  eived_info["rece
-000085a0: 6976 6564 5f63 656c 6c5f 7374 7265 616d  ived_cell_stream
-000085b0: 5f63 6f75 6e74 225d 203d 3d20 330a 0a20  _count"] == 3.. 
-000085c0: 2020 2040 7079 7465 7374 2e6d 6172 6b2e     @pytest.mark.
-000085d0: 6173 796e 6369 6f0a 2020 2020 6173 796e  asyncio.    asyn
-000085e0: 6320 6465 6620 7465 7374 5f69 646c 655f  c def test_idle_
-000085f0: 7374 6174 7573 280a 2020 2020 2020 2020  status(.        
-00008600: 7365 6c66 2c0a 2020 2020 2020 2020 636c  self,.        cl
-00008610: 6965 6e74 3a20 5465 7374 436c 6965 6e74  ient: TestClient
-00008620: 2c0a 2020 2020 2020 2020 7265 6164 6f6e  ,.        readon
-00008630: 6c79 5f74 6f6b 656e 5f68 6561 6465 7273  ly_token_headers
-00008640: 3a20 4469 6374 5b73 7472 2c20 7374 725d  : Dict[str, str]
-00008650: 2c0a 2020 2020 2020 2020 7065 726d 6973  ,.        permis
-00008660: 7369 6f6e 6c65 7373 5f74 6f6b 656e 5f68  sionless_token_h
-00008670: 6561 6465 7273 3a20 4469 6374 5b73 7472  eaders: Dict[str
-00008680: 2c20 7374 725d 2c0a 2020 2020 2020 2020  , str],.        
-00008690: 7375 7065 7275 7365 725f 746f 6b65 6e5f  superuser_token_
-000086a0: 6865 6164 6572 733a 2044 6963 745b 7374  headers: Dict[st
-000086b0: 722c 2073 7472 5d2c 0a20 2020 2029 3a0a  r, str],.    ):.
-000086c0: 2020 2020 2020 2020 6173 796e 6320 6465          async de
-000086d0: 6620 6973 5f69 646c 655f 7374 6174 7573  f is_idle_status
-000086e0: 2829 3a0a 2020 2020 2020 2020 2020 2020  ():.            
-000086f0: 7265 7370 6f6e 7365 203d 2061 7761 6974  response = await
-00008700: 2063 6c69 656e 742e 6765 7428 0a20 2020   client.get(.   
-00008710: 2020 2020 2020 2020 2020 2020 2066 222f               f"/
-00008720: 6b65 726e 656c 732f 6964 6c65 222c 2068  kernels/idle", h
-00008730: 6561 6465 7273 3d73 7570 6572 7573 6572  eaders=superuser
-00008740: 5f74 6f6b 656e 5f68 6561 6465 7273 0a20  _token_headers. 
-00008750: 2020 2020 2020 2020 2020 2029 0a20 2020             ).   
-00008760: 2020 2020 2020 2020 2061 7373 6572 7420           assert 
-00008770: 7265 7370 6f6e 7365 2e73 7461 7475 735f  response.status_
-00008780: 636f 6465 203d 3d20 3230 300a 2020 2020  code == 200.    
-00008790: 2020 2020 2020 2020 6a73 6f6e 203d 2072          json = r
-000087a0: 6573 706f 6e73 652e 6a73 6f6e 2829 0a20  esponse.json(). 
-000087b0: 2020 2020 2020 2020 2020 2072 6574 7572             retur
-000087c0: 6e20 280a 2020 2020 2020 2020 2020 2020  n (.            
-000087d0: 2020 2020 6a73 6f6e 5b22 6964 6c65 225d      json["idle"]
-000087e0: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
-000087f0: 2020 6461 7465 7469 6d65 2e73 7472 7074    datetime.strpt
-00008800: 696d 6528 6a73 6f6e 5b22 6c61 7374 5f69  ime(json["last_i
-00008810: 646c 6522 5d2c 2022 2559 2d25 6d2d 2564  dle"], "%Y-%m-%d
-00008820: 5425 483a 254d 3a25 532e 2566 2229 2c0a  T%H:%M:%S.%f"),.
-00008830: 2020 2020 2020 2020 2020 2020 290a 0a20              ).. 
-00008840: 2020 2020 2020 2023 204b 6572 6e65 6c20         # Kernel 
-00008850: 6973 2069 646c 650a 2020 2020 2020 2020  is idle.        
-00008860: 6973 5f69 646c 652c 206c 6173 745f 6964  is_idle, last_id
-00008870: 6c65 5f31 203d 2061 7761 6974 2069 735f  le_1 = await is_
-00008880: 6964 6c65 5f73 7461 7475 7328 290a 2020  idle_status().  
-00008890: 2020 2020 2020 6173 7365 7274 2069 735f        assert is_
-000088a0: 6964 6c65 2069 7320 5472 7565 0a0a 2020  idle is True..  
-000088b0: 2020 2020 2020 7575 6964 203d 2061 7761        uuid = awa
-000088c0: 6974 2075 706c 6f61 645f 6e6f 7465 626f  it upload_notebo
-000088d0: 6f6b 280a 2020 2020 2020 2020 2020 2020  ok(.            
-000088e0: 636c 6965 6e74 2c20 7375 7065 7275 7365  client, superuse
-000088f0: 725f 746f 6b65 6e5f 6865 6164 6572 732c  r_token_headers,
-00008900: 2022 7369 6d70 6c65 2e69 7079 6e62 220a   "simple.ipynb".
-00008910: 2020 2020 2020 2020 290a 0a20 2020 2020          )..     
-00008920: 2020 2023 204b 6572 6e65 6c20 6973 2073     # Kernel is s
-00008930: 7469 6c6c 2069 646c 650a 2020 2020 2020  till idle.      
-00008940: 2020 6973 5f69 646c 652c 206c 6173 745f    is_idle, last_
-00008950: 6964 6c65 5f32 203d 2061 7761 6974 2069  idle_2 = await i
-00008960: 735f 6964 6c65 5f73 7461 7475 7328 290a  s_idle_status().
-00008970: 2020 2020 2020 2020 6173 7365 7274 2069          assert i
-00008980: 735f 6964 6c65 2069 7320 5472 7565 0a20  s_idle is True. 
-00008990: 2020 2020 2020 2061 7373 6572 7420 6c61         assert la
-000089a0: 7374 5f69 646c 655f 3120 3d3d 206c 6173  st_idle_1 == las
-000089b0: 745f 6964 6c65 5f32 0a0a 2020 2020 2020  t_idle_2..      
-000089c0: 2020 2320 6765 7420 616e 2065 7869 7374    # get an exist
-000089d0: 696e 6720 6365 6c6c 0a20 2020 2020 2020  ing cell.       
-000089e0: 2072 6573 706f 6e73 6520 3d20 6177 6169   response = awai
-000089f0: 7420 636c 6965 6e74 2e67 6574 280a 2020  t client.get(.  
-00008a00: 2020 2020 2020 2020 2020 6622 2f6e 6f74            f"/not
-00008a10: 6562 6f6f 6b73 2f7b 7575 6964 7d2f 6365  ebooks/{uuid}/ce
-00008a20: 6c6c 7322 2c20 6865 6164 6572 733d 7375  lls", headers=su
-00008a30: 7065 7275 7365 725f 746f 6b65 6e5f 6865  peruser_token_he
-00008a40: 6164 6572 730a 2020 2020 2020 2020 290a  aders.        ).
-00008a50: 2020 2020 2020 2020 6173 7365 7274 2072          assert r
-00008a60: 6573 706f 6e73 652e 7374 6174 7573 5f63  esponse.status_c
-00008a70: 6f64 6520 3d3d 2032 3030 0a20 2020 2020  ode == 200.     
-00008a80: 2020 2063 656c 6c73 203d 2072 6573 706f     cells = respo
-00008a90: 6e73 652e 6a73 6f6e 2829 5b22 6365 6c6c  nse.json()["cell
-00008aa0: 7322 5d0a 2020 2020 2020 2020 6173 7365  s"].        asse
-00008ab0: 7274 2063 656c 6c73 5b31 5d5b 2273 6f75  rt cells[1]["sou
-00008ac0: 7263 6522 5d20 3d3d 2027 7072 696e 7428  rce"] == 'print(
-00008ad0: 224c 6172 7279 2074 6865 204c 6c61 6d61  "Larry the Llama
-00008ae0: 2229 270a 0a20 2020 2020 2020 2062 7573  ")'..        bus
-00008af0: 795f 6365 6c6c 5f75 7569 6420 3d20 6365  y_cell_uuid = ce
-00008b00: 6c6c 735b 315d 5b22 6d65 7461 6461 7461  lls[1]["metadata
-00008b10: 225d 5b22 6a75 7079 7465 725f 6431 225d  "]["jupyter_d1"]
-00008b20: 5b22 7575 6964 225d 0a20 2020 2020 2020  ["uuid"].       
-00008b30: 2071 7569 636b 5f63 656c 6c5f 7575 6964   quick_cell_uuid
-00008b40: 203d 2063 656c 6c73 5b32 5d5b 226d 6574   = cells[2]["met
-00008b50: 6164 6174 6122 5d5b 226a 7570 7974 6572  adata"]["jupyter
-00008b60: 5f64 3122 5d5b 2275 7569 6422 5d0a 0a20  _d1"]["uuid"].. 
-00008b70: 2020 2020 2020 2070 6172 616d 7320 3d20         params = 
-00008b80: 7b0a 2020 2020 2020 2020 2020 2020 2273  {.            "s
-00008b90: 6f75 7263 6522 3a20 2266 726f 6d20 7469  ource": "from ti
-00008ba0: 6d65 2069 6d70 6f72 7420 736c 6565 705c  me import sleep\
-00008bb0: 6e77 6869 6c65 2054 7275 653a 5c6e 2020  nwhile True:\n  
-00008bc0: 2020 736c 6565 7028 3529 220a 2020 2020    sleep(5)".    
-00008bd0: 2020 2020 7d0a 2020 2020 2020 2020 7265      }.        re
-00008be0: 7370 6f6e 7365 203d 2061 7761 6974 2063  sponse = await c
-00008bf0: 6c69 656e 742e 7061 7463 6828 0a20 2020  lient.patch(.   
-00008c00: 2020 2020 2020 2020 2066 222f 6e6f 7465           f"/note
-00008c10: 626f 6f6b 732f 7b75 7569 647d 2f63 656c  books/{uuid}/cel
-00008c20: 6c73 2f7b 6275 7379 5f63 656c 6c5f 7575  ls/{busy_cell_uu
-00008c30: 6964 7d22 2c0a 2020 2020 2020 2020 2020  id}",.          
-00008c40: 2020 6a73 6f6e 3d70 6172 616d 732c 0a20    json=params,. 
-00008c50: 2020 2020 2020 2020 2020 2068 6561 6465             heade
-00008c60: 7273 3d73 7570 6572 7573 6572 5f74 6f6b  rs=superuser_tok
-00008c70: 656e 5f68 6561 6465 7273 2c0a 2020 2020  en_headers,.    
-00008c80: 2020 2020 290a 2020 2020 2020 2020 6173      ).        as
-00008c90: 7365 7274 2072 6573 706f 6e73 652e 7374  sert response.st
-00008ca0: 6174 7573 5f63 6f64 6520 3d3d 2032 3030  atus_code == 200
-00008cb0: 0a0a 2020 2020 2020 2020 6173 796e 6320  ..        async 
-00008cc0: 7769 7468 2063 6c69 656e 742e 7765 6273  with client.webs
-00008cd0: 6f63 6b65 745f 636f 6e6e 6563 7428 0a20  ocket_connect(. 
-00008ce0: 2020 2020 2020 2020 2020 2066 222f 6e6f             f"/no
-00008cf0: 7465 626f 6f6b 732f 7b75 7569 647d 2f77  tebooks/{uuid}/w
-00008d00: 732f 6e6f 7465 626f 6f6b 222c 2068 6561  s/notebook", hea
-00008d10: 6465 7273 3d73 7570 6572 7573 6572 5f74  ders=superuser_t
-00008d20: 6f6b 656e 5f68 6561 6465 7273 0a20 2020  oken_headers.   
-00008d30: 2020 2020 2029 2061 7320 7765 6273 6f63       ) as websoc
-00008d40: 6b65 743a 0a20 2020 2020 2020 2020 2020  ket:.           
-00008d50: 2061 7761 6974 2061 7379 6e63 696f 2e73   await asyncio.s
-00008d60: 6c65 6570 2857 4542 534f 434b 4554 5f53  leep(WEBSOCKET_S
-00008d70: 4c45 4550 5f54 494d 4529 0a0a 2020 2020  LEEP_TIME)..    
-00008d80: 2020 2020 2020 2020 7265 7370 6f6e 7365          response
-00008d90: 203d 2061 7761 6974 2063 6c69 656e 742e   = await client.
-00008da0: 6765 7428 0a20 2020 2020 2020 2020 2020  get(.           
-00008db0: 2020 2020 2066 222f 6e6f 7465 626f 6f6b       f"/notebook
-00008dc0: 732f 7b75 7569 647d 2f63 656c 6c73 2f7b  s/{uuid}/cells/{
-00008dd0: 7175 6963 6b5f 6365 6c6c 5f75 7569 647d  quick_cell_uuid}
-00008de0: 2f65 7865 6375 7465 222c 0a20 2020 2020  /execute",.     
-00008df0: 2020 2020 2020 2020 2020 2068 6561 6465             heade
-00008e00: 7273 3d73 7570 6572 7573 6572 5f74 6f6b  rs=superuser_tok
-00008e10: 656e 5f68 6561 6465 7273 2c0a 2020 2020  en_headers,.    
-00008e20: 2020 2020 2020 2020 290a 2020 2020 2020          ).      
-00008e30: 2020 2020 2020 6173 7365 7274 2072 6573        assert res
-00008e40: 706f 6e73 652e 7374 6174 7573 5f63 6f64  ponse.status_cod
-00008e50: 6520 3d3d 2032 3030 0a0a 2020 2020 2020  e == 200..      
-00008e60: 2020 2020 2020 6461 7461 203d 2061 7761        data = awa
-00008e70: 6974 2072 6563 6569 7665 5f6a 736f 6e28  it receive_json(
-00008e80: 7765 6273 6f63 6b65 742c 206d 7367 5f74  websocket, msg_t
-00008e90: 7970 6573 3d5b 2276 6172 7322 5d29 0a20  ypes=["vars"]). 
-00008ea0: 2020 2020 2020 2020 2020 2061 7373 6572             asser
-00008eb0: 7420 2276 6172 7322 2069 6e20 6461 7461  t "vars" in data
-00008ec0: 0a0a 2020 2020 2020 2020 2020 2020 2320  ..            # 
-00008ed0: 4e65 6564 2074 6f20 7761 6974 2066 6f72  Need to wait for
-00008ee0: 2074 6865 2055 5044 4154 455f 574f 524b   the UPDATE_WORK
-00008ef0: 4449 525f 5245 5155 4553 5420 746f 2066  DIR_REQUEST to f
-00008f00: 696e 6973 680a 2020 2020 2020 2020 2020  inish.          
-00008f10: 2020 2320 2861 6e64 2077 6520 776f 6e27    # (and we won'
-00008f20: 7420 7365 6520 6974 2074 6872 6f75 6768  t see it through
-00008f30: 2074 6865 2077 6562 736f 636b 6574 290a   the websocket).
-00008f40: 2020 2020 2020 2020 2020 2020 6177 6169              awai
-00008f50: 7420 6173 796e 6369 6f2e 736c 6565 7028  t asyncio.sleep(
-00008f60: 3129 0a0a 2020 2020 2020 2020 2020 2020  1)..            
-00008f70: 2320 4b65 726e 656c 2069 7320 7374 696c  # Kernel is stil
-00008f80: 6c20 6964 6c65 2028 6e6f 2063 6f64 6520  l idle (no code 
-00008f90: 7275 6e6e 696e 6729 0a20 2020 2020 2020  running).       
-00008fa0: 2020 2020 2069 735f 6964 6c65 2c20 6c61       is_idle, la
-00008fb0: 7374 5f69 646c 655f 3320 3d20 6177 6169  st_idle_3 = awai
-00008fc0: 7420 6973 5f69 646c 655f 7374 6174 7573  t is_idle_status
-00008fd0: 2829 0a20 2020 2020 2020 2020 2020 2061  ().            a
-00008fe0: 7373 6572 7420 6973 5f69 646c 6520 6973  ssert is_idle is
-00008ff0: 2054 7275 650a 2020 2020 2020 2020 2020   True.          
-00009000: 2020 6173 7365 7274 206c 6173 745f 6964    assert last_id
-00009010: 6c65 5f33 203e 206c 6173 745f 6964 6c65  le_3 > last_idle
-00009020: 5f32 0a0a 2020 2020 2020 2020 2020 2020  _2..            
-00009030: 7265 7370 6f6e 7365 203d 2061 7761 6974  response = await
-00009040: 2063 6c69 656e 742e 6765 7428 0a20 2020   client.get(.   
-00009050: 2020 2020 2020 2020 2020 2020 2066 222f               f"/
-00009060: 6e6f 7465 626f 6f6b 732f 7b75 7569 647d  notebooks/{uuid}
-00009070: 2f63 656c 6c73 2f7b 6275 7379 5f63 656c  /cells/{busy_cel
-00009080: 6c5f 7575 6964 7d2f 6578 6563 7574 6522  l_uuid}/execute"
-00009090: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
-000090a0: 2020 6865 6164 6572 733d 7375 7065 7275    headers=superu
-000090b0: 7365 725f 746f 6b65 6e5f 6865 6164 6572  ser_token_header
-000090c0: 732c 0a20 2020 2020 2020 2020 2020 2029  s,.            )
-000090d0: 0a20 2020 2020 2020 2020 2020 2061 7373  .            ass
-000090e0: 6572 7420 7265 7370 6f6e 7365 2e73 7461  ert response.sta
-000090f0: 7475 735f 636f 6465 203d 3d20 3230 300a  tus_code == 200.
-00009100: 0a20 2020 2020 2020 2020 2020 2023 2066  .            # f
-00009110: 6972 7374 2063 6875 6e6b 2072 6563 6569  irst chunk recei
-00009120: 7665 6420 7368 6f75 6c64 2062 6520 6120  ved should be a 
-00009130: 6365 6c6c 5f75 7064 6174 6520 7769 7468  cell_update with
-00009140: 0a20 2020 2020 2020 2020 2020 2023 2061  .            # a
-00009150: 6e20 6578 6563 7574 696f 6e5f 7374 6174  n execution_stat
-00009160: 6520 6f66 2027 6275 7379 2720 7768 656e  e of 'busy' when
-00009170: 2070 726f 6365 7373 696e 6720 7374 6172   processing star
-00009180: 7473 0a20 2020 2020 2020 2020 2020 2064  ts.            d
-00009190: 6174 6120 3d20 6177 6169 7420 7761 6974  ata = await wait
-000091a0: 5f66 6f72 5f65 7665 6e74 2877 6562 736f  _for_event(webso
-000091b0: 636b 6574 2c20 2263 656c 6c5f 7570 6461  cket, "cell_upda
-000091c0: 7465 2229 0a20 2020 2020 2020 2020 2020  te").           
-000091d0: 2064 315f 6d65 7461 6461 7461 203d 2064   d1_metadata = d
-000091e0: 6174 615b 2263 656c 6c5f 7570 6461 7465  ata["cell_update
-000091f0: 225d 5b30 5d5b 226d 6574 6164 6174 6122  "][0]["metadata"
-00009200: 5d5b 226a 7570 7974 6572 5f64 3122 5d0a  ]["jupyter_d1"].
-00009210: 2020 2020 2020 2020 2020 2020 6173 7365              asse
-00009220: 7274 2064 315f 6d65 7461 6461 7461 5b22  rt d1_metadata["
-00009230: 6578 6563 7574 696f 6e5f 7374 6174 6522  execution_state"
-00009240: 5d20 3d3d 2022 6275 7379 220a 0a20 2020  ] == "busy"..   
-00009250: 2020 2020 2020 2020 2023 204b 6572 6e65           # Kerne
-00009260: 6c20 7368 6f75 6c64 206e 6f74 2062 6520  l should not be 
-00009270: 6964 6c65 206e 6f77 0a20 2020 2020 2020  idle now.       
-00009280: 2020 2020 2069 735f 6964 6c65 2c20 6c61       is_idle, la
-00009290: 7374 5f69 646c 655f 3420 3d20 6177 6169  st_idle_4 = awai
-000092a0: 7420 6973 5f69 646c 655f 7374 6174 7573  t is_idle_status
-000092b0: 2829 0a20 2020 2020 2020 2020 2020 2061  ().            a
-000092c0: 7373 6572 7420 6973 5f69 646c 6520 6973  ssert is_idle is
-000092d0: 2046 616c 7365 0a20 2020 2020 2020 2020   False.         
-000092e0: 2020 2061 7373 6572 7420 6c61 7374 5f69     assert last_i
-000092f0: 646c 655f 3420 3d3d 206c 6173 745f 6964  dle_4 == last_id
-00009300: 6c65 5f33 0a0a 2020 2020 4070 7974 6573  le_3..    @pytes
-00009310: 742e 6d61 726b 2e61 7379 6e63 696f 0a20  t.mark.asyncio. 
-00009320: 2020 2061 7379 6e63 2064 6566 2074 6573     async def tes
-00009330: 745f 6b65 726e 656c 5f69 6e74 6572 7275  t_kernel_interru
-00009340: 7074 280a 2020 2020 2020 2020 7365 6c66  pt(.        self
-00009350: 2c0a 2020 2020 2020 2020 636c 6965 6e74  ,.        client
-00009360: 3a20 5465 7374 436c 6965 6e74 2c0a 2020  : TestClient,.  
-00009370: 2020 2020 2020 7375 7065 7275 7365 725f        superuser_
-00009380: 746f 6b65 6e5f 6865 6164 6572 733a 2044  token_headers: D
-00009390: 6963 745b 7374 722c 2073 7472 5d2c 0a20  ict[str, str],. 
-000093a0: 2020 2029 3a0a 2020 2020 2020 2020 6173     ):.        as
-000093b0: 796e 6320 6465 6620 6973 5f69 646c 655f  ync def is_idle_
-000093c0: 7374 6174 7573 2829 3a0a 2020 2020 2020  status():.      
-000093d0: 2020 2020 2020 7265 7370 6f6e 7365 203d        response =
-000093e0: 2061 7761 6974 2063 6c69 656e 742e 6765   await client.ge
-000093f0: 7428 0a20 2020 2020 2020 2020 2020 2020  t(.             
-00009400: 2020 2066 222f 6b65 726e 656c 732f 6964     f"/kernels/id
-00009410: 6c65 222c 2068 6561 6465 7273 3d73 7570  le", headers=sup
-00009420: 6572 7573 6572 5f74 6f6b 656e 5f68 6561  eruser_token_hea
-00009430: 6465 7273 0a20 2020 2020 2020 2020 2020  ders.           
-00009440: 2029 0a20 2020 2020 2020 2020 2020 2061   ).            a
-00009450: 7373 6572 7420 7265 7370 6f6e 7365 2e73  ssert response.s
-00009460: 7461 7475 735f 636f 6465 203d 3d20 3230  tatus_code == 20
-00009470: 300a 2020 2020 2020 2020 2020 2020 6a73  0.            js
-00009480: 6f6e 203d 2072 6573 706f 6e73 652e 6a73  on = response.js
-00009490: 6f6e 2829 0a20 2020 2020 2020 2020 2020  on().           
-000094a0: 2072 6574 7572 6e20 280a 2020 2020 2020   return (.      
-000094b0: 2020 2020 2020 2020 2020 6a73 6f6e 5b22            json["
-000094c0: 6964 6c65 225d 2c0a 2020 2020 2020 2020  idle"],.        
-000094d0: 2020 2020 2020 2020 6461 7465 7469 6d65          datetime
-000094e0: 2e73 7472 7074 696d 6528 6a73 6f6e 5b22  .strptime(json["
-000094f0: 6c61 7374 5f69 646c 6522 5d2c 2022 2559  last_idle"], "%Y
-00009500: 2d25 6d2d 2564 5425 483a 254d 3a25 532e  -%m-%dT%H:%M:%S.
-00009510: 2566 2229 2c0a 2020 2020 2020 2020 2020  %f"),.          
-00009520: 2020 290a 0a20 2020 2020 2020 2075 7569    )..        uui
-00009530: 6420 3d20 6177 6169 7420 7570 6c6f 6164  d = await upload
-00009540: 5f6e 6f74 6562 6f6f 6b28 0a20 2020 2020  _notebook(.     
-00009550: 2020 2020 2020 2063 6c69 656e 742c 2073         client, s
-00009560: 7570 6572 7573 6572 5f74 6f6b 656e 5f68  uperuser_token_h
-00009570: 6561 6465 7273 2c20 2273 696d 706c 652e  eaders, "simple.
-00009580: 6970 796e 6222 0a20 2020 2020 2020 2029  ipynb".        )
-00009590: 0a0a 2020 2020 2020 2020 2320 4b65 726e  ..        # Kern
-000095a0: 656c 2069 7320 6964 6c65 0a20 2020 2020  el is idle.     
-000095b0: 2020 2069 735f 6964 6c65 2c20 6c61 7374     is_idle, last
-000095c0: 5f69 646c 655f 3120 3d20 6177 6169 7420  _idle_1 = await 
-000095d0: 6973 5f69 646c 655f 7374 6174 7573 2829  is_idle_status()
-000095e0: 0a20 2020 2020 2020 2061 7373 6572 7420  .        assert 
-000095f0: 6973 5f69 646c 6520 6973 2054 7275 650a  is_idle is True.
-00009600: 0a20 2020 2020 2020 2023 2067 6574 2061  .        # get a
-00009610: 6e20 6578 6973 7469 6e67 2063 656c 6c0a  n existing cell.
-00009620: 2020 2020 2020 2020 7265 7370 6f6e 7365          response
-00009630: 203d 2061 7761 6974 2063 6c69 656e 742e   = await client.
-00009640: 6765 7428 0a20 2020 2020 2020 2020 2020  get(.           
-00009650: 2066 222f 6e6f 7465 626f 6f6b 732f 7b75   f"/notebooks/{u
-00009660: 7569 647d 2f63 656c 6c73 222c 2068 6561  uid}/cells", hea
-00009670: 6465 7273 3d73 7570 6572 7573 6572 5f74  ders=superuser_t
-00009680: 6f6b 656e 5f68 6561 6465 7273 0a20 2020  oken_headers.   
-00009690: 2020 2020 2029 0a20 2020 2020 2020 2061       ).        a
-000096a0: 7373 6572 7420 7265 7370 6f6e 7365 2e73  ssert response.s
-000096b0: 7461 7475 735f 636f 6465 203d 3d20 3230  tatus_code == 20
-000096c0: 300a 2020 2020 2020 2020 6365 6c6c 7320  0.        cells 
-000096d0: 3d20 7265 7370 6f6e 7365 2e6a 736f 6e28  = response.json(
-000096e0: 295b 2263 656c 6c73 225d 0a20 2020 2020  )["cells"].     
-000096f0: 2020 2061 7373 6572 7420 6365 6c6c 735b     assert cells[
-00009700: 315d 5b22 736f 7572 6365 225d 203d 3d20  1]["source"] == 
-00009710: 2770 7269 6e74 2822 4c61 7272 7920 7468  'print("Larry th
-00009720: 6520 4c6c 616d 6122 2927 0a0a 2020 2020  e Llama")'..    
-00009730: 2020 2020 6275 7379 5f63 656c 6c5f 7575      busy_cell_uu
-00009740: 6964 203d 2063 656c 6c73 5b31 5d5b 226d  id = cells[1]["m
-00009750: 6574 6164 6174 6122 5d5b 226a 7570 7974  etadata"]["jupyt
-00009760: 6572 5f64 3122 5d5b 2275 7569 6422 5d0a  er_d1"]["uuid"].
-00009770: 0a20 2020 2020 2020 2070 6172 616d 7320  .        params 
-00009780: 3d20 7b0a 2020 2020 2020 2020 2020 2020  = {.            
-00009790: 2273 6f75 7263 6522 3a20 2266 726f 6d20  "source": "from 
-000097a0: 7469 6d65 2069 6d70 6f72 7420 736c 6565  time import slee
-000097b0: 705c 6e77 6869 6c65 2054 7275 653a 5c6e  p\nwhile True:\n
-000097c0: 2020 2020 736c 6565 7028 3529 220a 2020      sleep(5)".  
-000097d0: 2020 2020 2020 7d0a 2020 2020 2020 2020        }.        
-000097e0: 7265 7370 6f6e 7365 203d 2061 7761 6974  response = await
-000097f0: 2063 6c69 656e 742e 7061 7463 6828 0a20   client.patch(. 
-00009800: 2020 2020 2020 2020 2020 2066 222f 6e6f             f"/no
-00009810: 7465 626f 6f6b 732f 7b75 7569 647d 2f63  tebooks/{uuid}/c
-00009820: 656c 6c73 2f7b 6275 7379 5f63 656c 6c5f  ells/{busy_cell_
-00009830: 7575 6964 7d22 2c0a 2020 2020 2020 2020  uuid}",.        
-00009840: 2020 2020 6a73 6f6e 3d70 6172 616d 732c      json=params,
-00009850: 0a20 2020 2020 2020 2020 2020 2068 6561  .            hea
-00009860: 6465 7273 3d73 7570 6572 7573 6572 5f74  ders=superuser_t
-00009870: 6f6b 656e 5f68 6561 6465 7273 2c0a 2020  oken_headers,.  
-00009880: 2020 2020 2020 290a 2020 2020 2020 2020        ).        
-00009890: 6173 7365 7274 2072 6573 706f 6e73 652e  assert response.
-000098a0: 7374 6174 7573 5f63 6f64 6520 3d3d 2032  status_code == 2
-000098b0: 3030 0a0a 2020 2020 2020 2020 6173 796e  00..        asyn
-000098c0: 6320 7769 7468 2063 6c69 656e 742e 7765  c with client.we
-000098d0: 6273 6f63 6b65 745f 636f 6e6e 6563 7428  bsocket_connect(
-000098e0: 0a20 2020 2020 2020 2020 2020 2066 222f  .            f"/
-000098f0: 6e6f 7465 626f 6f6b 732f 7b75 7569 647d  notebooks/{uuid}
-00009900: 2f77 732f 6e6f 7465 626f 6f6b 222c 2068  /ws/notebook", h
-00009910: 6561 6465 7273 3d73 7570 6572 7573 6572  eaders=superuser
-00009920: 5f74 6f6b 656e 5f68 6561 6465 7273 0a20  _token_headers. 
-00009930: 2020 2020 2020 2029 2061 7320 7765 6273         ) as webs
-00009940: 6f63 6b65 743a 0a20 2020 2020 2020 2020  ocket:.         
-00009950: 2020 2061 7761 6974 2061 7379 6e63 696f     await asyncio
-00009960: 2e73 6c65 6570 2857 4542 534f 434b 4554  .sleep(WEBSOCKET
-00009970: 5f53 4c45 4550 5f54 494d 4529 0a0a 2020  _SLEEP_TIME)..  
-00009980: 2020 2020 2020 2020 2020 7265 7370 6f6e            respon
-00009990: 7365 203d 2061 7761 6974 2063 6c69 656e  se = await clien
-000099a0: 742e 6765 7428 0a20 2020 2020 2020 2020  t.get(.         
-000099b0: 2020 2020 2020 2066 222f 6e6f 7465 626f         f"/notebo
-000099c0: 6f6b 732f 7b75 7569 647d 2f63 656c 6c73  oks/{uuid}/cells
-000099d0: 2f7b 6275 7379 5f63 656c 6c5f 7575 6964  /{busy_cell_uuid
-000099e0: 7d2f 6578 6563 7574 6522 2c0a 2020 2020  }/execute",.    
-000099f0: 2020 2020 2020 2020 2020 2020 6865 6164              head
-00009a00: 6572 733d 7375 7065 7275 7365 725f 746f  ers=superuser_to
-00009a10: 6b65 6e5f 6865 6164 6572 732c 0a20 2020  ken_headers,.   
-00009a20: 2020 2020 2020 2020 2029 0a20 2020 2020           ).     
-00009a30: 2020 2020 2020 2061 7373 6572 7420 7265         assert re
-00009a40: 7370 6f6e 7365 2e73 7461 7475 735f 636f  sponse.status_co
-00009a50: 6465 203d 3d20 3230 300a 2020 2020 2020  de == 200.      
-00009a60: 2020 2020 2020 6d73 675f 6964 203d 2072        msg_id = r
-00009a70: 6573 706f 6e73 652e 6a73 6f6e 2829 5b22  esponse.json()["
-00009a80: 6b65 726e 656c 5f6d 6573 7361 6765 225d  kernel_message"]
-00009a90: 5b22 6d65 7373 6167 655f 6964 225d 0a0a  ["message_id"]..
-00009aa0: 2020 2020 2020 2020 2020 2020 2320 6669              # fi
-00009ab0: 7273 7420 6368 756e 6b20 7265 6365 6976  rst chunk receiv
-00009ac0: 6564 2073 686f 756c 6420 6265 2061 2063  ed should be a c
-00009ad0: 656c 6c5f 7570 6461 7465 2077 6974 680a  ell_update with.
-00009ae0: 2020 2020 2020 2020 2020 2020 2320 616e              # an
-00009af0: 2065 7865 6375 7469 6f6e 5f73 7461 7465   execution_state
-00009b00: 206f 6620 2762 7573 7927 2077 6865 6e20   of 'busy' when 
-00009b10: 7072 6f63 6573 7369 6e67 2073 7461 7274  processing start
-00009b20: 730a 2020 2020 2020 2020 2020 2020 6461  s.            da
-00009b30: 7461 203d 2061 7761 6974 2077 6169 745f  ta = await wait_
-00009b40: 666f 725f 6576 656e 7428 7765 6273 6f63  for_event(websoc
-00009b50: 6b65 742c 2022 6365 6c6c 5f75 7064 6174  ket, "cell_updat
-00009b60: 6522 290a 2020 2020 2020 2020 2020 2020  e").            
-00009b70: 6431 5f6d 6574 6164 6174 6120 3d20 6461  d1_metadata = da
-00009b80: 7461 5b22 6365 6c6c 5f75 7064 6174 6522  ta["cell_update"
-00009b90: 5d5b 305d 5b22 6d65 7461 6461 7461 225d  ][0]["metadata"]
-00009ba0: 5b22 6a75 7079 7465 725f 6431 225d 0a20  ["jupyter_d1"]. 
-00009bb0: 2020 2020 2020 2020 2020 2061 7373 6572             asser
-00009bc0: 7420 6431 5f6d 6574 6164 6174 615b 2265  t d1_metadata["e
-00009bd0: 7865 6375 7469 6f6e 5f73 7461 7465 225d  xecution_state"]
-00009be0: 203d 3d20 2262 7573 7922 0a20 2020 2020   == "busy".     
-00009bf0: 2020 2020 2020 2061 7373 6572 7420 6431         assert d1
-00009c00: 5f6d 6574 6164 6174 615b 2275 7569 6422  _metadata["uuid"
-00009c10: 5d20 3d3d 2062 7573 795f 6365 6c6c 5f75  ] == busy_cell_u
-00009c20: 7569 640a 0a20 2020 2020 2020 2020 2020  uid..           
-00009c30: 2023 204b 6572 6e65 6c20 7368 6f75 6c64   # Kernel should
-00009c40: 206e 6f74 2062 6520 6964 6c65 206e 6f77   not be idle now
-00009c50: 0a20 2020 2020 2020 2020 2020 2069 735f  .            is_
-00009c60: 6964 6c65 2c20 6c61 7374 5f69 646c 655f  idle, last_idle_
-00009c70: 3220 3d20 6177 6169 7420 6973 5f69 646c  2 = await is_idl
-00009c80: 655f 7374 6174 7573 2829 0a20 2020 2020  e_status().     
-00009c90: 2020 2020 2020 2061 7373 6572 7420 6973         assert is
-00009ca0: 5f69 646c 6520 6973 2046 616c 7365 0a20  _idle is False. 
-00009cb0: 2020 2020 2020 2020 2020 2061 7373 6572             asser
-00009cc0: 7420 6c61 7374 5f69 646c 655f 3220 3d3d  t last_idle_2 ==
-00009cd0: 206c 6173 745f 6964 6c65 5f31 0a0a 2020   last_idle_1..  
-00009ce0: 2020 2020 2020 2020 2020 7265 7370 6f6e            respon
-00009cf0: 7365 203d 2061 7761 6974 2063 6c69 656e  se = await clien
-00009d00: 742e 6765 7428 0a20 2020 2020 2020 2020  t.get(.         
-00009d10: 2020 2020 2020 2066 222f 6e6f 7465 626f         f"/notebo
-00009d20: 6f6b 732f 7b75 7569 647d 2f69 6e74 6572  oks/{uuid}/inter
-00009d30: 7275 7074 5f6b 6572 6e65 6c22 2c0a 2020  rupt_kernel",.  
-00009d40: 2020 2020 2020 2020 2020 2020 2020 6865                he
-00009d50: 6164 6572 733d 7375 7065 7275 7365 725f  aders=superuser_
-00009d60: 746f 6b65 6e5f 6865 6164 6572 732c 0a20  token_headers,. 
-00009d70: 2020 2020 2020 2020 2020 2029 0a20 2020             ).   
-00009d80: 2020 2020 2020 2020 2061 7373 6572 7420           assert 
-00009d90: 7265 7370 6f6e 7365 2e73 7461 7475 735f  response.status_
-00009da0: 636f 6465 203d 3d20 3230 340a 0a20 2020  code == 204..   
-00009db0: 2020 2020 2020 2020 2064 6174 6120 3d20           data = 
-00009dc0: 6177 6169 7420 7761 6974 5f66 6f72 5f65  await wait_for_e
-00009dd0: 7665 6e74 2877 6562 736f 636b 6574 2c20  vent(websocket, 
-00009de0: 226b 6572 6e65 6c5f 696e 7465 7272 7570  "kernel_interrup
-00009df0: 7465 6422 290a 2020 2020 2020 2020 2020  ted").          
-00009e00: 2020 6173 7365 7274 2064 6174 615b 226b    assert data["k
-00009e10: 6572 6e65 6c5f 696e 7465 7272 7570 7465  ernel_interrupte
-00009e20: 6422 5d5b 2269 6e74 6572 7275 7074 6564  d"]["interrupted
-00009e30: 225d 2069 7320 5472 7565 0a0a 2020 2020  "] is True..    
-00009e40: 2020 2020 2020 2020 2320 5265 6365 6976          # Receiv
-00009e50: 6520 6365 6c6c 2065 7272 6f72 206f 7574  e cell error out
-00009e60: 7075 740a 2020 2020 2020 2020 2020 2020  put.            
-00009e70: 6461 7461 203d 2061 7761 6974 2077 6169  data = await wai
-00009e80: 745f 666f 725f 6576 656e 7428 7765 6273  t_for_event(webs
-00009e90: 6f63 6b65 742c 2022 6365 6c6c 5f75 7064  ocket, "cell_upd
-00009ea0: 6174 6522 290a 2020 2020 2020 2020 2020  ate").          
-00009eb0: 2020 6431 5f6d 6574 6164 6174 6120 3d20    d1_metadata = 
-00009ec0: 6461 7461 5b22 6365 6c6c 5f75 7064 6174  data["cell_updat
-00009ed0: 6522 5d5b 305d 5b22 6d65 7461 6461 7461  e"][0]["metadata
-00009ee0: 225d 5b22 6a75 7079 7465 725f 6431 225d  "]["jupyter_d1"]
-00009ef0: 0a20 2020 2020 2020 2020 2020 2061 7373  .            ass
-00009f00: 6572 7420 6431 5f6d 6574 6164 6174 615b  ert d1_metadata[
-00009f10: 2265 7865 6375 7469 6f6e 5f73 7461 7465  "execution_state
-00009f20: 225d 203d 3d20 2262 7573 7922 0a20 2020  "] == "busy".   
-00009f30: 2020 2020 2020 2020 2061 7373 6572 7420           assert 
-00009f40: 6461 7461 5b22 6365 6c6c 5f75 7064 6174  data["cell_updat
-00009f50: 6522 5d5b 305d 5b22 6578 6563 7574 696f  e"][0]["executio
-00009f60: 6e5f 636f 756e 7422 5d20 6973 204e 6f6e  n_count"] is Non
-00009f70: 650a 2020 2020 2020 2020 2020 2020 6173  e.            as
-00009f80: 7365 7274 2064 315f 6d65 7461 6461 7461  sert d1_metadata
-00009f90: 5b22 706f 7369 7469 6f6e 225d 203d 3d20  ["position"] == 
-00009fa0: 310a 2020 2020 2020 2020 2020 2020 6173  1.            as
-00009fb0: 7365 7274 2064 315f 6d65 7461 6461 7461  sert d1_metadata
-00009fc0: 5b22 7575 6964 225d 203d 3d20 6275 7379  ["uuid"] == busy
-00009fd0: 5f63 656c 6c5f 7575 6964 0a20 2020 2020  _cell_uuid.     
-00009fe0: 2020 2020 2020 2063 656c 6c20 3d20 6461         cell = da
-00009ff0: 7461 5b22 6365 6c6c 5f75 7064 6174 6522  ta["cell_update"
-0000a000: 5d5b 305d 0a20 2020 2020 2020 2020 2020  ][0].           
-0000a010: 2061 7373 6572 7420 6365 6c6c 5b22 6365   assert cell["ce
-0000a020: 6c6c 5f74 7970 6522 5d20 3d3d 2022 636f  ll_type"] == "co
-0000a030: 6465 220a 2020 2020 2020 2020 2020 2020  de".            
-0000a040: 6173 7365 7274 206c 656e 2863 656c 6c5b  assert len(cell[
-0000a050: 226f 7574 7075 7473 225d 2920 3d3d 2031  "outputs"]) == 1
-0000a060: 0a20 2020 2020 2020 2020 2020 2061 7373  .            ass
-0000a070: 6572 7420 6365 6c6c 5b22 6f75 7470 7574  ert cell["output
-0000a080: 7322 5d5b 305d 5b22 656e 616d 6522 5d20  s"][0]["ename"] 
-0000a090: 3d3d 2022 4b65 7962 6f61 7264 496e 7465  == "KeyboardInte
-0000a0a0: 7272 7570 7422 0a20 2020 2020 2020 2020  rrupt".         
-0000a0b0: 2020 2061 7373 6572 7420 224b 6579 626f     assert "Keybo
-0000a0c0: 6172 6449 6e74 6572 7275 7074 2220 696e  ardInterrupt" in
-0000a0d0: 2063 656c 6c5b 226f 7574 7075 7473 225d   cell["outputs"]
-0000a0e0: 5b30 5d5b 2274 7261 6365 6261 636b 225d  [0]["traceback"]
-0000a0f0: 5b31 5d0a 0a20 2020 2020 2020 2020 2020  [1]..           
-0000a100: 2064 6566 2061 7373 6572 745f 6a73 6f6e   def assert_json
-0000a110: 5f63 6f6e 7465 6e74 2864 6174 612c 2065  _content(data, e
-0000a120: 7865 6375 7469 6f6e 5f63 6f75 6e74 3d4e  xecution_count=N
-0000a130: 6f6e 6529 3a0a 2020 2020 2020 2020 2020  one):.          
-0000a140: 2020 2020 2020 6966 2022 6365 6c6c 5f75        if "cell_u
-0000a150: 7064 6174 6522 2069 6e20 6461 7461 3a0a  pdate" in data:.
-0000a160: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000a170: 2020 2020 6365 6c6c 5f64 6174 6120 3d20      cell_data = 
-0000a180: 6461 7461 5b22 6365 6c6c 5f75 7064 6174  data["cell_updat
-0000a190: 6522 5d5b 305d 0a20 2020 2020 2020 2020  e"][0].         
-0000a1a0: 2020 2020 2020 2020 2020 2064 315f 6d65             d1_me
-0000a1b0: 7461 6461 7461 203d 2063 656c 6c5f 6461  tadata = cell_da
-0000a1c0: 7461 5b22 6d65 7461 6461 7461 225d 5b22  ta["metadata"]["
-0000a1d0: 6a75 7079 7465 725f 6431 225d 0a20 2020  jupyter_d1"].   
-0000a1e0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000a1f0: 2061 7373 6572 7420 6431 5f6d 6574 6164   assert d1_metad
-0000a200: 6174 615b 2265 7865 6375 7469 6f6e 5f73  ata["execution_s
-0000a210: 7461 7465 225d 203d 3d20 2269 646c 6522  tate"] == "idle"
-0000a220: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-0000a230: 2020 2020 2061 7373 6572 7420 6431 5f6d       assert d1_m
-0000a240: 6574 6164 6174 615b 2275 7569 6422 5d20  etadata["uuid"] 
-0000a250: 3d3d 2062 7573 795f 6365 6c6c 5f75 7569  == busy_cell_uui
-0000a260: 640a 2020 2020 2020 2020 2020 2020 2020  d.              
-0000a270: 2020 2020 2020 6173 7365 7274 2063 656c        assert cel
-0000a280: 6c5f 6461 7461 5b22 6578 6563 7574 696f  l_data["executio
-0000a290: 6e5f 636f 756e 7422 5d20 3d3d 2065 7865  n_count"] == exe
-0000a2a0: 6375 7469 6f6e 5f63 6f75 6e74 0a20 2020  cution_count.   
-0000a2b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000a2c0: 2072 6574 7572 6e20 4e6f 6e65 0a20 2020   return None.   
-0000a2d0: 2020 2020 2020 2020 2020 2020 2065 6c69               eli
-0000a2e0: 6620 2263 656c 6c5f 6578 6563 7574 696f  f "cell_executio
-0000a2f0: 6e5f 7265 706c 7922 2069 6e20 6461 7461  n_reply" in data
-0000a300: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
-0000a310: 2020 2020 2020 6173 7365 7274 2064 6174        assert dat
-0000a320: 615b 2263 656c 6c5f 6578 6563 7574 696f  a["cell_executio
-0000a330: 6e5f 7265 706c 7922 5d5b 2265 7865 6375  n_reply"]["execu
-0000a340: 7469 6f6e 5f63 6f75 6e74 225d 203d 3d20  tion_count"] == 
-0000a350: 310a 2020 2020 2020 2020 2020 2020 2020  1.              
-0000a360: 2020 2020 2020 6173 7365 7274 2028 0a20        assert (. 
-0000a370: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000a380: 2020 2020 2020 2064 6174 615b 2263 656c         data["cel
-0000a390: 6c5f 6578 6563 7574 696f 6e5f 7265 706c  l_execution_repl
-0000a3a0: 7922 5d5b 2263 656c 6c5f 6964 225d 0a20  y"]["cell_id"]. 
-0000a3b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000a3c0: 2020 2020 2020 203d 3d20 6275 7379 5f63         == busy_c
-0000a3d0: 656c 6c5f 7575 6964 0a20 2020 2020 2020  ell_uuid.       
-0000a3e0: 2020 2020 2020 2020 2020 2020 2029 0a20               ). 
-0000a3f0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000a400: 2020 2061 7373 6572 7420 6c65 6e28 6461     assert len(da
-0000a410: 7461 5b22 6365 6c6c 5f65 7865 6375 7469  ta["cell_executi
-0000a420: 6f6e 5f72 6570 6c79 225d 5b22 7061 7265  on_reply"]["pare
-0000a430: 6e74 5f69 6422 5d29 2069 6e20 5c0a 2020  nt_id"]) in \.  
-0000a440: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000a450: 2020 2020 2020 6d73 675f 6964 5f6c 656e        msg_id_len
-0000a460: 6774 6873 0a20 2020 2020 2020 2020 2020  gths.           
-0000a470: 2020 2020 2020 2020 2061 7373 6572 7420           assert 
-0000a480: 6461 7461 5b22 6365 6c6c 5f65 7865 6375  data["cell_execu
-0000a490: 7469 6f6e 5f72 6570 6c79 225d 5b22 7061  tion_reply"]["pa
-0000a4a0: 7265 6e74 5f69 6422 5d20 3d3d 206d 7367  rent_id"] == msg
-0000a4b0: 5f69 640a 2020 2020 2020 2020 2020 2020  _id.            
-0000a4c0: 2020 2020 2020 2020 7265 7475 726e 2031          return 1
-0000a4d0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-0000a4e0: 2065 6c73 653a 0a20 2020 2020 2020 2020   else:.         
-0000a4f0: 2020 2020 2020 2020 2020 2072 6169 7365             raise
-0000a500: 2041 7373 6572 7469 6f6e 4572 726f 7228   AssertionError(
-0000a510: 6622 756e 6578 7065 6374 6564 2063 656c  f"unexpected cel
-0000a520: 6c20 7479 7065 3a20 7b64 6174 617d 2229  l type: {data}")
-0000a530: 0a0a 2020 2020 2020 2020 2020 2020 2320  ..            # 
-0000a540: 4578 6563 7574 696f 6e20 636f 756e 7420  Execution count 
-0000a550: 7570 6461 7465 0a20 2020 2020 2020 2020  update.         
-0000a560: 2020 2064 6174 6120 3d20 6177 6169 7420     data = await 
-0000a570: 7761 6974 5f66 6f72 5f65 7665 6e74 2877  wait_for_event(w
-0000a580: 6562 736f 636b 6574 2c20 2263 656c 6c5f  ebsocket, "cell_
-0000a590: 6578 6563 7574 696f 6e5f 7265 706c 7922  execution_reply"
-0000a5a0: 290a 2020 2020 2020 2020 2020 2020 6578  ).            ex
-0000a5b0: 6563 5f63 6f75 6e74 203d 2061 7373 6572  ec_count = asser
-0000a5c0: 745f 6a73 6f6e 5f63 6f6e 7465 6e74 2864  t_json_content(d
-0000a5d0: 6174 6129 0a20 2020 2020 2020 2020 2020  ata).           
-0000a5e0: 2064 6174 6120 3d20 6177 6169 7420 7761   data = await wa
-0000a5f0: 6974 5f66 6f72 5f65 7665 6e74 2877 6562  it_for_event(web
-0000a600: 736f 636b 6574 2c20 2263 656c 6c5f 7570  socket, "cell_up
-0000a610: 6461 7465 2229 0a20 2020 2020 2020 2020  date").         
-0000a620: 2020 2061 7373 6572 745f 6a73 6f6e 5f63     assert_json_c
-0000a630: 6f6e 7465 6e74 2864 6174 612c 2065 7865  ontent(data, exe
-0000a640: 635f 636f 756e 7429 0a0a 2020 2020 2020  c_count)..      
-0000a650: 2020 2020 2020 2320 4b65 726e 656c 2073        # Kernel s
-0000a660: 686f 756c 6420 6265 2069 646c 6520 6e6f  hould be idle no
-0000a670: 770a 2020 2020 2020 2020 2020 2020 6973  w.            is
-0000a680: 5f69 646c 652c 206c 6173 745f 6964 6c65  _idle, last_idle
-0000a690: 5f33 203d 2061 7761 6974 2069 735f 6964  _3 = await is_id
-0000a6a0: 6c65 5f73 7461 7475 7328 290a 2020 2020  le_status().    
-0000a6b0: 2020 2020 2020 2020 6173 7365 7274 2069          assert i
-0000a6c0: 735f 6964 6c65 2069 7320 5472 7565 0a20  s_idle is True. 
-0000a6d0: 2020 2020 2020 2020 2020 2061 7373 6572             asser
-0000a6e0: 7420 6c61 7374 5f69 646c 655f 3320 3e20  t last_idle_3 > 
-0000a6f0: 6c61 7374 5f69 646c 655f 320a 0a20 2020  last_idle_2..   
-0000a700: 2040 7079 7465 7374 2e6d 6172 6b2e 6173   @pytest.mark.as
-0000a710: 796e 6369 6f0a 2020 2020 6173 796e 6320  yncio.    async 
-0000a720: 6465 6620 7465 7374 5f62 6f67 7573 5f63  def test_bogus_c
-0000a730: 6f64 655f 6572 726f 7228 0a20 2020 2020  ode_error(.     
-0000a740: 2020 2073 656c 662c 0a20 2020 2020 2020     self,.       
-0000a750: 2063 6c69 656e 743a 2054 6573 7443 6c69   client: TestCli
-0000a760: 656e 742c 0a20 2020 2020 2020 2072 6561  ent,.        rea
-0000a770: 646f 6e6c 795f 746f 6b65 6e5f 6865 6164  donly_token_head
-0000a780: 6572 733a 2044 6963 745b 7374 722c 2073  ers: Dict[str, s
-0000a790: 7472 5d2c 0a20 2020 2020 2020 2070 6572  tr],.        per
-0000a7a0: 6d69 7373 696f 6e6c 6573 735f 746f 6b65  missionless_toke
-0000a7b0: 6e5f 6865 6164 6572 733a 2044 6963 745b  n_headers: Dict[
-0000a7c0: 7374 722c 2073 7472 5d2c 0a20 2020 2020  str, str],.     
-0000a7d0: 2020 2073 7570 6572 7573 6572 5f74 6f6b     superuser_tok
-0000a7e0: 656e 5f68 6561 6465 7273 3a20 4469 6374  en_headers: Dict
-0000a7f0: 5b73 7472 2c20 7374 725d 2c0a 2020 2020  [str, str],.    
-0000a800: 293a 0a20 2020 2020 2020 2075 7569 6420  ):.        uuid 
-0000a810: 3d20 6177 6169 7420 7570 6c6f 6164 5f6e  = await upload_n
-0000a820: 6f74 6562 6f6f 6b28 0a20 2020 2020 2020  otebook(.       
-0000a830: 2020 2020 2063 6c69 656e 742c 2073 7570       client, sup
-0000a840: 6572 7573 6572 5f74 6f6b 656e 5f68 6561  eruser_token_hea
-0000a850: 6465 7273 2c20 2273 696d 706c 652e 6970  ders, "simple.ip
-0000a860: 796e 6222 0a20 2020 2020 2020 2029 0a0a  ynb".        )..
-0000a870: 2020 2020 2020 2020 2320 6765 7420 616e          # get an
-0000a880: 2065 7869 7374 696e 6720 6365 6c6c 0a20   existing cell. 
-0000a890: 2020 2020 2020 2072 6573 706f 6e73 6520         response 
-0000a8a0: 3d20 6177 6169 7420 636c 6965 6e74 2e67  = await client.g
-0000a8b0: 6574 280a 2020 2020 2020 2020 2020 2020  et(.            
-0000a8c0: 6622 2f6e 6f74 6562 6f6f 6b73 2f7b 7575  f"/notebooks/{uu
-0000a8d0: 6964 7d2f 6365 6c6c 7322 2c20 6865 6164  id}/cells", head
-0000a8e0: 6572 733d 7375 7065 7275 7365 725f 746f  ers=superuser_to
-0000a8f0: 6b65 6e5f 6865 6164 6572 730a 2020 2020  ken_headers.    
-0000a900: 2020 2020 290a 2020 2020 2020 2020 6173      ).        as
-0000a910: 7365 7274 2072 6573 706f 6e73 652e 7374  sert response.st
-0000a920: 6174 7573 5f63 6f64 6520 3d3d 2032 3030  atus_code == 200
-0000a930: 0a20 2020 2020 2020 2063 656c 6c73 203d  .        cells =
-0000a940: 2072 6573 706f 6e73 652e 6a73 6f6e 2829   response.json()
-0000a950: 5b22 6365 6c6c 7322 5d0a 2020 2020 2020  ["cells"].      
-0000a960: 2020 6365 6c6c 5f75 7569 6420 3d20 6365    cell_uuid = ce
-0000a970: 6c6c 735b 315d 5b22 6d65 7461 6461 7461  lls[1]["metadata
-0000a980: 225d 5b22 6a75 7079 7465 725f 6431 225d  "]["jupyter_d1"]
-0000a990: 5b22 7575 6964 225d 0a0a 2020 2020 2020  ["uuid"]..      
-0000a9a0: 2020 7061 7261 6d73 203d 207b 2273 6f75    params = {"sou
-0000a9b0: 7263 6522 3a20 2274 6869 7320 6973 6e74  rce": "this isnt
-0000a9c0: 2063 6f64 6522 7d0a 2020 2020 2020 2020   code"}.        
-0000a9d0: 7265 7370 6f6e 7365 203d 2061 7761 6974  response = await
-0000a9e0: 2063 6c69 656e 742e 7061 7463 6828 0a20   client.patch(. 
-0000a9f0: 2020 2020 2020 2020 2020 2066 222f 6e6f             f"/no
-0000aa00: 7465 626f 6f6b 732f 7b75 7569 647d 2f63  tebooks/{uuid}/c
-0000aa10: 656c 6c73 2f7b 6365 6c6c 5f75 7569 647d  ells/{cell_uuid}
-0000aa20: 222c 0a20 2020 2020 2020 2020 2020 206a  ",.            j
-0000aa30: 736f 6e3d 7061 7261 6d73 2c0a 2020 2020  son=params,.    
-0000aa40: 2020 2020 2020 2020 6865 6164 6572 733d          headers=
-0000aa50: 7375 7065 7275 7365 725f 746f 6b65 6e5f  superuser_token_
-0000aa60: 6865 6164 6572 732c 0a20 2020 2020 2020  headers,.       
-0000aa70: 2029 0a20 2020 2020 2020 2061 7373 6572   ).        asser
-0000aa80: 7420 7265 7370 6f6e 7365 2e73 7461 7475  t response.statu
-0000aa90: 735f 636f 6465 203d 3d20 3230 300a 0a20  s_code == 200.. 
-0000aaa0: 2020 2020 2020 2061 7379 6e63 2077 6974         async wit
-0000aab0: 6820 636c 6965 6e74 2e77 6562 736f 636b  h client.websock
-0000aac0: 6574 5f63 6f6e 6e65 6374 280a 2020 2020  et_connect(.    
-0000aad0: 2020 2020 2020 2020 6622 2f6e 6f74 6562          f"/noteb
-0000aae0: 6f6f 6b73 2f7b 7575 6964 7d2f 7773 2f6e  ooks/{uuid}/ws/n
-0000aaf0: 6f74 6562 6f6f 6b22 2c20 6865 6164 6572  otebook", header
-0000ab00: 733d 7375 7065 7275 7365 725f 746f 6b65  s=superuser_toke
-0000ab10: 6e5f 6865 6164 6572 730a 2020 2020 2020  n_headers.      
-0000ab20: 2020 2920 6173 2077 6562 736f 636b 6574    ) as websocket
-0000ab30: 3a0a 2020 2020 2020 2020 2020 2020 6177  :.            aw
-0000ab40: 6169 7420 6173 796e 6369 6f2e 736c 6565  ait asyncio.slee
-0000ab50: 7028 5745 4253 4f43 4b45 545f 534c 4545  p(WEBSOCKET_SLEE
-0000ab60: 505f 5449 4d45 290a 0a20 2020 2020 2020  P_TIME)..       
-0000ab70: 2020 2020 2072 6573 706f 6e73 6520 3d20       response = 
-0000ab80: 6177 6169 7420 636c 6965 6e74 2e67 6574  await client.get
-0000ab90: 280a 2020 2020 2020 2020 2020 2020 2020  (.              
-0000aba0: 2020 6622 2f6e 6f74 6562 6f6f 6b73 2f7b    f"/notebooks/{
-0000abb0: 7575 6964 7d2f 6365 6c6c 732f 7b63 656c  uuid}/cells/{cel
-0000abc0: 6c5f 7575 6964 7d2f 6578 6563 7574 6522  l_uuid}/execute"
-0000abd0: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
-0000abe0: 2020 6865 6164 6572 733d 7375 7065 7275    headers=superu
-0000abf0: 7365 725f 746f 6b65 6e5f 6865 6164 6572  ser_token_header
-0000ac00: 732c 0a20 2020 2020 2020 2020 2020 2029  s,.            )
-0000ac10: 0a20 2020 2020 2020 2020 2020 2061 7373  .            ass
-0000ac20: 6572 7420 7265 7370 6f6e 7365 2e73 7461  ert response.sta
-0000ac30: 7475 735f 636f 6465 203d 3d20 3230 300a  tus_code == 200.
-0000ac40: 2020 2020 2020 2020 2020 2020 6d73 675f              msg_
-0000ac50: 6964 203d 2072 6573 706f 6e73 652e 6a73  id = response.js
-0000ac60: 6f6e 2829 5b22 6b65 726e 656c 5f6d 6573  on()["kernel_mes
-0000ac70: 7361 6765 225d 5b22 6d65 7373 6167 655f  sage"]["message_
-0000ac80: 6964 225d 0a0a 2020 2020 2020 2020 2020  id"]..          
-0000ac90: 2020 2320 6578 6563 7574 696f 6e5f 636f    # execution_co
-0000aca0: 756e 7420 7570 6461 7465 2061 6e64 2062  unt update and b
-0000acb0: 7573 7920 7374 6174 7573 2075 7064 6174  usy status updat
-0000acc0: 652c 0a20 2020 2020 2020 2020 2020 2023  e,.            #
-0000acd0: 2069 6e20 756e 6365 7274 6169 6e20 6f72   in uncertain or
-0000ace0: 6465 720a 2020 2020 2020 2020 2020 2020  der.            
-0000acf0: 6465 6620 6173 7365 7274 5f6a 736f 6e5f  def assert_json_
-0000ad00: 636f 6e74 656e 7428 6461 7461 2c20 6578  content(data, ex
-0000ad10: 6563 7574 696f 6e5f 636f 756e 743d 4e6f  ecution_count=No
-0000ad20: 6e65 293a 0a20 2020 2020 2020 2020 2020  ne):.           
-0000ad30: 2020 2020 2069 6620 2263 656c 6c5f 7570       if "cell_up
-0000ad40: 6461 7465 2220 696e 2064 6174 613a 0a20  date" in data:. 
-0000ad50: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000ad60: 2020 2063 656c 6c5f 6461 7461 203d 2064     cell_data = d
-0000ad70: 6174 615b 2263 656c 6c5f 7570 6461 7465  ata["cell_update
-0000ad80: 225d 5b30 5d0a 2020 2020 2020 2020 2020  "][0].          
-0000ad90: 2020 2020 2020 2020 2020 6431 5f6d 6574            d1_met
-0000ada0: 6164 6174 6120 3d20 6365 6c6c 5f64 6174  adata = cell_dat
-0000adb0: 615b 226d 6574 6164 6174 6122 5d5b 226a  a["metadata"]["j
-0000adc0: 7570 7974 6572 5f64 3122 5d0a 2020 2020  upyter_d1"].    
-0000add0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000ade0: 6173 7365 7274 2064 315f 6d65 7461 6461  assert d1_metada
-0000adf0: 7461 5b22 6578 6563 7574 696f 6e5f 7374  ta["execution_st
-0000ae00: 6174 6522 5d20 3d3d 2022 6275 7379 220a  ate"] == "busy".
-0000ae10: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000ae20: 2020 2020 6173 7365 7274 2064 315f 6d65      assert d1_me
-0000ae30: 7461 6461 7461 5b22 7575 6964 225d 203d  tadata["uuid"] =
-0000ae40: 3d20 6365 6c6c 5f75 7569 640a 2020 2020  = cell_uuid.    
-0000ae50: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000ae60: 6173 7365 7274 2064 315f 6d65 7461 6461  assert d1_metada
-0000ae70: 7461 5b22 706f 7369 7469 6f6e 225d 203d  ta["position"] =
-0000ae80: 3d20 310a 2020 2020 2020 2020 2020 2020  = 1.            
-0000ae90: 2020 2020 2020 2020 6173 7365 7274 2063          assert c
-0000aea0: 656c 6c5f 6461 7461 5b22 6578 6563 7574  ell_data["execut
-0000aeb0: 696f 6e5f 636f 756e 7422 5d20 3d3d 2065  ion_count"] == e
-0000aec0: 7865 6375 7469 6f6e 5f63 6f75 6e74 0a20  xecution_count. 
-0000aed0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000aee0: 2020 2063 656c 6c20 3d20 6461 7461 5b22     cell = data["
-0000aef0: 6365 6c6c 5f75 7064 6174 6522 5d5b 305d  cell_update"][0]
-0000af00: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-0000af10: 2020 2020 2061 7373 6572 7420 6365 6c6c       assert cell
-0000af20: 5b22 6365 6c6c 5f74 7970 6522 5d20 3d3d  ["cell_type"] ==
-0000af30: 2022 636f 6465 220a 2020 2020 2020 2020   "code".        
-0000af40: 2020 2020 2020 2020 2020 2020 6173 7365              asse
-0000af50: 7274 206c 656e 2863 656c 6c5b 226f 7574  rt len(cell["out
-0000af60: 7075 7473 225d 2920 3d3d 2030 0a20 2020  puts"]) == 0.   
-0000af70: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000af80: 2072 6574 7572 6e20 4e6f 6e65 0a20 2020   return None.   
-0000af90: 2020 2020 2020 2020 2020 2020 2065 6c69               eli
-0000afa0: 6620 2263 656c 6c5f 6578 6563 7574 696f  f "cell_executio
-0000afb0: 6e5f 7265 706c 7922 2069 6e20 6461 7461  n_reply" in data
-0000afc0: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
-0000afd0: 2020 2020 2020 6173 7365 7274 2064 6174        assert dat
-0000afe0: 615b 2263 656c 6c5f 6578 6563 7574 696f  a["cell_executio
-0000aff0: 6e5f 7265 706c 7922 5d5b 2265 7865 6375  n_reply"]["execu
-0000b000: 7469 6f6e 5f63 6f75 6e74 225d 203d 3d20  tion_count"] == 
-0000b010: 310a 2020 2020 2020 2020 2020 2020 2020  1.              
-0000b020: 2020 2020 2020 6173 7365 7274 2064 6174        assert dat
-0000b030: 615b 2263 656c 6c5f 6578 6563 7574 696f  a["cell_executio
-0000b040: 6e5f 7265 706c 7922 5d5b 2263 656c 6c5f  n_reply"]["cell_
-0000b050: 6964 225d 203d 3d20 6365 6c6c 5f75 7569  id"] == cell_uui
-0000b060: 640a 2020 2020 2020 2020 2020 2020 2020  d.              
-0000b070: 2020 2020 2020 6173 7365 7274 206c 656e        assert len
-0000b080: 2864 6174 615b 2263 656c 6c5f 6578 6563  (data["cell_exec
-0000b090: 7574 696f 6e5f 7265 706c 7922 5d5b 2270  ution_reply"]["p
-0000b0a0: 6172 656e 745f 6964 225d 2920 696e 205c  arent_id"]) in \
-0000b0b0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-0000b0c0: 2020 2020 2020 2020 206d 7367 5f69 645f           msg_id_
-0000b0d0: 6c65 6e67 7468 730a 2020 2020 2020 2020  lengths.        
-0000b0e0: 2020 2020 2020 2020 2020 2020 6173 7365              asse
-0000b0f0: 7274 2064 6174 615b 2263 656c 6c5f 6578  rt data["cell_ex
-0000b100: 6563 7574 696f 6e5f 7265 706c 7922 5d5b  ecution_reply"][
-0000b110: 2270 6172 656e 745f 6964 225d 203d 3d20  "parent_id"] == 
-0000b120: 6d73 675f 6964 0a20 2020 2020 2020 2020  msg_id.         
-0000b130: 2020 2020 2020 2020 2020 2072 6574 7572             retur
-0000b140: 6e20 310a 2020 2020 2020 2020 2020 2020  n 1.            
-0000b150: 2020 2020 656c 7365 3a0a 2020 2020 2020      else:.      
-0000b160: 2020 2020 2020 2020 2020 2020 2020 7261                ra
-0000b170: 6973 6520 4173 7365 7274 696f 6e45 7272  ise AssertionErr
-0000b180: 6f72 2866 2275 6e65 7870 6563 7465 6420  or(f"unexpected 
-0000b190: 6365 6c6c 2074 7970 653a 207b 6461 7461  cell type: {data
-0000b1a0: 7d22 290a 0a20 2020 2020 2020 2020 2020  }")..           
-0000b1b0: 206d 7367 5f74 7970 6573 203d 205b 0a20   msg_types = [. 
-0000b1c0: 2020 2020 2020 2020 2020 2020 2020 2022                 "
-0000b1d0: 6365 6c6c 5f75 7064 6174 6522 2c0a 2020  cell_update",.  
-0000b1e0: 2020 2020 2020 2020 2020 2020 2020 2263                "c
-0000b1f0: 656c 6c5f 6578 6563 7574 696f 6e5f 7265  ell_execution_re
-0000b200: 706c 7922 2c0a 2020 2020 2020 2020 2020  ply",.          
-0000b210: 2020 5d0a 0a20 2020 2020 2020 2020 2020    ]..           
-0000b220: 2064 6174 6120 3d20 6177 6169 7420 7265   data = await re
-0000b230: 6365 6976 655f 6a73 6f6e 2877 6562 736f  ceive_json(webso
-0000b240: 636b 6574 2c20 6d73 675f 7479 7065 733d  cket, msg_types=
-0000b250: 6d73 675f 7479 7065 7329 0a20 2020 2020  msg_types).     
-0000b260: 2020 2020 2020 2065 7865 635f 636f 756e         exec_coun
-0000b270: 7420 3d20 6173 7365 7274 5f6a 736f 6e5f  t = assert_json_
-0000b280: 636f 6e74 656e 7428 6461 7461 290a 2020  content(data).  
-0000b290: 2020 2020 2020 2020 2020 6461 7461 203d            data =
-0000b2a0: 2061 7761 6974 2072 6563 6569 7665 5f6a   await receive_j
-0000b2b0: 736f 6e28 7765 6273 6f63 6b65 742c 206d  son(websocket, m
-0000b2c0: 7367 5f74 7970 6573 3d6d 7367 5f74 7970  sg_types=msg_typ
-0000b2d0: 6573 290a 2020 2020 2020 2020 2020 2020  es).            
-0000b2e0: 6173 7365 7274 5f6a 736f 6e5f 636f 6e74  assert_json_cont
-0000b2f0: 656e 7428 6461 7461 2c20 6578 6563 5f63  ent(data, exec_c
-0000b300: 6f75 6e74 290a 0a20 2020 2020 2020 2020  ount)..         
-0000b310: 2020 2023 2053 7469 6c6c 2062 7573 7920     # Still busy 
-0000b320: 7769 7468 206f 7574 7075 742c 2065 7272  with output, err
-0000b330: 6f72 206f 7574 7075 7420 7265 6365 6976  or output receiv
-0000b340: 6564 0a20 2020 2020 2020 2020 2020 2064  ed.            d
-0000b350: 6174 6120 3d20 6177 6169 7420 7265 6365  ata = await rece
-0000b360: 6976 655f 6a73 6f6e 2877 6562 736f 636b  ive_json(websock
-0000b370: 6574 2c20 6d73 675f 7479 7065 733d 5b22  et, msg_types=["
-0000b380: 6365 6c6c 5f75 7064 6174 6522 5d29 0a20  cell_update"]). 
-0000b390: 2020 2020 2020 2020 2020 2064 315f 6d65             d1_me
-0000b3a0: 7461 6461 7461 203d 2064 6174 615b 2263  tadata = data["c
-0000b3b0: 656c 6c5f 7570 6461 7465 225d 5b30 5d5b  ell_update"][0][
-0000b3c0: 226d 6574 6164 6174 6122 5d5b 226a 7570  "metadata"]["jup
-0000b3d0: 7974 6572 5f64 3122 5d0a 2020 2020 2020  yter_d1"].      
-0000b3e0: 2020 2020 2020 6173 7365 7274 2064 315f        assert d1_
-0000b3f0: 6d65 7461 6461 7461 5b22 6578 6563 7574  metadata["execut
-0000b400: 696f 6e5f 7374 6174 6522 5d20 3d3d 2022  ion_state"] == "
-0000b410: 6275 7379 220a 2020 2020 2020 2020 2020  busy".          
-0000b420: 2020 6173 7365 7274 2064 6174 615b 2263    assert data["c
-0000b430: 656c 6c5f 7570 6461 7465 225d 5b30 5d5b  ell_update"][0][
-0000b440: 2265 7865 6375 7469 6f6e 5f63 6f75 6e74  "execution_count
-0000b450: 225d 203d 3d20 310a 2020 2020 2020 2020  "] == 1.        
-0000b460: 2020 2020 6173 7365 7274 2064 315f 6d65      assert d1_me
-0000b470: 7461 6461 7461 5b22 706f 7369 7469 6f6e  tadata["position
-0000b480: 225d 203d 3d20 310a 2020 2020 2020 2020  "] == 1.        
-0000b490: 2020 2020 6173 7365 7274 2064 315f 6d65      assert d1_me
-0000b4a0: 7461 6461 7461 5b22 7575 6964 225d 203d  tadata["uuid"] =
-0000b4b0: 3d20 6365 6c6c 5f75 7569 640a 2020 2020  = cell_uuid.    
-0000b4c0: 2020 2020 2020 2020 6365 6c6c 203d 2064          cell = d
-0000b4d0: 6174 615b 2263 656c 6c5f 7570 6461 7465  ata["cell_update
-0000b4e0: 225d 5b30 5d0a 2020 2020 2020 2020 2020  "][0].          
-0000b4f0: 2020 6173 7365 7274 2063 656c 6c5b 2263    assert cell["c
-0000b500: 656c 6c5f 7479 7065 225d 203d 3d20 2263  ell_type"] == "c
-0000b510: 6f64 6522 0a20 2020 2020 2020 2020 2020  ode".           
-0000b520: 2061 7373 6572 7420 6c65 6e28 6365 6c6c   assert len(cell
-0000b530: 5b22 6f75 7470 7574 7322 5d29 203d 3d20  ["outputs"]) == 
-0000b540: 310a 2020 2020 2020 2020 2020 2020 6173  1.            as
-0000b550: 7365 7274 2063 656c 6c5b 226f 7574 7075  sert cell["outpu
-0000b560: 7473 225d 5b30 5d5b 2265 6e61 6d65 225d  ts"][0]["ename"]
-0000b570: 203d 3d20 2253 796e 7461 7845 7272 6f72   == "SyntaxError
-0000b580: 220a 2020 2020 2020 2020 2020 2020 6173  ".            as
-0000b590: 7365 7274 2022 5379 6e74 6178 4572 726f  sert "SyntaxErro
-0000b5a0: 7222 2069 6e20 6365 6c6c 5b22 6f75 7470  r" in cell["outp
-0000b5b0: 7574 7322 5d5b 305d 5b22 7472 6163 6562  uts"][0]["traceb
-0000b5c0: 6163 6b22 5d5b 305d 0a0a 2020 2020 2020  ack"][0]..      
-0000b5d0: 2020 2020 2020 2320 4b65 726e 656c 2076        # Kernel v
-0000b5e0: 6172 7320 7570 6461 7465 0a20 2020 2020  ars update.     
-0000b5f0: 2020 2020 2020 2064 6174 6120 3d20 6177         data = aw
-0000b600: 6169 7420 7265 6365 6976 655f 6a73 6f6e  ait receive_json
-0000b610: 2877 6562 736f 636b 6574 2c20 6d73 675f  (websocket, msg_
-0000b620: 7479 7065 733d 5b22 7661 7273 225d 290a  types=["vars"]).
-0000b630: 2020 2020 2020 2020 2020 2020 6173 7365              asse
-0000b640: 7274 2022 7661 7273 2220 696e 2064 6174  rt "vars" in dat
-0000b650: 610a 0a20 2020 2040 7079 7465 7374 2e6d  a..    @pytest.m
-0000b660: 6172 6b2e 6173 796e 6369 6f0a 2020 2020  ark.asyncio.    
-0000b670: 6173 796e 6320 6465 6620 7465 7374 5f73  async def test_s
-0000b680: 6372 6174 6368 5f65 7865 6375 7465 280a  cratch_execute(.
-0000b690: 2020 2020 2020 2020 7365 6c66 2c0a 2020          self,.  
-0000b6a0: 2020 2020 2020 636c 6965 6e74 3a20 5465        client: Te
-0000b6b0: 7374 436c 6965 6e74 2c0a 2020 2020 2020  stClient,.      
-0000b6c0: 2020 7265 6164 6f6e 6c79 5f74 6f6b 656e    readonly_token
-0000b6d0: 5f68 6561 6465 7273 3a20 4469 6374 5b73  _headers: Dict[s
-0000b6e0: 7472 2c20 7374 725d 2c0a 2020 2020 2020  tr, str],.      
-0000b6f0: 2020 7065 726d 6973 7369 6f6e 6c65 7373    permissionless
-0000b700: 5f74 6f6b 656e 5f68 6561 6465 7273 3a20  _token_headers: 
-0000b710: 4469 6374 5b73 7472 2c20 7374 725d 2c0a  Dict[str, str],.
-0000b720: 2020 2020 2020 2020 7375 7065 7275 7365          superuse
-0000b730: 725f 746f 6b65 6e5f 6865 6164 6572 733a  r_token_headers:
-0000b740: 2044 6963 745b 7374 722c 2073 7472 5d2c   Dict[str, str],
-0000b750: 0a20 2020 2029 3a0a 2020 2020 2020 2020  .    ):.        
-0000b760: 7575 6964 203d 2061 7761 6974 2075 706c  uuid = await upl
-0000b770: 6f61 645f 6e6f 7465 626f 6f6b 280a 2020  oad_notebook(.  
-0000b780: 2020 2020 2020 2020 2020 636c 6965 6e74            client
-0000b790: 2c20 7375 7065 7275 7365 725f 746f 6b65  , superuser_toke
-0000b7a0: 6e5f 6865 6164 6572 732c 2022 7369 6d70  n_headers, "simp
-0000b7b0: 6c65 2e69 7079 6e62 220a 2020 2020 2020  le.ipynb".      
-0000b7c0: 2020 290a 0a20 2020 2020 2020 2061 7379    )..        asy
-0000b7d0: 6e63 2077 6974 6820 636c 6965 6e74 2e77  nc with client.w
-0000b7e0: 6562 736f 636b 6574 5f63 6f6e 6e65 6374  ebsocket_connect
-0000b7f0: 280a 2020 2020 2020 2020 2020 2020 6622  (.            f"
-0000b800: 2f6e 6f74 6562 6f6f 6b73 2f7b 7575 6964  /notebooks/{uuid
-0000b810: 7d2f 7773 2f6e 6f74 6562 6f6f 6b22 2c20  }/ws/notebook", 
-0000b820: 6865 6164 6572 733d 7375 7065 7275 7365  headers=superuse
-0000b830: 725f 746f 6b65 6e5f 6865 6164 6572 730a  r_token_headers.
-0000b840: 2020 2020 2020 2020 2920 6173 2077 6562          ) as web
-0000b850: 736f 636b 6574 3a0a 2020 2020 2020 2020  socket:.        
-0000b860: 2020 2020 6177 6169 7420 6173 796e 6369      await asynci
-0000b870: 6f2e 736c 6565 7028 5745 4253 4f43 4b45  o.sleep(WEBSOCKE
-0000b880: 545f 534c 4545 505f 5449 4d45 290a 0a20  T_SLEEP_TIME).. 
-0000b890: 2020 2020 2020 2020 2020 2072 6573 706f             respo
-0000b8a0: 6e73 6520 3d20 6177 6169 7420 636c 6965  nse = await clie
-0000b8b0: 6e74 2e70 6f73 7428 0a20 2020 2020 2020  nt.post(.       
-0000b8c0: 2020 2020 2020 2020 2066 222f 6e6f 7465           f"/note
-0000b8d0: 626f 6f6b 732f 7b75 7569 647d 2f73 6372  books/{uuid}/scr
-0000b8e0: 6174 6368 5f65 7865 6375 7465 222c 0a20  atch_execute",. 
-0000b8f0: 2020 2020 2020 2020 2020 2020 2020 2068                 h
-0000b900: 6561 6465 7273 3d73 7570 6572 7573 6572  eaders=superuser
-0000b910: 5f74 6f6b 656e 5f68 6561 6465 7273 2c0a  _token_headers,.
-0000b920: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000b930: 6a73 6f6e 3d7b 2263 6f64 6522 3a20 2234  json={"code": "4
-0000b940: 2a35 227d 2c0a 2020 2020 2020 2020 2020  *5"},.          
-0000b950: 2020 290a 2020 2020 2020 2020 2020 2020    ).            
-0000b960: 6173 7365 7274 2072 6573 706f 6e73 652e  assert response.
-0000b970: 7374 6174 7573 5f63 6f64 6520 3d3d 2032  status_code == 2
-0000b980: 3030 0a20 2020 2020 2020 2020 2020 206d  00.            m
-0000b990: 6573 7361 6765 5f69 6420 3d20 7265 7370  essage_id = resp
-0000b9a0: 6f6e 7365 2e6a 736f 6e28 295b 226b 6572  onse.json()["ker
-0000b9b0: 6e65 6c5f 6d65 7373 6167 6522 5d5b 226d  nel_message"]["m
-0000b9c0: 6573 7361 6765 5f69 6422 5d0a 0a20 2020  essage_id"]..   
-0000b9d0: 2020 2020 2020 2020 2023 2066 6972 7374           # first
-0000b9e0: 2063 6875 6e6b 2072 6563 6569 7665 6420   chunk received 
-0000b9f0: 7368 6f75 6c64 2062 6520 6120 7363 7261  should be a scra
-0000ba00: 7463 685f 7570 6461 7465 2077 6974 680a  tch_update with.
-0000ba10: 2020 2020 2020 2020 2020 2020 2320 616e              # an
-0000ba20: 2065 7865 6375 7469 6f6e 5f73 7461 7465   execution_state
-0000ba30: 206f 6620 2762 7573 7927 2077 6865 6e20   of 'busy' when 
-0000ba40: 7072 6f63 6573 7369 6e67 2073 7461 7274  processing start
-0000ba50: 730a 2020 2020 2020 2020 2020 2020 6461  s.            da
-0000ba60: 7461 203d 2061 7761 6974 2072 6563 6569  ta = await recei
-0000ba70: 7665 5f6a 736f 6e28 7765 6273 6f63 6b65  ve_json(websocke
-0000ba80: 742c 206d 7367 5f74 7970 6573 3d5b 2273  t, msg_types=["s
-0000ba90: 6372 6174 6368 5f75 7064 6174 6522 5d29  cratch_update"])
-0000baa0: 0a20 2020 2020 2020 2020 2020 2073 6372  .            scr
-0000bab0: 6174 6368 5f75 7064 6174 6520 3d20 6461  atch_update = da
-0000bac0: 7461 5b22 7363 7261 7463 685f 7570 6461  ta["scratch_upda
-0000bad0: 7465 225d 0a20 2020 2020 2020 2020 2020  te"].           
-0000bae0: 2061 7373 6572 7420 7363 7261 7463 685f   assert scratch_
-0000baf0: 7570 6461 7465 5b22 6d65 7373 6167 655f  update["message_
-0000bb00: 6964 225d 203d 3d20 6d65 7373 6167 655f  id"] == message_
-0000bb10: 6964 0a20 2020 2020 2020 2020 2020 2061  id.            a
-0000bb20: 7373 6572 7420 7363 7261 7463 685f 7570  ssert scratch_up
-0000bb30: 6461 7465 5b22 6578 6563 7574 696f 6e5f  date["execution_
-0000bb40: 7374 6174 6522 5d20 3d3d 2022 6275 7379  state"] == "busy
-0000bb50: 220a 0a20 2020 2020 2020 2020 2020 2023  "..            #
-0000bb60: 2052 6563 6569 7665 2073 6372 6174 6368   Receive scratch
-0000bb70: 2065 7865 6375 7469 6f6e 206f 7574 7075   execution outpu
-0000bb80: 740a 2020 2020 2020 2020 2020 2020 6461  t.            da
-0000bb90: 7461 203d 2061 7761 6974 2072 6563 6569  ta = await recei
-0000bba0: 7665 5f6a 736f 6e28 7765 6273 6f63 6b65  ve_json(websocke
-0000bbb0: 742c 206d 7367 5f74 7970 6573 3d5b 2273  t, msg_types=["s
-0000bbc0: 6372 6174 6368 5f75 7064 6174 6522 5d29  cratch_update"])
-0000bbd0: 0a20 2020 2020 2020 2020 2020 2073 6372  .            scr
-0000bbe0: 6174 6368 5f75 7064 6174 6520 3d20 6461  atch_update = da
-0000bbf0: 7461 5b22 7363 7261 7463 685f 7570 6461  ta["scratch_upda
-0000bc00: 7465 225d 0a20 2020 2020 2020 2020 2020  te"].           
-0000bc10: 2065 7870 6563 7465 645f 6f75 7470 7574   expected_output
-0000bc20: 203d 207b 0a20 2020 2020 2020 2020 2020   = {.           
-0000bc30: 2020 2020 2022 6461 7461 223a 207b 2274       "data": {"t
-0000bc40: 6578 742f 706c 6169 6e22 3a20 2232 3022  ext/plain": "20"
-0000bc50: 7d2c 0a20 2020 2020 2020 2020 2020 2020  },.             
-0000bc60: 2020 2022 6578 6563 7574 696f 6e5f 636f     "execution_co
-0000bc70: 756e 7422 3a20 312c 0a20 2020 2020 2020  unt": 1,.       
-0000bc80: 2020 2020 2020 2020 2022 6d65 7461 6461           "metada
-0000bc90: 7461 223a 207b 7d2c 0a20 2020 2020 2020  ta": {},.       
-0000bca0: 2020 2020 2020 2020 2022 6f75 7470 7574           "output
-0000bcb0: 5f74 7970 6522 3a20 2265 7865 6375 7465  _type": "execute
-0000bcc0: 5f72 6573 756c 7422 2c0a 2020 2020 2020  _result",.      
-0000bcd0: 2020 2020 2020 7d0a 2020 2020 2020 2020        }.        
-0000bce0: 2020 2020 6173 7365 7274 2073 6372 6174      assert scrat
-0000bcf0: 6368 5f75 7064 6174 655b 226f 7574 7075  ch_update["outpu
-0000bd00: 7422 5d20 3d3d 2065 7870 6563 7465 645f  t"] == expected_
-0000bd10: 6f75 7470 7574 0a0a 2020 2020 2020 2020  output..        
-0000bd20: 2020 2020 2320 5363 7261 7463 6820 6578      # Scratch ex
-0000bd30: 6563 7574 696f 6e20 7374 6174 6520 7365  ecution state se
-0000bd40: 7420 746f 2069 646c 650a 2020 2020 2020  t to idle.      
-0000bd50: 2020 2020 2020 6461 7461 203d 2061 7761        data = awa
-0000bd60: 6974 2072 6563 6569 7665 5f6a 736f 6e28  it receive_json(
-0000bd70: 7765 6273 6f63 6b65 742c 206d 7367 5f74  websocket, msg_t
-0000bd80: 7970 6573 3d5b 2273 6372 6174 6368 5f75  ypes=["scratch_u
-0000bd90: 7064 6174 6522 5d29 0a20 2020 2020 2020  pdate"]).       
-0000bda0: 2020 2020 2073 6372 6174 6368 5f75 7064       scratch_upd
-0000bdb0: 6174 6520 3d20 6461 7461 5b22 7363 7261  ate = data["scra
-0000bdc0: 7463 685f 7570 6461 7465 225d 0a20 2020  tch_update"].   
-0000bdd0: 2020 2020 2020 2020 2061 7373 6572 7420           assert 
-0000bde0: 7363 7261 7463 685f 7570 6461 7465 5b22  scratch_update["
-0000bdf0: 6d65 7373 6167 655f 6964 225d 203d 3d20  message_id"] == 
-0000be00: 6d65 7373 6167 655f 6964 0a20 2020 2020  message_id.     
-0000be10: 2020 2020 2020 2061 7373 6572 7420 7363         assert sc
-0000be20: 7261 7463 685f 7570 6461 7465 5b22 6578  ratch_update["ex
-0000be30: 6563 7574 696f 6e5f 7374 6174 6522 5d20  ecution_state"] 
-0000be40: 3d3d 2022 6964 6c65 220a 0a20 2020 2040  == "idle"..    @
-0000be50: 7079 7465 7374 2e6d 6172 6b2e 6173 796e  pytest.mark.asyn
-0000be60: 6369 6f0a 2020 2020 6173 796e 6320 6465  cio.    async de
-0000be70: 6620 7465 7374 5f73 6372 6174 6368 5f63  f test_scratch_c
-0000be80: 6f64 655f 6964 6c65 5f73 7461 7475 7328  ode_idle_status(
-0000be90: 0a20 2020 2020 2020 2073 656c 662c 2063  .        self, c
-0000bea0: 6c69 656e 743a 2054 6573 7443 6c69 656e  lient: TestClien
-0000beb0: 742c 2073 7570 6572 7573 6572 5f74 6f6b  t, superuser_tok
-0000bec0: 656e 5f68 6561 6465 7273 3a20 4469 6374  en_headers: Dict
-0000bed0: 5b73 7472 2c20 7374 725d 0a20 2020 2029  [str, str].    )
-0000bee0: 3a0a 2020 2020 2020 2020 6173 796e 6320  :.        async 
-0000bef0: 6465 6620 6973 5f69 646c 655f 7374 6174  def is_idle_stat
-0000bf00: 7573 2829 3a0a 2020 2020 2020 2020 2020  us():.          
-0000bf10: 2020 7265 7370 6f6e 7365 203d 2061 7761    response = awa
-0000bf20: 6974 2063 6c69 656e 742e 6765 7428 0a20  it client.get(. 
-0000bf30: 2020 2020 2020 2020 2020 2020 2020 2066                 f
-0000bf40: 222f 6b65 726e 656c 732f 6964 6c65 222c  "/kernels/idle",
-0000bf50: 2068 6561 6465 7273 3d73 7570 6572 7573   headers=superus
-0000bf60: 6572 5f74 6f6b 656e 5f68 6561 6465 7273  er_token_headers
-0000bf70: 0a20 2020 2020 2020 2020 2020 2029 0a20  .            ). 
-0000bf80: 2020 2020 2020 2020 2020 2061 7373 6572             asser
-0000bf90: 7420 7265 7370 6f6e 7365 2e73 7461 7475  t response.statu
-0000bfa0: 735f 636f 6465 203d 3d20 3230 300a 2020  s_code == 200.  
-0000bfb0: 2020 2020 2020 2020 2020 6a73 6f6e 203d            json =
-0000bfc0: 2072 6573 706f 6e73 652e 6a73 6f6e 2829   response.json()
-0000bfd0: 0a20 2020 2020 2020 2020 2020 2072 6574  .            ret
-0000bfe0: 7572 6e20 280a 2020 2020 2020 2020 2020  urn (.          
-0000bff0: 2020 2020 2020 6a73 6f6e 5b22 6964 6c65        json["idle
-0000c000: 225d 2c0a 2020 2020 2020 2020 2020 2020  "],.            
-0000c010: 2020 2020 6461 7465 7469 6d65 2e73 7472      datetime.str
-0000c020: 7074 696d 6528 6a73 6f6e 5b22 6c61 7374  ptime(json["last
-0000c030: 5f69 646c 6522 5d2c 2022 2559 2d25 6d2d  _idle"], "%Y-%m-
-0000c040: 2564 5425 483a 254d 3a25 532e 2566 2229  %dT%H:%M:%S.%f")
-0000c050: 2c0a 2020 2020 2020 2020 2020 2020 290a  ,.            ).
-0000c060: 0a20 2020 2020 2020 2023 204b 6572 6e65  .        # Kerne
-0000c070: 6c20 6973 2069 646c 650a 2020 2020 2020  l is idle.      
-0000c080: 2020 6973 5f69 646c 652c 206c 6173 745f    is_idle, last_
-0000c090: 6964 6c65 5f31 203d 2061 7761 6974 2069  idle_1 = await i
-0000c0a0: 735f 6964 6c65 5f73 7461 7475 7328 290a  s_idle_status().
-0000c0b0: 2020 2020 2020 2020 6173 7365 7274 2069          assert i
-0000c0c0: 735f 6964 6c65 2069 7320 5472 7565 0a0a  s_idle is True..
-0000c0d0: 2020 2020 2020 2020 7575 6964 203d 2061          uuid = a
-0000c0e0: 7761 6974 2075 706c 6f61 645f 6e6f 7465  wait upload_note
-0000c0f0: 626f 6f6b 280a 2020 2020 2020 2020 2020  book(.          
-0000c100: 2020 636c 6965 6e74 2c20 7375 7065 7275    client, superu
-0000c110: 7365 725f 746f 6b65 6e5f 6865 6164 6572  ser_token_header
-0000c120: 732c 2022 7369 6d70 6c65 2e69 7079 6e62  s, "simple.ipynb
-0000c130: 220a 2020 2020 2020 2020 290a 0a20 2020  ".        )..   
-0000c140: 2020 2020 2023 204b 6572 6e65 6c20 6973       # Kernel is
-0000c150: 2073 7469 6c6c 2069 646c 650a 2020 2020   still idle.    
-0000c160: 2020 2020 6973 5f69 646c 652c 206c 6173      is_idle, las
-0000c170: 745f 6964 6c65 5f32 203d 2061 7761 6974  t_idle_2 = await
-0000c180: 2069 735f 6964 6c65 5f73 7461 7475 7328   is_idle_status(
-0000c190: 290a 2020 2020 2020 2020 6173 7365 7274  ).        assert
-0000c1a0: 2069 735f 6964 6c65 2069 7320 5472 7565   is_idle is True
-0000c1b0: 0a20 2020 2020 2020 2061 7373 6572 7420  .        assert 
-0000c1c0: 6c61 7374 5f69 646c 655f 3120 3d3d 206c  last_idle_1 == l
-0000c1d0: 6173 745f 6964 6c65 5f32 0a0a 2020 2020  ast_idle_2..    
-0000c1e0: 2020 2020 6173 796e 6320 7769 7468 2063      async with c
-0000c1f0: 6c69 656e 742e 7765 6273 6f63 6b65 745f  lient.websocket_
-0000c200: 636f 6e6e 6563 7428 0a20 2020 2020 2020  connect(.       
-0000c210: 2020 2020 2066 222f 6e6f 7465 626f 6f6b       f"/notebook
-0000c220: 732f 7b75 7569 647d 2f77 732f 6e6f 7465  s/{uuid}/ws/note
-0000c230: 626f 6f6b 222c 2068 6561 6465 7273 3d73  book", headers=s
-0000c240: 7570 6572 7573 6572 5f74 6f6b 656e 5f68  uperuser_token_h
-0000c250: 6561 6465 7273 0a20 2020 2020 2020 2029  eaders.        )
-0000c260: 2061 7320 7765 6273 6f63 6b65 743a 0a20   as websocket:. 
-0000c270: 2020 2020 2020 2020 2020 2061 7761 6974             await
-0000c280: 2061 7379 6e63 696f 2e73 6c65 6570 2857   asyncio.sleep(W
-0000c290: 4542 534f 434b 4554 5f53 4c45 4550 5f54  EBSOCKET_SLEEP_T
-0000c2a0: 494d 4529 0a0a 2020 2020 2020 2020 2020  IME)..          
-0000c2b0: 2020 7265 7370 6f6e 7365 203d 2061 7761    response = awa
-0000c2c0: 6974 2063 6c69 656e 742e 706f 7374 280a  it client.post(.
-0000c2d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000c2e0: 6622 2f6e 6f74 6562 6f6f 6b73 2f7b 7575  f"/notebooks/{uu
-0000c2f0: 6964 7d2f 7363 7261 7463 685f 6578 6563  id}/scratch_exec
-0000c300: 7574 6522 2c0a 2020 2020 2020 2020 2020  ute",.          
-0000c310: 2020 2020 2020 6865 6164 6572 733d 7375        headers=su
-0000c320: 7065 7275 7365 725f 746f 6b65 6e5f 6865  peruser_token_he
-0000c330: 6164 6572 732c 0a20 2020 2020 2020 2020  aders,.         
-0000c340: 2020 2020 2020 206a 736f 6e3d 7b22 636f         json={"co
-0000c350: 6465 223a 2022 342b 3922 7d2c 0a20 2020  de": "4+9"},.   
-0000c360: 2020 2020 2020 2020 2029 0a20 2020 2020           ).     
-0000c370: 2020 2020 2020 2061 7373 6572 7420 7265         assert re
-0000c380: 7370 6f6e 7365 2e73 7461 7475 735f 636f  sponse.status_co
-0000c390: 6465 203d 3d20 3230 300a 2020 2020 2020  de == 200.      
-0000c3a0: 2020 2020 2020 6d65 7373 6167 655f 6964        message_id
-0000c3b0: 203d 2072 6573 706f 6e73 652e 6a73 6f6e   = response.json
-0000c3c0: 2829 5b22 6b65 726e 656c 5f6d 6573 7361  ()["kernel_messa
-0000c3d0: 6765 225d 5b22 6d65 7373 6167 655f 6964  ge"]["message_id
-0000c3e0: 225d 0a0a 2020 2020 2020 2020 2020 2020  "]..            
-0000c3f0: 2320 4578 6563 7574 696f 6e20 7374 6174  # Execution stat
-0000c400: 6520 6275 7379 0a20 2020 2020 2020 2020  e busy.         
-0000c410: 2020 2061 7761 6974 2072 6563 6569 7665     await receive
-0000c420: 5f6a 736f 6e28 7765 6273 6f63 6b65 742c  _json(websocket,
-0000c430: 206d 7367 5f74 7970 6573 3d5b 2273 6372   msg_types=["scr
-0000c440: 6174 6368 5f75 7064 6174 6522 5d29 0a20  atch_update"]). 
-0000c450: 2020 2020 2020 2020 2020 2023 2045 7865             # Exe
-0000c460: 6375 7469 6f6e 206f 7574 7075 740a 2020  cution output.  
-0000c470: 2020 2020 2020 2020 2020 6177 6169 7420            await 
-0000c480: 7265 6365 6976 655f 6a73 6f6e 2877 6562  receive_json(web
-0000c490: 736f 636b 6574 2c20 6d73 675f 7479 7065  socket, msg_type
-0000c4a0: 733d 5b22 7363 7261 7463 685f 7570 6461  s=["scratch_upda
-0000c4b0: 7465 225d 290a 2020 2020 2020 2020 2020  te"]).          
-0000c4c0: 2020 2320 4578 6563 7574 696f 6e20 7374    # Execution st
-0000c4d0: 6174 6520 6964 6c65 0a20 2020 2020 2020  ate idle.       
-0000c4e0: 2020 2020 2061 7761 6974 2072 6563 6569       await recei
-0000c4f0: 7665 5f6a 736f 6e28 7765 6273 6f63 6b65  ve_json(websocke
-0000c500: 742c 206d 7367 5f74 7970 6573 3d5b 2273  t, msg_types=["s
-0000c510: 6372 6174 6368 5f75 7064 6174 6522 5d29  cratch_update"])
-0000c520: 0a0a 2020 2020 2020 2020 2020 2020 2320  ..            # 
-0000c530: 4b65 726e 656c 2069 7320 7374 696c 6c20  Kernel is still 
-0000c540: 6964 6c65 2028 6e6f 2063 6f64 6520 7275  idle (no code ru
-0000c550: 6e6e 696e 6729 0a20 2020 2020 2020 2020  nning).         
-0000c560: 2020 2069 735f 6964 6c65 2c20 6c61 7374     is_idle, last
-0000c570: 5f69 646c 655f 3320 3d20 6177 6169 7420  _idle_3 = await 
-0000c580: 6973 5f69 646c 655f 7374 6174 7573 2829  is_idle_status()
-0000c590: 0a20 2020 2020 2020 2020 2020 2061 7373  .            ass
-0000c5a0: 6572 7420 6973 5f69 646c 6520 6973 2054  ert is_idle is T
-0000c5b0: 7275 650a 2020 2020 2020 2020 2020 2020  rue.            
-0000c5c0: 6173 7365 7274 206c 6173 745f 6964 6c65  assert last_idle
-0000c5d0: 5f33 203e 206c 6173 745f 6964 6c65 5f32  _3 > last_idle_2
-0000c5e0: 0a0a 2020 2020 2020 2020 2020 2020 2320  ..            # 
-0000c5f0: 4b65 726e 656c 2076 6172 7320 7570 6461  Kernel vars upda
-0000c600: 7465 0a20 2020 2020 2020 2020 2020 2064  te.            d
-0000c610: 6174 6120 3d20 6177 6169 7420 7265 6365  ata = await rece
-0000c620: 6976 655f 6a73 6f6e 2877 6562 736f 636b  ive_json(websock
-0000c630: 6574 2c20 6d73 675f 7479 7065 733d 5b22  et, msg_types=["
-0000c640: 7661 7273 225d 290a 2020 2020 2020 2020  vars"]).        
-0000c650: 2020 2020 6173 7365 7274 2022 7661 7273      assert "vars
-0000c660: 2220 696e 2064 6174 610a 0a20 2020 2020  " in data..     
-0000c670: 2020 2020 2020 2072 6573 706f 6e73 6520         response 
-0000c680: 3d20 6177 6169 7420 636c 6965 6e74 2e70  = await client.p
-0000c690: 6f73 7428 0a20 2020 2020 2020 2020 2020  ost(.           
-0000c6a0: 2020 2020 2066 222f 6e6f 7465 626f 6f6b       f"/notebook
-0000c6b0: 732f 7b75 7569 647d 2f73 6372 6174 6368  s/{uuid}/scratch
-0000c6c0: 5f65 7865 6375 7465 222c 0a20 2020 2020  _execute",.     
-0000c6d0: 2020 2020 2020 2020 2020 2068 6561 6465             heade
-0000c6e0: 7273 3d73 7570 6572 7573 6572 5f74 6f6b  rs=superuser_tok
-0000c6f0: 656e 5f68 6561 6465 7273 2c0a 2020 2020  en_headers,.    
-0000c700: 2020 2020 2020 2020 2020 2020 6a73 6f6e              json
-0000c710: 3d7b 0a20 2020 2020 2020 2020 2020 2020  ={.             
-0000c720: 2020 2020 2020 2022 636f 6465 223a 2022         "code": "
-0000c730: 6672 6f6d 2074 696d 6520 696d 706f 7274  from time import
-0000c740: 2073 6c65 6570 5c6e 220a 2020 2020 2020   sleep\n".      
-0000c750: 2020 2020 2020 2020 2020 2020 2020 2277                "w
-0000c760: 6869 6c65 2054 7275 653a 5c6e 2020 2020  hile True:\n    
-0000c770: 736c 6565 7028 3129 220a 2020 2020 2020  sleep(1)".      
-0000c780: 2020 2020 2020 2020 2020 7d2c 0a20 2020            },.   
-0000c790: 2020 2020 2020 2020 2029 0a20 2020 2020           ).     
-0000c7a0: 2020 2020 2020 2061 7373 6572 7420 7265         assert re
-0000c7b0: 7370 6f6e 7365 2e73 7461 7475 735f 636f  sponse.status_co
-0000c7c0: 6465 203d 3d20 3230 300a 2020 2020 2020  de == 200.      
-0000c7d0: 2020 2020 2020 6d65 7373 6167 655f 6964        message_id
-0000c7e0: 203d 2072 6573 706f 6e73 652e 6a73 6f6e   = response.json
-0000c7f0: 2829 5b22 6b65 726e 656c 5f6d 6573 7361  ()["kernel_messa
-0000c800: 6765 225d 5b22 6d65 7373 6167 655f 6964  ge"]["message_id
-0000c810: 225d 0a0a 2020 2020 2020 2020 2020 2020  "]..            
-0000c820: 2320 6669 7273 7420 6368 756e 6b20 7265  # first chunk re
-0000c830: 6365 6976 6564 2073 686f 756c 6420 6265  ceived should be
-0000c840: 2061 2063 656c 6c5f 7570 6461 7465 2077   a cell_update w
-0000c850: 6974 680a 2020 2020 2020 2020 2020 2020  ith.            
-0000c860: 2320 616e 2065 7865 6375 7469 6f6e 5f73  # an execution_s
-0000c870: 7461 7465 206f 6620 2762 7573 7927 2077  tate of 'busy' w
-0000c880: 6865 6e20 7072 6f63 6573 7369 6e67 2073  hen processing s
-0000c890: 7461 7274 730a 2020 2020 2020 2020 2020  tarts.          
-0000c8a0: 2020 6461 7461 203d 2061 7761 6974 2077    data = await w
-0000c8b0: 6169 745f 666f 725f 6576 656e 7428 7765  ait_for_event(we
-0000c8c0: 6273 6f63 6b65 742c 2022 7363 7261 7463  bsocket, "scratc
-0000c8d0: 685f 7570 6461 7465 2229 0a20 2020 2020  h_update").     
-0000c8e0: 2020 2020 2020 2073 6372 6174 6368 5f75         scratch_u
-0000c8f0: 7064 6174 6520 3d20 6461 7461 5b22 7363  pdate = data["sc
-0000c900: 7261 7463 685f 7570 6461 7465 225d 0a20  ratch_update"]. 
-0000c910: 2020 2020 2020 2020 2020 2061 7373 6572             asser
-0000c920: 7420 7363 7261 7463 685f 7570 6461 7465  t scratch_update
-0000c930: 5b22 6d65 7373 6167 655f 6964 225d 203d  ["message_id"] =
-0000c940: 3d20 6d65 7373 6167 655f 6964 0a20 2020  = message_id.   
-0000c950: 2020 2020 2020 2020 2061 7373 6572 7420           assert 
-0000c960: 7363 7261 7463 685f 7570 6461 7465 5b22  scratch_update["
-0000c970: 6578 6563 7574 696f 6e5f 7374 6174 6522  execution_state"
-0000c980: 5d20 3d3d 2022 6275 7379 220a 0a20 2020  ] == "busy"..   
-0000c990: 2020 2020 2020 2020 2023 204b 6572 6e65           # Kerne
-0000c9a0: 6c20 7368 6f75 6c64 206e 6f74 2062 6520  l should not be 
-0000c9b0: 6964 6c65 206e 6f77 0a20 2020 2020 2020  idle now.       
-0000c9c0: 2020 2020 2069 735f 6964 6c65 2c20 6c61       is_idle, la
-0000c9d0: 7374 5f69 646c 655f 3420 3d20 6177 6169  st_idle_4 = awai
-0000c9e0: 7420 6973 5f69 646c 655f 7374 6174 7573  t is_idle_status
-0000c9f0: 2829 0a20 2020 2020 2020 2020 2020 2061  ().            a
-0000ca00: 7373 6572 7420 6973 5f69 646c 6520 6973  ssert is_idle is
-0000ca10: 2046 616c 7365 0a20 2020 2020 2020 2020   False.         
-0000ca20: 2020 2061 7373 6572 7420 6c61 7374 5f69     assert last_i
-0000ca30: 646c 655f 3420 3e20 6c61 7374 5f69 646c  dle_4 > last_idl
-0000ca40: 655f 330a 0a20 2020 2040 7079 7465 7374  e_3..    @pytest
-0000ca50: 2e6d 6172 6b2e 6173 796e 6369 6f0a 2020  .mark.asyncio.  
-0000ca60: 2020 6173 796e 6320 6465 6620 7465 7374    async def test
-0000ca70: 5f73 6372 6174 6368 5f73 7472 6561 6d28  _scratch_stream(
-0000ca80: 0a20 2020 2020 2020 2073 656c 662c 0a20  .        self,. 
-0000ca90: 2020 2020 2020 2063 6c69 656e 743a 2054         client: T
-0000caa0: 6573 7443 6c69 656e 742c 0a20 2020 2020  estClient,.     
-0000cab0: 2020 2072 6561 646f 6e6c 795f 746f 6b65     readonly_toke
-0000cac0: 6e5f 6865 6164 6572 733a 2044 6963 745b  n_headers: Dict[
-0000cad0: 7374 722c 2073 7472 5d2c 0a20 2020 2020  str, str],.     
-0000cae0: 2020 2070 6572 6d69 7373 696f 6e6c 6573     permissionles
-0000caf0: 735f 746f 6b65 6e5f 6865 6164 6572 733a  s_token_headers:
-0000cb00: 2044 6963 745b 7374 722c 2073 7472 5d2c   Dict[str, str],
-0000cb10: 0a20 2020 2020 2020 2073 7570 6572 7573  .        superus
-0000cb20: 6572 5f74 6f6b 656e 5f68 6561 6465 7273  er_token_headers
-0000cb30: 3a20 4469 6374 5b73 7472 2c20 7374 725d  : Dict[str, str]
-0000cb40: 2c0a 2020 2020 293a 0a20 2020 2020 2020  ,.    ):.       
-0000cb50: 2075 7569 6420 3d20 6177 6169 7420 7570   uuid = await up
-0000cb60: 6c6f 6164 5f6e 6f74 6562 6f6f 6b28 0a20  load_notebook(. 
-0000cb70: 2020 2020 2020 2020 2020 2063 6c69 656e             clien
-0000cb80: 742c 2073 7570 6572 7573 6572 5f74 6f6b  t, superuser_tok
-0000cb90: 656e 5f68 6561 6465 7273 2c20 2273 696d  en_headers, "sim
-0000cba0: 706c 652e 6970 796e 6222 0a20 2020 2020  ple.ipynb".     
-0000cbb0: 2020 2029 0a0a 2020 2020 2020 2020 6173     )..        as
-0000cbc0: 796e 6320 7769 7468 2063 6c69 656e 742e  ync with client.
-0000cbd0: 7765 6273 6f63 6b65 745f 636f 6e6e 6563  websocket_connec
-0000cbe0: 7428 0a20 2020 2020 2020 2020 2020 2066  t(.            f
-0000cbf0: 222f 6e6f 7465 626f 6f6b 732f 7b75 7569  "/notebooks/{uui
-0000cc00: 647d 2f77 732f 6e6f 7465 626f 6f6b 222c  d}/ws/notebook",
-0000cc10: 2068 6561 6465 7273 3d73 7570 6572 7573   headers=superus
-0000cc20: 6572 5f74 6f6b 656e 5f68 6561 6465 7273  er_token_headers
-0000cc30: 0a20 2020 2020 2020 2029 2061 7320 7765  .        ) as we
-0000cc40: 6273 6f63 6b65 743a 0a20 2020 2020 2020  bsocket:.       
-0000cc50: 2020 2020 2061 7761 6974 2061 7379 6e63       await async
-0000cc60: 696f 2e73 6c65 6570 2857 4542 534f 434b  io.sleep(WEBSOCK
-0000cc70: 4554 5f53 4c45 4550 5f54 494d 4529 0a0a  ET_SLEEP_TIME)..
-0000cc80: 2020 2020 2020 2020 2020 2020 7265 7370              resp
-0000cc90: 6f6e 7365 203d 2061 7761 6974 2063 6c69  onse = await cli
-0000cca0: 656e 742e 706f 7374 280a 2020 2020 2020  ent.post(.      
-0000ccb0: 2020 2020 2020 2020 2020 6622 2f6e 6f74            f"/not
-0000ccc0: 6562 6f6f 6b73 2f7b 7575 6964 7d2f 7363  ebooks/{uuid}/sc
-0000ccd0: 7261 7463 685f 6578 6563 7574 6522 2c0a  ratch_execute",.
-0000cce0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000ccf0: 6865 6164 6572 733d 7375 7065 7275 7365  headers=superuse
-0000cd00: 725f 746f 6b65 6e5f 6865 6164 6572 732c  r_token_headers,
-0000cd10: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-0000cd20: 206a 736f 6e3d 7b0a 2020 2020 2020 2020   json={.        
-0000cd30: 2020 2020 2020 2020 2020 2020 2263 6f64              "cod
-0000cd40: 6522 3a20 2269 6d70 6f72 7420 7469 6d65  e": "import time
-0000cd50: 5c6e 666f 7220 6920 696e 2028 2768 6572  \nfor i in ('her
-0000cd60: 6573 272c 2027 6127 2c20 220a 2020 2020  es', 'a', ".    
-0000cd70: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000cd80: 2227 7374 7265 616d 6f66 6461 7461 2729  "'streamofdata')
-0000cd90: 3a5c 6e20 2020 2070 7269 6e74 2869 295c  :\n    print(i)\
-0000cda0: 6e20 2020 2022 0a20 2020 2020 2020 2020  n    ".         
-0000cdb0: 2020 2020 2020 2020 2020 2022 7469 6d65             "time
-0000cdc0: 2e73 6c65 6570 2830 2e33 2922 0a20 2020  .sleep(0.3)".   
-0000cdd0: 2020 2020 2020 2020 2020 2020 207d 2c0a               },.
-0000cde0: 2020 2020 2020 2020 2020 2020 290a 2020              ).  
-0000cdf0: 2020 2020 2020 2020 2020 6173 7365 7274            assert
-0000ce00: 2072 6573 706f 6e73 652e 7374 6174 7573   response.status
-0000ce10: 5f63 6f64 6520 3d3d 2032 3030 0a20 2020  _code == 200.   
-0000ce20: 2020 2020 2020 2020 206d 6573 7361 6765           message
-0000ce30: 5f69 6420 3d20 7265 7370 6f6e 7365 2e6a  _id = response.j
-0000ce40: 736f 6e28 295b 226b 6572 6e65 6c5f 6d65  son()["kernel_me
-0000ce50: 7373 6167 6522 5d5b 226d 6573 7361 6765  ssage"]["message
-0000ce60: 5f69 6422 5d0a 0a20 2020 2020 2020 2020  _id"]..         
-0000ce70: 2020 2023 2066 6972 7374 2063 6875 6e6b     # first chunk
-0000ce80: 2072 6563 6569 7665 6420 7368 6f75 6c64   received should
-0000ce90: 2062 6520 6120 7363 7261 7463 685f 7570   be a scratch_up
-0000cea0: 6461 7465 2077 6974 680a 2020 2020 2020  date with.      
-0000ceb0: 2020 2020 2020 2320 616e 2065 7865 6375        # an execu
-0000cec0: 7469 6f6e 5f73 7461 7465 206f 6620 2762  tion_state of 'b
-0000ced0: 7573 7927 2077 6865 6e20 7072 6f63 6573  usy' when proces
-0000cee0: 7369 6e67 2073 7461 7274 730a 2020 2020  sing starts.    
-0000cef0: 2020 2020 2020 2020 6461 7461 203d 2061          data = a
-0000cf00: 7761 6974 2072 6563 6569 7665 5f6a 736f  wait receive_jso
-0000cf10: 6e28 7765 6273 6f63 6b65 742c 206d 7367  n(websocket, msg
-0000cf20: 5f74 7970 6573 3d5b 2273 6372 6174 6368  _types=["scratch
-0000cf30: 5f75 7064 6174 6522 5d29 0a20 2020 2020  _update"]).     
-0000cf40: 2020 2020 2020 2073 6372 6174 6368 5f75         scratch_u
-0000cf50: 7064 6174 6520 3d20 6461 7461 5b22 7363  pdate = data["sc
-0000cf60: 7261 7463 685f 7570 6461 7465 225d 0a20  ratch_update"]. 
-0000cf70: 2020 2020 2020 2020 2020 2061 7373 6572             asser
-0000cf80: 7420 7363 7261 7463 685f 7570 6461 7465  t scratch_update
-0000cf90: 5b22 6d65 7373 6167 655f 6964 225d 203d  ["message_id"] =
-0000cfa0: 3d20 6d65 7373 6167 655f 6964 0a20 2020  = message_id.   
-0000cfb0: 2020 2020 2020 2020 2061 7373 6572 7420           assert 
-0000cfc0: 7363 7261 7463 685f 7570 6461 7465 5b22  scratch_update["
-0000cfd0: 6578 6563 7574 696f 6e5f 7374 6174 6522  execution_state"
-0000cfe0: 5d20 3d3d 2022 6275 7379 220a 0a20 2020  ] == "busy"..   
-0000cff0: 2020 2020 2020 2020 2023 2052 6563 6569           # Recei
-0000d000: 7665 2073 6372 6174 6368 2065 7865 6375  ve scratch execu
-0000d010: 7469 6f6e 206f 7574 7075 740a 2020 2020  tion output.    
-0000d020: 2020 2020 2020 2020 6173 796e 6320 6465          async de
-0000d030: 6620 7265 6365 6976 655f 7465 7874 2874  f receive_text(t
-0000d040: 6578 7429 3a0a 2020 2020 2020 2020 2020  ext):.          
-0000d050: 2020 2020 2020 6461 7461 203d 2061 7761        data = awa
-0000d060: 6974 2072 6563 6569 7665 5f6a 736f 6e28  it receive_json(
-0000d070: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-0000d080: 2020 2020 2077 6562 736f 636b 6574 2c20       websocket, 
-0000d090: 6d73 675f 7479 7065 733d 5b22 7363 7261  msg_types=["scra
-0000d0a0: 7463 685f 7570 6461 7465 225d 0a20 2020  tch_update"].   
-0000d0b0: 2020 2020 2020 2020 2020 2020 2029 0a20               ). 
-0000d0c0: 2020 2020 2020 2020 2020 2020 2020 2073                 s
-0000d0d0: 6372 6174 6368 5f75 7064 6174 6520 3d20  cratch_update = 
-0000d0e0: 6461 7461 5b22 7363 7261 7463 685f 7570  data["scratch_up
-0000d0f0: 6461 7465 225d 0a20 2020 2020 2020 2020  date"].         
-0000d100: 2020 2020 2020 2065 7870 6563 7465 645f         expected_
-0000d110: 6f75 7470 7574 203d 207b 0a20 2020 2020  output = {.     
-0000d120: 2020 2020 2020 2020 2020 2020 2020 2022                 "
-0000d130: 6e61 6d65 223a 2022 7374 646f 7574 222c  name": "stdout",
-0000d140: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-0000d150: 2020 2020 2022 7465 7874 223a 2066 227b       "text": f"{
-0000d160: 7465 7874 7d5c 6e22 2c0a 2020 2020 2020  text}\n",.      
-0000d170: 2020 2020 2020 2020 2020 2020 2020 226f                "o
-0000d180: 7574 7075 745f 7479 7065 223a 2022 7374  utput_type": "st
-0000d190: 7265 616d 222c 0a20 2020 2020 2020 2020  ream",.         
-0000d1a0: 2020 2020 2020 207d 0a20 2020 2020 2020         }.       
-0000d1b0: 2020 2020 2020 2020 2061 7373 6572 7420           assert 
-0000d1c0: 7363 7261 7463 685f 7570 6461 7465 5b22  scratch_update["
-0000d1d0: 6f75 7470 7574 225d 203d 3d20 6578 7065  output"] == expe
-0000d1e0: 6374 6564 5f6f 7574 7075 740a 0a20 2020  cted_output..   
-0000d1f0: 2020 2020 2020 2020 2061 7761 6974 2072           await r
-0000d200: 6563 6569 7665 5f74 6578 7428 2268 6572  eceive_text("her
-0000d210: 6573 2229 0a20 2020 2020 2020 2020 2020  es").           
-0000d220: 2061 7761 6974 2072 6563 6569 7665 5f74   await receive_t
-0000d230: 6578 7428 2261 2229 0a20 2020 2020 2020  ext("a").       
-0000d240: 2020 2020 2061 7761 6974 2072 6563 6569       await recei
-0000d250: 7665 5f74 6578 7428 2273 7472 6561 6d6f  ve_text("streamo
-0000d260: 6664 6174 6122 290a 0a20 2020 2020 2020  fdata")..       
-0000d270: 2020 2020 2023 2053 6372 6174 6368 2065       # Scratch e
-0000d280: 7865 6375 7469 6f6e 2073 7461 7465 2073  xecution state s
-0000d290: 6574 2074 6f20 6964 6c65 0a20 2020 2020  et to idle.     
-0000d2a0: 2020 2020 2020 2064 6174 6120 3d20 6177         data = aw
-0000d2b0: 6169 7420 7265 6365 6976 655f 6a73 6f6e  ait receive_json
-0000d2c0: 2877 6562 736f 636b 6574 2c20 6d73 675f  (websocket, msg_
-0000d2d0: 7479 7065 733d 5b22 7363 7261 7463 685f  types=["scratch_
-0000d2e0: 7570 6461 7465 225d 290a 2020 2020 2020  update"]).      
-0000d2f0: 2020 2020 2020 7363 7261 7463 685f 7570        scratch_up
-0000d300: 6461 7465 203d 2064 6174 615b 2273 6372  date = data["scr
-0000d310: 6174 6368 5f75 7064 6174 6522 5d0a 2020  atch_update"].  
-0000d320: 2020 2020 2020 2020 2020 6173 7365 7274            assert
-0000d330: 2073 6372 6174 6368 5f75 7064 6174 655b   scratch_update[
-0000d340: 226d 6573 7361 6765 5f69 6422 5d20 3d3d  "message_id"] ==
-0000d350: 206d 6573 7361 6765 5f69 640a 2020 2020   message_id.    
-0000d360: 2020 2020 2020 2020 6173 7365 7274 2073          assert s
-0000d370: 6372 6174 6368 5f75 7064 6174 655b 2265  cratch_update["e
-0000d380: 7865 6375 7469 6f6e 5f73 7461 7465 225d  xecution_state"]
-0000d390: 203d 3d20 2269 646c 6522 0a0a 2020 2020   == "idle"..    
-0000d3a0: 4070 7974 6573 742e 6d61 726b 2e61 7379  @pytest.mark.asy
-0000d3b0: 6e63 696f 0a20 2020 2061 7379 6e63 2064  ncio.    async d
-0000d3c0: 6566 2074 6573 745f 7661 7273 5f75 7064  ef test_vars_upd
-0000d3d0: 6174 655f 6365 6c6c 5f65 7865 6375 7465  ate_cell_execute
-0000d3e0: 280a 2020 2020 2020 2020 7365 6c66 2c20  (.        self, 
-0000d3f0: 636c 6965 6e74 3a20 5465 7374 436c 6965  client: TestClie
-0000d400: 6e74 2c20 7375 7065 7275 7365 725f 746f  nt, superuser_to
-0000d410: 6b65 6e5f 6865 6164 6572 733a 2044 6963  ken_headers: Dic
-0000d420: 745b 7374 722c 2073 7472 5d0a 2020 2020  t[str, str].    
-0000d430: 293a 0a20 2020 2020 2020 2075 7569 6420  ):.        uuid 
-0000d440: 3d20 6177 6169 7420 7570 6c6f 6164 5f6e  = await upload_n
-0000d450: 6f74 6562 6f6f 6b28 0a20 2020 2020 2020  otebook(.       
-0000d460: 2020 2020 2063 6c69 656e 742c 2073 7570       client, sup
-0000d470: 6572 7573 6572 5f74 6f6b 656e 5f68 6561  eruser_token_hea
-0000d480: 6465 7273 2c20 2273 696d 706c 652e 6970  ders, "simple.ip
-0000d490: 796e 6222 0a20 2020 2020 2020 2029 0a0a  ynb".        )..
-0000d4a0: 2020 2020 2020 2020 2320 6765 7420 616e          # get an
-0000d4b0: 2065 7869 7374 696e 6720 6365 6c6c 0a20   existing cell. 
-0000d4c0: 2020 2020 2020 2072 6573 706f 6e73 6520         response 
-0000d4d0: 3d20 6177 6169 7420 636c 6965 6e74 2e67  = await client.g
-0000d4e0: 6574 280a 2020 2020 2020 2020 2020 2020  et(.            
-0000d4f0: 6622 2f6e 6f74 6562 6f6f 6b73 2f7b 7575  f"/notebooks/{uu
-0000d500: 6964 7d2f 6365 6c6c 7322 2c20 6865 6164  id}/cells", head
-0000d510: 6572 733d 7375 7065 7275 7365 725f 746f  ers=superuser_to
-0000d520: 6b65 6e5f 6865 6164 6572 730a 2020 2020  ken_headers.    
-0000d530: 2020 2020 290a 2020 2020 2020 2020 6173      ).        as
-0000d540: 7365 7274 2072 6573 706f 6e73 652e 7374  sert response.st
-0000d550: 6174 7573 5f63 6f64 6520 3d3d 2032 3030  atus_code == 200
-0000d560: 0a20 2020 2020 2020 2063 656c 6c73 203d  .        cells =
-0000d570: 2072 6573 706f 6e73 652e 6a73 6f6e 2829   response.json()
-0000d580: 5b22 6365 6c6c 7322 5d0a 2020 2020 2020  ["cells"].      
-0000d590: 2020 6173 7365 7274 2063 656c 6c73 5b31    assert cells[1
-0000d5a0: 5d5b 2273 6f75 7263 6522 5d20 3d3d 2027  ]["source"] == '
-0000d5b0: 7072 696e 7428 224c 6172 7279 2074 6865  print("Larry the
-0000d5c0: 204c 6c61 6d61 2229 270a 0a20 2020 2020   Llama")'..     
-0000d5d0: 2020 2063 656c 6c5f 7575 6964 203d 2063     cell_uuid = c
-0000d5e0: 656c 6c73 5b31 5d5b 226d 6574 6164 6174  ells[1]["metadat
-0000d5f0: 6122 5d5b 226a 7570 7974 6572 5f64 3122  a"]["jupyter_d1"
-0000d600: 5d5b 2275 7569 6422 5d0a 0a20 2020 2020  ]["uuid"]..     
-0000d610: 2020 2070 6172 616d 7320 3d20 7b22 736f     params = {"so
-0000d620: 7572 6365 223a 2022 7820 3d20 372d 3922  urce": "x = 7-9"
-0000d630: 7d0a 2020 2020 2020 2020 7265 7370 6f6e  }.        respon
-0000d640: 7365 203d 2061 7761 6974 2063 6c69 656e  se = await clien
-0000d650: 742e 7061 7463 6828 0a20 2020 2020 2020  t.patch(.       
-0000d660: 2020 2020 2066 222f 6e6f 7465 626f 6f6b       f"/notebook
-0000d670: 732f 7b75 7569 647d 2f63 656c 6c73 2f7b  s/{uuid}/cells/{
-0000d680: 6365 6c6c 5f75 7569 647d 222c 0a20 2020  cell_uuid}",.   
-0000d690: 2020 2020 2020 2020 206a 736f 6e3d 7061           json=pa
-0000d6a0: 7261 6d73 2c0a 2020 2020 2020 2020 2020  rams,.          
-0000d6b0: 2020 6865 6164 6572 733d 7375 7065 7275    headers=superu
-0000d6c0: 7365 725f 746f 6b65 6e5f 6865 6164 6572  ser_token_header
-0000d6d0: 732c 0a20 2020 2020 2020 2029 0a20 2020  s,.        ).   
-0000d6e0: 2020 2020 2061 7373 6572 7420 7265 7370       assert resp
-0000d6f0: 6f6e 7365 2e73 7461 7475 735f 636f 6465  onse.status_code
-0000d700: 203d 3d20 3230 300a 0a20 2020 2020 2020   == 200..       
-0000d710: 2072 6573 706f 6e73 6520 3d20 6177 6169   response = awai
-0000d720: 7420 636c 6965 6e74 2e67 6574 280a 2020  t client.get(.  
-0000d730: 2020 2020 2020 2020 2020 6622 2f6e 6f74            f"/not
-0000d740: 6562 6f6f 6b73 2f7b 7575 6964 7d2f 7661  ebooks/{uuid}/va
-0000d750: 7273 222c 2068 6561 6465 7273 3d73 7570  rs", headers=sup
-0000d760: 6572 7573 6572 5f74 6f6b 656e 5f68 6561  eruser_token_hea
-0000d770: 6465 7273 0a20 2020 2020 2020 2029 0a20  ders.        ). 
-0000d780: 2020 2020 2020 2061 7373 6572 7420 7265         assert re
-0000d790: 7370 6f6e 7365 2e73 7461 7475 735f 636f  sponse.status_co
-0000d7a0: 6465 203d 3d20 3230 300a 2020 2020 2020  de == 200.      
-0000d7b0: 2020 6173 7365 7274 206c 656e 2872 6573    assert len(res
-0000d7c0: 706f 6e73 652e 6a73 6f6e 2829 5b22 7661  ponse.json()["va
-0000d7d0: 7273 225d 2920 3d3d 2030 0a0a 2020 2020  rs"]) == 0..    
-0000d7e0: 2020 2020 6173 796e 6320 7769 7468 2063      async with c
-0000d7f0: 6c69 656e 742e 7765 6273 6f63 6b65 745f  lient.websocket_
-0000d800: 636f 6e6e 6563 7428 0a20 2020 2020 2020  connect(.       
-0000d810: 2020 2020 2066 222f 6e6f 7465 626f 6f6b       f"/notebook
-0000d820: 732f 7b75 7569 647d 2f77 732f 6e6f 7465  s/{uuid}/ws/note
-0000d830: 626f 6f6b 222c 2068 6561 6465 7273 3d73  book", headers=s
-0000d840: 7570 6572 7573 6572 5f74 6f6b 656e 5f68  uperuser_token_h
-0000d850: 6561 6465 7273 0a20 2020 2020 2020 2029  eaders.        )
-0000d860: 2061 7320 7765 6273 6f63 6b65 743a 0a20   as websocket:. 
-0000d870: 2020 2020 2020 2020 2020 2061 7761 6974             await
-0000d880: 2061 7379 6e63 696f 2e73 6c65 6570 2857   asyncio.sleep(W
-0000d890: 4542 534f 434b 4554 5f53 4c45 4550 5f54  EBSOCKET_SLEEP_T
-0000d8a0: 494d 4529 0a0a 2020 2020 2020 2020 2020  IME)..          
-0000d8b0: 2020 7265 7370 6f6e 7365 203d 2061 7761    response = awa
-0000d8c0: 6974 2063 6c69 656e 742e 6765 7428 0a20  it client.get(. 
-0000d8d0: 2020 2020 2020 2020 2020 2020 2020 2066                 f
-0000d8e0: 222f 6e6f 7465 626f 6f6b 732f 7b75 7569  "/notebooks/{uui
-0000d8f0: 647d 2f63 656c 6c73 2f7b 6365 6c6c 5f75  d}/cells/{cell_u
-0000d900: 7569 647d 2f65 7865 6375 7465 222c 0a20  uid}/execute",. 
-0000d910: 2020 2020 2020 2020 2020 2020 2020 2068                 h
-0000d920: 6561 6465 7273 3d73 7570 6572 7573 6572  eaders=superuser
-0000d930: 5f74 6f6b 656e 5f68 6561 6465 7273 2c0a  _token_headers,.
-0000d940: 2020 2020 2020 2020 2020 2020 290a 2020              ).  
-0000d950: 2020 2020 2020 2020 2020 6173 7365 7274            assert
-0000d960: 2072 6573 706f 6e73 652e 7374 6174 7573   response.status
-0000d970: 5f63 6f64 6520 3d3d 2032 3030 0a0a 2020  _code == 200..  
-0000d980: 2020 2020 2020 2020 2020 2320 4b65 726e            # Kern
-0000d990: 656c 2076 6172 7320 7570 6461 7465 0a20  el vars update. 
-0000d9a0: 2020 2020 2020 2020 2020 2064 6174 6120             data 
-0000d9b0: 3d20 6177 6169 7420 7265 6365 6976 655f  = await receive_
-0000d9c0: 6a73 6f6e 2877 6562 736f 636b 6574 2c20  json(websocket, 
-0000d9d0: 6d73 675f 7479 7065 733d 5b22 7661 7273  msg_types=["vars
-0000d9e0: 225d 290a 2020 2020 2020 2020 2020 2020  "]).            
-0000d9f0: 7661 7273 203d 207b 0a20 2020 2020 2020  vars = {.       
-0000da00: 2020 2020 2020 2020 2076 6172 5b22 6e61           var["na
-0000da10: 6d65 225d 3a20 7b0a 2020 2020 2020 2020  me"]: {.        
-0000da20: 2020 2020 2020 2020 2020 2020 2274 7970              "typ
-0000da30: 6522 3a20 7661 725b 2274 7970 6522 5d2c  e": var["type"],
-0000da40: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-0000da50: 2020 2020 2022 7661 6c75 6522 3a20 7661       "value": va
-0000da60: 725b 2276 616c 7565 225d 2c0a 2020 2020  r["value"],.    
-0000da70: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000da80: 2273 756d 6d61 7279 223a 2076 6172 5b22  "summary": var["
-0000da90: 7375 6d6d 6172 7922 5d2c 0a20 2020 2020  summary"],.     
-0000daa0: 2020 2020 2020 2020 2020 207d 0a20 2020             }.   
-0000dab0: 2020 2020 2020 2020 2020 2020 2066 6f72               for
-0000dac0: 2076 6172 2069 6e20 6461 7461 5b22 7661   var in data["va
-0000dad0: 7273 225d 0a20 2020 2020 2020 2020 2020  rs"].           
-0000dae0: 207d 0a0a 2020 2020 2020 2020 2020 2020   }..            
-0000daf0: 6173 7365 7274 2076 6172 735b 2278 225d  assert vars["x"]
-0000db00: 5b22 7479 7065 225d 203d 3d20 2269 6e74  ["type"] == "int
-0000db10: 220a 2020 2020 2020 2020 2020 2020 6173  ".            as
-0000db20: 7365 7274 2076 6172 735b 2278 225d 5b22  sert vars["x"]["
-0000db30: 7661 6c75 6522 5d5b 2273 696e 676c 655f  value"]["single_
-0000db40: 7661 6c75 6522 5d20 3d3d 2022 2d32 220a  value"] == "-2".
-0000db50: 2020 2020 2020 2020 2020 2020 6173 7365              asse
-0000db60: 7274 2076 6172 735b 2278 225d 5b22 7375  rt vars["x"]["su
-0000db70: 6d6d 6172 7922 5d20 3d3d 2022 2d32 220a  mmary"] == "-2".
-0000db80: 0a20 2020 2020 2020 2020 2020 2072 6573  .            res
-0000db90: 706f 6e73 6520 3d20 6177 6169 7420 636c  ponse = await cl
-0000dba0: 6965 6e74 2e67 6574 280a 2020 2020 2020  ient.get(.      
-0000dbb0: 2020 2020 2020 2020 2020 6622 2f6e 6f74            f"/not
-0000dbc0: 6562 6f6f 6b73 2f7b 7575 6964 7d2f 7661  ebooks/{uuid}/va
-0000dbd0: 7273 222c 2068 6561 6465 7273 3d73 7570  rs", headers=sup
-0000dbe0: 6572 7573 6572 5f74 6f6b 656e 5f68 6561  eruser_token_hea
-0000dbf0: 6465 7273 0a20 2020 2020 2020 2020 2020  ders.           
-0000dc00: 2029 0a20 2020 2020 2020 2020 2020 2061   ).            a
-0000dc10: 7373 6572 7420 7265 7370 6f6e 7365 2e73  ssert response.s
-0000dc20: 7461 7475 735f 636f 6465 203d 3d20 3230  tatus_code == 20
-0000dc30: 300a 2020 2020 2020 2020 2020 2020 6375  0.            cu
-0000dc40: 7272 656e 745f 7661 7273 203d 2072 6573  rrent_vars = res
-0000dc50: 706f 6e73 652e 6a73 6f6e 2829 5b22 7661  ponse.json()["va
-0000dc60: 7273 225d 0a20 2020 2020 2020 2020 2020  rs"].           
-0000dc70: 2063 7572 7265 6e74 5f76 6172 7320 3d20   current_vars = 
-0000dc80: 6669 6c74 6572 280a 2020 2020 2020 2020  filter(.        
-0000dc90: 2020 2020 2020 2020 6c61 6d62 6461 2078          lambda x
-0000dca0: 3a20 785b 226e 616d 6522 5d20 213d 2022  : x["name"] != "
-0000dcb0: 5f5f 5f64 316f 7322 2c20 6375 7272 656e  ___d1os", curren
-0000dcc0: 745f 7661 7273 0a20 2020 2020 2020 2020  t_vars.         
-0000dcd0: 2020 2029 0a20 2020 2020 2020 2020 2020     ).           
-0000dce0: 2061 7373 6572 7420 6c69 7374 2863 7572   assert list(cur
-0000dcf0: 7265 6e74 5f76 6172 7329 203d 3d20 6461  rent_vars) == da
-0000dd00: 7461 5b22 7661 7273 225d 0a0a 2020 2020  ta["vars"]..    
-0000dd10: 4070 7974 6573 742e 6d61 726b 2e61 7379  @pytest.mark.asy
-0000dd20: 6e63 696f 0a20 2020 2061 7379 6e63 2064  ncio.    async d
-0000dd30: 6566 2074 6573 745f 7661 7273 5f75 7064  ef test_vars_upd
-0000dd40: 6174 655f 7363 7261 7463 685f 6578 6563  ate_scratch_exec
-0000dd50: 7574 6528 0a20 2020 2020 2020 2073 656c  ute(.        sel
-0000dd60: 662c 2063 6c69 656e 743a 2054 6573 7443  f, client: TestC
-0000dd70: 6c69 656e 742c 2073 7570 6572 7573 6572  lient, superuser
-0000dd80: 5f74 6f6b 656e 5f68 6561 6465 7273 3a20  _token_headers: 
-0000dd90: 4469 6374 5b73 7472 2c20 7374 725d 0a20  Dict[str, str]. 
-0000dda0: 2020 2029 3a0a 2020 2020 2020 2020 7575     ):.        uu
-0000ddb0: 6964 203d 2061 7761 6974 2075 706c 6f61  id = await uploa
-0000ddc0: 645f 6e6f 7465 626f 6f6b 280a 2020 2020  d_notebook(.    
-0000ddd0: 2020 2020 2020 2020 636c 6965 6e74 2c20          client, 
-0000dde0: 7375 7065 7275 7365 725f 746f 6b65 6e5f  superuser_token_
-0000ddf0: 6865 6164 6572 732c 2022 7369 6d70 6c65  headers, "simple
-0000de00: 2e69 7079 6e62 220a 2020 2020 2020 2020  .ipynb".        
-0000de10: 290a 0a20 2020 2020 2020 2072 6573 706f  )..        respo
-0000de20: 6e73 6520 3d20 6177 6169 7420 636c 6965  nse = await clie
-0000de30: 6e74 2e67 6574 280a 2020 2020 2020 2020  nt.get(.        
-0000de40: 2020 2020 6622 2f6e 6f74 6562 6f6f 6b73      f"/notebooks
-0000de50: 2f7b 7575 6964 7d2f 7661 7273 222c 2068  /{uuid}/vars", h
-0000de60: 6561 6465 7273 3d73 7570 6572 7573 6572  eaders=superuser
-0000de70: 5f74 6f6b 656e 5f68 6561 6465 7273 0a20  _token_headers. 
-0000de80: 2020 2020 2020 2029 0a20 2020 2020 2020         ).       
-0000de90: 2061 7373 6572 7420 7265 7370 6f6e 7365   assert response
-0000dea0: 2e73 7461 7475 735f 636f 6465 203d 3d20  .status_code == 
-0000deb0: 3230 300a 2020 2020 2020 2020 6173 7365  200.        asse
-0000dec0: 7274 206c 656e 2872 6573 706f 6e73 652e  rt len(response.
-0000ded0: 6a73 6f6e 2829 5b22 7661 7273 225d 2920  json()["vars"]) 
-0000dee0: 3d3d 2030 0a0a 2020 2020 2020 2020 6173  == 0..        as
-0000def0: 796e 6320 7769 7468 2063 6c69 656e 742e  ync with client.
-0000df00: 7765 6273 6f63 6b65 745f 636f 6e6e 6563  websocket_connec
-0000df10: 7428 0a20 2020 2020 2020 2020 2020 2066  t(.            f
-0000df20: 222f 6e6f 7465 626f 6f6b 732f 7b75 7569  "/notebooks/{uui
-0000df30: 647d 2f77 732f 6e6f 7465 626f 6f6b 222c  d}/ws/notebook",
-0000df40: 2068 6561 6465 7273 3d73 7570 6572 7573   headers=superus
-0000df50: 6572 5f74 6f6b 656e 5f68 6561 6465 7273  er_token_headers
-0000df60: 0a20 2020 2020 2020 2029 2061 7320 7765  .        ) as we
-0000df70: 6273 6f63 6b65 743a 0a20 2020 2020 2020  bsocket:.       
-0000df80: 2020 2020 2061 7761 6974 2061 7379 6e63       await async
-0000df90: 696f 2e73 6c65 6570 2857 4542 534f 434b  io.sleep(WEBSOCK
-0000dfa0: 4554 5f53 4c45 4550 5f54 494d 4529 0a0a  ET_SLEEP_TIME)..
-0000dfb0: 2020 2020 2020 2020 2020 2020 7265 7370              resp
-0000dfc0: 6f6e 7365 203d 2061 7761 6974 2063 6c69  onse = await cli
-0000dfd0: 656e 742e 706f 7374 280a 2020 2020 2020  ent.post(.      
-0000dfe0: 2020 2020 2020 2020 2020 6622 2f6e 6f74            f"/not
-0000dff0: 6562 6f6f 6b73 2f7b 7575 6964 7d2f 7363  ebooks/{uuid}/sc
-0000e000: 7261 7463 685f 6578 6563 7574 6522 2c0a  ratch_execute",.
-0000e010: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000e020: 6865 6164 6572 733d 7375 7065 7275 7365  headers=superuse
-0000e030: 725f 746f 6b65 6e5f 6865 6164 6572 732c  r_token_headers,
-0000e040: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-0000e050: 206a 736f 6e3d 7b22 636f 6465 223a 2022   json={"code": "
-0000e060: 785f 7520 3d20 3237 2f31 3022 7d2c 0a20  x_u = 27/10"},. 
-0000e070: 2020 2020 2020 2020 2020 2029 0a20 2020             ).   
-0000e080: 2020 2020 2020 2020 2061 7373 6572 7420           assert 
-0000e090: 7265 7370 6f6e 7365 2e73 7461 7475 735f  response.status_
-0000e0a0: 636f 6465 203d 3d20 3230 300a 0a20 2020  code == 200..   
-0000e0b0: 2020 2020 2020 2020 2023 204b 6572 6e65           # Kerne
-0000e0c0: 6c20 7661 7273 2075 7064 6174 650a 2020  l vars update.  
-0000e0d0: 2020 2020 2020 2020 2020 6461 7461 203d            data =
-0000e0e0: 2061 7761 6974 2072 6563 6569 7665 5f6a   await receive_j
-0000e0f0: 736f 6e28 7765 6273 6f63 6b65 742c 206d  son(websocket, m
-0000e100: 7367 5f74 7970 6573 3d5b 2276 6172 7322  sg_types=["vars"
-0000e110: 5d29 0a20 2020 2020 2020 2020 2020 2076  ]).            v
-0000e120: 6172 7320 3d20 7b0a 2020 2020 2020 2020  ars = {.        
-0000e130: 2020 2020 2020 2020 7661 725b 226e 616d          var["nam
-0000e140: 6522 5d3a 207b 0a20 2020 2020 2020 2020  e"]: {.         
-0000e150: 2020 2020 2020 2020 2020 2022 7479 7065             "type
-0000e160: 223a 2076 6172 5b22 7479 7065 225d 2c0a  ": var["type"],.
-0000e170: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000e180: 2020 2020 2276 616c 7565 223a 2076 6172      "value": var
-0000e190: 5b22 7661 6c75 6522 5d2c 0a20 2020 2020  ["value"],.     
-0000e1a0: 2020 2020 2020 2020 2020 2020 2020 2022                 "
-0000e1b0: 7375 6d6d 6172 7922 3a20 7661 725b 2273  summary": var["s
-0000e1c0: 756d 6d61 7279 225d 2c0a 2020 2020 2020  ummary"],.      
-0000e1d0: 2020 2020 2020 2020 2020 7d0a 2020 2020            }.    
-0000e1e0: 2020 2020 2020 2020 2020 2020 666f 7220              for 
-0000e1f0: 7661 7220 696e 2064 6174 615b 2276 6172  var in data["var
-0000e200: 7322 5d0a 2020 2020 2020 2020 2020 2020  s"].            
-0000e210: 7d0a 0a20 2020 2020 2020 2020 2020 2061  }..            a
-0000e220: 7373 6572 7420 7661 7273 5b22 785f 7522  ssert vars["x_u"
-0000e230: 5d5b 2274 7970 6522 5d20 3d3d 2022 666c  ]["type"] == "fl
-0000e240: 6f61 7422 0a20 2020 2020 2020 2020 2020  oat".           
-0000e250: 2061 7373 6572 7420 7661 7273 5b22 785f   assert vars["x_
-0000e260: 7522 5d5b 2276 616c 7565 225d 5b22 7369  u"]["value"]["si
-0000e270: 6e67 6c65 5f76 616c 7565 225d 203d 3d20  ngle_value"] == 
-0000e280: 2232 2e37 220a 2020 2020 2020 2020 2020  "2.7".          
-0000e290: 2020 6173 7365 7274 2076 6172 735b 2278    assert vars["x
-0000e2a0: 5f75 225d 5b22 7375 6d6d 6172 7922 5d20  _u"]["summary"] 
-0000e2b0: 3d3d 2022 322e 3722 0a0a 2020 2020 2020  == "2.7"..      
-0000e2c0: 2020 2020 2020 7265 7370 6f6e 7365 203d        response =
-0000e2d0: 2061 7761 6974 2063 6c69 656e 742e 6765   await client.ge
-0000e2e0: 7428 0a20 2020 2020 2020 2020 2020 2020  t(.             
-0000e2f0: 2020 2066 222f 6e6f 7465 626f 6f6b 732f     f"/notebooks/
-0000e300: 7b75 7569 647d 2f76 6172 7322 2c20 6865  {uuid}/vars", he
-0000e310: 6164 6572 733d 7375 7065 7275 7365 725f  aders=superuser_
-0000e320: 746f 6b65 6e5f 6865 6164 6572 730a 2020  token_headers.  
-0000e330: 2020 2020 2020 2020 2020 290a 2020 2020            ).    
-0000e340: 2020 2020 2020 2020 6173 7365 7274 2072          assert r
-0000e350: 6573 706f 6e73 652e 7374 6174 7573 5f63  esponse.status_c
-0000e360: 6f64 6520 3d3d 2032 3030 0a20 2020 2020  ode == 200.     
-0000e370: 2020 2020 2020 2063 7572 7265 6e74 5f76         current_v
-0000e380: 6172 7320 3d20 7265 7370 6f6e 7365 2e6a  ars = response.j
-0000e390: 736f 6e28 295b 2276 6172 7322 5d0a 2020  son()["vars"].  
-0000e3a0: 2020 2020 2020 2020 2020 6375 7272 656e            curren
-0000e3b0: 745f 7661 7273 203d 2066 696c 7465 7228  t_vars = filter(
-0000e3c0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-0000e3d0: 206c 616d 6264 6120 783a 2078 5b22 6e61   lambda x: x["na
-0000e3e0: 6d65 225d 2021 3d20 225f 5f5f 6431 6f73  me"] != "___d1os
-0000e3f0: 222c 2063 7572 7265 6e74 5f76 6172 730a  ", current_vars.
-0000e400: 2020 2020 2020 2020 2020 2020 290a 2020              ).  
-0000e410: 2020 2020 2020 2020 2020 6173 7365 7274            assert
-0000e420: 206c 6973 7428 6375 7272 656e 745f 7661   list(current_va
-0000e430: 7273 2920 3d3d 2064 6174 615b 2276 6172  rs) == data["var
-0000e440: 7322 5d0a 0a20 2020 2040 7079 7465 7374  s"]..    @pytest
-0000e450: 2e6d 6172 6b2e 6173 796e 6369 6f0a 2020  .mark.asyncio.  
-0000e460: 2020 6173 796e 6320 6465 6620 7465 7374    async def test
-0000e470: 5f6e 6f74 6562 6f6f 6b5f 7772 6974 655f  _notebook_write_
-0000e480: 7065 726d 6973 7369 6f6e 280a 2020 2020  permission(.    
-0000e490: 2020 2020 7365 6c66 2c0a 2020 2020 2020      self,.      
-0000e4a0: 2020 636c 6965 6e74 3a20 5465 7374 436c    client: TestCl
-0000e4b0: 6965 6e74 2c0a 2020 2020 2020 2020 7375  ient,.        su
-0000e4c0: 7065 7275 7365 725f 746f 6b65 6e5f 6865  peruser_token_he
-0000e4d0: 6164 6572 733a 2044 6963 745b 7374 722c  aders: Dict[str,
-0000e4e0: 2073 7472 5d2c 0a20 2020 2020 2020 2072   str],.        r
-0000e4f0: 6561 646f 6e6c 795f 746f 6b65 6e5f 6865  eadonly_token_he
-0000e500: 6164 6572 733a 2044 6963 745b 7374 722c  aders: Dict[str,
-0000e510: 2073 7472 5d2c 0a20 2020 2029 3a0a 2020   str],.    ):.  
-0000e520: 2020 2020 2020 7575 6964 203d 2061 7761        uuid = awa
-0000e530: 6974 2075 706c 6f61 645f 6e6f 7465 626f  it upload_notebo
-0000e540: 6f6b 2863 6c69 656e 742c 2073 7570 6572  ok(client, super
-0000e550: 7573 6572 5f74 6f6b 656e 5f68 6561 6465  user_token_heade
-0000e560: 7273 290a 0a20 2020 2020 2020 2077 6974  rs)..        wit
-0000e570: 6820 7079 7465 7374 2e72 6169 7365 7328  h pytest.raises(
-0000e580: 4173 7365 7274 696f 6e45 7272 6f72 293a  AssertionError):
-0000e590: 0a20 2020 2020 2020 2020 2020 2061 7379  .            asy
-0000e5a0: 6e63 2077 6974 6820 636c 6965 6e74 2e77  nc with client.w
-0000e5b0: 6562 736f 636b 6574 5f63 6f6e 6e65 6374  ebsocket_connect
-0000e5c0: 280a 2020 2020 2020 2020 2020 2020 2020  (.              
-0000e5d0: 2020 6622 2f6e 6f74 6562 6f6f 6b73 2f7b    f"/notebooks/{
-0000e5e0: 7575 6964 7d2f 7773 2f6e 6f74 6562 6f6f  uuid}/ws/noteboo
-0000e5f0: 6b22 2c0a 2020 2020 2020 2020 2020 2020  k",.            
-0000e600: 2020 2020 6865 6164 6572 733d 7265 6164      headers=read
-0000e610: 6f6e 6c79 5f74 6f6b 656e 5f68 6561 6465  only_token_heade
-0000e620: 7273 2c0a 2020 2020 2020 2020 2020 2020  rs,.            
-0000e630: 293a 0a20 2020 2020 2020 2020 2020 2020  ):.             
-0000e640: 2020 2070 6173 730a 0a20 2020 2020 2020     pass..       
-0000e650: 2061 7379 6e63 2077 6974 6820 636c 6965   async with clie
-0000e660: 6e74 2e77 6562 736f 636b 6574 5f63 6f6e  nt.websocket_con
-0000e670: 6e65 6374 280a 2020 2020 2020 2020 2020  nect(.          
-0000e680: 2020 6622 2f6e 6f74 6562 6f6f 6b73 2f7b    f"/notebooks/{
-0000e690: 7575 6964 7d2f 7773 2f6e 6f74 6562 6f6f  uuid}/ws/noteboo
-0000e6a0: 6b22 2c20 6865 6164 6572 733d 7375 7065  k", headers=supe
-0000e6b0: 7275 7365 725f 746f 6b65 6e5f 6865 6164  ruser_token_head
-0000e6c0: 6572 730a 2020 2020 2020 2020 293a 0a20  ers.        ):. 
-0000e6d0: 2020 2020 2020 2020 2020 2070 6173 730a             pass.
-0000e6e0: 0a20 2020 2040 7079 7465 7374 2e6d 6172  .    @pytest.mar
-0000e6f0: 6b2e 6173 796e 6369 6f0a 2020 2020 6173  k.asyncio.    as
-0000e700: 796e 6320 6465 6620 7465 7374 5f6e 6f74  ync def test_not
-0000e710: 6562 6f6f 6b5f 7374 7265 616d 5f70 6572  ebook_stream_per
-0000e720: 6d69 7373 696f 6e28 0a20 2020 2020 2020  mission(.       
-0000e730: 2073 656c 662c 0a20 2020 2020 2020 2063   self,.        c
-0000e740: 6c69 656e 743a 2054 6573 7443 6c69 656e  lient: TestClien
-0000e750: 742c 0a20 2020 2020 2020 2073 7570 6572  t,.        super
-0000e760: 7573 6572 5f74 6f6b 656e 5f68 6561 6465  user_token_heade
-0000e770: 7273 3a20 4469 6374 5b73 7472 2c20 7374  rs: Dict[str, st
-0000e780: 725d 2c0a 2020 2020 2020 2020 7265 6164  r],.        read
-0000e790: 6f6e 6c79 5f74 6f6b 656e 5f68 6561 6465  only_token_heade
-0000e7a0: 7273 3a20 4469 6374 5b73 7472 2c20 7374  rs: Dict[str, st
-0000e7b0: 725d 2c0a 2020 2020 2020 2020 7065 726d  r],.        perm
-0000e7c0: 6973 7369 6f6e 6c65 7373 5f74 6f6b 656e  issionless_token
-0000e7d0: 5f68 6561 6465 7273 3a20 4469 6374 5b73  _headers: Dict[s
-0000e7e0: 7472 2c20 7374 725d 2c0a 2020 2020 293a  tr, str],.    ):
-0000e7f0: 0a20 2020 2020 2020 2075 7569 6420 3d20  .        uuid = 
-0000e800: 6177 6169 7420 7570 6c6f 6164 5f6e 6f74  await upload_not
-0000e810: 6562 6f6f 6b28 636c 6965 6e74 2c20 7375  ebook(client, su
-0000e820: 7065 7275 7365 725f 746f 6b65 6e5f 6865  peruser_token_he
-0000e830: 6164 6572 7329 0a0a 2020 2020 2020 2020  aders)..        
-0000e840: 7769 7468 2070 7974 6573 742e 7261 6973  with pytest.rais
-0000e850: 6573 2841 7373 6572 7469 6f6e 4572 726f  es(AssertionErro
-0000e860: 7229 3a0a 2020 2020 2020 2020 2020 2020  r):.            
-0000e870: 6173 796e 6320 7769 7468 2063 6c69 656e  async with clien
-0000e880: 742e 7765 6273 6f63 6b65 745f 636f 6e6e  t.websocket_conn
-0000e890: 6563 7428 0a20 2020 2020 2020 2020 2020  ect(.           
-0000e8a0: 2020 2020 2066 222f 6e6f 7465 626f 6f6b       f"/notebook
-0000e8b0: 732f 7b75 7569 647d 2f77 732f 7374 7265  s/{uuid}/ws/stre
-0000e8c0: 616d 222c 0a20 2020 2020 2020 2020 2020  am",.           
-0000e8d0: 2020 2020 2068 6561 6465 7273 3d70 6572       headers=per
-0000e8e0: 6d69 7373 696f 6e6c 6573 735f 746f 6b65  missionless_toke
-0000e8f0: 6e5f 6865 6164 6572 732c 0a20 2020 2020  n_headers,.     
-0000e900: 2020 2020 2020 2029 3a0a 2020 2020 2020         ):.      
-0000e910: 2020 2020 2020 2020 2020 7061 7373 0a0a            pass..
-0000e920: 2020 2020 2020 2020 6173 796e 6320 7769          async wi
-0000e930: 7468 2063 6c69 656e 742e 7765 6273 6f63  th client.websoc
-0000e940: 6b65 745f 636f 6e6e 6563 7428 0a20 2020  ket_connect(.   
-0000e950: 2020 2020 2020 2020 2066 222f 6e6f 7465           f"/note
-0000e960: 626f 6f6b 732f 7b75 7569 647d 2f77 732f  books/{uuid}/ws/
-0000e970: 7374 7265 616d 222c 2068 6561 6465 7273  stream", headers
-0000e980: 3d72 6561 646f 6e6c 795f 746f 6b65 6e5f  =readonly_token_
-0000e990: 6865 6164 6572 730a 2020 2020 2020 2020  headers.        
-0000e9a0: 293a 0a20 2020 2020 2020 2020 2020 2070  ):.            p
-0000e9b0: 6173 730a 0a20 2020 2040 7079 7465 7374  ass..    @pytest
-0000e9c0: 2e6d 6172 6b2e 6173 796e 6369 6f0a 2020  .mark.asyncio.  
-0000e9d0: 2020 6173 796e 6320 6465 6620 7465 7374    async def test
-0000e9e0: 5f76 6172 735f 7570 6461 7465 5f62 6173  _vars_update_bas
-0000e9f0: 6828 0a20 2020 2020 2020 2073 656c 662c  h(.        self,
-0000ea00: 2063 6c69 656e 743a 2054 6573 7443 6c69   client: TestCli
-0000ea10: 656e 742c 2073 7570 6572 7573 6572 5f74  ent, superuser_t
-0000ea20: 6f6b 656e 5f68 6561 6465 7273 3a20 4469  oken_headers: Di
-0000ea30: 6374 5b73 7472 2c20 7374 725d 0a20 2020  ct[str, str].   
-0000ea40: 2029 3a0a 2020 2020 2020 2020 7265 7370   ):.        resp
-0000ea50: 6f6e 7365 203d 2061 7761 6974 2063 6c69  onse = await cli
-0000ea60: 656e 742e 706f 7374 280a 2020 2020 2020  ent.post(.      
-0000ea70: 2020 2020 2020 222f 6e6f 7465 626f 6f6b        "/notebook
-0000ea80: 732f 6372 6561 7465 222c 0a20 2020 2020  s/create",.     
-0000ea90: 2020 2020 2020 2071 7565 7279 5f73 7472         query_str
-0000eaa0: 696e 673d 7b22 6b73 7065 635f 6e61 6d65  ing={"kspec_name
-0000eab0: 223a 2022 6261 7368 222c 2022 6669 6c65  ": "bash", "file
-0000eac0: 6e61 6d65 223a 2022 6865 7970 227d 2c0a  name": "heyp"},.
-0000ead0: 2020 2020 2020 2020 2020 2020 6865 6164              head
-0000eae0: 6572 733d 7375 7065 7275 7365 725f 746f  ers=superuser_to
-0000eaf0: 6b65 6e5f 6865 6164 6572 732c 0a20 2020  ken_headers,.   
-0000eb00: 2020 2020 2029 0a20 2020 2020 2020 2061       ).        a
-0000eb10: 7373 6572 7420 7265 7370 6f6e 7365 2e73  ssert response.s
-0000eb20: 7461 7475 735f 636f 6465 203d 3d20 3230  tatus_code == 20
-0000eb30: 310a 2020 2020 2020 2020 7265 7370 5f6a  1.        resp_j
-0000eb40: 736f 6e20 3d20 7265 7370 6f6e 7365 2e6a  son = response.j
-0000eb50: 736f 6e28 295b 226e 6f74 6562 6f6f 6b22  son()["notebook"
-0000eb60: 5d0a 2020 2020 2020 2020 7575 6964 203d  ].        uuid =
-0000eb70: 2072 6573 705f 6a73 6f6e 5b22 6d65 7461   resp_json["meta
-0000eb80: 6461 7461 225d 5b22 6a75 7079 7465 725f  data"]["jupyter_
-0000eb90: 6431 225d 5b22 7575 6964 225d 0a0a 2020  d1"]["uuid"]..  
-0000eba0: 2020 2020 2020 7265 7370 6f6e 7365 203d        response =
-0000ebb0: 2061 7761 6974 2063 6c69 656e 742e 6765   await client.ge
-0000ebc0: 7428 0a20 2020 2020 2020 2020 2020 2066  t(.            f
-0000ebd0: 222f 6e6f 7465 626f 6f6b 732f 7b75 7569  "/notebooks/{uui
-0000ebe0: 647d 2f76 6172 7322 2c20 6865 6164 6572  d}/vars", header
-0000ebf0: 733d 7375 7065 7275 7365 725f 746f 6b65  s=superuser_toke
-0000ec00: 6e5f 6865 6164 6572 730a 2020 2020 2020  n_headers.      
-0000ec10: 2020 290a 2020 2020 2020 2020 6173 7365    ).        asse
-0000ec20: 7274 2072 6573 706f 6e73 652e 7374 6174  rt response.stat
-0000ec30: 7573 5f63 6f64 6520 3d3d 2032 3030 0a20  us_code == 200. 
-0000ec40: 2020 2020 2020 2076 6172 735f 6c69 7374         vars_list
-0000ec50: 203d 2072 6573 706f 6e73 652e 6a73 6f6e   = response.json
-0000ec60: 2829 5b22 7661 7273 225d 0a20 2020 2020  ()["vars"].     
-0000ec70: 2020 2061 7373 6572 7420 6c65 6e28 7661     assert len(va
-0000ec80: 7273 5f6c 6973 7429 203d 3d20 300a 0a20  rs_list) == 0.. 
-0000ec90: 2020 2020 2020 2061 7379 6e63 2077 6974         async wit
-0000eca0: 6820 636c 6965 6e74 2e77 6562 736f 636b  h client.websock
-0000ecb0: 6574 5f63 6f6e 6e65 6374 280a 2020 2020  et_connect(.    
-0000ecc0: 2020 2020 2020 2020 6622 2f6e 6f74 6562          f"/noteb
-0000ecd0: 6f6f 6b73 2f7b 7575 6964 7d2f 7773 2f6e  ooks/{uuid}/ws/n
-0000ece0: 6f74 6562 6f6f 6b22 2c20 6865 6164 6572  otebook", header
-0000ecf0: 733d 7375 7065 7275 7365 725f 746f 6b65  s=superuser_toke
-0000ed00: 6e5f 6865 6164 6572 730a 2020 2020 2020  n_headers.      
-0000ed10: 2020 2920 6173 2077 6562 736f 636b 6574    ) as websocket
-0000ed20: 3a0a 2020 2020 2020 2020 2020 2020 6177  :.            aw
-0000ed30: 6169 7420 6173 796e 6369 6f2e 736c 6565  ait asyncio.slee
-0000ed40: 7028 5745 4253 4f43 4b45 545f 534c 4545  p(WEBSOCKET_SLEE
-0000ed50: 505f 5449 4d45 290a 0a20 2020 2020 2020  P_TIME)..       
-0000ed60: 2020 2020 2072 6573 706f 6e73 6520 3d20       response = 
-0000ed70: 6177 6169 7420 636c 6965 6e74 2e70 6f73  await client.pos
-0000ed80: 7428 0a20 2020 2020 2020 2020 2020 2020  t(.             
-0000ed90: 2020 2066 222f 6e6f 7465 626f 6f6b 732f     f"/notebooks/
-0000eda0: 7b75 7569 647d 2f73 6372 6174 6368 5f65  {uuid}/scratch_e
-0000edb0: 7865 6375 7465 222c 0a20 2020 2020 2020  xecute",.       
-0000edc0: 2020 2020 2020 2020 2068 6561 6465 7273           headers
-0000edd0: 3d73 7570 6572 7573 6572 5f74 6f6b 656e  =superuser_token
-0000ede0: 5f68 6561 6465 7273 2c0a 2020 2020 2020  _headers,.      
-0000edf0: 2020 2020 2020 2020 2020 6a73 6f6e 3d7b            json={
-0000ee00: 2263 6f64 6522 3a20 2265 7870 6f72 7420  "code": "export 
-0000ee10: 4431 5f56 4152 5f54 4553 543d 7039 3033  D1_VAR_TEST=p903
-0000ee20: 7322 7d2c 0a20 2020 2020 2020 2020 2020  s"},.           
-0000ee30: 2029 0a20 2020 2020 2020 2020 2020 2061   ).            a
-0000ee40: 7373 6572 7420 7265 7370 6f6e 7365 2e73  ssert response.s
-0000ee50: 7461 7475 735f 636f 6465 203d 3d20 3230  tatus_code == 20
-0000ee60: 300a 0a20 2020 2020 2020 2020 2020 2064  0..            d
-0000ee70: 6174 6120 3d20 6177 6169 7420 7265 6365  ata = await rece
-0000ee80: 6976 655f 6a73 6f6e 280a 2020 2020 2020  ive_json(.      
-0000ee90: 2020 2020 2020 2020 2020 7765 6273 6f63            websoc
-0000eea0: 6b65 742c 2074 696d 656f 7574 3d36 302c  ket, timeout=60,
-0000eeb0: 206d 7367 5f74 7970 6573 3d5b 2276 6172   msg_types=["var
-0000eec0: 7322 5d0a 2020 2020 2020 2020 2020 2020  s"].            
-0000eed0: 290a 2020 2020 2020 2020 2020 2020 7661  ).            va
-0000eee0: 7273 203d 207b 0a20 2020 2020 2020 2020  rs = {.         
-0000eef0: 2020 2020 2020 2076 6172 5b22 6e61 6d65         var["name
-0000ef00: 225d 3a20 7b0a 2020 2020 2020 2020 2020  "]: {.          
-0000ef10: 2020 2020 2020 2020 2020 2274 7970 6522            "type"
-0000ef20: 3a20 7661 725b 2274 7970 6522 5d2c 0a20  : var["type"],. 
-0000ef30: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000ef40: 2020 2022 7661 6c75 6522 3a20 7661 725b     "value": var[
-0000ef50: 2276 616c 7565 225d 2c0a 2020 2020 2020  "value"],.      
-0000ef60: 2020 2020 2020 2020 2020 2020 2020 2273                "s
-0000ef70: 756d 6d61 7279 223a 2076 6172 5b22 7375  ummary": var["su
-0000ef80: 6d6d 6172 7922 5d2c 0a20 2020 2020 2020  mmary"],.       
-0000ef90: 2020 2020 2020 2020 207d 0a20 2020 2020           }.     
-0000efa0: 2020 2020 2020 2020 2020 2066 6f72 2076             for v
-0000efb0: 6172 2069 6e20 6461 7461 5b22 7661 7273  ar in data["vars
-0000efc0: 225d 0a20 2020 2020 2020 2020 2020 207d  "].            }
-0000efd0: 0a20 2020 2020 2020 2020 2020 2061 7373  .            ass
-0000efe0: 6572 7420 7661 7273 5b22 4431 5f56 4152  ert vars["D1_VAR
-0000eff0: 5f54 4553 5422 5d5b 2274 7970 6522 5d20  _TEST"]["type"] 
-0000f000: 6973 204e 6f6e 650a 2020 2020 2020 2020  is None.        
-0000f010: 2020 2020 6173 7365 7274 2076 6172 735b      assert vars[
-0000f020: 2244 315f 5641 525f 5445 5354 225d 5b22  "D1_VAR_TEST"]["
-0000f030: 7661 6c75 6522 5d5b 2273 696e 676c 655f  value"]["single_
-0000f040: 7661 6c75 6522 5d20 3d3d 2022 7039 3033  value"] == "p903
-0000f050: 7322 0a20 2020 2020 2020 2020 2020 2061  s".            a
-0000f060: 7373 6572 7420 7661 7273 5b22 4431 5f56  ssert vars["D1_V
-0000f070: 4152 5f54 4553 5422 5d5b 2273 756d 6d61  AR_TEST"]["summa
-0000f080: 7279 225d 203d 3d20 2270 3930 3373 220a  ry"] == "p903s".
-0000f090: 0a20 2020 2040 7079 7465 7374 2e6d 6172  .    @pytest.mar
-0000f0a0: 6b2e 6173 796e 6369 6f0a 2020 2020 6173  k.asyncio.    as
-0000f0b0: 796e 6320 6465 6620 7465 7374 5f76 6172  ync def test_var
-0000f0c0: 735f 7570 6461 7465 5f72 5f6b 6572 6e65  s_update_r_kerne
-0000f0d0: 6c28 0a20 2020 2020 2020 2073 656c 662c  l(.        self,
-0000f0e0: 2063 6c69 656e 743a 2054 6573 7443 6c69   client: TestCli
-0000f0f0: 656e 742c 2073 7570 6572 7573 6572 5f74  ent, superuser_t
-0000f100: 6f6b 656e 5f68 6561 6465 7273 3a20 4469  oken_headers: Di
-0000f110: 6374 5b73 7472 2c20 7374 725d 0a20 2020  ct[str, str].   
-0000f120: 2029 3a0a 2020 2020 2020 2020 7265 7370   ):.        resp
-0000f130: 6f6e 7365 203d 2061 7761 6974 2063 6c69  onse = await cli
-0000f140: 656e 742e 706f 7374 280a 2020 2020 2020  ent.post(.      
-0000f150: 2020 2020 2020 222f 6e6f 7465 626f 6f6b        "/notebook
-0000f160: 732f 6372 6561 7465 222c 0a20 2020 2020  s/create",.     
-0000f170: 2020 2020 2020 2071 7565 7279 5f73 7472         query_str
-0000f180: 696e 673d 7b22 6b73 7065 635f 6e61 6d65  ing={"kspec_name
-0000f190: 223a 2022 6972 222c 2022 6669 6c65 6e61  ": "ir", "filena
-0000f1a0: 6d65 223a 2022 6865 7970 227d 2c0a 2020  me": "heyp"},.  
-0000f1b0: 2020 2020 2020 2020 2020 6865 6164 6572            header
-0000f1c0: 733d 7375 7065 7275 7365 725f 746f 6b65  s=superuser_toke
-0000f1d0: 6e5f 6865 6164 6572 732c 0a20 2020 2020  n_headers,.     
-0000f1e0: 2020 2029 0a20 2020 2020 2020 2061 7373     ).        ass
-0000f1f0: 6572 7420 7265 7370 6f6e 7365 2e73 7461  ert response.sta
-0000f200: 7475 735f 636f 6465 203d 3d20 3230 310a  tus_code == 201.
-0000f210: 2020 2020 2020 2020 7265 7370 5f6a 736f          resp_jso
-0000f220: 6e20 3d20 7265 7370 6f6e 7365 2e6a 736f  n = response.jso
-0000f230: 6e28 295b 226e 6f74 6562 6f6f 6b22 5d0a  n()["notebook"].
-0000f240: 2020 2020 2020 2020 7575 6964 203d 2072          uuid = r
-0000f250: 6573 705f 6a73 6f6e 5b22 6d65 7461 6461  esp_json["metada
-0000f260: 7461 225d 5b22 6a75 7079 7465 725f 6431  ta"]["jupyter_d1
-0000f270: 225d 5b22 7575 6964 225d 0a0a 2020 2020  "]["uuid"]..    
-0000f280: 2020 2020 7265 7370 6f6e 7365 203d 2061      response = a
-0000f290: 7761 6974 2063 6c69 656e 742e 6765 7428  wait client.get(
-0000f2a0: 0a20 2020 2020 2020 2020 2020 2066 222f  .            f"/
-0000f2b0: 6e6f 7465 626f 6f6b 732f 7b75 7569 647d  notebooks/{uuid}
-0000f2c0: 2f76 6172 7322 2c20 6865 6164 6572 733d  /vars", headers=
-0000f2d0: 7375 7065 7275 7365 725f 746f 6b65 6e5f  superuser_token_
-0000f2e0: 6865 6164 6572 730a 2020 2020 2020 2020  headers.        
-0000f2f0: 290a 2020 2020 2020 2020 6173 7365 7274  ).        assert
-0000f300: 2072 6573 706f 6e73 652e 7374 6174 7573   response.status
-0000f310: 5f63 6f64 6520 3d3d 2032 3030 0a20 2020  _code == 200.   
-0000f320: 2020 2020 2076 6172 735f 6c69 7374 203d       vars_list =
-0000f330: 2072 6573 706f 6e73 652e 6a73 6f6e 2829   response.json()
-0000f340: 5b22 7661 7273 225d 0a20 2020 2020 2020  ["vars"].       
-0000f350: 2061 7373 6572 7420 6c65 6e28 7661 7273   assert len(vars
-0000f360: 5f6c 6973 7429 203d 3d20 300a 0a20 2020  _list) == 0..   
-0000f370: 2020 2020 2061 7379 6e63 2077 6974 6820       async with 
-0000f380: 636c 6965 6e74 2e77 6562 736f 636b 6574  client.websocket
-0000f390: 5f63 6f6e 6e65 6374 280a 2020 2020 2020  _connect(.      
-0000f3a0: 2020 2020 2020 6622 2f6e 6f74 6562 6f6f        f"/noteboo
-0000f3b0: 6b73 2f7b 7575 6964 7d2f 7773 2f6e 6f74  ks/{uuid}/ws/not
-0000f3c0: 6562 6f6f 6b22 2c20 6865 6164 6572 733d  ebook", headers=
-0000f3d0: 7375 7065 7275 7365 725f 746f 6b65 6e5f  superuser_token_
-0000f3e0: 6865 6164 6572 730a 2020 2020 2020 2020  headers.        
-0000f3f0: 2920 6173 2077 6562 736f 636b 6574 3a0a  ) as websocket:.
-0000f400: 2020 2020 2020 2020 2020 2020 6177 6169              awai
-0000f410: 7420 6173 796e 6369 6f2e 736c 6565 7028  t asyncio.sleep(
-0000f420: 5745 4253 4f43 4b45 545f 534c 4545 505f  WEBSOCKET_SLEEP_
-0000f430: 5449 4d45 290a 0a20 2020 2020 2020 2020  TIME)..         
-0000f440: 2020 2072 6573 706f 6e73 6520 3d20 6177     response = aw
-0000f450: 6169 7420 636c 6965 6e74 2e70 6f73 7428  ait client.post(
-0000f460: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-0000f470: 2066 222f 6e6f 7465 626f 6f6b 732f 7b75   f"/notebooks/{u
-0000f480: 7569 647d 2f73 6372 6174 6368 5f65 7865  uid}/scratch_exe
-0000f490: 6375 7465 222c 0a20 2020 2020 2020 2020  cute",.         
-0000f4a0: 2020 2020 2020 2068 6561 6465 7273 3d73         headers=s
-0000f4b0: 7570 6572 7573 6572 5f74 6f6b 656e 5f68  uperuser_token_h
-0000f4c0: 6561 6465 7273 2c0a 2020 2020 2020 2020  eaders,.        
-0000f4d0: 2020 2020 2020 2020 6a73 6f6e 3d7b 0a20          json={. 
-0000f4e0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000f4f0: 2020 2022 636f 6465 223a 2022 6666 6f20     "code": "ffo 
-0000f500: 3c2d 2039 5c6e 220a 2020 2020 2020 2020  <- 9\n".        
-0000f510: 2020 2020 2020 2020 2020 2020 276b 203d              'k =
-0000f520: 2064 6174 612e 6672 616d 6528 636f 6c31   data.frame(col1
-0000f530: 3d63 2822 7422 2c20 3529 2c20 270a 2020  =c("t", 5), '.  
-0000f540: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000f550: 2020 2763 6f6c 323d 6328 2234 222c 2036    'col2=c("4", 6
-0000f560: 292c 2063 6f6c 333d 6328 2268 222c 2038  ), col3=c("h", 8
-0000f570: 2929 270a 2020 2020 2020 2020 2020 2020  ))'.            
-0000f580: 2020 2020 7d2c 0a20 2020 2020 2020 2020      },.         
-0000f590: 2020 2029 0a20 2020 2020 2020 2020 2020     ).           
-0000f5a0: 2061 7373 6572 7420 7265 7370 6f6e 7365   assert response
-0000f5b0: 2e73 7461 7475 735f 636f 6465 203d 3d20  .status_code == 
-0000f5c0: 3230 300a 0a20 2020 2020 2020 2020 2020  200..           
-0000f5d0: 2023 2047 6976 6520 6974 2074 696d 6520   # Give it time 
-0000f5e0: 746f 2069 6e73 7461 6c6c 2063 616c 6c69  to install calli
-0000f5f0: 7374 6f72 0a20 2020 2020 2020 2020 2020  stor.           
-0000f600: 2061 7761 6974 2061 7379 6e63 696f 2e73   await asyncio.s
-0000f610: 6c65 6570 2831 3029 0a0a 2020 2020 2020  leep(10)..      
-0000f620: 2020 2020 2020 6461 7461 203d 2061 7761        data = awa
-0000f630: 6974 2072 6563 6569 7665 5f6a 736f 6e28  it receive_json(
-0000f640: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-0000f650: 2077 6562 736f 636b 6574 2c20 7469 6d65   websocket, time
-0000f660: 6f75 743d 3630 2c20 6d73 675f 7479 7065  out=60, msg_type
-0000f670: 733d 5b22 7661 7273 225d 0a20 2020 2020  s=["vars"].     
-0000f680: 2020 2020 2020 2029 0a20 2020 2020 2020         ).       
-0000f690: 2020 2020 2076 6172 7320 3d20 7b76 6172       vars = {var
-0000f6a0: 5b22 6e61 6d65 225d 3a20 7661 7220 666f  ["name"]: var fo
-0000f6b0: 7220 7661 7220 696e 2064 6174 615b 2276  r var in data["v
-0000f6c0: 6172 7322 5d7d 0a0a 2020 2020 2020 2020  ars"]}..        
-0000f6d0: 2020 2020 6173 7365 7274 2076 6172 735b      assert vars[
-0000f6e0: 2266 666f 225d 5b22 7479 7065 225d 203d  "ffo"]["type"] =
-0000f6f0: 3d20 226e 756d 6572 6963 220a 2020 2020  = "numeric".    
-0000f700: 2020 2020 2020 2020 6173 7365 7274 2076          assert v
-0000f710: 6172 735b 2266 666f 225d 5b22 6162 6272  ars["ffo"]["abbr
-0000f720: 6576 6961 7465 6422 5d20 6973 2046 616c  eviated"] is Fal
-0000f730: 7365 0a20 2020 2020 2020 2020 2020 2061  se.            a
-0000f740: 7373 6572 7420 7661 7273 5b22 6666 6f22  ssert vars["ffo"
-0000f750: 5d5b 2273 756d 6d61 7279 225d 203d 3d20  ]["summary"] == 
-0000f760: 2239 220a 2020 2020 2020 2020 2020 2020  "9".            
-0000f770: 6173 7365 7274 2076 6172 735b 2266 666f  assert vars["ffo
-0000f780: 225d 5b22 7661 6c75 6522 5d5b 2273 696e  "]["value"]["sin
-0000f790: 676c 655f 7661 6c75 6522 5d20 3d3d 2022  gle_value"] == "
-0000f7a0: 3922 0a20 2020 2020 2020 2020 2020 2061  9".            a
-0000f7b0: 7373 6572 7420 7661 7273 5b22 6b22 5d5b  ssert vars["k"][
-0000f7c0: 2274 7970 6522 5d20 3d3d 2022 6461 7461  "type"] == "data
-0000f7d0: 2e66 7261 6d65 220a 2020 2020 2020 2020  .frame".        
-0000f7e0: 2020 2020 6173 7365 7274 2076 6172 735b      assert vars[
-0000f7f0: 226b 225d 5b22 6162 6272 6576 6961 7465  "k"]["abbreviate
-0000f800: 6422 5d20 6973 2046 616c 7365 0a20 2020  d"] is False.   
-0000f810: 2020 2020 2020 2020 2061 7373 6572 7420           assert 
-0000f820: 2253 697a 653a 2032 7833 204d 656d 6f72  "Size: 2x3 Memor
-0000f830: 793a 2022 2069 6e20 7661 7273 5b22 6b22  y: " in vars["k"
-0000f840: 5d5b 2273 756d 6d61 7279 225d 0a20 2020  ]["summary"].   
-0000f850: 2020 2020 2020 2020 2061 7373 6572 7420           assert 
-0000f860: 7661 7273 5b22 6b22 5d5b 2276 616c 7565  vars["k"]["value
-0000f870: 225d 5b22 6d75 6c74 695f 7661 6c75 6522  "]["multi_value"
-0000f880: 5d5b 2263 6f6c 756d 6e5f 636f 756e 7422  ]["column_count"
-0000f890: 5d20 3d3d 2033 0a20 2020 2020 2020 2020  ] == 3.         
-0000f8a0: 2020 2061 7373 6572 7420 7661 7273 5b22     assert vars["
-0000f8b0: 6b22 5d5b 2276 616c 7565 225d 5b22 6d75  k"]["value"]["mu
-0000f8c0: 6c74 695f 7661 6c75 6522 5d5b 2272 6f77  lti_value"]["row
-0000f8d0: 5f63 6f75 6e74 225d 203d 3d20 320a 2020  _count"] == 2.  
-0000f8e0: 2020 2020 2020 2020 2020 6173 7365 7274            assert
-0000f8f0: 2076 6172 735b 226b 225d 5b22 7661 6c75   vars["k"]["valu
-0000f900: 6522 5d5b 226d 756c 7469 5f76 616c 7565  e"]["multi_value
-0000f910: 225d 5b22 636f 6c75 6d6e 5f6e 616d 6573  "]["column_names
-0000f920: 225d 203d 3d20 5b0a 2020 2020 2020 2020  "] == [.        
-0000f930: 2020 2020 2020 2020 2263 6f6c 3120 2863          "col1 (c
-0000f940: 6861 7261 6374 6572 2922 2c0a 2020 2020  haracter)",.    
-0000f950: 2020 2020 2020 2020 2020 2020 2263 6f6c              "col
-0000f960: 3220 2863 6861 7261 6374 6572 2922 2c0a  2 (character)",.
-0000f970: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000f980: 2263 6f6c 3320 2863 6861 7261 6374 6572  "col3 (character
-0000f990: 2922 2c0a 2020 2020 2020 2020 2020 2020  )",.            
-0000f9a0: 5d0a 2020 2020 2020 2020 2020 2020 6173  ].            as
-0000f9b0: 7365 7274 2076 6172 735b 226b 225d 5b22  sert vars["k"]["
-0000f9c0: 7661 6c75 6522 5d5b 226d 756c 7469 5f76  value"]["multi_v
-0000f9d0: 616c 7565 225d 5b22 726f 775f 6e61 6d65  alue"]["row_name
-0000f9e0: 7322 5d20 3d3d 205b 2231 222c 2022 3222  s"] == ["1", "2"
-0000f9f0: 5d0a 2020 2020 2020 2020 2020 2020 6173  ].            as
-0000fa00: 7365 7274 2076 6172 735b 226b 225d 5b22  sert vars["k"]["
-0000fa10: 7661 6c75 6522 5d5b 226d 756c 7469 5f76  value"]["multi_v
-0000fa20: 616c 7565 225d 5b22 6461 7461 225d 203d  alue"]["data"] =
-0000fa30: 3d20 5b0a 2020 2020 2020 2020 2020 2020  = [.            
-0000fa40: 2020 2020 5b22 7422 2c20 2234 222c 2022      ["t", "4", "
-0000fa50: 6822 5d2c 0a20 2020 2020 2020 2020 2020  h"],.           
-0000fa60: 2020 2020 205b 2235 222c 2022 3622 2c20       ["5", "6", 
-0000fa70: 2238 225d 2c0a 2020 2020 2020 2020 2020  "8"],.          
-0000fa80: 2020 5d0a 0a20 2020 2040 7079 7465 7374    ]..    @pytest
-0000fa90: 2e6d 6172 6b2e 6173 796e 6369 6f0a 2020  .mark.asyncio.  
-0000faa0: 2020 6173 796e 6320 6465 6620 7465 7374    async def test
-0000fab0: 5f70 6167 655f 7061 796c 6f61 6428 0a20  _page_payload(. 
-0000fac0: 2020 2020 2020 2073 656c 662c 2063 6c69         self, cli
-0000fad0: 656e 743a 2054 6573 7443 6c69 656e 742c  ent: TestClient,
-0000fae0: 2073 7570 6572 7573 6572 5f74 6f6b 656e   superuser_token
-0000faf0: 5f68 6561 6465 7273 3a20 4469 6374 5b73  _headers: Dict[s
-0000fb00: 7472 2c20 7374 725d 0a20 2020 2029 3a0a  tr, str].    ):.
-0000fb10: 2020 2020 2020 2020 7265 7370 6f6e 7365          response
-0000fb20: 203d 2061 7761 6974 2063 6c69 656e 742e   = await client.
-0000fb30: 706f 7374 280a 2020 2020 2020 2020 2020  post(.          
-0000fb40: 2020 222f 6e6f 7465 626f 6f6b 732f 6372    "/notebooks/cr
-0000fb50: 6561 7465 222c 0a20 2020 2020 2020 2020  eate",.         
-0000fb60: 2020 2071 7565 7279 5f73 7472 696e 673d     query_string=
-0000fb70: 7b22 6b73 7065 635f 6e61 6d65 223a 2022  {"kspec_name": "
-0000fb80: 7079 7468 6f6e 222c 2022 6669 6c65 6e61  python", "filena
-0000fb90: 6d65 223a 2022 6865 7970 227d 2c0a 2020  me": "heyp"},.  
-0000fba0: 2020 2020 2020 2020 2020 6865 6164 6572            header
-0000fbb0: 733d 7375 7065 7275 7365 725f 746f 6b65  s=superuser_toke
-0000fbc0: 6e5f 6865 6164 6572 732c 0a20 2020 2020  n_headers,.     
-0000fbd0: 2020 2029 0a20 2020 2020 2020 2061 7373     ).        ass
-0000fbe0: 6572 7420 7265 7370 6f6e 7365 2e73 7461  ert response.sta
-0000fbf0: 7475 735f 636f 6465 203d 3d20 3230 310a  tus_code == 201.
-0000fc00: 2020 2020 2020 2020 7265 7370 5f6a 736f          resp_jso
-0000fc10: 6e20 3d20 7265 7370 6f6e 7365 2e6a 736f  n = response.jso
-0000fc20: 6e28 295b 226e 6f74 6562 6f6f 6b22 5d0a  n()["notebook"].
-0000fc30: 2020 2020 2020 2020 7575 6964 203d 2072          uuid = r
-0000fc40: 6573 705f 6a73 6f6e 5b22 6d65 7461 6461  esp_json["metada
-0000fc50: 7461 225d 5b22 6a75 7079 7465 725f 6431  ta"]["jupyter_d1
-0000fc60: 225d 5b22 7575 6964 225d 0a0a 2020 2020  "]["uuid"]..    
-0000fc70: 2020 2020 7265 7370 6f6e 7365 203d 2061      response = a
-0000fc80: 7761 6974 2063 6c69 656e 742e 706f 7374  wait client.post
-0000fc90: 280a 2020 2020 2020 2020 2020 2020 6622  (.            f"
-0000fca0: 2f6e 6f74 6562 6f6f 6b73 2f7b 7575 6964  /notebooks/{uuid
-0000fcb0: 7d2f 6365 6c6c 7322 2c0a 2020 2020 2020  }/cells",.      
-0000fcc0: 2020 2020 2020 6865 6164 6572 733d 7375        headers=su
-0000fcd0: 7065 7275 7365 725f 746f 6b65 6e5f 6865  peruser_token_he
-0000fce0: 6164 6572 732c 0a20 2020 2020 2020 2020  aders,.         
-0000fcf0: 2020 206a 736f 6e3d 7b22 6365 6c6c 5f74     json={"cell_t
-0000fd00: 7970 6522 3a20 2263 6f64 6522 2c20 2273  ype": "code", "s
-0000fd10: 6f75 7263 6522 3a20 223f 7374 7222 7d2c  ource": "?str"},
-0000fd20: 0a20 2020 2020 2020 2029 0a20 2020 2020  .        ).     
-0000fd30: 2020 2063 656c 6c5f 7575 6964 203d 2072     cell_uuid = r
-0000fd40: 6573 706f 6e73 652e 6a73 6f6e 2829 5b22  esponse.json()["
-0000fd50: 6365 6c6c 225d 5b22 6d65 7461 6461 7461  cell"]["metadata
-0000fd60: 225d 5b22 6a75 7079 7465 725f 6431 225d  "]["jupyter_d1"]
-0000fd70: 5b22 7575 6964 225d 0a0a 2020 2020 2020  ["uuid"]..      
-0000fd80: 2020 6173 796e 6320 7769 7468 2063 6c69    async with cli
-0000fd90: 656e 742e 7765 6273 6f63 6b65 745f 636f  ent.websocket_co
-0000fda0: 6e6e 6563 7428 0a20 2020 2020 2020 2020  nnect(.         
-0000fdb0: 2020 2066 222f 6e6f 7465 626f 6f6b 732f     f"/notebooks/
-0000fdc0: 7b75 7569 647d 2f77 732f 6e6f 7465 626f  {uuid}/ws/notebo
-0000fdd0: 6f6b 222c 2068 6561 6465 7273 3d73 7570  ok", headers=sup
-0000fde0: 6572 7573 6572 5f74 6f6b 656e 5f68 6561  eruser_token_hea
-0000fdf0: 6465 7273 0a20 2020 2020 2020 2029 2061  ders.        ) a
-0000fe00: 7320 7765 6273 6f63 6b65 743a 0a20 2020  s websocket:.   
-0000fe10: 2020 2020 2020 2020 2061 7761 6974 2061           await a
-0000fe20: 7379 6e63 696f 2e73 6c65 6570 2857 4542  syncio.sleep(WEB
-0000fe30: 534f 434b 4554 5f53 4c45 4550 5f54 494d  SOCKET_SLEEP_TIM
-0000fe40: 4529 0a0a 2020 2020 2020 2020 2020 2020  E)..            
-0000fe50: 7265 7370 6f6e 7365 203d 2061 7761 6974  response = await
-0000fe60: 2063 6c69 656e 742e 6765 7428 0a20 2020   client.get(.   
-0000fe70: 2020 2020 2020 2020 2020 2020 2066 222f               f"/
-0000fe80: 6e6f 7465 626f 6f6b 732f 7b75 7569 647d  notebooks/{uuid}
-0000fe90: 2f63 656c 6c73 2f7b 6365 6c6c 5f75 7569  /cells/{cell_uui
-0000fea0: 647d 2f65 7865 6375 7465 222c 0a20 2020  d}/execute",.   
-0000feb0: 2020 2020 2020 2020 2020 2020 2068 6561               hea
-0000fec0: 6465 7273 3d73 7570 6572 7573 6572 5f74  ders=superuser_t
-0000fed0: 6f6b 656e 5f68 6561 6465 7273 2c0a 2020  oken_headers,.  
-0000fee0: 2020 2020 2020 2020 2020 290a 2020 2020            ).    
-0000fef0: 2020 2020 2020 2020 6173 7365 7274 2072          assert r
-0000ff00: 6573 706f 6e73 652e 7374 6174 7573 5f63  esponse.status_c
-0000ff10: 6f64 6520 3d3d 2032 3030 0a20 2020 2020  ode == 200.     
-0000ff20: 2020 2020 2020 206d 7367 5f69 6420 3d20         msg_id = 
-0000ff30: 7265 7370 6f6e 7365 2e6a 736f 6e28 295b  response.json()[
-0000ff40: 226b 6572 6e65 6c5f 6d65 7373 6167 6522  "kernel_message"
-0000ff50: 5d5b 226d 6573 7361 6765 5f69 6422 5d0a  ]["message_id"].
-0000ff60: 0a20 2020 2020 2020 2020 2020 2064 6174  .            dat
-0000ff70: 6120 3d20 6177 6169 7420 7265 6365 6976  a = await receiv
-0000ff80: 655f 6a73 6f6e 2877 6562 736f 636b 6574  e_json(websocket
-0000ff90: 2c20 6d73 675f 7479 7065 733d 5b22 7061  , msg_types=["pa
-0000ffa0: 796c 6f61 645f 7061 6765 225d 290a 2020  yload_page"]).  
-0000ffb0: 2020 2020 2020 2020 2020 6173 7365 7274            assert
-0000ffc0: 2022 7465 7874 2f70 6c61 696e 2220 696e   "text/plain" in
-0000ffd0: 2064 6174 615b 2270 6179 6c6f 6164 5f70   data["payload_p
-0000ffe0: 6167 6522 5d5b 2264 6174 6122 5d0a 2020  age"]["data"].  
+000045c0: 2020 2020 2020 2020 2020 7d0a 2020 2020            }.    
+000045d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000045e0: 2020 2020 5d2c 0a20 2020 2020 2020 2020      ],.         
+000045f0: 2020 2020 2020 2020 2020 2020 2020 2022                 "
+00004600: 736f 7572 6365 223a 2022 372d 3922 2c0a  source": "7-9",.
+00004610: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00004620: 2020 2020 7d0a 2020 2020 2020 2020 2020      }.          
+00004630: 2020 2020 2020 5d0a 2020 2020 2020 2020        ].        
+00004640: 2020 2020 7d0a 0a20 2020 2020 2020 2020      }..         
+00004650: 2020 2070 6174 6368 5f6a 736f 6e20 3d20     patch_json = 
+00004660: 7265 7370 6f6e 7365 2e6a 736f 6e28 290a  response.json().
+00004670: 2020 2020 2020 2020 2020 2020 2320 7265              # re
+00004680: 7370 6f6e 7365 2073 686f 756c 6420 636f  sponse should co
+00004690: 6e74 6169 6e20 626f 7468 2074 6865 2027  ntain both the '
+000046a0: 6365 6c6c 272c 276b 6572 6e65 6c5f 6d65  cell','kernel_me
+000046b0: 7373 6167 6527 2077 7261 7070 6572 730a  ssage' wrappers.
+000046c0: 2020 2020 2020 2020 2020 2020 6173 7365              asse
+000046d0: 7274 2022 6365 6c6c 2220 696e 2070 6174  rt "cell" in pat
+000046e0: 6368 5f6a 736f 6e2e 6b65 7973 2829 0a20  ch_json.keys(). 
+000046f0: 2020 2020 2020 2020 2020 206d 7367 5f69             msg_i
+00004700: 6420 3d20 7265 7370 6f6e 7365 2e6a 736f  d = response.jso
+00004710: 6e28 295b 226b 6572 6e65 6c5f 6d65 7373  n()["kernel_mess
+00004720: 6167 6522 5d5b 226d 6573 7361 6765 5f69  age"]["message_i
+00004730: 6422 5d0a 2020 2020 2020 2020 2020 2020  d"].            
+00004740: 6173 7365 7274 206c 656e 286d 7367 5f69  assert len(msg_i
+00004750: 6429 2069 6e20 6d73 675f 6964 5f6c 656e  d) in msg_id_len
+00004760: 6774 6873 0a0a 2020 2020 2020 2020 2020  gths..          
+00004770: 2020 6578 6563 5f72 6570 6c79 203d 2061    exec_reply = a
+00004780: 7761 6974 2072 6563 6569 7665 5f6a 736f  wait receive_jso
+00004790: 6e28 0a20 2020 2020 2020 2020 2020 2020  n(.             
+000047a0: 2020 2077 6562 736f 636b 6574 2c20 6d73     websocket, ms
+000047b0: 675f 7479 7065 733d 5b22 6365 6c6c 5f65  g_types=["cell_e
+000047c0: 7865 6375 7469 6f6e 5f72 6570 6c79 225d  xecution_reply"]
+000047d0: 0a20 2020 2020 2020 2020 2020 2029 0a20  .            ). 
+000047e0: 2020 2020 2020 2020 2020 2061 7373 6572             asser
+000047f0: 7420 6578 6563 5f72 6570 6c79 5b22 6365  t exec_reply["ce
+00004800: 6c6c 5f65 7865 6375 7469 6f6e 5f72 6570  ll_execution_rep
+00004810: 6c79 225d 5b22 6365 6c6c 5f69 6422 5d20  ly"]["cell_id"] 
+00004820: 3d3d 2063 656c 6c5f 7575 6964 0a20 2020  == cell_uuid.   
+00004830: 2020 2020 2020 2020 2061 7373 6572 7420           assert 
+00004840: 6578 6563 5f72 6570 6c79 5b22 6365 6c6c  exec_reply["cell
+00004850: 5f65 7865 6375 7469 6f6e 5f72 6570 6c79  _execution_reply
+00004860: 225d 5b22 7061 7265 6e74 5f69 6422 5d20  "]["parent_id"] 
+00004870: 3d3d 206d 7367 5f69 640a 0a20 2020 2020  == msg_id..     
+00004880: 2020 2020 2020 2064 6174 6120 3d20 6177         data = aw
+00004890: 6169 7420 7265 6365 6976 655f 6a73 6f6e  ait receive_json
+000048a0: 2877 6562 736f 636b 6574 2c20 6d73 675f  (websocket, msg_
+000048b0: 7479 7065 733d 5b22 6365 6c6c 5f75 7064  types=["cell_upd
+000048c0: 6174 6522 5d29 0a20 2020 2020 2020 2020  ate"]).         
+000048d0: 2020 2061 7373 6572 7420 6461 7461 203d     assert data =
+000048e0: 3d20 6578 7065 6374 6564 0a0a 2020 2020  = expected..    
+000048f0: 4070 7974 6573 742e 6d61 726b 2e61 7379  @pytest.mark.asy
+00004900: 6e63 696f 0a20 2020 2061 7379 6e63 2064  ncio.    async d
+00004910: 6566 2074 6573 745f 6365 6c6c 5f70 6174  ef test_cell_pat
+00004920: 6368 5f61 6e64 5f65 7865 6375 7465 5f66  ch_and_execute_f
+00004930: 6972 7374 5f63 656c 6c5f 696d 706f 7274  irst_cell_import
+00004940: 735f 6f6e 6c79 280a 2020 2020 2020 2020  s_only(.        
+00004950: 7365 6c66 2c20 636c 6965 6e74 3a20 5465  self, client: Te
+00004960: 7374 436c 6965 6e74 2c20 7375 7065 7275  stClient, superu
+00004970: 7365 725f 746f 6b65 6e5f 6865 6164 6572  ser_token_header
+00004980: 733a 2044 6963 745b 7374 722c 2073 7472  s: Dict[str, str
+00004990: 5d0a 2020 2020 293a 0a20 2020 2020 2020  ].    ):.       
+000049a0: 2022 2222 0a20 2020 2020 2020 2054 6573   """.        Tes
+000049b0: 7420 666f 7220 4341 4c2d 3130 3438 2c20  t for CAL-1048, 
+000049c0: 6669 7273 7420 6365 6c6c 2064 6f65 736e  first cell doesn
+000049d0: 7420 7368 6f77 2065 7865 6375 7469 6f6e  t show execution
+000049e0: 2063 6f75 6e74 2069 6620 6974 206f 6e6c   count if it onl
+000049f0: 790a 2020 2020 2020 2020 636f 6e74 6169  y.        contai
+00004a00: 6e73 2069 6d70 6f72 7473 2e0a 2020 2020  ns imports..    
+00004a10: 2020 2020 2222 220a 2020 2020 2020 2020      """.        
+00004a20: 7575 6964 203d 2061 7761 6974 2075 706c  uuid = await upl
+00004a30: 6f61 645f 6e6f 7465 626f 6f6b 280a 2020  oad_notebook(.  
+00004a40: 2020 2020 2020 2020 2020 636c 6965 6e74            client
+00004a50: 2c20 7375 7065 7275 7365 725f 746f 6b65  , superuser_toke
+00004a60: 6e5f 6865 6164 6572 732c 2022 7369 6d70  n_headers, "simp
+00004a70: 6c65 2e69 7079 6e62 220a 2020 2020 2020  le.ipynb".      
+00004a80: 2020 290a 0a20 2020 2020 2020 2023 2067    )..        # g
+00004a90: 6574 2061 6e20 6578 6973 7469 6e67 2063  et an existing c
+00004aa0: 656c 6c0a 2020 2020 2020 2020 7265 7370  ell.        resp
+00004ab0: 6f6e 7365 203d 2061 7761 6974 2063 6c69  onse = await cli
+00004ac0: 656e 742e 6765 7428 0a20 2020 2020 2020  ent.get(.       
+00004ad0: 2020 2020 2066 222f 6e6f 7465 626f 6f6b       f"/notebook
+00004ae0: 732f 7b75 7569 647d 2f63 656c 6c73 222c  s/{uuid}/cells",
+00004af0: 2068 6561 6465 7273 3d73 7570 6572 7573   headers=superus
+00004b00: 6572 5f74 6f6b 656e 5f68 6561 6465 7273  er_token_headers
+00004b10: 0a20 2020 2020 2020 2029 0a20 2020 2020  .        ).     
+00004b20: 2020 2061 7373 6572 7420 7265 7370 6f6e     assert respon
+00004b30: 7365 2e73 7461 7475 735f 636f 6465 203d  se.status_code =
+00004b40: 3d20 3230 300a 2020 2020 2020 2020 6365  = 200.        ce
+00004b50: 6c6c 7320 3d20 7265 7370 6f6e 7365 2e6a  lls = response.j
+00004b60: 736f 6e28 295b 2263 656c 6c73 225d 0a20  son()["cells"]. 
+00004b70: 2020 2020 2020 2061 7373 6572 7420 6365         assert ce
+00004b80: 6c6c 735b 315d 5b22 736f 7572 6365 225d  lls[1]["source"]
+00004b90: 203d 3d20 2770 7269 6e74 2822 4c61 7272   == 'print("Larr
+00004ba0: 7920 7468 6520 4c6c 616d 6122 2927 0a0a  y the Llama")'..
+00004bb0: 2020 2020 2020 2020 6365 6c6c 5f75 7569          cell_uui
+00004bc0: 6420 3d20 6365 6c6c 735b 315d 5b22 6d65  d = cells[1]["me
+00004bd0: 7461 6461 7461 225d 5b22 6a75 7079 7465  tadata"]["jupyte
+00004be0: 725f 6431 225d 5b22 7575 6964 225d 0a0a  r_d1"]["uuid"]..
+00004bf0: 2020 2020 2020 2020 7061 7261 6d73 203d          params =
+00004c00: 207b 0a20 2020 2020 2020 2020 2020 2022   {.            "
+00004c10: 736f 7572 6365 223a 2022 696d 706f 7274  source": "import
+00004c20: 206d 6174 706c 6f74 6c69 6220 6173 206d   matplotlib as m
+00004c30: 706c 5c6e 696d 706f 7274 206d 6174 706c  pl\nimport matpl
+00004c40: 6f74 6c69 622e 7079 706c 6f74 2061 7320  otlib.pyplot as 
+00004c50: 706c 7422 0a20 2020 2020 2020 2020 2020  plt".           
+00004c60: 2022 5c6e 696d 706f 7274 206e 756d 7079   "\nimport numpy
+00004c70: 2061 7320 6e70 220a 2020 2020 2020 2020   as np".        
+00004c80: 7d0a 2020 2020 2020 2020 7265 7370 6f6e  }.        respon
+00004c90: 7365 203d 2061 7761 6974 2063 6c69 656e  se = await clien
+00004ca0: 742e 7061 7463 6828 0a20 2020 2020 2020  t.patch(.       
+00004cb0: 2020 2020 2066 222f 6e6f 7465 626f 6f6b       f"/notebook
+00004cc0: 732f 7b75 7569 647d 2f63 656c 6c73 2f7b  s/{uuid}/cells/{
+00004cd0: 6365 6c6c 5f75 7569 647d 222c 0a20 2020  cell_uuid}",.   
+00004ce0: 2020 2020 2020 2020 206a 736f 6e3d 7061           json=pa
+00004cf0: 7261 6d73 2c0a 2020 2020 2020 2020 2020  rams,.          
+00004d00: 2020 6865 6164 6572 733d 7375 7065 7275    headers=superu
+00004d10: 7365 725f 746f 6b65 6e5f 6865 6164 6572  ser_token_header
+00004d20: 732c 0a20 2020 2020 2020 2029 0a20 2020  s,.        ).   
+00004d30: 2020 2020 2061 7373 6572 7420 7265 7370       assert resp
+00004d40: 6f6e 7365 2e73 7461 7475 735f 636f 6465  onse.status_code
+00004d50: 203d 3d20 3230 300a 0a20 2020 2020 2020   == 200..       
+00004d60: 2072 6573 706f 6e73 6520 3d20 6177 6169   response = awai
+00004d70: 7420 636c 6965 6e74 2e67 6574 280a 2020  t client.get(.  
+00004d80: 2020 2020 2020 2020 2020 6622 2f6e 6f74            f"/not
+00004d90: 6562 6f6f 6b73 2f7b 7575 6964 7d2f 7661  ebooks/{uuid}/va
+00004da0: 7273 222c 2068 6561 6465 7273 3d73 7570  rs", headers=sup
+00004db0: 6572 7573 6572 5f74 6f6b 656e 5f68 6561  eruser_token_hea
+00004dc0: 6465 7273 0a20 2020 2020 2020 2029 0a20  ders.        ). 
+00004dd0: 2020 2020 2020 2061 7373 6572 7420 7265         assert re
+00004de0: 7370 6f6e 7365 2e73 7461 7475 735f 636f  sponse.status_co
+00004df0: 6465 203d 3d20 3230 300a 2020 2020 2020  de == 200.      
+00004e00: 2020 6173 7365 7274 206c 656e 2872 6573    assert len(res
+00004e10: 706f 6e73 652e 6a73 6f6e 2829 5b22 7661  ponse.json()["va
+00004e20: 7273 225d 2920 3d3d 2030 0a0a 2020 2020  rs"]) == 0..    
+00004e30: 2020 2020 6173 796e 6320 7769 7468 2063      async with c
+00004e40: 6c69 656e 742e 7765 6273 6f63 6b65 745f  lient.websocket_
+00004e50: 636f 6e6e 6563 7428 0a20 2020 2020 2020  connect(.       
+00004e60: 2020 2020 2066 222f 6e6f 7465 626f 6f6b       f"/notebook
+00004e70: 732f 7b75 7569 647d 2f77 732f 6e6f 7465  s/{uuid}/ws/note
+00004e80: 626f 6f6b 222c 2068 6561 6465 7273 3d73  book", headers=s
+00004e90: 7570 6572 7573 6572 5f74 6f6b 656e 5f68  uperuser_token_h
+00004ea0: 6561 6465 7273 0a20 2020 2020 2020 2029  eaders.        )
+00004eb0: 2061 7320 7765 6273 6f63 6b65 743a 0a20   as websocket:. 
+00004ec0: 2020 2020 2020 2020 2020 2061 7761 6974             await
+00004ed0: 2061 7379 6e63 696f 2e73 6c65 6570 2857   asyncio.sleep(W
+00004ee0: 4542 534f 434b 4554 5f53 4c45 4550 5f54  EBSOCKET_SLEEP_T
+00004ef0: 494d 4529 0a0a 2020 2020 2020 2020 2020  IME)..          
+00004f00: 2020 7265 7370 6f6e 7365 203d 2061 7761    response = awa
+00004f10: 6974 2063 6c69 656e 742e 7061 7463 6828  it client.patch(
+00004f20: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00004f30: 2066 222f 6e6f 7465 626f 6f6b 732f 7b75   f"/notebooks/{u
+00004f40: 7569 647d 2f63 656c 6c73 2f7b 6365 6c6c  uid}/cells/{cell
+00004f50: 5f75 7569 647d 2f65 7865 6375 7465 222c  _uuid}/execute",
+00004f60: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00004f70: 206a 736f 6e3d 7061 7261 6d73 2c0a 2020   json=params,.  
+00004f80: 2020 2020 2020 2020 2020 2020 2020 6865                he
+00004f90: 6164 6572 733d 7375 7065 7275 7365 725f  aders=superuser_
+00004fa0: 746f 6b65 6e5f 6865 6164 6572 732c 0a20  token_headers,. 
+00004fb0: 2020 2020 2020 2020 2020 2029 0a20 2020             ).   
+00004fc0: 2020 2020 2020 2020 2061 7373 6572 7420           assert 
+00004fd0: 7265 7370 6f6e 7365 2e73 7461 7475 735f  response.status_
+00004fe0: 636f 6465 203d 3d20 3230 300a 2020 2020  code == 200.    
+00004ff0: 2020 2020 2020 2020 7061 7463 685f 6a73          patch_js
+00005000: 6f6e 203d 2072 6573 706f 6e73 652e 6a73  on = response.js
+00005010: 6f6e 2829 0a20 2020 2020 2020 2020 2020  on().           
+00005020: 2023 2072 6573 706f 6e73 6520 7368 6f75   # response shou
+00005030: 6c64 2063 6f6e 7461 696e 2062 6f74 6820  ld contain both 
+00005040: 7468 6520 2763 656c 6c27 2c27 6b65 726e  the 'cell','kern
+00005050: 656c 5f6d 6573 7361 6765 2720 7772 6170  el_message' wrap
+00005060: 7065 7273 0a20 2020 2020 2020 2020 2020  pers.           
+00005070: 2061 7373 6572 7420 2263 656c 6c22 2069   assert "cell" i
+00005080: 6e20 7061 7463 685f 6a73 6f6e 2e6b 6579  n patch_json.key
+00005090: 7328 290a 2020 2020 2020 2020 2020 2020  s().            
+000050a0: 6d73 675f 6964 203d 2072 6573 706f 6e73  msg_id = respons
+000050b0: 652e 6a73 6f6e 2829 5b22 6b65 726e 656c  e.json()["kernel
+000050c0: 5f6d 6573 7361 6765 225d 5b22 6d65 7373  _message"]["mess
+000050d0: 6167 655f 6964 225d 0a20 2020 2020 2020  age_id"].       
+000050e0: 2020 2020 2061 7373 6572 7420 6c65 6e28       assert len(
+000050f0: 6d73 675f 6964 2920 696e 206d 7367 5f69  msg_id) in msg_i
+00005100: 645f 6c65 6e67 7468 730a 0a20 2020 2020  d_lengths..     
+00005110: 2020 2020 2020 2065 7870 6563 7465 6420         expected 
+00005120: 3d20 5b0a 2020 2020 2020 2020 2020 2020  = [.            
+00005130: 2020 2020 2320 6669 7273 7420 6365 6c6c      # first cell
+00005140: 5f75 7064 6174 6520 636f 6d65 7320 6672  _update comes fr
+00005150: 6f6d 2074 6865 2063 656c 6c20 7061 7463  om the cell patc
+00005160: 680a 2020 2020 2020 2020 2020 2020 2020  h.              
+00005170: 2020 7b0a 2020 2020 2020 2020 2020 2020    {.            
+00005180: 2020 2020 2020 2020 2263 656c 6c5f 7570          "cell_up
+00005190: 6461 7465 223a 205b 0a20 2020 2020 2020  date": [.       
+000051a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000051b0: 207b 0a20 2020 2020 2020 2020 2020 2020   {.             
+000051c0: 2020 2020 2020 2020 2020 2020 2020 2022                 "
+000051d0: 6365 6c6c 5f74 7970 6522 3a20 2263 6f64  cell_type": "cod
+000051e0: 6522 2c0a 2020 2020 2020 2020 2020 2020  e",.            
+000051f0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00005200: 2265 7865 6375 7469 6f6e 5f63 6f75 6e74  "execution_count
+00005210: 223a 204e 6f6e 652c 0a20 2020 2020 2020  ": None,.       
+00005220: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00005230: 2020 2020 2022 6d65 7461 6461 7461 223a       "metadata":
+00005240: 207b 0a20 2020 2020 2020 2020 2020 2020   {.             
+00005250: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00005260: 2020 2022 6a75 7079 7465 725f 6431 223a     "jupyter_d1":
+00005270: 207b 0a20 2020 2020 2020 2020 2020 2020   {.             
+00005280: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00005290: 2020 2020 2020 2022 706f 7369 7469 6f6e         "position
+000052a0: 223a 2031 2c0a 2020 2020 2020 2020 2020  ": 1,.          
+000052b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000052c0: 2020 2020 2020 2020 2020 2275 7569 6422            "uuid"
+000052d0: 3a20 6365 6c6c 5f75 7569 642c 0a20 2020  : cell_uuid,.   
+000052e0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000052f0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00005300: 2022 6e6f 7465 626f 6f6b 5f75 7569 6422   "notebook_uuid"
+00005310: 3a20 7575 6964 2c0a 2020 2020 2020 2020  : uuid,.        
+00005320: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00005330: 2020 2020 2020 2020 2020 2020 2265 7865              "exe
+00005340: 6375 7469 6f6e 5f73 7461 7465 223a 2022  cution_state": "
+00005350: 6964 6c65 222c 0a20 2020 2020 2020 2020  idle",.         
+00005360: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00005370: 2020 2020 2020 207d 0a20 2020 2020 2020         }.       
+00005380: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00005390: 2020 2020 207d 2c0a 2020 2020 2020 2020       },.        
+000053a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000053b0: 2020 2020 226f 7574 7075 7473 223a 205b      "outputs": [
+000053c0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+000053d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000053e0: 207b 0a20 2020 2020 2020 2020 2020 2020   {.             
+000053f0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00005400: 2020 2020 2020 2022 6e61 6d65 223a 2022         "name": "
+00005410: 7374 646f 7574 222c 0a20 2020 2020 2020  stdout",.       
+00005420: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00005430: 2020 2020 2020 2020 2020 2020 2022 6f75               "ou
+00005440: 7470 7574 5f74 7970 6522 3a20 2273 7472  tput_type": "str
+00005450: 6561 6d22 2c0a 2020 2020 2020 2020 2020  eam",.          
+00005460: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00005470: 2020 2020 2020 2020 2020 2274 6578 7422            "text"
+00005480: 3a20 224c 6172 7279 2074 6865 204c 6c61  : "Larry the Lla
+00005490: 6d61 5c6e 222c 0a20 2020 2020 2020 2020  ma\n",.         
+000054a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000054b0: 2020 2020 2020 207d 0a20 2020 2020 2020         }.       
+000054c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000054d0: 2020 2020 205d 2c0a 2020 2020 2020 2020       ],.        
+000054e0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000054f0: 2020 2020 2273 6f75 7263 6522 3a20 7061      "source": pa
+00005500: 7261 6d73 5b22 736f 7572 6365 225d 2c0a  rams["source"],.
+00005510: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00005520: 2020 2020 2020 2020 7d0a 2020 2020 2020          }.      
+00005530: 2020 2020 2020 2020 2020 2020 2020 5d0a                ].
+00005540: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00005550: 7d2c 0a20 2020 2020 2020 2020 2020 2020  },.             
+00005560: 2020 2023 2073 6563 6f6e 6420 6365 6c6c     # second cell
+00005570: 5f75 7064 6174 6520 636f 6d65 7320 6672  _update comes fr
+00005580: 6f6d 2074 6865 2063 656c 6c20 6578 6563  om the cell exec
+00005590: 7574 696f 6e20 7374 6172 7469 6e67 0a20  ution starting. 
+000055a0: 2020 2020 2020 2020 2020 2020 2020 207b                 {
+000055b0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+000055c0: 2020 2020 2022 6365 6c6c 5f75 7064 6174       "cell_updat
+000055d0: 6522 3a20 5b0a 2020 2020 2020 2020 2020  e": [.          
+000055e0: 2020 2020 2020 2020 2020 2020 2020 7b0a                {.
+000055f0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00005600: 2020 2020 2020 2020 2020 2020 2263 656c              "cel
+00005610: 6c5f 7479 7065 223a 2022 636f 6465 222c  l_type": "code",
+00005620: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00005630: 2020 2020 2020 2020 2020 2020 2022 6578               "ex
+00005640: 6563 7574 696f 6e5f 636f 756e 7422 3a20  ecution_count": 
+00005650: 4e6f 6e65 2c0a 2020 2020 2020 2020 2020  None,.          
+00005660: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00005670: 2020 226d 6574 6164 6174 6122 3a20 7b0a    "metadata": {.
+00005680: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00005690: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000056a0: 226a 7570 7974 6572 5f64 3122 3a20 7b0a  "jupyter_d1": {.
+000056b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000056c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000056d0: 2020 2020 2270 6f73 6974 696f 6e22 3a20      "position": 
+000056e0: 312c 0a20 2020 2020 2020 2020 2020 2020  1,.             
+000056f0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00005700: 2020 2020 2020 2022 7575 6964 223a 2063         "uuid": c
+00005710: 656c 6c5f 7575 6964 2c0a 2020 2020 2020  ell_uuid,.      
+00005720: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00005730: 2020 2020 2020 2020 2020 2020 2020 226e                "n
+00005740: 6f74 6562 6f6f 6b5f 7575 6964 223a 2075  otebook_uuid": u
+00005750: 7569 642c 0a20 2020 2020 2020 2020 2020  uid,.           
+00005760: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00005770: 2020 2020 2020 2020 2022 6578 6563 7574           "execut
+00005780: 696f 6e5f 7374 6174 6522 3a20 2262 7573  ion_state": "bus
+00005790: 7922 2c0a 2020 2020 2020 2020 2020 2020  y",.            
+000057a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000057b0: 2020 2020 7d0a 2020 2020 2020 2020 2020      }.          
+000057c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000057d0: 2020 7d2c 0a20 2020 2020 2020 2020 2020    },.           
+000057e0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000057f0: 2022 6f75 7470 7574 7322 3a20 5b5d 2c0a   "outputs": [],.
+00005800: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00005810: 2020 2020 2020 2020 2020 2020 2273 6f75              "sou
+00005820: 7263 6522 3a20 7061 7261 6d73 5b22 736f  rce": params["so
+00005830: 7572 6365 225d 2c0a 2020 2020 2020 2020  urce"],.        
+00005840: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00005850: 7d0a 2020 2020 2020 2020 2020 2020 2020  }.              
+00005860: 2020 2020 2020 5d0a 2020 2020 2020 2020        ].        
+00005870: 2020 2020 2020 2020 7d2c 0a20 2020 2020          },.     
+00005880: 2020 2020 2020 2020 2020 2023 2074 6869             # thi
+00005890: 7264 2063 656c 6c5f 7570 6461 7465 2063  rd cell_update c
+000058a0: 6f6d 6573 2066 726f 6d20 7468 6520 6365  omes from the ce
+000058b0: 6c6c 2065 7865 6375 7469 6f6e 2066 696e  ll execution fin
+000058c0: 6973 6869 6e67 0a20 2020 2020 2020 2020  ishing.         
+000058d0: 2020 2020 2020 207b 0a20 2020 2020 2020         {.       
+000058e0: 2020 2020 2020 2020 2020 2020 2022 6365               "ce
+000058f0: 6c6c 5f75 7064 6174 6522 3a20 5b0a 2020  ll_update": [.  
+00005900: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00005910: 2020 2020 2020 7b0a 2020 2020 2020 2020        {.        
+00005920: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00005930: 2020 2020 2263 656c 6c5f 7479 7065 223a      "cell_type":
+00005940: 2022 636f 6465 222c 0a20 2020 2020 2020   "code",.       
+00005950: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00005960: 2020 2020 2022 6578 6563 7574 696f 6e5f       "execution_
+00005970: 636f 756e 7422 3a20 312c 0a20 2020 2020  count": 1,.     
+00005980: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00005990: 2020 2020 2020 2022 6d65 7461 6461 7461         "metadata
+000059a0: 223a 207b 0a20 2020 2020 2020 2020 2020  ": {.           
+000059b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000059c0: 2020 2020 2022 6a75 7079 7465 725f 6431       "jupyter_d1
+000059d0: 223a 207b 0a20 2020 2020 2020 2020 2020  ": {.           
+000059e0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000059f0: 2020 2020 2020 2020 2022 706f 7369 7469           "positi
+00005a00: 6f6e 223a 2031 2c0a 2020 2020 2020 2020  on": 1,.        
+00005a10: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00005a20: 2020 2020 2020 2020 2020 2020 2275 7569              "uui
+00005a30: 6422 3a20 6365 6c6c 5f75 7569 642c 0a20  d": cell_uuid,. 
+00005a40: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00005a50: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00005a60: 2020 2022 6e6f 7465 626f 6f6b 5f75 7569     "notebook_uui
+00005a70: 6422 3a20 7575 6964 2c0a 2020 2020 2020  d": uuid,.      
+00005a80: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00005a90: 2020 2020 2020 2020 2020 2020 2020 2265                "e
+00005aa0: 7865 6375 7469 6f6e 5f73 7461 7465 223a  xecution_state":
+00005ab0: 2022 6964 6c65 222c 0a20 2020 2020 2020   "idle",.       
+00005ac0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00005ad0: 2020 2020 2020 2020 207d 0a20 2020 2020           }.     
+00005ae0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00005af0: 2020 2020 2020 207d 2c0a 2020 2020 2020         },.      
+00005b00: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00005b10: 2020 2020 2020 226f 7574 7075 7473 223a        "outputs":
+00005b20: 205b 5d2c 0a20 2020 2020 2020 2020 2020   [],.           
+00005b30: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00005b40: 2022 736f 7572 6365 223a 2070 6172 616d   "source": param
+00005b50: 735b 2273 6f75 7263 6522 5d2c 0a20 2020  s["source"],.   
+00005b60: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00005b70: 2020 2020 207d 0a20 2020 2020 2020 2020       }.         
+00005b80: 2020 2020 2020 2020 2020 205d 0a20 2020             ].   
+00005b90: 2020 2020 2020 2020 2020 2020 207d 2c0a               },.
+00005ba0: 2020 2020 2020 2020 2020 2020 5d0a 0a20              ].. 
+00005bb0: 2020 2020 2020 2020 2020 2023 204f 7264             # Ord
+00005bc0: 6572 206f 6620 7765 6273 6f63 6b65 7420  er of websocket 
+00005bd0: 6d65 7373 6167 6573 2063 616e 2062 6520  messages can be 
+00005be0: 6120 6269 7420 7661 7269 6162 6c65 2c20  a bit variable, 
+00005bf0: 7765 206d 616b 6520 7375 7265 2074 6865  we make sure the
+00005c00: 0a20 2020 2020 2020 2020 2020 2023 206f  .            # o
+00005c10: 7264 6572 206f 6620 6365 6c6c 5f75 7064  rder of cell_upd
+00005c20: 6174 6573 2069 7320 7768 6174 2077 6520  ates is what we 
+00005c30: 6578 7065 6374 2c20 6f74 6865 7277 6973  expect, otherwis
+00005c40: 6520 7765 206a 7573 7420 6368 6563 6b20  e we just check 
+00005c50: 7468 6174 2074 6865 0a20 2020 2020 2020  that the.       
+00005c60: 2020 2020 2023 206d 6573 7361 6765 7320       # messages 
+00005c70: 7765 2065 7870 6563 7420 6361 6d65 2074  we expect came t
+00005c80: 6872 6f75 6768 2061 7420 736f 6d65 2070  hrough at some p
+00005c90: 6f69 6e74 0a20 2020 2020 2020 2020 2020  oint.           
+00005ca0: 206d 7367 7320 3d20 6177 6169 7420 636f   msgs = await co
+00005cb0: 6c6c 6563 745f 7765 6273 6f63 6b65 745f  llect_websocket_
+00005cc0: 6d65 7373 6167 6573 2877 6562 736f 636b  messages(websock
+00005cd0: 6574 2c20 6c69 6d69 743d 3629 0a0a 2020  et, limit=6)..  
+00005ce0: 2020 2020 2020 2020 2020 6365 6c6c 5f75            cell_u
+00005cf0: 7064 6174 6573 203d 2066 696c 7465 725f  pdates = filter_
+00005d00: 7765 6273 6f63 6b65 745f 636f 6c6c 6563  websocket_collec
+00005d10: 7469 6f6e 286d 7367 732c 2022 6365 6c6c  tion(msgs, "cell
+00005d20: 5f75 7064 6174 6522 290a 2020 2020 2020  _update").      
+00005d30: 2020 2020 2020 6173 7365 7274 206c 656e        assert len
+00005d40: 2863 656c 6c5f 7570 6461 7465 7329 203d  (cell_updates) =
+00005d50: 3d20 330a 2020 2020 2020 2020 2020 2020  = 3.            
+00005d60: 6173 7365 7274 2063 656c 6c5f 7570 6461  assert cell_upda
+00005d70: 7465 735b 305d 203d 3d20 6578 7065 6374  tes[0] == expect
+00005d80: 6564 5b30 5d0a 2020 2020 2020 2020 2020  ed[0].          
+00005d90: 2020 6173 7365 7274 2063 656c 6c5f 7570    assert cell_up
+00005da0: 6461 7465 735b 315d 203d 3d20 6578 7065  dates[1] == expe
+00005db0: 6374 6564 5b31 5d0a 2020 2020 2020 2020  cted[1].        
+00005dc0: 2020 2020 6173 7365 7274 2063 656c 6c5f      assert cell_
+00005dd0: 7570 6461 7465 735b 325d 203d 3d20 6578  updates[2] == ex
+00005de0: 7065 6374 6564 5b32 5d0a 0a20 2020 2020  pected[2]..     
+00005df0: 2020 2020 2020 2065 7865 635f 7265 7175         exec_requ
+00005e00: 6573 7473 203d 2066 696c 7465 725f 7765  ests = filter_we
+00005e10: 6273 6f63 6b65 745f 636f 6c6c 6563 7469  bsocket_collecti
+00005e20: 6f6e 280a 2020 2020 2020 2020 2020 2020  on(.            
+00005e30: 2020 2020 6d73 6773 2c20 2263 656c 6c5f      msgs, "cell_
+00005e40: 6578 6563 7574 696f 6e5f 7265 7175 6573  execution_reques
+00005e50: 7422 0a20 2020 2020 2020 2020 2020 2029  t".            )
+00005e60: 0a20 2020 2020 2020 2020 2020 2061 7373  .            ass
+00005e70: 6572 7420 6c65 6e28 6578 6563 5f72 6571  ert len(exec_req
+00005e80: 7565 7374 7329 203d 3d20 310a 2020 2020  uests) == 1.    
+00005e90: 2020 2020 2020 2020 6578 6563 5f72 6571          exec_req
+00005ea0: 7565 7374 203d 2065 7865 635f 7265 7175  uest = exec_requ
+00005eb0: 6573 7473 5b30 5d0a 2020 2020 2020 2020  ests[0].        
+00005ec0: 2020 2020 6173 7365 7274 2028 0a20 2020      assert (.   
+00005ed0: 2020 2020 2020 2020 2020 2020 2065 7865               exe
+00005ee0: 635f 7265 7175 6573 745b 2263 656c 6c5f  c_request["cell_
+00005ef0: 6578 6563 7574 696f 6e5f 7265 7175 6573  execution_reques
+00005f00: 7422 5d5b 2263 656c 6c5f 6964 225d 203d  t"]["cell_id"] =
+00005f10: 3d20 6365 6c6c 5f75 7569 640a 2020 2020  = cell_uuid.    
+00005f20: 2020 2020 2020 2020 290a 2020 2020 2020          ).      
+00005f30: 2020 2020 2020 6173 7365 7274 2028 0a20        assert (. 
+00005f40: 2020 2020 2020 2020 2020 2020 2020 2065                 e
+00005f50: 7865 635f 7265 7175 6573 745b 2263 656c  xec_request["cel
+00005f60: 6c5f 6578 6563 7574 696f 6e5f 7265 7175  l_execution_requ
+00005f70: 6573 7422 5d5b 226d 6573 7361 6765 5f69  est"]["message_i
+00005f80: 6422 5d20 3d3d 206d 7367 5f69 640a 2020  d"] == msg_id.  
+00005f90: 2020 2020 2020 2020 2020 290a 0a20 2020            )..   
+00005fa0: 2020 2020 2020 2020 2065 7865 635f 696e           exec_in
+00005fb0: 7075 7473 203d 2066 696c 7465 725f 7765  puts = filter_we
+00005fc0: 6273 6f63 6b65 745f 636f 6c6c 6563 7469  bsocket_collecti
+00005fd0: 6f6e 280a 2020 2020 2020 2020 2020 2020  on(.            
+00005fe0: 2020 2020 6d73 6773 2c20 2263 656c 6c5f      msgs, "cell_
+00005ff0: 6578 6563 7574 696f 6e5f 696e 7075 7422  execution_input"
+00006000: 0a20 2020 2020 2020 2020 2020 2029 0a20  .            ). 
+00006010: 2020 2020 2020 2020 2020 2061 7373 6572             asser
+00006020: 7420 6c65 6e28 6578 6563 5f69 6e70 7574  t len(exec_input
+00006030: 7329 203d 3d20 310a 2020 2020 2020 2020  s) == 1.        
+00006040: 2020 2020 6578 6563 5f69 6e70 7574 203d      exec_input =
+00006050: 2065 7865 635f 696e 7075 7473 5b30 5d0a   exec_inputs[0].
+00006060: 2020 2020 2020 2020 2020 2020 6173 7365              asse
+00006070: 7274 2065 7865 635f 696e 7075 745b 2263  rt exec_input["c
+00006080: 656c 6c5f 6578 6563 7574 696f 6e5f 696e  ell_execution_in
+00006090: 7075 7422 5d5b 2270 6172 656e 745f 6964  put"]["parent_id
+000060a0: 225d 203d 3d20 6d73 675f 6964 0a20 2020  "] == msg_id.   
+000060b0: 2020 2020 2020 2020 2061 7373 6572 7420           assert 
+000060c0: 280a 2020 2020 2020 2020 2020 2020 2020  (.              
+000060d0: 2020 6578 6563 5f69 6e70 7574 5b22 6365    exec_input["ce
+000060e0: 6c6c 5f65 7865 6375 7469 6f6e 5f69 6e70  ll_execution_inp
+000060f0: 7574 225d 5b22 636f 6e74 656e 7422 5d5b  ut"]["content"][
+00006100: 2263 6f64 6522 5d0a 2020 2020 2020 2020  "code"].        
+00006110: 2020 2020 2020 2020 3d3d 2070 6172 616d          == param
+00006120: 735b 2273 6f75 7263 6522 5d0a 2020 2020  s["source"].    
+00006130: 2020 2020 2020 2020 290a 2020 2020 2020          ).      
+00006140: 2020 2020 2020 6173 7365 7274 2028 0a20        assert (. 
+00006150: 2020 2020 2020 2020 2020 2020 2020 2065                 e
+00006160: 7865 635f 696e 7075 745b 2263 656c 6c5f  xec_input["cell_
+00006170: 6578 6563 7574 696f 6e5f 696e 7075 7422  execution_input"
+00006180: 5d5b 2263 6f6e 7465 6e74 225d 5b0a 2020  ]["content"][.  
+00006190: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000061a0: 2020 2265 7865 6375 7469 6f6e 5f63 6f75    "execution_cou
+000061b0: 6e74 220a 2020 2020 2020 2020 2020 2020  nt".            
+000061c0: 2020 2020 5d0a 2020 2020 2020 2020 2020      ].          
+000061d0: 2020 2020 2020 3d3d 2031 0a20 2020 2020        == 1.     
+000061e0: 2020 2020 2020 2029 0a0a 2020 2020 2020         )..      
+000061f0: 2020 2020 2020 6578 6563 5f72 6570 6c69        exec_repli
+00006200: 6573 203d 2066 696c 7465 725f 7765 6273  es = filter_webs
+00006210: 6f63 6b65 745f 636f 6c6c 6563 7469 6f6e  ocket_collection
+00006220: 280a 2020 2020 2020 2020 2020 2020 2020  (.              
+00006230: 2020 6d73 6773 2c20 2263 656c 6c5f 6578    msgs, "cell_ex
+00006240: 6563 7574 696f 6e5f 7265 706c 7922 0a20  ecution_reply". 
+00006250: 2020 2020 2020 2020 2020 2029 0a20 2020             ).   
+00006260: 2020 2020 2020 2020 2061 7373 6572 7420           assert 
+00006270: 6c65 6e28 6578 6563 5f72 6570 6c69 6573  len(exec_replies
+00006280: 2920 3d3d 2031 0a20 2020 2020 2020 2020  ) == 1.         
+00006290: 2020 2065 7865 635f 7265 706c 7920 3d20     exec_reply = 
+000062a0: 6578 6563 5f72 6570 6c69 6573 5b30 5d0a  exec_replies[0].
+000062b0: 2020 2020 2020 2020 2020 2020 6173 7365              asse
+000062c0: 7274 2065 7865 635f 7265 706c 795b 2263  rt exec_reply["c
+000062d0: 656c 6c5f 6578 6563 7574 696f 6e5f 7265  ell_execution_re
+000062e0: 706c 7922 5d5b 2263 656c 6c5f 6964 225d  ply"]["cell_id"]
+000062f0: 203d 3d20 6365 6c6c 5f75 7569 640a 2020   == cell_uuid.  
+00006300: 2020 2020 2020 2020 2020 6173 7365 7274            assert
+00006310: 2065 7865 635f 7265 706c 795b 2263 656c   exec_reply["cel
+00006320: 6c5f 6578 6563 7574 696f 6e5f 7265 706c  l_execution_repl
+00006330: 7922 5d5b 2270 6172 656e 745f 6964 225d  y"]["parent_id"]
+00006340: 203d 3d20 6d73 675f 6964 0a20 2020 2020   == msg_id.     
+00006350: 2020 2020 2020 2061 7373 6572 7420 6578         assert ex
+00006360: 6563 5f72 6570 6c79 5b22 6365 6c6c 5f65  ec_reply["cell_e
+00006370: 7865 6375 7469 6f6e 5f72 6570 6c79 225d  xecution_reply"]
+00006380: 5b22 6578 6563 7574 696f 6e5f 636f 756e  ["execution_coun
+00006390: 7422 5d20 3d3d 2031 0a0a 2020 2020 2020  t"] == 1..      
+000063a0: 2020 2020 2020 2320 4174 2074 6865 2065        # At the e
+000063b0: 6e64 2077 6520 6578 7065 6374 2061 2076  nd we expect a v
+000063c0: 6172 7320 7570 6461 7465 0a20 2020 2020  ars update.     
+000063d0: 2020 2020 2020 206d 6f72 655f 6d73 6773         more_msgs
+000063e0: 203d 2061 7761 6974 2063 6f6c 6c65 6374   = await collect
+000063f0: 5f77 6562 736f 636b 6574 5f6d 6573 7361  _websocket_messa
+00006400: 6765 7328 7765 6273 6f63 6b65 7429 0a20  ges(websocket). 
+00006410: 2020 2020 2020 2020 2020 2061 7373 6572             asser
+00006420: 7420 6c65 6e28 6d6f 7265 5f6d 7367 7329  t len(more_msgs)
+00006430: 203d 3d20 310a 2020 2020 2020 2020 2020   == 1.          
+00006440: 2020 6173 7365 7274 2022 7661 7273 2220    assert "vars" 
+00006450: 696e 206d 6f72 655f 6d73 6773 5b30 5d0a  in more_msgs[0].
+00006460: 0a20 2020 2040 7079 7465 7374 2e6d 6172  .    @pytest.mar
+00006470: 6b2e 6173 796e 6369 6f0a 2020 2020 6173  k.asyncio.    as
+00006480: 796e 6320 6465 6620 7465 7374 5f6e 6f74  ync def test_not
+00006490: 6562 6f6f 6b5f 6365 6c6c 5f61 6464 280a  ebook_cell_add(.
+000064a0: 2020 2020 2020 2020 7365 6c66 2c20 636c          self, cl
+000064b0: 6965 6e74 3a20 5465 7374 436c 6965 6e74  ient: TestClient
+000064c0: 2c20 7375 7065 7275 7365 725f 746f 6b65  , superuser_toke
+000064d0: 6e5f 6865 6164 6572 733a 2044 6963 745b  n_headers: Dict[
+000064e0: 7374 722c 2073 7472 5d0a 2020 2020 293a  str, str].    ):
+000064f0: 0a20 2020 2020 2020 2075 7569 6420 3d20  .        uuid = 
+00006500: 6177 6169 7420 7570 6c6f 6164 5f6e 6f74  await upload_not
+00006510: 6562 6f6f 6b28 636c 6965 6e74 2c20 7375  ebook(client, su
+00006520: 7065 7275 7365 725f 746f 6b65 6e5f 6865  peruser_token_he
+00006530: 6164 6572 7329 0a0a 2020 2020 2020 2020  aders)..        
+00006540: 6173 796e 6320 7769 7468 2063 6c69 656e  async with clien
+00006550: 742e 7765 6273 6f63 6b65 745f 636f 6e6e  t.websocket_conn
+00006560: 6563 7428 0a20 2020 2020 2020 2020 2020  ect(.           
+00006570: 2066 222f 6e6f 7465 626f 6f6b 732f 7b75   f"/notebooks/{u
+00006580: 7569 647d 2f77 732f 6e6f 7465 626f 6f6b  uid}/ws/notebook
+00006590: 222c 2068 6561 6465 7273 3d73 7570 6572  ", headers=super
+000065a0: 7573 6572 5f74 6f6b 656e 5f68 6561 6465  user_token_heade
+000065b0: 7273 0a20 2020 2020 2020 2029 2061 7320  rs.        ) as 
+000065c0: 7765 6273 6f63 6b65 743a 0a20 2020 2020  websocket:.     
+000065d0: 2020 2020 2020 2061 7761 6974 2061 7379         await asy
+000065e0: 6e63 696f 2e73 6c65 6570 2857 4542 534f  ncio.sleep(WEBSO
+000065f0: 434b 4554 5f53 4c45 4550 5f54 494d 4529  CKET_SLEEP_TIME)
+00006600: 0a20 2020 2020 2020 2020 2020 2070 6172  .            par
+00006610: 616d 7320 3d20 7b0a 2020 2020 2020 2020  ams = {.        
+00006620: 2020 2020 2020 2020 2263 656c 6c5f 7479          "cell_ty
+00006630: 7065 223a 2022 6d61 726b 646f 776e 222c  pe": "markdown",
+00006640: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00006650: 2022 736f 7572 6365 223a 2022 5f5f 2a2a   "source": "__**
+00006660: 4865 6c6c 6f20 4361 6c6c 6973 746f 212a  Hello Callisto!*
+00006670: 2a5f 5f22 2c0a 2020 2020 2020 2020 2020  *__",.          
+00006680: 2020 7d0a 2020 2020 2020 2020 2020 2020    }.            
+00006690: 7265 7370 6f6e 7365 203d 2061 7761 6974  response = await
+000066a0: 2063 6c69 656e 742e 706f 7374 280a 2020   client.post(.  
+000066b0: 2020 2020 2020 2020 2020 2020 2020 6622                f"
+000066c0: 2f6e 6f74 6562 6f6f 6b73 2f7b 7575 6964  /notebooks/{uuid
+000066d0: 7d2f 6365 6c6c 7322 2c0a 2020 2020 2020  }/cells",.      
+000066e0: 2020 2020 2020 2020 2020 6a73 6f6e 3d70            json=p
+000066f0: 6172 616d 732c 0a20 2020 2020 2020 2020  arams,.         
+00006700: 2020 2020 2020 2068 6561 6465 7273 3d73         headers=s
+00006710: 7570 6572 7573 6572 5f74 6f6b 656e 5f68  uperuser_token_h
+00006720: 6561 6465 7273 2c0a 2020 2020 2020 2020  eaders,.        
+00006730: 2020 2020 290a 2020 2020 2020 2020 2020      ).          
+00006740: 2020 6173 7365 7274 2072 6573 706f 6e73    assert respons
+00006750: 652e 7374 6174 7573 5f63 6f64 6520 3d3d  e.status_code ==
+00006760: 2032 3031 0a0a 2020 2020 2020 2020 2020   201..          
+00006770: 2020 6461 7461 203d 2061 7761 6974 2072    data = await r
+00006780: 6563 6569 7665 5f6a 736f 6e28 7765 6273  eceive_json(webs
+00006790: 6f63 6b65 742c 206d 7367 5f74 7970 6573  ocket, msg_types
+000067a0: 3d5b 2263 656c 6c5f 6164 6422 5d29 0a20  =["cell_add"]). 
+000067b0: 2020 2020 2020 2020 2020 2063 656c 6c73             cells
+000067c0: 203d 2064 6174 615b 2263 656c 6c5f 6164   = data["cell_ad
+000067d0: 6422 5d0a 2020 2020 2020 2020 2020 2020  d"].            
+000067e0: 6173 7365 7274 206c 656e 2863 656c 6c73  assert len(cells
+000067f0: 2920 3d3d 2035 2020 2320 7368 6f75 6c64  ) == 5  # should
+00006800: 2064 756d 7020 616c 6c20 7468 6520 6365   dump all the ce
+00006810: 6c6c 730a 2020 2020 2020 2020 2020 2020  lls.            
+00006820: 6365 6c6c 203d 2063 656c 6c73 5b2d 315d  cell = cells[-1]
+00006830: 0a20 2020 2020 2020 2020 2020 2063 656c  .            cel
+00006840: 6c5f 7575 6964 203d 2063 656c 6c5b 226d  l_uuid = cell["m
+00006850: 6574 6164 6174 6122 5d5b 226a 7570 7974  etadata"]["jupyt
+00006860: 6572 5f64 3122 5d5b 2275 7569 6422 5d0a  er_d1"]["uuid"].
+00006870: 0a20 2020 2020 2020 2020 2020 2065 7870  .            exp
+00006880: 6563 7465 6420 3d20 7b0a 2020 2020 2020  ected = {.      
+00006890: 2020 2020 2020 2020 2020 2263 656c 6c5f            "cell_
+000068a0: 7479 7065 223a 2022 6d61 726b 646f 776e  type": "markdown
+000068b0: 222c 0a20 2020 2020 2020 2020 2020 2020  ",.             
+000068c0: 2020 2022 6d65 7461 6461 7461 223a 207b     "metadata": {
+000068d0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+000068e0: 2020 2020 2022 6a75 7079 7465 725f 6431       "jupyter_d1
+000068f0: 223a 207b 0a20 2020 2020 2020 2020 2020  ": {.           
+00006900: 2020 2020 2020 2020 2020 2020 2022 706f               "po
+00006910: 7369 7469 6f6e 223a 2034 2c0a 2020 2020  sition": 4,.    
+00006920: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00006930: 2020 2020 2275 7569 6422 3a20 6365 6c6c      "uuid": cell
+00006940: 5f75 7569 642c 0a20 2020 2020 2020 2020  _uuid,.         
+00006950: 2020 2020 2020 2020 2020 2020 2020 2022                 "
+00006960: 6e6f 7465 626f 6f6b 5f75 7569 6422 3a20  notebook_uuid": 
+00006970: 7575 6964 2c0a 2020 2020 2020 2020 2020  uuid,.          
+00006980: 2020 2020 2020 2020 2020 7d0a 2020 2020            }.    
+00006990: 2020 2020 2020 2020 2020 2020 7d2c 0a20              },. 
+000069a0: 2020 2020 2020 2020 2020 2020 2020 2022                 "
+000069b0: 736f 7572 6365 223a 2022 5f5f 2a2a 4865  source": "__**He
+000069c0: 6c6c 6f20 4361 6c6c 6973 746f 212a 2a5f  llo Callisto!**_
+000069d0: 5f22 2c0a 2020 2020 2020 2020 2020 2020  _",.            
+000069e0: 7d0a 0a20 2020 2020 2020 2020 2020 2023  }..            #
+000069f0: 2066 726f 6d20 7070 7269 6e74 2069 6d70   from pprint imp
+00006a00: 6f72 7420 7070 7269 6e74 0a20 2020 2020  ort pprint.     
+00006a10: 2020 2020 2020 2023 2070 7269 6e74 2822         # print("
+00006a20: 6461 7461 2229 0a20 2020 2020 2020 2020  data").         
+00006a30: 2020 2023 2070 7072 696e 7428 6461 7461     # pprint(data
+00006a40: 290a 2020 2020 2020 2020 2020 2020 2320  ).            # 
+00006a50: 7072 696e 7428 2265 7870 6563 7465 6422  print("expected"
+00006a60: 290a 2020 2020 2020 2020 2020 2020 2320  ).            # 
+00006a70: 7070 7269 6e74 2865 7870 6563 7465 6429  pprint(expected)
+00006a80: 0a20 2020 2020 2020 2020 2020 2063 6f6d  .            com
+00006a90: 7061 7265 5f63 656c 6c73 2863 656c 6c2c  pare_cells(cell,
+00006aa0: 2065 7870 6563 7465 6429 0a0a 2020 2020   expected)..    
+00006ab0: 4070 7974 6573 742e 6d61 726b 2e61 7379  @pytest.mark.asy
+00006ac0: 6e63 696f 0a20 2020 2061 7379 6e63 2064  ncio.    async d
+00006ad0: 6566 2074 6573 745f 6e6f 7465 626f 6f6b  ef test_notebook
+00006ae0: 5f63 656c 6c5f 7061 7463 6828 0a20 2020  _cell_patch(.   
+00006af0: 2020 2020 2073 656c 662c 2063 6c69 656e       self, clien
+00006b00: 743a 2054 6573 7443 6c69 656e 742c 2073  t: TestClient, s
+00006b10: 7570 6572 7573 6572 5f74 6f6b 656e 5f68  uperuser_token_h
+00006b20: 6561 6465 7273 3a20 4469 6374 5b73 7472  eaders: Dict[str
+00006b30: 2c20 7374 725d 0a20 2020 2029 3a0a 2020  , str].    ):.  
+00006b40: 2020 2020 2020 7575 6964 203d 2061 7761        uuid = awa
+00006b50: 6974 2075 706c 6f61 645f 6e6f 7465 626f  it upload_notebo
+00006b60: 6f6b 2863 6c69 656e 742c 2073 7570 6572  ok(client, super
+00006b70: 7573 6572 5f74 6f6b 656e 5f68 6561 6465  user_token_heade
+00006b80: 7273 290a 0a20 2020 2020 2020 2061 7379  rs)..        asy
+00006b90: 6e63 2077 6974 6820 636c 6965 6e74 2e77  nc with client.w
+00006ba0: 6562 736f 636b 6574 5f63 6f6e 6e65 6374  ebsocket_connect
+00006bb0: 280a 2020 2020 2020 2020 2020 2020 6622  (.            f"
+00006bc0: 2f6e 6f74 6562 6f6f 6b73 2f7b 7575 6964  /notebooks/{uuid
+00006bd0: 7d2f 7773 2f6e 6f74 6562 6f6f 6b22 2c20  }/ws/notebook", 
+00006be0: 6865 6164 6572 733d 7375 7065 7275 7365  headers=superuse
+00006bf0: 725f 746f 6b65 6e5f 6865 6164 6572 730a  r_token_headers.
+00006c00: 2020 2020 2020 2020 2920 6173 2077 6562          ) as web
+00006c10: 736f 636b 6574 3a0a 2020 2020 2020 2020  socket:.        
+00006c20: 2020 2020 6177 6169 7420 6173 796e 6369      await asynci
+00006c30: 6f2e 736c 6565 7028 5745 4253 4f43 4b45  o.sleep(WEBSOCKE
+00006c40: 545f 534c 4545 505f 5449 4d45 290a 0a20  T_SLEEP_TIME).. 
+00006c50: 2020 2020 2020 2020 2020 2023 2067 6574             # get
+00006c60: 2061 6e20 6578 6973 7469 6e67 2063 656c   an existing cel
+00006c70: 6c0a 2020 2020 2020 2020 2020 2020 7265  l.            re
+00006c80: 7370 6f6e 7365 203d 2061 7761 6974 2063  sponse = await c
+00006c90: 6c69 656e 742e 6765 7428 0a20 2020 2020  lient.get(.     
+00006ca0: 2020 2020 2020 2020 2020 2066 222f 6e6f             f"/no
+00006cb0: 7465 626f 6f6b 732f 7b75 7569 647d 2f63  tebooks/{uuid}/c
+00006cc0: 656c 6c73 222c 2068 6561 6465 7273 3d73  ells", headers=s
+00006cd0: 7570 6572 7573 6572 5f74 6f6b 656e 5f68  uperuser_token_h
+00006ce0: 6561 6465 7273 0a20 2020 2020 2020 2020  eaders.         
+00006cf0: 2020 2029 0a20 2020 2020 2020 2020 2020     ).           
+00006d00: 2061 7373 6572 7420 7265 7370 6f6e 7365   assert response
+00006d10: 2e73 7461 7475 735f 636f 6465 203d 3d20  .status_code == 
+00006d20: 3230 300a 2020 2020 2020 2020 2020 2020  200.            
+00006d30: 6365 6c6c 7320 3d20 7265 7370 6f6e 7365  cells = response
+00006d40: 2e6a 736f 6e28 295b 2263 656c 6c73 225d  .json()["cells"]
+00006d50: 0a20 2020 2020 2020 2020 2020 2061 7373  .            ass
+00006d60: 6572 7420 6365 6c6c 735b 315d 5b22 736f  ert cells[1]["so
+00006d70: 7572 6365 225d 203d 3d20 2770 7269 6e74  urce"] == 'print
+00006d80: 2822 4c61 7272 7920 7468 6520 4c6c 616d  ("Larry the Llam
+00006d90: 6122 2927 0a0a 2020 2020 2020 2020 2020  a")'..          
+00006da0: 2020 6365 6c6c 5f75 7569 6420 3d20 6365    cell_uuid = ce
+00006db0: 6c6c 735b 315d 5b22 6d65 7461 6461 7461  lls[1]["metadata
+00006dc0: 225d 5b22 6a75 7079 7465 725f 6431 225d  "]["jupyter_d1"]
+00006dd0: 5b22 7575 6964 225d 0a20 2020 2020 2020  ["uuid"].       
+00006de0: 2020 2020 2070 6172 616d 7320 3d20 7b22       params = {"
+00006df0: 736f 7572 6365 223a 2022 5f5f 4261 6e61  source": "__Bana
+00006e00: 6e61 2052 616d 6121 5f5f 227d 0a20 2020  na Rama!__"}.   
+00006e10: 2020 2020 2020 2020 2072 6573 706f 6e73           respons
+00006e20: 6520 3d20 6177 6169 7420 636c 6965 6e74  e = await client
+00006e30: 2e70 6174 6368 280a 2020 2020 2020 2020  .patch(.        
+00006e40: 2020 2020 2020 2020 6622 2f6e 6f74 6562          f"/noteb
+00006e50: 6f6f 6b73 2f7b 7575 6964 7d2f 6365 6c6c  ooks/{uuid}/cell
+00006e60: 732f 7b63 656c 6c5f 7575 6964 7d22 2c0a  s/{cell_uuid}",.
+00006e70: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00006e80: 6a73 6f6e 3d70 6172 616d 732c 0a20 2020  json=params,.   
+00006e90: 2020 2020 2020 2020 2020 2020 2068 6561               hea
+00006ea0: 6465 7273 3d73 7570 6572 7573 6572 5f74  ders=superuser_t
+00006eb0: 6f6b 656e 5f68 6561 6465 7273 2c0a 2020  oken_headers,.  
+00006ec0: 2020 2020 2020 2020 2020 290a 2020 2020            ).    
+00006ed0: 2020 2020 2020 2020 6173 7365 7274 2072          assert r
+00006ee0: 6573 706f 6e73 652e 7374 6174 7573 5f63  esponse.status_c
+00006ef0: 6f64 6520 3d3d 2032 3030 0a0a 2020 2020  ode == 200..    
+00006f00: 2020 2020 2020 2020 6461 7461 203d 2061          data = a
+00006f10: 7761 6974 2072 6563 6569 7665 5f6a 736f  wait receive_jso
+00006f20: 6e28 7765 6273 6f63 6b65 7429 0a20 2020  n(websocket).   
+00006f30: 2020 2020 2020 2020 2063 656c 6c73 203d           cells =
+00006f40: 2064 6174 615b 2263 656c 6c5f 7570 6461   data["cell_upda
+00006f50: 7465 225d 0a20 2020 2020 2020 2020 2020  te"].           
+00006f60: 2061 7373 6572 7420 6c65 6e28 6365 6c6c   assert len(cell
+00006f70: 7329 203d 3d20 310a 2020 2020 2020 2020  s) == 1.        
+00006f80: 2020 2020 6365 6c6c 203d 2063 656c 6c73      cell = cells
+00006f90: 5b30 5d0a 0a20 2020 2020 2020 2020 2020  [0]..           
+00006fa0: 2065 7870 6563 7465 6420 3d20 7b0a 2020   expected = {.  
+00006fb0: 2020 2020 2020 2020 2020 2020 2020 2263                "c
+00006fc0: 656c 6c5f 7479 7065 223a 2022 636f 6465  ell_type": "code
+00006fd0: 222c 0a20 2020 2020 2020 2020 2020 2020  ",.             
+00006fe0: 2020 2022 6578 6563 7574 696f 6e5f 636f     "execution_co
+00006ff0: 756e 7422 3a20 4e6f 6e65 2c0a 2020 2020  unt": None,.    
+00007000: 2020 2020 2020 2020 2020 2020 226d 6574              "met
+00007010: 6164 6174 6122 3a20 7b0a 2020 2020 2020  adata": {.      
+00007020: 2020 2020 2020 2020 2020 2020 2020 226a                "j
+00007030: 7570 7974 6572 5f64 3122 3a20 7b0a 2020  upyter_d1": {.  
+00007040: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00007050: 2020 2020 2020 2265 7865 6375 7469 6f6e        "execution
+00007060: 5f73 7461 7465 223a 2022 6964 6c65 222c  _state": "idle",
+00007070: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00007080: 2020 2020 2020 2020 2022 706f 7369 7469           "positi
+00007090: 6f6e 223a 2031 2c0a 2020 2020 2020 2020  on": 1,.        
+000070a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000070b0: 226e 6f74 6562 6f6f 6b5f 7575 6964 223a  "notebook_uuid":
+000070c0: 2075 7569 642c 0a20 2020 2020 2020 2020   uuid,.         
+000070d0: 2020 2020 2020 2020 2020 2020 2020 2022                 "
+000070e0: 7575 6964 223a 2063 656c 6c5f 7575 6964  uuid": cell_uuid
+000070f0: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
+00007100: 2020 2020 2020 7d0a 2020 2020 2020 2020        }.        
+00007110: 2020 2020 2020 2020 7d2c 0a20 2020 2020          },.     
+00007120: 2020 2020 2020 2020 2020 2022 6f75 7470             "outp
+00007130: 7574 7322 3a20 5b0a 2020 2020 2020 2020  uts": [.        
+00007140: 2020 2020 2020 2020 2020 2020 7b0a 2020              {.  
+00007150: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00007160: 2020 2020 2020 226e 616d 6522 3a20 2273        "name": "s
+00007170: 7464 6f75 7422 2c0a 2020 2020 2020 2020  tdout",.        
+00007180: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00007190: 226f 7574 7075 745f 7479 7065 223a 2022  "output_type": "
+000071a0: 7374 7265 616d 222c 0a20 2020 2020 2020  stream",.       
+000071b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000071c0: 2022 7465 7874 223a 2022 4c61 7272 7920   "text": "Larry 
+000071d0: 7468 6520 4c6c 616d 615c 6e22 2c0a 2020  the Llama\n",.  
+000071e0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000071f0: 2020 7d0a 2020 2020 2020 2020 2020 2020    }.            
+00007200: 2020 2020 5d2c 0a20 2020 2020 2020 2020      ],.         
+00007210: 2020 2020 2020 2022 736f 7572 6365 223a         "source":
+00007220: 2022 5f5f 4261 6e61 6e61 2052 616d 6121   "__Banana Rama!
+00007230: 5f5f 222c 0a20 2020 2020 2020 2020 2020  __",.           
+00007240: 207d 0a0a 2020 2020 2020 2020 2020 2020   }..            
+00007250: 6173 7365 7274 2063 656c 6c20 3d3d 2065  assert cell == e
+00007260: 7870 6563 7465 640a 0a20 2020 2040 7079  xpected..    @py
+00007270: 7465 7374 2e6d 6172 6b2e 6173 796e 6369  test.mark.asynci
+00007280: 6f0a 2020 2020 6173 796e 6320 6465 6620  o.    async def 
+00007290: 7465 7374 5f6e 6f74 6562 6f6f 6b5f 6365  test_notebook_ce
+000072a0: 6c6c 5f64 656c 6574 6528 0a20 2020 2020  ll_delete(.     
+000072b0: 2020 2073 656c 662c 2063 6c69 656e 743a     self, client:
+000072c0: 2054 6573 7443 6c69 656e 742c 2073 7570   TestClient, sup
+000072d0: 6572 7573 6572 5f74 6f6b 656e 5f68 6561  eruser_token_hea
+000072e0: 6465 7273 3a20 4469 6374 5b73 7472 2c20  ders: Dict[str, 
+000072f0: 7374 725d 0a20 2020 2029 3a0a 2020 2020  str].    ):.    
+00007300: 2020 2020 7575 6964 203d 2061 7761 6974      uuid = await
+00007310: 2075 706c 6f61 645f 6e6f 7465 626f 6f6b   upload_notebook
+00007320: 2863 6c69 656e 742c 2073 7570 6572 7573  (client, superus
+00007330: 6572 5f74 6f6b 656e 5f68 6561 6465 7273  er_token_headers
+00007340: 290a 0a20 2020 2020 2020 2072 6573 706f  )..        respo
+00007350: 6e73 6520 3d20 6177 6169 7420 636c 6965  nse = await clie
+00007360: 6e74 2e67 6574 280a 2020 2020 2020 2020  nt.get(.        
+00007370: 2020 2020 6622 2f6e 6f74 6562 6f6f 6b73      f"/notebooks
+00007380: 2f7b 7575 6964 7d2f 6365 6c6c 7322 2c20  /{uuid}/cells", 
+00007390: 6865 6164 6572 733d 7375 7065 7275 7365  headers=superuse
+000073a0: 725f 746f 6b65 6e5f 6865 6164 6572 730a  r_token_headers.
+000073b0: 2020 2020 2020 2020 290a 2020 2020 2020          ).      
+000073c0: 2020 6173 7365 7274 2072 6573 706f 6e73    assert respons
+000073d0: 652e 7374 6174 7573 5f63 6f64 6520 3d3d  e.status_code ==
+000073e0: 2032 3030 0a20 2020 2020 2020 2063 656c   200.        cel
+000073f0: 6c73 203d 2072 6573 706f 6e73 652e 6a73  ls = response.js
+00007400: 6f6e 2829 5b22 6365 6c6c 7322 5d0a 0a20  on()["cells"].. 
+00007410: 2020 2020 2020 2063 656c 6c20 3d20 6365         cell = ce
+00007420: 6c6c 735b 325d 0a20 2020 2020 2020 2063  lls[2].        c
+00007430: 656c 6c5f 7575 6964 203d 2063 656c 6c5b  ell_uuid = cell[
+00007440: 226d 6574 6164 6174 6122 5d5b 226a 7570  "metadata"]["jup
+00007450: 7974 6572 5f64 3122 5d5b 2275 7569 6422  yter_d1"]["uuid"
+00007460: 5d0a 0a20 2020 2020 2020 2061 7373 6572  ]..        asser
+00007470: 7420 6365 6c6c 735b 335d 5b22 6d65 7461  t cells[3]["meta
+00007480: 6461 7461 225d 5b22 6a75 7079 7465 725f  data"]["jupyter_
+00007490: 6431 225d 5b22 706f 7369 7469 6f6e 225d  d1"]["position"]
+000074a0: 203d 3d20 330a 0a20 2020 2020 2020 2061   == 3..        a
+000074b0: 7379 6e63 2077 6974 6820 636c 6965 6e74  sync with client
+000074c0: 2e77 6562 736f 636b 6574 5f63 6f6e 6e65  .websocket_conne
+000074d0: 6374 280a 2020 2020 2020 2020 2020 2020  ct(.            
+000074e0: 6622 2f6e 6f74 6562 6f6f 6b73 2f7b 7575  f"/notebooks/{uu
+000074f0: 6964 7d2f 7773 2f6e 6f74 6562 6f6f 6b22  id}/ws/notebook"
+00007500: 2c20 6865 6164 6572 733d 7375 7065 7275  , headers=superu
+00007510: 7365 725f 746f 6b65 6e5f 6865 6164 6572  ser_token_header
+00007520: 730a 2020 2020 2020 2020 2920 6173 2077  s.        ) as w
+00007530: 6562 736f 636b 6574 3a0a 2020 2020 2020  ebsocket:.      
+00007540: 2020 2020 2020 6177 6169 7420 6173 796e        await asyn
+00007550: 6369 6f2e 736c 6565 7028 5745 4253 4f43  cio.sleep(WEBSOC
+00007560: 4b45 545f 534c 4545 505f 5449 4d45 290a  KET_SLEEP_TIME).
+00007570: 0a20 2020 2020 2020 2020 2020 2072 6573  .            res
+00007580: 706f 6e73 6520 3d20 6177 6169 7420 636c  ponse = await cl
+00007590: 6965 6e74 2e64 656c 6574 6528 0a20 2020  ient.delete(.   
+000075a0: 2020 2020 2020 2020 2020 2020 2066 222f               f"/
+000075b0: 6e6f 7465 626f 6f6b 732f 7b75 7569 647d  notebooks/{uuid}
+000075c0: 2f63 656c 6c73 2f7b 6365 6c6c 5f75 7569  /cells/{cell_uui
+000075d0: 647d 222c 0a20 2020 2020 2020 2020 2020  d}",.           
+000075e0: 2020 2020 2068 6561 6465 7273 3d73 7570       headers=sup
+000075f0: 6572 7573 6572 5f74 6f6b 656e 5f68 6561  eruser_token_hea
+00007600: 6465 7273 2c0a 2020 2020 2020 2020 2020  ders,.          
+00007610: 2020 290a 2020 2020 2020 2020 2020 2020    ).            
+00007620: 6173 7365 7274 2072 6573 706f 6e73 652e  assert response.
+00007630: 7374 6174 7573 5f63 6f64 6520 3d3d 2032  status_code == 2
+00007640: 3034 0a0a 2020 2020 2020 2020 2020 2020  04..            
+00007650: 6461 7461 203d 2061 7761 6974 2072 6563  data = await rec
+00007660: 6569 7665 5f6a 736f 6e28 7765 6273 6f63  eive_json(websoc
+00007670: 6b65 7429 0a0a 2020 2020 2020 2020 2020  ket)..          
+00007680: 2020 6465 6c20 6365 6c6c 735b 325d 0a20    del cells[2]. 
+00007690: 2020 2020 2020 2020 2020 2063 656c 6c73             cells
+000076a0: 5b32 5d5b 226d 6574 6164 6174 6122 5d5b  [2]["metadata"][
+000076b0: 226a 7570 7974 6572 5f64 3122 5d5b 2270  "jupyter_d1"]["p
+000076c0: 6f73 6974 696f 6e22 5d20 3d20 320a 2020  osition"] = 2.  
+000076d0: 2020 2020 2020 2020 2020 6578 7065 6374            expect
+000076e0: 6564 203d 207b 2263 656c 6c5f 6465 6c65  ed = {"cell_dele
+000076f0: 7465 223a 2063 656c 6c73 7d0a 0a20 2020  te": cells}..   
+00007700: 2020 2020 2020 2020 2061 7373 6572 7420           assert 
+00007710: 6461 7461 203d 3d20 6578 7065 6374 6564  data == expected
+00007720: 0a0a 2020 2020 4070 7974 6573 742e 6d61  ..    @pytest.ma
+00007730: 726b 2e61 7379 6e63 696f 0a20 2020 2061  rk.asyncio.    a
+00007740: 7379 6e63 2064 6566 2074 6573 745f 6e6f  sync def test_no
+00007750: 7465 626f 6f6b 5f63 656c 6c5f 6d6f 7665  tebook_cell_move
+00007760: 280a 2020 2020 2020 2020 7365 6c66 2c20  (.        self, 
+00007770: 636c 6965 6e74 3a20 5465 7374 436c 6965  client: TestClie
+00007780: 6e74 2c20 7375 7065 7275 7365 725f 746f  nt, superuser_to
+00007790: 6b65 6e5f 6865 6164 6572 733a 2044 6963  ken_headers: Dic
+000077a0: 745b 7374 722c 2073 7472 5d0a 2020 2020  t[str, str].    
+000077b0: 293a 0a20 2020 2020 2020 2075 7569 6420  ):.        uuid 
+000077c0: 3d20 6177 6169 7420 7570 6c6f 6164 5f6e  = await upload_n
+000077d0: 6f74 6562 6f6f 6b28 636c 6965 6e74 2c20  otebook(client, 
+000077e0: 7375 7065 7275 7365 725f 746f 6b65 6e5f  superuser_token_
+000077f0: 6865 6164 6572 7329 0a0a 2020 2020 2020  headers)..      
+00007800: 2020 6173 796e 6320 7769 7468 2063 6c69    async with cli
+00007810: 656e 742e 7765 6273 6f63 6b65 745f 636f  ent.websocket_co
+00007820: 6e6e 6563 7428 0a20 2020 2020 2020 2020  nnect(.         
+00007830: 2020 2066 222f 6e6f 7465 626f 6f6b 732f     f"/notebooks/
+00007840: 7b75 7569 647d 2f77 732f 6e6f 7465 626f  {uuid}/ws/notebo
+00007850: 6f6b 222c 2068 6561 6465 7273 3d73 7570  ok", headers=sup
+00007860: 6572 7573 6572 5f74 6f6b 656e 5f68 6561  eruser_token_hea
+00007870: 6465 7273 0a20 2020 2020 2020 2029 2061  ders.        ) a
+00007880: 7320 7765 6273 6f63 6b65 743a 0a20 2020  s websocket:.   
+00007890: 2020 2020 2020 2020 2061 7761 6974 2061           await a
+000078a0: 7379 6e63 696f 2e73 6c65 6570 2857 4542  syncio.sleep(WEB
+000078b0: 534f 434b 4554 5f53 4c45 4550 5f54 494d  SOCKET_SLEEP_TIM
+000078c0: 4529 0a0a 2020 2020 2020 2020 2020 2020  E)..            
+000078d0: 2320 6765 7420 7468 6520 6578 6973 7469  # get the existi
+000078e0: 6e67 2063 656c 6c73 0a20 2020 2020 2020  ng cells.       
+000078f0: 2020 2020 2072 6573 706f 6e73 6520 3d20       response = 
+00007900: 6177 6169 7420 636c 6965 6e74 2e67 6574  await client.get
+00007910: 280a 2020 2020 2020 2020 2020 2020 2020  (.              
+00007920: 2020 6622 2f6e 6f74 6562 6f6f 6b73 2f7b    f"/notebooks/{
+00007930: 7575 6964 7d2f 6365 6c6c 7322 2c20 6865  uuid}/cells", he
+00007940: 6164 6572 733d 7375 7065 7275 7365 725f  aders=superuser_
+00007950: 746f 6b65 6e5f 6865 6164 6572 730a 2020  token_headers.  
+00007960: 2020 2020 2020 2020 2020 290a 2020 2020            ).    
+00007970: 2020 2020 2020 2020 6173 7365 7274 2072          assert r
+00007980: 6573 706f 6e73 652e 7374 6174 7573 5f63  esponse.status_c
+00007990: 6f64 6520 3d3d 2032 3030 0a20 2020 2020  ode == 200.     
+000079a0: 2020 2020 2020 2063 656c 6c73 203d 2072         cells = r
+000079b0: 6573 706f 6e73 652e 6a73 6f6e 2829 5b22  esponse.json()["
+000079c0: 6365 6c6c 7322 5d0a 2020 2020 2020 2020  cells"].        
+000079d0: 2020 2020 6f72 6967 5f75 7569 6473 203d      orig_uuids =
+000079e0: 206c 6973 7428 0a20 2020 2020 2020 2020   list(.         
+000079f0: 2020 2020 2020 206d 6170 286c 616d 6264         map(lambd
+00007a00: 6120 783a 2078 5b22 6d65 7461 6461 7461  a x: x["metadata
+00007a10: 225d 5b22 6a75 7079 7465 725f 6431 225d  "]["jupyter_d1"]
+00007a20: 5b22 7575 6964 225d 2c20 6365 6c6c 7329  ["uuid"], cells)
+00007a30: 0a20 2020 2020 2020 2020 2020 2029 0a0a  .            )..
+00007a40: 2020 2020 2020 2020 2020 2020 2320 6d6f              # mo
+00007a50: 7665 2074 6865 206c 6173 7420 6365 6c6c  ve the last cell
+00007a60: 2074 6f20 6265 666f 7265 2074 6865 2066   to before the f
+00007a70: 6972 7374 2063 656c 6c0a 2020 2020 2020  irst cell.      
+00007a80: 2020 2020 2020 6265 666f 7265 5f75 7569        before_uui
+00007a90: 6420 3d20 6f72 6967 5f75 7569 6473 5b31  d = orig_uuids[1
+00007aa0: 5d0a 2020 2020 2020 2020 2020 2020 6d6f  ].            mo
+00007ab0: 7665 5f75 7569 6420 3d20 6f72 6967 5f75  ve_uuid = orig_u
+00007ac0: 7569 6473 5b33 5d0a 0a20 2020 2020 2020  uids[3]..       
+00007ad0: 2020 2020 2070 6172 616d 7320 3d20 7b22       params = {"
+00007ae0: 6265 666f 7265 223a 2062 6566 6f72 655f  before": before_
+00007af0: 7575 6964 7d0a 2020 2020 2020 2020 2020  uuid}.          
+00007b00: 2020 7265 7370 6f6e 7365 203d 2061 7761    response = awa
+00007b10: 6974 2063 6c69 656e 742e 6765 7428 0a20  it client.get(. 
+00007b20: 2020 2020 2020 2020 2020 2020 2020 2066                 f
+00007b30: 222f 6e6f 7465 626f 6f6b 732f 7b75 7569  "/notebooks/{uui
+00007b40: 647d 2f63 656c 6c73 2f7b 6d6f 7665 5f75  d}/cells/{move_u
+00007b50: 7569 647d 2f6d 6f76 6522 2c0a 2020 2020  uid}/move",.    
+00007b60: 2020 2020 2020 2020 2020 2020 7175 6572              quer
+00007b70: 795f 7374 7269 6e67 3d70 6172 616d 732c  y_string=params,
+00007b80: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00007b90: 2068 6561 6465 7273 3d73 7570 6572 7573   headers=superus
+00007ba0: 6572 5f74 6f6b 656e 5f68 6561 6465 7273  er_token_headers
+00007bb0: 2c0a 2020 2020 2020 2020 2020 2020 290a  ,.            ).
+00007bc0: 2020 2020 2020 2020 2020 2020 6173 7365              asse
+00007bd0: 7274 2072 6573 706f 6e73 652e 7374 6174  rt response.stat
+00007be0: 7573 5f63 6f64 6520 3d3d 2032 3034 0a0a  us_code == 204..
+00007bf0: 2020 2020 2020 2020 2020 2020 6461 7461              data
+00007c00: 203d 2061 7761 6974 2072 6563 6569 7665   = await receive
+00007c10: 5f6a 736f 6e28 7765 6273 6f63 6b65 7429  _json(websocket)
+00007c20: 0a20 2020 2020 2020 2020 2020 2063 656c  .            cel
+00007c30: 6c73 203d 2064 6174 615b 2263 656c 6c5f  ls = data["cell_
+00007c40: 7570 6461 7465 225d 0a20 2020 2020 2020  update"].       
+00007c50: 2020 2020 2061 7373 6572 7420 6c65 6e28       assert len(
+00007c60: 6365 6c6c 7329 203d 3d20 3420 2023 2073  cells) == 4  # s
+00007c70: 686f 756c 6420 6475 6d70 2061 6c6c 2074  hould dump all t
+00007c80: 6865 2063 656c 6c73 0a0a 2020 2020 2020  he cells..      
+00007c90: 2020 2020 2020 6e65 775f 7575 6964 7320        new_uuids 
+00007ca0: 3d20 5b5d 0a20 2020 2020 2020 2020 2020  = [].           
+00007cb0: 2066 6f72 2063 656c 6c20 696e 2063 656c   for cell in cel
+00007cc0: 6c73 3a0a 2020 2020 2020 2020 2020 2020  ls:.            
+00007cd0: 2020 2020 7575 6964 203d 2063 656c 6c5b      uuid = cell[
+00007ce0: 226d 6574 6164 6174 6122 5d5b 226a 7570  "metadata"]["jup
+00007cf0: 7974 6572 5f64 3122 5d5b 2275 7569 6422  yter_d1"]["uuid"
+00007d00: 5d0a 2020 2020 2020 2020 2020 2020 2020  ].              
+00007d10: 2020 6e65 775f 7575 6964 732e 6170 7065    new_uuids.appe
+00007d20: 6e64 2875 7569 6429 0a0a 2020 2020 2020  nd(uuid)..      
+00007d30: 2020 2020 2020 6578 7065 6374 6564 5f75        expected_u
+00007d40: 7569 6473 203d 205b 0a20 2020 2020 2020  uids = [.       
+00007d50: 2020 2020 2020 2020 206f 7269 675f 7575           orig_uu
+00007d60: 6964 735b 305d 2c0a 2020 2020 2020 2020  ids[0],.        
+00007d70: 2020 2020 2020 2020 6f72 6967 5f75 7569          orig_uui
+00007d80: 6473 5b33 5d2c 0a20 2020 2020 2020 2020  ds[3],.         
+00007d90: 2020 2020 2020 206f 7269 675f 7575 6964         orig_uuid
+00007da0: 735b 315d 2c0a 2020 2020 2020 2020 2020  s[1],.          
+00007db0: 2020 2020 2020 6f72 6967 5f75 7569 6473        orig_uuids
+00007dc0: 5b32 5d2c 0a20 2020 2020 2020 2020 2020  [2],.           
+00007dd0: 205d 0a20 2020 2020 2020 2020 2020 2061   ].            a
+00007de0: 7373 6572 7420 6e65 775f 7575 6964 7320  ssert new_uuids 
+00007df0: 3d3d 2065 7870 6563 7465 645f 7575 6964  == expected_uuid
+00007e00: 730a 0a20 2020 2020 2020 2020 2020 2023  s..            #
+00007e10: 2043 6865 636b 2063 656c 6c20 706f 7369   Check cell posi
+00007e20: 7469 6f6e 730a 2020 2020 2020 2020 2020  tions.          
+00007e30: 2020 6173 7365 7274 5f63 656c 6c5f 706f    assert_cell_po
+00007e40: 7369 7469 6f6e 7328 6365 6c6c 7329 0a0a  sitions(cells)..
+00007e50: 2020 2020 4070 7974 6573 742e 6d61 726b      @pytest.mark
+00007e60: 2e61 7379 6e63 696f 0a20 2020 2061 7379  .asyncio.    asy
+00007e70: 6e63 2064 6566 2074 6573 745f 6e6f 7465  nc def test_note
+00007e80: 626f 6f6b 5f63 656c 6c73 5f6d 6572 6765  book_cells_merge
+00007e90: 280a 2020 2020 2020 2020 7365 6c66 2c20  (.        self, 
+00007ea0: 636c 6965 6e74 3a20 5465 7374 436c 6965  client: TestClie
+00007eb0: 6e74 2c20 7375 7065 7275 7365 725f 746f  nt, superuser_to
+00007ec0: 6b65 6e5f 6865 6164 6572 733a 2044 6963  ken_headers: Dic
+00007ed0: 745b 7374 722c 2073 7472 5d0a 2020 2020  t[str, str].    
+00007ee0: 293a 0a20 2020 2020 2020 2075 7569 6420  ):.        uuid 
+00007ef0: 3d20 6177 6169 7420 7570 6c6f 6164 5f6e  = await upload_n
+00007f00: 6f74 6562 6f6f 6b28 636c 6965 6e74 2c20  otebook(client, 
+00007f10: 7375 7065 7275 7365 725f 746f 6b65 6e5f  superuser_token_
+00007f20: 6865 6164 6572 7329 0a0a 2020 2020 2020  headers)..      
+00007f30: 2020 6173 796e 6320 7769 7468 2063 6c69    async with cli
+00007f40: 656e 742e 7765 6273 6f63 6b65 745f 636f  ent.websocket_co
+00007f50: 6e6e 6563 7428 0a20 2020 2020 2020 2020  nnect(.         
+00007f60: 2020 2066 222f 6e6f 7465 626f 6f6b 732f     f"/notebooks/
+00007f70: 7b75 7569 647d 2f77 732f 6e6f 7465 626f  {uuid}/ws/notebo
+00007f80: 6f6b 222c 2068 6561 6465 7273 3d73 7570  ok", headers=sup
+00007f90: 6572 7573 6572 5f74 6f6b 656e 5f68 6561  eruser_token_hea
+00007fa0: 6465 7273 0a20 2020 2020 2020 2029 2061  ders.        ) a
+00007fb0: 7320 7765 6273 6f63 6b65 743a 0a20 2020  s websocket:.   
+00007fc0: 2020 2020 2020 2020 2061 7761 6974 2061           await a
+00007fd0: 7379 6e63 696f 2e73 6c65 6570 2857 4542  syncio.sleep(WEB
+00007fe0: 534f 434b 4554 5f53 4c45 4550 5f54 494d  SOCKET_SLEEP_TIM
+00007ff0: 4529 0a0a 2020 2020 2020 2020 2020 2020  E)..            
+00008000: 2320 6765 7420 7468 6520 6578 6973 7469  # get the existi
+00008010: 6e67 2063 656c 6c73 0a20 2020 2020 2020  ng cells.       
+00008020: 2020 2020 2072 6573 706f 6e73 6520 3d20       response = 
+00008030: 6177 6169 7420 636c 6965 6e74 2e67 6574  await client.get
+00008040: 280a 2020 2020 2020 2020 2020 2020 2020  (.              
+00008050: 2020 6622 2f6e 6f74 6562 6f6f 6b73 2f7b    f"/notebooks/{
+00008060: 7575 6964 7d2f 6365 6c6c 7322 2c20 6865  uuid}/cells", he
+00008070: 6164 6572 733d 7375 7065 7275 7365 725f  aders=superuser_
+00008080: 746f 6b65 6e5f 6865 6164 6572 730a 2020  token_headers.  
+00008090: 2020 2020 2020 2020 2020 290a 2020 2020            ).    
+000080a0: 2020 2020 2020 2020 6173 7365 7274 2072          assert r
+000080b0: 6573 706f 6e73 652e 7374 6174 7573 5f63  esponse.status_c
+000080c0: 6f64 6520 3d3d 2032 3030 0a20 2020 2020  ode == 200.     
+000080d0: 2020 2020 2020 2063 656c 6c73 203d 2072         cells = r
+000080e0: 6573 706f 6e73 652e 6a73 6f6e 2829 5b22  esponse.json()["
+000080f0: 6365 6c6c 7322 5d0a 2020 2020 2020 2020  cells"].        
+00008100: 2020 2020 6365 6c6c 5f75 7569 6420 3d20      cell_uuid = 
+00008110: 6365 6c6c 735b 315d 5b22 6d65 7461 6461  cells[1]["metada
+00008120: 7461 225d 5b22 6a75 7079 7465 725f 6431  ta"]["jupyter_d1
+00008130: 225d 5b22 7575 6964 225d 0a20 2020 2020  "]["uuid"].     
+00008140: 2020 2020 2020 2063 656c 6c73 5b32 5d5b         cells[2][
+00008150: 226d 6574 6164 6174 6122 5d5b 226a 7570  "metadata"]["jup
+00008160: 7974 6572 5f64 3122 5d5b 2275 7569 6422  yter_d1"]["uuid"
+00008170: 5d0a 2020 2020 2020 2020 2020 2020 6e65  ].            ne
+00008180: 7874 5f63 656c 6c5f 7575 6964 203d 2063  xt_cell_uuid = c
+00008190: 656c 6c73 5b33 5d5b 226d 6574 6164 6174  ells[3]["metadat
+000081a0: 6122 5d5b 226a 7570 7974 6572 5f64 3122  a"]["jupyter_d1"
+000081b0: 5d5b 2275 7569 6422 5d0a 2020 2020 2020  ]["uuid"].      
+000081c0: 2020 2020 2020 6173 7365 7274 2063 656c        assert cel
+000081d0: 6c73 5b31 5d5b 2273 6f75 7263 6522 5d20  ls[1]["source"] 
+000081e0: 3d3d 2027 7072 696e 7428 224c 6172 7279  == 'print("Larry
+000081f0: 2074 6865 204c 6c61 6d61 2229 270a 2020   the Llama")'.  
+00008200: 2020 2020 2020 2020 2020 6173 7365 7274            assert
+00008210: 2063 656c 6c73 5b32 5d5b 2273 6f75 7263   cells[2]["sourc
+00008220: 6522 5d20 3d3d 2022 322b 3522 0a0a 2020  e"] == "2+5"..  
+00008230: 2020 2020 2020 2020 2020 7265 7370 6f6e            respon
+00008240: 7365 203d 2061 7761 6974 2063 6c69 656e  se = await clien
+00008250: 742e 6765 7428 0a20 2020 2020 2020 2020  t.get(.         
+00008260: 2020 2020 2020 2066 222f 6e6f 7465 626f         f"/notebo
+00008270: 6f6b 732f 7b75 7569 647d 2f63 656c 6c73  oks/{uuid}/cells
+00008280: 2f7b 6365 6c6c 5f75 7569 647d 2f6d 6572  /{cell_uuid}/mer
+00008290: 6765 222c 0a20 2020 2020 2020 2020 2020  ge",.           
+000082a0: 2020 2020 2071 7565 7279 5f73 7472 696e       query_strin
+000082b0: 673d 7b22 6162 6f76 6522 3a20 4661 6c73  g={"above": Fals
+000082c0: 657d 2c0a 2020 2020 2020 2020 2020 2020  e},.            
+000082d0: 2020 2020 6865 6164 6572 733d 7375 7065      headers=supe
+000082e0: 7275 7365 725f 746f 6b65 6e5f 6865 6164  ruser_token_head
+000082f0: 6572 732c 0a20 2020 2020 2020 2020 2020  ers,.           
+00008300: 2029 0a20 2020 2020 2020 2020 2020 2061   ).            a
+00008310: 7373 6572 7420 7265 7370 6f6e 7365 2e73  ssert response.s
+00008320: 7461 7475 735f 636f 6465 203d 3d20 3230  tatus_code == 20
+00008330: 340a 0a20 2020 2020 2020 2020 2020 2064  4..            d
+00008340: 6174 6120 3d20 6177 6169 7420 7265 6365  ata = await rece
+00008350: 6976 655f 6a73 6f6e 2877 6562 736f 636b  ive_json(websock
+00008360: 6574 290a 2020 2020 2020 2020 2020 2020  et).            
+00008370: 6365 6c6c 7320 3d20 6461 7461 5b22 6365  cells = data["ce
+00008380: 6c6c 5f64 656c 6574 6522 5d0a 2020 2020  ll_delete"].    
+00008390: 2020 2020 2020 2020 6173 7365 7274 206c          assert l
+000083a0: 656e 2863 656c 6c73 2920 3d3d 2033 0a20  en(cells) == 3. 
+000083b0: 2020 2020 2020 2020 2020 2061 7373 6572             asser
+000083c0: 7420 6365 6c6c 735b 315d 5b22 736f 7572  t cells[1]["sour
+000083d0: 6365 225d 203d 3d20 2770 7269 6e74 2822  ce"] == 'print("
+000083e0: 4c61 7272 7920 7468 6520 4c6c 616d 6122  Larry the Llama"
+000083f0: 295c 6e32 2b35 270a 2020 2020 2020 2020  )\n2+5'.        
+00008400: 2020 2020 6173 7365 7274 2063 656c 6c73      assert cells
+00008410: 5b31 5d5b 226d 6574 6164 6174 6122 5d5b  [1]["metadata"][
+00008420: 226a 7570 7974 6572 5f64 3122 5d5b 2275  "jupyter_d1"]["u
+00008430: 7569 6422 5d20 3d3d 2063 656c 6c5f 7575  uid"] == cell_uu
+00008440: 6964 0a20 2020 2020 2020 2020 2020 2061  id.            a
+00008450: 7373 6572 7420 6365 6c6c 735b 325d 5b22  ssert cells[2]["
+00008460: 736f 7572 6365 225d 203d 3d20 2222 0a20  source"] == "". 
+00008470: 2020 2020 2020 2020 2020 2061 7373 6572             asser
+00008480: 7420 6365 6c6c 735b 325d 5b22 6d65 7461  t cells[2]["meta
+00008490: 6461 7461 225d 5b22 6a75 7079 7465 725f  data"]["jupyter_
+000084a0: 6431 225d 5b22 7575 6964 225d 203d 3d20  d1"]["uuid"] == 
+000084b0: 6e65 7874 5f63 656c 6c5f 7575 6964 0a20  next_cell_uuid. 
+000084c0: 2020 2020 2020 2020 2020 2023 2043 6865             # Che
+000084d0: 636b 2063 656c 6c20 706f 7369 7469 6f6e  ck cell position
+000084e0: 730a 2020 2020 2020 2020 2020 2020 6173  s.            as
+000084f0: 7365 7274 5f63 656c 6c5f 706f 7369 7469  sert_cell_positi
+00008500: 6f6e 7328 6365 6c6c 7329 0a0a 2020 2020  ons(cells)..    
+00008510: 4070 7974 6573 742e 6d61 726b 2e61 7379  @pytest.mark.asy
+00008520: 6e63 696f 0a20 2020 2061 7379 6e63 2064  ncio.    async d
+00008530: 6566 2074 6573 745f 6e6f 7465 626f 6f6b  ef test_notebook
+00008540: 5f63 656c 6c5f 7370 6c69 7428 0a20 2020  _cell_split(.   
+00008550: 2020 2020 2073 656c 662c 2063 6c69 656e       self, clien
+00008560: 743a 2054 6573 7443 6c69 656e 742c 2073  t: TestClient, s
+00008570: 7570 6572 7573 6572 5f74 6f6b 656e 5f68  uperuser_token_h
+00008580: 6561 6465 7273 3a20 4469 6374 5b73 7472  eaders: Dict[str
+00008590: 2c20 7374 725d 0a20 2020 2029 3a0a 2020  , str].    ):.  
+000085a0: 2020 2020 2020 7575 6964 203d 2061 7761        uuid = awa
+000085b0: 6974 2075 706c 6f61 645f 6e6f 7465 626f  it upload_notebo
+000085c0: 6f6b 2863 6c69 656e 742c 2073 7570 6572  ok(client, super
+000085d0: 7573 6572 5f74 6f6b 656e 5f68 6561 6465  user_token_heade
+000085e0: 7273 290a 0a20 2020 2020 2020 2061 7379  rs)..        asy
+000085f0: 6e63 2077 6974 6820 636c 6965 6e74 2e77  nc with client.w
+00008600: 6562 736f 636b 6574 5f63 6f6e 6e65 6374  ebsocket_connect
+00008610: 280a 2020 2020 2020 2020 2020 2020 6622  (.            f"
+00008620: 2f6e 6f74 6562 6f6f 6b73 2f7b 7575 6964  /notebooks/{uuid
+00008630: 7d2f 7773 2f6e 6f74 6562 6f6f 6b22 2c20  }/ws/notebook", 
+00008640: 6865 6164 6572 733d 7375 7065 7275 7365  headers=superuse
+00008650: 725f 746f 6b65 6e5f 6865 6164 6572 730a  r_token_headers.
+00008660: 2020 2020 2020 2020 2920 6173 2077 6562          ) as web
+00008670: 736f 636b 6574 3a0a 2020 2020 2020 2020  socket:.        
+00008680: 2020 2020 6177 6169 7420 6173 796e 6369      await asynci
+00008690: 6f2e 736c 6565 7028 5745 4253 4f43 4b45  o.sleep(WEBSOCKE
+000086a0: 545f 534c 4545 505f 5449 4d45 290a 0a20  T_SLEEP_TIME).. 
+000086b0: 2020 2020 2020 2020 2020 2023 2067 6574             # get
+000086c0: 2074 6865 2065 7869 7374 696e 6720 6365   the existing ce
+000086d0: 6c6c 730a 2020 2020 2020 2020 2020 2020  lls.            
+000086e0: 7265 7370 6f6e 7365 203d 2061 7761 6974  response = await
+000086f0: 2063 6c69 656e 742e 6765 7428 0a20 2020   client.get(.   
+00008700: 2020 2020 2020 2020 2020 2020 2066 222f               f"/
+00008710: 6e6f 7465 626f 6f6b 732f 7b75 7569 647d  notebooks/{uuid}
+00008720: 2f63 656c 6c73 222c 2068 6561 6465 7273  /cells", headers
+00008730: 3d73 7570 6572 7573 6572 5f74 6f6b 656e  =superuser_token
+00008740: 5f68 6561 6465 7273 0a20 2020 2020 2020  _headers.       
+00008750: 2020 2020 2029 0a20 2020 2020 2020 2020       ).         
+00008760: 2020 2061 7373 6572 7420 7265 7370 6f6e     assert respon
+00008770: 7365 2e73 7461 7475 735f 636f 6465 203d  se.status_code =
+00008780: 3d20 3230 300a 2020 2020 2020 2020 2020  = 200.          
+00008790: 2020 6365 6c6c 7320 3d20 7265 7370 6f6e    cells = respon
+000087a0: 7365 2e6a 736f 6e28 295b 2263 656c 6c73  se.json()["cells
+000087b0: 225d 0a20 2020 2020 2020 2020 2020 2063  "].            c
+000087c0: 656c 6c5f 7575 6964 203d 2063 656c 6c73  ell_uuid = cells
+000087d0: 5b31 5d5b 226d 6574 6164 6174 6122 5d5b  [1]["metadata"][
+000087e0: 226a 7570 7974 6572 5f64 3122 5d5b 2275  "jupyter_d1"]["u
+000087f0: 7569 6422 5d0a 2020 2020 2020 2020 2020  uid"].          
+00008800: 2020 6e65 7874 5f63 656c 6c5f 7575 6964    next_cell_uuid
+00008810: 203d 2063 656c 6c73 5b32 5d5b 226d 6574   = cells[2]["met
+00008820: 6164 6174 6122 5d5b 226a 7570 7974 6572  adata"]["jupyter
+00008830: 5f64 3122 5d5b 2275 7569 6422 5d0a 2020  _d1"]["uuid"].  
+00008840: 2020 2020 2020 2020 2020 6173 7365 7274            assert
+00008850: 2063 656c 6c73 5b31 5d5b 2273 6f75 7263   cells[1]["sourc
+00008860: 6522 5d20 3d3d 2027 7072 696e 7428 224c  e"] == 'print("L
+00008870: 6172 7279 2074 6865 204c 6c61 6d61 2229  arry the Llama")
+00008880: 270a 0a20 2020 2020 2020 2020 2020 2072  '..            r
+00008890: 6573 706f 6e73 6520 3d20 6177 6169 7420  esponse = await 
+000088a0: 636c 6965 6e74 2e67 6574 280a 2020 2020  client.get(.    
+000088b0: 2020 2020 2020 2020 2020 2020 6622 2f6e              f"/n
+000088c0: 6f74 6562 6f6f 6b73 2f7b 7575 6964 7d2f  otebooks/{uuid}/
+000088d0: 6365 6c6c 732f 7b63 656c 6c5f 7575 6964  cells/{cell_uuid
+000088e0: 7d2f 7370 6c69 7422 2c0a 2020 2020 2020  }/split",.      
+000088f0: 2020 2020 2020 2020 2020 7175 6572 795f            query_
+00008900: 7374 7269 6e67 3d7b 2273 706c 6974 5f6c  string={"split_l
+00008910: 6f63 6174 696f 6e22 3a20 327d 2c0a 2020  ocation": 2},.  
+00008920: 2020 2020 2020 2020 2020 2020 2020 6865                he
+00008930: 6164 6572 733d 7375 7065 7275 7365 725f  aders=superuser_
+00008940: 746f 6b65 6e5f 6865 6164 6572 732c 0a20  token_headers,. 
+00008950: 2020 2020 2020 2020 2020 2029 0a20 2020             ).   
+00008960: 2020 2020 2020 2020 2061 7373 6572 7420           assert 
+00008970: 7265 7370 6f6e 7365 2e73 7461 7475 735f  response.status_
+00008980: 636f 6465 203d 3d20 3230 340a 0a20 2020  code == 204..   
+00008990: 2020 2020 2020 2020 2064 6174 6120 3d20           data = 
+000089a0: 6177 6169 7420 7265 6365 6976 655f 6a73  await receive_js
+000089b0: 6f6e 2877 6562 736f 636b 6574 290a 2020  on(websocket).  
+000089c0: 2020 2020 2020 2020 2020 6365 6c6c 7320            cells 
+000089d0: 3d20 6461 7461 5b22 6365 6c6c 5f75 7064  = data["cell_upd
+000089e0: 6174 6522 5d0a 2020 2020 2020 2020 2020  ate"].          
+000089f0: 2020 6173 7365 7274 206c 656e 2863 656c    assert len(cel
+00008a00: 6c73 2920 3d3d 2035 0a20 2020 2020 2020  ls) == 5.       
+00008a10: 2020 2020 2061 7373 6572 7420 6365 6c6c       assert cell
+00008a20: 735b 315d 5b22 736f 7572 6365 225d 203d  s[1]["source"] =
+00008a30: 3d20 2270 7222 0a20 2020 2020 2020 2020  = "pr".         
+00008a40: 2020 2061 7373 6572 7420 6365 6c6c 735b     assert cells[
+00008a50: 315d 5b22 6d65 7461 6461 7461 225d 5b22  1]["metadata"]["
+00008a60: 6a75 7079 7465 725f 6431 225d 5b22 7575  jupyter_d1"]["uu
+00008a70: 6964 225d 203d 3d20 6365 6c6c 5f75 7569  id"] == cell_uui
+00008a80: 640a 2020 2020 2020 2020 2020 2020 6173  d.            as
+00008a90: 7365 7274 2063 656c 6c73 5b32 5d5b 2273  sert cells[2]["s
+00008aa0: 6f75 7263 6522 5d20 3d3d 2027 696e 7428  ource"] == 'int(
+00008ab0: 224c 6172 7279 2074 6865 204c 6c61 6d61  "Larry the Llama
+00008ac0: 2229 270a 2020 2020 2020 2020 2020 2020  ")'.            
+00008ad0: 6173 7365 7274 2063 656c 6c73 5b32 5d5b  assert cells[2][
+00008ae0: 226d 6574 6164 6174 6122 5d5b 226a 7570  "metadata"]["jup
+00008af0: 7974 6572 5f64 3122 5d5b 2275 7569 6422  yter_d1"]["uuid"
+00008b00: 5d20 6973 206e 6f74 204e 6f6e 650a 2020  ] is not None.  
+00008b10: 2020 2020 2020 2020 2020 6173 7365 7274            assert
+00008b20: 2063 656c 6c73 5b33 5d5b 226d 6574 6164   cells[3]["metad
+00008b30: 6174 6122 5d5b 226a 7570 7974 6572 5f64  ata"]["jupyter_d
+00008b40: 3122 5d5b 2275 7569 6422 5d20 3d3d 206e  1"]["uuid"] == n
+00008b50: 6578 745f 6365 6c6c 5f75 7569 640a 0a20  ext_cell_uuid.. 
+00008b60: 2020 2020 2020 2020 2020 2023 2043 6865             # Che
+00008b70: 636b 2063 656c 6c20 706f 7369 7469 6f6e  ck cell position
+00008b80: 730a 2020 2020 2020 2020 2020 2020 6173  s.            as
+00008b90: 7365 7274 5f63 656c 6c5f 706f 7369 7469  sert_cell_positi
+00008ba0: 6f6e 7328 6365 6c6c 7329 0a0a 2020 2020  ons(cells)..    
+00008bb0: 4070 7974 6573 742e 6d61 726b 2e61 7379  @pytest.mark.asy
+00008bc0: 6e63 696f 0a20 2020 2061 7379 6e63 2064  ncio.    async d
+00008bd0: 6566 2074 6573 745f 6964 6c65 5f73 7461  ef test_idle_sta
+00008be0: 7475 7328 0a20 2020 2020 2020 2073 656c  tus(.        sel
+00008bf0: 662c 0a20 2020 2020 2020 2063 6c69 656e  f,.        clien
+00008c00: 743a 2054 6573 7443 6c69 656e 742c 0a20  t: TestClient,. 
+00008c10: 2020 2020 2020 2072 6561 646f 6e6c 795f         readonly_
+00008c20: 746f 6b65 6e5f 6865 6164 6572 733a 2044  token_headers: D
+00008c30: 6963 745b 7374 722c 2073 7472 5d2c 0a20  ict[str, str],. 
+00008c40: 2020 2020 2020 2070 6572 6d69 7373 696f         permissio
+00008c50: 6e6c 6573 735f 746f 6b65 6e5f 6865 6164  nless_token_head
+00008c60: 6572 733a 2044 6963 745b 7374 722c 2073  ers: Dict[str, s
+00008c70: 7472 5d2c 0a20 2020 2020 2020 2073 7570  tr],.        sup
+00008c80: 6572 7573 6572 5f74 6f6b 656e 5f68 6561  eruser_token_hea
+00008c90: 6465 7273 3a20 4469 6374 5b73 7472 2c20  ders: Dict[str, 
+00008ca0: 7374 725d 2c0a 2020 2020 293a 0a20 2020  str],.    ):.   
+00008cb0: 2020 2020 2061 7379 6e63 2064 6566 2069       async def i
+00008cc0: 735f 6964 6c65 5f73 7461 7475 7328 293a  s_idle_status():
+00008cd0: 0a20 2020 2020 2020 2020 2020 2072 6573  .            res
+00008ce0: 706f 6e73 6520 3d20 6177 6169 7420 636c  ponse = await cl
+00008cf0: 6965 6e74 2e67 6574 280a 2020 2020 2020  ient.get(.      
+00008d00: 2020 2020 2020 2020 2020 6622 2f6b 6572            f"/ker
+00008d10: 6e65 6c73 2f69 646c 6522 2c20 6865 6164  nels/idle", head
+00008d20: 6572 733d 7375 7065 7275 7365 725f 746f  ers=superuser_to
+00008d30: 6b65 6e5f 6865 6164 6572 730a 2020 2020  ken_headers.    
+00008d40: 2020 2020 2020 2020 290a 2020 2020 2020          ).      
+00008d50: 2020 2020 2020 6173 7365 7274 2072 6573        assert res
+00008d60: 706f 6e73 652e 7374 6174 7573 5f63 6f64  ponse.status_cod
+00008d70: 6520 3d3d 2032 3030 0a20 2020 2020 2020  e == 200.       
+00008d80: 2020 2020 206a 736f 6e20 3d20 7265 7370       json = resp
+00008d90: 6f6e 7365 2e6a 736f 6e28 290a 2020 2020  onse.json().    
+00008da0: 2020 2020 2020 2020 7265 7475 726e 2028          return (
+00008db0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00008dc0: 206a 736f 6e5b 2269 646c 6522 5d2c 0a20   json["idle"],. 
+00008dd0: 2020 2020 2020 2020 2020 2020 2020 2064                 d
+00008de0: 6174 6574 696d 652e 7374 7270 7469 6d65  atetime.strptime
+00008df0: 286a 736f 6e5b 226c 6173 745f 6964 6c65  (json["last_idle
+00008e00: 225d 2c20 2225 592d 256d 2d25 6454 2548  "], "%Y-%m-%dT%H
+00008e10: 3a25 4d3a 2553 2e25 6622 292c 0a20 2020  :%M:%S.%f"),.   
+00008e20: 2020 2020 2020 2020 2029 0a0a 2020 2020           )..    
+00008e30: 2020 2020 2320 4b65 726e 656c 2069 7320      # Kernel is 
+00008e40: 6964 6c65 0a20 2020 2020 2020 2069 735f  idle.        is_
+00008e50: 6964 6c65 2c20 6c61 7374 5f69 646c 655f  idle, last_idle_
+00008e60: 3120 3d20 6177 6169 7420 6973 5f69 646c  1 = await is_idl
+00008e70: 655f 7374 6174 7573 2829 0a20 2020 2020  e_status().     
+00008e80: 2020 2061 7373 6572 7420 6973 5f69 646c     assert is_idl
+00008e90: 6520 6973 2054 7275 650a 0a20 2020 2020  e is True..     
+00008ea0: 2020 2075 7569 6420 3d20 6177 6169 7420     uuid = await 
+00008eb0: 7570 6c6f 6164 5f6e 6f74 6562 6f6f 6b28  upload_notebook(
+00008ec0: 0a20 2020 2020 2020 2020 2020 2063 6c69  .            cli
+00008ed0: 656e 742c 2073 7570 6572 7573 6572 5f74  ent, superuser_t
+00008ee0: 6f6b 656e 5f68 6561 6465 7273 2c20 2273  oken_headers, "s
+00008ef0: 696d 706c 652e 6970 796e 6222 0a20 2020  imple.ipynb".   
+00008f00: 2020 2020 2029 0a0a 2020 2020 2020 2020       )..        
+00008f10: 2320 4b65 726e 656c 2069 7320 7374 696c  # Kernel is stil
+00008f20: 6c20 6964 6c65 0a20 2020 2020 2020 2069  l idle.        i
+00008f30: 735f 6964 6c65 2c20 6c61 7374 5f69 646c  s_idle, last_idl
+00008f40: 655f 3220 3d20 6177 6169 7420 6973 5f69  e_2 = await is_i
+00008f50: 646c 655f 7374 6174 7573 2829 0a20 2020  dle_status().   
+00008f60: 2020 2020 2061 7373 6572 7420 6973 5f69       assert is_i
+00008f70: 646c 6520 6973 2054 7275 650a 2020 2020  dle is True.    
+00008f80: 2020 2020 6173 7365 7274 206c 6173 745f      assert last_
+00008f90: 6964 6c65 5f31 203d 3d20 6c61 7374 5f69  idle_1 == last_i
+00008fa0: 646c 655f 320a 0a20 2020 2020 2020 2023  dle_2..        #
+00008fb0: 2067 6574 2061 6e20 6578 6973 7469 6e67   get an existing
+00008fc0: 2063 656c 6c0a 2020 2020 2020 2020 7265   cell.        re
+00008fd0: 7370 6f6e 7365 203d 2061 7761 6974 2063  sponse = await c
+00008fe0: 6c69 656e 742e 6765 7428 0a20 2020 2020  lient.get(.     
+00008ff0: 2020 2020 2020 2066 222f 6e6f 7465 626f         f"/notebo
+00009000: 6f6b 732f 7b75 7569 647d 2f63 656c 6c73  oks/{uuid}/cells
+00009010: 222c 2068 6561 6465 7273 3d73 7570 6572  ", headers=super
+00009020: 7573 6572 5f74 6f6b 656e 5f68 6561 6465  user_token_heade
+00009030: 7273 0a20 2020 2020 2020 2029 0a20 2020  rs.        ).   
+00009040: 2020 2020 2061 7373 6572 7420 7265 7370       assert resp
+00009050: 6f6e 7365 2e73 7461 7475 735f 636f 6465  onse.status_code
+00009060: 203d 3d20 3230 300a 2020 2020 2020 2020   == 200.        
+00009070: 6365 6c6c 7320 3d20 7265 7370 6f6e 7365  cells = response
+00009080: 2e6a 736f 6e28 295b 2263 656c 6c73 225d  .json()["cells"]
+00009090: 0a20 2020 2020 2020 2061 7373 6572 7420  .        assert 
+000090a0: 6365 6c6c 735b 315d 5b22 736f 7572 6365  cells[1]["source
+000090b0: 225d 203d 3d20 2770 7269 6e74 2822 4c61  "] == 'print("La
+000090c0: 7272 7920 7468 6520 4c6c 616d 6122 2927  rry the Llama")'
+000090d0: 0a0a 2020 2020 2020 2020 6275 7379 5f63  ..        busy_c
+000090e0: 656c 6c5f 7575 6964 203d 2063 656c 6c73  ell_uuid = cells
+000090f0: 5b31 5d5b 226d 6574 6164 6174 6122 5d5b  [1]["metadata"][
+00009100: 226a 7570 7974 6572 5f64 3122 5d5b 2275  "jupyter_d1"]["u
+00009110: 7569 6422 5d0a 2020 2020 2020 2020 7175  uid"].        qu
+00009120: 6963 6b5f 6365 6c6c 5f75 7569 6420 3d20  ick_cell_uuid = 
+00009130: 6365 6c6c 735b 325d 5b22 6d65 7461 6461  cells[2]["metada
+00009140: 7461 225d 5b22 6a75 7079 7465 725f 6431  ta"]["jupyter_d1
+00009150: 225d 5b22 7575 6964 225d 0a0a 2020 2020  "]["uuid"]..    
+00009160: 2020 2020 7061 7261 6d73 203d 207b 0a20      params = {. 
+00009170: 2020 2020 2020 2020 2020 2022 736f 7572             "sour
+00009180: 6365 223a 2022 6672 6f6d 2074 696d 6520  ce": "from time 
+00009190: 696d 706f 7274 2073 6c65 6570 5c6e 7768  import sleep\nwh
+000091a0: 696c 6520 5472 7565 3a5c 6e20 2020 2073  ile True:\n    s
+000091b0: 6c65 6570 2835 2922 0a20 2020 2020 2020  leep(5)".       
+000091c0: 207d 0a20 2020 2020 2020 2072 6573 706f   }.        respo
+000091d0: 6e73 6520 3d20 6177 6169 7420 636c 6965  nse = await clie
+000091e0: 6e74 2e70 6174 6368 280a 2020 2020 2020  nt.patch(.      
+000091f0: 2020 2020 2020 6622 2f6e 6f74 6562 6f6f        f"/noteboo
+00009200: 6b73 2f7b 7575 6964 7d2f 6365 6c6c 732f  ks/{uuid}/cells/
+00009210: 7b62 7573 795f 6365 6c6c 5f75 7569 647d  {busy_cell_uuid}
+00009220: 222c 0a20 2020 2020 2020 2020 2020 206a  ",.            j
+00009230: 736f 6e3d 7061 7261 6d73 2c0a 2020 2020  son=params,.    
+00009240: 2020 2020 2020 2020 6865 6164 6572 733d          headers=
+00009250: 7375 7065 7275 7365 725f 746f 6b65 6e5f  superuser_token_
+00009260: 6865 6164 6572 732c 0a20 2020 2020 2020  headers,.       
+00009270: 2029 0a20 2020 2020 2020 2061 7373 6572   ).        asser
+00009280: 7420 7265 7370 6f6e 7365 2e73 7461 7475  t response.statu
+00009290: 735f 636f 6465 203d 3d20 3230 300a 0a20  s_code == 200.. 
+000092a0: 2020 2020 2020 2061 7379 6e63 2077 6974         async wit
+000092b0: 6820 636c 6965 6e74 2e77 6562 736f 636b  h client.websock
+000092c0: 6574 5f63 6f6e 6e65 6374 280a 2020 2020  et_connect(.    
+000092d0: 2020 2020 2020 2020 6622 2f6e 6f74 6562          f"/noteb
+000092e0: 6f6f 6b73 2f7b 7575 6964 7d2f 7773 2f6e  ooks/{uuid}/ws/n
+000092f0: 6f74 6562 6f6f 6b22 2c20 6865 6164 6572  otebook", header
+00009300: 733d 7375 7065 7275 7365 725f 746f 6b65  s=superuser_toke
+00009310: 6e5f 6865 6164 6572 730a 2020 2020 2020  n_headers.      
+00009320: 2020 2920 6173 2077 6562 736f 636b 6574    ) as websocket
+00009330: 3a0a 2020 2020 2020 2020 2020 2020 6177  :.            aw
+00009340: 6169 7420 6173 796e 6369 6f2e 736c 6565  ait asyncio.slee
+00009350: 7028 5745 4253 4f43 4b45 545f 534c 4545  p(WEBSOCKET_SLEE
+00009360: 505f 5449 4d45 290a 0a20 2020 2020 2020  P_TIME)..       
+00009370: 2020 2020 2072 6573 706f 6e73 6520 3d20       response = 
+00009380: 6177 6169 7420 636c 6965 6e74 2e67 6574  await client.get
+00009390: 280a 2020 2020 2020 2020 2020 2020 2020  (.              
+000093a0: 2020 6622 2f6e 6f74 6562 6f6f 6b73 2f7b    f"/notebooks/{
+000093b0: 7575 6964 7d2f 6365 6c6c 732f 7b71 7569  uuid}/cells/{qui
+000093c0: 636b 5f63 656c 6c5f 7575 6964 7d2f 6578  ck_cell_uuid}/ex
+000093d0: 6563 7574 6522 2c0a 2020 2020 2020 2020  ecute",.        
+000093e0: 2020 2020 2020 2020 6865 6164 6572 733d          headers=
+000093f0: 7375 7065 7275 7365 725f 746f 6b65 6e5f  superuser_token_
+00009400: 6865 6164 6572 732c 0a20 2020 2020 2020  headers,.       
+00009410: 2020 2020 2029 0a20 2020 2020 2020 2020       ).         
+00009420: 2020 2061 7373 6572 7420 7265 7370 6f6e     assert respon
+00009430: 7365 2e73 7461 7475 735f 636f 6465 203d  se.status_code =
+00009440: 3d20 3230 300a 0a20 2020 2020 2020 2020  = 200..         
+00009450: 2020 2064 6174 6120 3d20 6177 6169 7420     data = await 
+00009460: 7265 6365 6976 655f 6a73 6f6e 2877 6562  receive_json(web
+00009470: 736f 636b 6574 2c20 6d73 675f 7479 7065  socket, msg_type
+00009480: 733d 5b22 7661 7273 225d 290a 2020 2020  s=["vars"]).    
+00009490: 2020 2020 2020 2020 6173 7365 7274 2022          assert "
+000094a0: 7661 7273 2220 696e 2064 6174 610a 0a20  vars" in data.. 
+000094b0: 2020 2020 2020 2020 2020 2023 204e 6565             # Nee
+000094c0: 6420 746f 2077 6169 7420 666f 7220 7468  d to wait for th
+000094d0: 6520 5550 4441 5445 5f57 4f52 4b44 4952  e UPDATE_WORKDIR
+000094e0: 5f52 4551 5545 5354 2074 6f20 6669 6e69  _REQUEST to fini
+000094f0: 7368 0a20 2020 2020 2020 2020 2020 2023  sh.            #
+00009500: 2028 616e 6420 7765 2077 6f6e 2774 2073   (and we won't s
+00009510: 6565 2069 7420 7468 726f 7567 6820 7468  ee it through th
+00009520: 6520 7765 6273 6f63 6b65 7429 0a20 2020  e websocket).   
+00009530: 2020 2020 2020 2020 2061 7761 6974 2061           await a
+00009540: 7379 6e63 696f 2e73 6c65 6570 2831 290a  syncio.sleep(1).
+00009550: 0a20 2020 2020 2020 2020 2020 2023 204b  .            # K
+00009560: 6572 6e65 6c20 6973 2073 7469 6c6c 2069  ernel is still i
+00009570: 646c 6520 286e 6f20 636f 6465 2072 756e  dle (no code run
+00009580: 6e69 6e67 290a 2020 2020 2020 2020 2020  ning).          
+00009590: 2020 6973 5f69 646c 652c 206c 6173 745f    is_idle, last_
+000095a0: 6964 6c65 5f33 203d 2061 7761 6974 2069  idle_3 = await i
+000095b0: 735f 6964 6c65 5f73 7461 7475 7328 290a  s_idle_status().
+000095c0: 2020 2020 2020 2020 2020 2020 6173 7365              asse
+000095d0: 7274 2069 735f 6964 6c65 2069 7320 5472  rt is_idle is Tr
+000095e0: 7565 0a20 2020 2020 2020 2020 2020 2061  ue.            a
+000095f0: 7373 6572 7420 6c61 7374 5f69 646c 655f  ssert last_idle_
+00009600: 3320 3e20 6c61 7374 5f69 646c 655f 320a  3 > last_idle_2.
+00009610: 0a20 2020 2020 2020 2020 2020 2072 6573  .            res
+00009620: 706f 6e73 6520 3d20 6177 6169 7420 636c  ponse = await cl
+00009630: 6965 6e74 2e67 6574 280a 2020 2020 2020  ient.get(.      
+00009640: 2020 2020 2020 2020 2020 6622 2f6e 6f74            f"/not
+00009650: 6562 6f6f 6b73 2f7b 7575 6964 7d2f 6365  ebooks/{uuid}/ce
+00009660: 6c6c 732f 7b62 7573 795f 6365 6c6c 5f75  lls/{busy_cell_u
+00009670: 7569 647d 2f65 7865 6375 7465 222c 0a20  uid}/execute",. 
+00009680: 2020 2020 2020 2020 2020 2020 2020 2068                 h
+00009690: 6561 6465 7273 3d73 7570 6572 7573 6572  eaders=superuser
+000096a0: 5f74 6f6b 656e 5f68 6561 6465 7273 2c0a  _token_headers,.
+000096b0: 2020 2020 2020 2020 2020 2020 290a 2020              ).  
+000096c0: 2020 2020 2020 2020 2020 6173 7365 7274            assert
+000096d0: 2072 6573 706f 6e73 652e 7374 6174 7573   response.status
+000096e0: 5f63 6f64 6520 3d3d 2032 3030 0a0a 2020  _code == 200..  
+000096f0: 2020 2020 2020 2020 2020 2320 6669 7273            # firs
+00009700: 7420 6368 756e 6b20 7265 6365 6976 6564  t chunk received
+00009710: 2073 686f 756c 6420 6265 2061 2063 656c   should be a cel
+00009720: 6c5f 7570 6461 7465 2077 6974 680a 2020  l_update with.  
+00009730: 2020 2020 2020 2020 2020 2320 616e 2065            # an e
+00009740: 7865 6375 7469 6f6e 5f73 7461 7465 206f  xecution_state o
+00009750: 6620 2762 7573 7927 2077 6865 6e20 7072  f 'busy' when pr
+00009760: 6f63 6573 7369 6e67 2073 7461 7274 730a  ocessing starts.
+00009770: 2020 2020 2020 2020 2020 2020 6461 7461              data
+00009780: 203d 2061 7761 6974 2077 6169 745f 666f   = await wait_fo
+00009790: 725f 6576 656e 7428 7765 6273 6f63 6b65  r_event(websocke
+000097a0: 742c 2022 6365 6c6c 5f75 7064 6174 6522  t, "cell_update"
+000097b0: 290a 2020 2020 2020 2020 2020 2020 6431  ).            d1
+000097c0: 5f6d 6574 6164 6174 6120 3d20 6461 7461  _metadata = data
+000097d0: 5b22 6365 6c6c 5f75 7064 6174 6522 5d5b  ["cell_update"][
+000097e0: 305d 5b22 6d65 7461 6461 7461 225d 5b22  0]["metadata"]["
+000097f0: 6a75 7079 7465 725f 6431 225d 0a20 2020  jupyter_d1"].   
+00009800: 2020 2020 2020 2020 2061 7373 6572 7420           assert 
+00009810: 6431 5f6d 6574 6164 6174 615b 2265 7865  d1_metadata["exe
+00009820: 6375 7469 6f6e 5f73 7461 7465 225d 203d  cution_state"] =
+00009830: 3d20 2262 7573 7922 0a0a 2020 2020 2020  = "busy"..      
+00009840: 2020 2020 2020 2320 4b65 726e 656c 2073        # Kernel s
+00009850: 686f 756c 6420 6e6f 7420 6265 2069 646c  hould not be idl
+00009860: 6520 6e6f 770a 2020 2020 2020 2020 2020  e now.          
+00009870: 2020 6973 5f69 646c 652c 206c 6173 745f    is_idle, last_
+00009880: 6964 6c65 5f34 203d 2061 7761 6974 2069  idle_4 = await i
+00009890: 735f 6964 6c65 5f73 7461 7475 7328 290a  s_idle_status().
+000098a0: 2020 2020 2020 2020 2020 2020 6173 7365              asse
+000098b0: 7274 2069 735f 6964 6c65 2069 7320 4661  rt is_idle is Fa
+000098c0: 6c73 650a 2020 2020 2020 2020 2020 2020  lse.            
+000098d0: 6173 7365 7274 206c 6173 745f 6964 6c65  assert last_idle
+000098e0: 5f34 203d 3d20 6c61 7374 5f69 646c 655f  _4 == last_idle_
+000098f0: 330a 0a20 2020 2040 7079 7465 7374 2e6d  3..    @pytest.m
+00009900: 6172 6b2e 6173 796e 6369 6f0a 2020 2020  ark.asyncio.    
+00009910: 6173 796e 6320 6465 6620 7465 7374 5f6b  async def test_k
+00009920: 6572 6e65 6c5f 696e 7465 7272 7570 7428  ernel_interrupt(
+00009930: 0a20 2020 2020 2020 2073 656c 662c 0a20  .        self,. 
+00009940: 2020 2020 2020 2063 6c69 656e 743a 2054         client: T
+00009950: 6573 7443 6c69 656e 742c 0a20 2020 2020  estClient,.     
+00009960: 2020 2073 7570 6572 7573 6572 5f74 6f6b     superuser_tok
+00009970: 656e 5f68 6561 6465 7273 3a20 4469 6374  en_headers: Dict
+00009980: 5b73 7472 2c20 7374 725d 2c0a 2020 2020  [str, str],.    
+00009990: 293a 0a20 2020 2020 2020 2061 7379 6e63  ):.        async
+000099a0: 2064 6566 2069 735f 6964 6c65 5f73 7461   def is_idle_sta
+000099b0: 7475 7328 293a 0a20 2020 2020 2020 2020  tus():.         
+000099c0: 2020 2072 6573 706f 6e73 6520 3d20 6177     response = aw
+000099d0: 6169 7420 636c 6965 6e74 2e67 6574 280a  ait client.get(.
+000099e0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000099f0: 6622 2f6b 6572 6e65 6c73 2f69 646c 6522  f"/kernels/idle"
+00009a00: 2c20 6865 6164 6572 733d 7375 7065 7275  , headers=superu
+00009a10: 7365 725f 746f 6b65 6e5f 6865 6164 6572  ser_token_header
+00009a20: 730a 2020 2020 2020 2020 2020 2020 290a  s.            ).
+00009a30: 2020 2020 2020 2020 2020 2020 6173 7365              asse
+00009a40: 7274 2072 6573 706f 6e73 652e 7374 6174  rt response.stat
+00009a50: 7573 5f63 6f64 6520 3d3d 2032 3030 0a20  us_code == 200. 
+00009a60: 2020 2020 2020 2020 2020 206a 736f 6e20             json 
+00009a70: 3d20 7265 7370 6f6e 7365 2e6a 736f 6e28  = response.json(
+00009a80: 290a 2020 2020 2020 2020 2020 2020 7265  ).            re
+00009a90: 7475 726e 2028 0a20 2020 2020 2020 2020  turn (.         
+00009aa0: 2020 2020 2020 206a 736f 6e5b 2269 646c         json["idl
+00009ab0: 6522 5d2c 0a20 2020 2020 2020 2020 2020  e"],.           
+00009ac0: 2020 2020 2064 6174 6574 696d 652e 7374       datetime.st
+00009ad0: 7270 7469 6d65 286a 736f 6e5b 226c 6173  rptime(json["las
+00009ae0: 745f 6964 6c65 225d 2c20 2225 592d 256d  t_idle"], "%Y-%m
+00009af0: 2d25 6454 2548 3a25 4d3a 2553 2e25 6622  -%dT%H:%M:%S.%f"
+00009b00: 292c 0a20 2020 2020 2020 2020 2020 2029  ),.            )
+00009b10: 0a0a 2020 2020 2020 2020 7575 6964 203d  ..        uuid =
+00009b20: 2061 7761 6974 2075 706c 6f61 645f 6e6f   await upload_no
+00009b30: 7465 626f 6f6b 280a 2020 2020 2020 2020  tebook(.        
+00009b40: 2020 2020 636c 6965 6e74 2c20 7375 7065      client, supe
+00009b50: 7275 7365 725f 746f 6b65 6e5f 6865 6164  ruser_token_head
+00009b60: 6572 732c 2022 7369 6d70 6c65 2e69 7079  ers, "simple.ipy
+00009b70: 6e62 220a 2020 2020 2020 2020 290a 0a20  nb".        ).. 
+00009b80: 2020 2020 2020 2023 204b 6572 6e65 6c20         # Kernel 
+00009b90: 6973 2069 646c 650a 2020 2020 2020 2020  is idle.        
+00009ba0: 6973 5f69 646c 652c 206c 6173 745f 6964  is_idle, last_id
+00009bb0: 6c65 5f31 203d 2061 7761 6974 2069 735f  le_1 = await is_
+00009bc0: 6964 6c65 5f73 7461 7475 7328 290a 2020  idle_status().  
+00009bd0: 2020 2020 2020 6173 7365 7274 2069 735f        assert is_
+00009be0: 6964 6c65 2069 7320 5472 7565 0a0a 2020  idle is True..  
+00009bf0: 2020 2020 2020 2320 6765 7420 616e 2065        # get an e
+00009c00: 7869 7374 696e 6720 6365 6c6c 0a20 2020  xisting cell.   
+00009c10: 2020 2020 2072 6573 706f 6e73 6520 3d20       response = 
+00009c20: 6177 6169 7420 636c 6965 6e74 2e67 6574  await client.get
+00009c30: 280a 2020 2020 2020 2020 2020 2020 6622  (.            f"
+00009c40: 2f6e 6f74 6562 6f6f 6b73 2f7b 7575 6964  /notebooks/{uuid
+00009c50: 7d2f 6365 6c6c 7322 2c20 6865 6164 6572  }/cells", header
+00009c60: 733d 7375 7065 7275 7365 725f 746f 6b65  s=superuser_toke
+00009c70: 6e5f 6865 6164 6572 730a 2020 2020 2020  n_headers.      
+00009c80: 2020 290a 2020 2020 2020 2020 6173 7365    ).        asse
+00009c90: 7274 2072 6573 706f 6e73 652e 7374 6174  rt response.stat
+00009ca0: 7573 5f63 6f64 6520 3d3d 2032 3030 0a20  us_code == 200. 
+00009cb0: 2020 2020 2020 2063 656c 6c73 203d 2072         cells = r
+00009cc0: 6573 706f 6e73 652e 6a73 6f6e 2829 5b22  esponse.json()["
+00009cd0: 6365 6c6c 7322 5d0a 2020 2020 2020 2020  cells"].        
+00009ce0: 6173 7365 7274 2063 656c 6c73 5b31 5d5b  assert cells[1][
+00009cf0: 2273 6f75 7263 6522 5d20 3d3d 2027 7072  "source"] == 'pr
+00009d00: 696e 7428 224c 6172 7279 2074 6865 204c  int("Larry the L
+00009d10: 6c61 6d61 2229 270a 0a20 2020 2020 2020  lama")'..       
+00009d20: 2062 7573 795f 6365 6c6c 5f75 7569 6420   busy_cell_uuid 
+00009d30: 3d20 6365 6c6c 735b 315d 5b22 6d65 7461  = cells[1]["meta
+00009d40: 6461 7461 225d 5b22 6a75 7079 7465 725f  data"]["jupyter_
+00009d50: 6431 225d 5b22 7575 6964 225d 0a0a 2020  d1"]["uuid"]..  
+00009d60: 2020 2020 2020 7061 7261 6d73 203d 207b        params = {
+00009d70: 0a20 2020 2020 2020 2020 2020 2022 736f  .            "so
+00009d80: 7572 6365 223a 2022 6672 6f6d 2074 696d  urce": "from tim
+00009d90: 6520 696d 706f 7274 2073 6c65 6570 5c6e  e import sleep\n
+00009da0: 7768 696c 6520 5472 7565 3a5c 6e20 2020  while True:\n   
+00009db0: 2073 6c65 6570 2835 2922 0a20 2020 2020   sleep(5)".     
+00009dc0: 2020 207d 0a20 2020 2020 2020 2072 6573     }.        res
+00009dd0: 706f 6e73 6520 3d20 6177 6169 7420 636c  ponse = await cl
+00009de0: 6965 6e74 2e70 6174 6368 280a 2020 2020  ient.patch(.    
+00009df0: 2020 2020 2020 2020 6622 2f6e 6f74 6562          f"/noteb
+00009e00: 6f6f 6b73 2f7b 7575 6964 7d2f 6365 6c6c  ooks/{uuid}/cell
+00009e10: 732f 7b62 7573 795f 6365 6c6c 5f75 7569  s/{busy_cell_uui
+00009e20: 647d 222c 0a20 2020 2020 2020 2020 2020  d}",.           
+00009e30: 206a 736f 6e3d 7061 7261 6d73 2c0a 2020   json=params,.  
+00009e40: 2020 2020 2020 2020 2020 6865 6164 6572            header
+00009e50: 733d 7375 7065 7275 7365 725f 746f 6b65  s=superuser_toke
+00009e60: 6e5f 6865 6164 6572 732c 0a20 2020 2020  n_headers,.     
+00009e70: 2020 2029 0a20 2020 2020 2020 2061 7373     ).        ass
+00009e80: 6572 7420 7265 7370 6f6e 7365 2e73 7461  ert response.sta
+00009e90: 7475 735f 636f 6465 203d 3d20 3230 300a  tus_code == 200.
+00009ea0: 0a20 2020 2020 2020 2061 7379 6e63 2077  .        async w
+00009eb0: 6974 6820 636c 6965 6e74 2e77 6562 736f  ith client.webso
+00009ec0: 636b 6574 5f63 6f6e 6e65 6374 280a 2020  cket_connect(.  
+00009ed0: 2020 2020 2020 2020 2020 6622 2f6e 6f74            f"/not
+00009ee0: 6562 6f6f 6b73 2f7b 7575 6964 7d2f 7773  ebooks/{uuid}/ws
+00009ef0: 2f6e 6f74 6562 6f6f 6b22 2c20 6865 6164  /notebook", head
+00009f00: 6572 733d 7375 7065 7275 7365 725f 746f  ers=superuser_to
+00009f10: 6b65 6e5f 6865 6164 6572 730a 2020 2020  ken_headers.    
+00009f20: 2020 2020 2920 6173 2077 6562 736f 636b      ) as websock
+00009f30: 6574 3a0a 2020 2020 2020 2020 2020 2020  et:.            
+00009f40: 6177 6169 7420 6173 796e 6369 6f2e 736c  await asyncio.sl
+00009f50: 6565 7028 5745 4253 4f43 4b45 545f 534c  eep(WEBSOCKET_SL
+00009f60: 4545 505f 5449 4d45 290a 0a20 2020 2020  EEP_TIME)..     
+00009f70: 2020 2020 2020 2072 6573 706f 6e73 6520         response 
+00009f80: 3d20 6177 6169 7420 636c 6965 6e74 2e67  = await client.g
+00009f90: 6574 280a 2020 2020 2020 2020 2020 2020  et(.            
+00009fa0: 2020 2020 6622 2f6e 6f74 6562 6f6f 6b73      f"/notebooks
+00009fb0: 2f7b 7575 6964 7d2f 6365 6c6c 732f 7b62  /{uuid}/cells/{b
+00009fc0: 7573 795f 6365 6c6c 5f75 7569 647d 2f65  usy_cell_uuid}/e
+00009fd0: 7865 6375 7465 222c 0a20 2020 2020 2020  xecute",.       
+00009fe0: 2020 2020 2020 2020 2068 6561 6465 7273           headers
+00009ff0: 3d73 7570 6572 7573 6572 5f74 6f6b 656e  =superuser_token
+0000a000: 5f68 6561 6465 7273 2c0a 2020 2020 2020  _headers,.      
+0000a010: 2020 2020 2020 290a 2020 2020 2020 2020        ).        
+0000a020: 2020 2020 6173 7365 7274 2072 6573 706f      assert respo
+0000a030: 6e73 652e 7374 6174 7573 5f63 6f64 6520  nse.status_code 
+0000a040: 3d3d 2032 3030 0a20 2020 2020 2020 2020  == 200.         
+0000a050: 2020 206d 7367 5f69 6420 3d20 7265 7370     msg_id = resp
+0000a060: 6f6e 7365 2e6a 736f 6e28 295b 226b 6572  onse.json()["ker
+0000a070: 6e65 6c5f 6d65 7373 6167 6522 5d5b 226d  nel_message"]["m
+0000a080: 6573 7361 6765 5f69 6422 5d0a 0a20 2020  essage_id"]..   
+0000a090: 2020 2020 2020 2020 2023 2066 6972 7374           # first
+0000a0a0: 2063 6875 6e6b 2072 6563 6569 7665 6420   chunk received 
+0000a0b0: 7368 6f75 6c64 2062 6520 6120 6365 6c6c  should be a cell
+0000a0c0: 5f75 7064 6174 6520 7769 7468 0a20 2020  _update with.   
+0000a0d0: 2020 2020 2020 2020 2023 2061 6e20 6578           # an ex
+0000a0e0: 6563 7574 696f 6e5f 7374 6174 6520 6f66  ecution_state of
+0000a0f0: 2027 6275 7379 2720 7768 656e 2070 726f   'busy' when pro
+0000a100: 6365 7373 696e 6720 7374 6172 7473 0a20  cessing starts. 
+0000a110: 2020 2020 2020 2020 2020 2064 6174 6120             data 
+0000a120: 3d20 6177 6169 7420 7761 6974 5f66 6f72  = await wait_for
+0000a130: 5f65 7665 6e74 2877 6562 736f 636b 6574  _event(websocket
+0000a140: 2c20 2263 656c 6c5f 7570 6461 7465 2229  , "cell_update")
+0000a150: 0a20 2020 2020 2020 2020 2020 2064 315f  .            d1_
+0000a160: 6d65 7461 6461 7461 203d 2064 6174 615b  metadata = data[
+0000a170: 2263 656c 6c5f 7570 6461 7465 225d 5b30  "cell_update"][0
+0000a180: 5d5b 226d 6574 6164 6174 6122 5d5b 226a  ]["metadata"]["j
+0000a190: 7570 7974 6572 5f64 3122 5d0a 2020 2020  upyter_d1"].    
+0000a1a0: 2020 2020 2020 2020 6173 7365 7274 2064          assert d
+0000a1b0: 315f 6d65 7461 6461 7461 5b22 6578 6563  1_metadata["exec
+0000a1c0: 7574 696f 6e5f 7374 6174 6522 5d20 3d3d  ution_state"] ==
+0000a1d0: 2022 6275 7379 220a 2020 2020 2020 2020   "busy".        
+0000a1e0: 2020 2020 6173 7365 7274 2064 315f 6d65      assert d1_me
+0000a1f0: 7461 6461 7461 5b22 7575 6964 225d 203d  tadata["uuid"] =
+0000a200: 3d20 6275 7379 5f63 656c 6c5f 7575 6964  = busy_cell_uuid
+0000a210: 0a0a 2020 2020 2020 2020 2020 2020 2320  ..            # 
+0000a220: 4b65 726e 656c 2073 686f 756c 6420 6e6f  Kernel should no
+0000a230: 7420 6265 2069 646c 6520 6e6f 770a 2020  t be idle now.  
+0000a240: 2020 2020 2020 2020 2020 6973 5f69 646c            is_idl
+0000a250: 652c 206c 6173 745f 6964 6c65 5f32 203d  e, last_idle_2 =
+0000a260: 2061 7761 6974 2069 735f 6964 6c65 5f73   await is_idle_s
+0000a270: 7461 7475 7328 290a 2020 2020 2020 2020  tatus().        
+0000a280: 2020 2020 6173 7365 7274 2069 735f 6964      assert is_id
+0000a290: 6c65 2069 7320 4661 6c73 650a 2020 2020  le is False.    
+0000a2a0: 2020 2020 2020 2020 6173 7365 7274 206c          assert l
+0000a2b0: 6173 745f 6964 6c65 5f32 203d 3d20 6c61  ast_idle_2 == la
+0000a2c0: 7374 5f69 646c 655f 310a 0a20 2020 2020  st_idle_1..     
+0000a2d0: 2020 2020 2020 2072 6573 706f 6e73 6520         response 
+0000a2e0: 3d20 6177 6169 7420 636c 6965 6e74 2e67  = await client.g
+0000a2f0: 6574 280a 2020 2020 2020 2020 2020 2020  et(.            
+0000a300: 2020 2020 6622 2f6e 6f74 6562 6f6f 6b73      f"/notebooks
+0000a310: 2f7b 7575 6964 7d2f 696e 7465 7272 7570  /{uuid}/interrup
+0000a320: 745f 6b65 726e 656c 222c 0a20 2020 2020  t_kernel",.     
+0000a330: 2020 2020 2020 2020 2020 2068 6561 6465             heade
+0000a340: 7273 3d73 7570 6572 7573 6572 5f74 6f6b  rs=superuser_tok
+0000a350: 656e 5f68 6561 6465 7273 2c0a 2020 2020  en_headers,.    
+0000a360: 2020 2020 2020 2020 290a 2020 2020 2020          ).      
+0000a370: 2020 2020 2020 6173 7365 7274 2072 6573        assert res
+0000a380: 706f 6e73 652e 7374 6174 7573 5f63 6f64  ponse.status_cod
+0000a390: 6520 3d3d 2032 3034 0a0a 2020 2020 2020  e == 204..      
+0000a3a0: 2020 2020 2020 6461 7461 203d 2061 7761        data = awa
+0000a3b0: 6974 2077 6169 745f 666f 725f 6576 656e  it wait_for_even
+0000a3c0: 7428 7765 6273 6f63 6b65 742c 2022 6b65  t(websocket, "ke
+0000a3d0: 726e 656c 5f69 6e74 6572 7275 7074 6564  rnel_interrupted
+0000a3e0: 2229 0a20 2020 2020 2020 2020 2020 2061  ").            a
+0000a3f0: 7373 6572 7420 6461 7461 5b22 6b65 726e  ssert data["kern
+0000a400: 656c 5f69 6e74 6572 7275 7074 6564 225d  el_interrupted"]
+0000a410: 5b22 696e 7465 7272 7570 7465 6422 5d20  ["interrupted"] 
+0000a420: 6973 2054 7275 650a 0a20 2020 2020 2020  is True..       
+0000a430: 2020 2020 2023 2052 6563 6569 7665 2063       # Receive c
+0000a440: 656c 6c20 6572 726f 7220 6f75 7470 7574  ell error output
+0000a450: 0a20 2020 2020 2020 2020 2020 2064 6174  .            dat
+0000a460: 6120 3d20 6177 6169 7420 7761 6974 5f66  a = await wait_f
+0000a470: 6f72 5f65 7665 6e74 2877 6562 736f 636b  or_event(websock
+0000a480: 6574 2c20 2263 656c 6c5f 7570 6461 7465  et, "cell_update
+0000a490: 2229 0a20 2020 2020 2020 2020 2020 2064  ").            d
+0000a4a0: 315f 6d65 7461 6461 7461 203d 2064 6174  1_metadata = dat
+0000a4b0: 615b 2263 656c 6c5f 7570 6461 7465 225d  a["cell_update"]
+0000a4c0: 5b30 5d5b 226d 6574 6164 6174 6122 5d5b  [0]["metadata"][
+0000a4d0: 226a 7570 7974 6572 5f64 3122 5d0a 2020  "jupyter_d1"].  
+0000a4e0: 2020 2020 2020 2020 2020 6173 7365 7274            assert
+0000a4f0: 2064 315f 6d65 7461 6461 7461 5b22 6578   d1_metadata["ex
+0000a500: 6563 7574 696f 6e5f 7374 6174 6522 5d20  ecution_state"] 
+0000a510: 3d3d 2022 6275 7379 220a 2020 2020 2020  == "busy".      
+0000a520: 2020 2020 2020 6173 7365 7274 2064 6174        assert dat
+0000a530: 615b 2263 656c 6c5f 7570 6461 7465 225d  a["cell_update"]
+0000a540: 5b30 5d5b 2265 7865 6375 7469 6f6e 5f63  [0]["execution_c
+0000a550: 6f75 6e74 225d 2069 7320 4e6f 6e65 0a20  ount"] is None. 
+0000a560: 2020 2020 2020 2020 2020 2061 7373 6572             asser
+0000a570: 7420 6431 5f6d 6574 6164 6174 615b 2270  t d1_metadata["p
+0000a580: 6f73 6974 696f 6e22 5d20 3d3d 2031 0a20  osition"] == 1. 
+0000a590: 2020 2020 2020 2020 2020 2061 7373 6572             asser
+0000a5a0: 7420 6431 5f6d 6574 6164 6174 615b 2275  t d1_metadata["u
+0000a5b0: 7569 6422 5d20 3d3d 2062 7573 795f 6365  uid"] == busy_ce
+0000a5c0: 6c6c 5f75 7569 640a 2020 2020 2020 2020  ll_uuid.        
+0000a5d0: 2020 2020 6365 6c6c 203d 2064 6174 615b      cell = data[
+0000a5e0: 2263 656c 6c5f 7570 6461 7465 225d 5b30  "cell_update"][0
+0000a5f0: 5d0a 2020 2020 2020 2020 2020 2020 6173  ].            as
+0000a600: 7365 7274 2063 656c 6c5b 2263 656c 6c5f  sert cell["cell_
+0000a610: 7479 7065 225d 203d 3d20 2263 6f64 6522  type"] == "code"
+0000a620: 0a20 2020 2020 2020 2020 2020 2061 7373  .            ass
+0000a630: 6572 7420 6c65 6e28 6365 6c6c 5b22 6f75  ert len(cell["ou
+0000a640: 7470 7574 7322 5d29 203d 3d20 310a 2020  tputs"]) == 1.  
+0000a650: 2020 2020 2020 2020 2020 6173 7365 7274            assert
+0000a660: 2063 656c 6c5b 226f 7574 7075 7473 225d   cell["outputs"]
+0000a670: 5b30 5d5b 2265 6e61 6d65 225d 203d 3d20  [0]["ename"] == 
+0000a680: 224b 6579 626f 6172 6449 6e74 6572 7275  "KeyboardInterru
+0000a690: 7074 220a 2020 2020 2020 2020 2020 2020  pt".            
+0000a6a0: 6173 7365 7274 2022 4b65 7962 6f61 7264  assert "Keyboard
+0000a6b0: 496e 7465 7272 7570 7422 2069 6e20 6365  Interrupt" in ce
+0000a6c0: 6c6c 5b22 6f75 7470 7574 7322 5d5b 305d  ll["outputs"][0]
+0000a6d0: 5b22 7472 6163 6562 6163 6b22 5d5b 315d  ["traceback"][1]
+0000a6e0: 0a0a 2020 2020 2020 2020 2020 2020 6465  ..            de
+0000a6f0: 6620 6173 7365 7274 5f6a 736f 6e5f 636f  f assert_json_co
+0000a700: 6e74 656e 7428 6461 7461 2c20 6578 6563  ntent(data, exec
+0000a710: 7574 696f 6e5f 636f 756e 743d 4e6f 6e65  ution_count=None
+0000a720: 293a 0a20 2020 2020 2020 2020 2020 2020  ):.             
+0000a730: 2020 2069 6620 2263 656c 6c5f 7570 6461     if "cell_upda
+0000a740: 7465 2220 696e 2064 6174 613a 0a20 2020  te" in data:.   
+0000a750: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000a760: 2063 656c 6c5f 6461 7461 203d 2064 6174   cell_data = dat
+0000a770: 615b 2263 656c 6c5f 7570 6461 7465 225d  a["cell_update"]
+0000a780: 5b30 5d0a 2020 2020 2020 2020 2020 2020  [0].            
+0000a790: 2020 2020 2020 2020 6431 5f6d 6574 6164          d1_metad
+0000a7a0: 6174 6120 3d20 6365 6c6c 5f64 6174 615b  ata = cell_data[
+0000a7b0: 226d 6574 6164 6174 6122 5d5b 226a 7570  "metadata"]["jup
+0000a7c0: 7974 6572 5f64 3122 5d0a 2020 2020 2020  yter_d1"].      
+0000a7d0: 2020 2020 2020 2020 2020 2020 2020 6173                as
+0000a7e0: 7365 7274 2064 315f 6d65 7461 6461 7461  sert d1_metadata
+0000a7f0: 5b22 6578 6563 7574 696f 6e5f 7374 6174  ["execution_stat
+0000a800: 6522 5d20 3d3d 2022 6964 6c65 220a 2020  e"] == "idle".  
+0000a810: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000a820: 2020 6173 7365 7274 2064 315f 6d65 7461    assert d1_meta
+0000a830: 6461 7461 5b22 7575 6964 225d 203d 3d20  data["uuid"] == 
+0000a840: 6275 7379 5f63 656c 6c5f 7575 6964 0a20  busy_cell_uuid. 
+0000a850: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000a860: 2020 2061 7373 6572 7420 6365 6c6c 5f64     assert cell_d
+0000a870: 6174 615b 2265 7865 6375 7469 6f6e 5f63  ata["execution_c
+0000a880: 6f75 6e74 225d 203d 3d20 6578 6563 7574  ount"] == execut
+0000a890: 696f 6e5f 636f 756e 740a 2020 2020 2020  ion_count.      
+0000a8a0: 2020 2020 2020 2020 2020 2020 2020 7265                re
+0000a8b0: 7475 726e 204e 6f6e 650a 2020 2020 2020  turn None.      
+0000a8c0: 2020 2020 2020 2020 2020 656c 6966 2022            elif "
+0000a8d0: 6365 6c6c 5f65 7865 6375 7469 6f6e 5f72  cell_execution_r
+0000a8e0: 6570 6c79 2220 696e 2064 6174 613a 0a20  eply" in data:. 
+0000a8f0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000a900: 2020 2061 7373 6572 7420 6461 7461 5b22     assert data["
+0000a910: 6365 6c6c 5f65 7865 6375 7469 6f6e 5f72  cell_execution_r
+0000a920: 6570 6c79 225d 5b22 6578 6563 7574 696f  eply"]["executio
+0000a930: 6e5f 636f 756e 7422 5d20 3d3d 2031 0a20  n_count"] == 1. 
+0000a940: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000a950: 2020 2061 7373 6572 7420 280a 2020 2020     assert (.    
+0000a960: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000a970: 2020 2020 6461 7461 5b22 6365 6c6c 5f65      data["cell_e
+0000a980: 7865 6375 7469 6f6e 5f72 6570 6c79 225d  xecution_reply"]
+0000a990: 5b22 6365 6c6c 5f69 6422 5d0a 2020 2020  ["cell_id"].    
+0000a9a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000a9b0: 2020 2020 3d3d 2062 7573 795f 6365 6c6c      == busy_cell
+0000a9c0: 5f75 7569 640a 2020 2020 2020 2020 2020  _uuid.          
+0000a9d0: 2020 2020 2020 2020 2020 290a 2020 2020            ).    
+0000a9e0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000a9f0: 6173 7365 7274 2028 0a20 2020 2020 2020  assert (.       
+0000aa00: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000aa10: 206c 656e 2864 6174 615b 2263 656c 6c5f   len(data["cell_
+0000aa20: 6578 6563 7574 696f 6e5f 7265 706c 7922  execution_reply"
+0000aa30: 5d5b 2270 6172 656e 745f 6964 225d 290a  ]["parent_id"]).
+0000aa40: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000aa50: 2020 2020 2020 2020 696e 206d 7367 5f69          in msg_i
+0000aa60: 645f 6c65 6e67 7468 730a 2020 2020 2020  d_lengths.      
+0000aa70: 2020 2020 2020 2020 2020 2020 2020 290a                ).
+0000aa80: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000aa90: 2020 2020 6173 7365 7274 2064 6174 615b      assert data[
+0000aaa0: 2263 656c 6c5f 6578 6563 7574 696f 6e5f  "cell_execution_
+0000aab0: 7265 706c 7922 5d5b 2270 6172 656e 745f  reply"]["parent_
+0000aac0: 6964 225d 203d 3d20 6d73 675f 6964 0a20  id"] == msg_id. 
+0000aad0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000aae0: 2020 2072 6574 7572 6e20 310a 2020 2020     return 1.    
+0000aaf0: 2020 2020 2020 2020 2020 2020 656c 7365              else
+0000ab00: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
+0000ab10: 2020 2020 2020 7261 6973 6520 4173 7365        raise Asse
+0000ab20: 7274 696f 6e45 7272 6f72 2866 2275 6e65  rtionError(f"une
+0000ab30: 7870 6563 7465 6420 6365 6c6c 2074 7970  xpected cell typ
+0000ab40: 653a 207b 6461 7461 7d22 290a 0a20 2020  e: {data}")..   
+0000ab50: 2020 2020 2020 2020 2023 2045 7865 6375           # Execu
+0000ab60: 7469 6f6e 2063 6f75 6e74 2075 7064 6174  tion count updat
+0000ab70: 650a 2020 2020 2020 2020 2020 2020 6461  e.            da
+0000ab80: 7461 203d 2061 7761 6974 2077 6169 745f  ta = await wait_
+0000ab90: 666f 725f 6576 656e 7428 7765 6273 6f63  for_event(websoc
+0000aba0: 6b65 742c 2022 6365 6c6c 5f65 7865 6375  ket, "cell_execu
+0000abb0: 7469 6f6e 5f72 6570 6c79 2229 0a20 2020  tion_reply").   
+0000abc0: 2020 2020 2020 2020 2065 7865 635f 636f           exec_co
+0000abd0: 756e 7420 3d20 6173 7365 7274 5f6a 736f  unt = assert_jso
+0000abe0: 6e5f 636f 6e74 656e 7428 6461 7461 290a  n_content(data).
+0000abf0: 2020 2020 2020 2020 2020 2020 6461 7461              data
+0000ac00: 203d 2061 7761 6974 2077 6169 745f 666f   = await wait_fo
+0000ac10: 725f 6576 656e 7428 7765 6273 6f63 6b65  r_event(websocke
+0000ac20: 742c 2022 6365 6c6c 5f75 7064 6174 6522  t, "cell_update"
+0000ac30: 290a 2020 2020 2020 2020 2020 2020 6173  ).            as
+0000ac40: 7365 7274 5f6a 736f 6e5f 636f 6e74 656e  sert_json_conten
+0000ac50: 7428 6461 7461 2c20 6578 6563 5f63 6f75  t(data, exec_cou
+0000ac60: 6e74 290a 0a20 2020 2020 2020 2020 2020  nt)..           
+0000ac70: 2023 204b 6572 6e65 6c20 7368 6f75 6c64   # Kernel should
+0000ac80: 2062 6520 6964 6c65 206e 6f77 0a20 2020   be idle now.   
+0000ac90: 2020 2020 2020 2020 2069 735f 6964 6c65           is_idle
+0000aca0: 2c20 6c61 7374 5f69 646c 655f 3320 3d20  , last_idle_3 = 
+0000acb0: 6177 6169 7420 6973 5f69 646c 655f 7374  await is_idle_st
+0000acc0: 6174 7573 2829 0a20 2020 2020 2020 2020  atus().         
+0000acd0: 2020 2061 7373 6572 7420 6973 5f69 646c     assert is_idl
+0000ace0: 6520 6973 2054 7275 650a 2020 2020 2020  e is True.      
+0000acf0: 2020 2020 2020 6173 7365 7274 206c 6173        assert las
+0000ad00: 745f 6964 6c65 5f33 203e 206c 6173 745f  t_idle_3 > last_
+0000ad10: 6964 6c65 5f32 0a0a 2020 2020 4070 7974  idle_2..    @pyt
+0000ad20: 6573 742e 6d61 726b 2e61 7379 6e63 696f  est.mark.asyncio
+0000ad30: 0a20 2020 2061 7379 6e63 2064 6566 2074  .    async def t
+0000ad40: 6573 745f 626f 6775 735f 636f 6465 5f65  est_bogus_code_e
+0000ad50: 7272 6f72 280a 2020 2020 2020 2020 7365  rror(.        se
+0000ad60: 6c66 2c0a 2020 2020 2020 2020 636c 6965  lf,.        clie
+0000ad70: 6e74 3a20 5465 7374 436c 6965 6e74 2c0a  nt: TestClient,.
+0000ad80: 2020 2020 2020 2020 7265 6164 6f6e 6c79          readonly
+0000ad90: 5f74 6f6b 656e 5f68 6561 6465 7273 3a20  _token_headers: 
+0000ada0: 4469 6374 5b73 7472 2c20 7374 725d 2c0a  Dict[str, str],.
+0000adb0: 2020 2020 2020 2020 7065 726d 6973 7369          permissi
+0000adc0: 6f6e 6c65 7373 5f74 6f6b 656e 5f68 6561  onless_token_hea
+0000add0: 6465 7273 3a20 4469 6374 5b73 7472 2c20  ders: Dict[str, 
+0000ade0: 7374 725d 2c0a 2020 2020 2020 2020 7375  str],.        su
+0000adf0: 7065 7275 7365 725f 746f 6b65 6e5f 6865  peruser_token_he
+0000ae00: 6164 6572 733a 2044 6963 745b 7374 722c  aders: Dict[str,
+0000ae10: 2073 7472 5d2c 0a20 2020 2029 3a0a 2020   str],.    ):.  
+0000ae20: 2020 2020 2020 7575 6964 203d 2061 7761        uuid = awa
+0000ae30: 6974 2075 706c 6f61 645f 6e6f 7465 626f  it upload_notebo
+0000ae40: 6f6b 280a 2020 2020 2020 2020 2020 2020  ok(.            
+0000ae50: 636c 6965 6e74 2c20 7375 7065 7275 7365  client, superuse
+0000ae60: 725f 746f 6b65 6e5f 6865 6164 6572 732c  r_token_headers,
+0000ae70: 2022 7369 6d70 6c65 2e69 7079 6e62 220a   "simple.ipynb".
+0000ae80: 2020 2020 2020 2020 290a 0a20 2020 2020          )..     
+0000ae90: 2020 2023 2067 6574 2061 6e20 6578 6973     # get an exis
+0000aea0: 7469 6e67 2063 656c 6c0a 2020 2020 2020  ting cell.      
+0000aeb0: 2020 7265 7370 6f6e 7365 203d 2061 7761    response = awa
+0000aec0: 6974 2063 6c69 656e 742e 6765 7428 0a20  it client.get(. 
+0000aed0: 2020 2020 2020 2020 2020 2066 222f 6e6f             f"/no
+0000aee0: 7465 626f 6f6b 732f 7b75 7569 647d 2f63  tebooks/{uuid}/c
+0000aef0: 656c 6c73 222c 2068 6561 6465 7273 3d73  ells", headers=s
+0000af00: 7570 6572 7573 6572 5f74 6f6b 656e 5f68  uperuser_token_h
+0000af10: 6561 6465 7273 0a20 2020 2020 2020 2029  eaders.        )
+0000af20: 0a20 2020 2020 2020 2061 7373 6572 7420  .        assert 
+0000af30: 7265 7370 6f6e 7365 2e73 7461 7475 735f  response.status_
+0000af40: 636f 6465 203d 3d20 3230 300a 2020 2020  code == 200.    
+0000af50: 2020 2020 6365 6c6c 7320 3d20 7265 7370      cells = resp
+0000af60: 6f6e 7365 2e6a 736f 6e28 295b 2263 656c  onse.json()["cel
+0000af70: 6c73 225d 0a20 2020 2020 2020 2063 656c  ls"].        cel
+0000af80: 6c5f 7575 6964 203d 2063 656c 6c73 5b31  l_uuid = cells[1
+0000af90: 5d5b 226d 6574 6164 6174 6122 5d5b 226a  ]["metadata"]["j
+0000afa0: 7570 7974 6572 5f64 3122 5d5b 2275 7569  upyter_d1"]["uui
+0000afb0: 6422 5d0a 0a20 2020 2020 2020 2070 6172  d"]..        par
+0000afc0: 616d 7320 3d20 7b22 736f 7572 6365 223a  ams = {"source":
+0000afd0: 2022 7468 6973 2069 736e 7420 636f 6465   "this isnt code
+0000afe0: 227d 0a20 2020 2020 2020 2072 6573 706f  "}.        respo
+0000aff0: 6e73 6520 3d20 6177 6169 7420 636c 6965  nse = await clie
+0000b000: 6e74 2e70 6174 6368 280a 2020 2020 2020  nt.patch(.      
+0000b010: 2020 2020 2020 6622 2f6e 6f74 6562 6f6f        f"/noteboo
+0000b020: 6b73 2f7b 7575 6964 7d2f 6365 6c6c 732f  ks/{uuid}/cells/
+0000b030: 7b63 656c 6c5f 7575 6964 7d22 2c0a 2020  {cell_uuid}",.  
+0000b040: 2020 2020 2020 2020 2020 6a73 6f6e 3d70            json=p
+0000b050: 6172 616d 732c 0a20 2020 2020 2020 2020  arams,.         
+0000b060: 2020 2068 6561 6465 7273 3d73 7570 6572     headers=super
+0000b070: 7573 6572 5f74 6f6b 656e 5f68 6561 6465  user_token_heade
+0000b080: 7273 2c0a 2020 2020 2020 2020 290a 2020  rs,.        ).  
+0000b090: 2020 2020 2020 6173 7365 7274 2072 6573        assert res
+0000b0a0: 706f 6e73 652e 7374 6174 7573 5f63 6f64  ponse.status_cod
+0000b0b0: 6520 3d3d 2032 3030 0a0a 2020 2020 2020  e == 200..      
+0000b0c0: 2020 6173 796e 6320 7769 7468 2063 6c69    async with cli
+0000b0d0: 656e 742e 7765 6273 6f63 6b65 745f 636f  ent.websocket_co
+0000b0e0: 6e6e 6563 7428 0a20 2020 2020 2020 2020  nnect(.         
+0000b0f0: 2020 2066 222f 6e6f 7465 626f 6f6b 732f     f"/notebooks/
+0000b100: 7b75 7569 647d 2f77 732f 6e6f 7465 626f  {uuid}/ws/notebo
+0000b110: 6f6b 222c 2068 6561 6465 7273 3d73 7570  ok", headers=sup
+0000b120: 6572 7573 6572 5f74 6f6b 656e 5f68 6561  eruser_token_hea
+0000b130: 6465 7273 0a20 2020 2020 2020 2029 2061  ders.        ) a
+0000b140: 7320 7765 6273 6f63 6b65 743a 0a20 2020  s websocket:.   
+0000b150: 2020 2020 2020 2020 2061 7761 6974 2061           await a
+0000b160: 7379 6e63 696f 2e73 6c65 6570 2857 4542  syncio.sleep(WEB
+0000b170: 534f 434b 4554 5f53 4c45 4550 5f54 494d  SOCKET_SLEEP_TIM
+0000b180: 4529 0a0a 2020 2020 2020 2020 2020 2020  E)..            
+0000b190: 7265 7370 6f6e 7365 203d 2061 7761 6974  response = await
+0000b1a0: 2063 6c69 656e 742e 6765 7428 0a20 2020   client.get(.   
+0000b1b0: 2020 2020 2020 2020 2020 2020 2066 222f               f"/
+0000b1c0: 6e6f 7465 626f 6f6b 732f 7b75 7569 647d  notebooks/{uuid}
+0000b1d0: 2f63 656c 6c73 2f7b 6365 6c6c 5f75 7569  /cells/{cell_uui
+0000b1e0: 647d 2f65 7865 6375 7465 222c 0a20 2020  d}/execute",.   
+0000b1f0: 2020 2020 2020 2020 2020 2020 2068 6561               hea
+0000b200: 6465 7273 3d73 7570 6572 7573 6572 5f74  ders=superuser_t
+0000b210: 6f6b 656e 5f68 6561 6465 7273 2c0a 2020  oken_headers,.  
+0000b220: 2020 2020 2020 2020 2020 290a 2020 2020            ).    
+0000b230: 2020 2020 2020 2020 6173 7365 7274 2072          assert r
+0000b240: 6573 706f 6e73 652e 7374 6174 7573 5f63  esponse.status_c
+0000b250: 6f64 6520 3d3d 2032 3030 0a20 2020 2020  ode == 200.     
+0000b260: 2020 2020 2020 206d 7367 5f69 6420 3d20         msg_id = 
+0000b270: 7265 7370 6f6e 7365 2e6a 736f 6e28 295b  response.json()[
+0000b280: 226b 6572 6e65 6c5f 6d65 7373 6167 6522  "kernel_message"
+0000b290: 5d5b 226d 6573 7361 6765 5f69 6422 5d0a  ]["message_id"].
+0000b2a0: 0a20 2020 2020 2020 2020 2020 2023 2065  .            # e
+0000b2b0: 7865 6375 7469 6f6e 5f63 6f75 6e74 2075  xecution_count u
+0000b2c0: 7064 6174 6520 616e 6420 6275 7379 2073  pdate and busy s
+0000b2d0: 7461 7475 7320 7570 6461 7465 2c0a 2020  tatus update,.  
+0000b2e0: 2020 2020 2020 2020 2020 2320 696e 2075            # in u
+0000b2f0: 6e63 6572 7461 696e 206f 7264 6572 0a20  ncertain order. 
+0000b300: 2020 2020 2020 2020 2020 2064 6566 2061             def a
+0000b310: 7373 6572 745f 6a73 6f6e 5f63 6f6e 7465  ssert_json_conte
+0000b320: 6e74 2864 6174 612c 2065 7865 6375 7469  nt(data, executi
+0000b330: 6f6e 5f63 6f75 6e74 3d4e 6f6e 6529 3a0a  on_count=None):.
+0000b340: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000b350: 6966 2022 6365 6c6c 5f75 7064 6174 6522  if "cell_update"
+0000b360: 2069 6e20 6461 7461 3a0a 2020 2020 2020   in data:.      
+0000b370: 2020 2020 2020 2020 2020 2020 2020 6365                ce
+0000b380: 6c6c 5f64 6174 6120 3d20 6461 7461 5b22  ll_data = data["
+0000b390: 6365 6c6c 5f75 7064 6174 6522 5d5b 305d  cell_update"][0]
+0000b3a0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+0000b3b0: 2020 2020 2064 315f 6d65 7461 6461 7461       d1_metadata
+0000b3c0: 203d 2063 656c 6c5f 6461 7461 5b22 6d65   = cell_data["me
+0000b3d0: 7461 6461 7461 225d 5b22 6a75 7079 7465  tadata"]["jupyte
+0000b3e0: 725f 6431 225d 0a20 2020 2020 2020 2020  r_d1"].         
+0000b3f0: 2020 2020 2020 2020 2020 2061 7373 6572             asser
+0000b400: 7420 6431 5f6d 6574 6164 6174 615b 2265  t d1_metadata["e
+0000b410: 7865 6375 7469 6f6e 5f73 7461 7465 225d  xecution_state"]
+0000b420: 203d 3d20 2262 7573 7922 0a20 2020 2020   == "busy".     
+0000b430: 2020 2020 2020 2020 2020 2020 2020 2061                 a
+0000b440: 7373 6572 7420 6431 5f6d 6574 6164 6174  ssert d1_metadat
+0000b450: 615b 2275 7569 6422 5d20 3d3d 2063 656c  a["uuid"] == cel
+0000b460: 6c5f 7575 6964 0a20 2020 2020 2020 2020  l_uuid.         
+0000b470: 2020 2020 2020 2020 2020 2061 7373 6572             asser
+0000b480: 7420 6431 5f6d 6574 6164 6174 615b 2270  t d1_metadata["p
+0000b490: 6f73 6974 696f 6e22 5d20 3d3d 2031 0a20  osition"] == 1. 
+0000b4a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000b4b0: 2020 2061 7373 6572 7420 6365 6c6c 5f64     assert cell_d
+0000b4c0: 6174 615b 2265 7865 6375 7469 6f6e 5f63  ata["execution_c
+0000b4d0: 6f75 6e74 225d 203d 3d20 6578 6563 7574  ount"] == execut
+0000b4e0: 696f 6e5f 636f 756e 740a 2020 2020 2020  ion_count.      
+0000b4f0: 2020 2020 2020 2020 2020 2020 2020 6365                ce
+0000b500: 6c6c 203d 2064 6174 615b 2263 656c 6c5f  ll = data["cell_
+0000b510: 7570 6461 7465 225d 5b30 5d0a 2020 2020  update"][0].    
+0000b520: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000b530: 6173 7365 7274 2063 656c 6c5b 2263 656c  assert cell["cel
+0000b540: 6c5f 7479 7065 225d 203d 3d20 2263 6f64  l_type"] == "cod
+0000b550: 6522 0a20 2020 2020 2020 2020 2020 2020  e".             
+0000b560: 2020 2020 2020 2061 7373 6572 7420 6c65         assert le
+0000b570: 6e28 6365 6c6c 5b22 6f75 7470 7574 7322  n(cell["outputs"
+0000b580: 5d29 203d 3d20 300a 2020 2020 2020 2020  ]) == 0.        
+0000b590: 2020 2020 2020 2020 2020 2020 7265 7475              retu
+0000b5a0: 726e 204e 6f6e 650a 2020 2020 2020 2020  rn None.        
+0000b5b0: 2020 2020 2020 2020 656c 6966 2022 6365          elif "ce
+0000b5c0: 6c6c 5f65 7865 6375 7469 6f6e 5f72 6570  ll_execution_rep
+0000b5d0: 6c79 2220 696e 2064 6174 613a 0a20 2020  ly" in data:.   
+0000b5e0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000b5f0: 2061 7373 6572 7420 6461 7461 5b22 6365   assert data["ce
+0000b600: 6c6c 5f65 7865 6375 7469 6f6e 5f72 6570  ll_execution_rep
+0000b610: 6c79 225d 5b22 6578 6563 7574 696f 6e5f  ly"]["execution_
+0000b620: 636f 756e 7422 5d20 3d3d 2031 0a20 2020  count"] == 1.   
+0000b630: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000b640: 2061 7373 6572 7420 6461 7461 5b22 6365   assert data["ce
+0000b650: 6c6c 5f65 7865 6375 7469 6f6e 5f72 6570  ll_execution_rep
+0000b660: 6c79 225d 5b22 6365 6c6c 5f69 6422 5d20  ly"]["cell_id"] 
+0000b670: 3d3d 2063 656c 6c5f 7575 6964 0a20 2020  == cell_uuid.   
+0000b680: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000b690: 2061 7373 6572 7420 280a 2020 2020 2020   assert (.      
+0000b6a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000b6b0: 2020 6c65 6e28 6461 7461 5b22 6365 6c6c    len(data["cell
+0000b6c0: 5f65 7865 6375 7469 6f6e 5f72 6570 6c79  _execution_reply
+0000b6d0: 225d 5b22 7061 7265 6e74 5f69 6422 5d29  "]["parent_id"])
+0000b6e0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+0000b6f0: 2020 2020 2020 2020 2069 6e20 6d73 675f           in msg_
+0000b700: 6964 5f6c 656e 6774 6873 0a20 2020 2020  id_lengths.     
+0000b710: 2020 2020 2020 2020 2020 2020 2020 2029                 )
+0000b720: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+0000b730: 2020 2020 2061 7373 6572 7420 6461 7461       assert data
+0000b740: 5b22 6365 6c6c 5f65 7865 6375 7469 6f6e  ["cell_execution
+0000b750: 5f72 6570 6c79 225d 5b22 7061 7265 6e74  _reply"]["parent
+0000b760: 5f69 6422 5d20 3d3d 206d 7367 5f69 640a  _id"] == msg_id.
+0000b770: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000b780: 2020 2020 7265 7475 726e 2031 0a20 2020      return 1.   
+0000b790: 2020 2020 2020 2020 2020 2020 2065 6c73               els
+0000b7a0: 653a 0a20 2020 2020 2020 2020 2020 2020  e:.             
+0000b7b0: 2020 2020 2020 2072 6169 7365 2041 7373         raise Ass
+0000b7c0: 6572 7469 6f6e 4572 726f 7228 6622 756e  ertionError(f"un
+0000b7d0: 6578 7065 6374 6564 2063 656c 6c20 7479  expected cell ty
+0000b7e0: 7065 3a20 7b64 6174 617d 2229 0a0a 2020  pe: {data}")..  
+0000b7f0: 2020 2020 2020 2020 2020 6d73 675f 7479            msg_ty
+0000b800: 7065 7320 3d20 5b0a 2020 2020 2020 2020  pes = [.        
+0000b810: 2020 2020 2020 2020 2263 656c 6c5f 7570          "cell_up
+0000b820: 6461 7465 222c 0a20 2020 2020 2020 2020  date",.         
+0000b830: 2020 2020 2020 2022 6365 6c6c 5f65 7865         "cell_exe
+0000b840: 6375 7469 6f6e 5f72 6570 6c79 222c 0a20  cution_reply",. 
+0000b850: 2020 2020 2020 2020 2020 205d 0a0a 2020             ]..  
+0000b860: 2020 2020 2020 2020 2020 6461 7461 203d            data =
+0000b870: 2061 7761 6974 2072 6563 6569 7665 5f6a   await receive_j
+0000b880: 736f 6e28 7765 6273 6f63 6b65 742c 206d  son(websocket, m
+0000b890: 7367 5f74 7970 6573 3d6d 7367 5f74 7970  sg_types=msg_typ
+0000b8a0: 6573 290a 2020 2020 2020 2020 2020 2020  es).            
+0000b8b0: 6578 6563 5f63 6f75 6e74 203d 2061 7373  exec_count = ass
+0000b8c0: 6572 745f 6a73 6f6e 5f63 6f6e 7465 6e74  ert_json_content
+0000b8d0: 2864 6174 6129 0a20 2020 2020 2020 2020  (data).         
+0000b8e0: 2020 2064 6174 6120 3d20 6177 6169 7420     data = await 
+0000b8f0: 7265 6365 6976 655f 6a73 6f6e 2877 6562  receive_json(web
+0000b900: 736f 636b 6574 2c20 6d73 675f 7479 7065  socket, msg_type
+0000b910: 733d 6d73 675f 7479 7065 7329 0a20 2020  s=msg_types).   
+0000b920: 2020 2020 2020 2020 2061 7373 6572 745f           assert_
+0000b930: 6a73 6f6e 5f63 6f6e 7465 6e74 2864 6174  json_content(dat
+0000b940: 612c 2065 7865 635f 636f 756e 7429 0a0a  a, exec_count)..
+0000b950: 2020 2020 2020 2020 2020 2020 2320 5374              # St
+0000b960: 696c 6c20 6275 7379 2077 6974 6820 6f75  ill busy with ou
+0000b970: 7470 7574 2c20 6572 726f 7220 6f75 7470  tput, error outp
+0000b980: 7574 2072 6563 6569 7665 640a 2020 2020  ut received.    
+0000b990: 2020 2020 2020 2020 6461 7461 203d 2061          data = a
+0000b9a0: 7761 6974 2072 6563 6569 7665 5f6a 736f  wait receive_jso
+0000b9b0: 6e28 7765 6273 6f63 6b65 742c 206d 7367  n(websocket, msg
+0000b9c0: 5f74 7970 6573 3d5b 2263 656c 6c5f 7570  _types=["cell_up
+0000b9d0: 6461 7465 225d 290a 2020 2020 2020 2020  date"]).        
+0000b9e0: 2020 2020 6431 5f6d 6574 6164 6174 6120      d1_metadata 
+0000b9f0: 3d20 6461 7461 5b22 6365 6c6c 5f75 7064  = data["cell_upd
+0000ba00: 6174 6522 5d5b 305d 5b22 6d65 7461 6461  ate"][0]["metada
+0000ba10: 7461 225d 5b22 6a75 7079 7465 725f 6431  ta"]["jupyter_d1
+0000ba20: 225d 0a20 2020 2020 2020 2020 2020 2061  "].            a
+0000ba30: 7373 6572 7420 6431 5f6d 6574 6164 6174  ssert d1_metadat
+0000ba40: 615b 2265 7865 6375 7469 6f6e 5f73 7461  a["execution_sta
+0000ba50: 7465 225d 203d 3d20 2262 7573 7922 0a20  te"] == "busy". 
+0000ba60: 2020 2020 2020 2020 2020 2061 7373 6572             asser
+0000ba70: 7420 6461 7461 5b22 6365 6c6c 5f75 7064  t data["cell_upd
+0000ba80: 6174 6522 5d5b 305d 5b22 6578 6563 7574  ate"][0]["execut
+0000ba90: 696f 6e5f 636f 756e 7422 5d20 6973 204e  ion_count"] is N
+0000baa0: 6f6e 650a 2020 2020 2020 2020 2020 2020  one.            
+0000bab0: 6173 7365 7274 2064 315f 6d65 7461 6461  assert d1_metada
+0000bac0: 7461 5b22 706f 7369 7469 6f6e 225d 203d  ta["position"] =
+0000bad0: 3d20 310a 2020 2020 2020 2020 2020 2020  = 1.            
+0000bae0: 6173 7365 7274 2064 315f 6d65 7461 6461  assert d1_metada
+0000baf0: 7461 5b22 7575 6964 225d 203d 3d20 6365  ta["uuid"] == ce
+0000bb00: 6c6c 5f75 7569 640a 2020 2020 2020 2020  ll_uuid.        
+0000bb10: 2020 2020 6365 6c6c 203d 2064 6174 615b      cell = data[
+0000bb20: 2263 656c 6c5f 7570 6461 7465 225d 5b30  "cell_update"][0
+0000bb30: 5d0a 2020 2020 2020 2020 2020 2020 6173  ].            as
+0000bb40: 7365 7274 2063 656c 6c5b 2263 656c 6c5f  sert cell["cell_
+0000bb50: 7479 7065 225d 203d 3d20 2263 6f64 6522  type"] == "code"
+0000bb60: 0a20 2020 2020 2020 2020 2020 2061 7373  .            ass
+0000bb70: 6572 7420 6c65 6e28 6365 6c6c 5b22 6f75  ert len(cell["ou
+0000bb80: 7470 7574 7322 5d29 203d 3d20 310a 2020  tputs"]) == 1.  
+0000bb90: 2020 2020 2020 2020 2020 6173 7365 7274            assert
+0000bba0: 2063 656c 6c5b 226f 7574 7075 7473 225d   cell["outputs"]
+0000bbb0: 5b30 5d5b 2265 6e61 6d65 225d 203d 3d20  [0]["ename"] == 
+0000bbc0: 2253 796e 7461 7845 7272 6f72 220a 2020  "SyntaxError".  
+0000bbd0: 2020 2020 2020 2020 2020 6173 7365 7274            assert
+0000bbe0: 2022 5379 6e74 6178 4572 726f 7222 2069   "SyntaxError" i
+0000bbf0: 6e20 6365 6c6c 5b22 6f75 7470 7574 7322  n cell["outputs"
+0000bc00: 5d5b 305d 5b22 7472 6163 6562 6163 6b22  ][0]["traceback"
+0000bc10: 5d5b 305d 0a0a 2020 2020 2020 2020 2020  ][0]..          
+0000bc20: 2020 2320 4b65 726e 656c 2076 6172 7320    # Kernel vars 
+0000bc30: 7570 6461 7465 0a20 2020 2020 2020 2020  update.         
+0000bc40: 2020 2064 6174 6120 3d20 6177 6169 7420     data = await 
+0000bc50: 7265 6365 6976 655f 6a73 6f6e 2877 6562  receive_json(web
+0000bc60: 736f 636b 6574 2c20 6d73 675f 7479 7065  socket, msg_type
+0000bc70: 733d 5b22 7661 7273 225d 290a 2020 2020  s=["vars"]).    
+0000bc80: 2020 2020 2020 2020 6173 7365 7274 2022          assert "
+0000bc90: 7661 7273 2220 696e 2064 6174 610a 0a20  vars" in data.. 
+0000bca0: 2020 2040 7079 7465 7374 2e6d 6172 6b2e     @pytest.mark.
+0000bcb0: 6173 796e 6369 6f0a 2020 2020 6173 796e  asyncio.    asyn
+0000bcc0: 6320 6465 6620 7465 7374 5f73 6372 6174  c def test_scrat
+0000bcd0: 6368 5f65 7865 6375 7465 280a 2020 2020  ch_execute(.    
+0000bce0: 2020 2020 7365 6c66 2c0a 2020 2020 2020      self,.      
+0000bcf0: 2020 636c 6965 6e74 3a20 5465 7374 436c    client: TestCl
+0000bd00: 6965 6e74 2c0a 2020 2020 2020 2020 7265  ient,.        re
+0000bd10: 6164 6f6e 6c79 5f74 6f6b 656e 5f68 6561  adonly_token_hea
+0000bd20: 6465 7273 3a20 4469 6374 5b73 7472 2c20  ders: Dict[str, 
+0000bd30: 7374 725d 2c0a 2020 2020 2020 2020 7065  str],.        pe
+0000bd40: 726d 6973 7369 6f6e 6c65 7373 5f74 6f6b  rmissionless_tok
+0000bd50: 656e 5f68 6561 6465 7273 3a20 4469 6374  en_headers: Dict
+0000bd60: 5b73 7472 2c20 7374 725d 2c0a 2020 2020  [str, str],.    
+0000bd70: 2020 2020 7375 7065 7275 7365 725f 746f      superuser_to
+0000bd80: 6b65 6e5f 6865 6164 6572 733a 2044 6963  ken_headers: Dic
+0000bd90: 745b 7374 722c 2073 7472 5d2c 0a20 2020  t[str, str],.   
+0000bda0: 2029 3a0a 2020 2020 2020 2020 7575 6964   ):.        uuid
+0000bdb0: 203d 2061 7761 6974 2075 706c 6f61 645f   = await upload_
+0000bdc0: 6e6f 7465 626f 6f6b 280a 2020 2020 2020  notebook(.      
+0000bdd0: 2020 2020 2020 636c 6965 6e74 2c20 7375        client, su
+0000bde0: 7065 7275 7365 725f 746f 6b65 6e5f 6865  peruser_token_he
+0000bdf0: 6164 6572 732c 2022 7369 6d70 6c65 2e69  aders, "simple.i
+0000be00: 7079 6e62 220a 2020 2020 2020 2020 290a  pynb".        ).
+0000be10: 0a20 2020 2020 2020 2061 7379 6e63 2077  .        async w
+0000be20: 6974 6820 636c 6965 6e74 2e77 6562 736f  ith client.webso
+0000be30: 636b 6574 5f63 6f6e 6e65 6374 280a 2020  cket_connect(.  
+0000be40: 2020 2020 2020 2020 2020 6622 2f6e 6f74            f"/not
+0000be50: 6562 6f6f 6b73 2f7b 7575 6964 7d2f 7773  ebooks/{uuid}/ws
+0000be60: 2f6e 6f74 6562 6f6f 6b22 2c20 6865 6164  /notebook", head
+0000be70: 6572 733d 7375 7065 7275 7365 725f 746f  ers=superuser_to
+0000be80: 6b65 6e5f 6865 6164 6572 730a 2020 2020  ken_headers.    
+0000be90: 2020 2020 2920 6173 2077 6562 736f 636b      ) as websock
+0000bea0: 6574 3a0a 2020 2020 2020 2020 2020 2020  et:.            
+0000beb0: 6177 6169 7420 6173 796e 6369 6f2e 736c  await asyncio.sl
+0000bec0: 6565 7028 5745 4253 4f43 4b45 545f 534c  eep(WEBSOCKET_SL
+0000bed0: 4545 505f 5449 4d45 290a 0a20 2020 2020  EEP_TIME)..     
+0000bee0: 2020 2020 2020 2072 6573 706f 6e73 6520         response 
+0000bef0: 3d20 6177 6169 7420 636c 6965 6e74 2e70  = await client.p
+0000bf00: 6f73 7428 0a20 2020 2020 2020 2020 2020  ost(.           
+0000bf10: 2020 2020 2066 222f 6e6f 7465 626f 6f6b       f"/notebook
+0000bf20: 732f 7b75 7569 647d 2f73 6372 6174 6368  s/{uuid}/scratch
+0000bf30: 5f65 7865 6375 7465 222c 0a20 2020 2020  _execute",.     
+0000bf40: 2020 2020 2020 2020 2020 2068 6561 6465             heade
+0000bf50: 7273 3d73 7570 6572 7573 6572 5f74 6f6b  rs=superuser_tok
+0000bf60: 656e 5f68 6561 6465 7273 2c0a 2020 2020  en_headers,.    
+0000bf70: 2020 2020 2020 2020 2020 2020 6a73 6f6e              json
+0000bf80: 3d7b 2263 6f64 6522 3a20 2234 2a35 227d  ={"code": "4*5"}
+0000bf90: 2c0a 2020 2020 2020 2020 2020 2020 290a  ,.            ).
+0000bfa0: 2020 2020 2020 2020 2020 2020 6173 7365              asse
+0000bfb0: 7274 2072 6573 706f 6e73 652e 7374 6174  rt response.stat
+0000bfc0: 7573 5f63 6f64 6520 3d3d 2032 3030 0a20  us_code == 200. 
+0000bfd0: 2020 2020 2020 2020 2020 206d 6573 7361             messa
+0000bfe0: 6765 5f69 6420 3d20 7265 7370 6f6e 7365  ge_id = response
+0000bff0: 2e6a 736f 6e28 295b 226b 6572 6e65 6c5f  .json()["kernel_
+0000c000: 6d65 7373 6167 6522 5d5b 226d 6573 7361  message"]["messa
+0000c010: 6765 5f69 6422 5d0a 0a20 2020 2020 2020  ge_id"]..       
+0000c020: 2020 2020 2023 2066 6972 7374 2063 6875       # first chu
+0000c030: 6e6b 2072 6563 6569 7665 6420 7368 6f75  nk received shou
+0000c040: 6c64 2062 6520 6120 7363 7261 7463 685f  ld be a scratch_
+0000c050: 7570 6461 7465 2077 6974 680a 2020 2020  update with.    
+0000c060: 2020 2020 2020 2020 2320 616e 2065 7865          # an exe
+0000c070: 6375 7469 6f6e 5f73 7461 7465 206f 6620  cution_state of 
+0000c080: 2762 7573 7927 2077 6865 6e20 7072 6f63  'busy' when proc
+0000c090: 6573 7369 6e67 2073 7461 7274 730a 2020  essing starts.  
+0000c0a0: 2020 2020 2020 2020 2020 6461 7461 203d            data =
+0000c0b0: 2061 7761 6974 2072 6563 6569 7665 5f6a   await receive_j
+0000c0c0: 736f 6e28 7765 6273 6f63 6b65 742c 206d  son(websocket, m
+0000c0d0: 7367 5f74 7970 6573 3d5b 2273 6372 6174  sg_types=["scrat
+0000c0e0: 6368 5f75 7064 6174 6522 5d29 0a20 2020  ch_update"]).   
+0000c0f0: 2020 2020 2020 2020 2073 6372 6174 6368           scratch
+0000c100: 5f75 7064 6174 6520 3d20 6461 7461 5b22  _update = data["
+0000c110: 7363 7261 7463 685f 7570 6461 7465 225d  scratch_update"]
+0000c120: 0a20 2020 2020 2020 2020 2020 2061 7373  .            ass
+0000c130: 6572 7420 7363 7261 7463 685f 7570 6461  ert scratch_upda
+0000c140: 7465 5b22 6d65 7373 6167 655f 6964 225d  te["message_id"]
+0000c150: 203d 3d20 6d65 7373 6167 655f 6964 0a20   == message_id. 
+0000c160: 2020 2020 2020 2020 2020 2061 7373 6572             asser
+0000c170: 7420 7363 7261 7463 685f 7570 6461 7465  t scratch_update
+0000c180: 5b22 6578 6563 7574 696f 6e5f 7374 6174  ["execution_stat
+0000c190: 6522 5d20 3d3d 2022 6275 7379 220a 0a20  e"] == "busy".. 
+0000c1a0: 2020 2020 2020 2020 2020 2023 2052 6563             # Rec
+0000c1b0: 6569 7665 2073 6372 6174 6368 2065 7865  eive scratch exe
+0000c1c0: 6375 7469 6f6e 206f 7574 7075 740a 2020  cution output.  
+0000c1d0: 2020 2020 2020 2020 2020 6461 7461 203d            data =
+0000c1e0: 2061 7761 6974 2072 6563 6569 7665 5f6a   await receive_j
+0000c1f0: 736f 6e28 7765 6273 6f63 6b65 742c 206d  son(websocket, m
+0000c200: 7367 5f74 7970 6573 3d5b 2273 6372 6174  sg_types=["scrat
+0000c210: 6368 5f75 7064 6174 6522 5d29 0a20 2020  ch_update"]).   
+0000c220: 2020 2020 2020 2020 2073 6372 6174 6368           scratch
+0000c230: 5f75 7064 6174 6520 3d20 6461 7461 5b22  _update = data["
+0000c240: 7363 7261 7463 685f 7570 6461 7465 225d  scratch_update"]
+0000c250: 0a20 2020 2020 2020 2020 2020 2065 7870  .            exp
+0000c260: 6563 7465 645f 6f75 7470 7574 203d 207b  ected_output = {
+0000c270: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+0000c280: 2022 6461 7461 223a 207b 2274 6578 742f   "data": {"text/
+0000c290: 706c 6169 6e22 3a20 2232 3022 7d2c 0a20  plain": "20"},. 
+0000c2a0: 2020 2020 2020 2020 2020 2020 2020 2022                 "
+0000c2b0: 6578 6563 7574 696f 6e5f 636f 756e 7422  execution_count"
+0000c2c0: 3a20 312c 0a20 2020 2020 2020 2020 2020  : 1,.           
+0000c2d0: 2020 2020 2022 6d65 7461 6461 7461 223a       "metadata":
+0000c2e0: 207b 7d2c 0a20 2020 2020 2020 2020 2020   {},.           
+0000c2f0: 2020 2020 2022 6f75 7470 7574 5f74 7970       "output_typ
+0000c300: 6522 3a20 2265 7865 6375 7465 5f72 6573  e": "execute_res
+0000c310: 756c 7422 2c0a 2020 2020 2020 2020 2020  ult",.          
+0000c320: 2020 7d0a 2020 2020 2020 2020 2020 2020    }.            
+0000c330: 6173 7365 7274 2073 6372 6174 6368 5f75  assert scratch_u
+0000c340: 7064 6174 655b 226f 7574 7075 7422 5d20  pdate["output"] 
+0000c350: 3d3d 2065 7870 6563 7465 645f 6f75 7470  == expected_outp
+0000c360: 7574 0a0a 2020 2020 2020 2020 2020 2020  ut..            
+0000c370: 2320 5363 7261 7463 6820 6578 6563 7574  # Scratch execut
+0000c380: 696f 6e20 7374 6174 6520 7365 7420 746f  ion state set to
+0000c390: 2069 646c 650a 2020 2020 2020 2020 2020   idle.          
+0000c3a0: 2020 6461 7461 203d 2061 7761 6974 2072    data = await r
+0000c3b0: 6563 6569 7665 5f6a 736f 6e28 7765 6273  eceive_json(webs
+0000c3c0: 6f63 6b65 742c 206d 7367 5f74 7970 6573  ocket, msg_types
+0000c3d0: 3d5b 2273 6372 6174 6368 5f75 7064 6174  =["scratch_updat
+0000c3e0: 6522 5d29 0a20 2020 2020 2020 2020 2020  e"]).           
+0000c3f0: 2073 6372 6174 6368 5f75 7064 6174 6520   scratch_update 
+0000c400: 3d20 6461 7461 5b22 7363 7261 7463 685f  = data["scratch_
+0000c410: 7570 6461 7465 225d 0a20 2020 2020 2020  update"].       
+0000c420: 2020 2020 2061 7373 6572 7420 7363 7261       assert scra
+0000c430: 7463 685f 7570 6461 7465 5b22 6d65 7373  tch_update["mess
+0000c440: 6167 655f 6964 225d 203d 3d20 6d65 7373  age_id"] == mess
+0000c450: 6167 655f 6964 0a20 2020 2020 2020 2020  age_id.         
+0000c460: 2020 2061 7373 6572 7420 7363 7261 7463     assert scratc
+0000c470: 685f 7570 6461 7465 5b22 6578 6563 7574  h_update["execut
+0000c480: 696f 6e5f 7374 6174 6522 5d20 3d3d 2022  ion_state"] == "
+0000c490: 6964 6c65 220a 0a20 2020 2040 7079 7465  idle"..    @pyte
+0000c4a0: 7374 2e6d 6172 6b2e 6173 796e 6369 6f0a  st.mark.asyncio.
+0000c4b0: 2020 2020 6173 796e 6320 6465 6620 7465      async def te
+0000c4c0: 7374 5f73 6372 6174 6368 5f63 6f64 655f  st_scratch_code_
+0000c4d0: 6964 6c65 5f73 7461 7475 7328 0a20 2020  idle_status(.   
+0000c4e0: 2020 2020 2073 656c 662c 2063 6c69 656e       self, clien
+0000c4f0: 743a 2054 6573 7443 6c69 656e 742c 2073  t: TestClient, s
+0000c500: 7570 6572 7573 6572 5f74 6f6b 656e 5f68  uperuser_token_h
+0000c510: 6561 6465 7273 3a20 4469 6374 5b73 7472  eaders: Dict[str
+0000c520: 2c20 7374 725d 0a20 2020 2029 3a0a 2020  , str].    ):.  
+0000c530: 2020 2020 2020 6173 796e 6320 6465 6620        async def 
+0000c540: 6973 5f69 646c 655f 7374 6174 7573 2829  is_idle_status()
+0000c550: 3a0a 2020 2020 2020 2020 2020 2020 7265  :.            re
+0000c560: 7370 6f6e 7365 203d 2061 7761 6974 2063  sponse = await c
+0000c570: 6c69 656e 742e 6765 7428 0a20 2020 2020  lient.get(.     
+0000c580: 2020 2020 2020 2020 2020 2066 222f 6b65             f"/ke
+0000c590: 726e 656c 732f 6964 6c65 222c 2068 6561  rnels/idle", hea
+0000c5a0: 6465 7273 3d73 7570 6572 7573 6572 5f74  ders=superuser_t
+0000c5b0: 6f6b 656e 5f68 6561 6465 7273 0a20 2020  oken_headers.   
+0000c5c0: 2020 2020 2020 2020 2029 0a20 2020 2020           ).     
+0000c5d0: 2020 2020 2020 2061 7373 6572 7420 7265         assert re
+0000c5e0: 7370 6f6e 7365 2e73 7461 7475 735f 636f  sponse.status_co
+0000c5f0: 6465 203d 3d20 3230 300a 2020 2020 2020  de == 200.      
+0000c600: 2020 2020 2020 6a73 6f6e 203d 2072 6573        json = res
+0000c610: 706f 6e73 652e 6a73 6f6e 2829 0a20 2020  ponse.json().   
+0000c620: 2020 2020 2020 2020 2072 6574 7572 6e20           return 
+0000c630: 280a 2020 2020 2020 2020 2020 2020 2020  (.              
+0000c640: 2020 6a73 6f6e 5b22 6964 6c65 225d 2c0a    json["idle"],.
+0000c650: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000c660: 6461 7465 7469 6d65 2e73 7472 7074 696d  datetime.strptim
+0000c670: 6528 6a73 6f6e 5b22 6c61 7374 5f69 646c  e(json["last_idl
+0000c680: 6522 5d2c 2022 2559 2d25 6d2d 2564 5425  e"], "%Y-%m-%dT%
+0000c690: 483a 254d 3a25 532e 2566 2229 2c0a 2020  H:%M:%S.%f"),.  
+0000c6a0: 2020 2020 2020 2020 2020 290a 0a20 2020            )..   
+0000c6b0: 2020 2020 2023 204b 6572 6e65 6c20 6973       # Kernel is
+0000c6c0: 2069 646c 650a 2020 2020 2020 2020 6973   idle.        is
+0000c6d0: 5f69 646c 652c 206c 6173 745f 6964 6c65  _idle, last_idle
+0000c6e0: 5f31 203d 2061 7761 6974 2069 735f 6964  _1 = await is_id
+0000c6f0: 6c65 5f73 7461 7475 7328 290a 2020 2020  le_status().    
+0000c700: 2020 2020 6173 7365 7274 2069 735f 6964      assert is_id
+0000c710: 6c65 2069 7320 5472 7565 0a0a 2020 2020  le is True..    
+0000c720: 2020 2020 7575 6964 203d 2061 7761 6974      uuid = await
+0000c730: 2075 706c 6f61 645f 6e6f 7465 626f 6f6b   upload_notebook
+0000c740: 280a 2020 2020 2020 2020 2020 2020 636c  (.            cl
+0000c750: 6965 6e74 2c20 7375 7065 7275 7365 725f  ient, superuser_
+0000c760: 746f 6b65 6e5f 6865 6164 6572 732c 2022  token_headers, "
+0000c770: 7369 6d70 6c65 2e69 7079 6e62 220a 2020  simple.ipynb".  
+0000c780: 2020 2020 2020 290a 0a20 2020 2020 2020        )..       
+0000c790: 2023 204b 6572 6e65 6c20 6973 2073 7469   # Kernel is sti
+0000c7a0: 6c6c 2069 646c 650a 2020 2020 2020 2020  ll idle.        
+0000c7b0: 6973 5f69 646c 652c 206c 6173 745f 6964  is_idle, last_id
+0000c7c0: 6c65 5f32 203d 2061 7761 6974 2069 735f  le_2 = await is_
+0000c7d0: 6964 6c65 5f73 7461 7475 7328 290a 2020  idle_status().  
+0000c7e0: 2020 2020 2020 6173 7365 7274 2069 735f        assert is_
+0000c7f0: 6964 6c65 2069 7320 5472 7565 0a20 2020  idle is True.   
+0000c800: 2020 2020 2061 7373 6572 7420 6c61 7374       assert last
+0000c810: 5f69 646c 655f 3120 3d3d 206c 6173 745f  _idle_1 == last_
+0000c820: 6964 6c65 5f32 0a0a 2020 2020 2020 2020  idle_2..        
+0000c830: 6173 796e 6320 7769 7468 2063 6c69 656e  async with clien
+0000c840: 742e 7765 6273 6f63 6b65 745f 636f 6e6e  t.websocket_conn
+0000c850: 6563 7428 0a20 2020 2020 2020 2020 2020  ect(.           
+0000c860: 2066 222f 6e6f 7465 626f 6f6b 732f 7b75   f"/notebooks/{u
+0000c870: 7569 647d 2f77 732f 6e6f 7465 626f 6f6b  uid}/ws/notebook
+0000c880: 222c 2068 6561 6465 7273 3d73 7570 6572  ", headers=super
+0000c890: 7573 6572 5f74 6f6b 656e 5f68 6561 6465  user_token_heade
+0000c8a0: 7273 0a20 2020 2020 2020 2029 2061 7320  rs.        ) as 
+0000c8b0: 7765 6273 6f63 6b65 743a 0a20 2020 2020  websocket:.     
+0000c8c0: 2020 2020 2020 2061 7761 6974 2061 7379         await asy
+0000c8d0: 6e63 696f 2e73 6c65 6570 2857 4542 534f  ncio.sleep(WEBSO
+0000c8e0: 434b 4554 5f53 4c45 4550 5f54 494d 4529  CKET_SLEEP_TIME)
+0000c8f0: 0a0a 2020 2020 2020 2020 2020 2020 7265  ..            re
+0000c900: 7370 6f6e 7365 203d 2061 7761 6974 2063  sponse = await c
+0000c910: 6c69 656e 742e 706f 7374 280a 2020 2020  lient.post(.    
+0000c920: 2020 2020 2020 2020 2020 2020 6622 2f6e              f"/n
+0000c930: 6f74 6562 6f6f 6b73 2f7b 7575 6964 7d2f  otebooks/{uuid}/
+0000c940: 7363 7261 7463 685f 6578 6563 7574 6522  scratch_execute"
+0000c950: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
+0000c960: 2020 6865 6164 6572 733d 7375 7065 7275    headers=superu
+0000c970: 7365 725f 746f 6b65 6e5f 6865 6164 6572  ser_token_header
+0000c980: 732c 0a20 2020 2020 2020 2020 2020 2020  s,.             
+0000c990: 2020 206a 736f 6e3d 7b22 636f 6465 223a     json={"code":
+0000c9a0: 2022 342b 3922 7d2c 0a20 2020 2020 2020   "4+9"},.       
+0000c9b0: 2020 2020 2029 0a20 2020 2020 2020 2020       ).         
+0000c9c0: 2020 2061 7373 6572 7420 7265 7370 6f6e     assert respon
+0000c9d0: 7365 2e73 7461 7475 735f 636f 6465 203d  se.status_code =
+0000c9e0: 3d20 3230 300a 2020 2020 2020 2020 2020  = 200.          
+0000c9f0: 2020 6d65 7373 6167 655f 6964 203d 2072    message_id = r
+0000ca00: 6573 706f 6e73 652e 6a73 6f6e 2829 5b22  esponse.json()["
+0000ca10: 6b65 726e 656c 5f6d 6573 7361 6765 225d  kernel_message"]
+0000ca20: 5b22 6d65 7373 6167 655f 6964 225d 0a0a  ["message_id"]..
+0000ca30: 2020 2020 2020 2020 2020 2020 2320 4578              # Ex
+0000ca40: 6563 7574 696f 6e20 7374 6174 6520 6275  ecution state bu
+0000ca50: 7379 0a20 2020 2020 2020 2020 2020 2061  sy.            a
+0000ca60: 7761 6974 2072 6563 6569 7665 5f6a 736f  wait receive_jso
+0000ca70: 6e28 7765 6273 6f63 6b65 742c 206d 7367  n(websocket, msg
+0000ca80: 5f74 7970 6573 3d5b 2273 6372 6174 6368  _types=["scratch
+0000ca90: 5f75 7064 6174 6522 5d29 0a20 2020 2020  _update"]).     
+0000caa0: 2020 2020 2020 2023 2045 7865 6375 7469         # Executi
+0000cab0: 6f6e 206f 7574 7075 740a 2020 2020 2020  on output.      
+0000cac0: 2020 2020 2020 6177 6169 7420 7265 6365        await rece
+0000cad0: 6976 655f 6a73 6f6e 2877 6562 736f 636b  ive_json(websock
+0000cae0: 6574 2c20 6d73 675f 7479 7065 733d 5b22  et, msg_types=["
+0000caf0: 7363 7261 7463 685f 7570 6461 7465 225d  scratch_update"]
+0000cb00: 290a 2020 2020 2020 2020 2020 2020 2320  ).            # 
+0000cb10: 4578 6563 7574 696f 6e20 7374 6174 6520  Execution state 
+0000cb20: 6964 6c65 0a20 2020 2020 2020 2020 2020  idle.           
+0000cb30: 2061 7761 6974 2072 6563 6569 7665 5f6a   await receive_j
+0000cb40: 736f 6e28 7765 6273 6f63 6b65 742c 206d  son(websocket, m
+0000cb50: 7367 5f74 7970 6573 3d5b 2273 6372 6174  sg_types=["scrat
+0000cb60: 6368 5f75 7064 6174 6522 5d29 0a0a 2020  ch_update"])..  
+0000cb70: 2020 2020 2020 2020 2020 2320 4b65 726e            # Kern
+0000cb80: 656c 2069 7320 7374 696c 6c20 6964 6c65  el is still idle
+0000cb90: 2028 6e6f 2063 6f64 6520 7275 6e6e 696e   (no code runnin
+0000cba0: 6729 0a20 2020 2020 2020 2020 2020 2069  g).            i
+0000cbb0: 735f 6964 6c65 2c20 6c61 7374 5f69 646c  s_idle, last_idl
+0000cbc0: 655f 3320 3d20 6177 6169 7420 6973 5f69  e_3 = await is_i
+0000cbd0: 646c 655f 7374 6174 7573 2829 0a20 2020  dle_status().   
+0000cbe0: 2020 2020 2020 2020 2061 7373 6572 7420           assert 
+0000cbf0: 6973 5f69 646c 6520 6973 2054 7275 650a  is_idle is True.
+0000cc00: 2020 2020 2020 2020 2020 2020 6173 7365              asse
+0000cc10: 7274 206c 6173 745f 6964 6c65 5f33 203e  rt last_idle_3 >
+0000cc20: 206c 6173 745f 6964 6c65 5f32 0a0a 2020   last_idle_2..  
+0000cc30: 2020 2020 2020 2020 2020 2320 4b65 726e            # Kern
+0000cc40: 656c 2076 6172 7320 7570 6461 7465 0a20  el vars update. 
+0000cc50: 2020 2020 2020 2020 2020 2064 6174 6120             data 
+0000cc60: 3d20 6177 6169 7420 7265 6365 6976 655f  = await receive_
+0000cc70: 6a73 6f6e 2877 6562 736f 636b 6574 2c20  json(websocket, 
+0000cc80: 6d73 675f 7479 7065 733d 5b22 7661 7273  msg_types=["vars
+0000cc90: 225d 290a 2020 2020 2020 2020 2020 2020  "]).            
+0000cca0: 6173 7365 7274 2022 7661 7273 2220 696e  assert "vars" in
+0000ccb0: 2064 6174 610a 0a20 2020 2020 2020 2020   data..         
+0000ccc0: 2020 2072 6573 706f 6e73 6520 3d20 6177     response = aw
+0000ccd0: 6169 7420 636c 6965 6e74 2e70 6f73 7428  ait client.post(
+0000cce0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+0000ccf0: 2066 222f 6e6f 7465 626f 6f6b 732f 7b75   f"/notebooks/{u
+0000cd00: 7569 647d 2f73 6372 6174 6368 5f65 7865  uid}/scratch_exe
+0000cd10: 6375 7465 222c 0a20 2020 2020 2020 2020  cute",.         
+0000cd20: 2020 2020 2020 2068 6561 6465 7273 3d73         headers=s
+0000cd30: 7570 6572 7573 6572 5f74 6f6b 656e 5f68  uperuser_token_h
+0000cd40: 6561 6465 7273 2c0a 2020 2020 2020 2020  eaders,.        
+0000cd50: 2020 2020 2020 2020 6a73 6f6e 3d7b 0a20          json={. 
+0000cd60: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000cd70: 2020 2022 636f 6465 223a 2022 6672 6f6d     "code": "from
+0000cd80: 2074 696d 6520 696d 706f 7274 2073 6c65   time import sle
+0000cd90: 6570 5c6e 220a 2020 2020 2020 2020 2020  ep\n".          
+0000cda0: 2020 2020 2020 2020 2020 2277 6869 6c65            "while
+0000cdb0: 2054 7275 653a 5c6e 2020 2020 736c 6565   True:\n    slee
+0000cdc0: 7028 3129 220a 2020 2020 2020 2020 2020  p(1)".          
+0000cdd0: 2020 2020 2020 7d2c 0a20 2020 2020 2020        },.       
+0000cde0: 2020 2020 2029 0a20 2020 2020 2020 2020       ).         
+0000cdf0: 2020 2061 7373 6572 7420 7265 7370 6f6e     assert respon
+0000ce00: 7365 2e73 7461 7475 735f 636f 6465 203d  se.status_code =
+0000ce10: 3d20 3230 300a 2020 2020 2020 2020 2020  = 200.          
+0000ce20: 2020 6d65 7373 6167 655f 6964 203d 2072    message_id = r
+0000ce30: 6573 706f 6e73 652e 6a73 6f6e 2829 5b22  esponse.json()["
+0000ce40: 6b65 726e 656c 5f6d 6573 7361 6765 225d  kernel_message"]
+0000ce50: 5b22 6d65 7373 6167 655f 6964 225d 0a0a  ["message_id"]..
+0000ce60: 2020 2020 2020 2020 2020 2020 2320 6669              # fi
+0000ce70: 7273 7420 6368 756e 6b20 7265 6365 6976  rst chunk receiv
+0000ce80: 6564 2073 686f 756c 6420 6265 2061 2063  ed should be a c
+0000ce90: 656c 6c5f 7570 6461 7465 2077 6974 680a  ell_update with.
+0000cea0: 2020 2020 2020 2020 2020 2020 2320 616e              # an
+0000ceb0: 2065 7865 6375 7469 6f6e 5f73 7461 7465   execution_state
+0000cec0: 206f 6620 2762 7573 7927 2077 6865 6e20   of 'busy' when 
+0000ced0: 7072 6f63 6573 7369 6e67 2073 7461 7274  processing start
+0000cee0: 730a 2020 2020 2020 2020 2020 2020 6461  s.            da
+0000cef0: 7461 203d 2061 7761 6974 2077 6169 745f  ta = await wait_
+0000cf00: 666f 725f 6576 656e 7428 7765 6273 6f63  for_event(websoc
+0000cf10: 6b65 742c 2022 7363 7261 7463 685f 7570  ket, "scratch_up
+0000cf20: 6461 7465 2229 0a20 2020 2020 2020 2020  date").         
+0000cf30: 2020 2073 6372 6174 6368 5f75 7064 6174     scratch_updat
+0000cf40: 6520 3d20 6461 7461 5b22 7363 7261 7463  e = data["scratc
+0000cf50: 685f 7570 6461 7465 225d 0a20 2020 2020  h_update"].     
+0000cf60: 2020 2020 2020 2061 7373 6572 7420 7363         assert sc
+0000cf70: 7261 7463 685f 7570 6461 7465 5b22 6d65  ratch_update["me
+0000cf80: 7373 6167 655f 6964 225d 203d 3d20 6d65  ssage_id"] == me
+0000cf90: 7373 6167 655f 6964 0a20 2020 2020 2020  ssage_id.       
+0000cfa0: 2020 2020 2061 7373 6572 7420 7363 7261       assert scra
+0000cfb0: 7463 685f 7570 6461 7465 5b22 6578 6563  tch_update["exec
+0000cfc0: 7574 696f 6e5f 7374 6174 6522 5d20 3d3d  ution_state"] ==
+0000cfd0: 2022 6275 7379 220a 0a20 2020 2020 2020   "busy"..       
+0000cfe0: 2020 2020 2023 204b 6572 6e65 6c20 7368       # Kernel sh
+0000cff0: 6f75 6c64 206e 6f74 2062 6520 6964 6c65  ould not be idle
+0000d000: 206e 6f77 0a20 2020 2020 2020 2020 2020   now.           
+0000d010: 2069 735f 6964 6c65 2c20 6c61 7374 5f69   is_idle, last_i
+0000d020: 646c 655f 3420 3d20 6177 6169 7420 6973  dle_4 = await is
+0000d030: 5f69 646c 655f 7374 6174 7573 2829 0a20  _idle_status(). 
+0000d040: 2020 2020 2020 2020 2020 2061 7373 6572             asser
+0000d050: 7420 6973 5f69 646c 6520 6973 2046 616c  t is_idle is Fal
+0000d060: 7365 0a20 2020 2020 2020 2020 2020 2061  se.            a
+0000d070: 7373 6572 7420 6c61 7374 5f69 646c 655f  ssert last_idle_
+0000d080: 3420 3e20 6c61 7374 5f69 646c 655f 330a  4 > last_idle_3.
+0000d090: 0a20 2020 2040 7079 7465 7374 2e6d 6172  .    @pytest.mar
+0000d0a0: 6b2e 6173 796e 6369 6f0a 2020 2020 6173  k.asyncio.    as
+0000d0b0: 796e 6320 6465 6620 7465 7374 5f73 6372  ync def test_scr
+0000d0c0: 6174 6368 5f73 7472 6561 6d28 0a20 2020  atch_stream(.   
+0000d0d0: 2020 2020 2073 656c 662c 0a20 2020 2020       self,.     
+0000d0e0: 2020 2063 6c69 656e 743a 2054 6573 7443     client: TestC
+0000d0f0: 6c69 656e 742c 0a20 2020 2020 2020 2072  lient,.        r
+0000d100: 6561 646f 6e6c 795f 746f 6b65 6e5f 6865  eadonly_token_he
+0000d110: 6164 6572 733a 2044 6963 745b 7374 722c  aders: Dict[str,
+0000d120: 2073 7472 5d2c 0a20 2020 2020 2020 2070   str],.        p
+0000d130: 6572 6d69 7373 696f 6e6c 6573 735f 746f  ermissionless_to
+0000d140: 6b65 6e5f 6865 6164 6572 733a 2044 6963  ken_headers: Dic
+0000d150: 745b 7374 722c 2073 7472 5d2c 0a20 2020  t[str, str],.   
+0000d160: 2020 2020 2073 7570 6572 7573 6572 5f74       superuser_t
+0000d170: 6f6b 656e 5f68 6561 6465 7273 3a20 4469  oken_headers: Di
+0000d180: 6374 5b73 7472 2c20 7374 725d 2c0a 2020  ct[str, str],.  
+0000d190: 2020 293a 0a20 2020 2020 2020 2075 7569    ):.        uui
+0000d1a0: 6420 3d20 6177 6169 7420 7570 6c6f 6164  d = await upload
+0000d1b0: 5f6e 6f74 6562 6f6f 6b28 0a20 2020 2020  _notebook(.     
+0000d1c0: 2020 2020 2020 2063 6c69 656e 742c 2073         client, s
+0000d1d0: 7570 6572 7573 6572 5f74 6f6b 656e 5f68  uperuser_token_h
+0000d1e0: 6561 6465 7273 2c20 2273 696d 706c 652e  eaders, "simple.
+0000d1f0: 6970 796e 6222 0a20 2020 2020 2020 2029  ipynb".        )
+0000d200: 0a0a 2020 2020 2020 2020 6173 796e 6320  ..        async 
+0000d210: 7769 7468 2063 6c69 656e 742e 7765 6273  with client.webs
+0000d220: 6f63 6b65 745f 636f 6e6e 6563 7428 0a20  ocket_connect(. 
+0000d230: 2020 2020 2020 2020 2020 2066 222f 6e6f             f"/no
+0000d240: 7465 626f 6f6b 732f 7b75 7569 647d 2f77  tebooks/{uuid}/w
+0000d250: 732f 6e6f 7465 626f 6f6b 222c 2068 6561  s/notebook", hea
+0000d260: 6465 7273 3d73 7570 6572 7573 6572 5f74  ders=superuser_t
+0000d270: 6f6b 656e 5f68 6561 6465 7273 0a20 2020  oken_headers.   
+0000d280: 2020 2020 2029 2061 7320 7765 6273 6f63       ) as websoc
+0000d290: 6b65 743a 0a20 2020 2020 2020 2020 2020  ket:.           
+0000d2a0: 2061 7761 6974 2061 7379 6e63 696f 2e73   await asyncio.s
+0000d2b0: 6c65 6570 2857 4542 534f 434b 4554 5f53  leep(WEBSOCKET_S
+0000d2c0: 4c45 4550 5f54 494d 4529 0a0a 2020 2020  LEEP_TIME)..    
+0000d2d0: 2020 2020 2020 2020 7265 7370 6f6e 7365          response
+0000d2e0: 203d 2061 7761 6974 2063 6c69 656e 742e   = await client.
+0000d2f0: 706f 7374 280a 2020 2020 2020 2020 2020  post(.          
+0000d300: 2020 2020 2020 6622 2f6e 6f74 6562 6f6f        f"/noteboo
+0000d310: 6b73 2f7b 7575 6964 7d2f 7363 7261 7463  ks/{uuid}/scratc
+0000d320: 685f 6578 6563 7574 6522 2c0a 2020 2020  h_execute",.    
+0000d330: 2020 2020 2020 2020 2020 2020 6865 6164              head
+0000d340: 6572 733d 7375 7065 7275 7365 725f 746f  ers=superuser_to
+0000d350: 6b65 6e5f 6865 6164 6572 732c 0a20 2020  ken_headers,.   
+0000d360: 2020 2020 2020 2020 2020 2020 206a 736f               jso
+0000d370: 6e3d 7b0a 2020 2020 2020 2020 2020 2020  n={.            
+0000d380: 2020 2020 2020 2020 2263 6f64 6522 3a20          "code": 
+0000d390: 2269 6d70 6f72 7420 7469 6d65 5c6e 666f  "import time\nfo
+0000d3a0: 7220 6920 696e 2028 2768 6572 6573 272c  r i in ('heres',
+0000d3b0: 2027 6127 2c20 220a 2020 2020 2020 2020   'a', ".        
+0000d3c0: 2020 2020 2020 2020 2020 2020 2227 7374              "'st
+0000d3d0: 7265 616d 6f66 6461 7461 2729 3a5c 6e20  reamofdata'):\n 
+0000d3e0: 2020 2070 7269 6e74 2869 295c 6e20 2020     print(i)\n   
+0000d3f0: 2022 0a20 2020 2020 2020 2020 2020 2020   ".             
+0000d400: 2020 2020 2020 2022 7469 6d65 2e73 6c65         "time.sle
+0000d410: 6570 2830 2e33 2922 0a20 2020 2020 2020  ep(0.3)".       
+0000d420: 2020 2020 2020 2020 207d 2c0a 2020 2020           },.    
+0000d430: 2020 2020 2020 2020 290a 2020 2020 2020          ).      
+0000d440: 2020 2020 2020 6173 7365 7274 2072 6573        assert res
+0000d450: 706f 6e73 652e 7374 6174 7573 5f63 6f64  ponse.status_cod
+0000d460: 6520 3d3d 2032 3030 0a20 2020 2020 2020  e == 200.       
+0000d470: 2020 2020 206d 6573 7361 6765 5f69 6420       message_id 
+0000d480: 3d20 7265 7370 6f6e 7365 2e6a 736f 6e28  = response.json(
+0000d490: 295b 226b 6572 6e65 6c5f 6d65 7373 6167  )["kernel_messag
+0000d4a0: 6522 5d5b 226d 6573 7361 6765 5f69 6422  e"]["message_id"
+0000d4b0: 5d0a 0a20 2020 2020 2020 2020 2020 2023  ]..            #
+0000d4c0: 2066 6972 7374 2063 6875 6e6b 2072 6563   first chunk rec
+0000d4d0: 6569 7665 6420 7368 6f75 6c64 2062 6520  eived should be 
+0000d4e0: 6120 7363 7261 7463 685f 7570 6461 7465  a scratch_update
+0000d4f0: 2077 6974 680a 2020 2020 2020 2020 2020   with.          
+0000d500: 2020 2320 616e 2065 7865 6375 7469 6f6e    # an execution
+0000d510: 5f73 7461 7465 206f 6620 2762 7573 7927  _state of 'busy'
+0000d520: 2077 6865 6e20 7072 6f63 6573 7369 6e67   when processing
+0000d530: 2073 7461 7274 730a 2020 2020 2020 2020   starts.        
+0000d540: 2020 2020 6461 7461 203d 2061 7761 6974      data = await
+0000d550: 2072 6563 6569 7665 5f6a 736f 6e28 7765   receive_json(we
+0000d560: 6273 6f63 6b65 742c 206d 7367 5f74 7970  bsocket, msg_typ
+0000d570: 6573 3d5b 2273 6372 6174 6368 5f75 7064  es=["scratch_upd
+0000d580: 6174 6522 5d29 0a20 2020 2020 2020 2020  ate"]).         
+0000d590: 2020 2073 6372 6174 6368 5f75 7064 6174     scratch_updat
+0000d5a0: 6520 3d20 6461 7461 5b22 7363 7261 7463  e = data["scratc
+0000d5b0: 685f 7570 6461 7465 225d 0a20 2020 2020  h_update"].     
+0000d5c0: 2020 2020 2020 2061 7373 6572 7420 7363         assert sc
+0000d5d0: 7261 7463 685f 7570 6461 7465 5b22 6d65  ratch_update["me
+0000d5e0: 7373 6167 655f 6964 225d 203d 3d20 6d65  ssage_id"] == me
+0000d5f0: 7373 6167 655f 6964 0a20 2020 2020 2020  ssage_id.       
+0000d600: 2020 2020 2061 7373 6572 7420 7363 7261       assert scra
+0000d610: 7463 685f 7570 6461 7465 5b22 6578 6563  tch_update["exec
+0000d620: 7574 696f 6e5f 7374 6174 6522 5d20 3d3d  ution_state"] ==
+0000d630: 2022 6275 7379 220a 0a20 2020 2020 2020   "busy"..       
+0000d640: 2020 2020 2023 2052 6563 6569 7665 2073       # Receive s
+0000d650: 6372 6174 6368 2065 7865 6375 7469 6f6e  cratch execution
+0000d660: 206f 7574 7075 740a 2020 2020 2020 2020   output.        
+0000d670: 2020 2020 6173 796e 6320 6465 6620 7265      async def re
+0000d680: 6365 6976 655f 7465 7874 2874 6578 7429  ceive_text(text)
+0000d690: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
+0000d6a0: 2020 6461 7461 203d 2061 7761 6974 2072    data = await r
+0000d6b0: 6563 6569 7665 5f6a 736f 6e28 0a20 2020  eceive_json(.   
+0000d6c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000d6d0: 2077 6562 736f 636b 6574 2c20 6d73 675f   websocket, msg_
+0000d6e0: 7479 7065 733d 5b22 7363 7261 7463 685f  types=["scratch_
+0000d6f0: 7570 6461 7465 225d 0a20 2020 2020 2020  update"].       
+0000d700: 2020 2020 2020 2020 2029 0a20 2020 2020           ).     
+0000d710: 2020 2020 2020 2020 2020 2073 6372 6174             scrat
+0000d720: 6368 5f75 7064 6174 6520 3d20 6461 7461  ch_update = data
+0000d730: 5b22 7363 7261 7463 685f 7570 6461 7465  ["scratch_update
+0000d740: 225d 0a20 2020 2020 2020 2020 2020 2020  "].             
+0000d750: 2020 2065 7870 6563 7465 645f 6f75 7470     expected_outp
+0000d760: 7574 203d 207b 0a20 2020 2020 2020 2020  ut = {.         
+0000d770: 2020 2020 2020 2020 2020 2022 6e61 6d65             "name
+0000d780: 223a 2022 7374 646f 7574 222c 0a20 2020  ": "stdout",.   
+0000d790: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000d7a0: 2022 7465 7874 223a 2066 227b 7465 7874   "text": f"{text
+0000d7b0: 7d5c 6e22 2c0a 2020 2020 2020 2020 2020  }\n",.          
+0000d7c0: 2020 2020 2020 2020 2020 226f 7574 7075            "outpu
+0000d7d0: 745f 7479 7065 223a 2022 7374 7265 616d  t_type": "stream
+0000d7e0: 222c 0a20 2020 2020 2020 2020 2020 2020  ",.             
+0000d7f0: 2020 207d 0a20 2020 2020 2020 2020 2020     }.           
+0000d800: 2020 2020 2061 7373 6572 7420 7363 7261       assert scra
+0000d810: 7463 685f 7570 6461 7465 5b22 6f75 7470  tch_update["outp
+0000d820: 7574 225d 203d 3d20 6578 7065 6374 6564  ut"] == expected
+0000d830: 5f6f 7574 7075 740a 0a20 2020 2020 2020  _output..       
+0000d840: 2020 2020 2061 7761 6974 2072 6563 6569       await recei
+0000d850: 7665 5f74 6578 7428 2268 6572 6573 2229  ve_text("heres")
+0000d860: 0a20 2020 2020 2020 2020 2020 2061 7761  .            awa
+0000d870: 6974 2072 6563 6569 7665 5f74 6578 7428  it receive_text(
+0000d880: 2261 2229 0a20 2020 2020 2020 2020 2020  "a").           
+0000d890: 2061 7761 6974 2072 6563 6569 7665 5f74   await receive_t
+0000d8a0: 6578 7428 2273 7472 6561 6d6f 6664 6174  ext("streamofdat
+0000d8b0: 6122 290a 0a20 2020 2020 2020 2020 2020  a")..           
+0000d8c0: 2023 2053 6372 6174 6368 2065 7865 6375   # Scratch execu
+0000d8d0: 7469 6f6e 2073 7461 7465 2073 6574 2074  tion state set t
+0000d8e0: 6f20 6964 6c65 0a20 2020 2020 2020 2020  o idle.         
+0000d8f0: 2020 2064 6174 6120 3d20 6177 6169 7420     data = await 
+0000d900: 7265 6365 6976 655f 6a73 6f6e 2877 6562  receive_json(web
+0000d910: 736f 636b 6574 2c20 6d73 675f 7479 7065  socket, msg_type
+0000d920: 733d 5b22 7363 7261 7463 685f 7570 6461  s=["scratch_upda
+0000d930: 7465 225d 290a 2020 2020 2020 2020 2020  te"]).          
+0000d940: 2020 7363 7261 7463 685f 7570 6461 7465    scratch_update
+0000d950: 203d 2064 6174 615b 2273 6372 6174 6368   = data["scratch
+0000d960: 5f75 7064 6174 6522 5d0a 2020 2020 2020  _update"].      
+0000d970: 2020 2020 2020 6173 7365 7274 2073 6372        assert scr
+0000d980: 6174 6368 5f75 7064 6174 655b 226d 6573  atch_update["mes
+0000d990: 7361 6765 5f69 6422 5d20 3d3d 206d 6573  sage_id"] == mes
+0000d9a0: 7361 6765 5f69 640a 2020 2020 2020 2020  sage_id.        
+0000d9b0: 2020 2020 6173 7365 7274 2073 6372 6174      assert scrat
+0000d9c0: 6368 5f75 7064 6174 655b 2265 7865 6375  ch_update["execu
+0000d9d0: 7469 6f6e 5f73 7461 7465 225d 203d 3d20  tion_state"] == 
+0000d9e0: 2269 646c 6522 0a0a 2020 2020 4070 7974  "idle"..    @pyt
+0000d9f0: 6573 742e 6d61 726b 2e61 7379 6e63 696f  est.mark.asyncio
+0000da00: 0a20 2020 2061 7379 6e63 2064 6566 2074  .    async def t
+0000da10: 6573 745f 7661 7273 5f75 7064 6174 655f  est_vars_update_
+0000da20: 6365 6c6c 5f65 7865 6375 7465 280a 2020  cell_execute(.  
+0000da30: 2020 2020 2020 7365 6c66 2c20 636c 6965        self, clie
+0000da40: 6e74 3a20 5465 7374 436c 6965 6e74 2c20  nt: TestClient, 
+0000da50: 7375 7065 7275 7365 725f 746f 6b65 6e5f  superuser_token_
+0000da60: 6865 6164 6572 733a 2044 6963 745b 7374  headers: Dict[st
+0000da70: 722c 2073 7472 5d0a 2020 2020 293a 0a20  r, str].    ):. 
+0000da80: 2020 2020 2020 2075 7569 6420 3d20 6177         uuid = aw
+0000da90: 6169 7420 7570 6c6f 6164 5f6e 6f74 6562  ait upload_noteb
+0000daa0: 6f6f 6b28 0a20 2020 2020 2020 2020 2020  ook(.           
+0000dab0: 2063 6c69 656e 742c 2073 7570 6572 7573   client, superus
+0000dac0: 6572 5f74 6f6b 656e 5f68 6561 6465 7273  er_token_headers
+0000dad0: 2c20 2273 696d 706c 652e 6970 796e 6222  , "simple.ipynb"
+0000dae0: 0a20 2020 2020 2020 2029 0a0a 2020 2020  .        )..    
+0000daf0: 2020 2020 2320 6765 7420 616e 2065 7869      # get an exi
+0000db00: 7374 696e 6720 6365 6c6c 0a20 2020 2020  sting cell.     
+0000db10: 2020 2072 6573 706f 6e73 6520 3d20 6177     response = aw
+0000db20: 6169 7420 636c 6965 6e74 2e67 6574 280a  ait client.get(.
+0000db30: 2020 2020 2020 2020 2020 2020 6622 2f6e              f"/n
+0000db40: 6f74 6562 6f6f 6b73 2f7b 7575 6964 7d2f  otebooks/{uuid}/
+0000db50: 6365 6c6c 7322 2c20 6865 6164 6572 733d  cells", headers=
+0000db60: 7375 7065 7275 7365 725f 746f 6b65 6e5f  superuser_token_
+0000db70: 6865 6164 6572 730a 2020 2020 2020 2020  headers.        
+0000db80: 290a 2020 2020 2020 2020 6173 7365 7274  ).        assert
+0000db90: 2072 6573 706f 6e73 652e 7374 6174 7573   response.status
+0000dba0: 5f63 6f64 6520 3d3d 2032 3030 0a20 2020  _code == 200.   
+0000dbb0: 2020 2020 2063 656c 6c73 203d 2072 6573       cells = res
+0000dbc0: 706f 6e73 652e 6a73 6f6e 2829 5b22 6365  ponse.json()["ce
+0000dbd0: 6c6c 7322 5d0a 2020 2020 2020 2020 6173  lls"].        as
+0000dbe0: 7365 7274 2063 656c 6c73 5b31 5d5b 2273  sert cells[1]["s
+0000dbf0: 6f75 7263 6522 5d20 3d3d 2027 7072 696e  ource"] == 'prin
+0000dc00: 7428 224c 6172 7279 2074 6865 204c 6c61  t("Larry the Lla
+0000dc10: 6d61 2229 270a 0a20 2020 2020 2020 2063  ma")'..        c
+0000dc20: 656c 6c5f 7575 6964 203d 2063 656c 6c73  ell_uuid = cells
+0000dc30: 5b31 5d5b 226d 6574 6164 6174 6122 5d5b  [1]["metadata"][
+0000dc40: 226a 7570 7974 6572 5f64 3122 5d5b 2275  "jupyter_d1"]["u
+0000dc50: 7569 6422 5d0a 0a20 2020 2020 2020 2070  uid"]..        p
+0000dc60: 6172 616d 7320 3d20 7b22 736f 7572 6365  arams = {"source
+0000dc70: 223a 2022 7820 3d20 372d 3922 7d0a 2020  ": "x = 7-9"}.  
+0000dc80: 2020 2020 2020 7265 7370 6f6e 7365 203d        response =
+0000dc90: 2061 7761 6974 2063 6c69 656e 742e 7061   await client.pa
+0000dca0: 7463 6828 0a20 2020 2020 2020 2020 2020  tch(.           
+0000dcb0: 2066 222f 6e6f 7465 626f 6f6b 732f 7b75   f"/notebooks/{u
+0000dcc0: 7569 647d 2f63 656c 6c73 2f7b 6365 6c6c  uid}/cells/{cell
+0000dcd0: 5f75 7569 647d 222c 0a20 2020 2020 2020  _uuid}",.       
+0000dce0: 2020 2020 206a 736f 6e3d 7061 7261 6d73       json=params
+0000dcf0: 2c0a 2020 2020 2020 2020 2020 2020 6865  ,.            he
+0000dd00: 6164 6572 733d 7375 7065 7275 7365 725f  aders=superuser_
+0000dd10: 746f 6b65 6e5f 6865 6164 6572 732c 0a20  token_headers,. 
+0000dd20: 2020 2020 2020 2029 0a20 2020 2020 2020         ).       
+0000dd30: 2061 7373 6572 7420 7265 7370 6f6e 7365   assert response
+0000dd40: 2e73 7461 7475 735f 636f 6465 203d 3d20  .status_code == 
+0000dd50: 3230 300a 0a20 2020 2020 2020 2072 6573  200..        res
+0000dd60: 706f 6e73 6520 3d20 6177 6169 7420 636c  ponse = await cl
+0000dd70: 6965 6e74 2e67 6574 280a 2020 2020 2020  ient.get(.      
+0000dd80: 2020 2020 2020 6622 2f6e 6f74 6562 6f6f        f"/noteboo
+0000dd90: 6b73 2f7b 7575 6964 7d2f 7661 7273 222c  ks/{uuid}/vars",
+0000dda0: 2068 6561 6465 7273 3d73 7570 6572 7573   headers=superus
+0000ddb0: 6572 5f74 6f6b 656e 5f68 6561 6465 7273  er_token_headers
+0000ddc0: 0a20 2020 2020 2020 2029 0a20 2020 2020  .        ).     
+0000ddd0: 2020 2061 7373 6572 7420 7265 7370 6f6e     assert respon
+0000dde0: 7365 2e73 7461 7475 735f 636f 6465 203d  se.status_code =
+0000ddf0: 3d20 3230 300a 2020 2020 2020 2020 6173  = 200.        as
+0000de00: 7365 7274 206c 656e 2872 6573 706f 6e73  sert len(respons
+0000de10: 652e 6a73 6f6e 2829 5b22 7661 7273 225d  e.json()["vars"]
+0000de20: 2920 3d3d 2030 0a0a 2020 2020 2020 2020  ) == 0..        
+0000de30: 6173 796e 6320 7769 7468 2063 6c69 656e  async with clien
+0000de40: 742e 7765 6273 6f63 6b65 745f 636f 6e6e  t.websocket_conn
+0000de50: 6563 7428 0a20 2020 2020 2020 2020 2020  ect(.           
+0000de60: 2066 222f 6e6f 7465 626f 6f6b 732f 7b75   f"/notebooks/{u
+0000de70: 7569 647d 2f77 732f 6e6f 7465 626f 6f6b  uid}/ws/notebook
+0000de80: 222c 2068 6561 6465 7273 3d73 7570 6572  ", headers=super
+0000de90: 7573 6572 5f74 6f6b 656e 5f68 6561 6465  user_token_heade
+0000dea0: 7273 0a20 2020 2020 2020 2029 2061 7320  rs.        ) as 
+0000deb0: 7765 6273 6f63 6b65 743a 0a20 2020 2020  websocket:.     
+0000dec0: 2020 2020 2020 2061 7761 6974 2061 7379         await asy
+0000ded0: 6e63 696f 2e73 6c65 6570 2857 4542 534f  ncio.sleep(WEBSO
+0000dee0: 434b 4554 5f53 4c45 4550 5f54 494d 4529  CKET_SLEEP_TIME)
+0000def0: 0a0a 2020 2020 2020 2020 2020 2020 7265  ..            re
+0000df00: 7370 6f6e 7365 203d 2061 7761 6974 2063  sponse = await c
+0000df10: 6c69 656e 742e 6765 7428 0a20 2020 2020  lient.get(.     
+0000df20: 2020 2020 2020 2020 2020 2066 222f 6e6f             f"/no
+0000df30: 7465 626f 6f6b 732f 7b75 7569 647d 2f63  tebooks/{uuid}/c
+0000df40: 656c 6c73 2f7b 6365 6c6c 5f75 7569 647d  ells/{cell_uuid}
+0000df50: 2f65 7865 6375 7465 222c 0a20 2020 2020  /execute",.     
+0000df60: 2020 2020 2020 2020 2020 2068 6561 6465             heade
+0000df70: 7273 3d73 7570 6572 7573 6572 5f74 6f6b  rs=superuser_tok
+0000df80: 656e 5f68 6561 6465 7273 2c0a 2020 2020  en_headers,.    
+0000df90: 2020 2020 2020 2020 290a 2020 2020 2020          ).      
+0000dfa0: 2020 2020 2020 6173 7365 7274 2072 6573        assert res
+0000dfb0: 706f 6e73 652e 7374 6174 7573 5f63 6f64  ponse.status_cod
+0000dfc0: 6520 3d3d 2032 3030 0a0a 2020 2020 2020  e == 200..      
+0000dfd0: 2020 2020 2020 2320 4b65 726e 656c 2076        # Kernel v
+0000dfe0: 6172 7320 7570 6461 7465 0a20 2020 2020  ars update.     
+0000dff0: 2020 2020 2020 2064 6174 6120 3d20 6177         data = aw
+0000e000: 6169 7420 7265 6365 6976 655f 6a73 6f6e  ait receive_json
+0000e010: 2877 6562 736f 636b 6574 2c20 6d73 675f  (websocket, msg_
+0000e020: 7479 7065 733d 5b22 7661 7273 225d 290a  types=["vars"]).
+0000e030: 2020 2020 2020 2020 2020 2020 7661 7273              vars
+0000e040: 203d 207b 0a20 2020 2020 2020 2020 2020   = {.           
+0000e050: 2020 2020 2076 6172 5b22 6e61 6d65 225d       var["name"]
+0000e060: 3a20 7b0a 2020 2020 2020 2020 2020 2020  : {.            
+0000e070: 2020 2020 2020 2020 2274 7970 6522 3a20          "type": 
+0000e080: 7661 725b 2274 7970 6522 5d2c 0a20 2020  var["type"],.   
+0000e090: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000e0a0: 2022 7661 6c75 6522 3a20 7661 725b 2276   "value": var["v
+0000e0b0: 616c 7565 225d 2c0a 2020 2020 2020 2020  alue"],.        
+0000e0c0: 2020 2020 2020 2020 2020 2020 2273 756d              "sum
+0000e0d0: 6d61 7279 223a 2076 6172 5b22 7375 6d6d  mary": var["summ
+0000e0e0: 6172 7922 5d2c 0a20 2020 2020 2020 2020  ary"],.         
+0000e0f0: 2020 2020 2020 207d 0a20 2020 2020 2020         }.       
+0000e100: 2020 2020 2020 2020 2066 6f72 2076 6172           for var
+0000e110: 2069 6e20 6461 7461 5b22 7661 7273 225d   in data["vars"]
+0000e120: 0a20 2020 2020 2020 2020 2020 207d 0a0a  .            }..
+0000e130: 2020 2020 2020 2020 2020 2020 6173 7365              asse
+0000e140: 7274 2076 6172 735b 2278 225d 5b22 7479  rt vars["x"]["ty
+0000e150: 7065 225d 203d 3d20 2269 6e74 220a 2020  pe"] == "int".  
+0000e160: 2020 2020 2020 2020 2020 6173 7365 7274            assert
+0000e170: 2076 6172 735b 2278 225d 5b22 7661 6c75   vars["x"]["valu
+0000e180: 6522 5d5b 2273 696e 676c 655f 7661 6c75  e"]["single_valu
+0000e190: 6522 5d20 3d3d 2022 2d32 220a 2020 2020  e"] == "-2".    
+0000e1a0: 2020 2020 2020 2020 6173 7365 7274 2076          assert v
+0000e1b0: 6172 735b 2278 225d 5b22 7375 6d6d 6172  ars["x"]["summar
+0000e1c0: 7922 5d20 3d3d 2022 2d32 220a 0a20 2020  y"] == "-2"..   
+0000e1d0: 2020 2020 2020 2020 2072 6573 706f 6e73           respons
+0000e1e0: 6520 3d20 6177 6169 7420 636c 6965 6e74  e = await client
+0000e1f0: 2e67 6574 280a 2020 2020 2020 2020 2020  .get(.          
+0000e200: 2020 2020 2020 6622 2f6e 6f74 6562 6f6f        f"/noteboo
+0000e210: 6b73 2f7b 7575 6964 7d2f 7661 7273 222c  ks/{uuid}/vars",
+0000e220: 2068 6561 6465 7273 3d73 7570 6572 7573   headers=superus
+0000e230: 6572 5f74 6f6b 656e 5f68 6561 6465 7273  er_token_headers
+0000e240: 0a20 2020 2020 2020 2020 2020 2029 0a20  .            ). 
+0000e250: 2020 2020 2020 2020 2020 2061 7373 6572             asser
+0000e260: 7420 7265 7370 6f6e 7365 2e73 7461 7475  t response.statu
+0000e270: 735f 636f 6465 203d 3d20 3230 300a 2020  s_code == 200.  
+0000e280: 2020 2020 2020 2020 2020 6375 7272 656e            curren
+0000e290: 745f 7661 7273 203d 2072 6573 706f 6e73  t_vars = respons
+0000e2a0: 652e 6a73 6f6e 2829 5b22 7661 7273 225d  e.json()["vars"]
+0000e2b0: 0a20 2020 2020 2020 2020 2020 2063 7572  .            cur
+0000e2c0: 7265 6e74 5f76 6172 7320 3d20 6669 6c74  rent_vars = filt
+0000e2d0: 6572 280a 2020 2020 2020 2020 2020 2020  er(.            
+0000e2e0: 2020 2020 6c61 6d62 6461 2078 3a20 785b      lambda x: x[
+0000e2f0: 226e 616d 6522 5d20 213d 2022 5f5f 5f64  "name"] != "___d
+0000e300: 316f 7322 2c20 6375 7272 656e 745f 7661  1os", current_va
+0000e310: 7273 0a20 2020 2020 2020 2020 2020 2029  rs.            )
+0000e320: 0a20 2020 2020 2020 2020 2020 2061 7373  .            ass
+0000e330: 6572 7420 6c69 7374 2863 7572 7265 6e74  ert list(current
+0000e340: 5f76 6172 7329 203d 3d20 6461 7461 5b22  _vars) == data["
+0000e350: 7661 7273 225d 0a0a 2020 2020 4070 7974  vars"]..    @pyt
+0000e360: 6573 742e 6d61 726b 2e61 7379 6e63 696f  est.mark.asyncio
+0000e370: 0a20 2020 2061 7379 6e63 2064 6566 2074  .    async def t
+0000e380: 6573 745f 7661 7273 5f75 7064 6174 655f  est_vars_update_
+0000e390: 7363 7261 7463 685f 6578 6563 7574 6528  scratch_execute(
+0000e3a0: 0a20 2020 2020 2020 2073 656c 662c 2063  .        self, c
+0000e3b0: 6c69 656e 743a 2054 6573 7443 6c69 656e  lient: TestClien
+0000e3c0: 742c 2073 7570 6572 7573 6572 5f74 6f6b  t, superuser_tok
+0000e3d0: 656e 5f68 6561 6465 7273 3a20 4469 6374  en_headers: Dict
+0000e3e0: 5b73 7472 2c20 7374 725d 0a20 2020 2029  [str, str].    )
+0000e3f0: 3a0a 2020 2020 2020 2020 7575 6964 203d  :.        uuid =
+0000e400: 2061 7761 6974 2075 706c 6f61 645f 6e6f   await upload_no
+0000e410: 7465 626f 6f6b 280a 2020 2020 2020 2020  tebook(.        
+0000e420: 2020 2020 636c 6965 6e74 2c20 7375 7065      client, supe
+0000e430: 7275 7365 725f 746f 6b65 6e5f 6865 6164  ruser_token_head
+0000e440: 6572 732c 2022 7369 6d70 6c65 2e69 7079  ers, "simple.ipy
+0000e450: 6e62 220a 2020 2020 2020 2020 290a 0a20  nb".        ).. 
+0000e460: 2020 2020 2020 2072 6573 706f 6e73 6520         response 
+0000e470: 3d20 6177 6169 7420 636c 6965 6e74 2e67  = await client.g
+0000e480: 6574 280a 2020 2020 2020 2020 2020 2020  et(.            
+0000e490: 6622 2f6e 6f74 6562 6f6f 6b73 2f7b 7575  f"/notebooks/{uu
+0000e4a0: 6964 7d2f 7661 7273 222c 2068 6561 6465  id}/vars", heade
+0000e4b0: 7273 3d73 7570 6572 7573 6572 5f74 6f6b  rs=superuser_tok
+0000e4c0: 656e 5f68 6561 6465 7273 0a20 2020 2020  en_headers.     
+0000e4d0: 2020 2029 0a20 2020 2020 2020 2061 7373     ).        ass
+0000e4e0: 6572 7420 7265 7370 6f6e 7365 2e73 7461  ert response.sta
+0000e4f0: 7475 735f 636f 6465 203d 3d20 3230 300a  tus_code == 200.
+0000e500: 2020 2020 2020 2020 6173 7365 7274 206c          assert l
+0000e510: 656e 2872 6573 706f 6e73 652e 6a73 6f6e  en(response.json
+0000e520: 2829 5b22 7661 7273 225d 2920 3d3d 2030  ()["vars"]) == 0
+0000e530: 0a0a 2020 2020 2020 2020 6173 796e 6320  ..        async 
+0000e540: 7769 7468 2063 6c69 656e 742e 7765 6273  with client.webs
+0000e550: 6f63 6b65 745f 636f 6e6e 6563 7428 0a20  ocket_connect(. 
+0000e560: 2020 2020 2020 2020 2020 2066 222f 6e6f             f"/no
+0000e570: 7465 626f 6f6b 732f 7b75 7569 647d 2f77  tebooks/{uuid}/w
+0000e580: 732f 6e6f 7465 626f 6f6b 222c 2068 6561  s/notebook", hea
+0000e590: 6465 7273 3d73 7570 6572 7573 6572 5f74  ders=superuser_t
+0000e5a0: 6f6b 656e 5f68 6561 6465 7273 0a20 2020  oken_headers.   
+0000e5b0: 2020 2020 2029 2061 7320 7765 6273 6f63       ) as websoc
+0000e5c0: 6b65 743a 0a20 2020 2020 2020 2020 2020  ket:.           
+0000e5d0: 2061 7761 6974 2061 7379 6e63 696f 2e73   await asyncio.s
+0000e5e0: 6c65 6570 2857 4542 534f 434b 4554 5f53  leep(WEBSOCKET_S
+0000e5f0: 4c45 4550 5f54 494d 4529 0a0a 2020 2020  LEEP_TIME)..    
+0000e600: 2020 2020 2020 2020 7265 7370 6f6e 7365          response
+0000e610: 203d 2061 7761 6974 2063 6c69 656e 742e   = await client.
+0000e620: 706f 7374 280a 2020 2020 2020 2020 2020  post(.          
+0000e630: 2020 2020 2020 6622 2f6e 6f74 6562 6f6f        f"/noteboo
+0000e640: 6b73 2f7b 7575 6964 7d2f 7363 7261 7463  ks/{uuid}/scratc
+0000e650: 685f 6578 6563 7574 6522 2c0a 2020 2020  h_execute",.    
+0000e660: 2020 2020 2020 2020 2020 2020 6865 6164              head
+0000e670: 6572 733d 7375 7065 7275 7365 725f 746f  ers=superuser_to
+0000e680: 6b65 6e5f 6865 6164 6572 732c 0a20 2020  ken_headers,.   
+0000e690: 2020 2020 2020 2020 2020 2020 206a 736f               jso
+0000e6a0: 6e3d 7b22 636f 6465 223a 2022 785f 7520  n={"code": "x_u 
+0000e6b0: 3d20 3237 2f31 3022 7d2c 0a20 2020 2020  = 27/10"},.     
+0000e6c0: 2020 2020 2020 2029 0a20 2020 2020 2020         ).       
+0000e6d0: 2020 2020 2061 7373 6572 7420 7265 7370       assert resp
+0000e6e0: 6f6e 7365 2e73 7461 7475 735f 636f 6465  onse.status_code
+0000e6f0: 203d 3d20 3230 300a 0a20 2020 2020 2020   == 200..       
+0000e700: 2020 2020 2023 204b 6572 6e65 6c20 7661       # Kernel va
+0000e710: 7273 2075 7064 6174 650a 2020 2020 2020  rs update.      
+0000e720: 2020 2020 2020 6461 7461 203d 2061 7761        data = awa
+0000e730: 6974 2072 6563 6569 7665 5f6a 736f 6e28  it receive_json(
+0000e740: 7765 6273 6f63 6b65 742c 206d 7367 5f74  websocket, msg_t
+0000e750: 7970 6573 3d5b 2276 6172 7322 5d29 0a20  ypes=["vars"]). 
+0000e760: 2020 2020 2020 2020 2020 2076 6172 7320             vars 
+0000e770: 3d20 7b0a 2020 2020 2020 2020 2020 2020  = {.            
+0000e780: 2020 2020 7661 725b 226e 616d 6522 5d3a      var["name"]:
+0000e790: 207b 0a20 2020 2020 2020 2020 2020 2020   {.             
+0000e7a0: 2020 2020 2020 2022 7479 7065 223a 2076         "type": v
+0000e7b0: 6172 5b22 7479 7065 225d 2c0a 2020 2020  ar["type"],.    
+0000e7c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000e7d0: 2276 616c 7565 223a 2076 6172 5b22 7661  "value": var["va
+0000e7e0: 6c75 6522 5d2c 0a20 2020 2020 2020 2020  lue"],.         
+0000e7f0: 2020 2020 2020 2020 2020 2022 7375 6d6d             "summ
+0000e800: 6172 7922 3a20 7661 725b 2273 756d 6d61  ary": var["summa
+0000e810: 7279 225d 2c0a 2020 2020 2020 2020 2020  ry"],.          
+0000e820: 2020 2020 2020 7d0a 2020 2020 2020 2020        }.        
+0000e830: 2020 2020 2020 2020 666f 7220 7661 7220          for var 
+0000e840: 696e 2064 6174 615b 2276 6172 7322 5d0a  in data["vars"].
+0000e850: 2020 2020 2020 2020 2020 2020 7d0a 0a20              }.. 
+0000e860: 2020 2020 2020 2020 2020 2061 7373 6572             asser
+0000e870: 7420 7661 7273 5b22 785f 7522 5d5b 2274  t vars["x_u"]["t
+0000e880: 7970 6522 5d20 3d3d 2022 666c 6f61 7422  ype"] == "float"
+0000e890: 0a20 2020 2020 2020 2020 2020 2061 7373  .            ass
+0000e8a0: 6572 7420 7661 7273 5b22 785f 7522 5d5b  ert vars["x_u"][
+0000e8b0: 2276 616c 7565 225d 5b22 7369 6e67 6c65  "value"]["single
+0000e8c0: 5f76 616c 7565 225d 203d 3d20 2232 2e37  _value"] == "2.7
+0000e8d0: 220a 2020 2020 2020 2020 2020 2020 6173  ".            as
+0000e8e0: 7365 7274 2076 6172 735b 2278 5f75 225d  sert vars["x_u"]
+0000e8f0: 5b22 7375 6d6d 6172 7922 5d20 3d3d 2022  ["summary"] == "
+0000e900: 322e 3722 0a0a 2020 2020 2020 2020 2020  2.7"..          
+0000e910: 2020 7265 7370 6f6e 7365 203d 2061 7761    response = awa
+0000e920: 6974 2063 6c69 656e 742e 6765 7428 0a20  it client.get(. 
+0000e930: 2020 2020 2020 2020 2020 2020 2020 2066                 f
+0000e940: 222f 6e6f 7465 626f 6f6b 732f 7b75 7569  "/notebooks/{uui
+0000e950: 647d 2f76 6172 7322 2c20 6865 6164 6572  d}/vars", header
+0000e960: 733d 7375 7065 7275 7365 725f 746f 6b65  s=superuser_toke
+0000e970: 6e5f 6865 6164 6572 730a 2020 2020 2020  n_headers.      
+0000e980: 2020 2020 2020 290a 2020 2020 2020 2020        ).        
+0000e990: 2020 2020 6173 7365 7274 2072 6573 706f      assert respo
+0000e9a0: 6e73 652e 7374 6174 7573 5f63 6f64 6520  nse.status_code 
+0000e9b0: 3d3d 2032 3030 0a20 2020 2020 2020 2020  == 200.         
+0000e9c0: 2020 2063 7572 7265 6e74 5f76 6172 7320     current_vars 
+0000e9d0: 3d20 7265 7370 6f6e 7365 2e6a 736f 6e28  = response.json(
+0000e9e0: 295b 2276 6172 7322 5d0a 2020 2020 2020  )["vars"].      
+0000e9f0: 2020 2020 2020 6375 7272 656e 745f 7661        current_va
+0000ea00: 7273 203d 2066 696c 7465 7228 0a20 2020  rs = filter(.   
+0000ea10: 2020 2020 2020 2020 2020 2020 206c 616d               lam
+0000ea20: 6264 6120 783a 2078 5b22 6e61 6d65 225d  bda x: x["name"]
+0000ea30: 2021 3d20 225f 5f5f 6431 6f73 222c 2063   != "___d1os", c
+0000ea40: 7572 7265 6e74 5f76 6172 730a 2020 2020  urrent_vars.    
+0000ea50: 2020 2020 2020 2020 290a 2020 2020 2020          ).      
+0000ea60: 2020 2020 2020 6173 7365 7274 206c 6973        assert lis
+0000ea70: 7428 6375 7272 656e 745f 7661 7273 2920  t(current_vars) 
+0000ea80: 3d3d 2064 6174 615b 2276 6172 7322 5d0a  == data["vars"].
+0000ea90: 0a20 2020 2040 7079 7465 7374 2e6d 6172  .    @pytest.mar
+0000eaa0: 6b2e 6173 796e 6369 6f0a 2020 2020 6173  k.asyncio.    as
+0000eab0: 796e 6320 6465 6620 7465 7374 5f6e 6f74  ync def test_not
+0000eac0: 6562 6f6f 6b5f 7772 6974 655f 7065 726d  ebook_write_perm
+0000ead0: 6973 7369 6f6e 280a 2020 2020 2020 2020  ission(.        
+0000eae0: 7365 6c66 2c0a 2020 2020 2020 2020 636c  self,.        cl
+0000eaf0: 6965 6e74 3a20 5465 7374 436c 6965 6e74  ient: TestClient
+0000eb00: 2c0a 2020 2020 2020 2020 7375 7065 7275  ,.        superu
+0000eb10: 7365 725f 746f 6b65 6e5f 6865 6164 6572  ser_token_header
+0000eb20: 733a 2044 6963 745b 7374 722c 2073 7472  s: Dict[str, str
+0000eb30: 5d2c 0a20 2020 2020 2020 2072 6561 646f  ],.        reado
+0000eb40: 6e6c 795f 746f 6b65 6e5f 6865 6164 6572  nly_token_header
+0000eb50: 733a 2044 6963 745b 7374 722c 2073 7472  s: Dict[str, str
+0000eb60: 5d2c 0a20 2020 2029 3a0a 2020 2020 2020  ],.    ):.      
+0000eb70: 2020 7575 6964 203d 2061 7761 6974 2075    uuid = await u
+0000eb80: 706c 6f61 645f 6e6f 7465 626f 6f6b 2863  pload_notebook(c
+0000eb90: 6c69 656e 742c 2073 7570 6572 7573 6572  lient, superuser
+0000eba0: 5f74 6f6b 656e 5f68 6561 6465 7273 290a  _token_headers).
+0000ebb0: 0a20 2020 2020 2020 2077 6974 6820 7079  .        with py
+0000ebc0: 7465 7374 2e72 6169 7365 7328 4173 7365  test.raises(Asse
+0000ebd0: 7274 696f 6e45 7272 6f72 293a 0a20 2020  rtionError):.   
+0000ebe0: 2020 2020 2020 2020 2061 7379 6e63 2077           async w
+0000ebf0: 6974 6820 636c 6965 6e74 2e77 6562 736f  ith client.webso
+0000ec00: 636b 6574 5f63 6f6e 6e65 6374 280a 2020  cket_connect(.  
+0000ec10: 2020 2020 2020 2020 2020 2020 2020 6622                f"
+0000ec20: 2f6e 6f74 6562 6f6f 6b73 2f7b 7575 6964  /notebooks/{uuid
+0000ec30: 7d2f 7773 2f6e 6f74 6562 6f6f 6b22 2c0a  }/ws/notebook",.
+0000ec40: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000ec50: 6865 6164 6572 733d 7265 6164 6f6e 6c79  headers=readonly
+0000ec60: 5f74 6f6b 656e 5f68 6561 6465 7273 2c0a  _token_headers,.
+0000ec70: 2020 2020 2020 2020 2020 2020 293a 0a20              ):. 
+0000ec80: 2020 2020 2020 2020 2020 2020 2020 2070                 p
+0000ec90: 6173 730a 0a20 2020 2020 2020 2061 7379  ass..        asy
+0000eca0: 6e63 2077 6974 6820 636c 6965 6e74 2e77  nc with client.w
+0000ecb0: 6562 736f 636b 6574 5f63 6f6e 6e65 6374  ebsocket_connect
+0000ecc0: 280a 2020 2020 2020 2020 2020 2020 6622  (.            f"
+0000ecd0: 2f6e 6f74 6562 6f6f 6b73 2f7b 7575 6964  /notebooks/{uuid
+0000ece0: 7d2f 7773 2f6e 6f74 6562 6f6f 6b22 2c20  }/ws/notebook", 
+0000ecf0: 6865 6164 6572 733d 7375 7065 7275 7365  headers=superuse
+0000ed00: 725f 746f 6b65 6e5f 6865 6164 6572 730a  r_token_headers.
+0000ed10: 2020 2020 2020 2020 293a 0a20 2020 2020          ):.     
+0000ed20: 2020 2020 2020 2070 6173 730a 0a20 2020         pass..   
+0000ed30: 2040 7079 7465 7374 2e6d 6172 6b2e 6173   @pytest.mark.as
+0000ed40: 796e 6369 6f0a 2020 2020 6173 796e 6320  yncio.    async 
+0000ed50: 6465 6620 7465 7374 5f6e 6f74 6562 6f6f  def test_noteboo
+0000ed60: 6b5f 7374 7265 616d 5f70 6572 6d69 7373  k_stream_permiss
+0000ed70: 696f 6e28 0a20 2020 2020 2020 2073 656c  ion(.        sel
+0000ed80: 662c 0a20 2020 2020 2020 2063 6c69 656e  f,.        clien
+0000ed90: 743a 2054 6573 7443 6c69 656e 742c 0a20  t: TestClient,. 
+0000eda0: 2020 2020 2020 2073 7570 6572 7573 6572         superuser
+0000edb0: 5f74 6f6b 656e 5f68 6561 6465 7273 3a20  _token_headers: 
+0000edc0: 4469 6374 5b73 7472 2c20 7374 725d 2c0a  Dict[str, str],.
+0000edd0: 2020 2020 2020 2020 7265 6164 6f6e 6c79          readonly
+0000ede0: 5f74 6f6b 656e 5f68 6561 6465 7273 3a20  _token_headers: 
+0000edf0: 4469 6374 5b73 7472 2c20 7374 725d 2c0a  Dict[str, str],.
+0000ee00: 2020 2020 2020 2020 7065 726d 6973 7369          permissi
+0000ee10: 6f6e 6c65 7373 5f74 6f6b 656e 5f68 6561  onless_token_hea
+0000ee20: 6465 7273 3a20 4469 6374 5b73 7472 2c20  ders: Dict[str, 
+0000ee30: 7374 725d 2c0a 2020 2020 293a 0a20 2020  str],.    ):.   
+0000ee40: 2020 2020 2075 7569 6420 3d20 6177 6169       uuid = awai
+0000ee50: 7420 7570 6c6f 6164 5f6e 6f74 6562 6f6f  t upload_noteboo
+0000ee60: 6b28 636c 6965 6e74 2c20 7375 7065 7275  k(client, superu
+0000ee70: 7365 725f 746f 6b65 6e5f 6865 6164 6572  ser_token_header
+0000ee80: 7329 0a0a 2020 2020 2020 2020 7769 7468  s)..        with
+0000ee90: 2070 7974 6573 742e 7261 6973 6573 2841   pytest.raises(A
+0000eea0: 7373 6572 7469 6f6e 4572 726f 7229 3a0a  ssertionError):.
+0000eeb0: 2020 2020 2020 2020 2020 2020 6173 796e              asyn
+0000eec0: 6320 7769 7468 2063 6c69 656e 742e 7765  c with client.we
+0000eed0: 6273 6f63 6b65 745f 636f 6e6e 6563 7428  bsocket_connect(
+0000eee0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+0000eef0: 2066 222f 6e6f 7465 626f 6f6b 732f 7b75   f"/notebooks/{u
+0000ef00: 7569 647d 2f77 732f 7374 7265 616d 222c  uid}/ws/stream",
+0000ef10: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+0000ef20: 2068 6561 6465 7273 3d70 6572 6d69 7373   headers=permiss
+0000ef30: 696f 6e6c 6573 735f 746f 6b65 6e5f 6865  ionless_token_he
+0000ef40: 6164 6572 732c 0a20 2020 2020 2020 2020  aders,.         
+0000ef50: 2020 2029 3a0a 2020 2020 2020 2020 2020     ):.          
+0000ef60: 2020 2020 2020 7061 7373 0a0a 2020 2020        pass..    
+0000ef70: 2020 2020 6173 796e 6320 7769 7468 2063      async with c
+0000ef80: 6c69 656e 742e 7765 6273 6f63 6b65 745f  lient.websocket_
+0000ef90: 636f 6e6e 6563 7428 0a20 2020 2020 2020  connect(.       
+0000efa0: 2020 2020 2066 222f 6e6f 7465 626f 6f6b       f"/notebook
+0000efb0: 732f 7b75 7569 647d 2f77 732f 7374 7265  s/{uuid}/ws/stre
+0000efc0: 616d 222c 2068 6561 6465 7273 3d72 6561  am", headers=rea
+0000efd0: 646f 6e6c 795f 746f 6b65 6e5f 6865 6164  donly_token_head
+0000efe0: 6572 730a 2020 2020 2020 2020 293a 0a20  ers.        ):. 
+0000eff0: 2020 2020 2020 2020 2020 2070 6173 730a             pass.
+0000f000: 0a20 2020 2040 7079 7465 7374 2e6d 6172  .    @pytest.mar
+0000f010: 6b2e 6173 796e 6369 6f0a 2020 2020 6173  k.asyncio.    as
+0000f020: 796e 6320 6465 6620 7465 7374 5f76 6172  ync def test_var
+0000f030: 735f 7570 6461 7465 5f62 6173 6828 0a20  s_update_bash(. 
+0000f040: 2020 2020 2020 2073 656c 662c 2063 6c69         self, cli
+0000f050: 656e 743a 2054 6573 7443 6c69 656e 742c  ent: TestClient,
+0000f060: 2073 7570 6572 7573 6572 5f74 6f6b 656e   superuser_token
+0000f070: 5f68 6561 6465 7273 3a20 4469 6374 5b73  _headers: Dict[s
+0000f080: 7472 2c20 7374 725d 0a20 2020 2029 3a0a  tr, str].    ):.
+0000f090: 2020 2020 2020 2020 7265 7370 6f6e 7365          response
+0000f0a0: 203d 2061 7761 6974 2063 6c69 656e 742e   = await client.
+0000f0b0: 706f 7374 280a 2020 2020 2020 2020 2020  post(.          
+0000f0c0: 2020 222f 6e6f 7465 626f 6f6b 732f 6372    "/notebooks/cr
+0000f0d0: 6561 7465 222c 0a20 2020 2020 2020 2020  eate",.         
+0000f0e0: 2020 2071 7565 7279 5f73 7472 696e 673d     query_string=
+0000f0f0: 7b22 6b73 7065 635f 6e61 6d65 223a 2022  {"kspec_name": "
+0000f100: 6261 7368 222c 2022 6669 6c65 6e61 6d65  bash", "filename
+0000f110: 223a 2022 6865 7970 227d 2c0a 2020 2020  ": "heyp"},.    
+0000f120: 2020 2020 2020 2020 6865 6164 6572 733d          headers=
+0000f130: 7375 7065 7275 7365 725f 746f 6b65 6e5f  superuser_token_
+0000f140: 6865 6164 6572 732c 0a20 2020 2020 2020  headers,.       
+0000f150: 2029 0a20 2020 2020 2020 2061 7373 6572   ).        asser
+0000f160: 7420 7265 7370 6f6e 7365 2e73 7461 7475  t response.statu
+0000f170: 735f 636f 6465 203d 3d20 3230 310a 2020  s_code == 201.  
+0000f180: 2020 2020 2020 7265 7370 5f6a 736f 6e20        resp_json 
+0000f190: 3d20 7265 7370 6f6e 7365 2e6a 736f 6e28  = response.json(
+0000f1a0: 295b 226e 6f74 6562 6f6f 6b22 5d0a 2020  )["notebook"].  
+0000f1b0: 2020 2020 2020 7575 6964 203d 2072 6573        uuid = res
+0000f1c0: 705f 6a73 6f6e 5b22 6d65 7461 6461 7461  p_json["metadata
+0000f1d0: 225d 5b22 6a75 7079 7465 725f 6431 225d  "]["jupyter_d1"]
+0000f1e0: 5b22 7575 6964 225d 0a0a 2020 2020 2020  ["uuid"]..      
+0000f1f0: 2020 7265 7370 6f6e 7365 203d 2061 7761    response = awa
+0000f200: 6974 2063 6c69 656e 742e 6765 7428 0a20  it client.get(. 
+0000f210: 2020 2020 2020 2020 2020 2066 222f 6e6f             f"/no
+0000f220: 7465 626f 6f6b 732f 7b75 7569 647d 2f76  tebooks/{uuid}/v
+0000f230: 6172 7322 2c20 6865 6164 6572 733d 7375  ars", headers=su
+0000f240: 7065 7275 7365 725f 746f 6b65 6e5f 6865  peruser_token_he
+0000f250: 6164 6572 730a 2020 2020 2020 2020 290a  aders.        ).
+0000f260: 2020 2020 2020 2020 6173 7365 7274 2072          assert r
+0000f270: 6573 706f 6e73 652e 7374 6174 7573 5f63  esponse.status_c
+0000f280: 6f64 6520 3d3d 2032 3030 0a20 2020 2020  ode == 200.     
+0000f290: 2020 2076 6172 735f 6c69 7374 203d 2072     vars_list = r
+0000f2a0: 6573 706f 6e73 652e 6a73 6f6e 2829 5b22  esponse.json()["
+0000f2b0: 7661 7273 225d 0a20 2020 2020 2020 2061  vars"].        a
+0000f2c0: 7373 6572 7420 6c65 6e28 7661 7273 5f6c  ssert len(vars_l
+0000f2d0: 6973 7429 203d 3d20 300a 0a20 2020 2020  ist) == 0..     
+0000f2e0: 2020 2061 7379 6e63 2077 6974 6820 636c     async with cl
+0000f2f0: 6965 6e74 2e77 6562 736f 636b 6574 5f63  ient.websocket_c
+0000f300: 6f6e 6e65 6374 280a 2020 2020 2020 2020  onnect(.        
+0000f310: 2020 2020 6622 2f6e 6f74 6562 6f6f 6b73      f"/notebooks
+0000f320: 2f7b 7575 6964 7d2f 7773 2f6e 6f74 6562  /{uuid}/ws/noteb
+0000f330: 6f6f 6b22 2c20 6865 6164 6572 733d 7375  ook", headers=su
+0000f340: 7065 7275 7365 725f 746f 6b65 6e5f 6865  peruser_token_he
+0000f350: 6164 6572 730a 2020 2020 2020 2020 2920  aders.        ) 
+0000f360: 6173 2077 6562 736f 636b 6574 3a0a 2020  as websocket:.  
+0000f370: 2020 2020 2020 2020 2020 6177 6169 7420            await 
+0000f380: 6173 796e 6369 6f2e 736c 6565 7028 5745  asyncio.sleep(WE
+0000f390: 4253 4f43 4b45 545f 534c 4545 505f 5449  BSOCKET_SLEEP_TI
+0000f3a0: 4d45 290a 0a20 2020 2020 2020 2020 2020  ME)..           
+0000f3b0: 2072 6573 706f 6e73 6520 3d20 6177 6169   response = awai
+0000f3c0: 7420 636c 6965 6e74 2e70 6f73 7428 0a20  t client.post(. 
+0000f3d0: 2020 2020 2020 2020 2020 2020 2020 2066                 f
+0000f3e0: 222f 6e6f 7465 626f 6f6b 732f 7b75 7569  "/notebooks/{uui
+0000f3f0: 647d 2f73 6372 6174 6368 5f65 7865 6375  d}/scratch_execu
+0000f400: 7465 222c 0a20 2020 2020 2020 2020 2020  te",.           
+0000f410: 2020 2020 2068 6561 6465 7273 3d73 7570       headers=sup
+0000f420: 6572 7573 6572 5f74 6f6b 656e 5f68 6561  eruser_token_hea
+0000f430: 6465 7273 2c0a 2020 2020 2020 2020 2020  ders,.          
+0000f440: 2020 2020 2020 6a73 6f6e 3d7b 2263 6f64        json={"cod
+0000f450: 6522 3a20 2265 7870 6f72 7420 4431 5f56  e": "export D1_V
+0000f460: 4152 5f54 4553 543d 7039 3033 7322 7d2c  AR_TEST=p903s"},
+0000f470: 0a20 2020 2020 2020 2020 2020 2029 0a20  .            ). 
+0000f480: 2020 2020 2020 2020 2020 2061 7373 6572             asser
+0000f490: 7420 7265 7370 6f6e 7365 2e73 7461 7475  t response.statu
+0000f4a0: 735f 636f 6465 203d 3d20 3230 300a 0a20  s_code == 200.. 
+0000f4b0: 2020 2020 2020 2020 2020 2064 6174 6120             data 
+0000f4c0: 3d20 6177 6169 7420 7265 6365 6976 655f  = await receive_
+0000f4d0: 6a73 6f6e 280a 2020 2020 2020 2020 2020  json(.          
+0000f4e0: 2020 2020 2020 7765 6273 6f63 6b65 742c        websocket,
+0000f4f0: 2074 696d 656f 7574 3d36 302c 206d 7367   timeout=60, msg
+0000f500: 5f74 7970 6573 3d5b 2276 6172 7322 5d0a  _types=["vars"].
+0000f510: 2020 2020 2020 2020 2020 2020 290a 2020              ).  
+0000f520: 2020 2020 2020 2020 2020 7661 7273 203d            vars =
+0000f530: 207b 0a20 2020 2020 2020 2020 2020 2020   {.             
+0000f540: 2020 2076 6172 5b22 6e61 6d65 225d 3a20     var["name"]: 
+0000f550: 7b0a 2020 2020 2020 2020 2020 2020 2020  {.              
+0000f560: 2020 2020 2020 2274 7970 6522 3a20 7661        "type": va
+0000f570: 725b 2274 7970 6522 5d2c 0a20 2020 2020  r["type"],.     
+0000f580: 2020 2020 2020 2020 2020 2020 2020 2022                 "
+0000f590: 7661 6c75 6522 3a20 7661 725b 2276 616c  value": var["val
+0000f5a0: 7565 225d 2c0a 2020 2020 2020 2020 2020  ue"],.          
+0000f5b0: 2020 2020 2020 2020 2020 2273 756d 6d61            "summa
+0000f5c0: 7279 223a 2076 6172 5b22 7375 6d6d 6172  ry": var["summar
+0000f5d0: 7922 5d2c 0a20 2020 2020 2020 2020 2020  y"],.           
+0000f5e0: 2020 2020 207d 0a20 2020 2020 2020 2020       }.         
+0000f5f0: 2020 2020 2020 2066 6f72 2076 6172 2069         for var i
+0000f600: 6e20 6461 7461 5b22 7661 7273 225d 0a20  n data["vars"]. 
+0000f610: 2020 2020 2020 2020 2020 207d 0a20 2020             }.   
+0000f620: 2020 2020 2020 2020 2061 7373 6572 7420           assert 
+0000f630: 7661 7273 5b22 4431 5f56 4152 5f54 4553  vars["D1_VAR_TES
+0000f640: 5422 5d5b 2274 7970 6522 5d20 6973 204e  T"]["type"] is N
+0000f650: 6f6e 650a 2020 2020 2020 2020 2020 2020  one.            
+0000f660: 6173 7365 7274 2076 6172 735b 2244 315f  assert vars["D1_
+0000f670: 5641 525f 5445 5354 225d 5b22 7661 6c75  VAR_TEST"]["valu
+0000f680: 6522 5d5b 2273 696e 676c 655f 7661 6c75  e"]["single_valu
+0000f690: 6522 5d20 3d3d 2022 7039 3033 7322 0a20  e"] == "p903s". 
+0000f6a0: 2020 2020 2020 2020 2020 2061 7373 6572             asser
+0000f6b0: 7420 7661 7273 5b22 4431 5f56 4152 5f54  t vars["D1_VAR_T
+0000f6c0: 4553 5422 5d5b 2273 756d 6d61 7279 225d  EST"]["summary"]
+0000f6d0: 203d 3d20 2270 3930 3373 220a 0a20 2020   == "p903s"..   
+0000f6e0: 2040 7079 7465 7374 2e6d 6172 6b2e 6173   @pytest.mark.as
+0000f6f0: 796e 6369 6f0a 2020 2020 6173 796e 6320  yncio.    async 
+0000f700: 6465 6620 7465 7374 5f76 6172 735f 7570  def test_vars_up
+0000f710: 6461 7465 5f72 5f6b 6572 6e65 6c28 0a20  date_r_kernel(. 
+0000f720: 2020 2020 2020 2073 656c 662c 2063 6c69         self, cli
+0000f730: 656e 743a 2054 6573 7443 6c69 656e 742c  ent: TestClient,
+0000f740: 2073 7570 6572 7573 6572 5f74 6f6b 656e   superuser_token
+0000f750: 5f68 6561 6465 7273 3a20 4469 6374 5b73  _headers: Dict[s
+0000f760: 7472 2c20 7374 725d 0a20 2020 2029 3a0a  tr, str].    ):.
+0000f770: 2020 2020 2020 2020 7265 7370 6f6e 7365          response
+0000f780: 203d 2061 7761 6974 2063 6c69 656e 742e   = await client.
+0000f790: 706f 7374 280a 2020 2020 2020 2020 2020  post(.          
+0000f7a0: 2020 222f 6e6f 7465 626f 6f6b 732f 6372    "/notebooks/cr
+0000f7b0: 6561 7465 222c 0a20 2020 2020 2020 2020  eate",.         
+0000f7c0: 2020 2071 7565 7279 5f73 7472 696e 673d     query_string=
+0000f7d0: 7b22 6b73 7065 635f 6e61 6d65 223a 2022  {"kspec_name": "
+0000f7e0: 6972 222c 2022 6669 6c65 6e61 6d65 223a  ir", "filename":
+0000f7f0: 2022 6865 7970 227d 2c0a 2020 2020 2020   "heyp"},.      
+0000f800: 2020 2020 2020 6865 6164 6572 733d 7375        headers=su
+0000f810: 7065 7275 7365 725f 746f 6b65 6e5f 6865  peruser_token_he
+0000f820: 6164 6572 732c 0a20 2020 2020 2020 2029  aders,.        )
+0000f830: 0a20 2020 2020 2020 2061 7373 6572 7420  .        assert 
+0000f840: 7265 7370 6f6e 7365 2e73 7461 7475 735f  response.status_
+0000f850: 636f 6465 203d 3d20 3230 310a 2020 2020  code == 201.    
+0000f860: 2020 2020 7265 7370 5f6a 736f 6e20 3d20      resp_json = 
+0000f870: 7265 7370 6f6e 7365 2e6a 736f 6e28 295b  response.json()[
+0000f880: 226e 6f74 6562 6f6f 6b22 5d0a 2020 2020  "notebook"].    
+0000f890: 2020 2020 7575 6964 203d 2072 6573 705f      uuid = resp_
+0000f8a0: 6a73 6f6e 5b22 6d65 7461 6461 7461 225d  json["metadata"]
+0000f8b0: 5b22 6a75 7079 7465 725f 6431 225d 5b22  ["jupyter_d1"]["
+0000f8c0: 7575 6964 225d 0a0a 2020 2020 2020 2020  uuid"]..        
+0000f8d0: 7265 7370 6f6e 7365 203d 2061 7761 6974  response = await
+0000f8e0: 2063 6c69 656e 742e 6765 7428 0a20 2020   client.get(.   
+0000f8f0: 2020 2020 2020 2020 2066 222f 6e6f 7465           f"/note
+0000f900: 626f 6f6b 732f 7b75 7569 647d 2f76 6172  books/{uuid}/var
+0000f910: 7322 2c20 6865 6164 6572 733d 7375 7065  s", headers=supe
+0000f920: 7275 7365 725f 746f 6b65 6e5f 6865 6164  ruser_token_head
+0000f930: 6572 730a 2020 2020 2020 2020 290a 2020  ers.        ).  
+0000f940: 2020 2020 2020 6173 7365 7274 2072 6573        assert res
+0000f950: 706f 6e73 652e 7374 6174 7573 5f63 6f64  ponse.status_cod
+0000f960: 6520 3d3d 2032 3030 0a20 2020 2020 2020  e == 200.       
+0000f970: 2076 6172 735f 6c69 7374 203d 2072 6573   vars_list = res
+0000f980: 706f 6e73 652e 6a73 6f6e 2829 5b22 7661  ponse.json()["va
+0000f990: 7273 225d 0a20 2020 2020 2020 2061 7373  rs"].        ass
+0000f9a0: 6572 7420 6c65 6e28 7661 7273 5f6c 6973  ert len(vars_lis
+0000f9b0: 7429 203d 3d20 300a 0a20 2020 2020 2020  t) == 0..       
+0000f9c0: 2061 7379 6e63 2077 6974 6820 636c 6965   async with clie
+0000f9d0: 6e74 2e77 6562 736f 636b 6574 5f63 6f6e  nt.websocket_con
+0000f9e0: 6e65 6374 280a 2020 2020 2020 2020 2020  nect(.          
+0000f9f0: 2020 6622 2f6e 6f74 6562 6f6f 6b73 2f7b    f"/notebooks/{
+0000fa00: 7575 6964 7d2f 7773 2f6e 6f74 6562 6f6f  uuid}/ws/noteboo
+0000fa10: 6b22 2c20 6865 6164 6572 733d 7375 7065  k", headers=supe
+0000fa20: 7275 7365 725f 746f 6b65 6e5f 6865 6164  ruser_token_head
+0000fa30: 6572 730a 2020 2020 2020 2020 2920 6173  ers.        ) as
+0000fa40: 2077 6562 736f 636b 6574 3a0a 2020 2020   websocket:.    
+0000fa50: 2020 2020 2020 2020 6177 6169 7420 6173          await as
+0000fa60: 796e 6369 6f2e 736c 6565 7028 5745 4253  yncio.sleep(WEBS
+0000fa70: 4f43 4b45 545f 534c 4545 505f 5449 4d45  OCKET_SLEEP_TIME
+0000fa80: 290a 0a20 2020 2020 2020 2020 2020 2072  )..            r
+0000fa90: 6573 706f 6e73 6520 3d20 6177 6169 7420  esponse = await 
+0000faa0: 636c 6965 6e74 2e70 6f73 7428 0a20 2020  client.post(.   
+0000fab0: 2020 2020 2020 2020 2020 2020 2066 222f               f"/
+0000fac0: 6e6f 7465 626f 6f6b 732f 7b75 7569 647d  notebooks/{uuid}
+0000fad0: 2f73 6372 6174 6368 5f65 7865 6375 7465  /scratch_execute
+0000fae0: 222c 0a20 2020 2020 2020 2020 2020 2020  ",.             
+0000faf0: 2020 2068 6561 6465 7273 3d73 7570 6572     headers=super
+0000fb00: 7573 6572 5f74 6f6b 656e 5f68 6561 6465  user_token_heade
+0000fb10: 7273 2c0a 2020 2020 2020 2020 2020 2020  rs,.            
+0000fb20: 2020 2020 6a73 6f6e 3d7b 0a20 2020 2020      json={.     
+0000fb30: 2020 2020 2020 2020 2020 2020 2020 2022                 "
+0000fb40: 636f 6465 223a 2022 6666 6f20 3c2d 2039  code": "ffo <- 9
+0000fb50: 5c6e 220a 2020 2020 2020 2020 2020 2020  \n".            
+0000fb60: 2020 2020 2020 2020 276b 203d 2064 6174          'k = dat
+0000fb70: 612e 6672 616d 6528 636f 6c31 3d63 2822  a.frame(col1=c("
+0000fb80: 7422 2c20 3529 2c20 270a 2020 2020 2020  t", 5), '.      
+0000fb90: 2020 2020 2020 2020 2020 2020 2020 2763                'c
+0000fba0: 6f6c 323d 6328 2234 222c 2036 292c 2063  ol2=c("4", 6), c
+0000fbb0: 6f6c 333d 6328 2268 222c 2038 2929 270a  ol3=c("h", 8))'.
+0000fbc0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000fbd0: 7d2c 0a20 2020 2020 2020 2020 2020 2029  },.            )
+0000fbe0: 0a20 2020 2020 2020 2020 2020 2061 7373  .            ass
+0000fbf0: 6572 7420 7265 7370 6f6e 7365 2e73 7461  ert response.sta
+0000fc00: 7475 735f 636f 6465 203d 3d20 3230 300a  tus_code == 200.
+0000fc10: 0a20 2020 2020 2020 2020 2020 2023 2047  .            # G
+0000fc20: 6976 6520 6974 2074 696d 6520 746f 2069  ive it time to i
+0000fc30: 6e73 7461 6c6c 2063 616c 6c69 7374 6f72  nstall callistor
+0000fc40: 0a20 2020 2020 2020 2020 2020 2061 7761  .            awa
+0000fc50: 6974 2061 7379 6e63 696f 2e73 6c65 6570  it asyncio.sleep
+0000fc60: 2831 3029 0a0a 2020 2020 2020 2020 2020  (10)..          
+0000fc70: 2020 6461 7461 203d 2061 7761 6974 2072    data = await r
+0000fc80: 6563 6569 7665 5f6a 736f 6e28 0a20 2020  eceive_json(.   
+0000fc90: 2020 2020 2020 2020 2020 2020 2077 6562               web
+0000fca0: 736f 636b 6574 2c20 7469 6d65 6f75 743d  socket, timeout=
+0000fcb0: 3630 2c20 6d73 675f 7479 7065 733d 5b22  60, msg_types=["
+0000fcc0: 7661 7273 225d 0a20 2020 2020 2020 2020  vars"].         
+0000fcd0: 2020 2029 0a20 2020 2020 2020 2020 2020     ).           
+0000fce0: 2076 6172 7320 3d20 7b76 6172 5b22 6e61   vars = {var["na
+0000fcf0: 6d65 225d 3a20 7661 7220 666f 7220 7661  me"]: var for va
+0000fd00: 7220 696e 2064 6174 615b 2276 6172 7322  r in data["vars"
+0000fd10: 5d7d 0a0a 2020 2020 2020 2020 2020 2020  ]}..            
+0000fd20: 6173 7365 7274 2076 6172 735b 2266 666f  assert vars["ffo
+0000fd30: 225d 5b22 7479 7065 225d 203d 3d20 226e  "]["type"] == "n
+0000fd40: 756d 6572 6963 220a 2020 2020 2020 2020  umeric".        
+0000fd50: 2020 2020 6173 7365 7274 2076 6172 735b      assert vars[
+0000fd60: 2266 666f 225d 5b22 6162 6272 6576 6961  "ffo"]["abbrevia
+0000fd70: 7465 6422 5d20 6973 2046 616c 7365 0a20  ted"] is False. 
+0000fd80: 2020 2020 2020 2020 2020 2061 7373 6572             asser
+0000fd90: 7420 7661 7273 5b22 6666 6f22 5d5b 2273  t vars["ffo"]["s
+0000fda0: 756d 6d61 7279 225d 203d 3d20 2239 220a  ummary"] == "9".
+0000fdb0: 2020 2020 2020 2020 2020 2020 6173 7365              asse
+0000fdc0: 7274 2076 6172 735b 2266 666f 225d 5b22  rt vars["ffo"]["
+0000fdd0: 7661 6c75 6522 5d5b 2273 696e 676c 655f  value"]["single_
+0000fde0: 7661 6c75 6522 5d20 3d3d 2022 3922 0a20  value"] == "9". 
+0000fdf0: 2020 2020 2020 2020 2020 2061 7373 6572             asser
+0000fe00: 7420 7661 7273 5b22 6b22 5d5b 2274 7970  t vars["k"]["typ
+0000fe10: 6522 5d20 3d3d 2022 6461 7461 2e66 7261  e"] == "data.fra
+0000fe20: 6d65 220a 2020 2020 2020 2020 2020 2020  me".            
+0000fe30: 6173 7365 7274 2076 6172 735b 226b 225d  assert vars["k"]
+0000fe40: 5b22 6162 6272 6576 6961 7465 6422 5d20  ["abbreviated"] 
+0000fe50: 6973 2046 616c 7365 0a20 2020 2020 2020  is False.       
+0000fe60: 2020 2020 2061 7373 6572 7420 2253 697a       assert "Siz
+0000fe70: 653a 2032 7833 204d 656d 6f72 793a 2022  e: 2x3 Memory: "
+0000fe80: 2069 6e20 7661 7273 5b22 6b22 5d5b 2273   in vars["k"]["s
+0000fe90: 756d 6d61 7279 225d 0a20 2020 2020 2020  ummary"].       
+0000fea0: 2020 2020 2061 7373 6572 7420 7661 7273       assert vars
+0000feb0: 5b22 6b22 5d5b 2276 616c 7565 225d 5b22  ["k"]["value"]["
+0000fec0: 6d75 6c74 695f 7661 6c75 6522 5d5b 2263  multi_value"]["c
+0000fed0: 6f6c 756d 6e5f 636f 756e 7422 5d20 3d3d  olumn_count"] ==
+0000fee0: 2033 0a20 2020 2020 2020 2020 2020 2061   3.            a
+0000fef0: 7373 6572 7420 7661 7273 5b22 6b22 5d5b  ssert vars["k"][
+0000ff00: 2276 616c 7565 225d 5b22 6d75 6c74 695f  "value"]["multi_
+0000ff10: 7661 6c75 6522 5d5b 2272 6f77 5f63 6f75  value"]["row_cou
+0000ff20: 6e74 225d 203d 3d20 320a 2020 2020 2020  nt"] == 2.      
+0000ff30: 2020 2020 2020 6173 7365 7274 2076 6172        assert var
+0000ff40: 735b 226b 225d 5b22 7661 6c75 6522 5d5b  s["k"]["value"][
+0000ff50: 226d 756c 7469 5f76 616c 7565 225d 5b22  "multi_value"]["
+0000ff60: 636f 6c75 6d6e 5f6e 616d 6573 225d 203d  column_names"] =
+0000ff70: 3d20 5b0a 2020 2020 2020 2020 2020 2020  = [.            
+0000ff80: 2020 2020 2263 6f6c 3120 2863 6861 7261      "col1 (chara
+0000ff90: 6374 6572 2922 2c0a 2020 2020 2020 2020  cter)",.        
+0000ffa0: 2020 2020 2020 2020 2263 6f6c 3220 2863          "col2 (c
+0000ffb0: 6861 7261 6374 6572 2922 2c0a 2020 2020  haracter)",.    
+0000ffc0: 2020 2020 2020 2020 2020 2020 2263 6f6c              "col
+0000ffd0: 3320 2863 6861 7261 6374 6572 2922 2c0a  3 (character)",.
+0000ffe0: 2020 2020 2020 2020 2020 2020 5d0a 2020              ].  
 0000fff0: 2020 2020 2020 2020 2020 6173 7365 7274            assert
-00010000: 2064 6174 615b 2270 6179 6c6f 6164 5f70   data["payload_p
-00010010: 6167 6522 5d5b 226d 6573 7361 6765 5f69  age"]["message_i
-00010020: 6422 5d20 3d3d 206d 7367 5f69 640a 2020  d"] == msg_id.  
-00010030: 2020 2020 2020 2020 2020 6173 7365 7274            assert
-00010040: 2064 6174 615b 2270 6179 6c6f 6164 5f70   data["payload_p
-00010050: 6167 6522 5d5b 2273 7461 7274 225d 203d  age"]["start"] =
-00010060: 3d20 300a 0a20 2020 2040 7079 7465 7374  = 0..    @pytest
-00010070: 2e6d 6172 6b2e 6173 796e 6369 6f0a 2020  .mark.asyncio.  
-00010080: 2020 6173 796e 6320 6465 6620 7465 7374    async def test
-00010090: 5f63 6f64 655f 636f 6d70 6c65 7469 6f6e  _code_completion
-000100a0: 280a 2020 2020 2020 2020 7365 6c66 2c20  (.        self, 
-000100b0: 636c 6965 6e74 3a20 5465 7374 436c 6965  client: TestClie
-000100c0: 6e74 2c20 7375 7065 7275 7365 725f 746f  nt, superuser_to
-000100d0: 6b65 6e5f 6865 6164 6572 733a 2044 6963  ken_headers: Dic
-000100e0: 745b 7374 722c 2073 7472 5d0a 2020 2020  t[str, str].    
-000100f0: 293a 0a20 2020 2020 2020 2072 6573 706f  ):.        respo
-00010100: 6e73 6520 3d20 6177 6169 7420 636c 6965  nse = await clie
-00010110: 6e74 2e70 6f73 7428 0a20 2020 2020 2020  nt.post(.       
-00010120: 2020 2020 2022 2f6e 6f74 6562 6f6f 6b73       "/notebooks
-00010130: 2f63 7265 6174 6522 2c0a 2020 2020 2020  /create",.      
-00010140: 2020 2020 2020 7175 6572 795f 7374 7269        query_stri
-00010150: 6e67 3d7b 226b 7370 6563 5f6e 616d 6522  ng={"kspec_name"
-00010160: 3a20 2270 7974 686f 6e22 2c20 2266 696c  : "python", "fil
-00010170: 656e 616d 6522 3a20 2268 6579 7022 7d2c  ename": "heyp"},
-00010180: 0a20 2020 2020 2020 2020 2020 2068 6561  .            hea
-00010190: 6465 7273 3d73 7570 6572 7573 6572 5f74  ders=superuser_t
-000101a0: 6f6b 656e 5f68 6561 6465 7273 2c0a 2020  oken_headers,.  
-000101b0: 2020 2020 2020 290a 2020 2020 2020 2020        ).        
-000101c0: 6173 7365 7274 2072 6573 706f 6e73 652e  assert response.
-000101d0: 7374 6174 7573 5f63 6f64 6520 3d3d 2032  status_code == 2
-000101e0: 3031 0a20 2020 2020 2020 2072 6573 705f  01.        resp_
-000101f0: 6a73 6f6e 203d 2072 6573 706f 6e73 652e  json = response.
-00010200: 6a73 6f6e 2829 5b22 6e6f 7465 626f 6f6b  json()["notebook
-00010210: 225d 0a20 2020 2020 2020 2075 7569 6420  "].        uuid 
-00010220: 3d20 7265 7370 5f6a 736f 6e5b 226d 6574  = resp_json["met
-00010230: 6164 6174 6122 5d5b 226a 7570 7974 6572  adata"]["jupyter
-00010240: 5f64 3122 5d5b 2275 7569 6422 5d0a 0a20  _d1"]["uuid"].. 
-00010250: 2020 2020 2020 2061 7379 6e63 2077 6974         async wit
-00010260: 6820 636c 6965 6e74 2e77 6562 736f 636b  h client.websock
-00010270: 6574 5f63 6f6e 6e65 6374 280a 2020 2020  et_connect(.    
-00010280: 2020 2020 2020 2020 6622 2f6e 6f74 6562          f"/noteb
-00010290: 6f6f 6b73 2f7b 7575 6964 7d2f 7773 2f6e  ooks/{uuid}/ws/n
-000102a0: 6f74 6562 6f6f 6b22 2c20 6865 6164 6572  otebook", header
-000102b0: 733d 7375 7065 7275 7365 725f 746f 6b65  s=superuser_toke
-000102c0: 6e5f 6865 6164 6572 730a 2020 2020 2020  n_headers.      
-000102d0: 2020 2920 6173 2077 6562 736f 636b 6574    ) as websocket
-000102e0: 3a0a 2020 2020 2020 2020 2020 2020 6177  :.            aw
-000102f0: 6169 7420 6173 796e 6369 6f2e 736c 6565  ait asyncio.slee
-00010300: 7028 5745 4253 4f43 4b45 545f 534c 4545  p(WEBSOCKET_SLEE
-00010310: 505f 5449 4d45 290a 0a20 2020 2020 2020  P_TIME)..       
-00010320: 2020 2020 2072 6573 706f 6e73 6520 3d20       response = 
-00010330: 6177 6169 7420 636c 6965 6e74 2e70 6f73  await client.pos
-00010340: 7428 0a20 2020 2020 2020 2020 2020 2020  t(.             
-00010350: 2020 2066 222f 6e6f 7465 626f 6f6b 732f     f"/notebooks/
-00010360: 7b75 7569 647d 2f63 6f6d 706c 6574 6522  {uuid}/complete"
-00010370: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
-00010380: 2020 6a73 6f6e 3d7b 2263 6f64 6522 3a20    json={"code": 
-00010390: 2273 227d 2c0a 2020 2020 2020 2020 2020  "s"},.          
-000103a0: 2020 2020 2020 6865 6164 6572 733d 7375        headers=su
-000103b0: 7065 7275 7365 725f 746f 6b65 6e5f 6865  peruser_token_he
-000103c0: 6164 6572 732c 0a20 2020 2020 2020 2020  aders,.         
-000103d0: 2020 2029 0a20 2020 2020 2020 2020 2020     ).           
-000103e0: 2061 7373 6572 7420 7265 7370 6f6e 7365   assert response
-000103f0: 2e73 7461 7475 735f 636f 6465 203d 3d20  .status_code == 
-00010400: 3230 300a 2020 2020 2020 2020 2020 2020  200.            
-00010410: 6d73 675f 6964 203d 2072 6573 706f 6e73  msg_id = respons
-00010420: 652e 6a73 6f6e 2829 5b22 6b65 726e 656c  e.json()["kernel
-00010430: 5f6d 6573 7361 6765 225d 5b22 6d65 7373  _message"]["mess
-00010440: 6167 655f 6964 225d 0a0a 2020 2020 2020  age_id"]..      
-00010450: 2020 2020 2020 6461 7461 203d 2061 7761        data = awa
-00010460: 6974 2072 6563 6569 7665 5f6a 736f 6e28  it receive_json(
-00010470: 7765 6273 6f63 6b65 7429 0a20 2020 2020  websocket).     
-00010480: 2020 2020 2020 2061 7373 6572 7420 6c65         assert le
-00010490: 6e28 6461 7461 5b22 636f 6d70 6c65 7465  n(data["complete
-000104a0: 5f72 6570 6c79 225d 5b22 6d61 7463 6865  _reply"]["matche
-000104b0: 7322 5d29 203e 2030 0a20 2020 2020 2020  s"]) > 0.       
-000104c0: 2020 2020 2061 7373 6572 7420 6461 7461       assert data
-000104d0: 5b22 636f 6d70 6c65 7465 5f72 6570 6c79  ["complete_reply
-000104e0: 225d 5b22 6d65 7373 6167 655f 6964 225d  "]["message_id"]
-000104f0: 203d 3d20 6d73 675f 6964 0a20 2020 2020   == msg_id.     
-00010500: 2020 2020 2020 2061 7373 6572 7420 6461         assert da
-00010510: 7461 5b22 636f 6d70 6c65 7465 5f72 6570  ta["complete_rep
-00010520: 6c79 225d 5b22 6375 7273 6f72 5f73 7461  ly"]["cursor_sta
-00010530: 7274 225d 203d 3d20 300a 2020 2020 2020  rt"] == 0.      
-00010540: 2020 2020 2020 6173 7365 7274 2064 6174        assert dat
-00010550: 615b 2263 6f6d 706c 6574 655f 7265 706c  a["complete_repl
-00010560: 7922 5d5b 2263 7572 736f 725f 656e 6422  y"]["cursor_end"
-00010570: 5d20 3d3d 2031 0a0a 2020 2020 4070 7974  ] == 1..    @pyt
-00010580: 6573 742e 6d61 726b 2e61 7379 6e63 696f  est.mark.asyncio
-00010590: 0a20 2020 2061 7379 6e63 2064 6566 2074  .    async def t
-000105a0: 6573 745f 636f 6465 5f63 6f6d 706c 6574  est_code_complet
-000105b0: 696f 6e5f 6375 7273 6f72 5f70 6f73 6974  ion_cursor_posit
-000105c0: 696f 6e28 0a20 2020 2020 2020 2073 656c  ion(.        sel
-000105d0: 662c 2063 6c69 656e 743a 2054 6573 7443  f, client: TestC
-000105e0: 6c69 656e 742c 2073 7570 6572 7573 6572  lient, superuser
-000105f0: 5f74 6f6b 656e 5f68 6561 6465 7273 3a20  _token_headers: 
-00010600: 4469 6374 5b73 7472 2c20 7374 725d 0a20  Dict[str, str]. 
-00010610: 2020 2029 3a0a 2020 2020 2020 2020 7265     ):.        re
-00010620: 7370 6f6e 7365 203d 2061 7761 6974 2063  sponse = await c
-00010630: 6c69 656e 742e 706f 7374 280a 2020 2020  lient.post(.    
-00010640: 2020 2020 2020 2020 222f 6e6f 7465 626f          "/notebo
-00010650: 6f6b 732f 6372 6561 7465 222c 0a20 2020  oks/create",.   
-00010660: 2020 2020 2020 2020 2071 7565 7279 5f73           query_s
-00010670: 7472 696e 673d 7b22 6b73 7065 635f 6e61  tring={"kspec_na
-00010680: 6d65 223a 2022 7079 7468 6f6e 222c 2022  me": "python", "
-00010690: 6669 6c65 6e61 6d65 223a 2022 6865 7970  filename": "heyp
-000106a0: 227d 2c0a 2020 2020 2020 2020 2020 2020  "},.            
-000106b0: 6865 6164 6572 733d 7375 7065 7275 7365  headers=superuse
-000106c0: 725f 746f 6b65 6e5f 6865 6164 6572 732c  r_token_headers,
-000106d0: 0a20 2020 2020 2020 2029 0a20 2020 2020  .        ).     
-000106e0: 2020 2061 7373 6572 7420 7265 7370 6f6e     assert respon
-000106f0: 7365 2e73 7461 7475 735f 636f 6465 203d  se.status_code =
-00010700: 3d20 3230 310a 2020 2020 2020 2020 7265  = 201.        re
-00010710: 7370 5f6a 736f 6e20 3d20 7265 7370 6f6e  sp_json = respon
-00010720: 7365 2e6a 736f 6e28 295b 226e 6f74 6562  se.json()["noteb
-00010730: 6f6f 6b22 5d0a 2020 2020 2020 2020 7575  ook"].        uu
-00010740: 6964 203d 2072 6573 705f 6a73 6f6e 5b22  id = resp_json["
-00010750: 6d65 7461 6461 7461 225d 5b22 6a75 7079  metadata"]["jupy
-00010760: 7465 725f 6431 225d 5b22 7575 6964 225d  ter_d1"]["uuid"]
-00010770: 0a0a 2020 2020 2020 2020 6173 796e 6320  ..        async 
-00010780: 7769 7468 2063 6c69 656e 742e 7765 6273  with client.webs
-00010790: 6f63 6b65 745f 636f 6e6e 6563 7428 0a20  ocket_connect(. 
-000107a0: 2020 2020 2020 2020 2020 2066 222f 6e6f             f"/no
-000107b0: 7465 626f 6f6b 732f 7b75 7569 647d 2f77  tebooks/{uuid}/w
-000107c0: 732f 6e6f 7465 626f 6f6b 222c 2068 6561  s/notebook", hea
-000107d0: 6465 7273 3d73 7570 6572 7573 6572 5f74  ders=superuser_t
-000107e0: 6f6b 656e 5f68 6561 6465 7273 0a20 2020  oken_headers.   
-000107f0: 2020 2020 2029 2061 7320 7765 6273 6f63       ) as websoc
-00010800: 6b65 743a 0a20 2020 2020 2020 2020 2020  ket:.           
-00010810: 2061 7761 6974 2061 7379 6e63 696f 2e73   await asyncio.s
-00010820: 6c65 6570 2857 4542 534f 434b 4554 5f53  leep(WEBSOCKET_S
-00010830: 4c45 4550 5f54 494d 4529 0a0a 2020 2020  LEEP_TIME)..    
-00010840: 2020 2020 2020 2020 7265 7370 6f6e 7365          response
-00010850: 203d 2061 7761 6974 2063 6c69 656e 742e   = await client.
-00010860: 706f 7374 280a 2020 2020 2020 2020 2020  post(.          
-00010870: 2020 2020 2020 6622 2f6e 6f74 6562 6f6f        f"/noteboo
-00010880: 6b73 2f7b 7575 6964 7d2f 636f 6d70 6c65  ks/{uuid}/comple
-00010890: 7465 222c 0a20 2020 2020 2020 2020 2020  te",.           
-000108a0: 2020 2020 206a 736f 6e3d 7b22 636f 6465       json={"code
-000108b0: 223a 2022 3520 2b20 7072 696e 202b 2036  ": "5 + prin + 6
-000108c0: 222c 2022 6375 7273 6f72 5f70 6f73 6974  ", "cursor_posit
-000108d0: 696f 6e22 3a20 377d 2c0a 2020 2020 2020  ion": 7},.      
-000108e0: 2020 2020 2020 2020 2020 6865 6164 6572            header
-000108f0: 733d 7375 7065 7275 7365 725f 746f 6b65  s=superuser_toke
-00010900: 6e5f 6865 6164 6572 732c 0a20 2020 2020  n_headers,.     
-00010910: 2020 2020 2020 2029 0a20 2020 2020 2020         ).       
-00010920: 2020 2020 2061 7373 6572 7420 7265 7370       assert resp
-00010930: 6f6e 7365 2e73 7461 7475 735f 636f 6465  onse.status_code
-00010940: 203d 3d20 3230 300a 2020 2020 2020 2020   == 200.        
-00010950: 2020 2020 6d73 675f 6964 203d 2072 6573      msg_id = res
-00010960: 706f 6e73 652e 6a73 6f6e 2829 5b22 6b65  ponse.json()["ke
-00010970: 726e 656c 5f6d 6573 7361 6765 225d 5b22  rnel_message"]["
-00010980: 6d65 7373 6167 655f 6964 225d 0a0a 2020  message_id"]..  
-00010990: 2020 2020 2020 2020 2020 6461 7461 203d            data =
-000109a0: 2061 7761 6974 2072 6563 6569 7665 5f6a   await receive_j
-000109b0: 736f 6e28 7765 6273 6f63 6b65 7429 0a20  son(websocket). 
-000109c0: 2020 2020 2020 2020 2020 2061 7373 6572             asser
-000109d0: 7420 6461 7461 5b22 636f 6d70 6c65 7465  t data["complete
-000109e0: 5f72 6570 6c79 225d 5b22 6d61 7463 6865  _reply"]["matche
-000109f0: 7322 5d20 3d3d 205b 2270 7269 6e74 225d  s"] == ["print"]
-00010a00: 0a20 2020 2020 2020 2020 2020 2061 7373  .            ass
-00010a10: 6572 7420 6461 7461 5b22 636f 6d70 6c65  ert data["comple
-00010a20: 7465 5f72 6570 6c79 225d 5b22 6d65 7373  te_reply"]["mess
-00010a30: 6167 655f 6964 225d 203d 3d20 6d73 675f  age_id"] == msg_
-00010a40: 6964 0a20 2020 2020 2020 2020 2020 2061  id.            a
-00010a50: 7373 6572 7420 6461 7461 5b22 636f 6d70  ssert data["comp
-00010a60: 6c65 7465 5f72 6570 6c79 225d 5b22 6375  lete_reply"]["cu
-00010a70: 7273 6f72 5f73 7461 7274 225d 203d 3d20  rsor_start"] == 
-00010a80: 340a 2020 2020 2020 2020 2020 2020 6173  4.            as
-00010a90: 7365 7274 2064 6174 615b 2263 6f6d 706c  sert data["compl
-00010aa0: 6574 655f 7265 706c 7922 5d5b 2263 7572  ete_reply"]["cur
-00010ab0: 736f 725f 656e 6422 5d20 3d3d 2037 0a0a  sor_end"] == 7..
-00010ac0: 2020 2020 4070 7974 6573 742e 6d61 726b      @pytest.mark
-00010ad0: 2e61 7379 6e63 696f 0a20 2020 2061 7379  .asyncio.    asy
-00010ae0: 6e63 2064 6566 2074 6573 745f 6869 7374  nc def test_hist
-00010af0: 6f72 7928 0a20 2020 2020 2020 2073 656c  ory(.        sel
-00010b00: 662c 2063 6c69 656e 743a 2054 6573 7443  f, client: TestC
-00010b10: 6c69 656e 742c 2073 7570 6572 7573 6572  lient, superuser
-00010b20: 5f74 6f6b 656e 5f68 6561 6465 7273 3a20  _token_headers: 
-00010b30: 4469 6374 5b73 7472 2c20 7374 725d 0a20  Dict[str, str]. 
-00010b40: 2020 2029 3a0a 2020 2020 2020 2020 7575     ):.        uu
-00010b50: 6964 203d 2061 7761 6974 2075 706c 6f61  id = await uploa
-00010b60: 645f 6e6f 7465 626f 6f6b 2863 6c69 656e  d_notebook(clien
-00010b70: 742c 2073 7570 6572 7573 6572 5f74 6f6b  t, superuser_tok
-00010b80: 656e 5f68 6561 6465 7273 290a 0a20 2020  en_headers)..   
-00010b90: 2020 2020 2072 6573 706f 6e73 6520 3d20       response = 
-00010ba0: 6177 6169 7420 636c 6965 6e74 2e67 6574  await client.get
-00010bb0: 280a 2020 2020 2020 2020 2020 2020 6622  (.            f"
-00010bc0: 2f6e 6f74 6562 6f6f 6b73 2f7b 7575 6964  /notebooks/{uuid
-00010bd0: 7d2f 6365 6c6c 7322 2c20 6865 6164 6572  }/cells", header
-00010be0: 733d 7375 7065 7275 7365 725f 746f 6b65  s=superuser_toke
-00010bf0: 6e5f 6865 6164 6572 730a 2020 2020 2020  n_headers.      
-00010c00: 2020 290a 2020 2020 2020 2020 6173 7365    ).        asse
-00010c10: 7274 2072 6573 706f 6e73 652e 7374 6174  rt response.stat
-00010c20: 7573 5f63 6f64 6520 3d3d 2032 3030 0a20  us_code == 200. 
-00010c30: 2020 2020 2020 2063 656c 6c73 203d 2072         cells = r
-00010c40: 6573 706f 6e73 652e 6a73 6f6e 2829 5b22  esponse.json()["
-00010c50: 6365 6c6c 7322 5d0a 0a20 2020 2020 2020  cells"]..       
-00010c60: 2063 656c 6c20 3d20 6365 6c6c 735b 325d   cell = cells[2]
-00010c70: 0a20 2020 2020 2020 2063 656c 6c5f 7575  .        cell_uu
-00010c80: 6964 203d 2063 656c 6c5b 226d 6574 6164  id = cell["metad
-00010c90: 6174 6122 5d5b 226a 7570 7974 6572 5f64  ata"]["jupyter_d
-00010ca0: 3122 5d5b 2275 7569 6422 5d0a 0a20 2020  1"]["uuid"]..   
-00010cb0: 2020 2020 2061 7379 6e63 2077 6974 6820       async with 
-00010cc0: 636c 6965 6e74 2e77 6562 736f 636b 6574  client.websocket
-00010cd0: 5f63 6f6e 6e65 6374 280a 2020 2020 2020  _connect(.      
-00010ce0: 2020 2020 2020 6622 2f6e 6f74 6562 6f6f        f"/noteboo
-00010cf0: 6b73 2f7b 7575 6964 7d2f 7773 2f6e 6f74  ks/{uuid}/ws/not
-00010d00: 6562 6f6f 6b22 2c20 6865 6164 6572 733d  ebook", headers=
-00010d10: 7375 7065 7275 7365 725f 746f 6b65 6e5f  superuser_token_
-00010d20: 6865 6164 6572 730a 2020 2020 2020 2020  headers.        
-00010d30: 2920 6173 2077 6562 736f 636b 6574 3a0a  ) as websocket:.
-00010d40: 2020 2020 2020 2020 2020 2020 6177 6169              awai
-00010d50: 7420 6173 796e 6369 6f2e 736c 6565 7028  t asyncio.sleep(
-00010d60: 5745 4253 4f43 4b45 545f 534c 4545 505f  WEBSOCKET_SLEEP_
-00010d70: 5449 4d45 290a 0a20 2020 2020 2020 2020  TIME)..         
-00010d80: 2020 2072 6573 706f 6e73 6520 3d20 6177     response = aw
-00010d90: 6169 7420 636c 6965 6e74 2e67 6574 280a  ait client.get(.
-00010da0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00010db0: 6622 2f6e 6f74 6562 6f6f 6b73 2f7b 7575  f"/notebooks/{uu
-00010dc0: 6964 7d2f 6365 6c6c 732f 7b63 656c 6c5f  id}/cells/{cell_
-00010dd0: 7575 6964 7d2f 6578 6563 7574 6522 2c0a  uuid}/execute",.
-00010de0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00010df0: 6865 6164 6572 733d 7375 7065 7275 7365  headers=superuse
-00010e00: 725f 746f 6b65 6e5f 6865 6164 6572 732c  r_token_headers,
-00010e10: 0a20 2020 2020 2020 2020 2020 2029 0a20  .            ). 
-00010e20: 2020 2020 2020 2020 2020 2061 7373 6572             asser
-00010e30: 7420 7265 7370 6f6e 7365 2e73 7461 7475  t response.statu
-00010e40: 735f 636f 6465 203d 3d20 3230 300a 0a20  s_code == 200.. 
-00010e50: 2020 2020 2020 2020 2020 2061 7761 6974             await
-00010e60: 2072 6563 6569 7665 5f6a 736f 6e28 7765   receive_json(we
-00010e70: 6273 6f63 6b65 7429 0a20 2020 2020 2020  bsocket).       
-00010e80: 2020 2020 2061 7761 6974 2072 6563 6569       await recei
-00010e90: 7665 5f6a 736f 6e28 7765 6273 6f63 6b65  ve_json(websocke
-00010ea0: 7429 0a20 2020 2020 2020 2020 2020 2061  t).            a
-00010eb0: 7761 6974 2072 6563 6569 7665 5f6a 736f  wait receive_jso
-00010ec0: 6e28 7765 6273 6f63 6b65 7429 0a20 2020  n(websocket).   
-00010ed0: 2020 2020 2020 2020 2061 7761 6974 2072           await r
-00010ee0: 6563 6569 7665 5f6a 736f 6e28 7765 6273  eceive_json(webs
-00010ef0: 6f63 6b65 7429 0a20 2020 2020 2020 2020  ocket).         
-00010f00: 2020 2061 7761 6974 2072 6563 6569 7665     await receive
-00010f10: 5f6a 736f 6e28 7765 6273 6f63 6b65 7429  _json(websocket)
-00010f20: 0a0a 2020 2020 2020 2020 2020 2020 7265  ..            re
-00010f30: 7370 6f6e 7365 203d 2061 7761 6974 2063  sponse = await c
-00010f40: 6c69 656e 742e 706f 7374 280a 2020 2020  lient.post(.    
-00010f50: 2020 2020 2020 2020 2020 2020 6622 2f6e              f"/n
-00010f60: 6f74 6562 6f6f 6b73 2f7b 7575 6964 7d2f  otebooks/{uuid}/
-00010f70: 6869 7374 6f72 7922 2c20 6865 6164 6572  history", header
-00010f80: 733d 7375 7065 7275 7365 725f 746f 6b65  s=superuser_toke
-00010f90: 6e5f 6865 6164 6572 730a 2020 2020 2020  n_headers.      
-00010fa0: 2020 2020 2020 290a 2020 2020 2020 2020        ).        
-00010fb0: 2020 2020 6173 7365 7274 2072 6573 706f      assert respo
-00010fc0: 6e73 652e 7374 6174 7573 5f63 6f64 6520  nse.status_code 
-00010fd0: 3d3d 2032 3030 0a20 2020 2020 2020 2020  == 200.         
-00010fe0: 2020 206d 7367 5f69 6420 3d20 7265 7370     msg_id = resp
-00010ff0: 6f6e 7365 2e6a 736f 6e28 295b 226b 6572  onse.json()["ker
-00011000: 6e65 6c5f 6d65 7373 6167 6522 5d5b 226d  nel_message"]["m
-00011010: 6573 7361 6765 5f69 6422 5d0a 0a20 2020  essage_id"]..   
-00011020: 2020 2020 2020 2020 2064 6174 6120 3d20           data = 
-00011030: 6177 6169 7420 7761 6974 5f66 6f72 5f65  await wait_for_e
-00011040: 7665 6e74 2877 6562 736f 636b 6574 2c20  vent(websocket, 
-00011050: 2268 6973 746f 7279 5f72 6570 6c79 2229  "history_reply")
-00011060: 0a0a 2020 2020 2020 2020 2020 2020 6173  ..            as
-00011070: 7365 7274 2064 6174 615b 2268 6973 746f  sert data["histo
-00011080: 7279 5f72 6570 6c79 225d 5b22 6d65 7373  ry_reply"]["mess
-00011090: 6167 655f 6964 225d 203d 3d20 6d73 675f  age_id"] == msg_
-000110a0: 6964 0a20 2020 2020 2020 2020 2020 2068  id.            h
-000110b0: 6973 746f 7279 203d 2064 6174 615b 2268  istory = data["h
-000110c0: 6973 746f 7279 5f72 6570 6c79 225d 5b22  istory_reply"]["
-000110d0: 6869 7374 6f72 7922 5d0a 2020 2020 2020  history"].      
-000110e0: 2020 2020 2020 6173 7365 7274 2068 6973        assert his
-000110f0: 746f 7279 5b30 5d5b 226c 696e 655f 6e75  tory[0]["line_nu
-00011100: 6d62 6572 225d 203d 3d20 300a 2020 2020  mber"] == 0.    
-00011110: 2020 2020 2020 2020 6173 7365 7274 2068          assert h
-00011120: 6973 746f 7279 5b30 5d5b 2269 6e70 7574  istory[0]["input
-00011130: 225d 203d 3d20 2222 0a20 2020 2020 2020  "] == "".       
-00011140: 2020 2020 2061 7373 6572 7420 6869 7374       assert hist
-00011150: 6f72 795b 305d 5b22 6f75 7470 7574 225d  ory[0]["output"]
-00011160: 2069 7320 4e6f 6e65 0a20 2020 2020 2020   is None.       
-00011170: 2020 2020 2061 7373 6572 7420 6869 7374       assert hist
-00011180: 6f72 795b 315d 5b22 6c69 6e65 5f6e 756d  ory[1]["line_num
-00011190: 6265 7222 5d20 3d3d 2031 0a20 2020 2020  ber"] == 1.     
-000111a0: 2020 2020 2020 2061 7373 6572 7420 6869         assert hi
-000111b0: 7374 6f72 795b 315d 5b22 696e 7075 7422  story[1]["input"
-000111c0: 5d20 3d3d 2022 322b 3522 0a20 2020 2020  ] == "2+5".     
-000111d0: 2020 2020 2020 2061 7373 6572 7420 6869         assert hi
-000111e0: 7374 6f72 795b 315d 5b22 6f75 7470 7574  story[1]["output
-000111f0: 225d 203d 3d20 2237 220a 0a20 2020 2040  "] == "7"..    @
-00011200: 7079 7465 7374 2e6d 6172 6b2e 6173 796e  pytest.mark.asyn
-00011210: 6369 6f0a 2020 2020 6173 796e 6320 6465  cio.    async de
-00011220: 6620 7465 7374 5f72 6573 7461 7274 5f6b  f test_restart_k
-00011230: 6572 6e65 6c28 0a20 2020 2020 2020 2073  ernel(.        s
-00011240: 656c 662c 2063 6c69 656e 743a 2054 6573  elf, client: Tes
-00011250: 7443 6c69 656e 742c 2073 7570 6572 7573  tClient, superus
-00011260: 6572 5f74 6f6b 656e 5f68 6561 6465 7273  er_token_headers
-00011270: 3a20 4469 6374 5b73 7472 2c20 7374 725d  : Dict[str, str]
-00011280: 0a20 2020 2029 3a0a 2020 2020 2020 2020  .    ):.        
-00011290: 7575 6964 203d 2061 7761 6974 2075 706c  uuid = await upl
-000112a0: 6f61 645f 6e6f 7465 626f 6f6b 2863 6c69  oad_notebook(cli
-000112b0: 656e 742c 2073 7570 6572 7573 6572 5f74  ent, superuser_t
-000112c0: 6f6b 656e 5f68 6561 6465 7273 290a 0a20  oken_headers).. 
-000112d0: 2020 2020 2020 2072 6573 706f 6e73 6520         response 
-000112e0: 3d20 6177 6169 7420 636c 6965 6e74 2e67  = await client.g
-000112f0: 6574 280a 2020 2020 2020 2020 2020 2020  et(.            
-00011300: 6622 2f6e 6f74 6562 6f6f 6b73 2f7b 7575  f"/notebooks/{uu
-00011310: 6964 7d2f 6365 6c6c 7322 2c20 6865 6164  id}/cells", head
-00011320: 6572 733d 7375 7065 7275 7365 725f 746f  ers=superuser_to
-00011330: 6b65 6e5f 6865 6164 6572 730a 2020 2020  ken_headers.    
-00011340: 2020 2020 290a 2020 2020 2020 2020 6173      ).        as
-00011350: 7365 7274 2072 6573 706f 6e73 652e 7374  sert response.st
-00011360: 6174 7573 5f63 6f64 6520 3d3d 2032 3030  atus_code == 200
-00011370: 0a20 2020 2020 2020 2063 656c 6c73 203d  .        cells =
-00011380: 2072 6573 706f 6e73 652e 6a73 6f6e 2829   response.json()
-00011390: 5b22 6365 6c6c 7322 5d0a 0a20 2020 2020  ["cells"]..     
-000113a0: 2020 2063 656c 6c20 3d20 6365 6c6c 735b     cell = cells[
-000113b0: 325d 0a20 2020 2020 2020 2063 656c 6c5f  2].        cell_
-000113c0: 7575 6964 203d 2063 656c 6c5b 226d 6574  uuid = cell["met
-000113d0: 6164 6174 6122 5d5b 226a 7570 7974 6572  adata"]["jupyter
-000113e0: 5f64 3122 5d5b 2275 7569 6422 5d0a 0a20  _d1"]["uuid"].. 
-000113f0: 2020 2020 2020 2072 6573 706f 6e73 6520         response 
-00011400: 3d20 6177 6169 7420 636c 6965 6e74 2e67  = await client.g
-00011410: 6574 280a 2020 2020 2020 2020 2020 2020  et(.            
-00011420: 6622 2f6e 6f74 6562 6f6f 6b73 2f7b 7575  f"/notebooks/{uu
-00011430: 6964 7d2f 6365 6c6c 732f 7b63 656c 6c5f  id}/cells/{cell_
-00011440: 7575 6964 7d2f 6578 6563 7574 6522 2c0a  uuid}/execute",.
-00011450: 2020 2020 2020 2020 2020 2020 6865 6164              head
-00011460: 6572 733d 7375 7065 7275 7365 725f 746f  ers=superuser_to
-00011470: 6b65 6e5f 6865 6164 6572 732c 0a20 2020  ken_headers,.   
-00011480: 2020 2020 2029 0a20 2020 2020 2020 2061       ).        a
-00011490: 7373 6572 7420 7265 7370 6f6e 7365 2e73  ssert response.s
-000114a0: 7461 7475 735f 636f 6465 203d 3d20 3230  tatus_code == 20
-000114b0: 300a 0a20 2020 2020 2020 2072 6573 706f  0..        respo
-000114c0: 6e73 6520 3d20 6177 6169 7420 636c 6965  nse = await clie
-000114d0: 6e74 2e67 6574 280a 2020 2020 2020 2020  nt.get(.        
-000114e0: 2020 2020 6622 2f6e 6f74 6562 6f6f 6b73      f"/notebooks
-000114f0: 2f7b 7575 6964 7d2f 6365 6c6c 7322 2c20  /{uuid}/cells", 
-00011500: 6865 6164 6572 733d 7375 7065 7275 7365  headers=superuse
-00011510: 725f 746f 6b65 6e5f 6865 6164 6572 730a  r_token_headers.
-00011520: 2020 2020 2020 2020 290a 2020 2020 2020          ).      
-00011530: 2020 6173 7365 7274 2072 6573 706f 6e73    assert respons
-00011540: 652e 7374 6174 7573 5f63 6f64 6520 3d3d  e.status_code ==
-00011550: 2032 3030 0a20 2020 2020 2020 2063 656c   200.        cel
-00011560: 6c73 203d 2072 6573 706f 6e73 652e 6a73  ls = response.js
-00011570: 6f6e 2829 5b22 6365 6c6c 7322 5d0a 0a20  on()["cells"].. 
-00011580: 2020 2020 2020 2061 7373 6572 7420 6365         assert ce
-00011590: 6c6c 735b 325d 5b22 6f75 7470 7574 7322  lls[2]["outputs"
-000115a0: 5d5b 305d 5b22 6461 7461 225d 5b22 7465  ][0]["data"]["te
-000115b0: 7874 2f70 6c61 696e 225d 203d 3d20 2237  xt/plain"] == "7
-000115c0: 220a 0a20 2020 2020 2020 2061 7379 6e63  "..        async
-000115d0: 2077 6974 6820 636c 6965 6e74 2e77 6562   with client.web
-000115e0: 736f 636b 6574 5f63 6f6e 6e65 6374 280a  socket_connect(.
-000115f0: 2020 2020 2020 2020 2020 2020 6622 2f6e              f"/n
-00011600: 6f74 6562 6f6f 6b73 2f7b 7575 6964 7d2f  otebooks/{uuid}/
-00011610: 7773 2f6e 6f74 6562 6f6f 6b22 2c20 6865  ws/notebook", he
-00011620: 6164 6572 733d 7375 7065 7275 7365 725f  aders=superuser_
-00011630: 746f 6b65 6e5f 6865 6164 6572 730a 2020  token_headers.  
-00011640: 2020 2020 2020 2920 6173 2077 6562 736f        ) as webso
-00011650: 636b 6574 3a0a 0a20 2020 2020 2020 2020  cket:..         
-00011660: 2020 2061 7761 6974 2061 7379 6e63 696f     await asyncio
-00011670: 2e73 6c65 6570 2857 4542 534f 434b 4554  .sleep(WEBSOCKET
-00011680: 5f53 4c45 4550 5f54 494d 4529 0a0a 2020  _SLEEP_TIME)..  
-00011690: 2020 2020 2020 2020 2020 7265 7370 6f6e            respon
-000116a0: 7365 203d 2061 7761 6974 2063 6c69 656e  se = await clien
-000116b0: 742e 6765 7428 0a20 2020 2020 2020 2020  t.get(.         
-000116c0: 2020 2020 2020 2066 222f 6e6f 7465 626f         f"/notebo
-000116d0: 6f6b 732f 7b75 7569 647d 2f72 6573 7461  oks/{uuid}/resta
-000116e0: 7274 5f6b 6572 6e65 6c22 2c0a 2020 2020  rt_kernel",.    
-000116f0: 2020 2020 2020 2020 2020 2020 6865 6164              head
-00011700: 6572 733d 7375 7065 7275 7365 725f 746f  ers=superuser_to
-00011710: 6b65 6e5f 6865 6164 6572 732c 0a20 2020  ken_headers,.   
-00011720: 2020 2020 2020 2020 2029 0a0a 2020 2020           )..    
-00011730: 2020 2020 2020 2020 6173 7365 7274 2072          assert r
-00011740: 6573 706f 6e73 652e 7374 6174 7573 5f63  esponse.status_c
-00011750: 6f64 6520 3d3d 2032 3034 0a0a 2020 2020  ode == 204..    
-00011760: 2020 2020 2020 2020 6461 7461 203d 2061          data = a
-00011770: 7761 6974 2077 6169 745f 666f 725f 6576  wait wait_for_ev
-00011780: 656e 7428 7765 6273 6f63 6b65 742c 2022  ent(websocket, "
-00011790: 6b65 726e 656c 5f72 6573 7461 7274 6564  kernel_restarted
-000117a0: 2229 0a0a 2020 2020 2020 2020 2020 2020  ")..            
-000117b0: 6173 7365 7274 2064 6174 615b 226b 6572  assert data["ker
-000117c0: 6e65 6c5f 7265 7374 6172 7465 6422 5d5b  nel_restarted"][
-000117d0: 2272 756e 5f61 6c6c 5f63 656c 6c73 225d  "run_all_cells"]
-000117e0: 2069 7320 4661 6c73 650a 2020 2020 2020   is False.      
-000117f0: 2020 2020 2020 6365 6c6c 7320 3d20 6461        cells = da
-00011800: 7461 5b22 6b65 726e 656c 5f72 6573 7461  ta["kernel_resta
-00011810: 7274 6564 225d 5b22 6365 6c6c 7322 5d0a  rted"]["cells"].
-00011820: 2020 2020 2020 2020 2020 2020 6173 7365              asse
-00011830: 7274 2063 656c 6c73 5b32 5d5b 226f 7574  rt cells[2]["out
-00011840: 7075 7473 225d 5b30 5d5b 2264 6174 6122  puts"][0]["data"
-00011850: 5d5b 2274 6578 742f 706c 6169 6e22 5d20  ]["text/plain"] 
-00011860: 3d3d 2022 3722 0a20 2020 2020 2020 2020  == "7".         
-00011870: 2020 2061 7373 6572 7420 6365 6c6c 735b     assert cells[
-00011880: 325d 5b22 6578 6563 7574 696f 6e5f 636f  2]["execution_co
-00011890: 756e 7422 5d20 3d3d 2031 0a0a 2020 2020  unt"] == 1..    
-000118a0: 2020 2020 7265 7370 6f6e 7365 203d 2061      response = a
-000118b0: 7761 6974 2063 6c69 656e 742e 6765 7428  wait client.get(
-000118c0: 0a20 2020 2020 2020 2020 2020 2066 222f  .            f"/
-000118d0: 6e6f 7465 626f 6f6b 732f 7b75 7569 647d  notebooks/{uuid}
-000118e0: 2f63 656c 6c73 222c 2068 6561 6465 7273  /cells", headers
-000118f0: 3d73 7570 6572 7573 6572 5f74 6f6b 656e  =superuser_token
-00011900: 5f68 6561 6465 7273 0a20 2020 2020 2020  _headers.       
-00011910: 2029 0a20 2020 2020 2020 2061 7373 6572   ).        asser
-00011920: 7420 7265 7370 6f6e 7365 2e73 7461 7475  t response.statu
-00011930: 735f 636f 6465 203d 3d20 3230 300a 2020  s_code == 200.  
-00011940: 2020 2020 2020 6365 6c6c 7320 3d20 7265        cells = re
-00011950: 7370 6f6e 7365 2e6a 736f 6e28 295b 2263  sponse.json()["c
-00011960: 656c 6c73 225d 0a20 2020 2020 2020 2066  ells"].        f
-00011970: 6f72 2063 656c 6c20 696e 2063 656c 6c73  or cell in cells
-00011980: 3a0a 2020 2020 2020 2020 2020 2020 6173  :.            as
-00011990: 7365 7274 2063 656c 6c73 5b32 5d5b 226f  sert cells[2]["o
-000119a0: 7574 7075 7473 225d 5b30 5d5b 2264 6174  utputs"][0]["dat
-000119b0: 6122 5d5b 2274 6578 742f 706c 6169 6e22  a"]["text/plain"
-000119c0: 5d20 3d3d 2022 3722 0a20 2020 2020 2020  ] == "7".       
-000119d0: 2020 2020 2061 7373 6572 7420 6365 6c6c       assert cell
-000119e0: 735b 325d 5b22 6578 6563 7574 696f 6e5f  s[2]["execution_
-000119f0: 636f 756e 7422 5d20 3d3d 2031 0a0a 2020  count"] == 1..  
-00011a00: 2020 4070 7974 6573 742e 6d61 726b 2e61    @pytest.mark.a
-00011a10: 7379 6e63 696f 0a20 2020 2061 7379 6e63  syncio.    async
-00011a20: 2064 6566 2074 6573 745f 7265 7374 6172   def test_restar
-00011a30: 745f 6b65 726e 656c 5f61 6e64 5f63 6c65  t_kernel_and_cle
-00011a40: 6172 5f6f 7574 7075 7428 0a20 2020 2020  ar_output(.     
-00011a50: 2020 2073 656c 662c 2063 6c69 656e 743a     self, client:
-00011a60: 2054 6573 7443 6c69 656e 742c 2073 7570   TestClient, sup
-00011a70: 6572 7573 6572 5f74 6f6b 656e 5f68 6561  eruser_token_hea
-00011a80: 6465 7273 3a20 4469 6374 5b73 7472 2c20  ders: Dict[str, 
-00011a90: 7374 725d 0a20 2020 2029 3a0a 2020 2020  str].    ):.    
-00011aa0: 2020 2020 7575 6964 203d 2061 7761 6974      uuid = await
-00011ab0: 2075 706c 6f61 645f 6e6f 7465 626f 6f6b   upload_notebook
-00011ac0: 2863 6c69 656e 742c 2073 7570 6572 7573  (client, superus
-00011ad0: 6572 5f74 6f6b 656e 5f68 6561 6465 7273  er_token_headers
-00011ae0: 290a 0a20 2020 2020 2020 2072 6573 706f  )..        respo
-00011af0: 6e73 6520 3d20 6177 6169 7420 636c 6965  nse = await clie
-00011b00: 6e74 2e67 6574 280a 2020 2020 2020 2020  nt.get(.        
-00011b10: 2020 2020 6622 2f6e 6f74 6562 6f6f 6b73      f"/notebooks
-00011b20: 2f7b 7575 6964 7d2f 6365 6c6c 7322 2c20  /{uuid}/cells", 
-00011b30: 6865 6164 6572 733d 7375 7065 7275 7365  headers=superuse
-00011b40: 725f 746f 6b65 6e5f 6865 6164 6572 730a  r_token_headers.
-00011b50: 2020 2020 2020 2020 290a 2020 2020 2020          ).      
-00011b60: 2020 6173 7365 7274 2072 6573 706f 6e73    assert respons
-00011b70: 652e 7374 6174 7573 5f63 6f64 6520 3d3d  e.status_code ==
-00011b80: 2032 3030 0a20 2020 2020 2020 2063 656c   200.        cel
-00011b90: 6c73 203d 2072 6573 706f 6e73 652e 6a73  ls = response.js
-00011ba0: 6f6e 2829 5b22 6365 6c6c 7322 5d0a 0a20  on()["cells"].. 
-00011bb0: 2020 2020 2020 2063 656c 6c20 3d20 6365         cell = ce
-00011bc0: 6c6c 735b 325d 0a20 2020 2020 2020 2063  lls[2].        c
-00011bd0: 656c 6c5f 7575 6964 203d 2063 656c 6c5b  ell_uuid = cell[
-00011be0: 226d 6574 6164 6174 6122 5d5b 226a 7570  "metadata"]["jup
-00011bf0: 7974 6572 5f64 3122 5d5b 2275 7569 6422  yter_d1"]["uuid"
-00011c00: 5d0a 0a20 2020 2020 2020 2072 6573 706f  ]..        respo
-00011c10: 6e73 6520 3d20 6177 6169 7420 636c 6965  nse = await clie
-00011c20: 6e74 2e67 6574 280a 2020 2020 2020 2020  nt.get(.        
-00011c30: 2020 2020 6622 2f6e 6f74 6562 6f6f 6b73      f"/notebooks
-00011c40: 2f7b 7575 6964 7d2f 6365 6c6c 732f 7b63  /{uuid}/cells/{c
-00011c50: 656c 6c5f 7575 6964 7d2f 6578 6563 7574  ell_uuid}/execut
-00011c60: 6522 2c0a 2020 2020 2020 2020 2020 2020  e",.            
-00011c70: 6865 6164 6572 733d 7375 7065 7275 7365  headers=superuse
-00011c80: 725f 746f 6b65 6e5f 6865 6164 6572 732c  r_token_headers,
-00011c90: 0a20 2020 2020 2020 2029 0a20 2020 2020  .        ).     
-00011ca0: 2020 2061 7373 6572 7420 7265 7370 6f6e     assert respon
-00011cb0: 7365 2e73 7461 7475 735f 636f 6465 203d  se.status_code =
-00011cc0: 3d20 3230 300a 0a20 2020 2020 2020 2072  = 200..        r
-00011cd0: 6573 706f 6e73 6520 3d20 6177 6169 7420  esponse = await 
-00011ce0: 636c 6965 6e74 2e67 6574 280a 2020 2020  client.get(.    
-00011cf0: 2020 2020 2020 2020 6622 2f6e 6f74 6562          f"/noteb
-00011d00: 6f6f 6b73 2f7b 7575 6964 7d2f 6365 6c6c  ooks/{uuid}/cell
-00011d10: 7322 2c20 6865 6164 6572 733d 7375 7065  s", headers=supe
-00011d20: 7275 7365 725f 746f 6b65 6e5f 6865 6164  ruser_token_head
-00011d30: 6572 730a 2020 2020 2020 2020 290a 2020  ers.        ).  
-00011d40: 2020 2020 2020 6173 7365 7274 2072 6573        assert res
-00011d50: 706f 6e73 652e 7374 6174 7573 5f63 6f64  ponse.status_cod
-00011d60: 6520 3d3d 2032 3030 0a20 2020 2020 2020  e == 200.       
-00011d70: 2063 656c 6c73 203d 2072 6573 706f 6e73   cells = respons
-00011d80: 652e 6a73 6f6e 2829 5b22 6365 6c6c 7322  e.json()["cells"
-00011d90: 5d0a 0a20 2020 2020 2020 2061 7373 6572  ]..        asser
-00011da0: 7420 6365 6c6c 735b 325d 5b22 6f75 7470  t cells[2]["outp
-00011db0: 7574 7322 5d5b 305d 5b22 6461 7461 225d  uts"][0]["data"]
-00011dc0: 5b22 7465 7874 2f70 6c61 696e 225d 203d  ["text/plain"] =
-00011dd0: 3d20 2237 220a 0a20 2020 2020 2020 2061  = "7"..        a
-00011de0: 7379 6e63 2077 6974 6820 636c 6965 6e74  sync with client
-00011df0: 2e77 6562 736f 636b 6574 5f63 6f6e 6e65  .websocket_conne
-00011e00: 6374 280a 2020 2020 2020 2020 2020 2020  ct(.            
-00011e10: 6622 2f6e 6f74 6562 6f6f 6b73 2f7b 7575  f"/notebooks/{uu
-00011e20: 6964 7d2f 7773 2f6e 6f74 6562 6f6f 6b22  id}/ws/notebook"
-00011e30: 2c20 6865 6164 6572 733d 7375 7065 7275  , headers=superu
-00011e40: 7365 725f 746f 6b65 6e5f 6865 6164 6572  ser_token_header
-00011e50: 730a 2020 2020 2020 2020 2920 6173 2077  s.        ) as w
-00011e60: 6562 736f 636b 6574 3a0a 0a20 2020 2020  ebsocket:..     
-00011e70: 2020 2020 2020 2061 7761 6974 2061 7379         await asy
-00011e80: 6e63 696f 2e73 6c65 6570 2857 4542 534f  ncio.sleep(WEBSO
-00011e90: 434b 4554 5f53 4c45 4550 5f54 494d 4529  CKET_SLEEP_TIME)
-00011ea0: 0a0a 2020 2020 2020 2020 2020 2020 7265  ..            re
-00011eb0: 7370 6f6e 7365 203d 2061 7761 6974 2063  sponse = await c
-00011ec0: 6c69 656e 742e 6765 7428 0a20 2020 2020  lient.get(.     
-00011ed0: 2020 2020 2020 2020 2020 2066 222f 6e6f             f"/no
-00011ee0: 7465 626f 6f6b 732f 7b75 7569 647d 2f72  tebooks/{uuid}/r
-00011ef0: 6573 7461 7274 5f6b 6572 6e65 6c5f 616e  estart_kernel_an
-00011f00: 645f 636c 6561 725f 6f75 7470 7574 222c  d_clear_output",
-00011f10: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00011f20: 2068 6561 6465 7273 3d73 7570 6572 7573   headers=superus
-00011f30: 6572 5f74 6f6b 656e 5f68 6561 6465 7273  er_token_headers
-00011f40: 2c0a 2020 2020 2020 2020 2020 2020 290a  ,.            ).
-00011f50: 0a20 2020 2020 2020 2020 2020 2061 7373  .            ass
-00011f60: 6572 7420 7265 7370 6f6e 7365 2e73 7461  ert response.sta
-00011f70: 7475 735f 636f 6465 203d 3d20 3230 340a  tus_code == 204.
-00011f80: 0a20 2020 2020 2020 2020 2020 2064 6174  .            dat
-00011f90: 6120 3d20 6177 6169 7420 7761 6974 5f66  a = await wait_f
-00011fa0: 6f72 5f65 7665 6e74 2877 6562 736f 636b  or_event(websock
-00011fb0: 6574 2c20 226b 6572 6e65 6c5f 7265 7374  et, "kernel_rest
-00011fc0: 6172 7465 6422 290a 0a20 2020 2020 2020  arted")..       
-00011fd0: 2020 2020 2061 7373 6572 7420 6461 7461       assert data
-00011fe0: 5b22 6b65 726e 656c 5f72 6573 7461 7274  ["kernel_restart
-00011ff0: 6564 225d 5b22 7275 6e5f 616c 6c5f 6365  ed"]["run_all_ce
-00012000: 6c6c 7322 5d20 6973 2046 616c 7365 0a20  lls"] is False. 
-00012010: 2020 2020 2020 2020 2020 2063 656c 6c73             cells
-00012020: 203d 2064 6174 615b 226b 6572 6e65 6c5f   = data["kernel_
-00012030: 7265 7374 6172 7465 6422 5d5b 2263 656c  restarted"]["cel
-00012040: 6c73 225d 0a20 2020 2020 2020 2020 2020  ls"].           
-00012050: 2066 6f72 2063 656c 6c20 696e 2063 656c   for cell in cel
-00012060: 6c73 3a0a 2020 2020 2020 2020 2020 2020  ls:.            
-00012070: 2020 2020 6173 7365 7274 2028 0a20 2020      assert (.   
-00012080: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00012090: 2028 226f 7574 7075 7473 2220 6e6f 7420   ("outputs" not 
-000120a0: 696e 2063 656c 6c20 6f72 206c 656e 2863  in cell or len(c
-000120b0: 656c 6c5b 226f 7574 7075 7473 225d 2920  ell["outputs"]) 
-000120c0: 3d3d 2030 290a 2020 2020 2020 2020 2020  == 0).          
-000120d0: 2020 2020 2020 2020 2020 616e 6420 2265            and "e
-000120e0: 7865 6375 7469 6f6e 5f63 6f75 6e74 2220  xecution_count" 
-000120f0: 6e6f 7420 696e 2063 656c 6c0a 2020 2020  not in cell.    
-00012100: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00012110: 6f72 2063 656c 6c5b 2265 7865 6375 7469  or cell["executi
-00012120: 6f6e 5f63 6f75 6e74 225d 2069 7320 4e6f  on_count"] is No
-00012130: 6e65 0a20 2020 2020 2020 2020 2020 2020  ne.             
-00012140: 2020 2029 0a0a 2020 2020 2020 2020 7265     )..        re
-00012150: 7370 6f6e 7365 203d 2061 7761 6974 2063  sponse = await c
-00012160: 6c69 656e 742e 6765 7428 0a20 2020 2020  lient.get(.     
-00012170: 2020 2020 2020 2066 222f 6e6f 7465 626f         f"/notebo
-00012180: 6f6b 732f 7b75 7569 647d 2f63 656c 6c73  oks/{uuid}/cells
-00012190: 222c 2068 6561 6465 7273 3d73 7570 6572  ", headers=super
-000121a0: 7573 6572 5f74 6f6b 656e 5f68 6561 6465  user_token_heade
-000121b0: 7273 0a20 2020 2020 2020 2029 0a20 2020  rs.        ).   
-000121c0: 2020 2020 2061 7373 6572 7420 7265 7370       assert resp
-000121d0: 6f6e 7365 2e73 7461 7475 735f 636f 6465  onse.status_code
-000121e0: 203d 3d20 3230 300a 2020 2020 2020 2020   == 200.        
-000121f0: 6365 6c6c 7320 3d20 7265 7370 6f6e 7365  cells = response
-00012200: 2e6a 736f 6e28 295b 2263 656c 6c73 225d  .json()["cells"]
-00012210: 0a20 2020 2020 2020 2066 6f72 2063 656c  .        for cel
-00012220: 6c20 696e 2063 656c 6c73 3a0a 2020 2020  l in cells:.    
-00012230: 2020 2020 2020 2020 6173 7365 7274 2028          assert (
-00012240: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00012250: 2028 226f 7574 7075 7473 2220 6e6f 7420   ("outputs" not 
-00012260: 696e 2063 656c 6c20 6f72 206c 656e 2863  in cell or len(c
-00012270: 656c 6c5b 226f 7574 7075 7473 225d 2920  ell["outputs"]) 
-00012280: 3d3d 2030 290a 2020 2020 2020 2020 2020  == 0).          
-00012290: 2020 2020 2020 616e 6420 2265 7865 6375        and "execu
-000122a0: 7469 6f6e 5f63 6f75 6e74 2220 6e6f 7420  tion_count" not 
-000122b0: 696e 2063 656c 6c0a 2020 2020 2020 2020  in cell.        
-000122c0: 2020 2020 2020 2020 6f72 2063 656c 6c5b          or cell[
-000122d0: 2265 7865 6375 7469 6f6e 5f63 6f75 6e74  "execution_count
-000122e0: 225d 2069 7320 4e6f 6e65 0a20 2020 2020  "] is None.     
-000122f0: 2020 2020 2020 2029 0a0a 2020 2020 4070         )..    @p
-00012300: 7974 6573 742e 6d61 726b 2e61 7379 6e63  ytest.mark.async
-00012310: 696f 0a20 2020 2061 7379 6e63 2064 6566  io.    async def
-00012320: 2074 6573 745f 7265 7374 6172 745f 6b65   test_restart_ke
-00012330: 726e 656c 5f61 6e64 5f72 756e 5f61 6c6c  rnel_and_run_all
-00012340: 5f63 656c 6c73 280a 2020 2020 2020 2020  _cells(.        
-00012350: 7365 6c66 2c20 636c 6965 6e74 3a20 5465  self, client: Te
-00012360: 7374 436c 6965 6e74 2c20 7375 7065 7275  stClient, superu
-00012370: 7365 725f 746f 6b65 6e5f 6865 6164 6572  ser_token_header
-00012380: 733a 2044 6963 745b 7374 722c 2073 7472  s: Dict[str, str
-00012390: 5d0a 2020 2020 293a 0a20 2020 2020 2020  ].    ):.       
-000123a0: 2075 7569 6420 3d20 6177 6169 7420 7570   uuid = await up
-000123b0: 6c6f 6164 5f6e 6f74 6562 6f6f 6b28 636c  load_notebook(cl
-000123c0: 6965 6e74 2c20 7375 7065 7275 7365 725f  ient, superuser_
-000123d0: 746f 6b65 6e5f 6865 6164 6572 7329 0a0a  token_headers)..
-000123e0: 2020 2020 2020 2020 7265 7370 6f6e 7365          response
-000123f0: 203d 2061 7761 6974 2063 6c69 656e 742e   = await client.
-00012400: 6765 7428 0a20 2020 2020 2020 2020 2020  get(.           
-00012410: 2066 222f 6e6f 7465 626f 6f6b 732f 7b75   f"/notebooks/{u
-00012420: 7569 647d 2f63 656c 6c73 222c 2068 6561  uid}/cells", hea
-00012430: 6465 7273 3d73 7570 6572 7573 6572 5f74  ders=superuser_t
-00012440: 6f6b 656e 5f68 6561 6465 7273 0a20 2020  oken_headers.   
-00012450: 2020 2020 2029 0a20 2020 2020 2020 2061       ).        a
-00012460: 7373 6572 7420 7265 7370 6f6e 7365 2e73  ssert response.s
-00012470: 7461 7475 735f 636f 6465 203d 3d20 3230  tatus_code == 20
-00012480: 300a 2020 2020 2020 2020 6365 6c6c 7320  0.        cells 
-00012490: 3d20 7265 7370 6f6e 7365 2e6a 736f 6e28  = response.json(
-000124a0: 295b 2263 656c 6c73 225d 0a0a 2020 2020  )["cells"]..    
-000124b0: 2020 2020 6365 6c6c 203d 2063 656c 6c73      cell = cells
-000124c0: 5b32 5d0a 2020 2020 2020 2020 6365 6c6c  [2].        cell
-000124d0: 5f75 7569 6420 3d20 6365 6c6c 5b22 6d65  _uuid = cell["me
-000124e0: 7461 6461 7461 225d 5b22 6a75 7079 7465  tadata"]["jupyte
-000124f0: 725f 6431 225d 5b22 7575 6964 225d 0a0a  r_d1"]["uuid"]..
-00012500: 2020 2020 2020 2020 7265 7370 6f6e 7365          response
-00012510: 203d 2061 7761 6974 2063 6c69 656e 742e   = await client.
-00012520: 6765 7428 0a20 2020 2020 2020 2020 2020  get(.           
-00012530: 2066 222f 6e6f 7465 626f 6f6b 732f 7b75   f"/notebooks/{u
-00012540: 7569 647d 2f63 656c 6c73 2f7b 6365 6c6c  uid}/cells/{cell
-00012550: 5f75 7569 647d 2f65 7865 6375 7465 222c  _uuid}/execute",
-00012560: 0a20 2020 2020 2020 2020 2020 2068 6561  .            hea
+00010000: 2076 6172 735b 226b 225d 5b22 7661 6c75   vars["k"]["valu
+00010010: 6522 5d5b 226d 756c 7469 5f76 616c 7565  e"]["multi_value
+00010020: 225d 5b22 726f 775f 6e61 6d65 7322 5d20  "]["row_names"] 
+00010030: 3d3d 205b 2231 222c 2022 3222 5d0a 2020  == ["1", "2"].  
+00010040: 2020 2020 2020 2020 2020 6173 7365 7274            assert
+00010050: 2076 6172 735b 226b 225d 5b22 7661 6c75   vars["k"]["valu
+00010060: 6522 5d5b 226d 756c 7469 5f76 616c 7565  e"]["multi_value
+00010070: 225d 5b22 6461 7461 225d 203d 3d20 5b0a  "]["data"] == [.
+00010080: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00010090: 5b22 7422 2c20 2234 222c 2022 6822 5d2c  ["t", "4", "h"],
+000100a0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+000100b0: 205b 2235 222c 2022 3622 2c20 2238 225d   ["5", "6", "8"]
+000100c0: 2c0a 2020 2020 2020 2020 2020 2020 5d0a  ,.            ].
+000100d0: 0a20 2020 2040 7079 7465 7374 2e6d 6172  .    @pytest.mar
+000100e0: 6b2e 6173 796e 6369 6f0a 2020 2020 6173  k.asyncio.    as
+000100f0: 796e 6320 6465 6620 7465 7374 5f70 6167  ync def test_pag
+00010100: 655f 7061 796c 6f61 6428 0a20 2020 2020  e_payload(.     
+00010110: 2020 2073 656c 662c 2063 6c69 656e 743a     self, client:
+00010120: 2054 6573 7443 6c69 656e 742c 2073 7570   TestClient, sup
+00010130: 6572 7573 6572 5f74 6f6b 656e 5f68 6561  eruser_token_hea
+00010140: 6465 7273 3a20 4469 6374 5b73 7472 2c20  ders: Dict[str, 
+00010150: 7374 725d 0a20 2020 2029 3a0a 2020 2020  str].    ):.    
+00010160: 2020 2020 7265 7370 6f6e 7365 203d 2061      response = a
+00010170: 7761 6974 2063 6c69 656e 742e 706f 7374  wait client.post
+00010180: 280a 2020 2020 2020 2020 2020 2020 222f  (.            "/
+00010190: 6e6f 7465 626f 6f6b 732f 6372 6561 7465  notebooks/create
+000101a0: 222c 0a20 2020 2020 2020 2020 2020 2071  ",.            q
+000101b0: 7565 7279 5f73 7472 696e 673d 7b22 6b73  uery_string={"ks
+000101c0: 7065 635f 6e61 6d65 223a 2022 7079 7468  pec_name": "pyth
+000101d0: 6f6e 222c 2022 6669 6c65 6e61 6d65 223a  on", "filename":
+000101e0: 2022 6865 7970 227d 2c0a 2020 2020 2020   "heyp"},.      
+000101f0: 2020 2020 2020 6865 6164 6572 733d 7375        headers=su
+00010200: 7065 7275 7365 725f 746f 6b65 6e5f 6865  peruser_token_he
+00010210: 6164 6572 732c 0a20 2020 2020 2020 2029  aders,.        )
+00010220: 0a20 2020 2020 2020 2061 7373 6572 7420  .        assert 
+00010230: 7265 7370 6f6e 7365 2e73 7461 7475 735f  response.status_
+00010240: 636f 6465 203d 3d20 3230 310a 2020 2020  code == 201.    
+00010250: 2020 2020 7265 7370 5f6a 736f 6e20 3d20      resp_json = 
+00010260: 7265 7370 6f6e 7365 2e6a 736f 6e28 295b  response.json()[
+00010270: 226e 6f74 6562 6f6f 6b22 5d0a 2020 2020  "notebook"].    
+00010280: 2020 2020 7575 6964 203d 2072 6573 705f      uuid = resp_
+00010290: 6a73 6f6e 5b22 6d65 7461 6461 7461 225d  json["metadata"]
+000102a0: 5b22 6a75 7079 7465 725f 6431 225d 5b22  ["jupyter_d1"]["
+000102b0: 7575 6964 225d 0a0a 2020 2020 2020 2020  uuid"]..        
+000102c0: 7265 7370 6f6e 7365 203d 2061 7761 6974  response = await
+000102d0: 2063 6c69 656e 742e 706f 7374 280a 2020   client.post(.  
+000102e0: 2020 2020 2020 2020 2020 6622 2f6e 6f74            f"/not
+000102f0: 6562 6f6f 6b73 2f7b 7575 6964 7d2f 6365  ebooks/{uuid}/ce
+00010300: 6c6c 7322 2c0a 2020 2020 2020 2020 2020  lls",.          
+00010310: 2020 6865 6164 6572 733d 7375 7065 7275    headers=superu
+00010320: 7365 725f 746f 6b65 6e5f 6865 6164 6572  ser_token_header
+00010330: 732c 0a20 2020 2020 2020 2020 2020 206a  s,.            j
+00010340: 736f 6e3d 7b22 6365 6c6c 5f74 7970 6522  son={"cell_type"
+00010350: 3a20 2263 6f64 6522 2c20 2273 6f75 7263  : "code", "sourc
+00010360: 6522 3a20 223f 7374 7222 7d2c 0a20 2020  e": "?str"},.   
+00010370: 2020 2020 2029 0a20 2020 2020 2020 2063       ).        c
+00010380: 656c 6c5f 7575 6964 203d 2072 6573 706f  ell_uuid = respo
+00010390: 6e73 652e 6a73 6f6e 2829 5b22 6365 6c6c  nse.json()["cell
+000103a0: 225d 5b22 6d65 7461 6461 7461 225d 5b22  "]["metadata"]["
+000103b0: 6a75 7079 7465 725f 6431 225d 5b22 7575  jupyter_d1"]["uu
+000103c0: 6964 225d 0a0a 2020 2020 2020 2020 6173  id"]..        as
+000103d0: 796e 6320 7769 7468 2063 6c69 656e 742e  ync with client.
+000103e0: 7765 6273 6f63 6b65 745f 636f 6e6e 6563  websocket_connec
+000103f0: 7428 0a20 2020 2020 2020 2020 2020 2066  t(.            f
+00010400: 222f 6e6f 7465 626f 6f6b 732f 7b75 7569  "/notebooks/{uui
+00010410: 647d 2f77 732f 6e6f 7465 626f 6f6b 222c  d}/ws/notebook",
+00010420: 2068 6561 6465 7273 3d73 7570 6572 7573   headers=superus
+00010430: 6572 5f74 6f6b 656e 5f68 6561 6465 7273  er_token_headers
+00010440: 0a20 2020 2020 2020 2029 2061 7320 7765  .        ) as we
+00010450: 6273 6f63 6b65 743a 0a20 2020 2020 2020  bsocket:.       
+00010460: 2020 2020 2061 7761 6974 2061 7379 6e63       await async
+00010470: 696f 2e73 6c65 6570 2857 4542 534f 434b  io.sleep(WEBSOCK
+00010480: 4554 5f53 4c45 4550 5f54 494d 4529 0a0a  ET_SLEEP_TIME)..
+00010490: 2020 2020 2020 2020 2020 2020 7265 7370              resp
+000104a0: 6f6e 7365 203d 2061 7761 6974 2063 6c69  onse = await cli
+000104b0: 656e 742e 6765 7428 0a20 2020 2020 2020  ent.get(.       
+000104c0: 2020 2020 2020 2020 2066 222f 6e6f 7465           f"/note
+000104d0: 626f 6f6b 732f 7b75 7569 647d 2f63 656c  books/{uuid}/cel
+000104e0: 6c73 2f7b 6365 6c6c 5f75 7569 647d 2f65  ls/{cell_uuid}/e
+000104f0: 7865 6375 7465 222c 0a20 2020 2020 2020  xecute",.       
+00010500: 2020 2020 2020 2020 2068 6561 6465 7273           headers
+00010510: 3d73 7570 6572 7573 6572 5f74 6f6b 656e  =superuser_token
+00010520: 5f68 6561 6465 7273 2c0a 2020 2020 2020  _headers,.      
+00010530: 2020 2020 2020 290a 2020 2020 2020 2020        ).        
+00010540: 2020 2020 6173 7365 7274 2072 6573 706f      assert respo
+00010550: 6e73 652e 7374 6174 7573 5f63 6f64 6520  nse.status_code 
+00010560: 3d3d 2032 3030 0a20 2020 2020 2020 2020  == 200.         
+00010570: 2020 206d 7367 5f69 6420 3d20 7265 7370     msg_id = resp
+00010580: 6f6e 7365 2e6a 736f 6e28 295b 226b 6572  onse.json()["ker
+00010590: 6e65 6c5f 6d65 7373 6167 6522 5d5b 226d  nel_message"]["m
+000105a0: 6573 7361 6765 5f69 6422 5d0a 0a20 2020  essage_id"]..   
+000105b0: 2020 2020 2020 2020 2064 6174 6120 3d20           data = 
+000105c0: 6177 6169 7420 7265 6365 6976 655f 6a73  await receive_js
+000105d0: 6f6e 2877 6562 736f 636b 6574 2c20 6d73  on(websocket, ms
+000105e0: 675f 7479 7065 733d 5b22 7061 796c 6f61  g_types=["payloa
+000105f0: 645f 7061 6765 225d 290a 2020 2020 2020  d_page"]).      
+00010600: 2020 2020 2020 6173 7365 7274 2022 7465        assert "te
+00010610: 7874 2f70 6c61 696e 2220 696e 2064 6174  xt/plain" in dat
+00010620: 615b 2270 6179 6c6f 6164 5f70 6167 6522  a["payload_page"
+00010630: 5d5b 2264 6174 6122 5d0a 2020 2020 2020  ]["data"].      
+00010640: 2020 2020 2020 6173 7365 7274 2064 6174        assert dat
+00010650: 615b 2270 6179 6c6f 6164 5f70 6167 6522  a["payload_page"
+00010660: 5d5b 226d 6573 7361 6765 5f69 6422 5d20  ]["message_id"] 
+00010670: 3d3d 206d 7367 5f69 640a 2020 2020 2020  == msg_id.      
+00010680: 2020 2020 2020 6173 7365 7274 2064 6174        assert dat
+00010690: 615b 2270 6179 6c6f 6164 5f70 6167 6522  a["payload_page"
+000106a0: 5d5b 2273 7461 7274 225d 203d 3d20 300a  ]["start"] == 0.
+000106b0: 0a20 2020 2040 7079 7465 7374 2e6d 6172  .    @pytest.mar
+000106c0: 6b2e 6173 796e 6369 6f0a 2020 2020 6173  k.asyncio.    as
+000106d0: 796e 6320 6465 6620 7465 7374 5f63 6f64  ync def test_cod
+000106e0: 655f 636f 6d70 6c65 7469 6f6e 280a 2020  e_completion(.  
+000106f0: 2020 2020 2020 7365 6c66 2c20 636c 6965        self, clie
+00010700: 6e74 3a20 5465 7374 436c 6965 6e74 2c20  nt: TestClient, 
+00010710: 7375 7065 7275 7365 725f 746f 6b65 6e5f  superuser_token_
+00010720: 6865 6164 6572 733a 2044 6963 745b 7374  headers: Dict[st
+00010730: 722c 2073 7472 5d0a 2020 2020 293a 0a20  r, str].    ):. 
+00010740: 2020 2020 2020 2072 6573 706f 6e73 6520         response 
+00010750: 3d20 6177 6169 7420 636c 6965 6e74 2e70  = await client.p
+00010760: 6f73 7428 0a20 2020 2020 2020 2020 2020  ost(.           
+00010770: 2022 2f6e 6f74 6562 6f6f 6b73 2f63 7265   "/notebooks/cre
+00010780: 6174 6522 2c0a 2020 2020 2020 2020 2020  ate",.          
+00010790: 2020 7175 6572 795f 7374 7269 6e67 3d7b    query_string={
+000107a0: 226b 7370 6563 5f6e 616d 6522 3a20 2270  "kspec_name": "p
+000107b0: 7974 686f 6e22 2c20 2266 696c 656e 616d  ython", "filenam
+000107c0: 6522 3a20 2268 6579 7022 7d2c 0a20 2020  e": "heyp"},.   
+000107d0: 2020 2020 2020 2020 2068 6561 6465 7273           headers
+000107e0: 3d73 7570 6572 7573 6572 5f74 6f6b 656e  =superuser_token
+000107f0: 5f68 6561 6465 7273 2c0a 2020 2020 2020  _headers,.      
+00010800: 2020 290a 2020 2020 2020 2020 6173 7365    ).        asse
+00010810: 7274 2072 6573 706f 6e73 652e 7374 6174  rt response.stat
+00010820: 7573 5f63 6f64 6520 3d3d 2032 3031 0a20  us_code == 201. 
+00010830: 2020 2020 2020 2072 6573 705f 6a73 6f6e         resp_json
+00010840: 203d 2072 6573 706f 6e73 652e 6a73 6f6e   = response.json
+00010850: 2829 5b22 6e6f 7465 626f 6f6b 225d 0a20  ()["notebook"]. 
+00010860: 2020 2020 2020 2075 7569 6420 3d20 7265         uuid = re
+00010870: 7370 5f6a 736f 6e5b 226d 6574 6164 6174  sp_json["metadat
+00010880: 6122 5d5b 226a 7570 7974 6572 5f64 3122  a"]["jupyter_d1"
+00010890: 5d5b 2275 7569 6422 5d0a 0a20 2020 2020  ]["uuid"]..     
+000108a0: 2020 2061 7379 6e63 2077 6974 6820 636c     async with cl
+000108b0: 6965 6e74 2e77 6562 736f 636b 6574 5f63  ient.websocket_c
+000108c0: 6f6e 6e65 6374 280a 2020 2020 2020 2020  onnect(.        
+000108d0: 2020 2020 6622 2f6e 6f74 6562 6f6f 6b73      f"/notebooks
+000108e0: 2f7b 7575 6964 7d2f 7773 2f6e 6f74 6562  /{uuid}/ws/noteb
+000108f0: 6f6f 6b22 2c20 6865 6164 6572 733d 7375  ook", headers=su
+00010900: 7065 7275 7365 725f 746f 6b65 6e5f 6865  peruser_token_he
+00010910: 6164 6572 730a 2020 2020 2020 2020 2920  aders.        ) 
+00010920: 6173 2077 6562 736f 636b 6574 3a0a 2020  as websocket:.  
+00010930: 2020 2020 2020 2020 2020 6177 6169 7420            await 
+00010940: 6173 796e 6369 6f2e 736c 6565 7028 5745  asyncio.sleep(WE
+00010950: 4253 4f43 4b45 545f 534c 4545 505f 5449  BSOCKET_SLEEP_TI
+00010960: 4d45 290a 0a20 2020 2020 2020 2020 2020  ME)..           
+00010970: 2072 6573 706f 6e73 6520 3d20 6177 6169   response = awai
+00010980: 7420 636c 6965 6e74 2e70 6f73 7428 0a20  t client.post(. 
+00010990: 2020 2020 2020 2020 2020 2020 2020 2066                 f
+000109a0: 222f 6e6f 7465 626f 6f6b 732f 7b75 7569  "/notebooks/{uui
+000109b0: 647d 2f63 6f6d 706c 6574 6522 2c0a 2020  d}/complete",.  
+000109c0: 2020 2020 2020 2020 2020 2020 2020 6a73                js
+000109d0: 6f6e 3d7b 2263 6f64 6522 3a20 2273 227d  on={"code": "s"}
+000109e0: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
+000109f0: 2020 6865 6164 6572 733d 7375 7065 7275    headers=superu
+00010a00: 7365 725f 746f 6b65 6e5f 6865 6164 6572  ser_token_header
+00010a10: 732c 0a20 2020 2020 2020 2020 2020 2029  s,.            )
+00010a20: 0a20 2020 2020 2020 2020 2020 2061 7373  .            ass
+00010a30: 6572 7420 7265 7370 6f6e 7365 2e73 7461  ert response.sta
+00010a40: 7475 735f 636f 6465 203d 3d20 3230 300a  tus_code == 200.
+00010a50: 2020 2020 2020 2020 2020 2020 6d73 675f              msg_
+00010a60: 6964 203d 2072 6573 706f 6e73 652e 6a73  id = response.js
+00010a70: 6f6e 2829 5b22 6b65 726e 656c 5f6d 6573  on()["kernel_mes
+00010a80: 7361 6765 225d 5b22 6d65 7373 6167 655f  sage"]["message_
+00010a90: 6964 225d 0a0a 2020 2020 2020 2020 2020  id"]..          
+00010aa0: 2020 6461 7461 203d 2061 7761 6974 2072    data = await r
+00010ab0: 6563 6569 7665 5f6a 736f 6e28 7765 6273  eceive_json(webs
+00010ac0: 6f63 6b65 7429 0a20 2020 2020 2020 2020  ocket).         
+00010ad0: 2020 2061 7373 6572 7420 6c65 6e28 6461     assert len(da
+00010ae0: 7461 5b22 636f 6d70 6c65 7465 5f72 6570  ta["complete_rep
+00010af0: 6c79 225d 5b22 6d61 7463 6865 7322 5d29  ly"]["matches"])
+00010b00: 203e 2030 0a20 2020 2020 2020 2020 2020   > 0.           
+00010b10: 2061 7373 6572 7420 6461 7461 5b22 636f   assert data["co
+00010b20: 6d70 6c65 7465 5f72 6570 6c79 225d 5b22  mplete_reply"]["
+00010b30: 6d65 7373 6167 655f 6964 225d 203d 3d20  message_id"] == 
+00010b40: 6d73 675f 6964 0a20 2020 2020 2020 2020  msg_id.         
+00010b50: 2020 2061 7373 6572 7420 6461 7461 5b22     assert data["
+00010b60: 636f 6d70 6c65 7465 5f72 6570 6c79 225d  complete_reply"]
+00010b70: 5b22 6375 7273 6f72 5f73 7461 7274 225d  ["cursor_start"]
+00010b80: 203d 3d20 300a 2020 2020 2020 2020 2020   == 0.          
+00010b90: 2020 6173 7365 7274 2064 6174 615b 2263    assert data["c
+00010ba0: 6f6d 706c 6574 655f 7265 706c 7922 5d5b  omplete_reply"][
+00010bb0: 2263 7572 736f 725f 656e 6422 5d20 3d3d  "cursor_end"] ==
+00010bc0: 2031 0a0a 2020 2020 4070 7974 6573 742e   1..    @pytest.
+00010bd0: 6d61 726b 2e61 7379 6e63 696f 0a20 2020  mark.asyncio.   
+00010be0: 2061 7379 6e63 2064 6566 2074 6573 745f   async def test_
+00010bf0: 636f 6465 5f63 6f6d 706c 6574 696f 6e5f  code_completion_
+00010c00: 6375 7273 6f72 5f70 6f73 6974 696f 6e28  cursor_position(
+00010c10: 0a20 2020 2020 2020 2073 656c 662c 2063  .        self, c
+00010c20: 6c69 656e 743a 2054 6573 7443 6c69 656e  lient: TestClien
+00010c30: 742c 2073 7570 6572 7573 6572 5f74 6f6b  t, superuser_tok
+00010c40: 656e 5f68 6561 6465 7273 3a20 4469 6374  en_headers: Dict
+00010c50: 5b73 7472 2c20 7374 725d 0a20 2020 2029  [str, str].    )
+00010c60: 3a0a 2020 2020 2020 2020 7265 7370 6f6e  :.        respon
+00010c70: 7365 203d 2061 7761 6974 2063 6c69 656e  se = await clien
+00010c80: 742e 706f 7374 280a 2020 2020 2020 2020  t.post(.        
+00010c90: 2020 2020 222f 6e6f 7465 626f 6f6b 732f      "/notebooks/
+00010ca0: 6372 6561 7465 222c 0a20 2020 2020 2020  create",.       
+00010cb0: 2020 2020 2071 7565 7279 5f73 7472 696e       query_strin
+00010cc0: 673d 7b22 6b73 7065 635f 6e61 6d65 223a  g={"kspec_name":
+00010cd0: 2022 7079 7468 6f6e 222c 2022 6669 6c65   "python", "file
+00010ce0: 6e61 6d65 223a 2022 6865 7970 227d 2c0a  name": "heyp"},.
+00010cf0: 2020 2020 2020 2020 2020 2020 6865 6164              head
+00010d00: 6572 733d 7375 7065 7275 7365 725f 746f  ers=superuser_to
+00010d10: 6b65 6e5f 6865 6164 6572 732c 0a20 2020  ken_headers,.   
+00010d20: 2020 2020 2029 0a20 2020 2020 2020 2061       ).        a
+00010d30: 7373 6572 7420 7265 7370 6f6e 7365 2e73  ssert response.s
+00010d40: 7461 7475 735f 636f 6465 203d 3d20 3230  tatus_code == 20
+00010d50: 310a 2020 2020 2020 2020 7265 7370 5f6a  1.        resp_j
+00010d60: 736f 6e20 3d20 7265 7370 6f6e 7365 2e6a  son = response.j
+00010d70: 736f 6e28 295b 226e 6f74 6562 6f6f 6b22  son()["notebook"
+00010d80: 5d0a 2020 2020 2020 2020 7575 6964 203d  ].        uuid =
+00010d90: 2072 6573 705f 6a73 6f6e 5b22 6d65 7461   resp_json["meta
+00010da0: 6461 7461 225d 5b22 6a75 7079 7465 725f  data"]["jupyter_
+00010db0: 6431 225d 5b22 7575 6964 225d 0a0a 2020  d1"]["uuid"]..  
+00010dc0: 2020 2020 2020 6173 796e 6320 7769 7468        async with
+00010dd0: 2063 6c69 656e 742e 7765 6273 6f63 6b65   client.websocke
+00010de0: 745f 636f 6e6e 6563 7428 0a20 2020 2020  t_connect(.     
+00010df0: 2020 2020 2020 2066 222f 6e6f 7465 626f         f"/notebo
+00010e00: 6f6b 732f 7b75 7569 647d 2f77 732f 6e6f  oks/{uuid}/ws/no
+00010e10: 7465 626f 6f6b 222c 2068 6561 6465 7273  tebook", headers
+00010e20: 3d73 7570 6572 7573 6572 5f74 6f6b 656e  =superuser_token
+00010e30: 5f68 6561 6465 7273 0a20 2020 2020 2020  _headers.       
+00010e40: 2029 2061 7320 7765 6273 6f63 6b65 743a   ) as websocket:
+00010e50: 0a20 2020 2020 2020 2020 2020 2061 7761  .            awa
+00010e60: 6974 2061 7379 6e63 696f 2e73 6c65 6570  it asyncio.sleep
+00010e70: 2857 4542 534f 434b 4554 5f53 4c45 4550  (WEBSOCKET_SLEEP
+00010e80: 5f54 494d 4529 0a0a 2020 2020 2020 2020  _TIME)..        
+00010e90: 2020 2020 7265 7370 6f6e 7365 203d 2061      response = a
+00010ea0: 7761 6974 2063 6c69 656e 742e 706f 7374  wait client.post
+00010eb0: 280a 2020 2020 2020 2020 2020 2020 2020  (.              
+00010ec0: 2020 6622 2f6e 6f74 6562 6f6f 6b73 2f7b    f"/notebooks/{
+00010ed0: 7575 6964 7d2f 636f 6d70 6c65 7465 222c  uuid}/complete",
+00010ee0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00010ef0: 206a 736f 6e3d 7b22 636f 6465 223a 2022   json={"code": "
+00010f00: 3520 2b20 7072 696e 202b 2036 222c 2022  5 + prin + 6", "
+00010f10: 6375 7273 6f72 5f70 6f73 6974 696f 6e22  cursor_position"
+00010f20: 3a20 377d 2c0a 2020 2020 2020 2020 2020  : 7},.          
+00010f30: 2020 2020 2020 6865 6164 6572 733d 7375        headers=su
+00010f40: 7065 7275 7365 725f 746f 6b65 6e5f 6865  peruser_token_he
+00010f50: 6164 6572 732c 0a20 2020 2020 2020 2020  aders,.         
+00010f60: 2020 2029 0a20 2020 2020 2020 2020 2020     ).           
+00010f70: 2061 7373 6572 7420 7265 7370 6f6e 7365   assert response
+00010f80: 2e73 7461 7475 735f 636f 6465 203d 3d20  .status_code == 
+00010f90: 3230 300a 2020 2020 2020 2020 2020 2020  200.            
+00010fa0: 6d73 675f 6964 203d 2072 6573 706f 6e73  msg_id = respons
+00010fb0: 652e 6a73 6f6e 2829 5b22 6b65 726e 656c  e.json()["kernel
+00010fc0: 5f6d 6573 7361 6765 225d 5b22 6d65 7373  _message"]["mess
+00010fd0: 6167 655f 6964 225d 0a0a 2020 2020 2020  age_id"]..      
+00010fe0: 2020 2020 2020 6461 7461 203d 2061 7761        data = awa
+00010ff0: 6974 2072 6563 6569 7665 5f6a 736f 6e28  it receive_json(
+00011000: 7765 6273 6f63 6b65 7429 0a20 2020 2020  websocket).     
+00011010: 2020 2020 2020 2061 7373 6572 7420 6461         assert da
+00011020: 7461 5b22 636f 6d70 6c65 7465 5f72 6570  ta["complete_rep
+00011030: 6c79 225d 5b22 6d61 7463 6865 7322 5d20  ly"]["matches"] 
+00011040: 3d3d 205b 2270 7269 6e74 225d 0a20 2020  == ["print"].   
+00011050: 2020 2020 2020 2020 2061 7373 6572 7420           assert 
+00011060: 6461 7461 5b22 636f 6d70 6c65 7465 5f72  data["complete_r
+00011070: 6570 6c79 225d 5b22 6d65 7373 6167 655f  eply"]["message_
+00011080: 6964 225d 203d 3d20 6d73 675f 6964 0a20  id"] == msg_id. 
+00011090: 2020 2020 2020 2020 2020 2061 7373 6572             asser
+000110a0: 7420 6461 7461 5b22 636f 6d70 6c65 7465  t data["complete
+000110b0: 5f72 6570 6c79 225d 5b22 6375 7273 6f72  _reply"]["cursor
+000110c0: 5f73 7461 7274 225d 203d 3d20 340a 2020  _start"] == 4.  
+000110d0: 2020 2020 2020 2020 2020 6173 7365 7274            assert
+000110e0: 2064 6174 615b 2263 6f6d 706c 6574 655f   data["complete_
+000110f0: 7265 706c 7922 5d5b 2263 7572 736f 725f  reply"]["cursor_
+00011100: 656e 6422 5d20 3d3d 2037 0a0a 2020 2020  end"] == 7..    
+00011110: 4070 7974 6573 742e 6d61 726b 2e61 7379  @pytest.mark.asy
+00011120: 6e63 696f 0a20 2020 2061 7379 6e63 2064  ncio.    async d
+00011130: 6566 2074 6573 745f 6869 7374 6f72 7928  ef test_history(
+00011140: 0a20 2020 2020 2020 2073 656c 662c 2063  .        self, c
+00011150: 6c69 656e 743a 2054 6573 7443 6c69 656e  lient: TestClien
+00011160: 742c 2073 7570 6572 7573 6572 5f74 6f6b  t, superuser_tok
+00011170: 656e 5f68 6561 6465 7273 3a20 4469 6374  en_headers: Dict
+00011180: 5b73 7472 2c20 7374 725d 0a20 2020 2029  [str, str].    )
+00011190: 3a0a 2020 2020 2020 2020 7575 6964 203d  :.        uuid =
+000111a0: 2061 7761 6974 2075 706c 6f61 645f 6e6f   await upload_no
+000111b0: 7465 626f 6f6b 2863 6c69 656e 742c 2073  tebook(client, s
+000111c0: 7570 6572 7573 6572 5f74 6f6b 656e 5f68  uperuser_token_h
+000111d0: 6561 6465 7273 290a 0a20 2020 2020 2020  eaders)..       
+000111e0: 2072 6573 706f 6e73 6520 3d20 6177 6169   response = awai
+000111f0: 7420 636c 6965 6e74 2e67 6574 280a 2020  t client.get(.  
+00011200: 2020 2020 2020 2020 2020 6622 2f6e 6f74            f"/not
+00011210: 6562 6f6f 6b73 2f7b 7575 6964 7d2f 6365  ebooks/{uuid}/ce
+00011220: 6c6c 7322 2c20 6865 6164 6572 733d 7375  lls", headers=su
+00011230: 7065 7275 7365 725f 746f 6b65 6e5f 6865  peruser_token_he
+00011240: 6164 6572 730a 2020 2020 2020 2020 290a  aders.        ).
+00011250: 2020 2020 2020 2020 6173 7365 7274 2072          assert r
+00011260: 6573 706f 6e73 652e 7374 6174 7573 5f63  esponse.status_c
+00011270: 6f64 6520 3d3d 2032 3030 0a20 2020 2020  ode == 200.     
+00011280: 2020 2063 656c 6c73 203d 2072 6573 706f     cells = respo
+00011290: 6e73 652e 6a73 6f6e 2829 5b22 6365 6c6c  nse.json()["cell
+000112a0: 7322 5d0a 0a20 2020 2020 2020 2063 656c  s"]..        cel
+000112b0: 6c20 3d20 6365 6c6c 735b 325d 0a20 2020  l = cells[2].   
+000112c0: 2020 2020 2063 656c 6c5f 7575 6964 203d       cell_uuid =
+000112d0: 2063 656c 6c5b 226d 6574 6164 6174 6122   cell["metadata"
+000112e0: 5d5b 226a 7570 7974 6572 5f64 3122 5d5b  ]["jupyter_d1"][
+000112f0: 2275 7569 6422 5d0a 0a20 2020 2020 2020  "uuid"]..       
+00011300: 2061 7379 6e63 2077 6974 6820 636c 6965   async with clie
+00011310: 6e74 2e77 6562 736f 636b 6574 5f63 6f6e  nt.websocket_con
+00011320: 6e65 6374 280a 2020 2020 2020 2020 2020  nect(.          
+00011330: 2020 6622 2f6e 6f74 6562 6f6f 6b73 2f7b    f"/notebooks/{
+00011340: 7575 6964 7d2f 7773 2f6e 6f74 6562 6f6f  uuid}/ws/noteboo
+00011350: 6b22 2c20 6865 6164 6572 733d 7375 7065  k", headers=supe
+00011360: 7275 7365 725f 746f 6b65 6e5f 6865 6164  ruser_token_head
+00011370: 6572 730a 2020 2020 2020 2020 2920 6173  ers.        ) as
+00011380: 2077 6562 736f 636b 6574 3a0a 2020 2020   websocket:.    
+00011390: 2020 2020 2020 2020 6177 6169 7420 6173          await as
+000113a0: 796e 6369 6f2e 736c 6565 7028 5745 4253  yncio.sleep(WEBS
+000113b0: 4f43 4b45 545f 534c 4545 505f 5449 4d45  OCKET_SLEEP_TIME
+000113c0: 290a 0a20 2020 2020 2020 2020 2020 2072  )..            r
+000113d0: 6573 706f 6e73 6520 3d20 6177 6169 7420  esponse = await 
+000113e0: 636c 6965 6e74 2e67 6574 280a 2020 2020  client.get(.    
+000113f0: 2020 2020 2020 2020 2020 2020 6622 2f6e              f"/n
+00011400: 6f74 6562 6f6f 6b73 2f7b 7575 6964 7d2f  otebooks/{uuid}/
+00011410: 6365 6c6c 732f 7b63 656c 6c5f 7575 6964  cells/{cell_uuid
+00011420: 7d2f 6578 6563 7574 6522 2c0a 2020 2020  }/execute",.    
+00011430: 2020 2020 2020 2020 2020 2020 6865 6164              head
+00011440: 6572 733d 7375 7065 7275 7365 725f 746f  ers=superuser_to
+00011450: 6b65 6e5f 6865 6164 6572 732c 0a20 2020  ken_headers,.   
+00011460: 2020 2020 2020 2020 2029 0a20 2020 2020           ).     
+00011470: 2020 2020 2020 2061 7373 6572 7420 7265         assert re
+00011480: 7370 6f6e 7365 2e73 7461 7475 735f 636f  sponse.status_co
+00011490: 6465 203d 3d20 3230 300a 0a20 2020 2020  de == 200..     
+000114a0: 2020 2020 2020 2061 7761 6974 2072 6563         await rec
+000114b0: 6569 7665 5f6a 736f 6e28 7765 6273 6f63  eive_json(websoc
+000114c0: 6b65 7429 0a20 2020 2020 2020 2020 2020  ket).           
+000114d0: 2061 7761 6974 2072 6563 6569 7665 5f6a   await receive_j
+000114e0: 736f 6e28 7765 6273 6f63 6b65 7429 0a20  son(websocket). 
+000114f0: 2020 2020 2020 2020 2020 2061 7761 6974             await
+00011500: 2072 6563 6569 7665 5f6a 736f 6e28 7765   receive_json(we
+00011510: 6273 6f63 6b65 7429 0a20 2020 2020 2020  bsocket).       
+00011520: 2020 2020 2061 7761 6974 2072 6563 6569       await recei
+00011530: 7665 5f6a 736f 6e28 7765 6273 6f63 6b65  ve_json(websocke
+00011540: 7429 0a20 2020 2020 2020 2020 2020 2061  t).            a
+00011550: 7761 6974 2072 6563 6569 7665 5f6a 736f  wait receive_jso
+00011560: 6e28 7765 6273 6f63 6b65 7429 0a0a 2020  n(websocket)..  
+00011570: 2020 2020 2020 2020 2020 7265 7370 6f6e            respon
+00011580: 7365 203d 2061 7761 6974 2063 6c69 656e  se = await clien
+00011590: 742e 706f 7374 280a 2020 2020 2020 2020  t.post(.        
+000115a0: 2020 2020 2020 2020 6622 2f6e 6f74 6562          f"/noteb
+000115b0: 6f6f 6b73 2f7b 7575 6964 7d2f 6869 7374  ooks/{uuid}/hist
+000115c0: 6f72 7922 2c20 6865 6164 6572 733d 7375  ory", headers=su
+000115d0: 7065 7275 7365 725f 746f 6b65 6e5f 6865  peruser_token_he
+000115e0: 6164 6572 730a 2020 2020 2020 2020 2020  aders.          
+000115f0: 2020 290a 2020 2020 2020 2020 2020 2020    ).            
+00011600: 6173 7365 7274 2072 6573 706f 6e73 652e  assert response.
+00011610: 7374 6174 7573 5f63 6f64 6520 3d3d 2032  status_code == 2
+00011620: 3030 0a20 2020 2020 2020 2020 2020 206d  00.            m
+00011630: 7367 5f69 6420 3d20 7265 7370 6f6e 7365  sg_id = response
+00011640: 2e6a 736f 6e28 295b 226b 6572 6e65 6c5f  .json()["kernel_
+00011650: 6d65 7373 6167 6522 5d5b 226d 6573 7361  message"]["messa
+00011660: 6765 5f69 6422 5d0a 0a20 2020 2020 2020  ge_id"]..       
+00011670: 2020 2020 2064 6174 6120 3d20 6177 6169       data = awai
+00011680: 7420 7761 6974 5f66 6f72 5f65 7665 6e74  t wait_for_event
+00011690: 2877 6562 736f 636b 6574 2c20 2268 6973  (websocket, "his
+000116a0: 746f 7279 5f72 6570 6c79 2229 0a0a 2020  tory_reply")..  
+000116b0: 2020 2020 2020 2020 2020 6173 7365 7274            assert
+000116c0: 2064 6174 615b 2268 6973 746f 7279 5f72   data["history_r
+000116d0: 6570 6c79 225d 5b22 6d65 7373 6167 655f  eply"]["message_
+000116e0: 6964 225d 203d 3d20 6d73 675f 6964 0a20  id"] == msg_id. 
+000116f0: 2020 2020 2020 2020 2020 2068 6973 746f             histo
+00011700: 7279 203d 2064 6174 615b 2268 6973 746f  ry = data["histo
+00011710: 7279 5f72 6570 6c79 225d 5b22 6869 7374  ry_reply"]["hist
+00011720: 6f72 7922 5d0a 2020 2020 2020 2020 2020  ory"].          
+00011730: 2020 6173 7365 7274 2068 6973 746f 7279    assert history
+00011740: 5b30 5d5b 226c 696e 655f 6e75 6d62 6572  [0]["line_number
+00011750: 225d 203d 3d20 300a 2020 2020 2020 2020  "] == 0.        
+00011760: 2020 2020 6173 7365 7274 2068 6973 746f      assert histo
+00011770: 7279 5b30 5d5b 2269 6e70 7574 225d 203d  ry[0]["input"] =
+00011780: 3d20 2222 0a20 2020 2020 2020 2020 2020  = "".           
+00011790: 2061 7373 6572 7420 6869 7374 6f72 795b   assert history[
+000117a0: 305d 5b22 6f75 7470 7574 225d 2069 7320  0]["output"] is 
+000117b0: 4e6f 6e65 0a20 2020 2020 2020 2020 2020  None.           
+000117c0: 2061 7373 6572 7420 6869 7374 6f72 795b   assert history[
+000117d0: 315d 5b22 6c69 6e65 5f6e 756d 6265 7222  1]["line_number"
+000117e0: 5d20 3d3d 2031 0a20 2020 2020 2020 2020  ] == 1.         
+000117f0: 2020 2061 7373 6572 7420 6869 7374 6f72     assert histor
+00011800: 795b 315d 5b22 696e 7075 7422 5d20 3d3d  y[1]["input"] ==
+00011810: 2022 322b 3522 0a20 2020 2020 2020 2020   "2+5".         
+00011820: 2020 2061 7373 6572 7420 6869 7374 6f72     assert histor
+00011830: 795b 315d 5b22 6f75 7470 7574 225d 203d  y[1]["output"] =
+00011840: 3d20 2237 220a 0a20 2020 2040 7079 7465  = "7"..    @pyte
+00011850: 7374 2e6d 6172 6b2e 6173 796e 6369 6f0a  st.mark.asyncio.
+00011860: 2020 2020 6173 796e 6320 6465 6620 7465      async def te
+00011870: 7374 5f72 6573 7461 7274 5f6b 6572 6e65  st_restart_kerne
+00011880: 6c28 0a20 2020 2020 2020 2073 656c 662c  l(.        self,
+00011890: 2063 6c69 656e 743a 2054 6573 7443 6c69   client: TestCli
+000118a0: 656e 742c 2073 7570 6572 7573 6572 5f74  ent, superuser_t
+000118b0: 6f6b 656e 5f68 6561 6465 7273 3a20 4469  oken_headers: Di
+000118c0: 6374 5b73 7472 2c20 7374 725d 0a20 2020  ct[str, str].   
+000118d0: 2029 3a0a 2020 2020 2020 2020 7575 6964   ):.        uuid
+000118e0: 203d 2061 7761 6974 2075 706c 6f61 645f   = await upload_
+000118f0: 6e6f 7465 626f 6f6b 2863 6c69 656e 742c  notebook(client,
+00011900: 2073 7570 6572 7573 6572 5f74 6f6b 656e   superuser_token
+00011910: 5f68 6561 6465 7273 290a 0a20 2020 2020  _headers)..     
+00011920: 2020 2072 6573 706f 6e73 6520 3d20 6177     response = aw
+00011930: 6169 7420 636c 6965 6e74 2e67 6574 280a  ait client.get(.
+00011940: 2020 2020 2020 2020 2020 2020 6622 2f6e              f"/n
+00011950: 6f74 6562 6f6f 6b73 2f7b 7575 6964 7d2f  otebooks/{uuid}/
+00011960: 6365 6c6c 7322 2c20 6865 6164 6572 733d  cells", headers=
+00011970: 7375 7065 7275 7365 725f 746f 6b65 6e5f  superuser_token_
+00011980: 6865 6164 6572 730a 2020 2020 2020 2020  headers.        
+00011990: 290a 2020 2020 2020 2020 6173 7365 7274  ).        assert
+000119a0: 2072 6573 706f 6e73 652e 7374 6174 7573   response.status
+000119b0: 5f63 6f64 6520 3d3d 2032 3030 0a20 2020  _code == 200.   
+000119c0: 2020 2020 2063 656c 6c73 203d 2072 6573       cells = res
+000119d0: 706f 6e73 652e 6a73 6f6e 2829 5b22 6365  ponse.json()["ce
+000119e0: 6c6c 7322 5d0a 0a20 2020 2020 2020 2063  lls"]..        c
+000119f0: 656c 6c20 3d20 6365 6c6c 735b 325d 0a20  ell = cells[2]. 
+00011a00: 2020 2020 2020 2063 656c 6c5f 7575 6964         cell_uuid
+00011a10: 203d 2063 656c 6c5b 226d 6574 6164 6174   = cell["metadat
+00011a20: 6122 5d5b 226a 7570 7974 6572 5f64 3122  a"]["jupyter_d1"
+00011a30: 5d5b 2275 7569 6422 5d0a 0a20 2020 2020  ]["uuid"]..     
+00011a40: 2020 2072 6573 706f 6e73 6520 3d20 6177     response = aw
+00011a50: 6169 7420 636c 6965 6e74 2e67 6574 280a  ait client.get(.
+00011a60: 2020 2020 2020 2020 2020 2020 6622 2f6e              f"/n
+00011a70: 6f74 6562 6f6f 6b73 2f7b 7575 6964 7d2f  otebooks/{uuid}/
+00011a80: 6365 6c6c 732f 7b63 656c 6c5f 7575 6964  cells/{cell_uuid
+00011a90: 7d2f 6578 6563 7574 6522 2c0a 2020 2020  }/execute",.    
+00011aa0: 2020 2020 2020 2020 6865 6164 6572 733d          headers=
+00011ab0: 7375 7065 7275 7365 725f 746f 6b65 6e5f  superuser_token_
+00011ac0: 6865 6164 6572 732c 0a20 2020 2020 2020  headers,.       
+00011ad0: 2029 0a20 2020 2020 2020 2061 7373 6572   ).        asser
+00011ae0: 7420 7265 7370 6f6e 7365 2e73 7461 7475  t response.statu
+00011af0: 735f 636f 6465 203d 3d20 3230 300a 0a20  s_code == 200.. 
+00011b00: 2020 2020 2020 2072 6573 706f 6e73 6520         response 
+00011b10: 3d20 6177 6169 7420 636c 6965 6e74 2e67  = await client.g
+00011b20: 6574 280a 2020 2020 2020 2020 2020 2020  et(.            
+00011b30: 6622 2f6e 6f74 6562 6f6f 6b73 2f7b 7575  f"/notebooks/{uu
+00011b40: 6964 7d2f 6365 6c6c 7322 2c20 6865 6164  id}/cells", head
+00011b50: 6572 733d 7375 7065 7275 7365 725f 746f  ers=superuser_to
+00011b60: 6b65 6e5f 6865 6164 6572 730a 2020 2020  ken_headers.    
+00011b70: 2020 2020 290a 2020 2020 2020 2020 6173      ).        as
+00011b80: 7365 7274 2072 6573 706f 6e73 652e 7374  sert response.st
+00011b90: 6174 7573 5f63 6f64 6520 3d3d 2032 3030  atus_code == 200
+00011ba0: 0a20 2020 2020 2020 2063 656c 6c73 203d  .        cells =
+00011bb0: 2072 6573 706f 6e73 652e 6a73 6f6e 2829   response.json()
+00011bc0: 5b22 6365 6c6c 7322 5d0a 0a20 2020 2020  ["cells"]..     
+00011bd0: 2020 2061 7373 6572 7420 6365 6c6c 735b     assert cells[
+00011be0: 325d 5b22 6f75 7470 7574 7322 5d5b 305d  2]["outputs"][0]
+00011bf0: 5b22 6461 7461 225d 5b22 7465 7874 2f70  ["data"]["text/p
+00011c00: 6c61 696e 225d 203d 3d20 2237 220a 0a20  lain"] == "7".. 
+00011c10: 2020 2020 2020 2061 7379 6e63 2077 6974         async wit
+00011c20: 6820 636c 6965 6e74 2e77 6562 736f 636b  h client.websock
+00011c30: 6574 5f63 6f6e 6e65 6374 280a 2020 2020  et_connect(.    
+00011c40: 2020 2020 2020 2020 6622 2f6e 6f74 6562          f"/noteb
+00011c50: 6f6f 6b73 2f7b 7575 6964 7d2f 7773 2f6e  ooks/{uuid}/ws/n
+00011c60: 6f74 6562 6f6f 6b22 2c20 6865 6164 6572  otebook", header
+00011c70: 733d 7375 7065 7275 7365 725f 746f 6b65  s=superuser_toke
+00011c80: 6e5f 6865 6164 6572 730a 2020 2020 2020  n_headers.      
+00011c90: 2020 2920 6173 2077 6562 736f 636b 6574    ) as websocket
+00011ca0: 3a0a 0a20 2020 2020 2020 2020 2020 2061  :..            a
+00011cb0: 7761 6974 2061 7379 6e63 696f 2e73 6c65  wait asyncio.sle
+00011cc0: 6570 2857 4542 534f 434b 4554 5f53 4c45  ep(WEBSOCKET_SLE
+00011cd0: 4550 5f54 494d 4529 0a0a 2020 2020 2020  EP_TIME)..      
+00011ce0: 2020 2020 2020 7265 7370 6f6e 7365 203d        response =
+00011cf0: 2061 7761 6974 2063 6c69 656e 742e 6765   await client.ge
+00011d00: 7428 0a20 2020 2020 2020 2020 2020 2020  t(.             
+00011d10: 2020 2066 222f 6e6f 7465 626f 6f6b 732f     f"/notebooks/
+00011d20: 7b75 7569 647d 2f72 6573 7461 7274 5f6b  {uuid}/restart_k
+00011d30: 6572 6e65 6c22 2c0a 2020 2020 2020 2020  ernel",.        
+00011d40: 2020 2020 2020 2020 6865 6164 6572 733d          headers=
+00011d50: 7375 7065 7275 7365 725f 746f 6b65 6e5f  superuser_token_
+00011d60: 6865 6164 6572 732c 0a20 2020 2020 2020  headers,.       
+00011d70: 2020 2020 2029 0a0a 2020 2020 2020 2020       )..        
+00011d80: 2020 2020 6173 7365 7274 2072 6573 706f      assert respo
+00011d90: 6e73 652e 7374 6174 7573 5f63 6f64 6520  nse.status_code 
+00011da0: 3d3d 2032 3034 0a0a 2020 2020 2020 2020  == 204..        
+00011db0: 2020 2020 6461 7461 203d 2061 7761 6974      data = await
+00011dc0: 2077 6169 745f 666f 725f 6576 656e 7428   wait_for_event(
+00011dd0: 7765 6273 6f63 6b65 742c 2022 6b65 726e  websocket, "kern
+00011de0: 656c 5f72 6573 7461 7274 6564 2229 0a0a  el_restarted")..
+00011df0: 2020 2020 2020 2020 2020 2020 6173 7365              asse
+00011e00: 7274 2064 6174 615b 226b 6572 6e65 6c5f  rt data["kernel_
+00011e10: 7265 7374 6172 7465 6422 5d5b 2272 756e  restarted"]["run
+00011e20: 5f61 6c6c 5f63 656c 6c73 225d 2069 7320  _all_cells"] is 
+00011e30: 4661 6c73 650a 2020 2020 2020 2020 2020  False.          
+00011e40: 2020 6365 6c6c 7320 3d20 6461 7461 5b22    cells = data["
+00011e50: 6b65 726e 656c 5f72 6573 7461 7274 6564  kernel_restarted
+00011e60: 225d 5b22 6365 6c6c 7322 5d0a 2020 2020  "]["cells"].    
+00011e70: 2020 2020 2020 2020 6173 7365 7274 2063          assert c
+00011e80: 656c 6c73 5b32 5d5b 226f 7574 7075 7473  ells[2]["outputs
+00011e90: 225d 5b30 5d5b 2264 6174 6122 5d5b 2274  "][0]["data"]["t
+00011ea0: 6578 742f 706c 6169 6e22 5d20 3d3d 2022  ext/plain"] == "
+00011eb0: 3722 0a20 2020 2020 2020 2020 2020 2061  7".            a
+00011ec0: 7373 6572 7420 6365 6c6c 735b 325d 5b22  ssert cells[2]["
+00011ed0: 6578 6563 7574 696f 6e5f 636f 756e 7422  execution_count"
+00011ee0: 5d20 3d3d 2031 0a0a 2020 2020 2020 2020  ] == 1..        
+00011ef0: 7265 7370 6f6e 7365 203d 2061 7761 6974  response = await
+00011f00: 2063 6c69 656e 742e 6765 7428 0a20 2020   client.get(.   
+00011f10: 2020 2020 2020 2020 2066 222f 6e6f 7465           f"/note
+00011f20: 626f 6f6b 732f 7b75 7569 647d 2f63 656c  books/{uuid}/cel
+00011f30: 6c73 222c 2068 6561 6465 7273 3d73 7570  ls", headers=sup
+00011f40: 6572 7573 6572 5f74 6f6b 656e 5f68 6561  eruser_token_hea
+00011f50: 6465 7273 0a20 2020 2020 2020 2029 0a20  ders.        ). 
+00011f60: 2020 2020 2020 2061 7373 6572 7420 7265         assert re
+00011f70: 7370 6f6e 7365 2e73 7461 7475 735f 636f  sponse.status_co
+00011f80: 6465 203d 3d20 3230 300a 2020 2020 2020  de == 200.      
+00011f90: 2020 6365 6c6c 7320 3d20 7265 7370 6f6e    cells = respon
+00011fa0: 7365 2e6a 736f 6e28 295b 2263 656c 6c73  se.json()["cells
+00011fb0: 225d 0a20 2020 2020 2020 2066 6f72 2063  "].        for c
+00011fc0: 656c 6c20 696e 2063 656c 6c73 3a0a 2020  ell in cells:.  
+00011fd0: 2020 2020 2020 2020 2020 6173 7365 7274            assert
+00011fe0: 2063 656c 6c73 5b32 5d5b 226f 7574 7075   cells[2]["outpu
+00011ff0: 7473 225d 5b30 5d5b 2264 6174 6122 5d5b  ts"][0]["data"][
+00012000: 2274 6578 742f 706c 6169 6e22 5d20 3d3d  "text/plain"] ==
+00012010: 2022 3722 0a20 2020 2020 2020 2020 2020   "7".           
+00012020: 2061 7373 6572 7420 6365 6c6c 735b 325d   assert cells[2]
+00012030: 5b22 6578 6563 7574 696f 6e5f 636f 756e  ["execution_coun
+00012040: 7422 5d20 3d3d 2031 0a0a 2020 2020 4070  t"] == 1..    @p
+00012050: 7974 6573 742e 6d61 726b 2e61 7379 6e63  ytest.mark.async
+00012060: 696f 0a20 2020 2061 7379 6e63 2064 6566  io.    async def
+00012070: 2074 6573 745f 7265 7374 6172 745f 6b65   test_restart_ke
+00012080: 726e 656c 5f61 6e64 5f63 6c65 6172 5f6f  rnel_and_clear_o
+00012090: 7574 7075 7428 0a20 2020 2020 2020 2073  utput(.        s
+000120a0: 656c 662c 2063 6c69 656e 743a 2054 6573  elf, client: Tes
+000120b0: 7443 6c69 656e 742c 2073 7570 6572 7573  tClient, superus
+000120c0: 6572 5f74 6f6b 656e 5f68 6561 6465 7273  er_token_headers
+000120d0: 3a20 4469 6374 5b73 7472 2c20 7374 725d  : Dict[str, str]
+000120e0: 0a20 2020 2029 3a0a 2020 2020 2020 2020  .    ):.        
+000120f0: 7575 6964 203d 2061 7761 6974 2075 706c  uuid = await upl
+00012100: 6f61 645f 6e6f 7465 626f 6f6b 2863 6c69  oad_notebook(cli
+00012110: 656e 742c 2073 7570 6572 7573 6572 5f74  ent, superuser_t
+00012120: 6f6b 656e 5f68 6561 6465 7273 290a 0a20  oken_headers).. 
+00012130: 2020 2020 2020 2072 6573 706f 6e73 6520         response 
+00012140: 3d20 6177 6169 7420 636c 6965 6e74 2e67  = await client.g
+00012150: 6574 280a 2020 2020 2020 2020 2020 2020  et(.            
+00012160: 6622 2f6e 6f74 6562 6f6f 6b73 2f7b 7575  f"/notebooks/{uu
+00012170: 6964 7d2f 6365 6c6c 7322 2c20 6865 6164  id}/cells", head
+00012180: 6572 733d 7375 7065 7275 7365 725f 746f  ers=superuser_to
+00012190: 6b65 6e5f 6865 6164 6572 730a 2020 2020  ken_headers.    
+000121a0: 2020 2020 290a 2020 2020 2020 2020 6173      ).        as
+000121b0: 7365 7274 2072 6573 706f 6e73 652e 7374  sert response.st
+000121c0: 6174 7573 5f63 6f64 6520 3d3d 2032 3030  atus_code == 200
+000121d0: 0a20 2020 2020 2020 2063 656c 6c73 203d  .        cells =
+000121e0: 2072 6573 706f 6e73 652e 6a73 6f6e 2829   response.json()
+000121f0: 5b22 6365 6c6c 7322 5d0a 0a20 2020 2020  ["cells"]..     
+00012200: 2020 2063 656c 6c20 3d20 6365 6c6c 735b     cell = cells[
+00012210: 325d 0a20 2020 2020 2020 2063 656c 6c5f  2].        cell_
+00012220: 7575 6964 203d 2063 656c 6c5b 226d 6574  uuid = cell["met
+00012230: 6164 6174 6122 5d5b 226a 7570 7974 6572  adata"]["jupyter
+00012240: 5f64 3122 5d5b 2275 7569 6422 5d0a 0a20  _d1"]["uuid"].. 
+00012250: 2020 2020 2020 2072 6573 706f 6e73 6520         response 
+00012260: 3d20 6177 6169 7420 636c 6965 6e74 2e67  = await client.g
+00012270: 6574 280a 2020 2020 2020 2020 2020 2020  et(.            
+00012280: 6622 2f6e 6f74 6562 6f6f 6b73 2f7b 7575  f"/notebooks/{uu
+00012290: 6964 7d2f 6365 6c6c 732f 7b63 656c 6c5f  id}/cells/{cell_
+000122a0: 7575 6964 7d2f 6578 6563 7574 6522 2c0a  uuid}/execute",.
+000122b0: 2020 2020 2020 2020 2020 2020 6865 6164              head
+000122c0: 6572 733d 7375 7065 7275 7365 725f 746f  ers=superuser_to
+000122d0: 6b65 6e5f 6865 6164 6572 732c 0a20 2020  ken_headers,.   
+000122e0: 2020 2020 2029 0a20 2020 2020 2020 2061       ).        a
+000122f0: 7373 6572 7420 7265 7370 6f6e 7365 2e73  ssert response.s
+00012300: 7461 7475 735f 636f 6465 203d 3d20 3230  tatus_code == 20
+00012310: 300a 0a20 2020 2020 2020 2072 6573 706f  0..        respo
+00012320: 6e73 6520 3d20 6177 6169 7420 636c 6965  nse = await clie
+00012330: 6e74 2e67 6574 280a 2020 2020 2020 2020  nt.get(.        
+00012340: 2020 2020 6622 2f6e 6f74 6562 6f6f 6b73      f"/notebooks
+00012350: 2f7b 7575 6964 7d2f 6365 6c6c 7322 2c20  /{uuid}/cells", 
+00012360: 6865 6164 6572 733d 7375 7065 7275 7365  headers=superuse
+00012370: 725f 746f 6b65 6e5f 6865 6164 6572 730a  r_token_headers.
+00012380: 2020 2020 2020 2020 290a 2020 2020 2020          ).      
+00012390: 2020 6173 7365 7274 2072 6573 706f 6e73    assert respons
+000123a0: 652e 7374 6174 7573 5f63 6f64 6520 3d3d  e.status_code ==
+000123b0: 2032 3030 0a20 2020 2020 2020 2063 656c   200.        cel
+000123c0: 6c73 203d 2072 6573 706f 6e73 652e 6a73  ls = response.js
+000123d0: 6f6e 2829 5b22 6365 6c6c 7322 5d0a 0a20  on()["cells"].. 
+000123e0: 2020 2020 2020 2061 7373 6572 7420 6365         assert ce
+000123f0: 6c6c 735b 325d 5b22 6f75 7470 7574 7322  lls[2]["outputs"
+00012400: 5d5b 305d 5b22 6461 7461 225d 5b22 7465  ][0]["data"]["te
+00012410: 7874 2f70 6c61 696e 225d 203d 3d20 2237  xt/plain"] == "7
+00012420: 220a 0a20 2020 2020 2020 2061 7379 6e63  "..        async
+00012430: 2077 6974 6820 636c 6965 6e74 2e77 6562   with client.web
+00012440: 736f 636b 6574 5f63 6f6e 6e65 6374 280a  socket_connect(.
+00012450: 2020 2020 2020 2020 2020 2020 6622 2f6e              f"/n
+00012460: 6f74 6562 6f6f 6b73 2f7b 7575 6964 7d2f  otebooks/{uuid}/
+00012470: 7773 2f6e 6f74 6562 6f6f 6b22 2c20 6865  ws/notebook", he
+00012480: 6164 6572 733d 7375 7065 7275 7365 725f  aders=superuser_
+00012490: 746f 6b65 6e5f 6865 6164 6572 730a 2020  token_headers.  
+000124a0: 2020 2020 2020 2920 6173 2077 6562 736f        ) as webso
+000124b0: 636b 6574 3a0a 0a20 2020 2020 2020 2020  cket:..         
+000124c0: 2020 2061 7761 6974 2061 7379 6e63 696f     await asyncio
+000124d0: 2e73 6c65 6570 2857 4542 534f 434b 4554  .sleep(WEBSOCKET
+000124e0: 5f53 4c45 4550 5f54 494d 4529 0a0a 2020  _SLEEP_TIME)..  
+000124f0: 2020 2020 2020 2020 2020 7265 7370 6f6e            respon
+00012500: 7365 203d 2061 7761 6974 2063 6c69 656e  se = await clien
+00012510: 742e 6765 7428 0a20 2020 2020 2020 2020  t.get(.         
+00012520: 2020 2020 2020 2066 222f 6e6f 7465 626f         f"/notebo
+00012530: 6f6b 732f 7b75 7569 647d 2f72 6573 7461  oks/{uuid}/resta
+00012540: 7274 5f6b 6572 6e65 6c5f 616e 645f 636c  rt_kernel_and_cl
+00012550: 6561 725f 6f75 7470 7574 222c 0a20 2020  ear_output",.   
+00012560: 2020 2020 2020 2020 2020 2020 2068 6561               hea
 00012570: 6465 7273 3d73 7570 6572 7573 6572 5f74  ders=superuser_t
 00012580: 6f6b 656e 5f68 6561 6465 7273 2c0a 2020  oken_headers,.  
-00012590: 2020 2020 2020 290a 2020 2020 2020 2020        ).        
-000125a0: 6173 7365 7274 2072 6573 706f 6e73 652e  assert response.
-000125b0: 7374 6174 7573 5f63 6f64 6520 3d3d 2032  status_code == 2
-000125c0: 3030 0a0a 2020 2020 2020 2020 7265 7370  00..        resp
-000125d0: 6f6e 7365 203d 2061 7761 6974 2063 6c69  onse = await cli
-000125e0: 656e 742e 6765 7428 0a20 2020 2020 2020  ent.get(.       
-000125f0: 2020 2020 2066 222f 6e6f 7465 626f 6f6b       f"/notebook
-00012600: 732f 7b75 7569 647d 2f63 656c 6c73 222c  s/{uuid}/cells",
-00012610: 2068 6561 6465 7273 3d73 7570 6572 7573   headers=superus
-00012620: 6572 5f74 6f6b 656e 5f68 6561 6465 7273  er_token_headers
-00012630: 0a20 2020 2020 2020 2029 0a20 2020 2020  .        ).     
-00012640: 2020 2061 7373 6572 7420 7265 7370 6f6e     assert respon
-00012650: 7365 2e73 7461 7475 735f 636f 6465 203d  se.status_code =
-00012660: 3d20 3230 300a 2020 2020 2020 2020 6365  = 200.        ce
-00012670: 6c6c 7320 3d20 7265 7370 6f6e 7365 2e6a  lls = response.j
-00012680: 736f 6e28 295b 2263 656c 6c73 225d 0a0a  son()["cells"]..
-00012690: 2020 2020 2020 2020 6173 7365 7274 2022          assert "
-000126a0: 6f75 7470 7574 7322 206e 6f74 2069 6e20  outputs" not in 
-000126b0: 6365 6c6c 735b 305d 0a20 2020 2020 2020  cells[0].       
-000126c0: 2061 7373 6572 7420 6365 6c6c 735b 315d   assert cells[1]
-000126d0: 5b22 6f75 7470 7574 7322 5d5b 305d 5b22  ["outputs"][0]["
-000126e0: 7465 7874 225d 203d 3d20 224c 6172 7279  text"] == "Larry
-000126f0: 2074 6865 204c 6c61 6d61 5c6e 220a 2020   the Llama\n".  
-00012700: 2020 2020 2020 6173 7365 7274 2063 656c        assert cel
-00012710: 6c73 5b32 5d5b 226f 7574 7075 7473 225d  ls[2]["outputs"]
-00012720: 5b30 5d5b 2264 6174 6122 5d5b 2274 6578  [0]["data"]["tex
-00012730: 742f 706c 6169 6e22 5d20 3d3d 2022 3722  t/plain"] == "7"
-00012740: 0a0a 2020 2020 2020 2020 6173 796e 6320  ..        async 
-00012750: 7769 7468 2063 6c69 656e 742e 7765 6273  with client.webs
-00012760: 6f63 6b65 745f 636f 6e6e 6563 7428 0a20  ocket_connect(. 
-00012770: 2020 2020 2020 2020 2020 2066 222f 6e6f             f"/no
-00012780: 7465 626f 6f6b 732f 7b75 7569 647d 2f77  tebooks/{uuid}/w
-00012790: 732f 6e6f 7465 626f 6f6b 222c 2068 6561  s/notebook", hea
-000127a0: 6465 7273 3d73 7570 6572 7573 6572 5f74  ders=superuser_t
-000127b0: 6f6b 656e 5f68 6561 6465 7273 0a20 2020  oken_headers.   
-000127c0: 2020 2020 2029 2061 7320 7765 6273 6f63       ) as websoc
-000127d0: 6b65 743a 0a0a 2020 2020 2020 2020 2020  ket:..          
-000127e0: 2020 6177 6169 7420 6173 796e 6369 6f2e    await asyncio.
-000127f0: 736c 6565 7028 5745 4253 4f43 4b45 545f  sleep(WEBSOCKET_
-00012800: 534c 4545 505f 5449 4d45 290a 0a20 2020  SLEEP_TIME)..   
-00012810: 2020 2020 2020 2020 2023 2043 6c65 6172           # Clear
-00012820: 2074 6865 2077 6562 2073 6f63 6b65 7420   the web socket 
-00012830: 6265 666f 7265 2077 6520 7374 6172 740a  before we start.
-00012840: 2020 2020 2020 2020 2020 2020 6177 6169              awai
-00012850: 7420 636f 6c6c 6563 745f 7765 6273 6f63  t collect_websoc
-00012860: 6b65 745f 6d65 7373 6167 6573 2877 6562  ket_messages(web
-00012870: 736f 636b 6574 2c20 7469 6d65 6f75 743d  socket, timeout=
-00012880: 3229 0a0a 2020 2020 2020 2020 2020 2020  2)..            
-00012890: 7265 7370 6f6e 7365 203d 2061 7761 6974  response = await
-000128a0: 2063 6c69 656e 742e 6765 7428 0a20 2020   client.get(.   
-000128b0: 2020 2020 2020 2020 2020 2020 2066 222f               f"/
-000128c0: 6e6f 7465 626f 6f6b 732f 7b75 7569 647d  notebooks/{uuid}
-000128d0: 2f72 6573 7461 7274 5f6b 6572 6e65 6c5f  /restart_kernel_
-000128e0: 616e 645f 6578 6563 7574 655f 616c 6c22  and_execute_all"
-000128f0: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
-00012900: 2020 6865 6164 6572 733d 7375 7065 7275    headers=superu
-00012910: 7365 725f 746f 6b65 6e5f 6865 6164 6572  ser_token_header
-00012920: 732c 0a20 2020 2020 2020 2020 2020 2029  s,.            )
-00012930: 0a0a 2020 2020 2020 2020 2020 2020 6173  ..            as
-00012940: 7365 7274 2072 6573 706f 6e73 652e 7374  sert response.st
-00012950: 6174 7573 5f63 6f64 6520 3d3d 2032 3030  atus_code == 200
-00012960: 0a0a 2020 2020 2020 2020 2020 2020 6d73  ..            ms
-00012970: 6773 203d 2061 7761 6974 2063 6f6c 6c65  gs = await colle
-00012980: 6374 5f77 6562 736f 636b 6574 5f6d 6573  ct_websocket_mes
-00012990: 7361 6765 7328 7765 6273 6f63 6b65 742c  sages(websocket,
-000129a0: 2074 696d 656f 7574 3d31 3029 0a20 2020   timeout=10).   
-000129b0: 2020 2020 2020 2020 206b 6572 6e65 6c5f           kernel_
-000129c0: 7265 7374 6172 7465 645f 6d73 6773 203d  restarted_msgs =
-000129d0: 2066 696c 7465 725f 7765 6273 6f63 6b65   filter_websocke
-000129e0: 745f 636f 6c6c 6563 7469 6f6e 280a 2020  t_collection(.  
-000129f0: 2020 2020 2020 2020 2020 2020 2020 6d73                ms
-00012a00: 6773 2c20 226b 6572 6e65 6c5f 7265 7374  gs, "kernel_rest
-00012a10: 6172 7465 6422 0a20 2020 2020 2020 2020  arted".         
-00012a20: 2020 2029 0a20 2020 2020 2020 2020 2020     ).           
-00012a30: 2063 656c 6c5f 7570 6461 7465 5f6d 7367   cell_update_msg
-00012a40: 7320 3d20 6669 6c74 6572 5f77 6562 736f  s = filter_webso
-00012a50: 636b 6574 5f63 6f6c 6c65 6374 696f 6e28  cket_collection(
-00012a60: 6d73 6773 2c20 2263 656c 6c5f 7570 6461  msgs, "cell_upda
-00012a70: 7465 2229 0a0a 2020 2020 2020 2020 2020  te")..          
-00012a80: 2020 6461 7461 203d 206b 6572 6e65 6c5f    data = kernel_
-00012a90: 7265 7374 6172 7465 645f 6d73 6773 2e70  restarted_msgs.p
-00012aa0: 6f70 2830 290a 2020 2020 2020 2020 2020  op(0).          
-00012ab0: 2020 6173 7365 7274 2064 6174 615b 226b    assert data["k
-00012ac0: 6572 6e65 6c5f 7265 7374 6172 7465 6422  ernel_restarted"
-00012ad0: 5d5b 2272 756e 5f61 6c6c 5f63 656c 6c73  ]["run_all_cells
-00012ae0: 225d 2069 7320 5472 7565 0a20 2020 2020  "] is True.     
-00012af0: 2020 2020 2020 2063 656c 6c73 203d 2064         cells = d
-00012b00: 6174 615b 226b 6572 6e65 6c5f 7265 7374  ata["kernel_rest
-00012b10: 6172 7465 6422 5d5b 2263 656c 6c73 225d  arted"]["cells"]
-00012b20: 0a20 2020 2020 2020 2020 2020 2066 6f72  .            for
-00012b30: 2063 656c 6c20 696e 2063 656c 6c73 3a0a   cell in cells:.
-00012b40: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00012b50: 6173 7365 7274 2028 0a20 2020 2020 2020  assert (.       
-00012b60: 2020 2020 2020 2020 2020 2020 2028 226f               ("o
-00012b70: 7574 7075 7473 2220 6e6f 7420 696e 2063  utputs" not in c
-00012b80: 656c 6c20 6f72 206c 656e 2863 656c 6c5b  ell or len(cell[
-00012b90: 226f 7574 7075 7473 225d 2920 3d3d 2030  "outputs"]) == 0
-00012ba0: 290a 2020 2020 2020 2020 2020 2020 2020  ).              
-00012bb0: 2020 2020 2020 616e 6420 2265 7865 6375        and "execu
-00012bc0: 7469 6f6e 5f63 6f75 6e74 2220 6e6f 7420  tion_count" not 
-00012bd0: 696e 2063 656c 6c0a 2020 2020 2020 2020  in cell.        
-00012be0: 2020 2020 2020 2020 2020 2020 6f72 2063              or c
-00012bf0: 656c 6c5b 2265 7865 6375 7469 6f6e 5f63  ell["execution_c
-00012c00: 6f75 6e74 225d 2069 7320 4e6f 6e65 0a20  ount"] is None. 
-00012c10: 2020 2020 2020 2020 2020 2020 2020 2029                 )
-00012c20: 0a0a 2020 2020 2020 2020 2020 2020 2320  ..            # 
-00012c30: 5468 6573 6520 7477 6f20 706f 7020 7570  These two pop up
-00012c40: 2064 7565 2074 6f20 7468 6520 7265 7374   due to the rest
-00012c50: 6172 740a 2020 2020 2020 2020 2020 2020  art.            
-00012c60: 6461 7461 203d 2063 656c 6c5f 7570 6461  data = cell_upda
-00012c70: 7465 5f6d 7367 732e 706f 7028 3029 0a20  te_msgs.pop(0). 
-00012c80: 2020 2020 2020 2020 2020 2063 656c 6c20             cell 
-00012c90: 3d20 6461 7461 5b22 6365 6c6c 5f75 7064  = data["cell_upd
-00012ca0: 6174 6522 5d5b 305d 0a20 2020 2020 2020  ate"][0].       
-00012cb0: 2020 2020 2061 7373 6572 7420 6365 6c6c       assert cell
-00012cc0: 5b22 6f75 7470 7574 7322 5d5b 305d 5b22  ["outputs"][0]["
-00012cd0: 6461 7461 225d 5b22 7465 7874 2f70 6c61  data"]["text/pla
-00012ce0: 696e 225d 203d 3d20 2237 220a 2020 2020  in"] == "7".    
-00012cf0: 2020 2020 2020 2020 6173 7365 7274 2063          assert c
-00012d00: 656c 6c5b 2265 7865 6375 7469 6f6e 5f63  ell["execution_c
-00012d10: 6f75 6e74 225d 203d 3d20 310a 2020 2020  ount"] == 1.    
-00012d20: 2020 2020 2020 2020 6173 7365 7274 2063          assert c
-00012d30: 656c 6c5b 226d 6574 6164 6174 6122 5d5b  ell["metadata"][
-00012d40: 226a 7570 7974 6572 5f64 3122 5d5b 2265  "jupyter_d1"]["e
-00012d50: 7865 6375 7469 6f6e 5f73 7461 7465 225d  xecution_state"]
-00012d60: 203d 3d20 2262 7573 7922 0a20 2020 2020   == "busy".     
-00012d70: 2020 2020 2020 2064 6174 6120 3d20 6365         data = ce
-00012d80: 6c6c 5f75 7064 6174 655f 6d73 6773 2e70  ll_update_msgs.p
-00012d90: 6f70 2830 290a 2020 2020 2020 2020 2020  op(0).          
-00012da0: 2020 6365 6c6c 203d 2064 6174 615b 2263    cell = data["c
-00012db0: 656c 6c5f 7570 6461 7465 225d 5b30 5d0a  ell_update"][0].
-00012dc0: 2020 2020 2020 2020 2020 2020 6173 7365              asse
-00012dd0: 7274 2063 656c 6c5b 226f 7574 7075 7473  rt cell["outputs
-00012de0: 225d 5b30 5d5b 2264 6174 6122 5d5b 2274  "][0]["data"]["t
-00012df0: 6578 742f 706c 6169 6e22 5d20 3d3d 2022  ext/plain"] == "
-00012e00: 3722 0a20 2020 2020 2020 2020 2020 2061  7".            a
-00012e10: 7373 6572 7420 6365 6c6c 5b22 6578 6563  ssert cell["exec
-00012e20: 7574 696f 6e5f 636f 756e 7422 5d20 3d3d  ution_count"] ==
-00012e30: 2031 0a20 2020 2020 2020 2020 2020 2061   1.            a
-00012e40: 7373 6572 7420 6365 6c6c 5b22 6d65 7461  ssert cell["meta
-00012e50: 6461 7461 225d 5b22 6a75 7079 7465 725f  data"]["jupyter_
-00012e60: 6431 225d 5b22 6578 6563 7574 696f 6e5f  d1"]["execution_
-00012e70: 7374 6174 6522 5d20 3d3d 2022 6964 6c65  state"] == "idle
-00012e80: 220a 0a20 2020 2020 2020 2020 2020 2064  "..            d
-00012e90: 6174 6120 3d20 6365 6c6c 5f75 7064 6174  ata = cell_updat
-00012ea0: 655f 6d73 6773 2e70 6f70 2830 290a 2020  e_msgs.pop(0).  
-00012eb0: 2020 2020 2020 2020 2020 6365 6c6c 203d            cell =
-00012ec0: 2064 6174 615b 2263 656c 6c5f 7570 6461   data["cell_upda
-00012ed0: 7465 225d 5b30 5d0a 2020 2020 2020 2020  te"][0].        
-00012ee0: 2020 2020 6173 7365 7274 206c 656e 2863      assert len(c
-00012ef0: 656c 6c5b 226f 7574 7075 7473 225d 2920  ell["outputs"]) 
-00012f00: 3d3d 2030 0a20 2020 2020 2020 2020 2020  == 0.           
-00012f10: 2061 7373 6572 7420 6365 6c6c 5b22 6d65   assert cell["me
-00012f20: 7461 6461 7461 225d 5b22 6a75 7079 7465  tadata"]["jupyte
-00012f30: 725f 6431 225d 5b22 6578 6563 7574 696f  r_d1"]["executio
-00012f40: 6e5f 7374 6174 6522 5d20 3d3d 2022 6275  n_state"] == "bu
-00012f50: 7379 220a 0a20 2020 2020 2020 2020 2020  sy"..           
-00012f60: 2064 6174 6120 3d20 6365 6c6c 5f75 7064   data = cell_upd
-00012f70: 6174 655f 6d73 6773 2e70 6f70 2830 290a  ate_msgs.pop(0).
-00012f80: 2020 2020 2020 2020 2020 2020 6365 6c6c              cell
-00012f90: 203d 2064 6174 615b 2263 656c 6c5f 7570   = data["cell_up
-00012fa0: 6461 7465 225d 5b30 5d0a 2020 2020 2020  date"][0].      
-00012fb0: 2020 2020 2020 6173 7365 7274 2063 656c        assert cel
-00012fc0: 6c5b 226f 7574 7075 7473 225d 5b30 5d5b  l["outputs"][0][
-00012fd0: 2274 6578 7422 5d20 3d3d 2022 4c61 7272  "text"] == "Larr
-00012fe0: 7920 7468 6520 4c6c 616d 615c 6e22 0a20  y the Llama\n". 
-00012ff0: 2020 2020 2020 2020 2020 2061 7373 6572             asser
-00013000: 7420 6365 6c6c 5b22 6578 6563 7574 696f  t cell["executio
-00013010: 6e5f 636f 756e 7422 5d20 3d3d 2031 0a20  n_count"] == 1. 
-00013020: 2020 2020 2020 2020 2020 2061 7373 6572             asser
-00013030: 7420 6365 6c6c 5b22 6d65 7461 6461 7461  t cell["metadata
-00013040: 225d 5b22 6a75 7079 7465 725f 6431 225d  "]["jupyter_d1"]
-00013050: 5b22 6578 6563 7574 696f 6e5f 7374 6174  ["execution_stat
-00013060: 6522 5d20 3d3d 2022 6964 6c65 220a 0a20  e"] == "idle".. 
-00013070: 2020 2020 2020 2020 2020 2064 6174 6120             data 
-00013080: 3d20 6365 6c6c 5f75 7064 6174 655f 6d73  = cell_update_ms
-00013090: 6773 2e70 6f70 2830 290a 2020 2020 2020  gs.pop(0).      
-000130a0: 2020 2020 2020 6365 6c6c 203d 2064 6174        cell = dat
-000130b0: 615b 2263 656c 6c5f 7570 6461 7465 225d  a["cell_update"]
-000130c0: 5b30 5d0a 2020 2020 2020 2020 2020 2020  [0].            
-000130d0: 6173 7365 7274 206c 656e 2863 656c 6c5b  assert len(cell[
-000130e0: 226f 7574 7075 7473 225d 2920 3d3d 2030  "outputs"]) == 0
-000130f0: 0a20 2020 2020 2020 2020 2020 2061 7373  .            ass
-00013100: 6572 7420 6365 6c6c 5b22 6d65 7461 6461  ert cell["metada
-00013110: 7461 225d 5b22 6a75 7079 7465 725f 6431  ta"]["jupyter_d1
-00013120: 225d 5b22 6578 6563 7574 696f 6e5f 7374  "]["execution_st
-00013130: 6174 6522 5d20 3d3d 2022 6275 7379 220a  ate"] == "busy".
-00013140: 0a20 2020 2020 2020 2020 2020 2064 6174  .            dat
-00013150: 6120 3d20 6365 6c6c 5f75 7064 6174 655f  a = cell_update_
-00013160: 6d73 6773 2e70 6f70 2830 290a 2020 2020  msgs.pop(0).    
-00013170: 2020 2020 2020 2020 6365 6c6c 203d 2064          cell = d
-00013180: 6174 615b 2263 656c 6c5f 7570 6461 7465  ata["cell_update
-00013190: 225d 5b30 5d0a 2020 2020 2020 2020 2020  "][0].          
-000131a0: 2020 6173 7365 7274 2063 656c 6c5b 226f    assert cell["o
-000131b0: 7574 7075 7473 225d 5b30 5d5b 2264 6174  utputs"][0]["dat
-000131c0: 6122 5d5b 2274 6578 742f 706c 6169 6e22  a"]["text/plain"
-000131d0: 5d20 3d3d 2022 3722 0a20 2020 2020 2020  ] == "7".       
-000131e0: 2020 2020 2061 7373 6572 7420 6365 6c6c       assert cell
-000131f0: 5b22 6578 6563 7574 696f 6e5f 636f 756e  ["execution_coun
-00013200: 7422 5d20 3d3d 2032 0a20 2020 2020 2020  t"] == 2.       
-00013210: 2020 2020 2061 7373 6572 7420 6365 6c6c       assert cell
-00013220: 5b22 6d65 7461 6461 7461 225d 5b22 6a75  ["metadata"]["ju
-00013230: 7079 7465 725f 6431 225d 5b22 6578 6563  pyter_d1"]["exec
-00013240: 7574 696f 6e5f 7374 6174 6522 5d20 3d3d  ution_state"] ==
-00013250: 2022 6275 7379 220a 0a20 2020 2020 2020   "busy"..       
-00013260: 2020 2020 2064 6174 6120 3d20 6365 6c6c       data = cell
-00013270: 5f75 7064 6174 655f 6d73 6773 2e70 6f70  _update_msgs.pop
-00013280: 2830 290a 2020 2020 2020 2020 2020 2020  (0).            
-00013290: 6365 6c6c 203d 2064 6174 615b 2263 656c  cell = data["cel
-000132a0: 6c5f 7570 6461 7465 225d 5b30 5d0a 2020  l_update"][0].  
-000132b0: 2020 2020 2020 2020 2020 6173 7365 7274            assert
-000132c0: 2063 656c 6c5b 226f 7574 7075 7473 225d   cell["outputs"]
-000132d0: 5b30 5d5b 2264 6174 6122 5d5b 2274 6578  [0]["data"]["tex
-000132e0: 742f 706c 6169 6e22 5d20 3d3d 2022 3722  t/plain"] == "7"
-000132f0: 0a20 2020 2020 2020 2020 2020 2061 7373  .            ass
-00013300: 6572 7420 6365 6c6c 5b22 6578 6563 7574  ert cell["execut
-00013310: 696f 6e5f 636f 756e 7422 5d20 3d3d 2032  ion_count"] == 2
-00013320: 0a20 2020 2020 2020 2020 2020 2061 7373  .            ass
-00013330: 6572 7420 6365 6c6c 5b22 6d65 7461 6461  ert cell["metada
-00013340: 7461 225d 5b22 6a75 7079 7465 725f 6431  ta"]["jupyter_d1
-00013350: 225d 5b22 6578 6563 7574 696f 6e5f 7374  "]["execution_st
-00013360: 6174 6522 5d20 3d3d 2022 6964 6c65 220a  ate"] == "idle".
-00013370: 0a20 2020 2040 7079 7465 7374 2e6d 6172  .    @pytest.mar
-00013380: 6b2e 6173 796e 6369 6f0a 2020 2020 6173  k.asyncio.    as
-00013390: 796e 6320 6465 6620 7465 7374 5f69 7079  ync def test_ipy
-000133a0: 7468 6f6e 5f6b 6572 6e65 6c5f 7374 6172  thon_kernel_star
-000133b0: 7475 705f 7363 7269 7074 280a 2020 2020  tup_script(.    
-000133c0: 2020 2020 7365 6c66 2c20 636c 6965 6e74      self, client
-000133d0: 3a20 5465 7374 436c 6965 6e74 2c20 7375  : TestClient, su
-000133e0: 7065 7275 7365 725f 746f 6b65 6e5f 6865  peruser_token_he
-000133f0: 6164 6572 733a 2044 6963 745b 7374 722c  aders: Dict[str,
-00013400: 2073 7472 5d0a 2020 2020 293a 0a20 2020   str].    ):.   
-00013410: 2020 2020 2022 2222 0a20 2020 2020 2020       """.       
-00013420: 2054 6573 7420 7468 6174 2074 6865 2063   Test that the c
-00013430: 616c 6c69 7374 6f5f 7374 6172 7475 702e  allisto_startup.
-00013440: 7079 2073 7461 7274 7570 2073 6372 6970  py startup scrip
-00013450: 7420 6973 2072 756e 2077 6865 6e20 7468  t is run when th
-00013460: 650a 2020 2020 2020 2020 6b65 726e 656c  e.        kernel
-00013470: 2073 7461 7274 732e 0a20 2020 2020 2020   starts..       
-00013480: 2022 2222 0a20 2020 2020 2020 2075 7569   """.        uui
-00013490: 6420 3d20 6177 6169 7420 7570 6c6f 6164  d = await upload
-000134a0: 5f6e 6f74 6562 6f6f 6b28 0a20 2020 2020  _notebook(.     
-000134b0: 2020 2020 2020 2063 6c69 656e 742c 2073         client, s
-000134c0: 7570 6572 7573 6572 5f74 6f6b 656e 5f68  uperuser_token_h
-000134d0: 6561 6465 7273 2c20 2273 696d 706c 652e  eaders, "simple.
-000134e0: 6970 796e 6222 0a20 2020 2020 2020 2029  ipynb".        )
-000134f0: 0a0a 2020 2020 2020 2020 2320 6765 7420  ..        # get 
-00013500: 616e 2065 7869 7374 696e 6720 6365 6c6c  an existing cell
-00013510: 0a20 2020 2020 2020 2072 6573 706f 6e73  .        respons
-00013520: 6520 3d20 6177 6169 7420 636c 6965 6e74  e = await client
-00013530: 2e67 6574 280a 2020 2020 2020 2020 2020  .get(.          
-00013540: 2020 6622 2f6e 6f74 6562 6f6f 6b73 2f7b    f"/notebooks/{
-00013550: 7575 6964 7d2f 6365 6c6c 7322 2c20 6865  uuid}/cells", he
-00013560: 6164 6572 733d 7375 7065 7275 7365 725f  aders=superuser_
-00013570: 746f 6b65 6e5f 6865 6164 6572 730a 2020  token_headers.  
-00013580: 2020 2020 2020 290a 2020 2020 2020 2020        ).        
-00013590: 6173 7365 7274 2072 6573 706f 6e73 652e  assert response.
-000135a0: 7374 6174 7573 5f63 6f64 6520 3d3d 2032  status_code == 2
-000135b0: 3030 0a20 2020 2020 2020 2063 656c 6c73  00.        cells
-000135c0: 203d 2072 6573 706f 6e73 652e 6a73 6f6e   = response.json
-000135d0: 2829 5b22 6365 6c6c 7322 5d0a 2020 2020  ()["cells"].    
-000135e0: 2020 2020 6173 7365 7274 2063 656c 6c73      assert cells
-000135f0: 5b31 5d5b 2273 6f75 7263 6522 5d20 3d3d  [1]["source"] ==
-00013600: 2027 7072 696e 7428 224c 6172 7279 2074   'print("Larry t
-00013610: 6865 204c 6c61 6d61 2229 270a 0a20 2020  he Llama")'..   
-00013620: 2020 2020 2063 656c 6c5f 7575 6964 203d       cell_uuid =
-00013630: 2063 656c 6c73 5b31 5d5b 226d 6574 6164   cells[1]["metad
-00013640: 6174 6122 5d5b 226a 7570 7974 6572 5f64  ata"]["jupyter_d
-00013650: 3122 5d5b 2275 7569 6422 5d0a 0a20 2020  1"]["uuid"]..   
-00013660: 2020 2020 2070 6172 616d 7320 3d20 7b0a       params = {.
-00013670: 2020 2020 2020 2020 2020 2020 2273 6f75              "sou
-00013680: 7263 6522 3a20 2269 6d70 6f72 7420 7061  rce": "import pa
-00013690: 6e64 6173 2061 7320 7064 5c6e 220a 2020  ndas as pd\n".  
-000136a0: 2020 2020 2020 2020 2020 2770 642e 6765            'pd.ge
-000136b0: 745f 6f70 7469 6f6e 2822 6469 7370 6c61  t_option("displa
-000136c0: 792e 6874 6d6c 2e74 6162 6c65 5f73 6368  y.html.table_sch
-000136d0: 656d 6122 2927 0a20 2020 2020 2020 207d  ema")'.        }
-000136e0: 0a20 2020 2020 2020 2072 6573 706f 6e73  .        respons
-000136f0: 6520 3d20 6177 6169 7420 636c 6965 6e74  e = await client
-00013700: 2e70 6174 6368 280a 2020 2020 2020 2020  .patch(.        
-00013710: 2020 2020 6622 2f6e 6f74 6562 6f6f 6b73      f"/notebooks
-00013720: 2f7b 7575 6964 7d2f 6365 6c6c 732f 7b63  /{uuid}/cells/{c
-00013730: 656c 6c5f 7575 6964 7d22 2c0a 2020 2020  ell_uuid}",.    
-00013740: 2020 2020 2020 2020 6a73 6f6e 3d70 6172          json=par
-00013750: 616d 732c 0a20 2020 2020 2020 2020 2020  ams,.           
-00013760: 2068 6561 6465 7273 3d73 7570 6572 7573   headers=superus
-00013770: 6572 5f74 6f6b 656e 5f68 6561 6465 7273  er_token_headers
-00013780: 2c0a 2020 2020 2020 2020 290a 2020 2020  ,.        ).    
-00013790: 2020 2020 6173 7365 7274 2072 6573 706f      assert respo
-000137a0: 6e73 652e 7374 6174 7573 5f63 6f64 6520  nse.status_code 
-000137b0: 3d3d 2032 3030 0a0a 2020 2020 2020 2020  == 200..        
-000137c0: 7265 7370 6f6e 7365 203d 2061 7761 6974  response = await
-000137d0: 2063 6c69 656e 742e 6765 7428 0a20 2020   client.get(.   
-000137e0: 2020 2020 2020 2020 2066 222f 6e6f 7465           f"/note
-000137f0: 626f 6f6b 732f 7b75 7569 647d 2f76 6172  books/{uuid}/var
-00013800: 7322 2c20 6865 6164 6572 733d 7375 7065  s", headers=supe
-00013810: 7275 7365 725f 746f 6b65 6e5f 6865 6164  ruser_token_head
-00013820: 6572 730a 2020 2020 2020 2020 290a 2020  ers.        ).  
-00013830: 2020 2020 2020 6173 7365 7274 2072 6573        assert res
-00013840: 706f 6e73 652e 7374 6174 7573 5f63 6f64  ponse.status_cod
-00013850: 6520 3d3d 2032 3030 0a20 2020 2020 2020  e == 200.       
-00013860: 2061 7373 6572 7420 6c65 6e28 7265 7370   assert len(resp
-00013870: 6f6e 7365 2e6a 736f 6e28 295b 2276 6172  onse.json()["var
-00013880: 7322 5d29 203d 3d20 300a 0a20 2020 2020  s"]) == 0..     
-00013890: 2020 2061 7379 6e63 2077 6974 6820 636c     async with cl
-000138a0: 6965 6e74 2e77 6562 736f 636b 6574 5f63  ient.websocket_c
-000138b0: 6f6e 6e65 6374 280a 2020 2020 2020 2020  onnect(.        
-000138c0: 2020 2020 6622 2f6e 6f74 6562 6f6f 6b73      f"/notebooks
-000138d0: 2f7b 7575 6964 7d2f 7773 2f6e 6f74 6562  /{uuid}/ws/noteb
-000138e0: 6f6f 6b22 2c20 6865 6164 6572 733d 7375  ook", headers=su
-000138f0: 7065 7275 7365 725f 746f 6b65 6e5f 6865  peruser_token_he
-00013900: 6164 6572 730a 2020 2020 2020 2020 2920  aders.        ) 
-00013910: 6173 2077 6562 736f 636b 6574 3a0a 2020  as websocket:.  
-00013920: 2020 2020 2020 2020 2020 6177 6169 7420            await 
-00013930: 6173 796e 6369 6f2e 736c 6565 7028 5745  asyncio.sleep(WE
-00013940: 4253 4f43 4b45 545f 534c 4545 505f 5449  BSOCKET_SLEEP_TI
-00013950: 4d45 290a 0a20 2020 2020 2020 2020 2020  ME)..           
-00013960: 2072 6573 706f 6e73 6520 3d20 6177 6169   response = awai
-00013970: 7420 636c 6965 6e74 2e70 6174 6368 280a  t client.patch(.
-00013980: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00013990: 6622 2f6e 6f74 6562 6f6f 6b73 2f7b 7575  f"/notebooks/{uu
-000139a0: 6964 7d2f 6365 6c6c 732f 7b63 656c 6c5f  id}/cells/{cell_
-000139b0: 7575 6964 7d2f 6578 6563 7574 6522 2c0a  uuid}/execute",.
-000139c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000139d0: 6a73 6f6e 3d70 6172 616d 732c 0a20 2020  json=params,.   
-000139e0: 2020 2020 2020 2020 2020 2020 2068 6561               hea
-000139f0: 6465 7273 3d73 7570 6572 7573 6572 5f74  ders=superuser_t
-00013a00: 6f6b 656e 5f68 6561 6465 7273 2c0a 2020  oken_headers,.  
-00013a10: 2020 2020 2020 2020 2020 290a 2020 2020            ).    
-00013a20: 2020 2020 2020 2020 6173 7365 7274 2072          assert r
-00013a30: 6573 706f 6e73 652e 7374 6174 7573 5f63  esponse.status_c
-00013a40: 6f64 6520 3d3d 2032 3030 0a0a 2020 2020  ode == 200..    
-00013a50: 2020 2020 2020 2020 6578 7065 6374 6564          expected
-00013a60: 203d 207b 0a20 2020 2020 2020 2020 2020   = {.           
-00013a70: 2020 2020 2022 6365 6c6c 5f75 7064 6174       "cell_updat
-00013a80: 6522 3a20 5b0a 2020 2020 2020 2020 2020  e": [.          
-00013a90: 2020 2020 2020 2020 2020 7b0a 2020 2020            {.    
-00013aa0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00013ab0: 2020 2020 2263 656c 6c5f 7479 7065 223a      "cell_type":
-00013ac0: 2022 636f 6465 222c 0a20 2020 2020 2020   "code",.       
-00013ad0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00013ae0: 2022 6578 6563 7574 696f 6e5f 636f 756e   "execution_coun
-00013af0: 7422 3a20 312c 0a20 2020 2020 2020 2020  t": 1,.         
-00013b00: 2020 2020 2020 2020 2020 2020 2020 2022                 "
-00013b10: 6d65 7461 6461 7461 223a 207b 0a20 2020  metadata": {.   
-00013b20: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00013b30: 2020 2020 2020 2020 2022 6a75 7079 7465           "jupyte
-00013b40: 725f 6431 223a 207b 0a20 2020 2020 2020  r_d1": {.       
-00013b50: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00013b60: 2020 2020 2020 2020 2022 706f 7369 7469           "positi
-00013b70: 6f6e 223a 2031 2c0a 2020 2020 2020 2020  on": 1,.        
-00013b80: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00013b90: 2020 2020 2020 2020 2275 7569 6422 3a20          "uuid": 
-00013ba0: 6365 6c6c 5f75 7569 642c 0a20 2020 2020  cell_uuid,.     
-00013bb0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00013bc0: 2020 2020 2020 2020 2020 2022 6e6f 7465             "note
-00013bd0: 626f 6f6b 5f75 7569 6422 3a20 7575 6964  book_uuid": uuid
-00013be0: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
-00013bf0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00013c00: 2020 2265 7865 6375 7469 6f6e 5f73 7461    "execution_sta
-00013c10: 7465 223a 2022 6275 7379 222c 0a20 2020  te": "busy",.   
-00013c20: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00013c30: 2020 2020 2020 2020 207d 0a20 2020 2020           }.     
-00013c40: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00013c50: 2020 207d 2c0a 2020 2020 2020 2020 2020     },.          
-00013c60: 2020 2020 2020 2020 2020 2020 2020 226f                "o
-00013c70: 7574 7075 7473 223a 205b 0a20 2020 2020  utputs": [.     
-00013c80: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00013c90: 2020 2020 2020 207b 0a20 2020 2020 2020         {.       
-00013ca0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00013cb0: 2020 2020 2020 2020 2022 6461 7461 223a           "data":
-00013cc0: 207b 2274 6578 742f 706c 6169 6e22 3a20   {"text/plain": 
-00013cd0: 2254 7275 6522 7d2c 0a20 2020 2020 2020  "True"},.       
-00013ce0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00013cf0: 2020 2020 2020 2020 2022 6578 6563 7574           "execut
-00013d00: 696f 6e5f 636f 756e 7422 3a20 312c 0a20  ion_count": 1,. 
-00013d10: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00013d20: 2020 2020 2020 2020 2020 2020 2020 2022                 "
-00013d30: 6d65 7461 6461 7461 223a 207b 7d2c 0a20  metadata": {},. 
-00013d40: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00013d50: 2020 2020 2020 2020 2020 2020 2020 2022                 "
-00013d60: 6f75 7470 7574 5f74 7970 6522 3a20 2265  output_type": "e
-00013d70: 7865 6375 7465 5f72 6573 756c 7422 2c0a  xecute_result",.
-00013d80: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00013d90: 2020 2020 2020 2020 2020 2020 7d0a 2020              }.  
-00013da0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00013db0: 2020 2020 2020 5d2c 0a20 2020 2020 2020        ],.       
-00013dc0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00013dd0: 2022 736f 7572 6365 223a 2022 696d 706f   "source": "impo
-00013de0: 7274 2070 616e 6461 7320 6173 2070 645c  rt pandas as pd\
-00013df0: 6e22 0a20 2020 2020 2020 2020 2020 2020  n".             
-00013e00: 2020 2020 2020 2020 2020 2027 7064 2e67             'pd.g
-00013e10: 6574 5f6f 7074 696f 6e28 2264 6973 706c  et_option("displ
-00013e20: 6179 2e68 746d 6c2e 7461 626c 655f 7363  ay.html.table_sc
-00013e30: 6865 6d61 2229 272c 0a20 2020 2020 2020  hema")',.       
-00013e40: 2020 2020 2020 2020 2020 2020 207d 0a20               }. 
-00013e50: 2020 2020 2020 2020 2020 2020 2020 205d                 ]
-00013e60: 0a20 2020 2020 2020 2020 2020 207d 0a0a  .            }..
-00013e70: 2020 2020 2020 2020 2020 2020 7061 7463              patc
-00013e80: 685f 6a73 6f6e 203d 2072 6573 706f 6e73  h_json = respons
-00013e90: 652e 6a73 6f6e 2829 0a20 2020 2020 2020  e.json().       
-00013ea0: 2020 2020 2023 2072 6573 706f 6e73 6520       # response 
-00013eb0: 7368 6f75 6c64 2063 6f6e 7461 696e 2062  should contain b
-00013ec0: 6f74 6820 7468 6520 2763 656c 6c27 2c27  oth the 'cell','
-00013ed0: 6b65 726e 656c 5f6d 6573 7361 6765 2720  kernel_message' 
-00013ee0: 7772 6170 7065 7273 0a20 2020 2020 2020  wrappers.       
-00013ef0: 2020 2020 2061 7373 6572 7420 2263 656c       assert "cel
-00013f00: 6c22 2069 6e20 7061 7463 685f 6a73 6f6e  l" in patch_json
-00013f10: 2e6b 6579 7328 290a 2020 2020 2020 2020  .keys().        
-00013f20: 2020 2020 6d73 675f 6964 203d 2072 6573      msg_id = res
-00013f30: 706f 6e73 652e 6a73 6f6e 2829 5b22 6b65  ponse.json()["ke
-00013f40: 726e 656c 5f6d 6573 7361 6765 225d 5b22  rnel_message"]["
-00013f50: 6d65 7373 6167 655f 6964 225d 0a20 2020  message_id"].   
-00013f60: 2020 2020 2020 2020 2061 7373 6572 7420           assert 
-00013f70: 6c65 6e28 6d73 675f 6964 2920 696e 206d  len(msg_id) in m
-00013f80: 7367 5f69 645f 6c65 6e67 7468 730a 0a20  sg_id_lengths.. 
-00013f90: 2020 2020 2020 2020 2020 2065 7865 635f             exec_
-00013fa0: 7265 706c 7920 3d20 6177 6169 7420 7265  reply = await re
-00013fb0: 6365 6976 655f 6a73 6f6e 280a 2020 2020  ceive_json(.    
-00013fc0: 2020 2020 2020 2020 2020 2020 7765 6273              webs
-00013fd0: 6f63 6b65 742c 206d 7367 5f74 7970 6573  ocket, msg_types
-00013fe0: 3d5b 2263 656c 6c5f 6578 6563 7574 696f  =["cell_executio
-00013ff0: 6e5f 7265 706c 7922 5d0a 2020 2020 2020  n_reply"].      
-00014000: 2020 2020 2020 290a 2020 2020 2020 2020        ).        
-00014010: 2020 2020 6173 7365 7274 2065 7865 635f      assert exec_
-00014020: 7265 706c 795b 2263 656c 6c5f 6578 6563  reply["cell_exec
-00014030: 7574 696f 6e5f 7265 706c 7922 5d5b 2263  ution_reply"]["c
-00014040: 656c 6c5f 6964 225d 203d 3d20 6365 6c6c  ell_id"] == cell
-00014050: 5f75 7569 640a 2020 2020 2020 2020 2020  _uuid.          
-00014060: 2020 6173 7365 7274 2065 7865 635f 7265    assert exec_re
-00014070: 706c 795b 2263 656c 6c5f 6578 6563 7574  ply["cell_execut
-00014080: 696f 6e5f 7265 706c 7922 5d5b 2270 6172  ion_reply"]["par
-00014090: 656e 745f 6964 225d 203d 3d20 6d73 675f  ent_id"] == msg_
-000140a0: 6964 0a0a 2020 2020 2020 2020 2020 2020  id..            
-000140b0: 6461 7461 203d 2061 7761 6974 2072 6563  data = await rec
-000140c0: 6569 7665 5f6a 736f 6e28 7765 6273 6f63  eive_json(websoc
-000140d0: 6b65 742c 206d 7367 5f74 7970 6573 3d5b  ket, msg_types=[
-000140e0: 2263 656c 6c5f 7570 6461 7465 225d 290a  "cell_update"]).
-000140f0: 2020 2020 2020 2020 2020 2020 6173 7365              asse
-00014100: 7274 2064 6174 6120 3d3d 2065 7870 6563  rt data == expec
-00014110: 7465 640a 0a0a 4070 7974 6573 742e 6d61  ted...@pytest.ma
-00014120: 726b 2e75 7365 6669 7874 7572 6573 2822  rk.usefixtures("
-00014130: 636c 6561 725f 6e6f 7465 626f 6f6b 7322  clear_notebooks"
-00014140: 2c20 2263 6c65 6172 5f6e 6f74 6562 6f6f  , "clear_noteboo
-00014150: 6b5f 6469 7265 6374 6f72 7922 290a 636c  k_directory").cl
-00014160: 6173 7320 5465 7374 4b65 726e 656c 5661  ass TestKernelVa
-00014170: 7273 4d61 6e61 6765 723a 0a20 2020 2040  rsManager:.    @
-00014180: 7079 7465 7374 2e6d 6172 6b2e 6173 796e  pytest.mark.asyn
-00014190: 6369 6f0a 2020 2020 6173 796e 6320 6465  cio.    async de
-000141a0: 6620 7465 7374 5f67 6574 5f73 696e 676c  f test_get_singl
-000141b0: 655f 7661 725f 6465 7461 696c 280a 2020  e_var_detail(.  
-000141c0: 2020 2020 2020 7365 6c66 2c20 636c 6965        self, clie
-000141d0: 6e74 3a20 5465 7374 436c 6965 6e74 2c20  nt: TestClient, 
-000141e0: 7375 7065 7275 7365 725f 746f 6b65 6e5f  superuser_token_
-000141f0: 6865 6164 6572 733a 2044 6963 745b 7374  headers: Dict[st
-00014200: 722c 2073 7472 5d0a 2020 2020 293a 0a20  r, str].    ):. 
-00014210: 2020 2020 2020 2022 2222 0a20 2020 2020         """.     
-00014220: 2020 204c 6172 6765 2064 6174 6166 7261     Large datafra
-00014230: 6d65 2069 7320 6162 6272 6576 6961 7465  me is abbreviate
-00014240: 6420 696e 2073 756d 6d61 7279 2c20 6e6f  d in summary, no
-00014250: 7420 696e 2076 6172 6961 626c 650a 2020  t in variable.  
-00014260: 2020 2020 2020 6465 7461 696c 7320 7265        details re
-00014270: 7175 6573 742e 0a20 2020 2020 2020 2022  quest..        "
-00014280: 2222 0a20 2020 2020 2020 2075 7569 6420  "".        uuid 
-00014290: 3d20 6177 6169 7420 7570 6c6f 6164 5f6e  = await upload_n
-000142a0: 6f74 6562 6f6f 6b28 0a20 2020 2020 2020  otebook(.       
-000142b0: 2020 2020 2063 6c69 656e 742c 2073 7570       client, sup
-000142c0: 6572 7573 6572 5f74 6f6b 656e 5f68 6561  eruser_token_hea
-000142d0: 6465 7273 2c20 2273 696d 706c 652e 6970  ders, "simple.ip
-000142e0: 796e 6222 0a20 2020 2020 2020 2029 0a0a  ynb".        )..
-000142f0: 2020 2020 2020 2020 2320 6765 7420 616e          # get an
-00014300: 2065 7869 7374 696e 6720 6365 6c6c 0a20   existing cell. 
-00014310: 2020 2020 2020 2072 6573 706f 6e73 6520         response 
-00014320: 3d20 6177 6169 7420 636c 6965 6e74 2e67  = await client.g
-00014330: 6574 280a 2020 2020 2020 2020 2020 2020  et(.            
-00014340: 6622 2f6e 6f74 6562 6f6f 6b73 2f7b 7575  f"/notebooks/{uu
-00014350: 6964 7d2f 6365 6c6c 7322 2c20 6865 6164  id}/cells", head
-00014360: 6572 733d 7375 7065 7275 7365 725f 746f  ers=superuser_to
-00014370: 6b65 6e5f 6865 6164 6572 730a 2020 2020  ken_headers.    
-00014380: 2020 2020 290a 2020 2020 2020 2020 6173      ).        as
-00014390: 7365 7274 2072 6573 706f 6e73 652e 7374  sert response.st
-000143a0: 6174 7573 5f63 6f64 6520 3d3d 2032 3030  atus_code == 200
-000143b0: 0a20 2020 2020 2020 2063 656c 6c73 203d  .        cells =
-000143c0: 2072 6573 706f 6e73 652e 6a73 6f6e 2829   response.json()
-000143d0: 5b22 6365 6c6c 7322 5d0a 2020 2020 2020  ["cells"].      
-000143e0: 2020 6173 7365 7274 2063 656c 6c73 5b31    assert cells[1
-000143f0: 5d5b 2273 6f75 7263 6522 5d20 3d3d 2027  ]["source"] == '
-00014400: 7072 696e 7428 224c 6172 7279 2074 6865  print("Larry the
-00014410: 204c 6c61 6d61 2229 270a 0a20 2020 2020   Llama")'..     
-00014420: 2020 2063 656c 6c5f 7575 6964 203d 2063     cell_uuid = c
-00014430: 656c 6c73 5b31 5d5b 226d 6574 6164 6174  ells[1]["metadat
-00014440: 6122 5d5b 226a 7570 7974 6572 5f64 3122  a"]["jupyter_d1"
-00014450: 5d5b 2275 7569 6422 5d0a 0a20 2020 2020  ]["uuid"]..     
-00014460: 2020 2070 6172 616d 7320 3d20 7b0a 2020     params = {.  
-00014470: 2020 2020 2020 2020 2020 2273 6f75 7263            "sourc
-00014480: 6522 3a20 2269 6d70 6f72 7420 7061 6e64  e": "import pand
-00014490: 6173 2061 7320 7064 5c6e 6466 3320 3d20  as as pd\ndf3 = 
-000144a0: 220a 2020 2020 2020 2020 2020 2020 2270  ".            "p
-000144b0: 642e 4461 7461 4672 616d 6528 5b7b 7374  d.DataFrame([{st
-000144c0: 7228 6929 3a20 6920 2b20 6a20 666f 7220  r(i): i + j for 
-000144d0: 6920 696e 2072 616e 6765 2835 297d 2066  i in range(5)} f
-000144e0: 6f72 206a 2069 6e20 220a 2020 2020 2020  or j in ".      
-000144f0: 2020 2020 2020 2272 616e 6765 2831 3530        "range(150
-00014500: 295d 2922 0a20 2020 2020 2020 207d 0a20  )])".        }. 
-00014510: 2020 2020 2020 2072 6573 706f 6e73 6520         response 
-00014520: 3d20 6177 6169 7420 636c 6965 6e74 2e70  = await client.p
-00014530: 6174 6368 280a 2020 2020 2020 2020 2020  atch(.          
-00014540: 2020 6622 2f6e 6f74 6562 6f6f 6b73 2f7b    f"/notebooks/{
-00014550: 7575 6964 7d2f 6365 6c6c 732f 7b63 656c  uuid}/cells/{cel
-00014560: 6c5f 7575 6964 7d22 2c0a 2020 2020 2020  l_uuid}",.      
-00014570: 2020 2020 2020 6a73 6f6e 3d70 6172 616d        json=param
-00014580: 732c 0a20 2020 2020 2020 2020 2020 2068  s,.            h
-00014590: 6561 6465 7273 3d73 7570 6572 7573 6572  eaders=superuser
-000145a0: 5f74 6f6b 656e 5f68 6561 6465 7273 2c0a  _token_headers,.
-000145b0: 2020 2020 2020 2020 290a 2020 2020 2020          ).      
-000145c0: 2020 6173 7365 7274 2072 6573 706f 6e73    assert respons
-000145d0: 652e 7374 6174 7573 5f63 6f64 6520 3d3d  e.status_code ==
-000145e0: 2032 3030 0a0a 2020 2020 2020 2020 7265   200..        re
-000145f0: 7370 6f6e 7365 203d 2061 7761 6974 2063  sponse = await c
-00014600: 6c69 656e 742e 6765 7428 0a20 2020 2020  lient.get(.     
-00014610: 2020 2020 2020 2066 222f 6e6f 7465 626f         f"/notebo
-00014620: 6f6b 732f 7b75 7569 647d 2f76 6172 7322  oks/{uuid}/vars"
-00014630: 2c20 6865 6164 6572 733d 7375 7065 7275  , headers=superu
-00014640: 7365 725f 746f 6b65 6e5f 6865 6164 6572  ser_token_header
-00014650: 730a 2020 2020 2020 2020 290a 2020 2020  s.        ).    
-00014660: 2020 2020 6173 7365 7274 2072 6573 706f      assert respo
-00014670: 6e73 652e 7374 6174 7573 5f63 6f64 6520  nse.status_code 
-00014680: 3d3d 2032 3030 0a20 2020 2020 2020 2061  == 200.        a
-00014690: 7373 6572 7420 6c65 6e28 7265 7370 6f6e  ssert len(respon
-000146a0: 7365 2e6a 736f 6e28 295b 2276 6172 7322  se.json()["vars"
-000146b0: 5d29 203d 3d20 300a 0a20 2020 2020 2020  ]) == 0..       
-000146c0: 2061 7379 6e63 2077 6974 6820 636c 6965   async with clie
-000146d0: 6e74 2e77 6562 736f 636b 6574 5f63 6f6e  nt.websocket_con
-000146e0: 6e65 6374 280a 2020 2020 2020 2020 2020  nect(.          
-000146f0: 2020 6622 2f6e 6f74 6562 6f6f 6b73 2f7b    f"/notebooks/{
-00014700: 7575 6964 7d2f 7773 2f6e 6f74 6562 6f6f  uuid}/ws/noteboo
-00014710: 6b22 2c20 6865 6164 6572 733d 7375 7065  k", headers=supe
-00014720: 7275 7365 725f 746f 6b65 6e5f 6865 6164  ruser_token_head
-00014730: 6572 730a 2020 2020 2020 2020 2920 6173  ers.        ) as
-00014740: 2077 6562 736f 636b 6574 3a0a 2020 2020   websocket:.    
-00014750: 2020 2020 2020 2020 6177 6169 7420 6173          await as
-00014760: 796e 6369 6f2e 736c 6565 7028 5745 4253  yncio.sleep(WEBS
-00014770: 4f43 4b45 545f 534c 4545 505f 5449 4d45  OCKET_SLEEP_TIME
-00014780: 290a 0a20 2020 2020 2020 2020 2020 2072  )..            r
-00014790: 6573 706f 6e73 6520 3d20 6177 6169 7420  esponse = await 
-000147a0: 636c 6965 6e74 2e67 6574 280a 2020 2020  client.get(.    
-000147b0: 2020 2020 2020 2020 2020 2020 6622 2f6e              f"/n
-000147c0: 6f74 6562 6f6f 6b73 2f7b 7575 6964 7d2f  otebooks/{uuid}/
-000147d0: 6365 6c6c 732f 7b63 656c 6c5f 7575 6964  cells/{cell_uuid
-000147e0: 7d2f 6578 6563 7574 6522 2c0a 2020 2020  }/execute",.    
-000147f0: 2020 2020 2020 2020 2020 2020 6865 6164              head
-00014800: 6572 733d 7375 7065 7275 7365 725f 746f  ers=superuser_to
-00014810: 6b65 6e5f 6865 6164 6572 732c 0a20 2020  ken_headers,.   
-00014820: 2020 2020 2020 2020 2029 0a20 2020 2020           ).     
-00014830: 2020 2020 2020 2061 7373 6572 7420 7265         assert re
-00014840: 7370 6f6e 7365 2e73 7461 7475 735f 636f  sponse.status_co
-00014850: 6465 203d 3d20 3230 300a 0a20 2020 2020  de == 200..     
-00014860: 2020 2020 2020 2023 204b 6572 6e65 6c20         # Kernel 
-00014870: 7661 7273 2075 7064 6174 650a 2020 2020  vars update.    
-00014880: 2020 2020 2020 2020 6461 7461 203d 2061          data = a
-00014890: 7761 6974 2072 6563 6569 7665 5f6a 736f  wait receive_jso
-000148a0: 6e28 7765 6273 6f63 6b65 742c 206d 7367  n(websocket, msg
-000148b0: 5f74 7970 6573 3d5b 2276 6172 7322 5d29  _types=["vars"])
-000148c0: 0a20 2020 2020 2020 2020 2020 2076 6172  .            var
-000148d0: 7320 3d20 7b0a 2020 2020 2020 2020 2020  s = {.          
-000148e0: 2020 2020 2020 7661 725b 226e 616d 6522        var["name"
-000148f0: 5d3a 207b 0a20 2020 2020 2020 2020 2020  ]: {.           
-00014900: 2020 2020 2020 2020 2022 7479 7065 223a           "type":
-00014910: 2076 6172 5b22 7479 7065 225d 2c0a 2020   var["type"],.  
-00014920: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00014930: 2020 2276 616c 7565 223a 2076 6172 5b22    "value": var["
-00014940: 7661 6c75 6522 5d2c 0a20 2020 2020 2020  value"],.       
-00014950: 2020 2020 2020 2020 2020 2020 2022 7375               "su
-00014960: 6d6d 6172 7922 3a20 7661 725b 2273 756d  mmary": var["sum
-00014970: 6d61 7279 225d 2c0a 2020 2020 2020 2020  mary"],.        
-00014980: 2020 2020 2020 2020 2020 2020 2261 6262              "abb
-00014990: 7265 7669 6174 6564 223a 2076 6172 5b22  reviated": var["
-000149a0: 6162 6272 6576 6961 7465 6422 5d2c 0a20  abbreviated"],. 
-000149b0: 2020 2020 2020 2020 2020 2020 2020 207d                 }
-000149c0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-000149d0: 2066 6f72 2076 6172 2069 6e20 6461 7461   for var in data
-000149e0: 5b22 7661 7273 225d 0a20 2020 2020 2020  ["vars"].       
-000149f0: 2020 2020 207d 0a0a 2020 2020 2020 2020       }..        
-00014a00: 2020 2020 6173 7365 7274 2076 6172 735b      assert vars[
-00014a10: 2264 6633 225d 5b22 7479 7065 225d 203d  "df3"]["type"] =
-00014a20: 3d20 2244 6174 6146 7261 6d65 220a 2020  = "DataFrame".  
-00014a30: 2020 2020 2020 2020 2020 6173 7365 7274            assert
-00014a40: 2076 6172 735b 2264 6633 225d 5b22 7661   vars["df3"]["va
-00014a50: 6c75 6522 5d5b 226d 756c 7469 5f76 616c  lue"]["multi_val
-00014a60: 7565 225d 5b22 636f 6c75 6d6e 5f63 6f75  ue"]["column_cou
-00014a70: 6e74 225d 203d 3d20 350a 2020 2020 2020  nt"] == 5.      
-00014a80: 2020 2020 2020 6173 7365 7274 2076 6172        assert var
-00014a90: 735b 2264 6633 225d 5b22 7661 6c75 6522  s["df3"]["value"
-00014aa0: 5d5b 226d 756c 7469 5f76 616c 7565 225d  ]["multi_value"]
-00014ab0: 5b22 726f 775f 636f 756e 7422 5d20 3d3d  ["row_count"] ==
-00014ac0: 2031 3530 0a20 2020 2020 2020 2020 2020   150.           
-00014ad0: 2061 7373 6572 7420 7661 7273 5b22 6466   assert vars["df
-00014ae0: 3322 5d5b 2276 616c 7565 225d 5b22 6d75  3"]["value"]["mu
-00014af0: 6c74 695f 7661 6c75 6522 5d5b 2263 6f6c  lti_value"]["col
-00014b00: 756d 6e5f 6e61 6d65 7322 5d20 3d3d 205b  umn_names"] == [
-00014b10: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00014b20: 2073 7472 2869 2920 666f 7220 6920 696e   str(i) for i in
-00014b30: 2072 616e 6765 2835 290a 2020 2020 2020   range(5).      
-00014b40: 2020 2020 2020 5d0a 2020 2020 2020 2020        ].        
-00014b50: 2020 2020 6173 7365 7274 2076 6172 735b      assert vars[
-00014b60: 2264 6633 225d 5b22 7661 6c75 6522 5d5b  "df3"]["value"][
-00014b70: 226d 756c 7469 5f76 616c 7565 225d 5b22  "multi_value"]["
-00014b80: 6461 7461 225d 203d 3d20 5b0a 2020 2020  data"] == [.    
-00014b90: 2020 2020 2020 2020 2020 2020 5b73 7472              [str
-00014ba0: 2869 202b 206a 2920 666f 7220 6920 696e  (i + j) for i in
-00014bb0: 2072 616e 6765 2835 295d 2066 6f72 206a   range(5)] for j
-00014bc0: 2069 6e20 7261 6e67 6528 3130 290a 2020   in range(10).  
-00014bd0: 2020 2020 2020 2020 2020 5d0a 2020 2020            ].    
-00014be0: 2020 2020 2020 2020 6173 7365 7274 2076          assert v
-00014bf0: 6172 735b 2264 6633 225d 5b22 7375 6d6d  ars["df3"]["summ
-00014c00: 6172 7922 5d20 3d3d 2022 5369 7a65 3a20  ary"] == "Size: 
-00014c10: 3135 3078 3520 4d65 6d6f 7279 3a20 352e  150x5 Memory: 5.
-00014c20: 3938 204b 4222 0a20 2020 2020 2020 2020  98 KB".         
-00014c30: 2020 2061 7373 6572 7420 7661 7273 5b22     assert vars["
-00014c40: 6466 3322 5d5b 2261 6262 7265 7669 6174  df3"]["abbreviat
-00014c50: 6564 225d 2069 7320 5472 7565 0a0a 2020  ed"] is True..  
-00014c60: 2020 2020 2020 2020 2020 7265 7370 6f6e            respon
-00014c70: 7365 203d 2061 7761 6974 2063 6c69 656e  se = await clien
-00014c80: 742e 6765 7428 0a20 2020 2020 2020 2020  t.get(.         
-00014c90: 2020 2020 2020 2066 222f 6e6f 7465 626f         f"/notebo
-00014ca0: 6f6b 732f 7b75 7569 647d 2f76 6172 7322  oks/{uuid}/vars"
-00014cb0: 2c20 6865 6164 6572 733d 7375 7065 7275  , headers=superu
-00014cc0: 7365 725f 746f 6b65 6e5f 6865 6164 6572  ser_token_header
-00014cd0: 730a 2020 2020 2020 2020 2020 2020 290a  s.            ).
-00014ce0: 2020 2020 2020 2020 2020 2020 6173 7365              asse
-00014cf0: 7274 2072 6573 706f 6e73 652e 7374 6174  rt response.stat
-00014d00: 7573 5f63 6f64 6520 3d3d 2032 3030 0a20  us_code == 200. 
-00014d10: 2020 2020 2020 2020 2020 2063 7572 7265             curre
-00014d20: 6e74 5f76 6172 7320 3d20 7265 7370 6f6e  nt_vars = respon
-00014d30: 7365 2e6a 736f 6e28 295b 2276 6172 7322  se.json()["vars"
-00014d40: 5d0a 2020 2020 2020 2020 2020 2020 6375  ].            cu
-00014d50: 7272 656e 745f 7661 7273 203d 2066 696c  rrent_vars = fil
-00014d60: 7465 7228 0a20 2020 2020 2020 2020 2020  ter(.           
-00014d70: 2020 2020 206c 616d 6264 6120 783a 2078       lambda x: x
-00014d80: 5b22 6e61 6d65 225d 2021 3d20 225f 5f5f  ["name"] != "___
-00014d90: 6431 6f73 222c 2063 7572 7265 6e74 5f76  d1os", current_v
-00014da0: 6172 730a 2020 2020 2020 2020 2020 2020  ars.            
-00014db0: 290a 2020 2020 2020 2020 2020 2020 6173  ).            as
-00014dc0: 7365 7274 206c 6973 7428 6375 7272 656e  sert list(curren
-00014dd0: 745f 7661 7273 2920 3d3d 2064 6174 615b  t_vars) == data[
-00014de0: 2276 6172 7322 5d0a 0a20 2020 2020 2020  "vars"]..       
-00014df0: 2020 2020 2072 6573 706f 6e73 6520 3d20       response = 
-00014e00: 6177 6169 7420 636c 6965 6e74 2e67 6574  await client.get
-00014e10: 280a 2020 2020 2020 2020 2020 2020 2020  (.              
-00014e20: 2020 6622 2f6e 6f74 6562 6f6f 6b73 2f7b    f"/notebooks/{
-00014e30: 7575 6964 7d2f 7661 7273 2f64 6633 222c  uuid}/vars/df3",
-00014e40: 2068 6561 6465 7273 3d73 7570 6572 7573   headers=superus
-00014e50: 6572 5f74 6f6b 656e 5f68 6561 6465 7273  er_token_headers
-00014e60: 0a20 2020 2020 2020 2020 2020 2029 0a20  .            ). 
-00014e70: 2020 2020 2020 2020 2020 2061 7373 6572             asser
-00014e80: 7420 7265 7370 6f6e 7365 2e73 7461 7475  t response.statu
-00014e90: 735f 636f 6465 203d 3d20 3230 300a 2020  s_code == 200.  
-00014ea0: 2020 2020 2020 2020 2020 7369 6e67 6c65            single
-00014eb0: 5f76 6172 203d 2072 6573 706f 6e73 652e  _var = response.
-00014ec0: 6a73 6f6e 2829 5b22 7369 6e67 6c65 5f76  json()["single_v
-00014ed0: 6172 225d 0a20 2020 2020 2020 2020 2020  ar"].           
-00014ee0: 2061 7373 6572 7420 7369 6e67 6c65 5f76   assert single_v
-00014ef0: 6172 5b22 6e61 6d65 225d 203d 3d20 2264  ar["name"] == "d
-00014f00: 6633 220a 2020 2020 2020 2020 2020 2020  f3".            
-00014f10: 6173 7365 7274 2073 696e 676c 655f 7661  assert single_va
-00014f20: 725b 2274 7970 6522 5d20 3d3d 2022 4461  r["type"] == "Da
-00014f30: 7461 4672 616d 6522 0a20 2020 2020 2020  taFrame".       
-00014f40: 2020 2020 2061 7373 6572 7420 7369 6e67       assert sing
-00014f50: 6c65 5f76 6172 5b22 7661 6c75 6522 5d5b  le_var["value"][
-00014f60: 226d 756c 7469 5f76 616c 7565 225d 5b22  "multi_value"]["
-00014f70: 636f 6c75 6d6e 5f63 6f75 6e74 225d 203d  column_count"] =
-00014f80: 3d20 350a 2020 2020 2020 2020 2020 2020  = 5.            
-00014f90: 6173 7365 7274 2073 696e 676c 655f 7661  assert single_va
-00014fa0: 725b 2276 616c 7565 225d 5b22 6d75 6c74  r["value"]["mult
-00014fb0: 695f 7661 6c75 6522 5d5b 2272 6f77 5f63  i_value"]["row_c
-00014fc0: 6f75 6e74 225d 203d 3d20 3135 300a 2020  ount"] == 150.  
-00014fd0: 2020 2020 2020 2020 2020 6173 7365 7274            assert
-00014fe0: 2073 696e 676c 655f 7661 725b 2276 616c   single_var["val
-00014ff0: 7565 225d 5b22 6d75 6c74 695f 7661 6c75  ue"]["multi_valu
-00015000: 6522 5d5b 2263 6f6c 756d 6e5f 6e61 6d65  e"]["column_name
-00015010: 7322 5d20 3d3d 205b 0a20 2020 2020 2020  s"] == [.       
-00015020: 2020 2020 2020 2020 2073 7472 2869 2920           str(i) 
-00015030: 666f 7220 6920 696e 2072 616e 6765 2835  for i in range(5
-00015040: 290a 2020 2020 2020 2020 2020 2020 5d0a  ).            ].
-00015050: 2020 2020 2020 2020 2020 2020 6173 7365              asse
-00015060: 7274 2073 696e 676c 655f 7661 725b 2276  rt single_var["v
-00015070: 616c 7565 225d 5b22 6d75 6c74 695f 7661  alue"]["multi_va
-00015080: 6c75 6522 5d5b 2264 6174 6122 5d20 3d3d  lue"]["data"] ==
-00015090: 205b 0a20 2020 2020 2020 2020 2020 2020   [.             
-000150a0: 2020 205b 7374 7228 6920 2b20 6a29 2066     [str(i + j) f
-000150b0: 6f72 2069 2069 6e20 7261 6e67 6528 3529  or i in range(5)
-000150c0: 5d20 666f 7220 6a20 696e 2072 616e 6765  ] for j in range
-000150d0: 2831 3530 290a 2020 2020 2020 2020 2020  (150).          
-000150e0: 2020 5d0a 2020 2020 2020 2020 2020 2020    ].            
-000150f0: 6173 7365 7274 2073 696e 676c 655f 7661  assert single_va
-00015100: 725b 2273 756d 6d61 7279 225d 203d 3d20  r["summary"] == 
-00015110: 2253 697a 653a 2031 3530 7835 204d 656d  "Size: 150x5 Mem
-00015120: 6f72 793a 2035 2e39 3820 4b42 220a 2020  ory: 5.98 KB".  
-00015130: 2020 2020 2020 2020 2020 6173 7365 7274            assert
-00015140: 2073 696e 676c 655f 7661 725b 2261 6262   single_var["abb
-00015150: 7265 7669 6174 6564 225d 2069 7320 4661  reviated"] is Fa
-00015160: 6c73 650a 0a20 2020 2020 2020 2020 2020  lse..           
-00015170: 2023 2053 686f 756c 646e 2774 2068 6176   # Shouldn't hav
-00015180: 6520 6368 616e 6765 6420 616e 7974 6869  e changed anythi
-00015190: 6e67 2069 6e20 7468 6520 6375 7272 656e  ng in the curren
-000151a0: 7420 7661 7273 0a20 2020 2020 2020 2020  t vars.         
-000151b0: 2020 2072 6573 706f 6e73 6520 3d20 6177     response = aw
-000151c0: 6169 7420 636c 6965 6e74 2e67 6574 280a  ait client.get(.
-000151d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000151e0: 6622 2f6e 6f74 6562 6f6f 6b73 2f7b 7575  f"/notebooks/{uu
-000151f0: 6964 7d2f 7661 7273 222c 2068 6561 6465  id}/vars", heade
-00015200: 7273 3d73 7570 6572 7573 6572 5f74 6f6b  rs=superuser_tok
-00015210: 656e 5f68 6561 6465 7273 0a20 2020 2020  en_headers.     
-00015220: 2020 2020 2020 2029 0a20 2020 2020 2020         ).       
-00015230: 2020 2020 2061 7373 6572 7420 7265 7370       assert resp
-00015240: 6f6e 7365 2e73 7461 7475 735f 636f 6465  onse.status_code
-00015250: 203d 3d20 3230 300a 2020 2020 2020 2020   == 200.        
-00015260: 2020 2020 6375 7272 656e 745f 7661 7273      current_vars
-00015270: 203d 2072 6573 706f 6e73 652e 6a73 6f6e   = response.json
-00015280: 2829 5b22 7661 7273 225d 0a20 2020 2020  ()["vars"].     
-00015290: 2020 2020 2020 2063 7572 7265 6e74 5f76         current_v
-000152a0: 6172 7320 3d20 6669 6c74 6572 280a 2020  ars = filter(.  
-000152b0: 2020 2020 2020 2020 2020 2020 2020 6c61                la
-000152c0: 6d62 6461 2078 3a20 785b 226e 616d 6522  mbda x: x["name"
-000152d0: 5d20 213d 2022 5f5f 5f64 316f 7322 2c20  ] != "___d1os", 
-000152e0: 6375 7272 656e 745f 7661 7273 0a20 2020  current_vars.   
-000152f0: 2020 2020 2020 2020 2029 0a20 2020 2020           ).     
-00015300: 2020 2020 2020 2061 7373 6572 7420 6c69         assert li
-00015310: 7374 2863 7572 7265 6e74 5f76 6172 7329  st(current_vars)
-00015320: 203d 3d20 6461 7461 5b22 7661 7273 225d   == data["vars"]
-00015330: 0a0a 2020 2020 2020 2020 2020 2020 2320  ..            # 
-00015340: 5661 7220 7468 6174 2064 6f65 736e 2774  Var that doesn't
-00015350: 2065 7869 7374 0a20 2020 2020 2020 2020   exist.         
-00015360: 2020 2072 6573 706f 6e73 6520 3d20 6177     response = aw
-00015370: 6169 7420 636c 6965 6e74 2e67 6574 280a  ait client.get(.
-00015380: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00015390: 6622 2f6e 6f74 6562 6f6f 6b73 2f7b 7575  f"/notebooks/{uu
-000153a0: 6964 7d2f 7661 7273 2f64 6632 222c 2068  id}/vars/df2", h
-000153b0: 6561 6465 7273 3d73 7570 6572 7573 6572  eaders=superuser
-000153c0: 5f74 6f6b 656e 5f68 6561 6465 7273 0a20  _token_headers. 
-000153d0: 2020 2020 2020 2020 2020 2029 0a20 2020             ).   
-000153e0: 2020 2020 2020 2020 2061 7373 6572 7420           assert 
-000153f0: 7265 7370 6f6e 7365 2e73 7461 7475 735f  response.status_
-00015400: 636f 6465 203d 3d20 3430 340a 0a20 2020  code == 404..   
-00015410: 2040 7079 7465 7374 2e6d 6172 6b2e 6173   @pytest.mark.as
-00015420: 796e 6369 6f0a 2020 2020 6173 796e 6320  yncio.    async 
-00015430: 6465 6620 7465 7374 5f67 6574 5f73 696e  def test_get_sin
-00015440: 676c 655f 7661 725f 6465 7461 696c 5f72  gle_var_detail_r
-00015450: 5f6b 6572 6e65 6c28 0a20 2020 2020 2020  _kernel(.       
-00015460: 2073 656c 662c 2063 6c69 656e 743a 2054   self, client: T
-00015470: 6573 7443 6c69 656e 742c 2073 7570 6572  estClient, super
-00015480: 7573 6572 5f74 6f6b 656e 5f68 6561 6465  user_token_heade
-00015490: 7273 3a20 4469 6374 5b73 7472 2c20 7374  rs: Dict[str, st
-000154a0: 725d 0a20 2020 2029 3a0a 2020 2020 2020  r].    ):.      
-000154b0: 2020 2222 220a 2020 2020 2020 2020 5220    """.        R 
-000154c0: 4b65 726e 656c 206c 6172 6765 2064 6174  Kernel large dat
-000154d0: 6166 7261 6d65 2069 7320 6162 6272 6576  aframe is abbrev
-000154e0: 6961 7465 6420 696e 2073 756d 6d61 7279  iated in summary
-000154f0: 2c20 6e6f 7420 696e 2076 6172 6961 626c  , not in variabl
-00015500: 650a 2020 2020 2020 2020 6465 7461 696c  e.        detail
-00015510: 7320 7265 7175 6573 742e 0a20 2020 2020  s request..     
-00015520: 2020 2022 2222 0a20 2020 2020 2020 2075     """.        u
-00015530: 7569 6420 3d20 6177 6169 7420 7570 6c6f  uid = await uplo
-00015540: 6164 5f6e 6f74 6562 6f6f 6b28 0a20 2020  ad_notebook(.   
-00015550: 2020 2020 2020 2020 2063 6c69 656e 742c           client,
-00015560: 2073 7570 6572 7573 6572 5f74 6f6b 656e   superuser_token
-00015570: 5f68 6561 6465 7273 2c20 2273 696d 706c  _headers, "simpl
-00015580: 655f 722e 6970 796e 6222 0a20 2020 2020  e_r.ipynb".     
-00015590: 2020 2029 0a0a 2020 2020 2020 2020 2320     )..        # 
-000155a0: 6765 7420 616e 2065 7869 7374 696e 6720  get an existing 
-000155b0: 6365 6c6c 0a20 2020 2020 2020 2072 6573  cell.        res
-000155c0: 706f 6e73 6520 3d20 6177 6169 7420 636c  ponse = await cl
-000155d0: 6965 6e74 2e67 6574 280a 2020 2020 2020  ient.get(.      
-000155e0: 2020 2020 2020 6622 2f6e 6f74 6562 6f6f        f"/noteboo
-000155f0: 6b73 2f7b 7575 6964 7d2f 6365 6c6c 7322  ks/{uuid}/cells"
-00015600: 2c20 6865 6164 6572 733d 7375 7065 7275  , headers=superu
-00015610: 7365 725f 746f 6b65 6e5f 6865 6164 6572  ser_token_header
-00015620: 730a 2020 2020 2020 2020 290a 2020 2020  s.        ).    
-00015630: 2020 2020 6173 7365 7274 2072 6573 706f      assert respo
-00015640: 6e73 652e 7374 6174 7573 5f63 6f64 6520  nse.status_code 
-00015650: 3d3d 2032 3030 0a20 2020 2020 2020 2063  == 200.        c
-00015660: 656c 6c73 203d 2072 6573 706f 6e73 652e  ells = response.
-00015670: 6a73 6f6e 2829 5b22 6365 6c6c 7322 5d0a  json()["cells"].
-00015680: 2020 2020 2020 2020 6173 7365 7274 2063          assert c
-00015690: 656c 6c73 5b31 5d5b 2273 6f75 7263 6522  ells[1]["source"
-000156a0: 5d20 3d3d 2022 6620 3c2d 2035 3433 220a  ] == "f <- 543".
-000156b0: 0a20 2020 2020 2020 2063 656c 6c5f 7575  .        cell_uu
-000156c0: 6964 203d 2063 656c 6c73 5b31 5d5b 226d  id = cells[1]["m
-000156d0: 6574 6164 6174 6122 5d5b 226a 7570 7974  etadata"]["jupyt
-000156e0: 6572 5f64 3122 5d5b 2275 7569 6422 5d0a  er_d1"]["uuid"].
-000156f0: 0a20 2020 2020 2020 2070 6172 616d 7320  .        params 
-00015700: 3d20 7b22 736f 7572 6365 223a 2022 6b6f  = {"source": "ko
-00015710: 6f6c 203d 2064 6174 612e 6672 616d 6528  ol = data.frame(
-00015720: 636f 6c31 3d63 2831 3a31 3530 292c 2063  col1=c(1:150), c
-00015730: 6f6c 323d 6328 3135 303a 3129 2922 7d0a  ol2=c(150:1))"}.
-00015740: 2020 2020 2020 2020 7265 7370 6f6e 7365          response
-00015750: 203d 2061 7761 6974 2063 6c69 656e 742e   = await client.
-00015760: 7061 7463 6828 0a20 2020 2020 2020 2020  patch(.         
-00015770: 2020 2066 222f 6e6f 7465 626f 6f6b 732f     f"/notebooks/
-00015780: 7b75 7569 647d 2f63 656c 6c73 2f7b 6365  {uuid}/cells/{ce
-00015790: 6c6c 5f75 7569 647d 222c 0a20 2020 2020  ll_uuid}",.     
-000157a0: 2020 2020 2020 206a 736f 6e3d 7061 7261         json=para
-000157b0: 6d73 2c0a 2020 2020 2020 2020 2020 2020  ms,.            
-000157c0: 6865 6164 6572 733d 7375 7065 7275 7365  headers=superuse
-000157d0: 725f 746f 6b65 6e5f 6865 6164 6572 732c  r_token_headers,
-000157e0: 0a20 2020 2020 2020 2029 0a20 2020 2020  .        ).     
-000157f0: 2020 2061 7373 6572 7420 7265 7370 6f6e     assert respon
-00015800: 7365 2e73 7461 7475 735f 636f 6465 203d  se.status_code =
-00015810: 3d20 3230 300a 0a20 2020 2020 2020 2072  = 200..        r
-00015820: 6573 706f 6e73 6520 3d20 6177 6169 7420  esponse = await 
-00015830: 636c 6965 6e74 2e67 6574 280a 2020 2020  client.get(.    
-00015840: 2020 2020 2020 2020 6622 2f6e 6f74 6562          f"/noteb
-00015850: 6f6f 6b73 2f7b 7575 6964 7d2f 7661 7273  ooks/{uuid}/vars
-00015860: 222c 2068 6561 6465 7273 3d73 7570 6572  ", headers=super
-00015870: 7573 6572 5f74 6f6b 656e 5f68 6561 6465  user_token_heade
-00015880: 7273 0a20 2020 2020 2020 2029 0a20 2020  rs.        ).   
-00015890: 2020 2020 2061 7373 6572 7420 7265 7370       assert resp
-000158a0: 6f6e 7365 2e73 7461 7475 735f 636f 6465  onse.status_code
-000158b0: 203d 3d20 3230 300a 2020 2020 2020 2020   == 200.        
-000158c0: 6173 7365 7274 206c 656e 2872 6573 706f  assert len(respo
-000158d0: 6e73 652e 6a73 6f6e 2829 5b22 7661 7273  nse.json()["vars
-000158e0: 225d 2920 3d3d 2030 0a0a 2020 2020 2020  "]) == 0..      
-000158f0: 2020 6173 796e 6320 7769 7468 2063 6c69    async with cli
-00015900: 656e 742e 7765 6273 6f63 6b65 745f 636f  ent.websocket_co
-00015910: 6e6e 6563 7428 0a20 2020 2020 2020 2020  nnect(.         
-00015920: 2020 2066 222f 6e6f 7465 626f 6f6b 732f     f"/notebooks/
-00015930: 7b75 7569 647d 2f77 732f 6e6f 7465 626f  {uuid}/ws/notebo
-00015940: 6f6b 222c 2068 6561 6465 7273 3d73 7570  ok", headers=sup
-00015950: 6572 7573 6572 5f74 6f6b 656e 5f68 6561  eruser_token_hea
-00015960: 6465 7273 0a20 2020 2020 2020 2029 2061  ders.        ) a
-00015970: 7320 7765 6273 6f63 6b65 743a 0a20 2020  s websocket:.   
-00015980: 2020 2020 2020 2020 2061 7761 6974 2061           await a
-00015990: 7379 6e63 696f 2e73 6c65 6570 2857 4542  syncio.sleep(WEB
-000159a0: 534f 434b 4554 5f53 4c45 4550 5f54 494d  SOCKET_SLEEP_TIM
-000159b0: 4529 0a0a 2020 2020 2020 2020 2020 2020  E)..            
-000159c0: 7265 7370 6f6e 7365 203d 2061 7761 6974  response = await
-000159d0: 2063 6c69 656e 742e 6765 7428 0a20 2020   client.get(.   
-000159e0: 2020 2020 2020 2020 2020 2020 2066 222f               f"/
-000159f0: 6e6f 7465 626f 6f6b 732f 7b75 7569 647d  notebooks/{uuid}
-00015a00: 2f63 656c 6c73 2f7b 6365 6c6c 5f75 7569  /cells/{cell_uui
-00015a10: 647d 2f65 7865 6375 7465 222c 0a20 2020  d}/execute",.   
-00015a20: 2020 2020 2020 2020 2020 2020 2068 6561               hea
-00015a30: 6465 7273 3d73 7570 6572 7573 6572 5f74  ders=superuser_t
-00015a40: 6f6b 656e 5f68 6561 6465 7273 2c0a 2020  oken_headers,.  
-00015a50: 2020 2020 2020 2020 2020 290a 2020 2020            ).    
-00015a60: 2020 2020 2020 2020 6173 7365 7274 2072          assert r
-00015a70: 6573 706f 6e73 652e 7374 6174 7573 5f63  esponse.status_c
-00015a80: 6f64 6520 3d3d 2032 3030 0a0a 2020 2020  ode == 200..    
-00015a90: 2020 2020 2020 2020 2320 4b65 726e 656c          # Kernel
-00015aa0: 2076 6172 7320 7570 6461 7465 0a20 2020   vars update.   
-00015ab0: 2020 2020 2020 2020 2064 6174 6120 3d20           data = 
-00015ac0: 6177 6169 7420 7265 6365 6976 655f 6a73  await receive_js
-00015ad0: 6f6e 2877 6562 736f 636b 6574 2c20 6d73  on(websocket, ms
-00015ae0: 675f 7479 7065 733d 5b22 7661 7273 225d  g_types=["vars"]
-00015af0: 290a 2020 2020 2020 2020 2020 2020 7661  ).            va
-00015b00: 7273 203d 207b 7661 725b 226e 616d 6522  rs = {var["name"
-00015b10: 5d3a 2076 6172 2066 6f72 2076 6172 2069  ]: var for var i
-00015b20: 6e20 6461 7461 5b22 7661 7273 225d 7d0a  n data["vars"]}.
-00015b30: 0a20 2020 2020 2020 2020 2020 2061 7373  .            ass
-00015b40: 6572 7420 7661 7273 5b22 6b6f 6f6c 225d  ert vars["kool"]
-00015b50: 5b22 7479 7065 225d 203d 3d20 2264 6174  ["type"] == "dat
-00015b60: 612e 6672 616d 6522 0a20 2020 2020 2020  a.frame".       
-00015b70: 2020 2020 2061 7373 6572 7420 7661 7273       assert vars
-00015b80: 5b22 6b6f 6f6c 225d 5b22 7661 6c75 6522  ["kool"]["value"
-00015b90: 5d5b 226d 756c 7469 5f76 616c 7565 225d  ]["multi_value"]
-00015ba0: 5b22 636f 6c75 6d6e 5f63 6f75 6e74 225d  ["column_count"]
-00015bb0: 203d 3d20 320a 2020 2020 2020 2020 2020   == 2.          
-00015bc0: 2020 6173 7365 7274 2076 6172 735b 226b    assert vars["k
-00015bd0: 6f6f 6c22 5d5b 2276 616c 7565 225d 5b22  ool"]["value"]["
-00015be0: 6d75 6c74 695f 7661 6c75 6522 5d5b 2272  multi_value"]["r
-00015bf0: 6f77 5f63 6f75 6e74 225d 203d 3d20 3135  ow_count"] == 15
-00015c00: 300a 2020 2020 2020 2020 2020 2020 6173  0.            as
-00015c10: 7365 7274 2076 6172 735b 226b 6f6f 6c22  sert vars["kool"
-00015c20: 5d5b 2276 616c 7565 225d 5b22 6d75 6c74  ]["value"]["mult
-00015c30: 695f 7661 6c75 6522 5d5b 2263 6f6c 756d  i_value"]["colum
-00015c40: 6e5f 6e61 6d65 7322 5d20 3d3d 205b 0a20  n_names"] == [. 
-00015c50: 2020 2020 2020 2020 2020 2020 2020 2022                 "
-00015c60: 636f 6c31 2028 696e 7465 6765 7229 222c  col1 (integer)",
-00015c70: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00015c80: 2022 636f 6c32 2028 696e 7465 6765 7229   "col2 (integer)
-00015c90: 222c 0a20 2020 2020 2020 2020 2020 205d  ",.            ]
-00015ca0: 0a20 2020 2020 2020 2020 2020 2061 7373  .            ass
-00015cb0: 6572 7420 7661 7273 5b22 6b6f 6f6c 225d  ert vars["kool"]
-00015cc0: 5b22 7661 6c75 6522 5d5b 226d 756c 7469  ["value"]["multi
-00015cd0: 5f76 616c 7565 225d 5b22 6461 7461 225d  _value"]["data"]
-00015ce0: 203d 3d20 5b0a 2020 2020 2020 2020 2020   == [.          
-00015cf0: 2020 2020 2020 5b73 7472 2869 202b 2031        [str(i + 1
-00015d00: 292c 2073 7472 2831 3530 202d 2069 295d  ), str(150 - i)]
-00015d10: 2066 6f72 2069 2069 6e20 7261 6e67 6528   for i in range(
-00015d20: 3235 290a 2020 2020 2020 2020 2020 2020  25).            
-00015d30: 5d0a 2020 2020 2020 2020 2020 2020 6173  ].            as
-00015d40: 7365 7274 2022 5369 7a65 3a20 3135 3078  sert "Size: 150x
-00015d50: 3220 4d65 6d6f 7279 3a22 2069 6e20 7661  2 Memory:" in va
-00015d60: 7273 5b22 6b6f 6f6c 225d 5b22 7375 6d6d  rs["kool"]["summ
-00015d70: 6172 7922 5d0a 2020 2020 2020 2020 2020  ary"].          
-00015d80: 2020 6173 7365 7274 2076 6172 735b 226b    assert vars["k
-00015d90: 6f6f 6c22 5d5b 2261 6262 7265 7669 6174  ool"]["abbreviat
-00015da0: 6564 225d 2069 7320 5472 7565 0a0a 2020  ed"] is True..  
-00015db0: 2020 2020 2020 2020 2020 7265 7370 6f6e            respon
-00015dc0: 7365 203d 2061 7761 6974 2063 6c69 656e  se = await clien
-00015dd0: 742e 6765 7428 0a20 2020 2020 2020 2020  t.get(.         
-00015de0: 2020 2020 2020 2066 222f 6e6f 7465 626f         f"/notebo
-00015df0: 6f6b 732f 7b75 7569 647d 2f76 6172 7322  oks/{uuid}/vars"
-00015e00: 2c20 6865 6164 6572 733d 7375 7065 7275  , headers=superu
-00015e10: 7365 725f 746f 6b65 6e5f 6865 6164 6572  ser_token_header
-00015e20: 730a 2020 2020 2020 2020 2020 2020 290a  s.            ).
-00015e30: 2020 2020 2020 2020 2020 2020 6173 7365              asse
-00015e40: 7274 2072 6573 706f 6e73 652e 7374 6174  rt response.stat
-00015e50: 7573 5f63 6f64 6520 3d3d 2032 3030 0a20  us_code == 200. 
-00015e60: 2020 2020 2020 2020 2020 2063 7572 7265             curre
-00015e70: 6e74 5f76 6172 7320 3d20 7265 7370 6f6e  nt_vars = respon
-00015e80: 7365 2e6a 736f 6e28 295b 2276 6172 7322  se.json()["vars"
-00015e90: 5d0a 2020 2020 2020 2020 2020 2020 6173  ].            as
-00015ea0: 7365 7274 206c 6973 7428 6375 7272 656e  sert list(curren
-00015eb0: 745f 7661 7273 2920 3d3d 2064 6174 615b  t_vars) == data[
-00015ec0: 2276 6172 7322 5d0a 0a20 2020 2020 2020  "vars"]..       
-00015ed0: 2020 2020 2072 6573 706f 6e73 6520 3d20       response = 
-00015ee0: 6177 6169 7420 636c 6965 6e74 2e67 6574  await client.get
-00015ef0: 280a 2020 2020 2020 2020 2020 2020 2020  (.              
-00015f00: 2020 6622 2f6e 6f74 6562 6f6f 6b73 2f7b    f"/notebooks/{
-00015f10: 7575 6964 7d2f 7661 7273 2f6b 6f6f 6c22  uuid}/vars/kool"
-00015f20: 2c20 6865 6164 6572 733d 7375 7065 7275  , headers=superu
-00015f30: 7365 725f 746f 6b65 6e5f 6865 6164 6572  ser_token_header
-00015f40: 730a 2020 2020 2020 2020 2020 2020 290a  s.            ).
-00015f50: 2020 2020 2020 2020 2020 2020 6173 7365              asse
-00015f60: 7274 2072 6573 706f 6e73 652e 7374 6174  rt response.stat
-00015f70: 7573 5f63 6f64 6520 3d3d 2032 3030 0a20  us_code == 200. 
-00015f80: 2020 2020 2020 2020 2020 2073 696e 676c             singl
-00015f90: 655f 7661 7220 3d20 7265 7370 6f6e 7365  e_var = response
-00015fa0: 2e6a 736f 6e28 295b 2273 696e 676c 655f  .json()["single_
-00015fb0: 7661 7222 5d0a 2020 2020 2020 2020 2020  var"].          
-00015fc0: 2020 6173 7365 7274 2073 696e 676c 655f    assert single_
-00015fd0: 7661 725b 226e 616d 6522 5d20 3d3d 2022  var["name"] == "
-00015fe0: 6b6f 6f6c 220a 2020 2020 2020 2020 2020  kool".          
-00015ff0: 2020 6173 7365 7274 2073 696e 676c 655f    assert single_
-00016000: 7661 725b 2274 7970 6522 5d20 3d3d 2022  var["type"] == "
-00016010: 6461 7461 2e66 7261 6d65 220a 2020 2020  data.frame".    
-00016020: 2020 2020 2020 2020 6173 7365 7274 2073          assert s
-00016030: 696e 676c 655f 7661 725b 2276 616c 7565  ingle_var["value
-00016040: 225d 5b22 6d75 6c74 695f 7661 6c75 6522  "]["multi_value"
-00016050: 5d5b 2263 6f6c 756d 6e5f 636f 756e 7422  ]["column_count"
-00016060: 5d20 3d3d 2032 0a20 2020 2020 2020 2020  ] == 2.         
-00016070: 2020 2061 7373 6572 7420 7369 6e67 6c65     assert single
-00016080: 5f76 6172 5b22 7661 6c75 6522 5d5b 226d  _var["value"]["m
-00016090: 756c 7469 5f76 616c 7565 225d 5b22 726f  ulti_value"]["ro
-000160a0: 775f 636f 756e 7422 5d20 3d3d 2031 3530  w_count"] == 150
-000160b0: 0a20 2020 2020 2020 2020 2020 2061 7373  .            ass
-000160c0: 6572 7420 7369 6e67 6c65 5f76 6172 5b22  ert single_var["
-000160d0: 7661 6c75 6522 5d5b 226d 756c 7469 5f76  value"]["multi_v
-000160e0: 616c 7565 225d 5b22 636f 6c75 6d6e 5f6e  alue"]["column_n
-000160f0: 616d 6573 225d 203d 3d20 5b0a 2020 2020  ames"] == [.    
-00016100: 2020 2020 2020 2020 2020 2020 2263 6f6c              "col
-00016110: 3120 2869 6e74 6567 6572 2922 2c0a 2020  1 (integer)",.  
-00016120: 2020 2020 2020 2020 2020 2020 2020 2263                "c
-00016130: 6f6c 3220 2869 6e74 6567 6572 2922 2c0a  ol2 (integer)",.
-00016140: 2020 2020 2020 2020 2020 2020 5d0a 2020              ].  
-00016150: 2020 2020 2020 2020 2020 6173 7365 7274            assert
-00016160: 2073 696e 676c 655f 7661 725b 2276 616c   single_var["val
-00016170: 7565 225d 5b22 6d75 6c74 695f 7661 6c75  ue"]["multi_valu
-00016180: 6522 5d5b 2264 6174 6122 5d20 3d3d 205b  e"]["data"] == [
-00016190: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-000161a0: 205b 7374 7228 6920 2b20 3129 2c20 7374   [str(i + 1), st
-000161b0: 7228 3135 3020 2d20 6929 5d20 666f 7220  r(150 - i)] for 
-000161c0: 6920 696e 2072 616e 6765 2831 3530 290a  i in range(150).
-000161d0: 2020 2020 2020 2020 2020 2020 5d0a 2020              ].  
-000161e0: 2020 2020 2020 2020 2020 6173 7365 7274            assert
-000161f0: 2022 5369 7a65 3a20 3135 3078 3220 4d65   "Size: 150x2 Me
-00016200: 6d6f 7279 3a22 2069 6e20 7369 6e67 6c65  mory:" in single
-00016210: 5f76 6172 5b22 7375 6d6d 6172 7922 5d0a  _var["summary"].
-00016220: 2020 2020 2020 2020 2020 2020 6173 7365              asse
-00016230: 7274 2073 696e 676c 655f 7661 725b 2261  rt single_var["a
-00016240: 6262 7265 7669 6174 6564 225d 2069 7320  bbreviated"] is 
-00016250: 4661 6c73 650a 0a20 2020 2020 2020 2020  False..         
-00016260: 2020 2023 2053 686f 756c 646e 2774 2068     # Shouldn't h
-00016270: 6176 6520 6368 616e 6765 6420 616e 7974  ave changed anyt
-00016280: 6869 6e67 2069 6e20 7468 6520 6375 7272  hing in the curr
-00016290: 656e 7420 7661 7273 0a20 2020 2020 2020  ent vars.       
-000162a0: 2020 2020 2072 6573 706f 6e73 6520 3d20       response = 
-000162b0: 6177 6169 7420 636c 6965 6e74 2e67 6574  await client.get
-000162c0: 280a 2020 2020 2020 2020 2020 2020 2020  (.              
-000162d0: 2020 6622 2f6e 6f74 6562 6f6f 6b73 2f7b    f"/notebooks/{
-000162e0: 7575 6964 7d2f 7661 7273 222c 2068 6561  uuid}/vars", hea
-000162f0: 6465 7273 3d73 7570 6572 7573 6572 5f74  ders=superuser_t
-00016300: 6f6b 656e 5f68 6561 6465 7273 0a20 2020  oken_headers.   
-00016310: 2020 2020 2020 2020 2029 0a20 2020 2020           ).     
-00016320: 2020 2020 2020 2061 7373 6572 7420 7265         assert re
-00016330: 7370 6f6e 7365 2e73 7461 7475 735f 636f  sponse.status_co
-00016340: 6465 203d 3d20 3230 300a 2020 2020 2020  de == 200.      
-00016350: 2020 2020 2020 6375 7272 656e 745f 7661        current_va
-00016360: 7273 203d 2072 6573 706f 6e73 652e 6a73  rs = response.js
-00016370: 6f6e 2829 5b22 7661 7273 225d 0a20 2020  on()["vars"].   
-00016380: 2020 2020 2020 2020 2061 7373 6572 7420           assert 
-00016390: 6c69 7374 2863 7572 7265 6e74 5f76 6172  list(current_var
-000163a0: 7329 203d 3d20 6461 7461 5b22 7661 7273  s) == data["vars
-000163b0: 225d 0a0a 2020 2020 2020 2020 2020 2020  "]..            
-000163c0: 2320 5661 7220 7468 6174 2064 6f65 736e  # Var that doesn
-000163d0: 2774 2065 7869 7374 0a20 2020 2020 2020  't exist.       
-000163e0: 2020 2020 2072 6573 706f 6e73 6520 3d20       response = 
-000163f0: 6177 6169 7420 636c 6965 6e74 2e67 6574  await client.get
-00016400: 280a 2020 2020 2020 2020 2020 2020 2020  (.              
-00016410: 2020 6622 2f6e 6f74 6562 6f6f 6b73 2f7b    f"/notebooks/{
-00016420: 7575 6964 7d2f 7661 7273 2f64 6632 222c  uuid}/vars/df2",
-00016430: 2068 6561 6465 7273 3d73 7570 6572 7573   headers=superus
-00016440: 6572 5f74 6f6b 656e 5f68 6561 6465 7273  er_token_headers
-00016450: 0a20 2020 2020 2020 2020 2020 2029 0a20  .            ). 
-00016460: 2020 2020 2020 2020 2020 2061 7373 6572             asser
-00016470: 7420 7265 7370 6f6e 7365 2e73 7461 7475  t response.statu
-00016480: 735f 636f 6465 203d 3d20 3430 340a 0a0a  s_code == 404...
-00016490: 4070 7974 6573 742e 6d61 726b 2e75 7365  @pytest.mark.use
-000164a0: 6669 7874 7572 6573 2822 636c 6561 725f  fixtures("clear_
-000164b0: 6e6f 7465 626f 6f6b 7322 2c20 2263 6c65  notebooks", "cle
-000164c0: 6172 5f6e 6f74 6562 6f6f 6b5f 6469 7265  ar_notebook_dire
-000164d0: 6374 6f72 7922 290a 636c 6173 7320 5465  ctory").class Te
-000164e0: 7374 576f 726b 696e 6744 6972 6563 746f  stWorkingDirecto
-000164f0: 7279 3a0a 2020 2020 6173 796e 6320 6465  ry:.    async de
-00016500: 6620 6173 7365 7274 5f70 7974 686f 6e5f  f assert_python_
-00016510: 776f 726b 696e 675f 6469 7265 6374 6f72  working_director
-00016520: 7928 0a20 2020 2020 2020 2073 656c 662c  y(.        self,
-00016530: 0a20 2020 2020 2020 2063 6c69 656e 743a  .        client:
-00016540: 2054 6573 7443 6c69 656e 742c 0a20 2020   TestClient,.   
-00016550: 2020 2020 2073 7570 6572 7573 6572 5f74       superuser_t
-00016560: 6f6b 656e 5f68 6561 6465 7273 3a20 4469  oken_headers: Di
-00016570: 6374 5b73 7472 2c20 7374 725d 2c0a 2020  ct[str, str],.  
-00016580: 2020 2020 2020 6f70 656e 5f70 6174 683a        open_path:
-00016590: 2073 7472 2c0a 2020 2020 2020 2020 776f   str,.        wo
-000165a0: 726b 696e 675f 6469 7265 6374 6f72 793a  rking_directory:
-000165b0: 2073 7472 2c0a 2020 2020 2020 2020 7175   str,.        qu
-000165c0: 6572 795f 7374 7269 6e67 3a20 4f70 7469  ery_string: Opti
-000165d0: 6f6e 616c 5b44 6963 745b 7374 722c 2041  onal[Dict[str, A
-000165e0: 6e79 5d5d 203d 204e 6f6e 652c 0a20 2020  ny]] = None,.   
-000165f0: 2029 3a0a 2020 2020 2020 2020 2222 2254   ):.        """T
-00016600: 6573 7420 7468 6174 2070 7974 686f 6e20  est that python 
-00016610: 6b65 726e 656c 2069 7320 7374 6172 7465  kernel is starte
-00016620: 6420 696e 2063 6f72 7265 6374 2064 6972  d in correct dir
-00016630: 6563 746f 7279 2e22 2222 0a20 2020 2020  ectory.""".     
-00016640: 2020 2069 6620 7175 6572 795f 7374 7269     if query_stri
-00016650: 6e67 2069 7320 4e6f 6e65 3a0a 2020 2020  ng is None:.    
-00016660: 2020 2020 2020 2020 7175 6572 795f 7374          query_st
-00016670: 7269 6e67 203d 207b 7d0a 2020 2020 2020  ring = {}.      
-00016680: 2020 7175 6572 795f 7374 7269 6e67 5b22    query_string["
-00016690: 6669 6c65 7061 7468 225d 203d 206f 7065  filepath"] = ope
-000166a0: 6e5f 7061 7468 0a20 2020 2020 2020 2072  n_path.        r
-000166b0: 6573 706f 6e73 6520 3d20 6177 6169 7420  esponse = await 
-000166c0: 636c 6965 6e74 2e67 6574 280a 2020 2020  client.get(.    
-000166d0: 2020 2020 2020 2020 6622 2f6e 6f74 6562          f"/noteb
-000166e0: 6f6f 6b73 2f6f 7065 6e2f 222c 0a20 2020  ooks/open/",.   
-000166f0: 2020 2020 2020 2020 2068 6561 6465 7273           headers
-00016700: 3d73 7570 6572 7573 6572 5f74 6f6b 656e  =superuser_token
-00016710: 5f68 6561 6465 7273 2c0a 2020 2020 2020  _headers,.      
-00016720: 2020 2020 2020 7175 6572 795f 7374 7269        query_stri
-00016730: 6e67 3d71 7565 7279 5f73 7472 696e 672c  ng=query_string,
-00016740: 0a20 2020 2020 2020 2029 0a20 2020 2020  .        ).     
-00016750: 2020 2061 7373 6572 7420 7265 7370 6f6e     assert respon
-00016760: 7365 2e73 7461 7475 735f 636f 6465 203d  se.status_code =
-00016770: 3d20 3230 310a 2020 2020 2020 2020 7265  = 201.        re
-00016780: 7370 5f6a 736f 6e20 3d20 7265 7370 6f6e  sp_json = respon
-00016790: 7365 2e6a 736f 6e28 295b 226e 6f74 6562  se.json()["noteb
-000167a0: 6f6f 6b22 5d0a 2020 2020 2020 2020 7575  ook"].        uu
-000167b0: 6964 203d 2072 6573 705f 6a73 6f6e 5b22  id = resp_json["
-000167c0: 6d65 7461 6461 7461 225d 5b22 6a75 7079  metadata"]["jupy
-000167d0: 7465 725f 6431 225d 5b22 7575 6964 225d  ter_d1"]["uuid"]
-000167e0: 0a0a 2020 2020 2020 2020 2320 2f74 6d70  ..        # /tmp
-000167f0: 2073 796d 6c69 6e6b 7320 746f 202f 7072   symlinks to /pr
-00016800: 6976 6174 652f 746d 7020 6f6e 206d 6163  ivate/tmp on mac
-00016810: 2c20 736f 2077 6520 7265 736f 6c76 650a  , so we resolve.
-00016820: 2020 2020 2020 2020 7265 736f 6c76 6564          resolved
-00016830: 5f77 6f72 6b5f 6469 7220 3d20 7374 7228  _work_dir = str(
-00016840: 7061 7468 6c69 622e 5061 7468 2877 6f72  pathlib.Path(wor
-00016850: 6b69 6e67 5f64 6972 6563 746f 7279 292e  king_directory).
-00016860: 7265 736f 6c76 6528 2929 0a0a 2020 2020  resolve())..    
-00016870: 2020 2020 6173 7365 7274 2028 0a20 2020      assert (.   
-00016880: 2020 2020 2020 2020 2072 6573 705f 6a73           resp_js
-00016890: 6f6e 5b22 6d65 7461 6461 7461 225d 5b22  on["metadata"]["
-000168a0: 6a75 7079 7465 725f 6431 225d 5b22 776f  jupyter_d1"]["wo
-000168b0: 726b 696e 675f 6469 7265 6374 6f72 7922  rking_directory"
-000168c0: 5d0a 2020 2020 2020 2020 2020 2020 3d3d  ].            ==
-000168d0: 2072 6573 6f6c 7665 645f 776f 726b 5f64   resolved_work_d
-000168e0: 6972 0a20 2020 2020 2020 2029 0a0a 2020  ir.        )..  
-000168f0: 2020 2020 2020 6173 796e 6320 7769 7468        async with
-00016900: 2063 6c69 656e 742e 7765 6273 6f63 6b65   client.websocke
-00016910: 745f 636f 6e6e 6563 7428 0a20 2020 2020  t_connect(.     
-00016920: 2020 2020 2020 2066 222f 6e6f 7465 626f         f"/notebo
-00016930: 6f6b 732f 7b75 7569 647d 2f77 732f 6e6f  oks/{uuid}/ws/no
-00016940: 7465 626f 6f6b 222c 2068 6561 6465 7273  tebook", headers
-00016950: 3d73 7570 6572 7573 6572 5f74 6f6b 656e  =superuser_token
-00016960: 5f68 6561 6465 7273 0a20 2020 2020 2020  _headers.       
-00016970: 2029 2061 7320 7765 6273 6f63 6b65 743a   ) as websocket:
-00016980: 0a20 2020 2020 2020 2020 2020 2061 7761  .            awa
-00016990: 6974 2061 7379 6e63 696f 2e73 6c65 6570  it asyncio.sleep
-000169a0: 2857 4542 534f 434b 4554 5f53 4c45 4550  (WEBSOCKET_SLEEP
-000169b0: 5f54 494d 4529 0a0a 2020 2020 2020 2020  _TIME)..        
-000169c0: 2020 2020 7265 7370 6f6e 7365 203d 2061      response = a
-000169d0: 7761 6974 2063 6c69 656e 742e 706f 7374  wait client.post
-000169e0: 280a 2020 2020 2020 2020 2020 2020 2020  (.              
-000169f0: 2020 6622 2f6e 6f74 6562 6f6f 6b73 2f7b    f"/notebooks/{
-00016a00: 7575 6964 7d2f 7363 7261 7463 685f 6578  uuid}/scratch_ex
-00016a10: 6563 7574 6522 2c0a 2020 2020 2020 2020  ecute",.        
-00016a20: 2020 2020 2020 2020 6865 6164 6572 733d          headers=
-00016a30: 7375 7065 7275 7365 725f 746f 6b65 6e5f  superuser_token_
-00016a40: 6865 6164 6572 732c 0a20 2020 2020 2020  headers,.       
-00016a50: 2020 2020 2020 2020 206a 736f 6e3d 7b22           json={"
-00016a60: 636f 6465 223a 2022 696d 706f 7274 206f  code": "import o
-00016a70: 735c 6e6f 732e 6765 7463 7764 2829 227d  s\nos.getcwd()"}
-00016a80: 2c0a 2020 2020 2020 2020 2020 2020 290a  ,.            ).
-00016a90: 2020 2020 2020 2020 2020 2020 6173 7365              asse
-00016aa0: 7274 2072 6573 706f 6e73 652e 7374 6174  rt response.stat
-00016ab0: 7573 5f63 6f64 6520 3d3d 2032 3030 0a20  us_code == 200. 
-00016ac0: 2020 2020 2020 2020 2020 206d 6573 7361             messa
-00016ad0: 6765 5f69 6420 3d20 7265 7370 6f6e 7365  ge_id = response
-00016ae0: 2e6a 736f 6e28 295b 226b 6572 6e65 6c5f  .json()["kernel_
-00016af0: 6d65 7373 6167 6522 5d5b 226d 6573 7361  message"]["messa
-00016b00: 6765 5f69 6422 5d0a 0a20 2020 2020 2020  ge_id"]..       
-00016b10: 2020 2020 2023 2066 6972 7374 2063 6875       # first chu
-00016b20: 6e6b 2072 6563 6569 7665 6420 7368 6f75  nk received shou
-00016b30: 6c64 2062 6520 6120 7363 7261 7463 685f  ld be a scratch_
-00016b40: 7570 6461 7465 2077 6974 680a 2020 2020  update with.    
-00016b50: 2020 2020 2020 2020 2320 616e 2065 7865          # an exe
-00016b60: 6375 7469 6f6e 5f73 7461 7465 206f 6620  cution_state of 
-00016b70: 2762 7573 7927 2077 6865 6e20 7072 6f63  'busy' when proc
-00016b80: 6573 7369 6e67 2073 7461 7274 730a 2020  essing starts.  
-00016b90: 2020 2020 2020 2020 2020 6461 7461 203d            data =
-00016ba0: 2061 7761 6974 2072 6563 6569 7665 5f6a   await receive_j
-00016bb0: 736f 6e28 7765 6273 6f63 6b65 742c 206d  son(websocket, m
-00016bc0: 7367 5f74 7970 6573 3d5b 2273 6372 6174  sg_types=["scrat
-00016bd0: 6368 5f75 7064 6174 6522 5d29 0a20 2020  ch_update"]).   
-00016be0: 2020 2020 2020 2020 2073 6372 6174 6368           scratch
-00016bf0: 5f75 7064 6174 6520 3d20 6461 7461 5b22  _update = data["
-00016c00: 7363 7261 7463 685f 7570 6461 7465 225d  scratch_update"]
-00016c10: 0a20 2020 2020 2020 2020 2020 2061 7373  .            ass
-00016c20: 6572 7420 7363 7261 7463 685f 7570 6461  ert scratch_upda
-00016c30: 7465 5b22 6d65 7373 6167 655f 6964 225d  te["message_id"]
-00016c40: 203d 3d20 6d65 7373 6167 655f 6964 0a20   == message_id. 
-00016c50: 2020 2020 2020 2020 2020 2061 7373 6572             asser
-00016c60: 7420 7363 7261 7463 685f 7570 6461 7465  t scratch_update
-00016c70: 5b22 6578 6563 7574 696f 6e5f 7374 6174  ["execution_stat
-00016c80: 6522 5d20 3d3d 2022 6275 7379 220a 0a20  e"] == "busy".. 
-00016c90: 2020 2020 2020 2020 2020 2023 2052 6563             # Rec
-00016ca0: 6569 7665 2073 6372 6174 6368 2065 7865  eive scratch exe
-00016cb0: 6375 7469 6f6e 206f 7574 7075 740a 2020  cution output.  
-00016cc0: 2020 2020 2020 2020 2020 6461 7461 203d            data =
-00016cd0: 2061 7761 6974 2072 6563 6569 7665 5f6a   await receive_j
-00016ce0: 736f 6e28 7765 6273 6f63 6b65 742c 206d  son(websocket, m
-00016cf0: 7367 5f74 7970 6573 3d5b 2273 6372 6174  sg_types=["scrat
-00016d00: 6368 5f75 7064 6174 6522 5d29 0a20 2020  ch_update"]).   
-00016d10: 2020 2020 2020 2020 2073 6372 6174 6368           scratch
-00016d20: 5f75 7064 6174 6520 3d20 6461 7461 5b22  _update = data["
-00016d30: 7363 7261 7463 685f 7570 6461 7465 225d  scratch_update"]
-00016d40: 0a0a 2020 2020 2020 2020 2020 2020 6578  ..            ex
-00016d50: 7065 6374 6564 5f6f 7574 7075 7420 3d20  pected_output = 
-00016d60: 7b0a 2020 2020 2020 2020 2020 2020 2020  {.              
-00016d70: 2020 2264 6174 6122 3a20 7b22 7465 7874    "data": {"text
-00016d80: 2f70 6c61 696e 223a 2066 2227 7b72 6573  /plain": f"'{res
-00016d90: 6f6c 7665 645f 776f 726b 5f64 6972 7d27  olved_work_dir}'
-00016da0: 227d 2c0a 2020 2020 2020 2020 2020 2020  "},.            
-00016db0: 2020 2020 2265 7865 6375 7469 6f6e 5f63      "execution_c
-00016dc0: 6f75 6e74 223a 2031 2c0a 2020 2020 2020  ount": 1,.      
-00016dd0: 2020 2020 2020 2020 2020 226d 6574 6164            "metad
-00016de0: 6174 6122 3a20 7b7d 2c0a 2020 2020 2020  ata": {},.      
-00016df0: 2020 2020 2020 2020 2020 226f 7574 7075            "outpu
-00016e00: 745f 7479 7065 223a 2022 6578 6563 7574  t_type": "execut
-00016e10: 655f 7265 7375 6c74 222c 0a20 2020 2020  e_result",.     
-00016e20: 2020 2020 2020 207d 0a20 2020 2020 2020         }.       
-00016e30: 2020 2020 2061 7373 6572 7420 7363 7261       assert scra
-00016e40: 7463 685f 7570 6461 7465 5b22 6f75 7470  tch_update["outp
-00016e50: 7574 225d 203d 3d20 6578 7065 6374 6564  ut"] == expected
-00016e60: 5f6f 7574 7075 740a 0a20 2020 2020 2020  _output..       
-00016e70: 2020 2020 2023 2053 6372 6174 6368 2065       # Scratch e
-00016e80: 7865 6375 7469 6f6e 2073 7461 7465 2073  xecution state s
-00016e90: 6574 2074 6f20 6964 6c65 0a20 2020 2020  et to idle.     
-00016ea0: 2020 2020 2020 2064 6174 6120 3d20 6177         data = aw
-00016eb0: 6169 7420 7265 6365 6976 655f 6a73 6f6e  ait receive_json
-00016ec0: 2877 6562 736f 636b 6574 2c20 6d73 675f  (websocket, msg_
-00016ed0: 7479 7065 733d 5b22 7363 7261 7463 685f  types=["scratch_
-00016ee0: 7570 6461 7465 225d 290a 2020 2020 2020  update"]).      
-00016ef0: 2020 2020 2020 7363 7261 7463 685f 7570        scratch_up
-00016f00: 6461 7465 203d 2064 6174 615b 2273 6372  date = data["scr
-00016f10: 6174 6368 5f75 7064 6174 6522 5d0a 2020  atch_update"].  
-00016f20: 2020 2020 2020 2020 2020 6173 7365 7274            assert
-00016f30: 2073 6372 6174 6368 5f75 7064 6174 655b   scratch_update[
-00016f40: 226d 6573 7361 6765 5f69 6422 5d20 3d3d  "message_id"] ==
-00016f50: 206d 6573 7361 6765 5f69 640a 2020 2020   message_id.    
-00016f60: 2020 2020 2020 2020 6173 7365 7274 2073          assert s
-00016f70: 6372 6174 6368 5f75 7064 6174 655b 2265  cratch_update["e
-00016f80: 7865 6375 7469 6f6e 5f73 7461 7465 225d  xecution_state"]
-00016f90: 203d 3d20 2269 646c 6522 0a0a 2020 2020   == "idle"..    
-00016fa0: 2020 2020 2020 2020 746f 6b65 6e20 3d20          token = 
-00016fb0: 6765 745f 7375 7065 7275 7365 725f 746f  get_superuser_to
-00016fc0: 6b65 6e28 290a 2020 2020 2020 2020 2020  ken().          
-00016fd0: 2020 6175 7468 203d 2062 6173 6536 342e    auth = base64.
-00016fe0: 6236 3465 6e63 6f64 6528 6622 7b74 6f6b  b64encode(f"{tok
-00016ff0: 656e 7d3a 222e 656e 636f 6465 2822 7574  en}:".encode("ut
-00017000: 662d 3822 2929 0a20 2020 2020 2020 2020  f-8")).         
-00017010: 2020 2072 6573 706f 6e73 6520 3d20 6177     response = aw
-00017020: 6169 7420 636c 6965 6e74 2e67 6574 280a  ait client.get(.
-00017030: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00017040: 6622 2f64 6176 7b72 6573 6f6c 7665 645f  f"/dav{resolved_
-00017050: 776f 726b 5f64 6972 7d22 2c0a 2020 2020  work_dir}",.    
-00017060: 2020 2020 2020 2020 2020 2020 6865 6164              head
-00017070: 6572 733d 7b22 4175 7468 6f72 697a 6174  ers={"Authorizat
-00017080: 696f 6e22 3a20 6622 4261 7369 6320 7b61  ion": f"Basic {a
-00017090: 7574 682e 6465 636f 6465 2827 7574 662d  uth.decode('utf-
-000170a0: 3827 297d 227d 2c0a 2020 2020 2020 2020  8')}"},.        
-000170b0: 2020 2020 290a 2020 2020 2020 2020 2020      ).          
-000170c0: 2020 6173 7365 7274 2072 6573 706f 6e73    assert respons
-000170d0: 652e 7374 6174 7573 5f63 6f64 6520 3d3d  e.status_code ==
-000170e0: 2032 3030 0a0a 2020 2020 4070 7974 6573   200..    @pytes
-000170f0: 742e 6d61 726b 2e61 7379 6e63 696f 0a20  t.mark.asyncio. 
-00017100: 2020 2061 7379 6e63 2064 6566 2074 6573     async def tes
-00017110: 745f 776f 726b 696e 675f 6469 7265 6374  t_working_direct
-00017120: 6f72 795f 7061 7373 6564 5f69 6e28 0a20  ory_passed_in(. 
-00017130: 2020 2020 2020 2073 656c 662c 2063 6c69         self, cli
-00017140: 656e 743a 2054 6573 7443 6c69 656e 742c  ent: TestClient,
-00017150: 2073 7570 6572 7573 6572 5f74 6f6b 656e   superuser_token
-00017160: 5f68 6561 6465 7273 3a20 4469 6374 5b73  _headers: Dict[s
-00017170: 7472 2c20 7374 725d 0a20 2020 2029 3a0a  tr, str].    ):.
-00017180: 2020 2020 2020 2020 2222 220a 2020 2020          """.    
-00017190: 2020 2020 4966 206e 6f74 6562 6f6f 6b20      If notebook 
-000171a0: 6973 206f 7065 6e65 6420 7769 7468 2077  is opened with w
-000171b0: 6f72 6b69 6e67 2064 6972 6563 746f 7279  orking directory
-000171c0: 2073 7065 6369 6669 6564 2c20 6d61 6b65   specified, make
-000171d0: 2073 7572 650a 2020 2020 2020 2020 7468   sure.        th
-000171e0: 6520 6b65 726e 656c 2069 7320 7275 6e6e  e kernel is runn
-000171f0: 696e 6720 696e 2074 6861 7420 6469 7265  ing in that dire
-00017200: 6374 6f72 792e 0a20 2020 2020 2020 2022  ctory..        "
-00017210: 2222 0a20 2020 2020 2020 2066 696c 656e  "".        filen
-00017220: 616d 6520 3d20 2273 696d 706c 652e 6970  ame = "simple.ip
-00017230: 796e 6222 0a20 2020 2020 2020 206e 625f  ynb".        nb_
-00017240: 6669 6c65 6e61 6d65 203d 2066 226a 7570  filename = f"jup
-00017250: 7974 6572 5f64 312f 7465 7374 732f 6e6f  yter_d1/tests/no
-00017260: 7465 626f 6f6b 732f 7b66 696c 656e 616d  tebooks/{filenam
-00017270: 657d 220a 2020 2020 2020 2020 6e62 5f6a  e}".        nb_j
-00017280: 736f 6e20 3d20 6f70 656e 286e 625f 6669  son = open(nb_fi
-00017290: 6c65 6e61 6d65 292e 7265 6164 2829 0a20  lename).read(). 
-000172a0: 2020 2020 2020 2072 6573 706f 6e73 6520         response 
-000172b0: 3d20 6177 6169 7420 636c 6965 6e74 2e70  = await client.p
-000172c0: 6f73 7428 0a20 2020 2020 2020 2020 2020  ost(.           
-000172d0: 2022 2f6e 6f74 6562 6f6f 6b73 2f75 706c   "/notebooks/upl
-000172e0: 6f61 6422 2c0a 2020 2020 2020 2020 2020  oad",.          
-000172f0: 2020 7175 6572 795f 7374 7269 6e67 3d7b    query_string={
-00017300: 2266 696c 656e 616d 6522 3a20 6669 6c65  "filename": file
-00017310: 6e61 6d65 7d2c 0a20 2020 2020 2020 2020  name},.         
-00017320: 2020 2064 6174 613d 6e62 5f6a 736f 6e2c     data=nb_json,
-00017330: 0a20 2020 2020 2020 2020 2020 2068 6561  .            hea
-00017340: 6465 7273 3d73 7570 6572 7573 6572 5f74  ders=superuser_t
-00017350: 6f6b 656e 5f68 6561 6465 7273 2c0a 2020  oken_headers,.  
-00017360: 2020 2020 2020 290a 2020 2020 2020 2020        ).        
-00017370: 6173 7365 7274 2072 6573 706f 6e73 652e  assert response.
-00017380: 7374 6174 7573 5f63 6f64 6520 3d3d 2032  status_code == 2
-00017390: 3031 0a20 2020 2020 2020 2061 7761 6974  01.        await
-000173a0: 2073 656c 662e 6173 7365 7274 5f70 7974   self.assert_pyt
-000173b0: 686f 6e5f 776f 726b 696e 675f 6469 7265  hon_working_dire
-000173c0: 6374 6f72 7928 0a20 2020 2020 2020 2020  ctory(.         
-000173d0: 2020 2063 6c69 656e 742c 0a20 2020 2020     client,.     
-000173e0: 2020 2020 2020 2073 7570 6572 7573 6572         superuser
-000173f0: 5f74 6f6b 656e 5f68 6561 6465 7273 2c0a  _token_headers,.
-00017400: 2020 2020 2020 2020 2020 2020 6f70 656e              open
-00017410: 5f70 6174 683d 6669 6c65 6e61 6d65 2c0a  _path=filename,.
-00017420: 2020 2020 2020 2020 2020 2020 776f 726b              work
-00017430: 696e 675f 6469 7265 6374 6f72 793d 6622  ing_directory=f"
-00017440: 7b6f 732e 6765 7463 7764 2829 7d2f 6a75  {os.getcwd()}/ju
-00017450: 7079 7465 725f 6431 2f74 6573 7473 2f6e  pyter_d1/tests/n
-00017460: 6f74 6562 6f6f 6b73 222c 0a20 2020 2020  otebooks",.     
-00017470: 2020 2020 2020 2071 7565 7279 5f73 7472         query_str
-00017480: 696e 673d 7b0a 2020 2020 2020 2020 2020  ing={.          
-00017490: 2020 2020 2020 2277 6f72 6b69 6e67 5f64        "working_d
-000174a0: 6972 6563 746f 7279 223a 2066 227b 6f73  irectory": f"{os
-000174b0: 2e67 6574 6377 6428 297d 2f6a 7570 7974  .getcwd()}/jupyt
-000174c0: 6572 5f64 3122 0a20 2020 2020 2020 2020  er_d1".         
-000174d0: 2020 2020 2020 2022 2f74 6573 7473 2f6e         "/tests/n
-000174e0: 6f74 6562 6f6f 6b73 220a 2020 2020 2020  otebooks".      
-000174f0: 2020 2020 2020 7d2c 0a20 2020 2020 2020        },.       
-00017500: 2029 0a0a 2020 2020 4070 7974 6573 742e   )..    @pytest.
-00017510: 6d61 726b 2e61 7379 6e63 696f 0a20 2020  mark.asyncio.   
-00017520: 2061 7379 6e63 2064 6566 2074 6573 745f   async def test_
-00017530: 6669 6c65 5f69 6e5f 6469 6666 6572 656e  file_in_differen
-00017540: 745f 776f 726b 696e 675f 6469 7265 6374  t_working_direct
-00017550: 6f72 7928 0a20 2020 2020 2020 2073 656c  ory(.        sel
-00017560: 662c 2063 6c69 656e 743a 2054 6573 7443  f, client: TestC
-00017570: 6c69 656e 742c 2073 7570 6572 7573 6572  lient, superuser
-00017580: 5f74 6f6b 656e 5f68 6561 6465 7273 3a20  _token_headers: 
-00017590: 4469 6374 5b73 7472 2c20 7374 725d 0a20  Dict[str, str]. 
-000175a0: 2020 2029 3a0a 2020 2020 2020 2020 2222     ):.        ""
-000175b0: 220a 2020 2020 2020 2020 4966 206e 6f74  ".        If not
-000175c0: 6562 6f6f 6b20 696e 2061 2064 6966 6665  ebook in a diffe
-000175d0: 7265 6e74 2064 6972 6563 746f 7279 2069  rent directory i
-000175e0: 7320 6f70 656e 6564 2c20 6d61 6b65 2073  s opened, make s
-000175f0: 7572 650a 2020 2020 2020 2020 7468 6520  ure.        the 
-00017600: 6b65 726e 656c 2069 7320 7275 6e6e 696e  kernel is runnin
-00017610: 6720 696e 2074 6861 7420 6469 7265 6374  g in that direct
-00017620: 6f72 792e 0a20 2020 2020 2020 2022 2222  ory..        """
-00017630: 0a20 2020 2020 2020 2073 6875 7469 6c2e  .        shutil.
-00017640: 636f 7079 6669 6c65 280a 2020 2020 2020  copyfile(.      
-00017650: 2020 2020 2020 226a 7570 7974 6572 5f64        "jupyter_d
-00017660: 312f 7465 7374 732f 6e6f 7465 626f 6f6b  1/tests/notebook
-00017670: 732f 7369 6d70 6c65 2e69 7079 6e62 222c  s/simple.ipynb",
-00017680: 0a20 2020 2020 2020 2020 2020 2022 6a75  .            "ju
-00017690: 7079 7465 725f 6431 2f74 6573 7473 2f6e  pyter_d1/tests/n
-000176a0: 6f74 6562 6f6f 6b73 2f73 696d 706c 655f  otebooks/simple_
-000176b0: 636f 7079 2e69 7079 6e62 222c 0a20 2020  copy.ipynb",.   
-000176c0: 2020 2020 2029 0a20 2020 2020 2020 2061       ).        a
-000176d0: 7761 6974 2073 656c 662e 6173 7365 7274  wait self.assert
-000176e0: 5f70 7974 686f 6e5f 776f 726b 696e 675f  _python_working_
-000176f0: 6469 7265 6374 6f72 7928 0a20 2020 2020  directory(.     
-00017700: 2020 2020 2020 2063 6c69 656e 742c 0a20         client,. 
-00017710: 2020 2020 2020 2020 2020 2073 7570 6572             super
-00017720: 7573 6572 5f74 6f6b 656e 5f68 6561 6465  user_token_heade
-00017730: 7273 2c0a 2020 2020 2020 2020 2020 2020  rs,.            
-00017740: 6f70 656e 5f70 6174 683d 6622 7b6f 732e  open_path=f"{os.
-00017750: 6765 7463 7764 2829 7d2f 6a75 7079 7465  getcwd()}/jupyte
-00017760: 725f 6431 2f74 6573 7473 2f22 0a20 2020  r_d1/tests/".   
-00017770: 2020 2020 2020 2020 2022 6e6f 7465 626f           "notebo
-00017780: 6f6b 732f 7369 6d70 6c65 5f63 6f70 792e  oks/simple_copy.
-00017790: 6970 796e 6222 2c0a 2020 2020 2020 2020  ipynb",.        
-000177a0: 2020 2020 776f 726b 696e 675f 6469 7265      working_dire
-000177b0: 6374 6f72 793d 6622 7b6f 732e 6765 7463  ctory=f"{os.getc
-000177c0: 7764 2829 7d2f 6a75 7079 7465 725f 6431  wd()}/jupyter_d1
-000177d0: 2f74 6573 7473 2f6e 6f74 6562 6f6f 6b73  /tests/notebooks
-000177e0: 222c 0a20 2020 2020 2020 2029 0a20 2020  ",.        ).   
-000177f0: 2020 2020 206f 732e 7265 6d6f 7665 2822       os.remove("
-00017800: 6a75 7079 7465 725f 6431 2f74 6573 7473  jupyter_d1/tests
-00017810: 2f6e 6f74 6562 6f6f 6b73 2f73 696d 706c  /notebooks/simpl
-00017820: 655f 636f 7079 2e69 7079 6e62 2229 0a0a  e_copy.ipynb")..
-00017830: 2020 2020 4070 7974 6573 742e 6d61 726b      @pytest.mark
-00017840: 2e61 7379 6e63 696f 0a20 2020 2061 7379  .asyncio.    asy
-00017850: 6e63 2064 6566 2074 6573 745f 6669 6c65  nc def test_file
-00017860: 5f69 6e5f 7061 7265 6e74 5f64 6972 6563  _in_parent_direc
-00017870: 746f 7279 5f6f 665f 776f 726b 696e 675f  tory_of_working_
-00017880: 6469 7265 6374 6f72 7928 0a20 2020 2020  directory(.     
-00017890: 2020 2073 656c 662c 2063 6c69 656e 743a     self, client:
-000178a0: 2054 6573 7443 6c69 656e 742c 2073 7570   TestClient, sup
-000178b0: 6572 7573 6572 5f74 6f6b 656e 5f68 6561  eruser_token_hea
-000178c0: 6465 7273 3a20 4469 6374 5b73 7472 2c20  ders: Dict[str, 
-000178d0: 7374 725d 0a20 2020 2029 3a0a 2020 2020  str].    ):.    
-000178e0: 2020 2020 2222 220a 2020 2020 2020 2020      """.        
-000178f0: 4966 206e 6f74 6562 6f6f 6b20 696e 2074  If notebook in t
-00017900: 6865 2070 6172 656e 7420 6469 7265 6374  he parent direct
-00017910: 6f72 7920 6f66 2074 6865 2073 6572 7665  ory of the serve
-00017920: 7227 7320 776f 726b 696e 6720 6469 7265  r's working dire
-00017930: 6374 6f72 790a 2020 2020 2020 2020 6973  ctory.        is
-00017940: 206f 7065 6e65 642c 206d 616b 6520 7375   opened, make su
-00017950: 7265 2074 6865 206b 6572 6e65 6c20 6973  re the kernel is
-00017960: 2072 756e 6e69 6e67 2069 6e20 7468 6174   running in that
-00017970: 2070 6172 656e 7420 6469 7265 6374 6f72   parent director
-00017980: 792e 0a20 2020 2020 2020 2022 2222 0a20  y..        """. 
-00017990: 2020 2020 2020 2073 6875 7469 6c2e 636f         shutil.co
-000179a0: 7079 6669 6c65 280a 2020 2020 2020 2020  pyfile(.        
-000179b0: 2020 2020 226a 7570 7974 6572 5f64 312f      "jupyter_d1/
-000179c0: 7465 7374 732f 6e6f 7465 626f 6f6b 732f  tests/notebooks/
-000179d0: 7369 6d70 6c65 2e69 7079 6e62 222c 0a20  simple.ipynb",. 
-000179e0: 2020 2020 2020 2020 2020 2066 222f 746d             f"/tm
-000179f0: 702f 7369 6d70 6c65 5f63 6f70 792e 6970  p/simple_copy.ip
-00017a00: 796e 6222 2c0a 2020 2020 2020 2020 290a  ynb",.        ).
-00017a10: 2020 2020 2020 2020 6177 6169 7420 7365          await se
-00017a20: 6c66 2e61 7373 6572 745f 7079 7468 6f6e  lf.assert_python
-00017a30: 5f77 6f72 6b69 6e67 5f64 6972 6563 746f  _working_directo
-00017a40: 7279 280a 2020 2020 2020 2020 2020 2020  ry(.            
-00017a50: 636c 6965 6e74 2c0a 2020 2020 2020 2020  client,.        
-00017a60: 2020 2020 7375 7065 7275 7365 725f 746f      superuser_to
-00017a70: 6b65 6e5f 6865 6164 6572 732c 0a20 2020  ken_headers,.   
-00017a80: 2020 2020 2020 2020 206f 7065 6e5f 7061           open_pa
-00017a90: 7468 3d66 222f 746d 702f 7369 6d70 6c65  th=f"/tmp/simple
-00017aa0: 5f63 6f70 792e 6970 796e 6222 2c0a 2020  _copy.ipynb",.  
-00017ab0: 2020 2020 2020 2020 2020 776f 726b 696e            workin
-00017ac0: 675f 6469 7265 6374 6f72 793d 6622 2f74  g_directory=f"/t
-00017ad0: 6d70 222c 0a20 2020 2020 2020 2029 0a20  mp",.        ). 
-00017ae0: 2020 2020 2020 206f 732e 7265 6d6f 7665         os.remove
-00017af0: 2822 2f74 6d70 2f73 696d 706c 655f 636f  ("/tmp/simple_co
-00017b00: 7079 2e69 7079 6e62 2229 0a0a 2020 2020  py.ipynb")..    
-00017b10: 4070 7974 6573 742e 6d61 726b 2e61 7379  @pytest.mark.asy
-00017b20: 6e63 696f 0a20 2020 2061 7379 6e63 2064  ncio.    async d
-00017b30: 6566 2074 6573 745f 6669 6c65 5f69 6e5f  ef test_file_in_
-00017b40: 7375 625f 6469 7265 6374 6f72 795f 6f66  sub_directory_of
-00017b50: 5f77 6f72 6b69 6e67 5f64 6972 6563 746f  _working_directo
-00017b60: 7279 280a 2020 2020 2020 2020 7365 6c66  ry(.        self
-00017b70: 2c20 636c 6965 6e74 3a20 5465 7374 436c  , client: TestCl
-00017b80: 6965 6e74 2c20 7375 7065 7275 7365 725f  ient, superuser_
-00017b90: 746f 6b65 6e5f 6865 6164 6572 733a 2044  token_headers: D
-00017ba0: 6963 745b 7374 722c 2073 7472 5d0a 2020  ict[str, str].  
-00017bb0: 2020 293a 0a20 2020 2020 2020 2022 2222    ):.        """
-00017bc0: 0a20 2020 2020 2020 2049 6620 6e6f 7465  .        If note
-00017bd0: 626f 6f6b 2069 6e20 6120 7375 6220 6469  book in a sub di
-00017be0: 7265 6374 6f72 7920 6f66 2074 6865 2073  rectory of the s
-00017bf0: 6572 7665 7227 7320 776f 726b 696e 6720  erver's working 
-00017c00: 6469 7265 6374 6f72 790a 2020 2020 2020  directory.      
-00017c10: 2020 6973 206f 7065 6e65 642c 206d 616b    is opened, mak
-00017c20: 6520 7375 7265 2074 6865 206b 6572 6e65  e sure the kerne
-00017c30: 6c20 6973 2072 756e 6e69 6e67 2069 6e20  l is running in 
-00017c40: 7468 6174 2073 7562 2064 6972 6563 746f  that sub directo
-00017c50: 7279 2e0a 2020 2020 2020 2020 2222 220a  ry..        """.
-00017c60: 2020 2020 2020 2020 7061 7468 6c69 622e          pathlib.
-00017c70: 5061 7468 2822 2f74 6d70 2f6a 7570 7974  Path("/tmp/jupyt
-00017c80: 6572 5f64 315f 7465 7374 2f73 6f6d 655f  er_d1_test/some_
-00017c90: 6e62 7322 292e 6d6b 6469 7228 6578 6973  nbs").mkdir(exis
-00017ca0: 745f 6f6b 3d54 7275 6529 0a20 2020 2020  t_ok=True).     
-00017cb0: 2020 2073 6875 7469 6c2e 636f 7079 6669     shutil.copyfi
-00017cc0: 6c65 280a 2020 2020 2020 2020 2020 2020  le(.            
-00017cd0: 226a 7570 7974 6572 5f64 312f 7465 7374  "jupyter_d1/test
-00017ce0: 732f 6e6f 7465 626f 6f6b 732f 7369 6d70  s/notebooks/simp
-00017cf0: 6c65 2e69 7079 6e62 222c 0a20 2020 2020  le.ipynb",.     
-00017d00: 2020 2020 2020 2066 222f 746d 702f 6a75         f"/tmp/ju
-00017d10: 7079 7465 725f 6431 5f74 6573 742f 736f  pyter_d1_test/so
-00017d20: 6d65 5f6e 6273 2f2f 7369 6d70 6c65 5f63  me_nbs//simple_c
-00017d30: 6f70 792e 6970 796e 6222 2c0a 2020 2020  opy.ipynb",.    
-00017d40: 2020 2020 290a 2020 2020 2020 2020 6177      ).        aw
-00017d50: 6169 7420 7365 6c66 2e61 7373 6572 745f  ait self.assert_
-00017d60: 7079 7468 6f6e 5f77 6f72 6b69 6e67 5f64  python_working_d
-00017d70: 6972 6563 746f 7279 280a 2020 2020 2020  irectory(.      
-00017d80: 2020 2020 2020 636c 6965 6e74 2c0a 2020        client,.  
-00017d90: 2020 2020 2020 2020 2020 7375 7065 7275            superu
-00017da0: 7365 725f 746f 6b65 6e5f 6865 6164 6572  ser_token_header
-00017db0: 732c 0a20 2020 2020 2020 2020 2020 206f  s,.            o
-00017dc0: 7065 6e5f 7061 7468 3d66 222f 746d 702f  pen_path=f"/tmp/
-00017dd0: 6a75 7079 7465 725f 6431 5f74 6573 742f  jupyter_d1_test/
-00017de0: 736f 6d65 5f6e 6273 2f73 696d 706c 655f  some_nbs/simple_
-00017df0: 636f 7079 2e69 7079 6e62 222c 0a20 2020  copy.ipynb",.   
-00017e00: 2020 2020 2020 2020 2077 6f72 6b69 6e67           working
-00017e10: 5f64 6972 6563 746f 7279 3d66 222f 746d  _directory=f"/tm
-00017e20: 702f 6a75 7079 7465 725f 6431 5f74 6573  p/jupyter_d1_tes
-00017e30: 742f 736f 6d65 5f6e 6273 222c 0a20 2020  t/some_nbs",.   
-00017e40: 2020 2020 2029 0a20 2020 2020 2020 2073       ).        s
-00017e50: 6875 7469 6c2e 726d 7472 6565 2822 2f74  hutil.rmtree("/t
-00017e60: 6d70 2f6a 7570 7974 6572 5f64 315f 7465  mp/jupyter_d1_te
-00017e70: 7374 2f73 6f6d 655f 6e62 7322 290a 0a20  st/some_nbs").. 
-00017e80: 2020 2040 7079 7465 7374 2e6d 6172 6b2e     @pytest.mark.
-00017e90: 6173 796e 6369 6f0a 2020 2020 6173 796e  asyncio.    asyn
-00017ea0: 6320 6465 6620 7465 7374 5f72 5f6b 6572  c def test_r_ker
-00017eb0: 6e65 6c5f 776f 726b 696e 675f 6469 7265  nel_working_dire
-00017ec0: 6374 6f72 795f 7061 7373 6564 5f69 6e28  ctory_passed_in(
-00017ed0: 0a20 2020 2020 2020 2073 656c 662c 2063  .        self, c
-00017ee0: 6c69 656e 743a 2054 6573 7443 6c69 656e  lient: TestClien
-00017ef0: 742c 2073 7570 6572 7573 6572 5f74 6f6b  t, superuser_tok
-00017f00: 656e 5f68 6561 6465 7273 3a20 4469 6374  en_headers: Dict
-00017f10: 5b73 7472 2c20 7374 725d 0a20 2020 2029  [str, str].    )
-00017f20: 3a0a 2020 2020 2020 2020 776f 726b 696e  :.        workin
-00017f30: 675f 6469 7265 6374 6f72 7920 3d20 222f  g_directory = "/
-00017f40: 746d 7022 0a20 2020 2020 2020 2072 6573  tmp".        res
-00017f50: 706f 6e73 6520 3d20 6177 6169 7420 636c  ponse = await cl
-00017f60: 6965 6e74 2e70 6f73 7428 0a20 2020 2020  ient.post(.     
-00017f70: 2020 2020 2020 2022 2f6e 6f74 6562 6f6f         "/noteboo
-00017f80: 6b73 2f63 7265 6174 6522 2c0a 2020 2020  ks/create",.    
-00017f90: 2020 2020 2020 2020 7175 6572 795f 7374          query_st
-00017fa0: 7269 6e67 3d7b 0a20 2020 2020 2020 2020  ring={.         
-00017fb0: 2020 2020 2020 2022 6b73 7065 635f 6e61         "kspec_na
-00017fc0: 6d65 223a 2022 6972 222c 0a20 2020 2020  me": "ir",.     
-00017fd0: 2020 2020 2020 2020 2020 2022 6669 6c65             "file
-00017fe0: 6e61 6d65 223a 2022 6865 7970 222c 0a20  name": "heyp",. 
-00017ff0: 2020 2020 2020 2020 2020 2020 2020 2022                 "
-00018000: 776f 726b 696e 675f 6469 7265 6374 6f72  working_director
-00018010: 7922 3a20 776f 726b 696e 675f 6469 7265  y": working_dire
-00018020: 6374 6f72 792c 0a20 2020 2020 2020 2020  ctory,.         
-00018030: 2020 207d 2c0a 2020 2020 2020 2020 2020     },.          
-00018040: 2020 6865 6164 6572 733d 7375 7065 7275    headers=superu
-00018050: 7365 725f 746f 6b65 6e5f 6865 6164 6572  ser_token_header
-00018060: 732c 0a20 2020 2020 2020 2029 0a20 2020  s,.        ).   
-00018070: 2020 2020 2061 7373 6572 7420 7265 7370       assert resp
-00018080: 6f6e 7365 2e73 7461 7475 735f 636f 6465  onse.status_code
-00018090: 203d 3d20 3230 310a 2020 2020 2020 2020   == 201.        
-000180a0: 7265 7370 5f6a 736f 6e20 3d20 7265 7370  resp_json = resp
-000180b0: 6f6e 7365 2e6a 736f 6e28 295b 226e 6f74  onse.json()["not
-000180c0: 6562 6f6f 6b22 5d0a 2020 2020 2020 2020  ebook"].        
-000180d0: 7575 6964 203d 2072 6573 705f 6a73 6f6e  uuid = resp_json
-000180e0: 5b22 6d65 7461 6461 7461 225d 5b22 6a75  ["metadata"]["ju
-000180f0: 7079 7465 725f 6431 225d 5b22 7575 6964  pyter_d1"]["uuid
-00018100: 225d 0a0a 2020 2020 2020 2020 6173 796e  "]..        asyn
-00018110: 6320 7769 7468 2063 6c69 656e 742e 7765  c with client.we
-00018120: 6273 6f63 6b65 745f 636f 6e6e 6563 7428  bsocket_connect(
-00018130: 0a20 2020 2020 2020 2020 2020 2066 222f  .            f"/
-00018140: 6e6f 7465 626f 6f6b 732f 7b75 7569 647d  notebooks/{uuid}
-00018150: 2f77 732f 6e6f 7465 626f 6f6b 222c 2068  /ws/notebook", h
-00018160: 6561 6465 7273 3d73 7570 6572 7573 6572  eaders=superuser
-00018170: 5f74 6f6b 656e 5f68 6561 6465 7273 0a20  _token_headers. 
-00018180: 2020 2020 2020 2029 2061 7320 7765 6273         ) as webs
-00018190: 6f63 6b65 743a 0a20 2020 2020 2020 2020  ocket:.         
-000181a0: 2020 2061 7761 6974 2061 7379 6e63 696f     await asyncio
-000181b0: 2e73 6c65 6570 2857 4542 534f 434b 4554  .sleep(WEBSOCKET
-000181c0: 5f53 4c45 4550 5f54 494d 4529 0a0a 2020  _SLEEP_TIME)..  
-000181d0: 2020 2020 2020 2020 2020 7265 7370 6f6e            respon
-000181e0: 7365 203d 2061 7761 6974 2063 6c69 656e  se = await clien
-000181f0: 742e 706f 7374 280a 2020 2020 2020 2020  t.post(.        
-00018200: 2020 2020 2020 2020 6622 2f6e 6f74 6562          f"/noteb
-00018210: 6f6f 6b73 2f7b 7575 6964 7d2f 7363 7261  ooks/{uuid}/scra
-00018220: 7463 685f 6578 6563 7574 6522 2c0a 2020  tch_execute",.  
-00018230: 2020 2020 2020 2020 2020 2020 2020 6865                he
-00018240: 6164 6572 733d 7375 7065 7275 7365 725f  aders=superuser_
-00018250: 746f 6b65 6e5f 6865 6164 6572 732c 0a20  token_headers,. 
-00018260: 2020 2020 2020 2020 2020 2020 2020 206a                 j
-00018270: 736f 6e3d 7b22 636f 6465 223a 2022 6765  son={"code": "ge
-00018280: 7477 6428 2922 7d2c 0a20 2020 2020 2020  twd()"},.       
-00018290: 2020 2020 2029 0a20 2020 2020 2020 2020       ).         
-000182a0: 2020 2061 7373 6572 7420 7265 7370 6f6e     assert respon
-000182b0: 7365 2e73 7461 7475 735f 636f 6465 203d  se.status_code =
-000182c0: 3d20 3230 300a 2020 2020 2020 2020 2020  = 200.          
-000182d0: 2020 6d65 7373 6167 655f 6964 203d 2072    message_id = r
-000182e0: 6573 706f 6e73 652e 6a73 6f6e 2829 5b22  esponse.json()["
-000182f0: 6b65 726e 656c 5f6d 6573 7361 6765 225d  kernel_message"]
-00018300: 5b22 6d65 7373 6167 655f 6964 225d 0a0a  ["message_id"]..
-00018310: 2020 2020 2020 2020 2020 2020 2320 6669              # fi
-00018320: 7273 7420 6368 756e 6b20 7265 6365 6976  rst chunk receiv
-00018330: 6564 2073 686f 756c 6420 6265 2061 2073  ed should be a s
-00018340: 6372 6174 6368 5f75 7064 6174 6520 7769  cratch_update wi
-00018350: 7468 0a20 2020 2020 2020 2020 2020 2023  th.            #
-00018360: 2061 6e20 6578 6563 7574 696f 6e5f 7374   an execution_st
-00018370: 6174 6520 6f66 2027 6275 7379 2720 7768  ate of 'busy' wh
-00018380: 656e 2070 726f 6365 7373 696e 6720 7374  en processing st
-00018390: 6172 7473 0a20 2020 2020 2020 2020 2020  arts.           
-000183a0: 2064 6174 6120 3d20 6177 6169 7420 7265   data = await re
-000183b0: 6365 6976 655f 6a73 6f6e 2877 6562 736f  ceive_json(webso
-000183c0: 636b 6574 2c20 6d73 675f 7479 7065 733d  cket, msg_types=
-000183d0: 5b22 7363 7261 7463 685f 7570 6461 7465  ["scratch_update
-000183e0: 225d 290a 2020 2020 2020 2020 2020 2020  "]).            
-000183f0: 7363 7261 7463 685f 7570 6461 7465 203d  scratch_update =
-00018400: 2064 6174 615b 2273 6372 6174 6368 5f75   data["scratch_u
-00018410: 7064 6174 6522 5d0a 2020 2020 2020 2020  pdate"].        
-00018420: 2020 2020 6173 7365 7274 2073 6372 6174      assert scrat
-00018430: 6368 5f75 7064 6174 655b 226d 6573 7361  ch_update["messa
-00018440: 6765 5f69 6422 5d20 3d3d 206d 6573 7361  ge_id"] == messa
-00018450: 6765 5f69 640a 2020 2020 2020 2020 2020  ge_id.          
-00018460: 2020 6173 7365 7274 2073 6372 6174 6368    assert scratch
-00018470: 5f75 7064 6174 655b 2265 7865 6375 7469  _update["executi
-00018480: 6f6e 5f73 7461 7465 225d 203d 3d20 2262  on_state"] == "b
-00018490: 7573 7922 0a0a 2020 2020 2020 2020 2020  usy"..          
-000184a0: 2020 2320 5265 6365 6976 6520 7363 7261    # Receive scra
-000184b0: 7463 6820 6578 6563 7574 696f 6e20 6f75  tch execution ou
-000184c0: 7470 7574 0a20 2020 2020 2020 2020 2020  tput.           
-000184d0: 2064 6174 6120 3d20 6177 6169 7420 7265   data = await re
-000184e0: 6365 6976 655f 6a73 6f6e 2877 6562 736f  ceive_json(webso
-000184f0: 636b 6574 2c20 6d73 675f 7479 7065 733d  cket, msg_types=
-00018500: 5b22 7363 7261 7463 685f 7570 6461 7465  ["scratch_update
-00018510: 225d 290a 2020 2020 2020 2020 2020 2020  "]).            
-00018520: 7363 7261 7463 685f 7570 6461 7465 203d  scratch_update =
-00018530: 2064 6174 615b 2273 6372 6174 6368 5f75   data["scratch_u
-00018540: 7064 6174 6522 5d0a 2020 2020 2020 2020  pdate"].        
-00018550: 2020 2020 2320 2f74 6d70 2073 796d 6c69      # /tmp symli
-00018560: 6e6b 7320 746f 202f 7072 6976 6174 652f  nks to /private/
-00018570: 746d 7020 6f6e 206d 6163 2c20 736f 2077  tmp on mac, so w
-00018580: 6520 7265 736f 6c76 650a 2020 2020 2020  e resolve.      
-00018590: 2020 2020 2020 7265 736f 6c76 6564 5f77        resolved_w
-000185a0: 6f72 6b5f 6469 7220 3d20 7061 7468 6c69  ork_dir = pathli
-000185b0: 622e 5061 7468 2877 6f72 6b69 6e67 5f64  b.Path(working_d
-000185c0: 6972 6563 746f 7279 292e 7265 736f 6c76  irectory).resolv
-000185d0: 6528 290a 2020 2020 2020 2020 2020 2020  e().            
-000185e0: 6578 7065 6374 6564 5f6f 7574 7075 7420  expected_output 
-000185f0: 3d20 7b0a 2020 2020 2020 2020 2020 2020  = {.            
-00018600: 2020 2020 2264 6174 6122 3a20 7b0a 2020      "data": {.  
-00018610: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00018620: 2020 2274 6578 742f 6874 6d6c 223a 2066    "text/html": f
-00018630: 2227 7b72 6573 6f6c 7665 645f 776f 726b  "'{resolved_work
-00018640: 5f64 6972 7d27 222c 0a20 2020 2020 2020  _dir}'",.       
-00018650: 2020 2020 2020 2020 2020 2020 2022 7465               "te
-00018660: 7874 2f6c 6174 6578 223a 2066 2227 7b72  xt/latex": f"'{r
-00018670: 6573 6f6c 7665 645f 776f 726b 5f64 6972  esolved_work_dir
-00018680: 7d27 222c 0a20 2020 2020 2020 2020 2020  }'",.           
-00018690: 2020 2020 2020 2020 2022 7465 7874 2f6d           "text/m
-000186a0: 6172 6b64 6f77 6e22 3a20 6622 277b 7265  arkdown": f"'{re
-000186b0: 736f 6c76 6564 5f77 6f72 6b5f 6469 727d  solved_work_dir}
-000186c0: 2722 2c0a 2020 2020 2020 2020 2020 2020  '",.            
-000186d0: 2020 2020 2020 2020 2274 6578 742f 706c          "text/pl
-000186e0: 6169 6e22 3a20 6627 5b31 5d20 227b 7265  ain": f'[1] "{re
-000186f0: 736f 6c76 6564 5f77 6f72 6b5f 6469 727d  solved_work_dir}
-00018700: 2227 2c0a 2020 2020 2020 2020 2020 2020  "',.            
-00018710: 2020 2020 7d2c 0a20 2020 2020 2020 2020      },.         
-00018720: 2020 2020 2020 2022 6d65 7461 6461 7461         "metadata
-00018730: 223a 207b 7d2c 0a20 2020 2020 2020 2020  ": {},.         
-00018740: 2020 2020 2020 2022 6f75 7470 7574 5f74         "output_t
-00018750: 7970 6522 3a20 2264 6973 706c 6179 5f64  ype": "display_d
-00018760: 6174 6122 2c0a 2020 2020 2020 2020 2020  ata",.          
-00018770: 2020 7d0a 2020 2020 2020 2020 2020 2020    }.            
-00018780: 6173 7365 7274 2073 6372 6174 6368 5f75  assert scratch_u
-00018790: 7064 6174 655b 226f 7574 7075 7422 5d20  pdate["output"] 
-000187a0: 3d3d 2065 7870 6563 7465 645f 6f75 7470  == expected_outp
-000187b0: 7574 0a0a 2020 2020 2020 2020 2020 2020  ut..            
-000187c0: 2320 5363 7261 7463 6820 6578 6563 7574  # Scratch execut
-000187d0: 696f 6e20 7374 6174 6520 7365 7420 746f  ion state set to
-000187e0: 2069 646c 650a 2020 2020 2020 2020 2020   idle.          
-000187f0: 2020 6461 7461 203d 2061 7761 6974 2072    data = await r
-00018800: 6563 6569 7665 5f6a 736f 6e28 7765 6273  eceive_json(webs
-00018810: 6f63 6b65 742c 206d 7367 5f74 7970 6573  ocket, msg_types
-00018820: 3d5b 2273 6372 6174 6368 5f75 7064 6174  =["scratch_updat
-00018830: 6522 5d29 0a20 2020 2020 2020 2020 2020  e"]).           
-00018840: 2073 6372 6174 6368 5f75 7064 6174 6520   scratch_update 
-00018850: 3d20 6461 7461 5b22 7363 7261 7463 685f  = data["scratch_
-00018860: 7570 6461 7465 225d 0a20 2020 2020 2020  update"].       
-00018870: 2020 2020 2061 7373 6572 7420 7363 7261       assert scra
-00018880: 7463 685f 7570 6461 7465 5b22 6d65 7373  tch_update["mess
-00018890: 6167 655f 6964 225d 203d 3d20 6d65 7373  age_id"] == mess
-000188a0: 6167 655f 6964 0a20 2020 2020 2020 2020  age_id.         
-000188b0: 2020 2061 7373 6572 7420 7363 7261 7463     assert scratc
-000188c0: 685f 7570 6461 7465 5b22 6578 6563 7574  h_update["execut
-000188d0: 696f 6e5f 7374 6174 6522 5d20 3d3d 2022  ion_state"] == "
-000188e0: 6964 6c65 220a 0a20 2020 2020 2020 2020  idle"..         
-000188f0: 2020 2074 6f6b 656e 203d 2067 6574 5f73     token = get_s
-00018900: 7570 6572 7573 6572 5f74 6f6b 656e 2829  uperuser_token()
-00018910: 0a20 2020 2020 2020 2020 2020 2061 7574  .            aut
-00018920: 6820 3d20 6261 7365 3634 2e62 3634 656e  h = base64.b64en
-00018930: 636f 6465 2866 227b 746f 6b65 6e7d 3a22  code(f"{token}:"
-00018940: 2e65 6e63 6f64 6528 2275 7466 2d38 2229  .encode("utf-8")
-00018950: 290a 2020 2020 2020 2020 2020 2020 7265  ).            re
-00018960: 7370 6f6e 7365 203d 2061 7761 6974 2063  sponse = await c
-00018970: 6c69 656e 742e 6765 7428 0a20 2020 2020  lient.get(.     
-00018980: 2020 2020 2020 2020 2020 2066 222f 6461             f"/da
-00018990: 767b 7265 736f 6c76 6564 5f77 6f72 6b5f  v{resolved_work_
-000189a0: 6469 727d 222c 0a20 2020 2020 2020 2020  dir}",.         
-000189b0: 2020 2020 2020 2068 6561 6465 7273 3d7b         headers={
-000189c0: 2241 7574 686f 7269 7a61 7469 6f6e 223a  "Authorization":
-000189d0: 2066 2242 6173 6963 207b 6175 7468 2e64   f"Basic {auth.d
-000189e0: 6563 6f64 6528 2775 7466 2d38 2729 7d22  ecode('utf-8')}"
-000189f0: 7d2c 0a20 2020 2020 2020 2020 2020 2029  },.            )
-00018a00: 0a20 2020 2020 2020 2020 2020 2061 7373  .            ass
-00018a10: 6572 7420 7265 7370 6f6e 7365 2e73 7461  ert response.sta
-00018a20: 7475 735f 636f 6465 203d 3d20 3230 300a  tus_code == 200.
-00018a30: 0a0a 4070 7974 6573 742e 6d61 726b 2e75  ..@pytest.mark.u
-00018a40: 7365 6669 7874 7572 6573 2822 636c 6561  sefixtures("clea
-00018a50: 725f 6e6f 7465 626f 6f6b 7322 2c20 2263  r_notebooks", "c
-00018a60: 6c65 6172 5f6e 6f74 6562 6f6f 6b5f 6469  lear_notebook_di
-00018a70: 7265 6374 6f72 7922 290a 636c 6173 7320  rectory").class 
-00018a80: 5465 7374 4368 616e 6765 576f 726b 696e  TestChangeWorkin
-00018a90: 6744 6972 6563 746f 7279 3a0a 2020 2020  gDirectory:.    
-00018aa0: 6173 796e 6320 6465 6620 646f 5f74 6573  async def do_tes
-00018ab0: 745f 6368 616e 6765 5f77 6f72 6b69 6e67  t_change_working
-00018ac0: 5f64 6972 6563 746f 7279 280a 2020 2020  _directory(.    
-00018ad0: 2020 2020 7365 6c66 2c0a 2020 2020 2020      self,.      
-00018ae0: 2020 636c 6965 6e74 3a20 5465 7374 436c    client: TestCl
-00018af0: 6965 6e74 2c0a 2020 2020 2020 2020 7375  ient,.        su
-00018b00: 7065 7275 7365 725f 746f 6b65 6e5f 6865  peruser_token_he
-00018b10: 6164 6572 733a 2044 6963 745b 7374 722c  aders: Dict[str,
-00018b20: 2073 7472 5d2c 0a20 2020 2020 2020 206b   str],.        k
-00018b30: 7370 6563 5f6e 616d 653a 2073 7472 2c0a  spec_name: str,.
-00018b40: 2020 2020 293a 0a20 2020 2020 2020 2077      ):.        w
-00018b50: 6f72 6b69 6e67 5f64 6972 6563 746f 7279  orking_directory
-00018b60: 203d 2022 2f74 6d70 220a 2020 2020 2020   = "/tmp".      
-00018b70: 2020 7265 736f 6c76 6564 5f77 6f72 6b5f    resolved_work_
-00018b80: 6469 7220 3d20 7374 7228 7061 7468 6c69  dir = str(pathli
-00018b90: 622e 5061 7468 2877 6f72 6b69 6e67 5f64  b.Path(working_d
-00018ba0: 6972 6563 746f 7279 292e 7265 736f 6c76  irectory).resolv
-00018bb0: 6528 2929 0a20 2020 2020 2020 2072 6573  e()).        res
-00018bc0: 706f 6e73 6520 3d20 6177 6169 7420 636c  ponse = await cl
-00018bd0: 6965 6e74 2e70 6f73 7428 0a20 2020 2020  ient.post(.     
-00018be0: 2020 2020 2020 2022 2f6e 6f74 6562 6f6f         "/noteboo
-00018bf0: 6b73 2f63 7265 6174 6522 2c0a 2020 2020  ks/create",.    
-00018c00: 2020 2020 2020 2020 7175 6572 795f 7374          query_st
-00018c10: 7269 6e67 3d7b 0a20 2020 2020 2020 2020  ring={.         
-00018c20: 2020 2020 2020 2022 6b73 7065 635f 6e61         "kspec_na
-00018c30: 6d65 223a 206b 7370 6563 5f6e 616d 652c  me": kspec_name,
-00018c40: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00018c50: 2022 6669 6c65 6e61 6d65 223a 2022 6865   "filename": "he
-00018c60: 7970 222c 0a20 2020 2020 2020 2020 2020  yp",.           
-00018c70: 2020 2020 2022 776f 726b 696e 675f 6469       "working_di
-00018c80: 7265 6374 6f72 7922 3a20 776f 726b 696e  rectory": workin
-00018c90: 675f 6469 7265 6374 6f72 792c 0a20 2020  g_directory,.   
-00018ca0: 2020 2020 2020 2020 207d 2c0a 2020 2020           },.    
-00018cb0: 2020 2020 2020 2020 6865 6164 6572 733d          headers=
-00018cc0: 7375 7065 7275 7365 725f 746f 6b65 6e5f  superuser_token_
-00018cd0: 6865 6164 6572 732c 0a20 2020 2020 2020  headers,.       
-00018ce0: 2029 0a20 2020 2020 2020 2061 7373 6572   ).        asser
-00018cf0: 7420 7265 7370 6f6e 7365 2e73 7461 7475  t response.statu
-00018d00: 735f 636f 6465 203d 3d20 3230 310a 2020  s_code == 201.  
-00018d10: 2020 2020 2020 7265 7370 5f6a 736f 6e20        resp_json 
-00018d20: 3d20 7265 7370 6f6e 7365 2e6a 736f 6e28  = response.json(
-00018d30: 295b 226e 6f74 6562 6f6f 6b22 5d0a 2020  )["notebook"].  
-00018d40: 2020 2020 2020 7575 6964 203d 2072 6573        uuid = res
-00018d50: 705f 6a73 6f6e 5b22 6d65 7461 6461 7461  p_json["metadata
-00018d60: 225d 5b22 6a75 7079 7465 725f 6431 225d  "]["jupyter_d1"]
-00018d70: 5b22 7575 6964 225d 0a0a 2020 2020 2020  ["uuid"]..      
-00018d80: 2020 746f 6b65 6e20 3d20 6765 745f 7375    token = get_su
-00018d90: 7065 7275 7365 725f 746f 6b65 6e28 290a  peruser_token().
-00018da0: 2020 2020 2020 2020 6175 7468 203d 2062          auth = b
-00018db0: 6173 6536 342e 6236 3465 6e63 6f64 6528  ase64.b64encode(
-00018dc0: 6622 7b74 6f6b 656e 7d3a 222e 656e 636f  f"{token}:".enco
-00018dd0: 6465 2822 7574 662d 3822 2929 0a20 2020  de("utf-8")).   
-00018de0: 2020 2020 2072 6573 706f 6e73 6520 3d20       response = 
-00018df0: 6177 6169 7420 636c 6965 6e74 2e67 6574  await client.get
-00018e00: 280a 2020 2020 2020 2020 2020 2020 6622  (.            f"
-00018e10: 2f64 6176 7b72 6573 6f6c 7665 645f 776f  /dav{resolved_wo
-00018e20: 726b 5f64 6972 7d22 2c0a 2020 2020 2020  rk_dir}",.      
-00018e30: 2020 2020 2020 6865 6164 6572 733d 7b22        headers={"
-00018e40: 4175 7468 6f72 697a 6174 696f 6e22 3a20  Authorization": 
-00018e50: 6622 4261 7369 6320 7b61 7574 682e 6465  f"Basic {auth.de
-00018e60: 636f 6465 2827 7574 662d 3827 297d 227d  code('utf-8')}"}
-00018e70: 2c0a 2020 2020 2020 2020 290a 2020 2020  ,.        ).    
-00018e80: 2020 2020 6173 7365 7274 2072 6573 706f      assert respo
-00018e90: 6e73 652e 7374 6174 7573 5f63 6f64 6520  nse.status_code 
-00018ea0: 3d3d 2032 3030 0a0a 2020 2020 2020 2020  == 200..        
-00018eb0: 6173 796e 6320 7769 7468 2063 6c69 656e  async with clien
-00018ec0: 742e 7765 6273 6f63 6b65 745f 636f 6e6e  t.websocket_conn
-00018ed0: 6563 7428 0a20 2020 2020 2020 2020 2020  ect(.           
-00018ee0: 2066 222f 6e6f 7465 626f 6f6b 732f 7b75   f"/notebooks/{u
-00018ef0: 7569 647d 2f77 732f 6e6f 7465 626f 6f6b  uid}/ws/notebook
-00018f00: 222c 2068 6561 6465 7273 3d73 7570 6572  ", headers=super
-00018f10: 7573 6572 5f74 6f6b 656e 5f68 6561 6465  user_token_heade
-00018f20: 7273 0a20 2020 2020 2020 2029 2061 7320  rs.        ) as 
-00018f30: 7765 6273 6f63 6b65 743a 0a20 2020 2020  websocket:.     
-00018f40: 2020 2020 2020 2061 7761 6974 2061 7379         await asy
-00018f50: 6e63 696f 2e73 6c65 6570 2857 4542 534f  ncio.sleep(WEBSO
-00018f60: 434b 4554 5f53 4c45 4550 5f54 494d 4529  CKET_SLEEP_TIME)
-00018f70: 0a0a 2020 2020 2020 2020 2020 2020 6e65  ..            ne
-00018f80: 775f 776f 726b 6469 7220 3d20 6622 7b6f  w_workdir = f"{o
-00018f90: 732e 6765 7463 7764 2829 7d2f 6a75 7079  s.getcwd()}/jupy
-00018fa0: 7465 725f 6431 2f74 6573 7473 2f6e 6f74  ter_d1/tests/not
-00018fb0: 6562 6f6f 6b73 220a 2020 2020 2020 2020  ebooks".        
-00018fc0: 2020 2020 7265 7370 6f6e 7365 203d 2061      response = a
-00018fd0: 7761 6974 2063 6c69 656e 742e 7061 7463  wait client.patc
-00018fe0: 6828 0a20 2020 2020 2020 2020 2020 2020  h(.             
-00018ff0: 2020 2066 222f 6e6f 7465 626f 6f6b 732f     f"/notebooks/
-00019000: 7b75 7569 647d 2f63 6861 6e67 655f 776f  {uuid}/change_wo
-00019010: 726b 696e 675f 6469 7265 6374 6f72 7922  rking_directory"
-00019020: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
-00019030: 2020 6865 6164 6572 733d 7375 7065 7275    headers=superu
-00019040: 7365 725f 746f 6b65 6e5f 6865 6164 6572  ser_token_header
-00019050: 732c 0a20 2020 2020 2020 2020 2020 2020  s,.             
-00019060: 2020 2071 7565 7279 5f73 7472 696e 673d     query_string=
-00019070: 7b22 6469 7265 6374 6f72 7922 3a20 6e65  {"directory": ne
-00019080: 775f 776f 726b 6469 727d 2c0a 2020 2020  w_workdir},.    
-00019090: 2020 2020 2020 2020 290a 2020 2020 2020          ).      
-000190a0: 2020 2020 2020 6173 7365 7274 2072 6573        assert res
-000190b0: 706f 6e73 652e 7374 6174 7573 5f63 6f64  ponse.status_cod
-000190c0: 6520 3d3d 2032 3030 0a0a 2020 2020 2020  e == 200..      
-000190d0: 2020 2020 2020 6461 7461 203d 2061 7761        data = awa
-000190e0: 6974 2072 6563 6569 7665 5f6a 736f 6e28  it receive_json(
-000190f0: 7765 6273 6f63 6b65 742c 206d 7367 5f74  websocket, msg_t
-00019100: 7970 6573 3d5b 226d 6574 6164 6174 6122  ypes=["metadata"
-00019110: 5d29 0a0a 2020 2020 2020 2020 2020 2020  ])..            
-00019120: 6d65 7461 6461 7461 203d 2064 6174 615b  metadata = data[
-00019130: 226d 6574 6164 6174 6122 5d0a 2020 2020  "metadata"].    
-00019140: 2020 2020 2020 2020 6173 7365 7274 206d          assert m
-00019150: 6574 6164 6174 615b 226a 7570 7974 6572  etadata["jupyter
-00019160: 5f64 3122 5d5b 2277 6f72 6b69 6e67 5f64  _d1"]["working_d
-00019170: 6972 6563 746f 7279 225d 203d 3d20 6e65  irectory"] == ne
-00019180: 775f 776f 726b 6469 720a 0a20 2020 2020  w_workdir..     
-00019190: 2020 2020 2020 2072 6573 706f 6e73 6520         response 
-000191a0: 3d20 6177 6169 7420 636c 6965 6e74 2e67  = await client.g
-000191b0: 6574 280a 2020 2020 2020 2020 2020 2020  et(.            
-000191c0: 2020 2020 6622 2f64 6176 7b6e 6577 5f77      f"/dav{new_w
-000191d0: 6f72 6b64 6972 7d22 2c0a 2020 2020 2020  orkdir}",.      
-000191e0: 2020 2020 2020 2020 2020 6865 6164 6572            header
-000191f0: 733d 7b22 4175 7468 6f72 697a 6174 696f  s={"Authorizatio
-00019200: 6e22 3a20 6622 4261 7369 6320 7b61 7574  n": f"Basic {aut
-00019210: 682e 6465 636f 6465 2827 7574 662d 3827  h.decode('utf-8'
-00019220: 297d 227d 2c0a 2020 2020 2020 2020 2020  )}"},.          
-00019230: 2020 290a 2020 2020 2020 2020 2020 2020    ).            
-00019240: 6173 7365 7274 2072 6573 706f 6e73 652e  assert response.
-00019250: 7374 6174 7573 5f63 6f64 6520 3d3d 2032  status_code == 2
-00019260: 3030 0a0a 2020 2020 2020 2020 2020 2020  00..            
-00019270: 7265 7370 6f6e 7365 203d 2061 7761 6974  response = await
-00019280: 2063 6c69 656e 742e 6765 7428 0a20 2020   client.get(.   
-00019290: 2020 2020 2020 2020 2020 2020 2066 222f               f"/
-000192a0: 6461 767b 7265 736f 6c76 6564 5f77 6f72  dav{resolved_wor
-000192b0: 6b5f 6469 727d 222c 0a20 2020 2020 2020  k_dir}",.       
-000192c0: 2020 2020 2020 2020 2068 6561 6465 7273           headers
-000192d0: 3d7b 2241 7574 686f 7269 7a61 7469 6f6e  ={"Authorization
-000192e0: 223a 2066 2242 6173 6963 207b 6175 7468  ": f"Basic {auth
-000192f0: 2e64 6563 6f64 6528 2775 7466 2d38 2729  .decode('utf-8')
-00019300: 7d22 7d2c 0a20 2020 2020 2020 2020 2020  }"},.           
-00019310: 2029 0a20 2020 2020 2020 2020 2020 2061   ).            a
-00019320: 7373 6572 7420 7265 7370 6f6e 7365 2e73  ssert response.s
-00019330: 7461 7475 735f 636f 6465 203d 3d20 3430  tatus_code == 40
-00019340: 340a 0a20 2020 2020 2020 2072 6573 706f  4..        respo
-00019350: 6e73 6520 3d20 6177 6169 7420 636c 6965  nse = await clie
-00019360: 6e74 2e67 6574 280a 2020 2020 2020 2020  nt.get(.        
-00019370: 2020 2020 6622 2f6e 6f74 6562 6f6f 6b73      f"/notebooks
-00019380: 2f7b 7575 6964 7d22 2c20 6865 6164 6572  /{uuid}", header
-00019390: 733d 7375 7065 7275 7365 725f 746f 6b65  s=superuser_toke
-000193a0: 6e5f 6865 6164 6572 730a 2020 2020 2020  n_headers.      
-000193b0: 2020 290a 2020 2020 2020 2020 7265 7370    ).        resp
-000193c0: 5f6a 736f 6e20 3d20 7265 7370 6f6e 7365  _json = response
-000193d0: 2e6a 736f 6e28 295b 226e 6f74 6562 6f6f  .json()["noteboo
-000193e0: 6b22 5d0a 2020 2020 2020 2020 6173 7365  k"].        asse
-000193f0: 7274 2028 0a20 2020 2020 2020 2020 2020  rt (.           
-00019400: 2072 6573 705f 6a73 6f6e 5b22 6d65 7461   resp_json["meta
-00019410: 6461 7461 225d 5b22 6a75 7079 7465 725f  data"]["jupyter_
-00019420: 6431 225d 5b22 776f 726b 696e 675f 6469  d1"]["working_di
-00019430: 7265 6374 6f72 7922 5d0a 2020 2020 2020  rectory"].      
-00019440: 2020 2020 2020 3d3d 206e 6577 5f77 6f72        == new_wor
-00019450: 6b64 6972 0a20 2020 2020 2020 2029 0a0a  kdir.        )..
-00019460: 2020 2020 6173 796e 6320 6465 6620 646f      async def do
-00019470: 5f74 6573 745f 6368 616e 6765 5f77 6f72  _test_change_wor
-00019480: 6b69 6e67 5f64 6972 6563 746f 7279 5f69  king_directory_i
-00019490: 6e5f 636f 6465 280a 2020 2020 2020 2020  n_code(.        
-000194a0: 7365 6c66 2c0a 2020 2020 2020 2020 636c  self,.        cl
-000194b0: 6965 6e74 3a20 5465 7374 436c 6965 6e74  ient: TestClient
-000194c0: 2c0a 2020 2020 2020 2020 7375 7065 7275  ,.        superu
-000194d0: 7365 725f 746f 6b65 6e5f 6865 6164 6572  ser_token_header
-000194e0: 733a 2044 6963 745b 7374 722c 2073 7472  s: Dict[str, str
-000194f0: 5d2c 0a20 2020 2020 2020 206b 7370 6563  ],.        kspec
-00019500: 5f6e 616d 653a 2073 7472 2c0a 2020 2020  _name: str,.    
-00019510: 2020 2020 6368 6469 725f 636f 6465 3a20      chdir_code: 
-00019520: 7374 722c 0a20 2020 2029 3a0a 2020 2020  str,.    ):.    
-00019530: 2020 2020 776f 726b 696e 675f 6469 7265      working_dire
-00019540: 6374 6f72 7920 3d20 222f 746d 7022 0a20  ctory = "/tmp". 
-00019550: 2020 2020 2020 2072 6573 6f6c 7665 645f         resolved_
-00019560: 776f 726b 5f64 6972 203d 2073 7472 2870  work_dir = str(p
-00019570: 6174 686c 6962 2e50 6174 6828 776f 726b  athlib.Path(work
-00019580: 696e 675f 6469 7265 6374 6f72 7929 2e72  ing_directory).r
-00019590: 6573 6f6c 7665 2829 290a 2020 2020 2020  esolve()).      
-000195a0: 2020 7265 7370 6f6e 7365 203d 2061 7761    response = awa
-000195b0: 6974 2063 6c69 656e 742e 706f 7374 280a  it client.post(.
-000195c0: 2020 2020 2020 2020 2020 2020 222f 6e6f              "/no
-000195d0: 7465 626f 6f6b 732f 6372 6561 7465 222c  tebooks/create",
-000195e0: 0a20 2020 2020 2020 2020 2020 2071 7565  .            que
-000195f0: 7279 5f73 7472 696e 673d 7b0a 2020 2020  ry_string={.    
-00019600: 2020 2020 2020 2020 2020 2020 226b 7370              "ksp
-00019610: 6563 5f6e 616d 6522 3a20 6b73 7065 635f  ec_name": kspec_
-00019620: 6e61 6d65 2c0a 2020 2020 2020 2020 2020  name,.          
-00019630: 2020 2020 2020 2266 696c 656e 616d 6522        "filename"
-00019640: 3a20 2268 6579 7022 2c0a 2020 2020 2020  : "heyp",.      
-00019650: 2020 2020 2020 2020 2020 2277 6f72 6b69            "worki
-00019660: 6e67 5f64 6972 6563 746f 7279 223a 2077  ng_directory": w
-00019670: 6f72 6b69 6e67 5f64 6972 6563 746f 7279  orking_directory
-00019680: 2c0a 2020 2020 2020 2020 2020 2020 7d2c  ,.            },
-00019690: 0a20 2020 2020 2020 2020 2020 2068 6561  .            hea
-000196a0: 6465 7273 3d73 7570 6572 7573 6572 5f74  ders=superuser_t
-000196b0: 6f6b 656e 5f68 6561 6465 7273 2c0a 2020  oken_headers,.  
-000196c0: 2020 2020 2020 290a 2020 2020 2020 2020        ).        
-000196d0: 6173 7365 7274 2072 6573 706f 6e73 652e  assert response.
-000196e0: 7374 6174 7573 5f63 6f64 6520 3d3d 2032  status_code == 2
-000196f0: 3031 0a20 2020 2020 2020 2072 6573 705f  01.        resp_
-00019700: 6a73 6f6e 203d 2072 6573 706f 6e73 652e  json = response.
-00019710: 6a73 6f6e 2829 5b22 6e6f 7465 626f 6f6b  json()["notebook
-00019720: 225d 0a20 2020 2020 2020 2075 7569 6420  "].        uuid 
-00019730: 3d20 7265 7370 5f6a 736f 6e5b 226d 6574  = resp_json["met
-00019740: 6164 6174 6122 5d5b 226a 7570 7974 6572  adata"]["jupyter
-00019750: 5f64 3122 5d5b 2275 7569 6422 5d0a 0a20  _d1"]["uuid"].. 
-00019760: 2020 2020 2020 2074 6f6b 656e 203d 2067         token = g
-00019770: 6574 5f73 7570 6572 7573 6572 5f74 6f6b  et_superuser_tok
-00019780: 656e 2829 0a20 2020 2020 2020 2061 7574  en().        aut
-00019790: 6820 3d20 6261 7365 3634 2e62 3634 656e  h = base64.b64en
-000197a0: 636f 6465 2866 227b 746f 6b65 6e7d 3a22  code(f"{token}:"
-000197b0: 2e65 6e63 6f64 6528 2275 7466 2d38 2229  .encode("utf-8")
-000197c0: 290a 2020 2020 2020 2020 7265 7370 6f6e  ).        respon
-000197d0: 7365 203d 2061 7761 6974 2063 6c69 656e  se = await clien
-000197e0: 742e 6765 7428 0a20 2020 2020 2020 2020  t.get(.         
-000197f0: 2020 2066 222f 6461 767b 7265 736f 6c76     f"/dav{resolv
-00019800: 6564 5f77 6f72 6b5f 6469 727d 222c 0a20  ed_work_dir}",. 
-00019810: 2020 2020 2020 2020 2020 2068 6561 6465             heade
-00019820: 7273 3d7b 2241 7574 686f 7269 7a61 7469  rs={"Authorizati
-00019830: 6f6e 223a 2066 2242 6173 6963 207b 6175  on": f"Basic {au
-00019840: 7468 2e64 6563 6f64 6528 2775 7466 2d38  th.decode('utf-8
-00019850: 2729 7d22 7d2c 0a20 2020 2020 2020 2029  ')}"},.        )
-00019860: 0a20 2020 2020 2020 2061 7373 6572 7420  .        assert 
-00019870: 7265 7370 6f6e 7365 2e73 7461 7475 735f  response.status_
-00019880: 636f 6465 203d 3d20 3230 300a 0a20 2020  code == 200..   
-00019890: 2020 2020 2061 7379 6e63 2077 6974 6820       async with 
-000198a0: 636c 6965 6e74 2e77 6562 736f 636b 6574  client.websocket
-000198b0: 5f63 6f6e 6e65 6374 280a 2020 2020 2020  _connect(.      
-000198c0: 2020 2020 2020 6622 2f6e 6f74 6562 6f6f        f"/noteboo
-000198d0: 6b73 2f7b 7575 6964 7d2f 7773 2f6e 6f74  ks/{uuid}/ws/not
-000198e0: 6562 6f6f 6b22 2c20 6865 6164 6572 733d  ebook", headers=
-000198f0: 7375 7065 7275 7365 725f 746f 6b65 6e5f  superuser_token_
-00019900: 6865 6164 6572 730a 2020 2020 2020 2020  headers.        
-00019910: 2920 6173 2077 6562 736f 636b 6574 3a0a  ) as websocket:.
-00019920: 2020 2020 2020 2020 2020 2020 6177 6169              awai
-00019930: 7420 6173 796e 6369 6f2e 736c 6565 7028  t asyncio.sleep(
-00019940: 5745 4253 4f43 4b45 545f 534c 4545 505f  WEBSOCKET_SLEEP_
-00019950: 5449 4d45 290a 0a20 2020 2020 2020 2020  TIME)..         
-00019960: 2020 206e 6577 5f77 6f72 6b64 6972 203d     new_workdir =
-00019970: 2066 227b 6f73 2e67 6574 6377 6428 297d   f"{os.getcwd()}
-00019980: 2f6a 7570 7974 6572 5f64 312f 7465 7374  /jupyter_d1/test
-00019990: 732f 6e6f 7465 626f 6f6b 7322 0a20 2020  s/notebooks".   
-000199a0: 2020 2020 2020 2020 2072 6573 706f 6e73           respons
-000199b0: 6520 3d20 6177 6169 7420 636c 6965 6e74  e = await client
-000199c0: 2e70 6f73 7428 0a20 2020 2020 2020 2020  .post(.         
-000199d0: 2020 2020 2020 2066 222f 6e6f 7465 626f         f"/notebo
-000199e0: 6f6b 732f 7b75 7569 647d 2f73 6372 6174  oks/{uuid}/scrat
-000199f0: 6368 5f65 7865 6375 7465 222c 0a20 2020  ch_execute",.   
-00019a00: 2020 2020 2020 2020 2020 2020 2068 6561               hea
-00019a10: 6465 7273 3d73 7570 6572 7573 6572 5f74  ders=superuser_t
-00019a20: 6f6b 656e 5f68 6561 6465 7273 2c0a 2020  oken_headers,.  
-00019a30: 2020 2020 2020 2020 2020 2020 2020 6a73                js
-00019a40: 6f6e 3d7b 2263 6f64 6522 3a20 6368 6469  on={"code": chdi
-00019a50: 725f 636f 6465 2e66 6f72 6d61 7428 6e65  r_code.format(ne
-00019a60: 775f 776f 726b 6469 723d 6e65 775f 776f  w_workdir=new_wo
-00019a70: 726b 6469 7229 7d2c 0a20 2020 2020 2020  rkdir)},.       
-00019a80: 2020 2020 2029 0a20 2020 2020 2020 2020       ).         
-00019a90: 2020 2061 7373 6572 7420 7265 7370 6f6e     assert respon
-00019aa0: 7365 2e73 7461 7475 735f 636f 6465 203d  se.status_code =
-00019ab0: 3d20 3230 300a 0a20 2020 2020 2020 2020  = 200..         
-00019ac0: 2020 2064 6174 6120 3d20 6177 6169 7420     data = await 
-00019ad0: 7761 6974 5f66 6f72 5f65 7665 6e74 2877  wait_for_event(w
-00019ae0: 6562 736f 636b 6574 2c20 226d 6574 6164  ebsocket, "metad
-00019af0: 6174 6122 2c20 7469 6d65 6f75 743d 3130  ata", timeout=10
-00019b00: 290a 0a20 2020 2020 2020 2020 2020 206d  )..            m
-00019b10: 6574 6164 6174 6120 3d20 6461 7461 5b22  etadata = data["
-00019b20: 6d65 7461 6461 7461 225d 0a20 2020 2020  metadata"].     
-00019b30: 2020 2020 2020 2061 7373 6572 7420 6d65         assert me
-00019b40: 7461 6461 7461 5b22 6a75 7079 7465 725f  tadata["jupyter_
-00019b50: 6431 225d 5b22 776f 726b 696e 675f 6469  d1"]["working_di
-00019b60: 7265 6374 6f72 7922 5d20 3d3d 206e 6577  rectory"] == new
-00019b70: 5f77 6f72 6b64 6972 0a0a 2020 2020 2020  _workdir..      
-00019b80: 2020 2020 2020 7265 7370 6f6e 7365 203d        response =
-00019b90: 2061 7761 6974 2063 6c69 656e 742e 6765   await client.ge
-00019ba0: 7428 0a20 2020 2020 2020 2020 2020 2020  t(.             
-00019bb0: 2020 2066 222f 6461 767b 6e65 775f 776f     f"/dav{new_wo
-00019bc0: 726b 6469 727d 222c 0a20 2020 2020 2020  rkdir}",.       
-00019bd0: 2020 2020 2020 2020 2068 6561 6465 7273           headers
-00019be0: 3d7b 2241 7574 686f 7269 7a61 7469 6f6e  ={"Authorization
-00019bf0: 223a 2066 2242 6173 6963 207b 6175 7468  ": f"Basic {auth
-00019c00: 2e64 6563 6f64 6528 2775 7466 2d38 2729  .decode('utf-8')
-00019c10: 7d22 7d2c 0a20 2020 2020 2020 2020 2020  }"},.           
-00019c20: 2029 0a20 2020 2020 2020 2020 2020 2061   ).            a
-00019c30: 7373 6572 7420 7265 7370 6f6e 7365 2e73  ssert response.s
-00019c40: 7461 7475 735f 636f 6465 203d 3d20 3230  tatus_code == 20
-00019c50: 300a 0a20 2020 2020 2020 2020 2020 2072  0..            r
-00019c60: 6573 706f 6e73 6520 3d20 6177 6169 7420  esponse = await 
-00019c70: 636c 6965 6e74 2e67 6574 280a 2020 2020  client.get(.    
-00019c80: 2020 2020 2020 2020 2020 2020 6622 2f64              f"/d
-00019c90: 6176 7b72 6573 6f6c 7665 645f 776f 726b  av{resolved_work
-00019ca0: 5f64 6972 7d22 2c0a 2020 2020 2020 2020  _dir}",.        
-00019cb0: 2020 2020 2020 2020 6865 6164 6572 733d          headers=
-00019cc0: 7b22 4175 7468 6f72 697a 6174 696f 6e22  {"Authorization"
-00019cd0: 3a20 6622 4261 7369 6320 7b61 7574 682e  : f"Basic {auth.
-00019ce0: 6465 636f 6465 2827 7574 662d 3827 297d  decode('utf-8')}
-00019cf0: 227d 2c0a 2020 2020 2020 2020 2020 2020  "},.            
-00019d00: 290a 2020 2020 2020 2020 2020 2020 6173  ).            as
-00019d10: 7365 7274 2072 6573 706f 6e73 652e 7374  sert response.st
-00019d20: 6174 7573 5f63 6f64 6520 3d3d 2034 3034  atus_code == 404
-00019d30: 0a0a 2020 2020 2020 2020 7265 7370 6f6e  ..        respon
-00019d40: 7365 203d 2061 7761 6974 2063 6c69 656e  se = await clien
-00019d50: 742e 6765 7428 0a20 2020 2020 2020 2020  t.get(.         
-00019d60: 2020 2066 222f 6e6f 7465 626f 6f6b 732f     f"/notebooks/
-00019d70: 7b75 7569 647d 222c 2068 6561 6465 7273  {uuid}", headers
-00019d80: 3d73 7570 6572 7573 6572 5f74 6f6b 656e  =superuser_token
-00019d90: 5f68 6561 6465 7273 0a20 2020 2020 2020  _headers.       
-00019da0: 2029 0a20 2020 2020 2020 2072 6573 705f   ).        resp_
-00019db0: 6a73 6f6e 203d 2072 6573 706f 6e73 652e  json = response.
-00019dc0: 6a73 6f6e 2829 5b22 6e6f 7465 626f 6f6b  json()["notebook
-00019dd0: 225d 0a20 2020 2020 2020 2061 7373 6572  "].        asser
-00019de0: 7420 280a 2020 2020 2020 2020 2020 2020  t (.            
-00019df0: 7265 7370 5f6a 736f 6e5b 226d 6574 6164  resp_json["metad
-00019e00: 6174 6122 5d5b 226a 7570 7974 6572 5f64  ata"]["jupyter_d
-00019e10: 3122 5d5b 2277 6f72 6b69 6e67 5f64 6972  1"]["working_dir
-00019e20: 6563 746f 7279 225d 0a20 2020 2020 2020  ectory"].       
-00019e30: 2020 2020 203d 3d20 6e65 775f 776f 726b       == new_work
-00019e40: 6469 720a 2020 2020 2020 2020 290a 0a20  dir.        ).. 
-00019e50: 2020 2040 7079 7465 7374 2e6d 6172 6b2e     @pytest.mark.
-00019e60: 6173 796e 6369 6f0a 2020 2020 6173 796e  asyncio.    asyn
-00019e70: 6320 6465 6620 7465 7374 5f70 7974 686f  c def test_pytho
-00019e80: 6e5f 6368 616e 6765 5f77 6f72 6b69 6e67  n_change_working
-00019e90: 5f64 6972 6563 746f 7279 5f65 6e64 706f  _directory_endpo
-00019ea0: 696e 7428 0a20 2020 2020 2020 2073 656c  int(.        sel
-00019eb0: 662c 2063 6c69 656e 743a 2054 6573 7443  f, client: TestC
-00019ec0: 6c69 656e 742c 2073 7570 6572 7573 6572  lient, superuser
-00019ed0: 5f74 6f6b 656e 5f68 6561 6465 7273 3a20  _token_headers: 
-00019ee0: 4469 6374 5b73 7472 2c20 7374 725d 0a20  Dict[str, str]. 
-00019ef0: 2020 2029 3a0a 2020 2020 2020 2020 6177     ):.        aw
-00019f00: 6169 7420 7365 6c66 2e64 6f5f 7465 7374  ait self.do_test
-00019f10: 5f63 6861 6e67 655f 776f 726b 696e 675f  _change_working_
-00019f20: 6469 7265 6374 6f72 7928 0a20 2020 2020  directory(.     
-00019f30: 2020 2020 2020 2063 6c69 656e 742c 2073         client, s
-00019f40: 7570 6572 7573 6572 5f74 6f6b 656e 5f68  uperuser_token_h
-00019f50: 6561 6465 7273 2c20 2270 7974 686f 6e22  eaders, "python"
-00019f60: 0a20 2020 2020 2020 2029 0a0a 2020 2020  .        )..    
-00019f70: 4070 7974 6573 742e 6d61 726b 2e61 7379  @pytest.mark.asy
-00019f80: 6e63 696f 0a20 2020 2061 7379 6e63 2064  ncio.    async d
-00019f90: 6566 2074 6573 745f 7079 7468 6f6e 5f63  ef test_python_c
-00019fa0: 6861 6e67 655f 776f 726b 696e 675f 6469  hange_working_di
-00019fb0: 7265 6374 6f72 795f 696e 5f63 6f64 6528  rectory_in_code(
-00019fc0: 0a20 2020 2020 2020 2073 656c 662c 2063  .        self, c
-00019fd0: 6c69 656e 743a 2054 6573 7443 6c69 656e  lient: TestClien
-00019fe0: 742c 2073 7570 6572 7573 6572 5f74 6f6b  t, superuser_tok
-00019ff0: 656e 5f68 6561 6465 7273 3a20 4469 6374  en_headers: Dict
-0001a000: 5b73 7472 2c20 7374 725d 0a20 2020 2029  [str, str].    )
-0001a010: 3a0a 2020 2020 2020 2020 6177 6169 7420  :.        await 
-0001a020: 7365 6c66 2e64 6f5f 7465 7374 5f63 6861  self.do_test_cha
-0001a030: 6e67 655f 776f 726b 696e 675f 6469 7265  nge_working_dire
-0001a040: 6374 6f72 795f 696e 5f63 6f64 6528 0a20  ctory_in_code(. 
-0001a050: 2020 2020 2020 2020 2020 2063 6c69 656e             clien
-0001a060: 742c 0a20 2020 2020 2020 2020 2020 2073  t,.            s
-0001a070: 7570 6572 7573 6572 5f74 6f6b 656e 5f68  uperuser_token_h
-0001a080: 6561 6465 7273 2c0a 2020 2020 2020 2020  eaders,.        
-0001a090: 2020 2020 2270 7974 686f 6e22 2c0a 2020      "python",.  
-0001a0a0: 2020 2020 2020 2020 2020 2769 6d70 6f72            'impor
-0001a0b0: 7420 6f73 5c6e 6f73 2e63 6864 6972 2822  t os\nos.chdir("
-0001a0c0: 7b6e 6577 5f77 6f72 6b64 6972 7d22 2927  {new_workdir}")'
-0001a0d0: 2c0a 2020 2020 2020 2020 290a 0a20 2020  ,.        )..   
-0001a0e0: 2040 7079 7465 7374 2e6d 6172 6b2e 6173   @pytest.mark.as
-0001a0f0: 796e 6369 6f0a 2020 2020 6173 796e 6320  yncio.    async 
-0001a100: 6465 6620 7465 7374 5f72 5f63 6861 6e67  def test_r_chang
-0001a110: 655f 776f 726b 696e 675f 6469 7265 6374  e_working_direct
-0001a120: 6f72 795f 656e 6470 6f69 6e74 280a 2020  ory_endpoint(.  
-0001a130: 2020 2020 2020 7365 6c66 2c20 636c 6965        self, clie
-0001a140: 6e74 3a20 5465 7374 436c 6965 6e74 2c20  nt: TestClient, 
-0001a150: 7375 7065 7275 7365 725f 746f 6b65 6e5f  superuser_token_
-0001a160: 6865 6164 6572 733a 2044 6963 745b 7374  headers: Dict[st
-0001a170: 722c 2073 7472 5d0a 2020 2020 293a 0a20  r, str].    ):. 
-0001a180: 2020 2020 2020 2061 7761 6974 2073 656c         await sel
-0001a190: 662e 646f 5f74 6573 745f 6368 616e 6765  f.do_test_change
-0001a1a0: 5f77 6f72 6b69 6e67 5f64 6972 6563 746f  _working_directo
-0001a1b0: 7279 280a 2020 2020 2020 2020 2020 2020  ry(.            
-0001a1c0: 636c 6965 6e74 2c20 7375 7065 7275 7365  client, superuse
-0001a1d0: 725f 746f 6b65 6e5f 6865 6164 6572 732c  r_token_headers,
-0001a1e0: 2022 6972 220a 2020 2020 2020 2020 290a   "ir".        ).
-0001a1f0: 0a20 2020 2040 7079 7465 7374 2e6d 6172  .    @pytest.mar
-0001a200: 6b2e 6173 796e 6369 6f0a 2020 2020 6173  k.asyncio.    as
-0001a210: 796e 6320 6465 6620 7465 7374 5f72 5f63  ync def test_r_c
-0001a220: 6861 6e67 655f 776f 726b 696e 675f 6469  hange_working_di
-0001a230: 7265 6374 6f72 795f 696e 5f63 6f64 6528  rectory_in_code(
-0001a240: 0a20 2020 2020 2020 2073 656c 662c 2063  .        self, c
-0001a250: 6c69 656e 743a 2054 6573 7443 6c69 656e  lient: TestClien
-0001a260: 742c 2073 7570 6572 7573 6572 5f74 6f6b  t, superuser_tok
-0001a270: 656e 5f68 6561 6465 7273 3a20 4469 6374  en_headers: Dict
-0001a280: 5b73 7472 2c20 7374 725d 0a20 2020 2029  [str, str].    )
-0001a290: 3a0a 2020 2020 2020 2020 6177 6169 7420  :.        await 
-0001a2a0: 7365 6c66 2e64 6f5f 7465 7374 5f63 6861  self.do_test_cha
-0001a2b0: 6e67 655f 776f 726b 696e 675f 6469 7265  nge_working_dire
-0001a2c0: 6374 6f72 795f 696e 5f63 6f64 6528 0a20  ctory_in_code(. 
-0001a2d0: 2020 2020 2020 2020 2020 2063 6c69 656e             clien
-0001a2e0: 742c 2073 7570 6572 7573 6572 5f74 6f6b  t, superuser_tok
-0001a2f0: 656e 5f68 6561 6465 7273 2c20 2269 7222  en_headers, "ir"
-0001a300: 2c20 2773 6574 7764 2822 7b6e 6577 5f77  , 'setwd("{new_w
-0001a310: 6f72 6b64 6972 7d22 2927 0a20 2020 2020  orkdir}")'.     
-0001a320: 2020 2029 0a0a 2020 2020 4070 7974 6573     )..    @pytes
-0001a330: 742e 6d61 726b 2e61 7379 6e63 696f 0a20  t.mark.asyncio. 
-0001a340: 2020 2061 7379 6e63 2064 6566 2074 6573     async def tes
-0001a350: 745f 6261 7368 5f63 6861 6e67 655f 776f  t_bash_change_wo
-0001a360: 726b 696e 675f 6469 7265 6374 6f72 795f  rking_directory_
-0001a370: 656e 6470 6f69 6e74 280a 2020 2020 2020  endpoint(.      
-0001a380: 2020 7365 6c66 2c20 636c 6965 6e74 3a20    self, client: 
-0001a390: 5465 7374 436c 6965 6e74 2c20 7375 7065  TestClient, supe
-0001a3a0: 7275 7365 725f 746f 6b65 6e5f 6865 6164  ruser_token_head
-0001a3b0: 6572 733a 2044 6963 745b 7374 722c 2073  ers: Dict[str, s
-0001a3c0: 7472 5d0a 2020 2020 293a 0a20 2020 2020  tr].    ):.     
-0001a3d0: 2020 2061 7761 6974 2073 656c 662e 646f     await self.do
-0001a3e0: 5f74 6573 745f 6368 616e 6765 5f77 6f72  _test_change_wor
-0001a3f0: 6b69 6e67 5f64 6972 6563 746f 7279 280a  king_directory(.
-0001a400: 2020 2020 2020 2020 2020 2020 636c 6965              clie
-0001a410: 6e74 2c20 7375 7065 7275 7365 725f 746f  nt, superuser_to
-0001a420: 6b65 6e5f 6865 6164 6572 732c 2022 6261  ken_headers, "ba
-0001a430: 7368 220a 2020 2020 2020 2020 290a 0a20  sh".        ).. 
-0001a440: 2020 2040 7079 7465 7374 2e6d 6172 6b2e     @pytest.mark.
-0001a450: 6173 796e 6369 6f0a 2020 2020 6173 796e  asyncio.    asyn
-0001a460: 6320 6465 6620 7465 7374 5f62 6173 685f  c def test_bash_
-0001a470: 6368 616e 6765 5f77 6f72 6b69 6e67 5f64  change_working_d
-0001a480: 6972 6563 746f 7279 5f69 6e5f 636f 6465  irectory_in_code
-0001a490: 280a 2020 2020 2020 2020 7365 6c66 2c20  (.        self, 
-0001a4a0: 636c 6965 6e74 3a20 5465 7374 436c 6965  client: TestClie
-0001a4b0: 6e74 2c20 7375 7065 7275 7365 725f 746f  nt, superuser_to
-0001a4c0: 6b65 6e5f 6865 6164 6572 733a 2044 6963  ken_headers: Dic
-0001a4d0: 745b 7374 722c 2073 7472 5d0a 2020 2020  t[str, str].    
-0001a4e0: 293a 0a20 2020 2020 2020 2061 7761 6974  ):.        await
-0001a4f0: 2073 656c 662e 646f 5f74 6573 745f 6368   self.do_test_ch
-0001a500: 616e 6765 5f77 6f72 6b69 6e67 5f64 6972  ange_working_dir
-0001a510: 6563 746f 7279 5f69 6e5f 636f 6465 280a  ectory_in_code(.
-0001a520: 2020 2020 2020 2020 2020 2020 636c 6965              clie
-0001a530: 6e74 2c20 7375 7065 7275 7365 725f 746f  nt, superuser_to
-0001a540: 6b65 6e5f 6865 6164 6572 732c 2022 6261  ken_headers, "ba
-0001a550: 7368 222c 2022 6364 207b 6e65 775f 776f  sh", "cd {new_wo
-0001a560: 726b 6469 727d 220a 2020 2020 2020 2020  rkdir}".        
-0001a570: 290a 0a20 2020 2040 7079 7465 7374 2e6d  )..    @pytest.m
-0001a580: 6172 6b2e 6173 796e 6369 6f0a 2020 2020  ark.asyncio.    
-0001a590: 6173 796e 6320 6465 6620 7465 7374 5f63  async def test_c
-0001a5a0: 6861 6e67 655f 776f 726b 696e 675f 6469  hange_working_di
-0001a5b0: 7265 6374 6f72 795f 6661 696c 5f69 6e76  rectory_fail_inv
-0001a5c0: 616c 6964 5f64 6972 6563 746f 7279 280a  alid_directory(.
-0001a5d0: 2020 2020 2020 2020 7365 6c66 2c20 636c          self, cl
-0001a5e0: 6965 6e74 3a20 5465 7374 436c 6965 6e74  ient: TestClient
-0001a5f0: 2c20 7375 7065 7275 7365 725f 746f 6b65  , superuser_toke
-0001a600: 6e5f 6865 6164 6572 733a 2044 6963 745b  n_headers: Dict[
-0001a610: 7374 722c 2073 7472 5d0a 2020 2020 293a  str, str].    ):
-0001a620: 0a20 2020 2020 2020 2077 6f72 6b69 6e67  .        working
-0001a630: 5f64 6972 6563 746f 7279 203d 2022 2f74  _directory = "/t
-0001a640: 6d70 220a 2020 2020 2020 2020 7265 736f  mp".        reso
-0001a650: 6c76 6564 5f77 6f72 6b5f 6469 7220 3d20  lved_work_dir = 
-0001a660: 7374 7228 7061 7468 6c69 622e 5061 7468  str(pathlib.Path
-0001a670: 2877 6f72 6b69 6e67 5f64 6972 6563 746f  (working_directo
-0001a680: 7279 292e 7265 736f 6c76 6528 2929 0a20  ry).resolve()). 
-0001a690: 2020 2020 2020 2072 6573 706f 6e73 6520         response 
-0001a6a0: 3d20 6177 6169 7420 636c 6965 6e74 2e70  = await client.p
-0001a6b0: 6f73 7428 0a20 2020 2020 2020 2020 2020  ost(.           
-0001a6c0: 2022 2f6e 6f74 6562 6f6f 6b73 2f63 7265   "/notebooks/cre
-0001a6d0: 6174 6522 2c0a 2020 2020 2020 2020 2020  ate",.          
-0001a6e0: 2020 7175 6572 795f 7374 7269 6e67 3d7b    query_string={
-0001a6f0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-0001a700: 2022 6b73 7065 635f 6e61 6d65 223a 2022   "kspec_name": "
-0001a710: 7079 7468 6f6e 222c 0a20 2020 2020 2020  python",.       
-0001a720: 2020 2020 2020 2020 2022 6669 6c65 6e61           "filena
-0001a730: 6d65 223a 2022 6865 7970 222c 0a20 2020  me": "heyp",.   
-0001a740: 2020 2020 2020 2020 2020 2020 2022 776f               "wo
-0001a750: 726b 696e 675f 6469 7265 6374 6f72 7922  rking_directory"
-0001a760: 3a20 776f 726b 696e 675f 6469 7265 6374  : working_direct
-0001a770: 6f72 792c 0a20 2020 2020 2020 2020 2020  ory,.           
-0001a780: 207d 2c0a 2020 2020 2020 2020 2020 2020   },.            
-0001a790: 6865 6164 6572 733d 7375 7065 7275 7365  headers=superuse
-0001a7a0: 725f 746f 6b65 6e5f 6865 6164 6572 732c  r_token_headers,
-0001a7b0: 0a20 2020 2020 2020 2029 0a20 2020 2020  .        ).     
-0001a7c0: 2020 2061 7373 6572 7420 7265 7370 6f6e     assert respon
-0001a7d0: 7365 2e73 7461 7475 735f 636f 6465 203d  se.status_code =
-0001a7e0: 3d20 3230 310a 2020 2020 2020 2020 7265  = 201.        re
-0001a7f0: 7370 5f6a 736f 6e20 3d20 7265 7370 6f6e  sp_json = respon
-0001a800: 7365 2e6a 736f 6e28 295b 226e 6f74 6562  se.json()["noteb
-0001a810: 6f6f 6b22 5d0a 2020 2020 2020 2020 7575  ook"].        uu
-0001a820: 6964 203d 2072 6573 705f 6a73 6f6e 5b22  id = resp_json["
-0001a830: 6d65 7461 6461 7461 225d 5b22 6a75 7079  metadata"]["jupy
-0001a840: 7465 725f 6431 225d 5b22 7575 6964 225d  ter_d1"]["uuid"]
-0001a850: 0a0a 2020 2020 2020 2020 746f 6b65 6e20  ..        token 
-0001a860: 3d20 6765 745f 7375 7065 7275 7365 725f  = get_superuser_
-0001a870: 746f 6b65 6e28 290a 2020 2020 2020 2020  token().        
-0001a880: 6175 7468 203d 2062 6173 6536 342e 6236  auth = base64.b6
-0001a890: 3465 6e63 6f64 6528 6622 7b74 6f6b 656e  4encode(f"{token
-0001a8a0: 7d3a 222e 656e 636f 6465 2822 7574 662d  }:".encode("utf-
-0001a8b0: 3822 2929 0a20 2020 2020 2020 2072 6573  8")).        res
-0001a8c0: 706f 6e73 6520 3d20 6177 6169 7420 636c  ponse = await cl
-0001a8d0: 6965 6e74 2e67 6574 280a 2020 2020 2020  ient.get(.      
-0001a8e0: 2020 2020 2020 6622 2f64 6176 7b72 6573        f"/dav{res
-0001a8f0: 6f6c 7665 645f 776f 726b 5f64 6972 7d22  olved_work_dir}"
-0001a900: 2c0a 2020 2020 2020 2020 2020 2020 6865  ,.            he
-0001a910: 6164 6572 733d 7b22 4175 7468 6f72 697a  aders={"Authoriz
-0001a920: 6174 696f 6e22 3a20 6622 4261 7369 6320  ation": f"Basic 
-0001a930: 7b61 7574 682e 6465 636f 6465 2827 7574  {auth.decode('ut
-0001a940: 662d 3827 297d 227d 2c0a 2020 2020 2020  f-8')}"},.      
-0001a950: 2020 290a 2020 2020 2020 2020 6173 7365    ).        asse
-0001a960: 7274 2072 6573 706f 6e73 652e 7374 6174  rt response.stat
-0001a970: 7573 5f63 6f64 6520 3d3d 2032 3030 0a0a  us_code == 200..
-0001a980: 2020 2020 2020 2020 6177 6169 7420 6173          await as
-0001a990: 796e 6369 6f2e 736c 6565 7028 5745 4253  yncio.sleep(WEBS
-0001a9a0: 4f43 4b45 545f 534c 4545 505f 5449 4d45  OCKET_SLEEP_TIME
-0001a9b0: 290a 0a20 2020 2020 2020 206e 6577 5f77  )..        new_w
-0001a9c0: 6f72 6b64 6972 203d 2066 227b 6f73 2e67  orkdir = f"{os.g
-0001a9d0: 6574 6377 6428 297d 2f74 6573 7473 2f6e  etcwd()}/tests/n
-0001a9e0: 6f74 7265 616c 6469 7222 0a20 2020 2020  otrealdir".     
-0001a9f0: 2020 2072 6573 706f 6e73 6520 3d20 6177     response = aw
-0001aa00: 6169 7420 636c 6965 6e74 2e70 6174 6368  ait client.patch
-0001aa10: 280a 2020 2020 2020 2020 2020 2020 6622  (.            f"
-0001aa20: 2f6e 6f74 6562 6f6f 6b73 2f7b 7575 6964  /notebooks/{uuid
-0001aa30: 7d2f 6368 616e 6765 5f77 6f72 6b69 6e67  }/change_working
-0001aa40: 5f64 6972 6563 746f 7279 222c 0a20 2020  _directory",.   
-0001aa50: 2020 2020 2020 2020 2068 6561 6465 7273           headers
-0001aa60: 3d73 7570 6572 7573 6572 5f74 6f6b 656e  =superuser_token
-0001aa70: 5f68 6561 6465 7273 2c0a 2020 2020 2020  _headers,.      
-0001aa80: 2020 2020 2020 7175 6572 795f 7374 7269        query_stri
-0001aa90: 6e67 3d7b 2264 6972 6563 746f 7279 223a  ng={"directory":
-0001aaa0: 206e 6577 5f77 6f72 6b64 6972 7d2c 0a20   new_workdir},. 
-0001aab0: 2020 2020 2020 2029 0a20 2020 2020 2020         ).       
-0001aac0: 2061 7373 6572 7420 7265 7370 6f6e 7365   assert response
-0001aad0: 2e73 7461 7475 735f 636f 6465 203d 3d20  .status_code == 
-0001aae0: 3430 340a 2020 2020 2020 2020 6173 7365  404.        asse
-0001aaf0: 7274 2072 6573 706f 6e73 652e 6a73 6f6e  rt response.json
-0001ab00: 2829 5b22 6465 7461 696c 225d 203d 3d20  ()["detail"] == 
-0001ab10: 2244 6972 6563 746f 7279 2064 6f65 7320  "Directory does 
-0001ab20: 6e6f 7420 6578 6973 7422 0a0a 2020 2020  not exist"..    
-0001ab30: 2020 2020 6177 6169 7420 6173 796e 6369      await asynci
-0001ab40: 6f2e 736c 6565 7028 3229 0a0a 2020 2020  o.sleep(2)..    
-0001ab50: 2020 2020 7265 7370 6f6e 7365 203d 2061      response = a
-0001ab60: 7761 6974 2063 6c69 656e 742e 6765 7428  wait client.get(
-0001ab70: 0a20 2020 2020 2020 2020 2020 2066 222f  .            f"/
-0001ab80: 6461 767b 6e65 775f 776f 726b 6469 727d  dav{new_workdir}
-0001ab90: 222c 0a20 2020 2020 2020 2020 2020 2068  ",.            h
-0001aba0: 6561 6465 7273 3d7b 2241 7574 686f 7269  eaders={"Authori
-0001abb0: 7a61 7469 6f6e 223a 2066 2242 6173 6963  zation": f"Basic
-0001abc0: 207b 6175 7468 2e64 6563 6f64 6528 2775   {auth.decode('u
-0001abd0: 7466 2d38 2729 7d22 7d2c 0a20 2020 2020  tf-8')}"},.     
-0001abe0: 2020 2029 0a20 2020 2020 2020 2061 7373     ).        ass
-0001abf0: 6572 7420 7265 7370 6f6e 7365 2e73 7461  ert response.sta
-0001ac00: 7475 735f 636f 6465 203d 3d20 3430 340a  tus_code == 404.
-0001ac10: 0a20 2020 2020 2020 2072 6573 706f 6e73  .        respons
-0001ac20: 6520 3d20 6177 6169 7420 636c 6965 6e74  e = await client
-0001ac30: 2e67 6574 280a 2020 2020 2020 2020 2020  .get(.          
-0001ac40: 2020 6622 2f64 6176 7b72 6573 6f6c 7665    f"/dav{resolve
-0001ac50: 645f 776f 726b 5f64 6972 7d22 2c0a 2020  d_work_dir}",.  
-0001ac60: 2020 2020 2020 2020 2020 6865 6164 6572            header
-0001ac70: 733d 7b22 4175 7468 6f72 697a 6174 696f  s={"Authorizatio
-0001ac80: 6e22 3a20 6622 4261 7369 6320 7b61 7574  n": f"Basic {aut
-0001ac90: 682e 6465 636f 6465 2827 7574 662d 3827  h.decode('utf-8'
-0001aca0: 297d 227d 2c0a 2020 2020 2020 2020 290a  )}"},.        ).
-0001acb0: 2020 2020 2020 2020 6173 7365 7274 2072          assert r
-0001acc0: 6573 706f 6e73 652e 7374 6174 7573 5f63  esponse.status_c
-0001acd0: 6f64 6520 3d3d 2032 3030 0a0a 2020 2020  ode == 200..    
-0001ace0: 2020 2020 7265 7370 6f6e 7365 203d 2061      response = a
-0001acf0: 7761 6974 2063 6c69 656e 742e 6765 7428  wait client.get(
-0001ad00: 0a20 2020 2020 2020 2020 2020 2066 222f  .            f"/
-0001ad10: 6e6f 7465 626f 6f6b 732f 7b75 7569 647d  notebooks/{uuid}
-0001ad20: 222c 2068 6561 6465 7273 3d73 7570 6572  ", headers=super
-0001ad30: 7573 6572 5f74 6f6b 656e 5f68 6561 6465  user_token_heade
-0001ad40: 7273 0a20 2020 2020 2020 2029 0a20 2020  rs.        ).   
-0001ad50: 2020 2020 2072 6573 705f 6a73 6f6e 203d       resp_json =
-0001ad60: 2072 6573 706f 6e73 652e 6a73 6f6e 2829   response.json()
-0001ad70: 5b22 6e6f 7465 626f 6f6b 225d 0a20 2020  ["notebook"].   
-0001ad80: 2020 2020 2061 7373 6572 7420 280a 2020       assert (.  
-0001ad90: 2020 2020 2020 2020 2020 7265 7370 5f6a            resp_j
-0001ada0: 736f 6e5b 226d 6574 6164 6174 6122 5d5b  son["metadata"][
-0001adb0: 226a 7570 7974 6572 5f64 3122 5d5b 2277  "jupyter_d1"]["w
-0001adc0: 6f72 6b69 6e67 5f64 6972 6563 746f 7279  orking_directory
-0001add0: 225d 0a20 2020 2020 2020 2020 2020 203d  "].            =
-0001ade0: 3d20 7265 736f 6c76 6564 5f77 6f72 6b5f  = resolved_work_
-0001adf0: 6469 720a 2020 2020 2020 2020 290a 0a0a  dir.        )...
-0001ae00: 4070 7974 6573 742e 6d61 726b 2e75 7365  @pytest.mark.use
-0001ae10: 6669 7874 7572 6573 280a 2020 2020 2263  fixtures(.    "c
-0001ae20: 6c65 6172 5f6e 6f74 6562 6f6f 6b73 222c  lear_notebooks",
-0001ae30: 2022 636c 6561 725f 6e6f 7465 626f 6f6b   "clear_notebook
-0001ae40: 5f64 6972 6563 746f 7279 222c 2022 636c  _directory", "cl
-0001ae50: 6561 725f 6e6f 7465 626f 6f6b 5f64 6972  ear_notebook_dir
-0001ae60: 6563 746f 7279 5f32 220a 290a 636c 6173  ectory_2".).clas
-0001ae70: 7320 5465 7374 5361 7665 4173 3a0a 2020  s TestSaveAs:.  
-0001ae80: 2020 4070 7974 6573 742e 6d61 726b 2e61    @pytest.mark.a
-0001ae90: 7379 6e63 696f 0a20 2020 2061 7379 6e63  syncio.    async
-0001aea0: 2064 6566 2074 6573 745f 7265 6e61 6d65   def test_rename
-0001aeb0: 280a 2020 2020 2020 2020 7365 6c66 2c20  (.        self, 
-0001aec0: 636c 6965 6e74 3a20 5465 7374 436c 6965  client: TestClie
-0001aed0: 6e74 2c20 7375 7065 7275 7365 725f 746f  nt, superuser_to
-0001aee0: 6b65 6e5f 6865 6164 6572 733a 2044 6963  ken_headers: Dic
-0001aef0: 745b 7374 722c 2073 7472 5d0a 2020 2020  t[str, str].    
-0001af00: 293a 0a20 2020 2020 2020 2075 7569 6420  ):.        uuid 
-0001af10: 3d20 6177 6169 7420 7570 6c6f 6164 5f6e  = await upload_n
-0001af20: 6f74 6562 6f6f 6b28 0a20 2020 2020 2020  otebook(.       
-0001af30: 2020 2020 2063 6c69 656e 742c 2073 7570       client, sup
-0001af40: 6572 7573 6572 5f74 6f6b 656e 5f68 6561  eruser_token_hea
-0001af50: 6465 7273 2c20 6669 6c65 6e61 6d65 3d22  ders, filename="
-0001af60: 7369 6d70 6c65 2e69 7079 6e62 220a 2020  simple.ipynb".  
-0001af70: 2020 2020 2020 290a 0a20 2020 2020 2020        )..       
-0001af80: 2061 7373 6572 7420 6f73 2e70 6174 682e   assert os.path.
-0001af90: 6578 6973 7473 2866 227b 7365 7474 696e  exists(f"{settin
-0001afa0: 6773 2e52 4f4f 545f 4449 527d 2f73 696d  gs.ROOT_DIR}/sim
-0001afb0: 706c 652e 6970 796e 6222 290a 2020 2020  ple.ipynb").    
-0001afc0: 2020 2020 6173 7365 7274 206e 6f74 206f      assert not o
-0001afd0: 732e 7061 7468 2e65 7869 7374 7328 6622  s.path.exists(f"
-0001afe0: 7b73 6574 7469 6e67 732e 524f 4f54 5f44  {settings.ROOT_D
-0001aff0: 4952 7d2f 6177 686f 6c65 6e65 776e 616d  IR}/awholenewnam
-0001b000: 652e 6970 796e 6222 290a 0a20 2020 2020  e.ipynb")..     
-0001b010: 2020 2061 7379 6e63 2077 6974 6820 636c     async with cl
-0001b020: 6965 6e74 2e77 6562 736f 636b 6574 5f63  ient.websocket_c
-0001b030: 6f6e 6e65 6374 280a 2020 2020 2020 2020  onnect(.        
-0001b040: 2020 2020 6622 2f6e 6f74 6562 6f6f 6b73      f"/notebooks
-0001b050: 2f7b 7575 6964 7d2f 7773 2f6e 6f74 6562  /{uuid}/ws/noteb
-0001b060: 6f6f 6b22 2c20 6865 6164 6572 733d 7375  ook", headers=su
-0001b070: 7065 7275 7365 725f 746f 6b65 6e5f 6865  peruser_token_he
-0001b080: 6164 6572 730a 2020 2020 2020 2020 2920  aders.        ) 
-0001b090: 6173 2077 6562 736f 636b 6574 3a0a 2020  as websocket:.  
-0001b0a0: 2020 2020 2020 2020 2020 7265 7370 6f6e            respon
-0001b0b0: 7365 203d 2061 7761 6974 2063 6c69 656e  se = await clien
-0001b0c0: 742e 7061 7463 6828 0a20 2020 2020 2020  t.patch(.       
-0001b0d0: 2020 2020 2020 2020 2066 222f 6e6f 7465           f"/note
-0001b0e0: 626f 6f6b 732f 7b75 7569 647d 2f72 656e  books/{uuid}/ren
-0001b0f0: 616d 6522 2c0a 2020 2020 2020 2020 2020  ame",.          
-0001b100: 2020 2020 2020 7175 6572 795f 7374 7269        query_stri
-0001b110: 6e67 3d7b 2266 696c 656e 616d 6522 3a20  ng={"filename": 
-0001b120: 2261 7768 6f6c 656e 6577 6e61 6d65 227d  "awholenewname"}
-0001b130: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
-0001b140: 2020 6865 6164 6572 733d 7375 7065 7275    headers=superu
-0001b150: 7365 725f 746f 6b65 6e5f 6865 6164 6572  ser_token_header
-0001b160: 732c 0a20 2020 2020 2020 2020 2020 2029  s,.            )
-0001b170: 0a20 2020 2020 2020 2020 2020 2061 7373  .            ass
-0001b180: 6572 7420 7265 7370 6f6e 7365 2e73 7461  ert response.sta
-0001b190: 7475 735f 636f 6465 203d 3d20 3230 300a  tus_code == 200.
-0001b1a0: 2020 2020 2020 2020 2020 2020 6173 7365              asse
-0001b1b0: 7274 2028 0a20 2020 2020 2020 2020 2020  rt (.           
-0001b1c0: 2020 2020 2072 6573 706f 6e73 652e 6a73       response.js
-0001b1d0: 6f6e 2829 5b22 7061 7468 225d 0a20 2020  on()["path"].   
-0001b1e0: 2020 2020 2020 2020 2020 2020 203d 3d20               == 
-0001b1f0: 6622 7b73 6574 7469 6e67 732e 524f 4f54  f"{settings.ROOT
-0001b200: 5f44 4952 7d2f 6177 686f 6c65 6e65 776e  _DIR}/awholenewn
-0001b210: 616d 652e 6970 796e 6222 0a20 2020 2020  ame.ipynb".     
-0001b220: 2020 2020 2020 2029 0a0a 2020 2020 2020         )..      
-0001b230: 2020 2020 2020 6461 7461 203d 2061 7761        data = awa
-0001b240: 6974 2072 6563 6569 7665 5f6a 736f 6e28  it receive_json(
-0001b250: 7765 6273 6f63 6b65 742c 206d 7367 5f74  websocket, msg_t
-0001b260: 7970 6573 3d5b 226d 6574 6164 6174 6122  ypes=["metadata"
-0001b270: 5d29 0a20 2020 2020 2020 2020 2020 206d  ]).            m
-0001b280: 6574 6164 6174 6120 3d20 6461 7461 5b22  etadata = data["
-0001b290: 6d65 7461 6461 7461 225d 0a20 2020 2020  metadata"].     
-0001b2a0: 2020 2020 2020 2061 7373 6572 7420 280a         assert (.
-0001b2b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001b2c0: 6d65 7461 6461 7461 5b22 6a75 7079 7465  metadata["jupyte
-0001b2d0: 725f 6431 225d 5b22 7061 7468 225d 0a20  r_d1"]["path"]. 
-0001b2e0: 2020 2020 2020 2020 2020 2020 2020 203d                 =
-0001b2f0: 3d20 6622 7b73 6574 7469 6e67 732e 524f  = f"{settings.RO
-0001b300: 4f54 5f44 4952 7d2f 6177 686f 6c65 6e65  OT_DIR}/awholene
-0001b310: 776e 616d 652e 6970 796e 6222 0a20 2020  wname.ipynb".   
-0001b320: 2020 2020 2020 2020 2029 0a20 2020 2020           ).     
-0001b330: 2020 2020 2020 2061 7373 6572 7420 6d65         assert me
-0001b340: 7461 6461 7461 5b22 6a75 7079 7465 725f  tadata["jupyter_
-0001b350: 6431 225d 5b22 6e61 6d65 225d 203d 3d20  d1"]["name"] == 
-0001b360: 2261 7768 6f6c 656e 6577 6e61 6d65 220a  "awholenewname".
-0001b370: 0a20 2020 2020 2020 2020 2020 2061 7373  .            ass
-0001b380: 6572 7420 6f73 2e70 6174 682e 6578 6973  ert os.path.exis
-0001b390: 7473 2866 227b 7365 7474 696e 6773 2e52  ts(f"{settings.R
-0001b3a0: 4f4f 545f 4449 527d 2f61 7768 6f6c 656e  OOT_DIR}/awholen
-0001b3b0: 6577 6e61 6d65 2e69 7079 6e62 2229 0a20  ewname.ipynb"). 
-0001b3c0: 2020 2020 2020 2020 2020 2061 7373 6572             asser
-0001b3d0: 7420 6e6f 7420 6f73 2e70 6174 682e 6578  t not os.path.ex
-0001b3e0: 6973 7473 2866 227b 7365 7474 696e 6773  ists(f"{settings
-0001b3f0: 2e52 4f4f 545f 4449 527d 2f73 696d 706c  .ROOT_DIR}/simpl
-0001b400: 652e 6970 796e 6222 290a 0a20 2020 2040  e.ipynb")..    @
-0001b410: 7079 7465 7374 2e6d 6172 6b2e 6173 796e  pytest.mark.asyn
-0001b420: 6369 6f0a 2020 2020 6173 796e 6320 6465  cio.    async de
-0001b430: 6620 7465 7374 5f72 656e 616d 655f 6469  f test_rename_di
-0001b440: 6666 6572 656e 745f 6469 7265 6374 6f72  fferent_director
-0001b450: 7928 0a20 2020 2020 2020 2073 656c 662c  y(.        self,
-0001b460: 2063 6c69 656e 743a 2054 6573 7443 6c69   client: TestCli
-0001b470: 656e 742c 2073 7570 6572 7573 6572 5f74  ent, superuser_t
-0001b480: 6f6b 656e 5f68 6561 6465 7273 3a20 4469  oken_headers: Di
-0001b490: 6374 5b73 7472 2c20 7374 725d 0a20 2020  ct[str, str].   
-0001b4a0: 2029 3a0a 2020 2020 2020 2020 7575 6964   ):.        uuid
-0001b4b0: 203d 2061 7761 6974 2075 706c 6f61 645f   = await upload_
-0001b4c0: 6e6f 7465 626f 6f6b 280a 2020 2020 2020  notebook(.      
-0001b4d0: 2020 2020 2020 636c 6965 6e74 2c20 7375        client, su
-0001b4e0: 7065 7275 7365 725f 746f 6b65 6e5f 6865  peruser_token_he
-0001b4f0: 6164 6572 732c 2066 696c 656e 616d 653d  aders, filename=
-0001b500: 2273 696d 706c 652e 6970 796e 6222 0a20  "simple.ipynb". 
-0001b510: 2020 2020 2020 2029 0a0a 2020 2020 2020         )..      
-0001b520: 2020 6173 7365 7274 206f 732e 7061 7468    assert os.path
-0001b530: 2e65 7869 7374 7328 6622 7b73 6574 7469  .exists(f"{setti
-0001b540: 6e67 732e 524f 4f54 5f44 4952 7d2f 7369  ngs.ROOT_DIR}/si
-0001b550: 6d70 6c65 2e69 7079 6e62 2229 0a20 2020  mple.ipynb").   
-0001b560: 2020 2020 2061 7373 6572 7420 6e6f 7420       assert not 
-0001b570: 6f73 2e70 6174 682e 6578 6973 7473 2866  os.path.exists(f
-0001b580: 227b 776f 726b 6469 725f 317d 2f61 7768  "{workdir_1}/awh
-0001b590: 6f6c 656e 6577 6e61 6d65 2e69 7079 6e62  olenewname.ipynb
-0001b5a0: 2229 0a0a 2020 2020 2020 2020 6173 796e  ")..        asyn
-0001b5b0: 6320 7769 7468 2063 6c69 656e 742e 7765  c with client.we
-0001b5c0: 6273 6f63 6b65 745f 636f 6e6e 6563 7428  bsocket_connect(
-0001b5d0: 0a20 2020 2020 2020 2020 2020 2066 222f  .            f"/
-0001b5e0: 6e6f 7465 626f 6f6b 732f 7b75 7569 647d  notebooks/{uuid}
-0001b5f0: 2f77 732f 6e6f 7465 626f 6f6b 222c 2068  /ws/notebook", h
-0001b600: 6561 6465 7273 3d73 7570 6572 7573 6572  eaders=superuser
-0001b610: 5f74 6f6b 656e 5f68 6561 6465 7273 0a20  _token_headers. 
-0001b620: 2020 2020 2020 2029 2061 7320 7765 6273         ) as webs
-0001b630: 6f63 6b65 743a 0a20 2020 2020 2020 2020  ocket:.         
-0001b640: 2020 2072 6573 706f 6e73 6520 3d20 6177     response = aw
-0001b650: 6169 7420 636c 6965 6e74 2e70 6174 6368  ait client.patch
-0001b660: 280a 2020 2020 2020 2020 2020 2020 2020  (.              
-0001b670: 2020 6622 2f6e 6f74 6562 6f6f 6b73 2f7b    f"/notebooks/{
-0001b680: 7575 6964 7d2f 7265 6e61 6d65 222c 0a20  uuid}/rename",. 
-0001b690: 2020 2020 2020 2020 2020 2020 2020 2071                 q
-0001b6a0: 7565 7279 5f73 7472 696e 673d 7b0a 2020  uery_string={.  
-0001b6b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001b6c0: 2020 2266 696c 656e 616d 6522 3a20 2261    "filename": "a
-0001b6d0: 7768 6f6c 656e 6577 6e61 6d65 222c 0a20  wholenewname",. 
-0001b6e0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001b6f0: 2020 2022 6469 7265 6374 6f72 7922 3a20     "directory": 
-0001b700: 222f 746d 702f 7465 7374 5f6e 625f 322f  "/tmp/test_nb_2/
-0001b710: 222c 0a20 2020 2020 2020 2020 2020 2020  ",.             
-0001b720: 2020 207d 2c0a 2020 2020 2020 2020 2020     },.          
-0001b730: 2020 2020 2020 6865 6164 6572 733d 7375        headers=su
-0001b740: 7065 7275 7365 725f 746f 6b65 6e5f 6865  peruser_token_he
-0001b750: 6164 6572 732c 0a20 2020 2020 2020 2020  aders,.         
-0001b760: 2020 2029 0a20 2020 2020 2020 2020 2020     ).           
-0001b770: 2061 7373 6572 7420 7265 7370 6f6e 7365   assert response
-0001b780: 2e73 7461 7475 735f 636f 6465 203d 3d20  .status_code == 
-0001b790: 3230 300a 2020 2020 2020 2020 2020 2020  200.            
-0001b7a0: 6173 7365 7274 2028 0a20 2020 2020 2020  assert (.       
-0001b7b0: 2020 2020 2020 2020 2072 6573 706f 6e73           respons
-0001b7c0: 652e 6a73 6f6e 2829 5b22 7061 7468 225d  e.json()["path"]
-0001b7d0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-0001b7e0: 203d 3d20 6622 2f74 6d70 2f74 6573 745f   == f"/tmp/test_
-0001b7f0: 6e62 5f32 2f61 7768 6f6c 656e 6577 6e61  nb_2/awholenewna
-0001b800: 6d65 2e69 7079 6e62 220a 2020 2020 2020  me.ipynb".      
-0001b810: 2020 2020 2020 290a 0a20 2020 2020 2020        )..       
-0001b820: 2020 2020 2064 6174 6120 3d20 6177 6169       data = awai
-0001b830: 7420 7265 6365 6976 655f 6a73 6f6e 2877  t receive_json(w
-0001b840: 6562 736f 636b 6574 2c20 6d73 675f 7479  ebsocket, msg_ty
-0001b850: 7065 733d 5b22 6d65 7461 6461 7461 225d  pes=["metadata"]
-0001b860: 290a 2020 2020 2020 2020 2020 2020 6d65  ).            me
-0001b870: 7461 6461 7461 203d 2064 6174 615b 226d  tadata = data["m
-0001b880: 6574 6164 6174 6122 5d0a 2020 2020 2020  etadata"].      
-0001b890: 2020 2020 2020 6173 7365 7274 2028 0a20        assert (. 
-0001b8a0: 2020 2020 2020 2020 2020 2020 2020 206d                 m
-0001b8b0: 6574 6164 6174 615b 226a 7570 7974 6572  etadata["jupyter
-0001b8c0: 5f64 3122 5d5b 2270 6174 6822 5d0a 2020  _d1"]["path"].  
-0001b8d0: 2020 2020 2020 2020 2020 2020 2020 3d3d                ==
-0001b8e0: 2066 227b 776f 726b 6469 725f 317d 2f61   f"{workdir_1}/a
-0001b8f0: 7768 6f6c 656e 6577 6e61 6d65 2e69 7079  wholenewname.ipy
-0001b900: 6e62 220a 2020 2020 2020 2020 2020 2020  nb".            
-0001b910: 290a 2020 2020 2020 2020 2020 2020 6173  ).            as
-0001b920: 7365 7274 206d 6574 6164 6174 615b 226a  sert metadata["j
-0001b930: 7570 7974 6572 5f64 3122 5d5b 226e 616d  upyter_d1"]["nam
-0001b940: 6522 5d20 3d3d 2022 6177 686f 6c65 6e65  e"] == "awholene
-0001b950: 776e 616d 6522 0a0a 2020 2020 2020 2020  wname"..        
-0001b960: 2020 2020 6173 7365 7274 206f 732e 7061      assert os.pa
-0001b970: 7468 2e65 7869 7374 7328 6622 7b77 6f72  th.exists(f"{wor
-0001b980: 6b64 6972 5f31 7d2f 6177 686f 6c65 6e65  kdir_1}/awholene
-0001b990: 776e 616d 652e 6970 796e 6222 290a 2020  wname.ipynb").  
-0001b9a0: 2020 2020 2020 2020 2020 6173 7365 7274            assert
-0001b9b0: 206e 6f74 206f 732e 7061 7468 2e65 7869   not os.path.exi
-0001b9c0: 7374 7328 6622 7b73 6574 7469 6e67 732e  sts(f"{settings.
-0001b9d0: 524f 4f54 5f44 4952 7d2f 7369 6d70 6c65  ROOT_DIR}/simple
-0001b9e0: 2e69 7079 6e62 2229 0a0a 2020 2020 4070  .ipynb")..    @p
-0001b9f0: 7974 6573 742e 6d61 726b 2e61 7379 6e63  ytest.mark.async
-0001ba00: 696f 0a20 2020 2061 7379 6e63 2064 6566  io.    async def
-0001ba10: 2074 6573 745f 7265 6e61 6d65 5f66 696c   test_rename_fil
-0001ba20: 655f 6578 6973 7473 280a 2020 2020 2020  e_exists(.      
-0001ba30: 2020 7365 6c66 2c20 636c 6965 6e74 3a20    self, client: 
-0001ba40: 5465 7374 436c 6965 6e74 2c20 7375 7065  TestClient, supe
-0001ba50: 7275 7365 725f 746f 6b65 6e5f 6865 6164  ruser_token_head
-0001ba60: 6572 733a 2044 6963 745b 7374 722c 2073  ers: Dict[str, s
-0001ba70: 7472 5d0a 2020 2020 293a 0a20 2020 2020  tr].    ):.     
-0001ba80: 2020 2022 2222 4661 696c 2069 6620 6669     """Fail if fi
-0001ba90: 6c65 2065 7869 7374 7320 756e 6c65 7373  le exists unless
-0001baa0: 206f 7665 7277 7269 7465 2070 6172 616d   overwrite param
-0001bab0: 2069 7320 7365 7420 746f 2074 7275 6522   is set to true"
-0001bac0: 2222 0a20 2020 2020 2020 2075 7569 6420  "".        uuid 
-0001bad0: 3d20 6177 6169 7420 7570 6c6f 6164 5f6e  = await upload_n
-0001bae0: 6f74 6562 6f6f 6b28 0a20 2020 2020 2020  otebook(.       
-0001baf0: 2020 2020 2063 6c69 656e 742c 2073 7570       client, sup
-0001bb00: 6572 7573 6572 5f74 6f6b 656e 5f68 6561  eruser_token_hea
-0001bb10: 6465 7273 2c20 6669 6c65 6e61 6d65 3d22  ders, filename="
-0001bb20: 7369 6d70 6c65 2e69 7079 6e62 220a 2020  simple.ipynb".  
-0001bb30: 2020 2020 2020 290a 0a20 2020 2020 2020        )..       
-0001bb40: 2077 6974 6820 6f70 656e 2866 227b 776f   with open(f"{wo
-0001bb50: 726b 6469 725f 317d 2f61 7768 6f6c 656e  rkdir_1}/awholen
-0001bb60: 6577 6e61 6d65 2e69 7079 6e62 222c 2022  ewname.ipynb", "
-0001bb70: 7722 2920 6173 2066 3a0a 2020 2020 2020  w") as f:.      
-0001bb80: 2020 2020 2020 662e 7772 6974 6528 2273        f.write("s
-0001bb90: 6f6d 6520 7465 7874 2068 6572 6522 290a  ome text here").
-0001bba0: 0a20 2020 2020 2020 2061 7373 6572 7420  .        assert 
-0001bbb0: 6f73 2e70 6174 682e 6578 6973 7473 2866  os.path.exists(f
-0001bbc0: 227b 7365 7474 696e 6773 2e52 4f4f 545f  "{settings.ROOT_
-0001bbd0: 4449 527d 2f73 696d 706c 652e 6970 796e  DIR}/simple.ipyn
-0001bbe0: 6222 290a 2020 2020 2020 2020 6173 7365  b").        asse
-0001bbf0: 7274 206f 732e 7061 7468 2e65 7869 7374  rt os.path.exist
-0001bc00: 7328 6622 7b77 6f72 6b64 6972 5f31 7d2f  s(f"{workdir_1}/
-0001bc10: 6177 686f 6c65 6e65 776e 616d 652e 6970  awholenewname.ip
-0001bc20: 796e 6222 290a 0a20 2020 2020 2020 2061  ynb")..        a
-0001bc30: 7379 6e63 2077 6974 6820 636c 6965 6e74  sync with client
-0001bc40: 2e77 6562 736f 636b 6574 5f63 6f6e 6e65  .websocket_conne
-0001bc50: 6374 280a 2020 2020 2020 2020 2020 2020  ct(.            
-0001bc60: 6622 2f6e 6f74 6562 6f6f 6b73 2f7b 7575  f"/notebooks/{uu
-0001bc70: 6964 7d2f 7773 2f6e 6f74 6562 6f6f 6b22  id}/ws/notebook"
-0001bc80: 2c20 6865 6164 6572 733d 7375 7065 7275  , headers=superu
-0001bc90: 7365 725f 746f 6b65 6e5f 6865 6164 6572  ser_token_header
-0001bca0: 730a 2020 2020 2020 2020 2920 6173 2077  s.        ) as w
-0001bcb0: 6562 736f 636b 6574 3a0a 2020 2020 2020  ebsocket:.      
-0001bcc0: 2020 2020 2020 7265 7370 6f6e 7365 203d        response =
-0001bcd0: 2061 7761 6974 2063 6c69 656e 742e 7061   await client.pa
-0001bce0: 7463 6828 0a20 2020 2020 2020 2020 2020  tch(.           
-0001bcf0: 2020 2020 2066 222f 6e6f 7465 626f 6f6b       f"/notebook
-0001bd00: 732f 7b75 7569 647d 2f72 656e 616d 6522  s/{uuid}/rename"
-0001bd10: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
-0001bd20: 2020 7175 6572 795f 7374 7269 6e67 3d7b    query_string={
-0001bd30: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-0001bd40: 2020 2020 2022 6669 6c65 6e61 6d65 223a       "filename":
-0001bd50: 2022 6177 686f 6c65 6e65 776e 616d 6522   "awholenewname"
-0001bd60: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
-0001bd70: 2020 2020 2020 2264 6972 6563 746f 7279        "directory
-0001bd80: 223a 2022 2f74 6d70 2f74 6573 745f 6e62  ": "/tmp/test_nb
-0001bd90: 5f32 2f22 2c0a 2020 2020 2020 2020 2020  _2/",.          
-0001bda0: 2020 2020 2020 7d2c 0a20 2020 2020 2020        },.       
-0001bdb0: 2020 2020 2020 2020 2068 6561 6465 7273           headers
-0001bdc0: 3d73 7570 6572 7573 6572 5f74 6f6b 656e  =superuser_token
-0001bdd0: 5f68 6561 6465 7273 2c0a 2020 2020 2020  _headers,.      
-0001bde0: 2020 2020 2020 290a 2020 2020 2020 2020        ).        
-0001bdf0: 2020 2020 6173 7365 7274 2072 6573 706f      assert respo
-0001be00: 6e73 652e 7374 6174 7573 5f63 6f64 6520  nse.status_code 
-0001be10: 3d3d 2034 3030 0a20 2020 2020 2020 2020  == 400.         
-0001be20: 2020 2061 7373 6572 7420 7265 7370 6f6e     assert respon
-0001be30: 7365 2e6a 736f 6e28 295b 2264 6574 6169  se.json()["detai
-0001be40: 6c22 5d20 3d3d 2066 2246 696c 6520 616c  l"] == f"File al
-0001be50: 7265 6164 7920 6578 6973 7473 220a 0a20  ready exists".. 
-0001be60: 2020 2020 2020 2020 2020 2072 6573 706f             respo
-0001be70: 6e73 6520 3d20 6177 6169 7420 636c 6965  nse = await clie
-0001be80: 6e74 2e70 6174 6368 280a 2020 2020 2020  nt.patch(.      
-0001be90: 2020 2020 2020 2020 2020 6622 2f6e 6f74            f"/not
-0001bea0: 6562 6f6f 6b73 2f7b 7575 6964 7d2f 7265  ebooks/{uuid}/re
-0001beb0: 6e61 6d65 222c 0a20 2020 2020 2020 2020  name",.         
-0001bec0: 2020 2020 2020 2071 7565 7279 5f73 7472         query_str
-0001bed0: 696e 673d 7b0a 2020 2020 2020 2020 2020  ing={.          
-0001bee0: 2020 2020 2020 2020 2020 2266 696c 656e            "filen
-0001bef0: 616d 6522 3a20 2261 7768 6f6c 656e 6577  ame": "awholenew
-0001bf00: 6e61 6d65 222c 0a20 2020 2020 2020 2020  name",.         
-0001bf10: 2020 2020 2020 2020 2020 2022 6469 7265             "dire
-0001bf20: 6374 6f72 7922 3a20 222f 746d 702f 7465  ctory": "/tmp/te
-0001bf30: 7374 5f6e 625f 322f 222c 0a20 2020 2020  st_nb_2/",.     
-0001bf40: 2020 2020 2020 2020 2020 2020 2020 2022                 "
-0001bf50: 6f76 6572 7772 6974 6522 3a20 5472 7565  overwrite": True
-0001bf60: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
-0001bf70: 2020 7d2c 0a20 2020 2020 2020 2020 2020    },.           
-0001bf80: 2020 2020 2068 6561 6465 7273 3d73 7570       headers=sup
-0001bf90: 6572 7573 6572 5f74 6f6b 656e 5f68 6561  eruser_token_hea
-0001bfa0: 6465 7273 2c0a 2020 2020 2020 2020 2020  ders,.          
-0001bfb0: 2020 290a 2020 2020 2020 2020 2020 2020    ).            
-0001bfc0: 6173 7365 7274 2072 6573 706f 6e73 652e  assert response.
-0001bfd0: 7374 6174 7573 5f63 6f64 6520 3d3d 2032  status_code == 2
-0001bfe0: 3030 0a20 2020 2020 2020 2020 2020 2061  00.            a
-0001bff0: 7373 6572 7420 280a 2020 2020 2020 2020  ssert (.        
-0001c000: 2020 2020 2020 2020 7265 7370 6f6e 7365          response
-0001c010: 2e6a 736f 6e28 295b 2270 6174 6822 5d0a  .json()["path"].
-0001c020: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001c030: 3d3d 2066 222f 746d 702f 7465 7374 5f6e  == f"/tmp/test_n
-0001c040: 625f 322f 6177 686f 6c65 6e65 776e 616d  b_2/awholenewnam
-0001c050: 652e 6970 796e 6222 0a20 2020 2020 2020  e.ipynb".       
-0001c060: 2020 2020 2029 0a0a 2020 2020 2020 2020       )..        
-0001c070: 2020 2020 6461 7461 203d 2061 7761 6974      data = await
-0001c080: 2072 6563 6569 7665 5f6a 736f 6e28 7765   receive_json(we
-0001c090: 6273 6f63 6b65 742c 206d 7367 5f74 7970  bsocket, msg_typ
-0001c0a0: 6573 3d5b 226d 6574 6164 6174 6122 5d29  es=["metadata"])
-0001c0b0: 0a20 2020 2020 2020 2020 2020 206d 6574  .            met
-0001c0c0: 6164 6174 6120 3d20 6461 7461 5b22 6d65  adata = data["me
-0001c0d0: 7461 6461 7461 225d 0a20 2020 2020 2020  tadata"].       
-0001c0e0: 2020 2020 2061 7373 6572 7420 280a 2020       assert (.  
-0001c0f0: 2020 2020 2020 2020 2020 2020 2020 6d65                me
-0001c100: 7461 6461 7461 5b22 6a75 7079 7465 725f  tadata["jupyter_
-0001c110: 6431 225d 5b22 7061 7468 225d 0a20 2020  d1"]["path"].   
-0001c120: 2020 2020 2020 2020 2020 2020 203d 3d20               == 
-0001c130: 6622 7b77 6f72 6b64 6972 5f31 7d2f 6177  f"{workdir_1}/aw
-0001c140: 686f 6c65 6e65 776e 616d 652e 6970 796e  holenewname.ipyn
-0001c150: 6222 0a20 2020 2020 2020 2020 2020 2029  b".            )
-0001c160: 0a20 2020 2020 2020 2020 2020 2061 7373  .            ass
-0001c170: 6572 7420 6d65 7461 6461 7461 5b22 6a75  ert metadata["ju
-0001c180: 7079 7465 725f 6431 225d 5b22 6e61 6d65  pyter_d1"]["name
-0001c190: 225d 203d 3d20 2261 7768 6f6c 656e 6577  "] == "awholenew
-0001c1a0: 6e61 6d65 220a 0a20 2020 2020 2020 2020  name"..         
-0001c1b0: 2020 2061 7373 6572 7420 6f73 2e70 6174     assert os.pat
-0001c1c0: 682e 6578 6973 7473 2866 227b 776f 726b  h.exists(f"{work
-0001c1d0: 6469 725f 317d 2f61 7768 6f6c 656e 6577  dir_1}/awholenew
-0001c1e0: 6e61 6d65 2e69 7079 6e62 2229 0a20 2020  name.ipynb").   
-0001c1f0: 2020 2020 2020 2020 2061 7373 6572 7420           assert 
-0001c200: 6e6f 7420 6f73 2e70 6174 682e 6578 6973  not os.path.exis
-0001c210: 7473 2866 227b 7365 7474 696e 6773 2e52  ts(f"{settings.R
-0001c220: 4f4f 545f 4449 527d 2f73 696d 706c 652e  OOT_DIR}/simple.
-0001c230: 6970 796e 6222 290a 0a20 2020 2020 2020  ipynb")..       
-0001c240: 2077 6974 6820 6f70 656e 2866 227b 776f   with open(f"{wo
-0001c250: 726b 6469 725f 317d 2f61 7768 6f6c 656e  rkdir_1}/awholen
-0001c260: 6577 6e61 6d65 2e69 7079 6e62 222c 2022  ewname.ipynb", "
-0001c270: 7222 2920 6173 2066 3a0a 2020 2020 2020  r") as f:.      
-0001c280: 2020 2020 2020 6173 7365 7274 2066 2e72        assert f.r
-0001c290: 6561 6428 2920 213d 2022 736f 6d65 2074  ead() != "some t
-0001c2a0: 6578 7420 6865 7265 220a 0a20 2020 2040  ext here"..    @
-0001c2b0: 7079 7465 7374 2e6d 6172 6b2e 6173 796e  pytest.mark.asyn
-0001c2c0: 6369 6f0a 2020 2020 6173 796e 6320 6465  cio.    async de
-0001c2d0: 6620 7465 7374 5f72 656e 616d 655f 6a75  f test_rename_ju
-0001c2e0: 7374 5f6d 6574 6164 6174 6128 0a20 2020  st_metadata(.   
-0001c2f0: 2020 2020 2073 656c 662c 2063 6c69 656e       self, clien
-0001c300: 743a 2054 6573 7443 6c69 656e 742c 2073  t: TestClient, s
-0001c310: 7570 6572 7573 6572 5f74 6f6b 656e 5f68  uperuser_token_h
-0001c320: 6561 6465 7273 3a20 4469 6374 5b73 7472  eaders: Dict[str
-0001c330: 2c20 7374 725d 0a20 2020 2029 3a0a 2020  , str].    ):.  
-0001c340: 2020 2020 2020 7575 6964 203d 2061 7761        uuid = awa
-0001c350: 6974 2075 706c 6f61 645f 6e6f 7465 626f  it upload_notebo
-0001c360: 6f6b 280a 2020 2020 2020 2020 2020 2020  ok(.            
-0001c370: 636c 6965 6e74 2c20 7375 7065 7275 7365  client, superuse
-0001c380: 725f 746f 6b65 6e5f 6865 6164 6572 732c  r_token_headers,
-0001c390: 2066 696c 656e 616d 653d 2273 696d 706c   filename="simpl
-0001c3a0: 652e 6970 796e 6222 0a20 2020 2020 2020  e.ipynb".       
-0001c3b0: 2029 0a0a 2020 2020 2020 2020 6173 7365   )..        asse
-0001c3c0: 7274 206f 732e 7061 7468 2e65 7869 7374  rt os.path.exist
-0001c3d0: 7328 6622 7b73 6574 7469 6e67 732e 524f  s(f"{settings.RO
-0001c3e0: 4f54 5f44 4952 7d2f 7369 6d70 6c65 2e69  OT_DIR}/simple.i
-0001c3f0: 7079 6e62 2229 0a20 2020 2020 2020 2061  pynb").        a
-0001c400: 7373 6572 7420 6e6f 7420 6f73 2e70 6174  ssert not os.pat
-0001c410: 682e 6578 6973 7473 2866 227b 776f 726b  h.exists(f"{work
-0001c420: 6469 725f 317d 2f61 7768 6f6c 656e 6577  dir_1}/awholenew
-0001c430: 6e61 6d65 2e69 7079 6e62 2229 0a0a 2020  name.ipynb")..  
-0001c440: 2020 2020 2020 6173 796e 6320 7769 7468        async with
-0001c450: 2063 6c69 656e 742e 7765 6273 6f63 6b65   client.websocke
-0001c460: 745f 636f 6e6e 6563 7428 0a20 2020 2020  t_connect(.     
-0001c470: 2020 2020 2020 2066 222f 6e6f 7465 626f         f"/notebo
-0001c480: 6f6b 732f 7b75 7569 647d 2f77 732f 6e6f  oks/{uuid}/ws/no
-0001c490: 7465 626f 6f6b 222c 2068 6561 6465 7273  tebook", headers
-0001c4a0: 3d73 7570 6572 7573 6572 5f74 6f6b 656e  =superuser_token
-0001c4b0: 5f68 6561 6465 7273 0a20 2020 2020 2020  _headers.       
-0001c4c0: 2029 2061 7320 7765 6273 6f63 6b65 743a   ) as websocket:
-0001c4d0: 0a20 2020 2020 2020 2020 2020 2072 6573  .            res
-0001c4e0: 706f 6e73 6520 3d20 6177 6169 7420 636c  ponse = await cl
-0001c4f0: 6965 6e74 2e70 6174 6368 280a 2020 2020  ient.patch(.    
-0001c500: 2020 2020 2020 2020 2020 2020 6622 2f6e              f"/n
-0001c510: 6f74 6562 6f6f 6b73 2f7b 7575 6964 7d2f  otebooks/{uuid}/
-0001c520: 7265 6e61 6d65 222c 0a20 2020 2020 2020  rename",.       
-0001c530: 2020 2020 2020 2020 2071 7565 7279 5f73           query_s
-0001c540: 7472 696e 673d 7b0a 2020 2020 2020 2020  tring={.        
-0001c550: 2020 2020 2020 2020 2020 2020 2266 696c              "fil
-0001c560: 656e 616d 6522 3a20 2261 7768 6f6c 656e  ename": "awholen
-0001c570: 6577 6e61 6d65 222c 0a20 2020 2020 2020  ewname",.       
-0001c580: 2020 2020 2020 2020 2020 2020 2022 6469               "di
-0001c590: 7265 6374 6f72 7922 3a20 222f 746d 702f  rectory": "/tmp/
-0001c5a0: 7465 7374 5f6e 625f 322f 222c 0a20 2020  test_nb_2/",.   
-0001c5b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001c5c0: 2022 6a75 7374 5f6d 6574 6164 6174 6122   "just_metadata"
-0001c5d0: 3a20 5472 7565 2c0a 2020 2020 2020 2020  : True,.        
-0001c5e0: 2020 2020 2020 2020 7d2c 0a20 2020 2020          },.     
-0001c5f0: 2020 2020 2020 2020 2020 2068 6561 6465             heade
-0001c600: 7273 3d73 7570 6572 7573 6572 5f74 6f6b  rs=superuser_tok
-0001c610: 656e 5f68 6561 6465 7273 2c0a 2020 2020  en_headers,.    
-0001c620: 2020 2020 2020 2020 290a 2020 2020 2020          ).      
-0001c630: 2020 2020 2020 6173 7365 7274 2072 6573        assert res
-0001c640: 706f 6e73 652e 7374 6174 7573 5f63 6f64  ponse.status_cod
-0001c650: 6520 3d3d 2032 3030 0a20 2020 2020 2020  e == 200.       
-0001c660: 2020 2020 2061 7373 6572 7420 280a 2020       assert (.  
-0001c670: 2020 2020 2020 2020 2020 2020 2020 7265                re
-0001c680: 7370 6f6e 7365 2e6a 736f 6e28 295b 2270  sponse.json()["p
-0001c690: 6174 6822 5d0a 2020 2020 2020 2020 2020  ath"].          
-0001c6a0: 2020 2020 2020 3d3d 2066 222f 746d 702f        == f"/tmp/
-0001c6b0: 7465 7374 5f6e 625f 322f 6177 686f 6c65  test_nb_2/awhole
-0001c6c0: 6e65 776e 616d 652e 6970 796e 6222 0a20  newname.ipynb". 
-0001c6d0: 2020 2020 2020 2020 2020 2029 0a0a 2020             )..  
-0001c6e0: 2020 2020 2020 2020 2020 6461 7461 203d            data =
-0001c6f0: 2061 7761 6974 2072 6563 6569 7665 5f6a   await receive_j
-0001c700: 736f 6e28 7765 6273 6f63 6b65 742c 206d  son(websocket, m
-0001c710: 7367 5f74 7970 6573 3d5b 226d 6574 6164  sg_types=["metad
-0001c720: 6174 6122 5d29 0a20 2020 2020 2020 2020  ata"]).         
-0001c730: 2020 206d 6574 6164 6174 6120 3d20 6461     metadata = da
-0001c740: 7461 5b22 6d65 7461 6461 7461 225d 0a20  ta["metadata"]. 
-0001c750: 2020 2020 2020 2020 2020 2061 7373 6572             asser
-0001c760: 7420 280a 2020 2020 2020 2020 2020 2020  t (.            
-0001c770: 2020 2020 6d65 7461 6461 7461 5b22 6a75      metadata["ju
-0001c780: 7079 7465 725f 6431 225d 5b22 7061 7468  pyter_d1"]["path
-0001c790: 225d 0a20 2020 2020 2020 2020 2020 2020  "].             
-0001c7a0: 2020 203d 3d20 6622 7b77 6f72 6b64 6972     == f"{workdir
-0001c7b0: 5f31 7d2f 6177 686f 6c65 6e65 776e 616d  _1}/awholenewnam
-0001c7c0: 652e 6970 796e 6222 0a20 2020 2020 2020  e.ipynb".       
-0001c7d0: 2020 2020 2029 0a20 2020 2020 2020 2020       ).         
-0001c7e0: 2020 2061 7373 6572 7420 6d65 7461 6461     assert metada
-0001c7f0: 7461 5b22 6a75 7079 7465 725f 6431 225d  ta["jupyter_d1"]
-0001c800: 5b22 6e61 6d65 225d 203d 3d20 2261 7768  ["name"] == "awh
-0001c810: 6f6c 656e 6577 6e61 6d65 220a 0a20 2020  olenewname"..   
-0001c820: 2020 2020 2020 2020 2061 7373 6572 7420           assert 
-0001c830: 6e6f 7420 6f73 2e70 6174 682e 6578 6973  not os.path.exis
-0001c840: 7473 2866 227b 776f 726b 6469 725f 317d  ts(f"{workdir_1}
-0001c850: 2f61 7768 6f6c 656e 6577 6e61 6d65 2e69  /awholenewname.i
-0001c860: 7079 6e62 2229 0a20 2020 2020 2020 2020  pynb").         
-0001c870: 2020 2061 7373 6572 7420 6f73 2e70 6174     assert os.pat
-0001c880: 682e 6578 6973 7473 2866 227b 7365 7474  h.exists(f"{sett
-0001c890: 696e 6773 2e52 4f4f 545f 4449 527d 2f73  ings.ROOT_DIR}/s
-0001c8a0: 696d 706c 652e 6970 796e 6222 290a 0a20  imple.ipynb").. 
-0001c8b0: 2020 2040 7079 7465 7374 2e6d 6172 6b2e     @pytest.mark.
-0001c8c0: 6173 796e 6369 6f0a 2020 2020 6173 796e  asyncio.    asyn
-0001c8d0: 6320 6465 6620 7465 7374 5f73 6176 655f  c def test_save_
-0001c8e0: 6173 280a 2020 2020 2020 2020 7365 6c66  as(.        self
-0001c8f0: 2c20 636c 6965 6e74 3a20 5465 7374 436c  , client: TestCl
-0001c900: 6965 6e74 2c20 7375 7065 7275 7365 725f  ient, superuser_
-0001c910: 746f 6b65 6e5f 6865 6164 6572 733a 2044  token_headers: D
-0001c920: 6963 745b 7374 722c 2073 7472 5d0a 2020  ict[str, str].  
-0001c930: 2020 293a 0a20 2020 2020 2020 2075 7569    ):.        uui
-0001c940: 6420 3d20 6177 6169 7420 7570 6c6f 6164  d = await upload
-0001c950: 5f6e 6f74 6562 6f6f 6b28 0a20 2020 2020  _notebook(.     
-0001c960: 2020 2020 2020 2063 6c69 656e 742c 2073         client, s
-0001c970: 7570 6572 7573 6572 5f74 6f6b 656e 5f68  uperuser_token_h
-0001c980: 6561 6465 7273 2c20 6669 6c65 6e61 6d65  eaders, filename
-0001c990: 3d22 7369 6d70 6c65 2e69 7079 6e62 220a  ="simple.ipynb".
-0001c9a0: 2020 2020 2020 2020 290a 0a20 2020 2020          )..     
-0001c9b0: 2020 2061 7373 6572 7420 6f73 2e70 6174     assert os.pat
-0001c9c0: 682e 6578 6973 7473 2866 227b 7365 7474  h.exists(f"{sett
-0001c9d0: 696e 6773 2e52 4f4f 545f 4449 527d 2f73  ings.ROOT_DIR}/s
-0001c9e0: 696d 706c 652e 6970 796e 6222 290a 2020  imple.ipynb").  
-0001c9f0: 2020 2020 2020 6173 7365 7274 206e 6f74        assert not
-0001ca00: 206f 732e 7061 7468 2e65 7869 7374 7328   os.path.exists(
-0001ca10: 6622 7b73 6574 7469 6e67 732e 524f 4f54  f"{settings.ROOT
-0001ca20: 5f44 4952 7d2f 6177 686f 6c65 6e65 776e  _DIR}/awholenewn
-0001ca30: 616d 652e 6970 796e 6222 290a 0a20 2020  ame.ipynb")..   
-0001ca40: 2020 2020 2061 7379 6e63 2077 6974 6820       async with 
-0001ca50: 636c 6965 6e74 2e77 6562 736f 636b 6574  client.websocket
-0001ca60: 5f63 6f6e 6e65 6374 280a 2020 2020 2020  _connect(.      
-0001ca70: 2020 2020 2020 6622 2f6e 6f74 6562 6f6f        f"/noteboo
-0001ca80: 6b73 2f7b 7575 6964 7d2f 7773 2f6e 6f74  ks/{uuid}/ws/not
-0001ca90: 6562 6f6f 6b22 2c20 6865 6164 6572 733d  ebook", headers=
-0001caa0: 7375 7065 7275 7365 725f 746f 6b65 6e5f  superuser_token_
-0001cab0: 6865 6164 6572 730a 2020 2020 2020 2020  headers.        
-0001cac0: 2920 6173 2077 6562 736f 636b 6574 3a0a  ) as websocket:.
-0001cad0: 2020 2020 2020 2020 2020 2020 7265 7370              resp
-0001cae0: 6f6e 7365 203d 2061 7761 6974 2063 6c69  onse = await cli
-0001caf0: 656e 742e 7061 7463 6828 0a20 2020 2020  ent.patch(.     
-0001cb00: 2020 2020 2020 2020 2020 2066 222f 6e6f             f"/no
-0001cb10: 7465 626f 6f6b 732f 7b75 7569 647d 2f73  tebooks/{uuid}/s
-0001cb20: 6176 655f 6173 222c 0a20 2020 2020 2020  ave_as",.       
-0001cb30: 2020 2020 2020 2020 2071 7565 7279 5f73           query_s
-0001cb40: 7472 696e 673d 7b22 6669 6c65 6e61 6d65  tring={"filename
-0001cb50: 223a 2022 6177 686f 6c65 6e65 776e 616d  ": "awholenewnam
-0001cb60: 6522 7d2c 0a20 2020 2020 2020 2020 2020  e"},.           
-0001cb70: 2020 2020 2068 6561 6465 7273 3d73 7570       headers=sup
-0001cb80: 6572 7573 6572 5f74 6f6b 656e 5f68 6561  eruser_token_hea
-0001cb90: 6465 7273 2c0a 2020 2020 2020 2020 2020  ders,.          
-0001cba0: 2020 290a 2020 2020 2020 2020 2020 2020    ).            
-0001cbb0: 6173 7365 7274 2072 6573 706f 6e73 652e  assert response.
-0001cbc0: 7374 6174 7573 5f63 6f64 6520 3d3d 2032  status_code == 2
-0001cbd0: 3030 0a20 2020 2020 2020 2020 2020 2061  00.            a
-0001cbe0: 7373 6572 7420 280a 2020 2020 2020 2020  ssert (.        
-0001cbf0: 2020 2020 2020 2020 7265 7370 6f6e 7365          response
-0001cc00: 2e6a 736f 6e28 295b 2270 6174 6822 5d0a  .json()["path"].
-0001cc10: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001cc20: 3d3d 2066 227b 7365 7474 696e 6773 2e52  == f"{settings.R
-0001cc30: 4f4f 545f 4449 527d 2f61 7768 6f6c 656e  OOT_DIR}/awholen
-0001cc40: 6577 6e61 6d65 2e69 7079 6e62 220a 2020  ewname.ipynb".  
-0001cc50: 2020 2020 2020 2020 2020 290a 0a20 2020            )..   
-0001cc60: 2020 2020 2020 2020 2064 6174 6120 3d20           data = 
-0001cc70: 6177 6169 7420 7265 6365 6976 655f 6a73  await receive_js
-0001cc80: 6f6e 2877 6562 736f 636b 6574 2c20 6d73  on(websocket, ms
-0001cc90: 675f 7479 7065 733d 5b22 6d65 7461 6461  g_types=["metada
-0001cca0: 7461 225d 290a 2020 2020 2020 2020 2020  ta"]).          
-0001ccb0: 2020 6d65 7461 6461 7461 203d 2064 6174    metadata = dat
-0001ccc0: 615b 226d 6574 6164 6174 6122 5d0a 2020  a["metadata"].  
-0001ccd0: 2020 2020 2020 2020 2020 6173 7365 7274            assert
-0001cce0: 2028 0a20 2020 2020 2020 2020 2020 2020   (.             
-0001ccf0: 2020 206d 6574 6164 6174 615b 226a 7570     metadata["jup
-0001cd00: 7974 6572 5f64 3122 5d5b 2270 6174 6822  yter_d1"]["path"
-0001cd10: 5d0a 2020 2020 2020 2020 2020 2020 2020  ].              
-0001cd20: 2020 3d3d 2066 227b 7365 7474 696e 6773    == f"{settings
-0001cd30: 2e52 4f4f 545f 4449 527d 2f61 7768 6f6c  .ROOT_DIR}/awhol
-0001cd40: 656e 6577 6e61 6d65 2e69 7079 6e62 220a  enewname.ipynb".
-0001cd50: 2020 2020 2020 2020 2020 2020 290a 2020              ).  
-0001cd60: 2020 2020 2020 2020 2020 6173 7365 7274            assert
-0001cd70: 206d 6574 6164 6174 615b 226a 7570 7974   metadata["jupyt
-0001cd80: 6572 5f64 3122 5d5b 226e 616d 6522 5d20  er_d1"]["name"] 
-0001cd90: 3d3d 2022 6177 686f 6c65 6e65 776e 616d  == "awholenewnam
-0001cda0: 6522 0a20 2020 2020 2020 2020 2020 2061  e".            a
-0001cdb0: 7373 6572 7420 6d65 7461 6461 7461 5b22  ssert metadata["
-0001cdc0: 6a75 7079 7465 725f 6431 225d 5b22 7575  jupyter_d1"]["uu
-0001cdd0: 6964 225d 203d 3d20 7575 6964 0a0a 2020  id"] == uuid..  
-0001cde0: 2020 2020 2020 2020 2020 6173 7365 7274            assert
-0001cdf0: 206f 732e 7061 7468 2e65 7869 7374 7328   os.path.exists(
-0001ce00: 6622 7b73 6574 7469 6e67 732e 524f 4f54  f"{settings.ROOT
-0001ce10: 5f44 4952 7d2f 6177 686f 6c65 6e65 776e  _DIR}/awholenewn
-0001ce20: 616d 652e 6970 796e 6222 290a 2020 2020  ame.ipynb").    
-0001ce30: 2020 2020 2020 2020 6173 7365 7274 206f          assert o
-0001ce40: 732e 7061 7468 2e65 7869 7374 7328 6622  s.path.exists(f"
-0001ce50: 7b73 6574 7469 6e67 732e 524f 4f54 5f44  {settings.ROOT_D
-0001ce60: 4952 7d2f 7369 6d70 6c65 2e69 7079 6e62  IR}/simple.ipynb
-0001ce70: 2229 0a0a 2020 2020 2020 2020 2020 2020  ")..            
-0001ce80: 7265 7370 6f6e 7365 203d 2061 7761 6974  response = await
-0001ce90: 2063 6c69 656e 742e 6765 7428 0a20 2020   client.get(.   
-0001cea0: 2020 2020 2020 2020 2020 2020 2066 222f               f"/
-0001ceb0: 6e6f 7465 626f 6f6b 732f 7b75 7569 647d  notebooks/{uuid}
-0001cec0: 222c 2068 6561 6465 7273 3d73 7570 6572  ", headers=super
-0001ced0: 7573 6572 5f74 6f6b 656e 5f68 6561 6465  user_token_heade
-0001cee0: 7273 0a20 2020 2020 2020 2020 2020 2029  rs.            )
-0001cef0: 0a20 2020 2020 2020 2020 2020 2072 6573  .            res
-0001cf00: 705f 6a73 6f6e 203d 2072 6573 706f 6e73  p_json = respons
-0001cf10: 652e 6a73 6f6e 2829 5b22 6e6f 7465 626f  e.json()["notebo
-0001cf20: 6f6b 225d 0a20 2020 2020 2020 2020 2020  ok"].           
-0001cf30: 2061 7373 6572 7420 280a 2020 2020 2020   assert (.      
-0001cf40: 2020 2020 2020 2020 2020 7265 7370 5f6a            resp_j
-0001cf50: 736f 6e5b 226d 6574 6164 6174 6122 5d5b  son["metadata"][
-0001cf60: 226a 7570 7974 6572 5f64 3122 5d5b 226e  "jupyter_d1"]["n
-0001cf70: 616d 6522 5d20 3d3d 2022 6177 686f 6c65  ame"] == "awhole
-0001cf80: 6e65 776e 616d 6522 0a20 2020 2020 2020  newname".       
-0001cf90: 2020 2020 2029 0a20 2020 2020 2020 2020       ).         
-0001cfa0: 2020 2061 7373 6572 7420 7265 7370 5f6a     assert resp_j
-0001cfb0: 736f 6e5b 226d 6574 6164 6174 6122 5d5b  son["metadata"][
-0001cfc0: 226a 7570 7974 6572 5f64 3122 5d5b 2275  "jupyter_d1"]["u
-0001cfd0: 7569 6422 5d20 3d3d 2075 7569 640a 0a20  uid"] == uuid.. 
-0001cfe0: 2020 2040 7079 7465 7374 2e6d 6172 6b2e     @pytest.mark.
-0001cff0: 6173 796e 6369 6f0a 2020 2020 6173 796e  asyncio.    asyn
-0001d000: 6320 6465 6620 7465 7374 5f73 6176 655f  c def test_save_
-0001d010: 6173 5f64 6966 6665 7265 6e74 5f64 6972  as_different_dir
-0001d020: 6563 746f 7279 280a 2020 2020 2020 2020  ectory(.        
-0001d030: 7365 6c66 2c20 636c 6965 6e74 3a20 5465  self, client: Te
-0001d040: 7374 436c 6965 6e74 2c20 7375 7065 7275  stClient, superu
-0001d050: 7365 725f 746f 6b65 6e5f 6865 6164 6572  ser_token_header
-0001d060: 733a 2044 6963 745b 7374 722c 2073 7472  s: Dict[str, str
-0001d070: 5d0a 2020 2020 293a 0a20 2020 2020 2020  ].    ):.       
-0001d080: 2075 7569 6420 3d20 6177 6169 7420 7570   uuid = await up
-0001d090: 6c6f 6164 5f6e 6f74 6562 6f6f 6b28 0a20  load_notebook(. 
-0001d0a0: 2020 2020 2020 2020 2020 2063 6c69 656e             clien
-0001d0b0: 742c 2073 7570 6572 7573 6572 5f74 6f6b  t, superuser_tok
-0001d0c0: 656e 5f68 6561 6465 7273 2c20 6669 6c65  en_headers, file
-0001d0d0: 6e61 6d65 3d22 7369 6d70 6c65 2e69 7079  name="simple.ipy
-0001d0e0: 6e62 220a 2020 2020 2020 2020 290a 0a20  nb".        ).. 
-0001d0f0: 2020 2020 2020 2061 7373 6572 7420 6f73         assert os
-0001d100: 2e70 6174 682e 6578 6973 7473 2866 227b  .path.exists(f"{
-0001d110: 7365 7474 696e 6773 2e52 4f4f 545f 4449  settings.ROOT_DI
-0001d120: 527d 2f73 696d 706c 652e 6970 796e 6222  R}/simple.ipynb"
-0001d130: 290a 2020 2020 2020 2020 6173 7365 7274  ).        assert
-0001d140: 206e 6f74 206f 732e 7061 7468 2e65 7869   not os.path.exi
-0001d150: 7374 7328 6622 7b77 6f72 6b64 6972 5f31  sts(f"{workdir_1
-0001d160: 7d2f 6177 686f 6c65 6e65 776e 616d 652e  }/awholenewname.
-0001d170: 6970 796e 6222 290a 0a20 2020 2020 2020  ipynb")..       
-0001d180: 2061 7379 6e63 2077 6974 6820 636c 6965   async with clie
-0001d190: 6e74 2e77 6562 736f 636b 6574 5f63 6f6e  nt.websocket_con
-0001d1a0: 6e65 6374 280a 2020 2020 2020 2020 2020  nect(.          
-0001d1b0: 2020 6622 2f6e 6f74 6562 6f6f 6b73 2f7b    f"/notebooks/{
-0001d1c0: 7575 6964 7d2f 7773 2f6e 6f74 6562 6f6f  uuid}/ws/noteboo
-0001d1d0: 6b22 2c20 6865 6164 6572 733d 7375 7065  k", headers=supe
-0001d1e0: 7275 7365 725f 746f 6b65 6e5f 6865 6164  ruser_token_head
-0001d1f0: 6572 730a 2020 2020 2020 2020 2920 6173  ers.        ) as
-0001d200: 2077 6562 736f 636b 6574 3a0a 2020 2020   websocket:.    
-0001d210: 2020 2020 2020 2020 7265 7370 6f6e 7365          response
-0001d220: 203d 2061 7761 6974 2063 6c69 656e 742e   = await client.
-0001d230: 7061 7463 6828 0a20 2020 2020 2020 2020  patch(.         
-0001d240: 2020 2020 2020 2066 222f 6e6f 7465 626f         f"/notebo
-0001d250: 6f6b 732f 7b75 7569 647d 2f73 6176 655f  oks/{uuid}/save_
-0001d260: 6173 222c 0a20 2020 2020 2020 2020 2020  as",.           
-0001d270: 2020 2020 2071 7565 7279 5f73 7472 696e       query_strin
-0001d280: 673d 7b0a 2020 2020 2020 2020 2020 2020  g={.            
-0001d290: 2020 2020 2020 2020 2266 696c 656e 616d          "filenam
-0001d2a0: 6522 3a20 2261 7768 6f6c 656e 6577 6e61  e": "awholenewna
-0001d2b0: 6d65 222c 0a20 2020 2020 2020 2020 2020  me",.           
-0001d2c0: 2020 2020 2020 2020 2022 6469 7265 6374           "direct
-0001d2d0: 6f72 7922 3a20 222f 746d 702f 7465 7374  ory": "/tmp/test
-0001d2e0: 5f6e 625f 322f 222c 0a20 2020 2020 2020  _nb_2/",.       
-0001d2f0: 2020 2020 2020 2020 207d 2c0a 2020 2020           },.    
-0001d300: 2020 2020 2020 2020 2020 2020 6865 6164              head
-0001d310: 6572 733d 7375 7065 7275 7365 725f 746f  ers=superuser_to
-0001d320: 6b65 6e5f 6865 6164 6572 732c 0a20 2020  ken_headers,.   
-0001d330: 2020 2020 2020 2020 2029 0a20 2020 2020           ).     
-0001d340: 2020 2020 2020 2061 7373 6572 7420 7265         assert re
-0001d350: 7370 6f6e 7365 2e73 7461 7475 735f 636f  sponse.status_co
-0001d360: 6465 203d 3d20 3230 300a 2020 2020 2020  de == 200.      
-0001d370: 2020 2020 2020 6173 7365 7274 2028 0a20        assert (. 
-0001d380: 2020 2020 2020 2020 2020 2020 2020 2072                 r
-0001d390: 6573 706f 6e73 652e 6a73 6f6e 2829 5b22  esponse.json()["
-0001d3a0: 7061 7468 225d 0a20 2020 2020 2020 2020  path"].         
-0001d3b0: 2020 2020 2020 203d 3d20 6622 2f74 6d70         == f"/tmp
-0001d3c0: 2f74 6573 745f 6e62 5f32 2f61 7768 6f6c  /test_nb_2/awhol
-0001d3d0: 656e 6577 6e61 6d65 2e69 7079 6e62 220a  enewname.ipynb".
-0001d3e0: 2020 2020 2020 2020 2020 2020 290a 0a20              ).. 
-0001d3f0: 2020 2020 2020 2020 2020 2064 6174 6120             data 
-0001d400: 3d20 6177 6169 7420 7265 6365 6976 655f  = await receive_
-0001d410: 6a73 6f6e 2877 6562 736f 636b 6574 2c20  json(websocket, 
-0001d420: 6d73 675f 7479 7065 733d 5b22 6d65 7461  msg_types=["meta
-0001d430: 6461 7461 225d 290a 2020 2020 2020 2020  data"]).        
-0001d440: 2020 2020 6d65 7461 6461 7461 203d 2064      metadata = d
-0001d450: 6174 615b 226d 6574 6164 6174 6122 5d0a  ata["metadata"].
-0001d460: 2020 2020 2020 2020 2020 2020 6173 7365              asse
-0001d470: 7274 2028 0a20 2020 2020 2020 2020 2020  rt (.           
-0001d480: 2020 2020 206d 6574 6164 6174 615b 226a       metadata["j
-0001d490: 7570 7974 6572 5f64 3122 5d5b 2270 6174  upyter_d1"]["pat
-0001d4a0: 6822 5d0a 2020 2020 2020 2020 2020 2020  h"].            
-0001d4b0: 2020 2020 3d3d 2066 227b 776f 726b 6469      == f"{workdi
-0001d4c0: 725f 317d 2f61 7768 6f6c 656e 6577 6e61  r_1}/awholenewna
-0001d4d0: 6d65 2e69 7079 6e62 220a 2020 2020 2020  me.ipynb".      
-0001d4e0: 2020 2020 2020 290a 2020 2020 2020 2020        ).        
-0001d4f0: 2020 2020 6173 7365 7274 206d 6574 6164      assert metad
-0001d500: 6174 615b 226a 7570 7974 6572 5f64 3122  ata["jupyter_d1"
-0001d510: 5d5b 226e 616d 6522 5d20 3d3d 2022 6177  ]["name"] == "aw
-0001d520: 686f 6c65 6e65 776e 616d 6522 0a0a 2020  holenewname"..  
-0001d530: 2020 2020 2020 2020 2020 6173 7365 7274            assert
-0001d540: 206f 732e 7061 7468 2e65 7869 7374 7328   os.path.exists(
-0001d550: 6622 7b77 6f72 6b64 6972 5f31 7d2f 6177  f"{workdir_1}/aw
-0001d560: 686f 6c65 6e65 776e 616d 652e 6970 796e  holenewname.ipyn
-0001d570: 6222 290a 2020 2020 2020 2020 2020 2020  b").            
-0001d580: 6173 7365 7274 206f 732e 7061 7468 2e65  assert os.path.e
-0001d590: 7869 7374 7328 6622 7b73 6574 7469 6e67  xists(f"{setting
-0001d5a0: 732e 524f 4f54 5f44 4952 7d2f 7369 6d70  s.ROOT_DIR}/simp
-0001d5b0: 6c65 2e69 7079 6e62 2229 0a0a 2020 2020  le.ipynb")..    
-0001d5c0: 4070 7974 6573 742e 6d61 726b 2e61 7379  @pytest.mark.asy
-0001d5d0: 6e63 696f 0a20 2020 2061 7379 6e63 2064  ncio.    async d
-0001d5e0: 6566 2074 6573 745f 7361 7665 5f61 735f  ef test_save_as_
-0001d5f0: 6669 6c65 5f65 7869 7374 7328 0a20 2020  file_exists(.   
-0001d600: 2020 2020 2073 656c 662c 2063 6c69 656e       self, clien
-0001d610: 743a 2054 6573 7443 6c69 656e 742c 2073  t: TestClient, s
-0001d620: 7570 6572 7573 6572 5f74 6f6b 656e 5f68  uperuser_token_h
-0001d630: 6561 6465 7273 3a20 4469 6374 5b73 7472  eaders: Dict[str
-0001d640: 2c20 7374 725d 0a20 2020 2029 3a0a 2020  , str].    ):.  
-0001d650: 2020 2020 2020 2222 2246 6169 6c20 6966        """Fail if
-0001d660: 2066 696c 6520 6578 6973 7473 2075 6e6c   file exists unl
-0001d670: 6573 7320 6f76 6572 7772 6974 6520 7061  ess overwrite pa
-0001d680: 7261 6d20 6973 2073 6574 2074 6f20 7472  ram is set to tr
-0001d690: 7565 2222 220a 2020 2020 2020 2020 7575  ue""".        uu
-0001d6a0: 6964 203d 2061 7761 6974 2075 706c 6f61  id = await uploa
-0001d6b0: 645f 6e6f 7465 626f 6f6b 280a 2020 2020  d_notebook(.    
-0001d6c0: 2020 2020 2020 2020 636c 6965 6e74 2c20          client, 
-0001d6d0: 7375 7065 7275 7365 725f 746f 6b65 6e5f  superuser_token_
-0001d6e0: 6865 6164 6572 732c 2066 696c 656e 616d  headers, filenam
-0001d6f0: 653d 2273 696d 706c 652e 6970 796e 6222  e="simple.ipynb"
-0001d700: 0a20 2020 2020 2020 2029 0a0a 2020 2020  .        )..    
-0001d710: 2020 2020 7769 7468 206f 7065 6e28 6622      with open(f"
-0001d720: 7b77 6f72 6b64 6972 5f31 7d2f 6177 686f  {workdir_1}/awho
-0001d730: 6c65 6e65 776e 616d 652e 6970 796e 6222  lenewname.ipynb"
-0001d740: 2c20 2277 2229 2061 7320 663a 0a20 2020  , "w") as f:.   
-0001d750: 2020 2020 2020 2020 2066 2e77 7269 7465           f.write
-0001d760: 2822 736f 6d65 2074 6578 7420 6865 7265  ("some text here
-0001d770: 2229 0a0a 2020 2020 2020 2020 6173 7365  ")..        asse
-0001d780: 7274 206f 732e 7061 7468 2e65 7869 7374  rt os.path.exist
-0001d790: 7328 6622 7b73 6574 7469 6e67 732e 524f  s(f"{settings.RO
-0001d7a0: 4f54 5f44 4952 7d2f 7369 6d70 6c65 2e69  OT_DIR}/simple.i
-0001d7b0: 7079 6e62 2229 0a20 2020 2020 2020 2061  pynb").        a
-0001d7c0: 7373 6572 7420 6f73 2e70 6174 682e 6578  ssert os.path.ex
-0001d7d0: 6973 7473 2866 227b 776f 726b 6469 725f  ists(f"{workdir_
-0001d7e0: 317d 2f61 7768 6f6c 656e 6577 6e61 6d65  1}/awholenewname
-0001d7f0: 2e69 7079 6e62 2229 0a0a 2020 2020 2020  .ipynb")..      
-0001d800: 2020 6173 796e 6320 7769 7468 2063 6c69    async with cli
-0001d810: 656e 742e 7765 6273 6f63 6b65 745f 636f  ent.websocket_co
-0001d820: 6e6e 6563 7428 0a20 2020 2020 2020 2020  nnect(.         
-0001d830: 2020 2066 222f 6e6f 7465 626f 6f6b 732f     f"/notebooks/
-0001d840: 7b75 7569 647d 2f77 732f 6e6f 7465 626f  {uuid}/ws/notebo
-0001d850: 6f6b 222c 2068 6561 6465 7273 3d73 7570  ok", headers=sup
-0001d860: 6572 7573 6572 5f74 6f6b 656e 5f68 6561  eruser_token_hea
-0001d870: 6465 7273 0a20 2020 2020 2020 2029 2061  ders.        ) a
-0001d880: 7320 7765 6273 6f63 6b65 743a 0a20 2020  s websocket:.   
-0001d890: 2020 2020 2020 2020 2072 6573 706f 6e73           respons
-0001d8a0: 6520 3d20 6177 6169 7420 636c 6965 6e74  e = await client
-0001d8b0: 2e70 6174 6368 280a 2020 2020 2020 2020  .patch(.        
-0001d8c0: 2020 2020 2020 2020 6622 2f6e 6f74 6562          f"/noteb
-0001d8d0: 6f6f 6b73 2f7b 7575 6964 7d2f 7361 7665  ooks/{uuid}/save
-0001d8e0: 5f61 7322 2c0a 2020 2020 2020 2020 2020  _as",.          
-0001d8f0: 2020 2020 2020 7175 6572 795f 7374 7269        query_stri
-0001d900: 6e67 3d7b 0a20 2020 2020 2020 2020 2020  ng={.           
-0001d910: 2020 2020 2020 2020 2022 6669 6c65 6e61           "filena
-0001d920: 6d65 223a 2022 6177 686f 6c65 6e65 776e  me": "awholenewn
-0001d930: 616d 6522 2c0a 2020 2020 2020 2020 2020  ame",.          
-0001d940: 2020 2020 2020 2020 2020 2264 6972 6563            "direc
-0001d950: 746f 7279 223a 2022 2f74 6d70 2f74 6573  tory": "/tmp/tes
-0001d960: 745f 6e62 5f32 2f22 2c0a 2020 2020 2020  t_nb_2/",.      
-0001d970: 2020 2020 2020 2020 2020 7d2c 0a20 2020            },.   
-0001d980: 2020 2020 2020 2020 2020 2020 2068 6561               hea
-0001d990: 6465 7273 3d73 7570 6572 7573 6572 5f74  ders=superuser_t
-0001d9a0: 6f6b 656e 5f68 6561 6465 7273 2c0a 2020  oken_headers,.  
-0001d9b0: 2020 2020 2020 2020 2020 290a 2020 2020            ).    
-0001d9c0: 2020 2020 2020 2020 6173 7365 7274 2072          assert r
-0001d9d0: 6573 706f 6e73 652e 7374 6174 7573 5f63  esponse.status_c
-0001d9e0: 6f64 6520 3d3d 2034 3030 0a20 2020 2020  ode == 400.     
-0001d9f0: 2020 2020 2020 2061 7373 6572 7420 7265         assert re
-0001da00: 7370 6f6e 7365 2e6a 736f 6e28 295b 2264  sponse.json()["d
-0001da10: 6574 6169 6c22 5d20 3d3d 2066 2246 696c  etail"] == f"Fil
-0001da20: 6520 616c 7265 6164 7920 6578 6973 7473  e already exists
-0001da30: 220a 0a20 2020 2020 2020 2020 2020 2072  "..            r
-0001da40: 6573 706f 6e73 6520 3d20 6177 6169 7420  esponse = await 
-0001da50: 636c 6965 6e74 2e70 6174 6368 280a 2020  client.patch(.  
-0001da60: 2020 2020 2020 2020 2020 2020 2020 6622                f"
-0001da70: 2f6e 6f74 6562 6f6f 6b73 2f7b 7575 6964  /notebooks/{uuid
-0001da80: 7d2f 7361 7665 5f61 7322 2c0a 2020 2020  }/save_as",.    
-0001da90: 2020 2020 2020 2020 2020 2020 7175 6572              quer
-0001daa0: 795f 7374 7269 6e67 3d7b 0a20 2020 2020  y_string={.     
-0001dab0: 2020 2020 2020 2020 2020 2020 2020 2022                 "
-0001dac0: 6669 6c65 6e61 6d65 223a 2022 6177 686f  filename": "awho
-0001dad0: 6c65 6e65 776e 616d 6522 2c0a 2020 2020  lenewname",.    
-0001dae0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001daf0: 2264 6972 6563 746f 7279 223a 2022 2f74  "directory": "/t
-0001db00: 6d70 2f74 6573 745f 6e62 5f32 2f22 2c0a  mp/test_nb_2/",.
-0001db10: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001db20: 2020 2020 226f 7665 7277 7269 7465 223a      "overwrite":
-0001db30: 2054 7275 652c 0a20 2020 2020 2020 2020   True,.         
-0001db40: 2020 2020 2020 207d 2c0a 2020 2020 2020         },.      
-0001db50: 2020 2020 2020 2020 2020 6865 6164 6572            header
-0001db60: 733d 7375 7065 7275 7365 725f 746f 6b65  s=superuser_toke
-0001db70: 6e5f 6865 6164 6572 732c 0a20 2020 2020  n_headers,.     
-0001db80: 2020 2020 2020 2029 0a20 2020 2020 2020         ).       
-0001db90: 2020 2020 2061 7373 6572 7420 7265 7370       assert resp
-0001dba0: 6f6e 7365 2e73 7461 7475 735f 636f 6465  onse.status_code
-0001dbb0: 203d 3d20 3230 300a 2020 2020 2020 2020   == 200.        
-0001dbc0: 2020 2020 6173 7365 7274 2028 0a20 2020      assert (.   
-0001dbd0: 2020 2020 2020 2020 2020 2020 2072 6573               res
-0001dbe0: 706f 6e73 652e 6a73 6f6e 2829 5b22 7061  ponse.json()["pa
-0001dbf0: 7468 225d 0a20 2020 2020 2020 2020 2020  th"].           
-0001dc00: 2020 2020 203d 3d20 6622 2f74 6d70 2f74       == f"/tmp/t
-0001dc10: 6573 745f 6e62 5f32 2f61 7768 6f6c 656e  est_nb_2/awholen
-0001dc20: 6577 6e61 6d65 2e69 7079 6e62 220a 2020  ewname.ipynb".  
-0001dc30: 2020 2020 2020 2020 2020 290a 0a20 2020            )..   
-0001dc40: 2020 2020 2020 2020 2064 6174 6120 3d20           data = 
-0001dc50: 6177 6169 7420 7265 6365 6976 655f 6a73  await receive_js
-0001dc60: 6f6e 2877 6562 736f 636b 6574 2c20 6d73  on(websocket, ms
-0001dc70: 675f 7479 7065 733d 5b22 6d65 7461 6461  g_types=["metada
-0001dc80: 7461 225d 290a 2020 2020 2020 2020 2020  ta"]).          
-0001dc90: 2020 6d65 7461 6461 7461 203d 2064 6174    metadata = dat
-0001dca0: 615b 226d 6574 6164 6174 6122 5d0a 2020  a["metadata"].  
-0001dcb0: 2020 2020 2020 2020 2020 6173 7365 7274            assert
-0001dcc0: 2028 0a20 2020 2020 2020 2020 2020 2020   (.             
-0001dcd0: 2020 206d 6574 6164 6174 615b 226a 7570     metadata["jup
-0001dce0: 7974 6572 5f64 3122 5d5b 2270 6174 6822  yter_d1"]["path"
-0001dcf0: 5d0a 2020 2020 2020 2020 2020 2020 2020  ].              
-0001dd00: 2020 3d3d 2066 227b 776f 726b 6469 725f    == f"{workdir_
-0001dd10: 317d 2f61 7768 6f6c 656e 6577 6e61 6d65  1}/awholenewname
-0001dd20: 2e69 7079 6e62 220a 2020 2020 2020 2020  .ipynb".        
-0001dd30: 2020 2020 290a 2020 2020 2020 2020 2020      ).          
-0001dd40: 2020 6173 7365 7274 206d 6574 6164 6174    assert metadat
-0001dd50: 615b 226a 7570 7974 6572 5f64 3122 5d5b  a["jupyter_d1"][
-0001dd60: 226e 616d 6522 5d20 3d3d 2022 6177 686f  "name"] == "awho
-0001dd70: 6c65 6e65 776e 616d 6522 0a0a 2020 2020  lenewname"..    
-0001dd80: 2020 2020 2020 2020 6173 7365 7274 206f          assert o
-0001dd90: 732e 7061 7468 2e65 7869 7374 7328 6622  s.path.exists(f"
-0001dda0: 7b77 6f72 6b64 6972 5f31 7d2f 6177 686f  {workdir_1}/awho
-0001ddb0: 6c65 6e65 776e 616d 652e 6970 796e 6222  lenewname.ipynb"
-0001ddc0: 290a 2020 2020 2020 2020 2020 2020 6173  ).            as
-0001ddd0: 7365 7274 206f 732e 7061 7468 2e65 7869  sert os.path.exi
-0001dde0: 7374 7328 6622 7b73 6574 7469 6e67 732e  sts(f"{settings.
-0001ddf0: 524f 4f54 5f44 4952 7d2f 7369 6d70 6c65  ROOT_DIR}/simple
-0001de00: 2e69 7079 6e62 2229 0a0a 2020 2020 2020  .ipynb")..      
-0001de10: 2020 7769 7468 206f 7065 6e28 6622 7b77    with open(f"{w
-0001de20: 6f72 6b64 6972 5f31 7d2f 6177 686f 6c65  orkdir_1}/awhole
-0001de30: 6e65 776e 616d 652e 6970 796e 6222 2c20  newname.ipynb", 
-0001de40: 2272 2229 2061 7320 663a 0a20 2020 2020  "r") as f:.     
-0001de50: 2020 2020 2020 2061 7373 6572 7420 662e         assert f.
-0001de60: 7265 6164 2829 2021 3d20 2273 6f6d 6520  read() != "some 
-0001de70: 7465 7874 2068 6572 6522 0a0a 0a40 7079  text here"...@py
-0001de80: 7465 7374 2e6d 6172 6b2e 7573 6566 6978  test.mark.usefix
-0001de90: 7475 7265 7328 2263 6c65 6172 5f6e 6f74  tures("clear_not
-0001dea0: 6562 6f6f 6b73 222c 2022 636c 6561 725f  ebooks", "clear_
-0001deb0: 6e6f 7465 626f 6f6b 5f64 6972 6563 746f  notebook_directo
-0001dec0: 7279 2229 0a63 6c61 7373 2054 6573 7444  ry").class TestD
-0001ded0: 3143 6f6d 6d61 6e64 733a 0a20 2020 2061  1Commands:.    a
-0001dee0: 7379 6e63 2064 6566 2064 6f5f 7465 7374  sync def do_test
-0001def0: 5f64 315f 6e6f 7469 6679 280a 2020 2020  _d1_notify(.    
-0001df00: 2020 2020 7365 6c66 2c0a 2020 2020 2020      self,.      
-0001df10: 2020 6365 6c6c 5f63 6f6e 7465 6e74 3a20    cell_content: 
-0001df20: 7374 722c 0a20 2020 2020 2020 206e 6f74  str,.        not
-0001df30: 6966 6963 6174 696f 6e73 3a20 4c69 7374  ifications: List
-0001df40: 5b73 7472 5d2c 0a20 2020 2020 2020 2072  [str],.        r
-0001df50: 656d 6169 6e69 6e67 5f73 7464 6f75 743a  emaining_stdout:
-0001df60: 2073 7472 2c0a 2020 2020 2020 2020 636c   str,.        cl
-0001df70: 6965 6e74 3a20 5465 7374 436c 6965 6e74  ient: TestClient
-0001df80: 2c0a 2020 2020 2020 2020 7375 7065 7275  ,.        superu
-0001df90: 7365 725f 746f 6b65 6e5f 6865 6164 6572  ser_token_header
-0001dfa0: 733a 2044 6963 745b 7374 722c 2073 7472  s: Dict[str, str
-0001dfb0: 5d2c 0a20 2020 2020 2020 206d 6f63 6b65  ],.        mocke
-0001dfc0: 723a 204d 6f63 6b46 6978 7475 7265 2c0a  r: MockFixture,.
-0001dfd0: 2020 2020 293a 0a20 2020 2020 2020 2065      ):.        e
-0001dfe0: 7865 6375 7465 5f64 315f 636f 6d6d 616e  xecute_d1_comman
-0001dff0: 6420 3d20 6d6f 636b 6572 2e70 6174 6368  d = mocker.patch
-0001e000: 280a 2020 2020 2020 2020 2020 2020 226a  (.            "j
-0001e010: 7570 7974 6572 5f64 312e 7374 6f72 6167  upyter_d1.storag
-0001e020: 652e 6e6f 7465 626f 6f6b 5f6d 616e 6167  e.notebook_manag
-0001e030: 6572 2e65 7865 6375 7465 5f64 315f 636f  er.execute_d1_co
-0001e040: 6d6d 616e 6422 0a20 2020 2020 2020 2029  mmand".        )
-0001e050: 0a0a 2020 2020 2020 2020 7575 6964 203d  ..        uuid =
-0001e060: 2061 7761 6974 2075 706c 6f61 645f 6e6f   await upload_no
-0001e070: 7465 626f 6f6b 280a 2020 2020 2020 2020  tebook(.        
-0001e080: 2020 2020 636c 6965 6e74 2c20 7375 7065      client, supe
-0001e090: 7275 7365 725f 746f 6b65 6e5f 6865 6164  ruser_token_head
-0001e0a0: 6572 732c 2022 7369 6d70 6c65 2e69 7079  ers, "simple.ipy
-0001e0b0: 6e62 220a 2020 2020 2020 2020 290a 0a20  nb".        ).. 
-0001e0c0: 2020 2020 2020 2023 2067 6574 2061 6e20         # get an 
-0001e0d0: 6578 6973 7469 6e67 2063 656c 6c0a 2020  existing cell.  
-0001e0e0: 2020 2020 2020 7265 7370 6f6e 7365 203d        response =
-0001e0f0: 2061 7761 6974 2063 6c69 656e 742e 6765   await client.ge
-0001e100: 7428 0a20 2020 2020 2020 2020 2020 2066  t(.            f
-0001e110: 222f 6e6f 7465 626f 6f6b 732f 7b75 7569  "/notebooks/{uui
-0001e120: 647d 2f63 656c 6c73 222c 2068 6561 6465  d}/cells", heade
-0001e130: 7273 3d73 7570 6572 7573 6572 5f74 6f6b  rs=superuser_tok
-0001e140: 656e 5f68 6561 6465 7273 0a20 2020 2020  en_headers.     
-0001e150: 2020 2029 0a20 2020 2020 2020 2061 7373     ).        ass
-0001e160: 6572 7420 7265 7370 6f6e 7365 2e73 7461  ert response.sta
-0001e170: 7475 735f 636f 6465 203d 3d20 3230 300a  tus_code == 200.
-0001e180: 2020 2020 2020 2020 6365 6c6c 7320 3d20          cells = 
-0001e190: 7265 7370 6f6e 7365 2e6a 736f 6e28 295b  response.json()[
-0001e1a0: 2263 656c 6c73 225d 0a20 2020 2020 2020  "cells"].       
-0001e1b0: 2061 7373 6572 7420 6365 6c6c 735b 315d   assert cells[1]
-0001e1c0: 5b22 736f 7572 6365 225d 203d 3d20 2770  ["source"] == 'p
-0001e1d0: 7269 6e74 2822 4c61 7272 7920 7468 6520  rint("Larry the 
-0001e1e0: 4c6c 616d 6122 2927 0a0a 2020 2020 2020  Llama")'..      
-0001e1f0: 2020 6365 6c6c 5f75 7569 6420 3d20 6365    cell_uuid = ce
-0001e200: 6c6c 735b 315d 5b22 6d65 7461 6461 7461  lls[1]["metadata
-0001e210: 225d 5b22 6a75 7079 7465 725f 6431 225d  "]["jupyter_d1"]
-0001e220: 5b22 7575 6964 225d 0a20 2020 2020 2020  ["uuid"].       
-0001e230: 2061 7373 6572 7420 6365 6c6c 735b 315d   assert cells[1]
-0001e240: 5b22 6578 6563 7574 696f 6e5f 636f 756e  ["execution_coun
-0001e250: 7422 5d20 6973 204e 6f6e 650a 0a20 2020  t"] is None..   
-0001e260: 2020 2020 2062 6f64 7920 3d20 7b22 736f       body = {"so
-0001e270: 7572 6365 223a 2063 656c 6c5f 636f 6e74  urce": cell_cont
-0001e280: 656e 747d 0a20 2020 2020 2020 2072 6573  ent}.        res
-0001e290: 706f 6e73 6520 3d20 6177 6169 7420 636c  ponse = await cl
-0001e2a0: 6965 6e74 2e70 6174 6368 280a 2020 2020  ient.patch(.    
-0001e2b0: 2020 2020 2020 2020 6622 2f6e 6f74 6562          f"/noteb
-0001e2c0: 6f6f 6b73 2f7b 7575 6964 7d2f 6365 6c6c  ooks/{uuid}/cell
-0001e2d0: 732f 7b63 656c 6c5f 7575 6964 7d22 2c0a  s/{cell_uuid}",.
-0001e2e0: 2020 2020 2020 2020 2020 2020 6a73 6f6e              json
-0001e2f0: 3d62 6f64 792c 0a20 2020 2020 2020 2020  =body,.         
-0001e300: 2020 2068 6561 6465 7273 3d73 7570 6572     headers=super
-0001e310: 7573 6572 5f74 6f6b 656e 5f68 6561 6465  user_token_heade
-0001e320: 7273 2c0a 2020 2020 2020 2020 290a 2020  rs,.        ).  
-0001e330: 2020 2020 2020 6173 7365 7274 2072 6573        assert res
-0001e340: 706f 6e73 652e 7374 6174 7573 5f63 6f64  ponse.status_cod
-0001e350: 6520 3d3d 2032 3030 0a0a 2020 2020 2020  e == 200..      
-0001e360: 2020 6173 796e 6320 7769 7468 2063 6c69    async with cli
-0001e370: 656e 742e 7765 6273 6f63 6b65 745f 636f  ent.websocket_co
-0001e380: 6e6e 6563 7428 0a20 2020 2020 2020 2020  nnect(.         
-0001e390: 2020 2066 222f 6e6f 7465 626f 6f6b 732f     f"/notebooks/
-0001e3a0: 7b75 7569 647d 2f77 732f 6e6f 7465 626f  {uuid}/ws/notebo
-0001e3b0: 6f6b 222c 2068 6561 6465 7273 3d73 7570  ok", headers=sup
-0001e3c0: 6572 7573 6572 5f74 6f6b 656e 5f68 6561  eruser_token_hea
-0001e3d0: 6465 7273 0a20 2020 2020 2020 2029 2061  ders.        ) a
-0001e3e0: 7320 7765 6273 6f63 6b65 743a 0a20 2020  s websocket:.   
-0001e3f0: 2020 2020 2020 2020 2061 7761 6974 2061           await a
-0001e400: 7379 6e63 696f 2e73 6c65 6570 2857 4542  syncio.sleep(WEB
-0001e410: 534f 434b 4554 5f53 4c45 4550 5f54 494d  SOCKET_SLEEP_TIM
-0001e420: 4529 0a0a 2020 2020 2020 2020 2020 2020  E)..            
-0001e430: 7265 7370 6f6e 7365 203d 2061 7761 6974  response = await
-0001e440: 2063 6c69 656e 742e 6765 7428 0a20 2020   client.get(.   
-0001e450: 2020 2020 2020 2020 2020 2020 2066 222f               f"/
-0001e460: 6e6f 7465 626f 6f6b 732f 7b75 7569 647d  notebooks/{uuid}
-0001e470: 2f63 656c 6c73 2f7b 6365 6c6c 5f75 7569  /cells/{cell_uui
-0001e480: 647d 2f65 7865 6375 7465 222c 0a20 2020  d}/execute",.   
-0001e490: 2020 2020 2020 2020 2020 2020 2068 6561               hea
-0001e4a0: 6465 7273 3d73 7570 6572 7573 6572 5f74  ders=superuser_t
-0001e4b0: 6f6b 656e 5f68 6561 6465 7273 2c0a 2020  oken_headers,.  
-0001e4c0: 2020 2020 2020 2020 2020 290a 2020 2020            ).    
-0001e4d0: 2020 2020 2020 2020 6173 7365 7274 2072          assert r
-0001e4e0: 6573 706f 6e73 652e 7374 6174 7573 5f63  esponse.status_c
-0001e4f0: 6f64 6520 3d3d 2032 3030 0a0a 2020 2020  ode == 200..    
-0001e500: 2020 2020 2020 2020 6365 6c6c 5f73 7472          cell_str
-0001e510: 6561 6d73 3a20 4c69 7374 5b44 6963 745b  eams: List[Dict[
-0001e520: 7374 722c 2041 6e79 5d5d 203d 205b 5d0a  str, Any]] = [].
-0001e530: 2020 2020 2020 2020 2020 2020 7265 6365              rece
-0001e540: 6976 6564 5f69 6e66 6f20 3d20 7b0a 2020  ived_info = {.  
-0001e550: 2020 2020 2020 2020 2020 2020 2020 2272                "r
-0001e560: 6563 6569 7665 645f 6365 6c6c 5f73 7472  eceived_cell_str
-0001e570: 6561 6d5f 636f 756e 7422 3a20 302c 0a20  eam_count": 0,. 
-0001e580: 2020 2020 2020 2020 2020 2020 2020 2022                 "
-0001e590: 7265 6365 6976 6564 5f63 656c 6c5f 7570  received_cell_up
-0001e5a0: 6461 7465 5f63 6f75 6e74 223a 2030 2c0a  date_count": 0,.
-0001e5b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001e5c0: 2272 6563 6569 7665 645f 6365 6c6c 5f65  "received_cell_e
-0001e5d0: 7865 6375 7469 6f6e 223a 2046 616c 7365  xecution": False
-0001e5e0: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
-0001e5f0: 2020 2272 6563 6569 7665 645f 7661 7273    "received_vars
-0001e600: 223a 2046 616c 7365 2c0a 2020 2020 2020  ": False,.      
-0001e610: 2020 2020 2020 7d0a 0a20 2020 2020 2020        }..       
-0001e620: 2020 2020 2023 2052 6563 6569 7665 2063       # Receive c
-0001e630: 656c 6c20 7374 7265 616d 206f 7574 7075  ell stream outpu
-0001e640: 740a 2020 2020 2020 2020 2020 2020 6173  t.            as
-0001e650: 796e 6320 6465 6620 7265 6365 6976 655f  ync def receive_
-0001e660: 6365 6c6c 5f73 7472 6561 6d28 6461 7461  cell_stream(data
-0001e670: 293a 0a20 2020 2020 2020 2020 2020 2020  ):.             
-0001e680: 2020 2063 656c 6c5f 7374 7265 616d 203d     cell_stream =
-0001e690: 2064 6174 615b 2263 656c 6c5f 7374 7265   data["cell_stre
-0001e6a0: 616d 225d 0a20 2020 2020 2020 2020 2020  am"].           
-0001e6b0: 2020 2020 2065 7870 6563 7465 645f 6f75       expected_ou
-0001e6c0: 7470 7574 203d 207b 0a20 2020 2020 2020  tput = {.       
-0001e6d0: 2020 2020 2020 2020 2020 2020 2022 6e61               "na
-0001e6e0: 6d65 223a 2022 7374 646f 7574 222c 0a20  me": "stdout",. 
-0001e6f0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001e700: 2020 2022 7465 7874 223a 2072 656d 6169     "text": remai
-0001e710: 6e69 6e67 5f73 7464 6f75 742c 0a20 2020  ning_stdout,.   
-0001e720: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001e730: 2022 6f75 7470 7574 5f74 7970 6522 3a20   "output_type": 
-0001e740: 2273 7472 6561 6d22 2c0a 2020 2020 2020  "stream",.      
-0001e750: 2020 2020 2020 2020 2020 7d0a 2020 2020            }.    
-0001e760: 2020 2020 2020 2020 2020 2020 6173 7365              asse
-0001e770: 7274 2063 656c 6c5f 7374 7265 616d 5b22  rt cell_stream["
-0001e780: 6f75 7470 7574 225d 203d 3d20 6578 7065  output"] == expe
-0001e790: 6374 6564 5f6f 7574 7075 740a 2020 2020  cted_output.    
-0001e7a0: 2020 2020 2020 2020 2020 2020 6173 7365              asse
-0001e7b0: 7274 2063 656c 6c5f 7374 7265 616d 5b22  rt cell_stream["
-0001e7c0: 6365 6c6c 5f69 6422 5d20 3d3d 2063 656c  cell_id"] == cel
-0001e7d0: 6c5f 7575 6964 0a20 2020 2020 2020 2020  l_uuid.         
-0001e7e0: 2020 2020 2020 2072 6563 6569 7665 645f         received_
-0001e7f0: 696e 666f 5b22 7265 6365 6976 6564 5f63  info["received_c
-0001e800: 656c 6c5f 7374 7265 616d 5f63 6f75 6e74  ell_stream_count
-0001e810: 225d 202b 3d20 310a 2020 2020 2020 2020  "] += 1.        
-0001e820: 2020 2020 2020 2020 7265 7475 726e 2065          return e
-0001e830: 7870 6563 7465 645f 6f75 7470 7574 0a0a  xpected_output..
-0001e840: 2020 2020 2020 2020 2020 2020 6173 796e              asyn
-0001e850: 6320 6465 6620 7265 6365 6976 655f 6365  c def receive_ce
-0001e860: 6c6c 5f75 7064 6174 6528 6461 7461 293a  ll_update(data):
-0001e870: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-0001e880: 2063 656c 6c5f 7570 6461 7465 203d 2064   cell_update = d
-0001e890: 6174 615b 2263 656c 6c5f 7570 6461 7465  ata["cell_update
-0001e8a0: 225d 0a20 2020 2020 2020 2020 2020 2020  "].             
-0001e8b0: 2020 2061 7373 6572 7420 6c65 6e28 6365     assert len(ce
-0001e8c0: 6c6c 5f75 7064 6174 6529 203d 3d20 310a  ll_update) == 1.
-0001e8d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001e8e0: 6365 6c6c 5f64 315f 6461 7461 203d 2063  cell_d1_data = c
-0001e8f0: 656c 6c5f 7570 6461 7465 5b30 5d5b 226d  ell_update[0]["m
-0001e900: 6574 6164 6174 6122 5d5b 226a 7570 7974  etadata"]["jupyt
-0001e910: 6572 5f64 3122 5d0a 2020 2020 2020 2020  er_d1"].        
-0001e920: 2020 2020 2020 2020 6173 7365 7274 2063          assert c
-0001e930: 656c 6c5f 6431 5f64 6174 615b 2275 7569  ell_d1_data["uui
-0001e940: 6422 5d20 3d3d 2063 656c 6c5f 7575 6964  d"] == cell_uuid
-0001e950: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-0001e960: 2069 6620 7265 6365 6976 6564 5f69 6e66   if received_inf
-0001e970: 6f5b 2272 6563 6569 7665 645f 6365 6c6c  o["received_cell
-0001e980: 5f75 7064 6174 655f 636f 756e 7422 5d20  _update_count"] 
-0001e990: 3d3d 2030 3a0a 2020 2020 2020 2020 2020  == 0:.          
-0001e9a0: 2020 2020 2020 2020 2020 6173 7365 7274            assert
-0001e9b0: 2063 656c 6c5f 6431 5f64 6174 615b 2265   cell_d1_data["e
-0001e9c0: 7865 6375 7469 6f6e 5f73 7461 7465 225d  xecution_state"]
-0001e9d0: 203d 3d20 2262 7573 7922 0a20 2020 2020   == "busy".     
-0001e9e0: 2020 2020 2020 2020 2020 2020 2020 2061                 a
-0001e9f0: 7373 6572 7420 280a 2020 2020 2020 2020  ssert (.        
-0001ea00: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001ea10: 6365 6c6c 5f75 7064 6174 655b 305d 5b22  cell_update[0]["
-0001ea20: 6578 6563 7574 696f 6e5f 636f 756e 7422  execution_count"
-0001ea30: 5d20 6973 204e 6f6e 650a 2020 2020 2020  ] is None.      
-0001ea40: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001ea50: 2020 6f72 2063 656c 6c5f 7570 6461 7465    or cell_update
-0001ea60: 5b30 5d5b 2265 7865 6375 7469 6f6e 5f63  [0]["execution_c
-0001ea70: 6f75 6e74 225d 203d 3d20 310a 2020 2020  ount"] == 1.    
-0001ea80: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001ea90: 290a 2020 2020 2020 2020 2020 2020 2020  ).              
-0001eaa0: 2020 656c 7365 3a0a 2020 2020 2020 2020    else:.        
-0001eab0: 2020 2020 2020 2020 2020 2020 6173 7365              asse
-0001eac0: 7274 2063 656c 6c5f 6431 5f64 6174 615b  rt cell_d1_data[
-0001ead0: 2265 7865 6375 7469 6f6e 5f73 7461 7465  "execution_state
-0001eae0: 225d 203d 3d20 2269 646c 6522 0a20 2020  "] == "idle".   
-0001eaf0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001eb00: 2061 7373 6572 7420 6365 6c6c 5f75 7064   assert cell_upd
-0001eb10: 6174 655b 305d 5b22 6f75 7470 7574 7322  ate[0]["outputs"
-0001eb20: 5d20 3d3d 2063 656c 6c5f 7374 7265 616d  ] == cell_stream
-0001eb30: 730a 2020 2020 2020 2020 2020 2020 2020  s.              
-0001eb40: 2020 2020 2020 6173 7365 7274 2063 656c        assert cel
-0001eb50: 6c5f 7570 6461 7465 5b30 5d5b 2265 7865  l_update[0]["exe
-0001eb60: 6375 7469 6f6e 5f63 6f75 6e74 225d 203d  cution_count"] =
-0001eb70: 3d20 310a 2020 2020 2020 2020 2020 2020  = 1.            
-0001eb80: 2020 2020 7265 6365 6976 6564 5f69 6e66      received_inf
-0001eb90: 6f5b 2272 6563 6569 7665 645f 6365 6c6c  o["received_cell
-0001eba0: 5f75 7064 6174 655f 636f 756e 7422 5d20  _update_count"] 
-0001ebb0: 2b3d 2031 0a0a 2020 2020 2020 2020 2020  += 1..          
-0001ebc0: 2020 6173 796e 6320 6465 6620 7265 6365    async def rece
-0001ebd0: 6976 655f 6365 6c6c 5f65 7865 6375 7469  ive_cell_executi
-0001ebe0: 6f6e 2864 6174 6129 3a0a 2020 2020 2020  on(data):.      
-0001ebf0: 2020 2020 2020 2020 2020 6365 6c6c 5f65            cell_e
-0001ec00: 7865 6320 3d20 6461 7461 5b22 6365 6c6c  xec = data["cell
-0001ec10: 5f65 7865 6375 7469 6f6e 5f72 6570 6c79  _execution_reply
-0001ec20: 225d 0a20 2020 2020 2020 2020 2020 2020  "].             
-0001ec30: 2020 2061 7373 6572 7420 6365 6c6c 5f65     assert cell_e
-0001ec40: 7865 635b 2263 656c 6c5f 6964 225d 203d  xec["cell_id"] =
-0001ec50: 3d20 6365 6c6c 5f75 7569 640a 2020 2020  = cell_uuid.    
-0001ec60: 2020 2020 2020 2020 2020 2020 6173 7365              asse
-0001ec70: 7274 2063 656c 6c5f 6578 6563 5b22 6578  rt cell_exec["ex
-0001ec80: 6563 7574 696f 6e5f 636f 756e 7422 5d20  ecution_count"] 
-0001ec90: 3d3d 2031 0a20 2020 2020 2020 2020 2020  == 1.           
-0001eca0: 2020 2020 2061 7373 6572 7420 6c65 6e28       assert len(
-0001ecb0: 6365 6c6c 5f65 7865 635b 2270 6172 656e  cell_exec["paren
-0001ecc0: 745f 6964 225d 2920 696e 206d 7367 5f69  t_id"]) in msg_i
-0001ecd0: 645f 6c65 6e67 7468 730a 2020 2020 2020  d_lengths.      
-0001ece0: 2020 2020 2020 2020 2020 7265 6365 6976            receiv
-0001ecf0: 6564 5f69 6e66 6f5b 2272 6563 6569 7665  ed_info["receive
-0001ed00: 645f 6365 6c6c 5f65 7865 6375 7469 6f6e  d_cell_execution
-0001ed10: 225d 203d 2054 7275 650a 0a20 2020 2020  "] = True..     
-0001ed20: 2020 2020 2020 206d 7367 5f74 7970 6573         msg_types
-0001ed30: 203d 205b 0a20 2020 2020 2020 2020 2020   = [.           
-0001ed40: 2020 2020 2022 6365 6c6c 5f73 7472 6561       "cell_strea
-0001ed50: 6d22 2c0a 2020 2020 2020 2020 2020 2020  m",.            
-0001ed60: 2020 2020 2263 656c 6c5f 7570 6461 7465      "cell_update
-0001ed70: 222c 0a20 2020 2020 2020 2020 2020 2020  ",.             
-0001ed80: 2020 2022 6365 6c6c 5f65 7865 6375 7469     "cell_executi
-0001ed90: 6f6e 5f72 6570 6c79 222c 0a20 2020 2020  on_reply",.     
-0001eda0: 2020 2020 2020 2020 2020 2022 7661 7273             "vars
-0001edb0: 222c 0a20 2020 2020 2020 2020 2020 205d  ",.            ]
-0001edc0: 0a20 2020 2020 2020 2020 2020 2066 6f72  .            for
-0001edd0: 2069 2069 6e20 7261 6e67 6528 3529 3a0a   i in range(5):.
-0001ede0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001edf0: 6461 7461 203d 2061 7761 6974 2072 6563  data = await rec
-0001ee00: 6569 7665 5f6a 736f 6e28 7765 6273 6f63  eive_json(websoc
-0001ee10: 6b65 742c 2032 302c 206d 7367 5f74 7970  ket, 20, msg_typ
-0001ee20: 6573 3d6d 7367 5f74 7970 6573 290a 2020  es=msg_types).  
-0001ee30: 2020 2020 2020 2020 2020 2020 2020 6966                if
-0001ee40: 2022 6365 6c6c 5f73 7472 6561 6d22 2069   "cell_stream" i
-0001ee50: 6e20 6461 7461 3a0a 2020 2020 2020 2020  n data:.        
-0001ee60: 2020 2020 2020 2020 2020 2020 6365 6c6c              cell
-0001ee70: 5f73 7472 6561 6d73 2e61 7070 656e 6428  _streams.append(
-0001ee80: 6177 6169 7420 7265 6365 6976 655f 6365  await receive_ce
-0001ee90: 6c6c 5f73 7472 6561 6d28 6461 7461 2929  ll_stream(data))
-0001eea0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-0001eeb0: 2069 6620 2263 656c 6c5f 7570 6461 7465   if "cell_update
-0001eec0: 2220 696e 2064 6174 613a 0a20 2020 2020  " in data:.     
-0001eed0: 2020 2020 2020 2020 2020 2020 2020 2061                 a
-0001eee0: 7761 6974 2072 6563 6569 7665 5f63 656c  wait receive_cel
-0001eef0: 6c5f 7570 6461 7465 2864 6174 6129 0a20  l_update(data). 
-0001ef00: 2020 2020 2020 2020 2020 2020 2020 2069                 i
-0001ef10: 6620 2263 656c 6c5f 6578 6563 7574 696f  f "cell_executio
-0001ef20: 6e5f 7265 706c 7922 2069 6e20 6461 7461  n_reply" in data
-0001ef30: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
-0001ef40: 2020 2020 2020 6177 6169 7420 7265 6365        await rece
-0001ef50: 6976 655f 6365 6c6c 5f65 7865 6375 7469  ive_cell_executi
-0001ef60: 6f6e 2864 6174 6129 0a20 2020 2020 2020  on(data).       
-0001ef70: 2020 2020 2020 2020 2069 6620 2276 6172           if "var
-0001ef80: 7322 2069 6e20 6461 7461 3a0a 2020 2020  s" in data:.    
-0001ef90: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001efa0: 7265 6365 6976 6564 5f69 6e66 6f5b 2272  received_info["r
-0001efb0: 6563 6569 7665 645f 7661 7273 225d 203d  eceived_vars"] =
-0001efc0: 2054 7275 650a 0a20 2020 2020 2020 2020   True..         
-0001efd0: 2020 2061 7373 6572 7420 7265 6365 6976     assert receiv
-0001efe0: 6564 5f69 6e66 6f5b 2272 6563 6569 7665  ed_info["receive
-0001eff0: 645f 6365 6c6c 5f75 7064 6174 655f 636f  d_cell_update_co
-0001f000: 756e 7422 5d20 3d3d 2032 0a20 2020 2020  unt"] == 2.     
-0001f010: 2020 2020 2020 2061 7373 6572 7420 7265         assert re
-0001f020: 6365 6976 6564 5f69 6e66 6f5b 2272 6563  ceived_info["rec
-0001f030: 6569 7665 645f 6365 6c6c 5f65 7865 6375  eived_cell_execu
-0001f040: 7469 6f6e 225d 0a20 2020 2020 2020 2020  tion"].         
-0001f050: 2020 2061 7373 6572 7420 7265 6365 6976     assert receiv
-0001f060: 6564 5f69 6e66 6f5b 2272 6563 6569 7665  ed_info["receive
-0001f070: 645f 7661 7273 225d 0a20 2020 2020 2020  d_vars"].       
-0001f080: 2020 2020 2061 7373 6572 7420 7265 6365       assert rece
-0001f090: 6976 6564 5f69 6e66 6f5b 2272 6563 6569  ived_info["recei
-0001f0a0: 7665 645f 6365 6c6c 5f73 7472 6561 6d5f  ved_cell_stream_
-0001f0b0: 636f 756e 7422 5d20 3d3d 2031 0a0a 2020  count"] == 1..  
-0001f0c0: 2020 2020 2020 2020 2020 6578 6563 7574            execut
-0001f0d0: 655f 6431 5f63 6f6d 6d61 6e64 2e61 7373  e_d1_command.ass
-0001f0e0: 6572 745f 6861 735f 6361 6c6c 7328 0a20  ert_has_calls(. 
-0001f0f0: 2020 2020 2020 2020 2020 2020 2020 205b                 [
-0001f100: 6361 6c6c 286e 6f74 6529 2066 6f72 206e  call(note) for n
-0001f110: 6f74 6520 696e 206e 6f74 6966 6963 6174  ote in notificat
-0001f120: 696f 6e73 5d0a 2020 2020 2020 2020 2020  ions].          
-0001f130: 2020 290a 0a20 2020 2040 7079 7465 7374    )..    @pytest
-0001f140: 2e6d 6172 6b2e 6173 796e 6369 6f0a 2020  .mark.asyncio.  
-0001f150: 2020 6173 796e 6320 6465 6620 7465 7374    async def test
-0001f160: 5f64 315f 6e6f 7469 6679 280a 2020 2020  _d1_notify(.    
-0001f170: 2020 2020 7365 6c66 2c0a 2020 2020 2020      self,.      
-0001f180: 2020 636c 6965 6e74 3a20 5465 7374 436c    client: TestCl
-0001f190: 6965 6e74 2c0a 2020 2020 2020 2020 7375  ient,.        su
-0001f1a0: 7065 7275 7365 725f 746f 6b65 6e5f 6865  peruser_token_he
-0001f1b0: 6164 6572 733a 2044 6963 745b 7374 722c  aders: Dict[str,
-0001f1c0: 2073 7472 5d2c 0a20 2020 2020 2020 206d   str],.        m
-0001f1d0: 6f63 6b65 723a 204d 6f63 6b46 6978 7475  ocker: MockFixtu
-0001f1e0: 7265 2c0a 2020 2020 293a 0a20 2020 2020  re,.    ):.     
-0001f1f0: 2020 2063 656c 6c5f 636f 6e74 656e 7420     cell_content 
-0001f200: 3d20 280a 2020 2020 2020 2020 2020 2020  = (.            
-0001f210: 2770 7269 6e74 2822 5f5f 5f63 616c 6c69  'print("___calli
-0001f220: 7374 6f5f 6431 5f63 6f6d 6d61 6e64 5f5f  sto_d1_command__
-0001f230: 5f7b 270a 2020 2020 2020 2020 2020 2020  _{'.            
-0001f240: 275c 5c22 636f 6d6d 616e 645f 7479 7065  '\\"command_type
-0001f250: 5c5c 223a 5c5c 226e 6f74 6966 795c 5c22  \\":\\"notify\\"
-0001f260: 2c27 0a20 2020 2020 2020 2020 2020 2027  ,'.            '
-0001f270: 5c5c 2274 6974 6c65 5c5c 223a 5c5c 2261  \\"title\\":\\"a
-0001f280: 7469 746c 655c 5c22 2c27 0a20 2020 2020  title\\",'.     
-0001f290: 2020 2020 2020 2027 5c5c 226d 6573 7361         '\\"messa
-0001f2a0: 6765 5c5c 223a 5c5c 2274 6573 7436 6534  ge\\":\\"test6e4
-0001f2b0: 5c5c 227d 5f5f 5f63 616c 6c69 7374 6f5f  \\"}___callisto_
-0001f2c0: 6431 5f63 6f6d 6d61 6e64 5f5f 5f22 2c20  d1_command___", 
-0001f2d0: 270a 2020 2020 2020 2020 2020 2020 2720  '.            ' 
-0001f2e0: 656e 643d 2222 2927 0a20 2020 2020 2020  end="")'.       
-0001f2f0: 2029 0a20 2020 2020 2020 206e 6f74 6966   ).        notif
-0001f300: 6963 6174 696f 6e73 203d 205b 0a20 2020  ications = [.   
-0001f310: 2020 2020 2020 2020 2027 7b22 636f 6d6d           '{"comm
-0001f320: 616e 645f 7479 7065 223a 226e 6f74 6966  and_type":"notif
-0001f330: 7922 2c27 0a20 2020 2020 2020 2020 2020  y",'.           
-0001f340: 2027 2274 6974 6c65 223a 2261 7469 746c   '"title":"atitl
-0001f350: 6522 2c27 0a20 2020 2020 2020 2020 2020  e",'.           
-0001f360: 2027 226d 6573 7361 6765 223a 2274 6573   '"message":"tes
-0001f370: 7436 6534 227d 270a 2020 2020 2020 2020  t6e4"}'.        
-0001f380: 5d0a 2020 2020 2020 2020 6177 6169 7420  ].        await 
-0001f390: 7365 6c66 2e64 6f5f 7465 7374 5f64 315f  self.do_test_d1_
-0001f3a0: 6e6f 7469 6679 280a 2020 2020 2020 2020  notify(.        
-0001f3b0: 2020 2020 6365 6c6c 5f63 6f6e 7465 6e74      cell_content
-0001f3c0: 2c0a 2020 2020 2020 2020 2020 2020 6e6f  ,.            no
-0001f3d0: 7469 6669 6361 7469 6f6e 732c 0a20 2020  tifications,.   
-0001f3e0: 2020 2020 2020 2020 2022 222c 0a20 2020           "",.   
-0001f3f0: 2020 2020 2020 2020 2063 6c69 656e 742c           client,
-0001f400: 0a20 2020 2020 2020 2020 2020 2073 7570  .            sup
-0001f410: 6572 7573 6572 5f74 6f6b 656e 5f68 6561  eruser_token_hea
-0001f420: 6465 7273 2c0a 2020 2020 2020 2020 2020  ders,.          
-0001f430: 2020 6d6f 636b 6572 2c0a 2020 2020 2020    mocker,.      
-0001f440: 2020 290a 0a20 2020 2040 7079 7465 7374    )..    @pytest
-0001f450: 2e6d 6172 6b2e 6173 796e 6369 6f0a 2020  .mark.asyncio.  
-0001f460: 2020 6173 796e 6320 6465 6620 7465 7374    async def test
-0001f470: 5f64 315f 6e6f 7469 6679 5f69 6e63 6f6d  _d1_notify_incom
-0001f480: 706c 6574 6528 0a20 2020 2020 2020 2073  plete(.        s
-0001f490: 656c 662c 0a20 2020 2020 2020 2063 6c69  elf,.        cli
-0001f4a0: 656e 743a 2054 6573 7443 6c69 656e 742c  ent: TestClient,
-0001f4b0: 0a20 2020 2020 2020 2073 7570 6572 7573  .        superus
-0001f4c0: 6572 5f74 6f6b 656e 5f68 6561 6465 7273  er_token_headers
-0001f4d0: 3a20 4469 6374 5b73 7472 2c20 7374 725d  : Dict[str, str]
-0001f4e0: 2c0a 2020 2020 2020 2020 6d6f 636b 6572  ,.        mocker
-0001f4f0: 3a20 4d6f 636b 4669 7874 7572 652c 0a20  : MockFixture,. 
-0001f500: 2020 2029 3a0a 2020 2020 2020 2020 6365     ):.        ce
-0001f510: 6c6c 5f63 6f6e 7465 6e74 203d 2028 0a20  ll_content = (. 
-0001f520: 2020 2020 2020 2020 2020 2027 7072 696e             'prin
-0001f530: 7428 2272 7568 5f5f 5f63 616c 6c69 7374  t("ruh___callist
-0001f540: 6f5f 6431 5f63 6f6d 6d61 6e64 5f5f 5f7b  o_d1_command___{
-0001f550: 270a 2020 2020 2020 2020 2020 2020 275c  '.            '\
-0001f560: 5c22 636f 6d6d 616e 645f 7479 7065 5c5c  \"command_type\\
-0001f570: 223a 5c5c 226e 6f74 6966 795c 5c22 2c27  ":\\"notify\\",'
-0001f580: 0a20 2020 2020 2020 2020 2020 2027 5c5c  .            '\\
-0001f590: 2274 6974 6c65 5c5c 223a 5c5c 2261 7469  "title\\":\\"ati
-0001f5a0: 746c 655c 5c22 2c27 0a20 2020 2020 2020  tle\\",'.       
-0001f5b0: 2020 2020 2027 5c5c 226d 6573 7361 6765       '\\"message
-0001f5c0: 5c5c 223a 5c5c 2274 6573 7436 6534 5c5c  \\":\\"test6e4\\
-0001f5d0: 227d 5f5f 5f63 616c 6c69 7374 6f5f 6431  "}___callisto_d1
-0001f5e0: 5f63 6f6d 6d61 6e64 5f5f 5f6d 6f72 6927  _command___mori'
-0001f5f0: 0a20 2020 2020 2020 2020 2020 2027 5f5f  .            '__
-0001f600: 5f63 616c 6c69 7374 6f5f 6431 5f63 6f6d  _callisto_d1_com
-0001f610: 6d61 6e64 5f5f 5f6a 6a75 6f22 2c20 270a  mand___jjuo", '.
-0001f620: 2020 2020 2020 2020 2020 2020 2720 656e              ' en
-0001f630: 643d 2222 2927 0a20 2020 2020 2020 2029  d="")'.        )
-0001f640: 0a20 2020 2020 2020 206e 6f74 6966 6963  .        notific
-0001f650: 6174 696f 6e73 203d 205b 0a20 2020 2020  ations = [.     
-0001f660: 2020 2020 2020 2027 7b22 636f 6d6d 616e         '{"comman
-0001f670: 645f 7479 7065 223a 226e 6f74 6966 7922  d_type":"notify"
-0001f680: 2c27 0a20 2020 2020 2020 2020 2020 2027  ,'.            '
-0001f690: 2274 6974 6c65 223a 2261 7469 746c 6522  "title":"atitle"
-0001f6a0: 2c27 0a20 2020 2020 2020 2020 2020 2027  ,'.            '
-0001f6b0: 226d 6573 7361 6765 223a 2274 6573 7436  "message":"test6
-0001f6c0: 6534 227d 270a 2020 2020 2020 2020 5d0a  e4"}'.        ].
-0001f6d0: 2020 2020 2020 2020 6177 6169 7420 7365          await se
-0001f6e0: 6c66 2e64 6f5f 7465 7374 5f64 315f 6e6f  lf.do_test_d1_no
-0001f6f0: 7469 6679 280a 2020 2020 2020 2020 2020  tify(.          
-0001f700: 2020 6365 6c6c 5f63 6f6e 7465 6e74 2c0a    cell_content,.
-0001f710: 2020 2020 2020 2020 2020 2020 6e6f 7469              noti
-0001f720: 6669 6361 7469 6f6e 732c 0a20 2020 2020  fications,.     
-0001f730: 2020 2020 2020 2022 7275 686d 6f72 696a         "ruhmorij
-0001f740: 6a75 6f22 2c0a 2020 2020 2020 2020 2020  juo",.          
-0001f750: 2020 636c 6965 6e74 2c0a 2020 2020 2020    client,.      
-0001f760: 2020 2020 2020 7375 7065 7275 7365 725f        superuser_
-0001f770: 746f 6b65 6e5f 6865 6164 6572 732c 0a20  token_headers,. 
-0001f780: 2020 2020 2020 2020 2020 206d 6f63 6b65             mocke
-0001f790: 722c 0a20 2020 2020 2020 2029 0a0a 2020  r,.        )..  
-0001f7a0: 2020 4070 7974 6573 742e 6d61 726b 2e61    @pytest.mark.a
-0001f7b0: 7379 6e63 696f 0a20 2020 2061 7379 6e63  syncio.    async
-0001f7c0: 2064 6566 2074 6573 745f 6431 5f6e 6f74   def test_d1_not
-0001f7d0: 6966 795f 696e 7661 6c69 645f 636f 6d6d  ify_invalid_comm
-0001f7e0: 616e 6428 0a20 2020 2020 2020 2073 656c  and(.        sel
-0001f7f0: 662c 0a20 2020 2020 2020 2063 6c69 656e  f,.        clien
-0001f800: 743a 2054 6573 7443 6c69 656e 742c 0a20  t: TestClient,. 
-0001f810: 2020 2020 2020 2073 7570 6572 7573 6572         superuser
-0001f820: 5f74 6f6b 656e 5f68 6561 6465 7273 3a20  _token_headers: 
-0001f830: 4469 6374 5b73 7472 2c20 7374 725d 2c0a  Dict[str, str],.
-0001f840: 2020 2020 2020 2020 6d6f 636b 6572 3a20          mocker: 
-0001f850: 4d6f 636b 4669 7874 7572 652c 0a20 2020  MockFixture,.   
-0001f860: 2029 3a0a 2020 2020 2020 2020 6365 6c6c   ):.        cell
-0001f870: 5f63 6f6e 7465 6e74 203d 2028 0a20 2020  _content = (.   
-0001f880: 2020 2020 2020 2020 2027 7072 696e 7428           'print(
-0001f890: 225f 5f5f 6361 6c6c 6973 746f 5f64 315f  "___callisto_d1_
-0001f8a0: 636f 6d6d 616e 645f 5f5f 7b27 0a20 2020  command___{'.   
-0001f8b0: 2020 2020 2020 2020 2027 5c5c 2263 6f6d           '\\"com
-0001f8c0: 6d61 6e64 5f74 7970 655c 5c22 3a5c 5c22  mand_type\\":\\"
-0001f8d0: 6e6f 7469 6679 5c5c 222c 270a 2020 2020  notify\\",'.    
-0001f8e0: 2020 2020 2020 2020 275c 5c22 7469 746c          '\\"titl
-0001f8f0: 655c 5c22 3a5c 5c22 6174 6974 6c65 5c5c  e\\":\\"atitle\\
-0001f900: 222c 270a 2020 2020 2020 2020 2020 2020  ",'.            
-0001f910: 275c 5c22 6d65 7373 6167 655c 5c22 3a5c  '\\"message\\":\
-0001f920: 5c22 7465 7374 3665 345c 5c22 7d5f 5f5f  \"test6e4\\"}___
-0001f930: 6361 6c6c 6973 746f 5f64 315f 636f 6d6d  callisto_d1_comm
-0001f940: 616e 645f 5f5f 6d6f 7269 270a 2020 2020  and___mori'.    
-0001f950: 2020 2020 2020 2020 225f 5f5f 6361 6c6c          "___call
-0001f960: 6973 746f 5f64 315f 636f 6d6d 616e 645f  isto_d1_command_
-0001f970: 5f5f 7b6a 6a75 6f7d 5f5f 5f63 616c 6c69  __{jjuo}___calli
-0001f980: 7374 6f5f 6431 5f63 6f6d 6d61 6e64 5f5f  sto_d1_command__
-0001f990: 5f22 0a20 2020 2020 2020 2020 2020 2027  _".            '
-0001f9a0: 7768 6579 222c 2027 0a20 2020 2020 2020  whey", '.       
-0001f9b0: 2020 2020 2027 2065 6e64 3d22 2229 270a       ' end="")'.
-0001f9c0: 2020 2020 2020 2020 290a 2020 2020 2020          ).      
-0001f9d0: 2020 6e6f 7469 6669 6361 7469 6f6e 7320    notifications 
-0001f9e0: 3d20 5b0a 2020 2020 2020 2020 2020 2020  = [.            
-0001f9f0: 277b 2263 6f6d 6d61 6e64 5f74 7970 6522  '{"command_type"
-0001fa00: 3a22 6e6f 7469 6679 222c 270a 2020 2020  :"notify",'.    
-0001fa10: 2020 2020 2020 2020 2722 7469 746c 6522          '"title"
-0001fa20: 3a22 6174 6974 6c65 222c 270a 2020 2020  :"atitle",'.    
-0001fa30: 2020 2020 2020 2020 2722 6d65 7373 6167          '"messag
-0001fa40: 6522 3a22 7465 7374 3665 3422 7d27 2c0a  e":"test6e4"}',.
-0001fa50: 2020 2020 2020 2020 2020 2020 227b 6a6a              "{jj
-0001fa60: 756f 7d22 2c0a 2020 2020 2020 2020 5d0a  uo}",.        ].
-0001fa70: 2020 2020 2020 2020 6177 6169 7420 7365          await se
-0001fa80: 6c66 2e64 6f5f 7465 7374 5f64 315f 6e6f  lf.do_test_d1_no
-0001fa90: 7469 6679 280a 2020 2020 2020 2020 2020  tify(.          
-0001faa0: 2020 6365 6c6c 5f63 6f6e 7465 6e74 2c0a    cell_content,.
-0001fab0: 2020 2020 2020 2020 2020 2020 6e6f 7469              noti
-0001fac0: 6669 6361 7469 6f6e 732c 0a20 2020 2020  fications,.     
-0001fad0: 2020 2020 2020 2022 6d6f 7269 7768 6579         "moriwhey
-0001fae0: 222c 0a20 2020 2020 2020 2020 2020 2063  ",.            c
-0001faf0: 6c69 656e 742c 0a20 2020 2020 2020 2020  lient,.         
-0001fb00: 2020 2073 7570 6572 7573 6572 5f74 6f6b     superuser_tok
-0001fb10: 656e 5f68 6561 6465 7273 2c0a 2020 2020  en_headers,.    
-0001fb20: 2020 2020 2020 2020 6d6f 636b 6572 2c0a          mocker,.
-0001fb30: 2020 2020 2020 2020 290a 0a0a 4070 7974          )...@pyt
-0001fb40: 6573 742e 6d61 726b 2e75 7365 6669 7874  est.mark.usefixt
-0001fb50: 7572 6573 2822 636c 6561 725f 6e6f 7465  ures("clear_note
-0001fb60: 626f 6f6b 7322 2c20 2263 6c65 6172 5f6e  books", "clear_n
-0001fb70: 6f74 6562 6f6f 6b5f 6469 7265 6374 6f72  otebook_director
-0001fb80: 7922 290a 636c 6173 7320 5465 7374 4e6f  y").class TestNo
-0001fb90: 7465 626f 6f6b 7357 6562 536f 636b 6574  tebooksWebSocket
-0001fba0: 3a0a 2020 2020 6173 796e 6320 6465 6620  :.    async def 
-0001fbb0: 6765 745f 6e6f 7465 626f 6f6b 735f 6576  get_notebooks_ev
-0001fbc0: 656e 7428 7365 6c66 2c20 7765 6273 6f63  ent(self, websoc
-0001fbd0: 6b65 7429 3a0a 2020 2020 2020 2020 666f  ket):.        fo
-0001fbe0: 7220 6920 696e 2072 616e 6765 2835 293a  r i in range(5):
-0001fbf0: 0a20 2020 2020 2020 2020 2020 2064 6174  .            dat
-0001fc00: 6120 3d20 6177 6169 7420 7265 6365 6976  a = await receiv
-0001fc10: 655f 6a73 6f6e 2877 6562 736f 636b 6574  e_json(websocket
-0001fc20: 290a 2020 2020 2020 2020 2020 2020 6966  ).            if
-0001fc30: 2022 6e6f 7465 626f 6f6b 7322 2069 6e20   "notebooks" in 
-0001fc40: 6461 7461 3a0a 2020 2020 2020 2020 2020  data:.          
-0001fc50: 2020 2020 2020 6272 6561 6b0a 2020 2020        break.    
-0001fc60: 2020 2020 7265 7475 726e 2064 6174 610a      return data.
-0001fc70: 0a20 2020 2040 7079 7465 7374 2e6d 6172  .    @pytest.mar
-0001fc80: 6b2e 6173 796e 6369 6f0a 2020 2020 6173  k.asyncio.    as
-0001fc90: 796e 6320 6465 6620 7465 7374 5f6e 6f74  ync def test_not
-0001fca0: 6562 6f6f 6b73 5f75 7064 6174 6573 280a  ebooks_updates(.
-0001fcb0: 2020 2020 2020 2020 7365 6c66 2c20 636c          self, cl
-0001fcc0: 6965 6e74 3a20 5465 7374 436c 6965 6e74  ient: TestClient
-0001fcd0: 2c20 7375 7065 7275 7365 725f 746f 6b65  , superuser_toke
-0001fce0: 6e5f 6865 6164 6572 733a 2044 6963 745b  n_headers: Dict[
-0001fcf0: 7374 722c 2073 7472 5d0a 2020 2020 293a  str, str].    ):
-0001fd00: 0a0a 2020 2020 2020 2020 6173 796e 6320  ..        async 
-0001fd10: 7769 7468 2063 6c69 656e 742e 7765 6273  with client.webs
-0001fd20: 6f63 6b65 745f 636f 6e6e 6563 7428 0a20  ocket_connect(. 
-0001fd30: 2020 2020 2020 2020 2020 2066 222f 7365             f"/se
-0001fd40: 7276 6572 2f77 7322 2c20 6865 6164 6572  rver/ws", header
-0001fd50: 733d 7375 7065 7275 7365 725f 746f 6b65  s=superuser_toke
-0001fd60: 6e5f 6865 6164 6572 730a 2020 2020 2020  n_headers.      
-0001fd70: 2020 2920 6173 2077 6562 736f 636b 6574    ) as websocket
-0001fd80: 3a0a 0a20 2020 2020 2020 2020 2020 2061  :..            a
-0001fd90: 7761 6974 2061 7379 6e63 696f 2e73 6c65  wait asyncio.sle
-0001fda0: 6570 2857 4542 534f 434b 4554 5f53 4c45  ep(WEBSOCKET_SLE
-0001fdb0: 4550 5f54 494d 4529 0a0a 2020 2020 2020  EP_TIME)..      
-0001fdc0: 2020 2020 2020 7575 6964 203d 2061 7761        uuid = awa
-0001fdd0: 6974 2075 706c 6f61 645f 6e6f 7465 626f  it upload_notebo
-0001fde0: 6f6b 2863 6c69 656e 742c 2073 7570 6572  ok(client, super
-0001fdf0: 7573 6572 5f74 6f6b 656e 5f68 6561 6465  user_token_heade
-0001fe00: 7273 290a 0a20 2020 2020 2020 2020 2020  rs)..           
-0001fe10: 2064 6174 6120 3d20 6177 6169 7420 7761   data = await wa
-0001fe20: 6974 5f66 6f72 5f65 7665 6e74 2877 6562  it_for_event(web
-0001fe30: 736f 636b 6574 2c20 226e 6f74 6562 6f6f  socket, "noteboo
-0001fe40: 6b73 222c 2074 7269 6573 3d31 3030 290a  ks", tries=100).
-0001fe50: 2020 2020 2020 2020 2020 2020 6173 7365              asse
-0001fe60: 7274 206c 656e 2864 6174 615b 226e 6f74  rt len(data["not
-0001fe70: 6562 6f6f 6b73 225d 2920 3d3d 2031 0a20  ebooks"]) == 1. 
-0001fe80: 2020 2020 2020 2020 2020 2061 7373 6572             asser
-0001fe90: 7420 6461 7461 5b22 6e6f 7465 626f 6f6b  t data["notebook
-0001fea0: 7322 5d5b 305d 5b22 7575 6964 225d 203d  s"][0]["uuid"] =
-0001feb0: 3d20 7575 6964 0a20 2020 2020 2020 2020  = uuid.         
-0001fec0: 2020 2061 7373 6572 7420 6461 7461 5b22     assert data["
-0001fed0: 6e6f 7465 626f 6f6b 7322 5d5b 305d 5b22  notebooks"][0]["
-0001fee0: 6e61 6d65 225d 203d 3d20 2273 696d 706c  name"] == "simpl
-0001fef0: 6522 0a0a 2020 2020 2020 2020 2020 2020  e"..            
-0001ff00: 7575 6964 3220 3d20 6177 6169 7420 7570  uuid2 = await up
-0001ff10: 6c6f 6164 5f6e 6f74 6562 6f6f 6b28 0a20  load_notebook(. 
-0001ff20: 2020 2020 2020 2020 2020 2020 2020 2063                 c
-0001ff30: 6c69 656e 742c 0a20 2020 2020 2020 2020  lient,.         
-0001ff40: 2020 2020 2020 2073 7570 6572 7573 6572         superuser
-0001ff50: 5f74 6f6b 656e 5f68 6561 6465 7273 2c0a  _token_headers,.
-0001ff60: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001ff70: 6669 6c65 6e61 6d65 3d22 7374 6174 6566  filename="statef
-0001ff80: 756c 5f73 696d 706c 652e 6970 796e 6222  ul_simple.ipynb"
-0001ff90: 2c0a 2020 2020 2020 2020 2020 2020 290a  ,.            ).
-0001ffa0: 2020 2020 2020 2020 2020 2020 6461 7461              data
-0001ffb0: 203d 2061 7761 6974 2077 6169 745f 666f   = await wait_fo
-0001ffc0: 725f 6576 656e 7428 7765 6273 6f63 6b65  r_event(websocke
-0001ffd0: 742c 2022 6e6f 7465 626f 6f6b 7322 2c20  t, "notebooks", 
-0001ffe0: 7472 6965 733d 3130 3029 0a20 2020 2020  tries=100).     
-0001fff0: 2020 2020 2020 2061 7373 6572 7420 6c65         assert le
-00020000: 6e28 6461 7461 5b22 6e6f 7465 626f 6f6b  n(data["notebook
-00020010: 7322 5d29 203d 3d20 320a 2020 2020 2020  s"]) == 2.      
-00020020: 2020 2020 2020 6173 7365 7274 2064 6174        assert dat
-00020030: 615b 226e 6f74 6562 6f6f 6b73 225d 5b30  a["notebooks"][0
-00020040: 5d5b 2275 7569 6422 5d20 3d3d 2075 7569  ]["uuid"] == uui
-00020050: 640a 2020 2020 2020 2020 2020 2020 6173  d.            as
-00020060: 7365 7274 2064 6174 615b 226e 6f74 6562  sert data["noteb
-00020070: 6f6f 6b73 225d 5b30 5d5b 226e 616d 6522  ooks"][0]["name"
-00020080: 5d20 3d3d 2022 7369 6d70 6c65 220a 2020  ] == "simple".  
-00020090: 2020 2020 2020 2020 2020 6173 7365 7274            assert
-000200a0: 2064 6174 615b 226e 6f74 6562 6f6f 6b73   data["notebooks
-000200b0: 225d 5b31 5d5b 2275 7569 6422 5d20 3d3d  "][1]["uuid"] ==
-000200c0: 2075 7569 6432 0a20 2020 2020 2020 2020   uuid2.         
-000200d0: 2020 2061 7373 6572 7420 6461 7461 5b22     assert data["
-000200e0: 6e6f 7465 626f 6f6b 7322 5d5b 315d 5b22  notebooks"][1]["
-000200f0: 6e61 6d65 225d 203d 3d20 2273 7461 7465  name"] == "state
-00020100: 6675 6c5f 7369 6d70 6c65 220a 0a20 2020  ful_simple"..   
-00020110: 2020 2020 2020 2020 2072 6573 706f 6e73           respons
-00020120: 6520 3d20 6177 6169 7420 636c 6965 6e74  e = await client
-00020130: 2e64 656c 6574 6528 0a20 2020 2020 2020  .delete(.       
-00020140: 2020 2020 2020 2020 2066 222f 6e6f 7465           f"/note
-00020150: 626f 6f6b 732f 7b75 7569 647d 222c 2068  books/{uuid}", h
-00020160: 6561 6465 7273 3d73 7570 6572 7573 6572  eaders=superuser
-00020170: 5f74 6f6b 656e 5f68 6561 6465 7273 0a20  _token_headers. 
-00020180: 2020 2020 2020 2020 2020 2029 0a20 2020             ).   
-00020190: 2020 2020 2020 2020 2061 7373 6572 7420           assert 
-000201a0: 7265 7370 6f6e 7365 2e73 7461 7475 735f  response.status_
-000201b0: 636f 6465 203d 3d20 3230 340a 2020 2020  code == 204.    
-000201c0: 2020 2020 2020 2020 6461 7461 203d 2061          data = a
-000201d0: 7761 6974 2077 6169 745f 666f 725f 6576  wait wait_for_ev
-000201e0: 656e 7428 7765 6273 6f63 6b65 742c 2022  ent(websocket, "
-000201f0: 6e6f 7465 626f 6f6b 7322 2c20 7472 6965  notebooks", trie
-00020200: 733d 3130 3029 0a20 2020 2020 2020 2020  s=100).         
-00020210: 2020 2061 7373 6572 7420 6c65 6e28 6461     assert len(da
-00020220: 7461 5b22 6e6f 7465 626f 6f6b 7322 5d29  ta["notebooks"])
-00020230: 203d 3d20 310a 2020 2020 2020 2020 2020   == 1.          
-00020240: 2020 6173 7365 7274 2064 6174 615b 226e    assert data["n
-00020250: 6f74 6562 6f6f 6b73 225d 5b30 5d5b 2275  otebooks"][0]["u
-00020260: 7569 6422 5d20 3d3d 2075 7569 6432 0a20  uid"] == uuid2. 
-00020270: 2020 2020 2020 2020 2020 2061 7373 6572             asser
-00020280: 7420 6461 7461 5b22 6e6f 7465 626f 6f6b  t data["notebook
-00020290: 7322 5d5b 305d 5b22 6e61 6d65 225d 203d  s"][0]["name"] =
-000202a0: 3d20 2273 7461 7465 6675 6c5f 7369 6d70  = "stateful_simp
-000202b0: 6c65 220a 0a20 2020 2020 2020 2020 2020  le"..           
-000202c0: 2072 6573 706f 6e73 6520 3d20 6177 6169   response = awai
-000202d0: 7420 636c 6965 6e74 2e64 656c 6574 6528  t client.delete(
-000202e0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-000202f0: 2022 2f6e 6f74 6562 6f6f 6b73 222c 2068   "/notebooks", h
-00020300: 6561 6465 7273 3d73 7570 6572 7573 6572  eaders=superuser
-00020310: 5f74 6f6b 656e 5f68 6561 6465 7273 0a20  _token_headers. 
-00020320: 2020 2020 2020 2020 2020 2029 0a20 2020             ).   
-00020330: 2020 2020 2020 2020 2061 7373 6572 7420           assert 
-00020340: 7265 7370 6f6e 7365 2e73 7461 7475 735f  response.status_
-00020350: 636f 6465 203d 3d20 3230 340a 2020 2020  code == 204.    
-00020360: 2020 2020 2020 2020 6461 7461 203d 2061          data = a
-00020370: 7761 6974 2077 6169 745f 666f 725f 6576  wait wait_for_ev
-00020380: 656e 7428 7765 6273 6f63 6b65 742c 2022  ent(websocket, "
-00020390: 6e6f 7465 626f 6f6b 7322 2c20 7472 6965  notebooks", trie
-000203a0: 733d 3130 3029 0a20 2020 2020 2020 2020  s=100).         
-000203b0: 2020 2061 7373 6572 7420 6c65 6e28 6461     assert len(da
-000203c0: 7461 5b22 6e6f 7465 626f 6f6b 7322 5d29  ta["notebooks"])
-000203d0: 203d 3d20 300a                            == 0.
+00012590: 2020 2020 2020 2020 2020 290a 0a20 2020            )..   
+000125a0: 2020 2020 2020 2020 2061 7373 6572 7420           assert 
+000125b0: 7265 7370 6f6e 7365 2e73 7461 7475 735f  response.status_
+000125c0: 636f 6465 203d 3d20 3230 340a 0a20 2020  code == 204..   
+000125d0: 2020 2020 2020 2020 2064 6174 6120 3d20           data = 
+000125e0: 6177 6169 7420 7761 6974 5f66 6f72 5f65  await wait_for_e
+000125f0: 7665 6e74 2877 6562 736f 636b 6574 2c20  vent(websocket, 
+00012600: 226b 6572 6e65 6c5f 7265 7374 6172 7465  "kernel_restarte
+00012610: 6422 290a 0a20 2020 2020 2020 2020 2020  d")..           
+00012620: 2061 7373 6572 7420 6461 7461 5b22 6b65   assert data["ke
+00012630: 726e 656c 5f72 6573 7461 7274 6564 225d  rnel_restarted"]
+00012640: 5b22 7275 6e5f 616c 6c5f 6365 6c6c 7322  ["run_all_cells"
+00012650: 5d20 6973 2046 616c 7365 0a20 2020 2020  ] is False.     
+00012660: 2020 2020 2020 2063 656c 6c73 203d 2064         cells = d
+00012670: 6174 615b 226b 6572 6e65 6c5f 7265 7374  ata["kernel_rest
+00012680: 6172 7465 6422 5d5b 2263 656c 6c73 225d  arted"]["cells"]
+00012690: 0a20 2020 2020 2020 2020 2020 2066 6f72  .            for
+000126a0: 2063 656c 6c20 696e 2063 656c 6c73 3a0a   cell in cells:.
+000126b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000126c0: 6173 7365 7274 2028 0a20 2020 2020 2020  assert (.       
+000126d0: 2020 2020 2020 2020 2020 2020 2028 226f               ("o
+000126e0: 7574 7075 7473 2220 6e6f 7420 696e 2063  utputs" not in c
+000126f0: 656c 6c20 6f72 206c 656e 2863 656c 6c5b  ell or len(cell[
+00012700: 226f 7574 7075 7473 225d 2920 3d3d 2030  "outputs"]) == 0
+00012710: 290a 2020 2020 2020 2020 2020 2020 2020  ).              
+00012720: 2020 2020 2020 616e 6420 2265 7865 6375        and "execu
+00012730: 7469 6f6e 5f63 6f75 6e74 2220 6e6f 7420  tion_count" not 
+00012740: 696e 2063 656c 6c0a 2020 2020 2020 2020  in cell.        
+00012750: 2020 2020 2020 2020 2020 2020 6f72 2063              or c
+00012760: 656c 6c5b 2265 7865 6375 7469 6f6e 5f63  ell["execution_c
+00012770: 6f75 6e74 225d 2069 7320 4e6f 6e65 0a20  ount"] is None. 
+00012780: 2020 2020 2020 2020 2020 2020 2020 2029                 )
+00012790: 0a0a 2020 2020 2020 2020 7265 7370 6f6e  ..        respon
+000127a0: 7365 203d 2061 7761 6974 2063 6c69 656e  se = await clien
+000127b0: 742e 6765 7428 0a20 2020 2020 2020 2020  t.get(.         
+000127c0: 2020 2066 222f 6e6f 7465 626f 6f6b 732f     f"/notebooks/
+000127d0: 7b75 7569 647d 2f63 656c 6c73 222c 2068  {uuid}/cells", h
+000127e0: 6561 6465 7273 3d73 7570 6572 7573 6572  eaders=superuser
+000127f0: 5f74 6f6b 656e 5f68 6561 6465 7273 0a20  _token_headers. 
+00012800: 2020 2020 2020 2029 0a20 2020 2020 2020         ).       
+00012810: 2061 7373 6572 7420 7265 7370 6f6e 7365   assert response
+00012820: 2e73 7461 7475 735f 636f 6465 203d 3d20  .status_code == 
+00012830: 3230 300a 2020 2020 2020 2020 6365 6c6c  200.        cell
+00012840: 7320 3d20 7265 7370 6f6e 7365 2e6a 736f  s = response.jso
+00012850: 6e28 295b 2263 656c 6c73 225d 0a20 2020  n()["cells"].   
+00012860: 2020 2020 2066 6f72 2063 656c 6c20 696e       for cell in
+00012870: 2063 656c 6c73 3a0a 2020 2020 2020 2020   cells:.        
+00012880: 2020 2020 6173 7365 7274 2028 0a20 2020      assert (.   
+00012890: 2020 2020 2020 2020 2020 2020 2028 226f               ("o
+000128a0: 7574 7075 7473 2220 6e6f 7420 696e 2063  utputs" not in c
+000128b0: 656c 6c20 6f72 206c 656e 2863 656c 6c5b  ell or len(cell[
+000128c0: 226f 7574 7075 7473 225d 2920 3d3d 2030  "outputs"]) == 0
+000128d0: 290a 2020 2020 2020 2020 2020 2020 2020  ).              
+000128e0: 2020 616e 6420 2265 7865 6375 7469 6f6e    and "execution
+000128f0: 5f63 6f75 6e74 2220 6e6f 7420 696e 2063  _count" not in c
+00012900: 656c 6c0a 2020 2020 2020 2020 2020 2020  ell.            
+00012910: 2020 2020 6f72 2063 656c 6c5b 2265 7865      or cell["exe
+00012920: 6375 7469 6f6e 5f63 6f75 6e74 225d 2069  cution_count"] i
+00012930: 7320 4e6f 6e65 0a20 2020 2020 2020 2020  s None.         
+00012940: 2020 2029 0a0a 2020 2020 4070 7974 6573     )..    @pytes
+00012950: 742e 6d61 726b 2e61 7379 6e63 696f 0a20  t.mark.asyncio. 
+00012960: 2020 2061 7379 6e63 2064 6566 2074 6573     async def tes
+00012970: 745f 7265 7374 6172 745f 6b65 726e 656c  t_restart_kernel
+00012980: 5f61 6e64 5f72 756e 5f61 6c6c 5f63 656c  _and_run_all_cel
+00012990: 6c73 280a 2020 2020 2020 2020 7365 6c66  ls(.        self
+000129a0: 2c20 636c 6965 6e74 3a20 5465 7374 436c  , client: TestCl
+000129b0: 6965 6e74 2c20 7375 7065 7275 7365 725f  ient, superuser_
+000129c0: 746f 6b65 6e5f 6865 6164 6572 733a 2044  token_headers: D
+000129d0: 6963 745b 7374 722c 2073 7472 5d0a 2020  ict[str, str].  
+000129e0: 2020 293a 0a20 2020 2020 2020 2075 7569    ):.        uui
+000129f0: 6420 3d20 6177 6169 7420 7570 6c6f 6164  d = await upload
+00012a00: 5f6e 6f74 6562 6f6f 6b28 636c 6965 6e74  _notebook(client
+00012a10: 2c20 7375 7065 7275 7365 725f 746f 6b65  , superuser_toke
+00012a20: 6e5f 6865 6164 6572 7329 0a0a 2020 2020  n_headers)..    
+00012a30: 2020 2020 7265 7370 6f6e 7365 203d 2061      response = a
+00012a40: 7761 6974 2063 6c69 656e 742e 6765 7428  wait client.get(
+00012a50: 0a20 2020 2020 2020 2020 2020 2066 222f  .            f"/
+00012a60: 6e6f 7465 626f 6f6b 732f 7b75 7569 647d  notebooks/{uuid}
+00012a70: 2f63 656c 6c73 222c 2068 6561 6465 7273  /cells", headers
+00012a80: 3d73 7570 6572 7573 6572 5f74 6f6b 656e  =superuser_token
+00012a90: 5f68 6561 6465 7273 0a20 2020 2020 2020  _headers.       
+00012aa0: 2029 0a20 2020 2020 2020 2061 7373 6572   ).        asser
+00012ab0: 7420 7265 7370 6f6e 7365 2e73 7461 7475  t response.statu
+00012ac0: 735f 636f 6465 203d 3d20 3230 300a 2020  s_code == 200.  
+00012ad0: 2020 2020 2020 6365 6c6c 7320 3d20 7265        cells = re
+00012ae0: 7370 6f6e 7365 2e6a 736f 6e28 295b 2263  sponse.json()["c
+00012af0: 656c 6c73 225d 0a0a 2020 2020 2020 2020  ells"]..        
+00012b00: 6365 6c6c 203d 2063 656c 6c73 5b32 5d0a  cell = cells[2].
+00012b10: 2020 2020 2020 2020 6365 6c6c 5f75 7569          cell_uui
+00012b20: 6420 3d20 6365 6c6c 5b22 6d65 7461 6461  d = cell["metada
+00012b30: 7461 225d 5b22 6a75 7079 7465 725f 6431  ta"]["jupyter_d1
+00012b40: 225d 5b22 7575 6964 225d 0a0a 2020 2020  "]["uuid"]..    
+00012b50: 2020 2020 7265 7370 6f6e 7365 203d 2061      response = a
+00012b60: 7761 6974 2063 6c69 656e 742e 6765 7428  wait client.get(
+00012b70: 0a20 2020 2020 2020 2020 2020 2066 222f  .            f"/
+00012b80: 6e6f 7465 626f 6f6b 732f 7b75 7569 647d  notebooks/{uuid}
+00012b90: 2f63 656c 6c73 2f7b 6365 6c6c 5f75 7569  /cells/{cell_uui
+00012ba0: 647d 2f65 7865 6375 7465 222c 0a20 2020  d}/execute",.   
+00012bb0: 2020 2020 2020 2020 2068 6561 6465 7273           headers
+00012bc0: 3d73 7570 6572 7573 6572 5f74 6f6b 656e  =superuser_token
+00012bd0: 5f68 6561 6465 7273 2c0a 2020 2020 2020  _headers,.      
+00012be0: 2020 290a 2020 2020 2020 2020 6173 7365    ).        asse
+00012bf0: 7274 2072 6573 706f 6e73 652e 7374 6174  rt response.stat
+00012c00: 7573 5f63 6f64 6520 3d3d 2032 3030 0a0a  us_code == 200..
+00012c10: 2020 2020 2020 2020 7265 7370 6f6e 7365          response
+00012c20: 203d 2061 7761 6974 2063 6c69 656e 742e   = await client.
+00012c30: 6765 7428 0a20 2020 2020 2020 2020 2020  get(.           
+00012c40: 2066 222f 6e6f 7465 626f 6f6b 732f 7b75   f"/notebooks/{u
+00012c50: 7569 647d 2f63 656c 6c73 222c 2068 6561  uid}/cells", hea
+00012c60: 6465 7273 3d73 7570 6572 7573 6572 5f74  ders=superuser_t
+00012c70: 6f6b 656e 5f68 6561 6465 7273 0a20 2020  oken_headers.   
+00012c80: 2020 2020 2029 0a20 2020 2020 2020 2061       ).        a
+00012c90: 7373 6572 7420 7265 7370 6f6e 7365 2e73  ssert response.s
+00012ca0: 7461 7475 735f 636f 6465 203d 3d20 3230  tatus_code == 20
+00012cb0: 300a 2020 2020 2020 2020 6365 6c6c 7320  0.        cells 
+00012cc0: 3d20 7265 7370 6f6e 7365 2e6a 736f 6e28  = response.json(
+00012cd0: 295b 2263 656c 6c73 225d 0a0a 2020 2020  )["cells"]..    
+00012ce0: 2020 2020 6173 7365 7274 2022 6f75 7470      assert "outp
+00012cf0: 7574 7322 206e 6f74 2069 6e20 6365 6c6c  uts" not in cell
+00012d00: 735b 305d 0a20 2020 2020 2020 2061 7373  s[0].        ass
+00012d10: 6572 7420 6365 6c6c 735b 315d 5b22 6f75  ert cells[1]["ou
+00012d20: 7470 7574 7322 5d5b 305d 5b22 7465 7874  tputs"][0]["text
+00012d30: 225d 203d 3d20 224c 6172 7279 2074 6865  "] == "Larry the
+00012d40: 204c 6c61 6d61 5c6e 220a 2020 2020 2020   Llama\n".      
+00012d50: 2020 6173 7365 7274 2063 656c 6c73 5b32    assert cells[2
+00012d60: 5d5b 226f 7574 7075 7473 225d 5b30 5d5b  ]["outputs"][0][
+00012d70: 2264 6174 6122 5d5b 2274 6578 742f 706c  "data"]["text/pl
+00012d80: 6169 6e22 5d20 3d3d 2022 3722 0a0a 2020  ain"] == "7"..  
+00012d90: 2020 2020 2020 6173 796e 6320 7769 7468        async with
+00012da0: 2063 6c69 656e 742e 7765 6273 6f63 6b65   client.websocke
+00012db0: 745f 636f 6e6e 6563 7428 0a20 2020 2020  t_connect(.     
+00012dc0: 2020 2020 2020 2066 222f 6e6f 7465 626f         f"/notebo
+00012dd0: 6f6b 732f 7b75 7569 647d 2f77 732f 6e6f  oks/{uuid}/ws/no
+00012de0: 7465 626f 6f6b 222c 2068 6561 6465 7273  tebook", headers
+00012df0: 3d73 7570 6572 7573 6572 5f74 6f6b 656e  =superuser_token
+00012e00: 5f68 6561 6465 7273 0a20 2020 2020 2020  _headers.       
+00012e10: 2029 2061 7320 7765 6273 6f63 6b65 743a   ) as websocket:
+00012e20: 0a0a 2020 2020 2020 2020 2020 2020 6177  ..            aw
+00012e30: 6169 7420 6173 796e 6369 6f2e 736c 6565  ait asyncio.slee
+00012e40: 7028 5745 4253 4f43 4b45 545f 534c 4545  p(WEBSOCKET_SLEE
+00012e50: 505f 5449 4d45 290a 0a20 2020 2020 2020  P_TIME)..       
+00012e60: 2020 2020 2023 2043 6c65 6172 2074 6865       # Clear the
+00012e70: 2077 6562 2073 6f63 6b65 7420 6265 666f   web socket befo
+00012e80: 7265 2077 6520 7374 6172 740a 2020 2020  re we start.    
+00012e90: 2020 2020 2020 2020 6177 6169 7420 636f          await co
+00012ea0: 6c6c 6563 745f 7765 6273 6f63 6b65 745f  llect_websocket_
+00012eb0: 6d65 7373 6167 6573 2877 6562 736f 636b  messages(websock
+00012ec0: 6574 2c20 7469 6d65 6f75 743d 3229 0a0a  et, timeout=2)..
+00012ed0: 2020 2020 2020 2020 2020 2020 7265 7370              resp
+00012ee0: 6f6e 7365 203d 2061 7761 6974 2063 6c69  onse = await cli
+00012ef0: 656e 742e 6765 7428 0a20 2020 2020 2020  ent.get(.       
+00012f00: 2020 2020 2020 2020 2066 222f 6e6f 7465           f"/note
+00012f10: 626f 6f6b 732f 7b75 7569 647d 2f72 6573  books/{uuid}/res
+00012f20: 7461 7274 5f6b 6572 6e65 6c5f 616e 645f  tart_kernel_and_
+00012f30: 6578 6563 7574 655f 616c 6c22 2c0a 2020  execute_all",.  
+00012f40: 2020 2020 2020 2020 2020 2020 2020 6865                he
+00012f50: 6164 6572 733d 7375 7065 7275 7365 725f  aders=superuser_
+00012f60: 746f 6b65 6e5f 6865 6164 6572 732c 0a20  token_headers,. 
+00012f70: 2020 2020 2020 2020 2020 2029 0a0a 2020             )..  
+00012f80: 2020 2020 2020 2020 2020 6173 7365 7274            assert
+00012f90: 2072 6573 706f 6e73 652e 7374 6174 7573   response.status
+00012fa0: 5f63 6f64 6520 3d3d 2032 3030 0a0a 2020  _code == 200..  
+00012fb0: 2020 2020 2020 2020 2020 6d73 6773 203d            msgs =
+00012fc0: 2061 7761 6974 2063 6f6c 6c65 6374 5f77   await collect_w
+00012fd0: 6562 736f 636b 6574 5f6d 6573 7361 6765  ebsocket_message
+00012fe0: 7328 7765 6273 6f63 6b65 742c 2074 696d  s(websocket, tim
+00012ff0: 656f 7574 3d31 3029 0a20 2020 2020 2020  eout=10).       
+00013000: 2020 2020 206b 6572 6e65 6c5f 7265 7374       kernel_rest
+00013010: 6172 7465 645f 6d73 6773 203d 2066 696c  arted_msgs = fil
+00013020: 7465 725f 7765 6273 6f63 6b65 745f 636f  ter_websocket_co
+00013030: 6c6c 6563 7469 6f6e 280a 2020 2020 2020  llection(.      
+00013040: 2020 2020 2020 2020 2020 6d73 6773 2c20            msgs, 
+00013050: 226b 6572 6e65 6c5f 7265 7374 6172 7465  "kernel_restarte
+00013060: 6422 0a20 2020 2020 2020 2020 2020 2029  d".            )
+00013070: 0a20 2020 2020 2020 2020 2020 2063 656c  .            cel
+00013080: 6c5f 7570 6461 7465 5f6d 7367 7320 3d20  l_update_msgs = 
+00013090: 6669 6c74 6572 5f77 6562 736f 636b 6574  filter_websocket
+000130a0: 5f63 6f6c 6c65 6374 696f 6e28 6d73 6773  _collection(msgs
+000130b0: 2c20 2263 656c 6c5f 7570 6461 7465 2229  , "cell_update")
+000130c0: 0a0a 2020 2020 2020 2020 2020 2020 6461  ..            da
+000130d0: 7461 203d 206b 6572 6e65 6c5f 7265 7374  ta = kernel_rest
+000130e0: 6172 7465 645f 6d73 6773 2e70 6f70 2830  arted_msgs.pop(0
+000130f0: 290a 2020 2020 2020 2020 2020 2020 6173  ).            as
+00013100: 7365 7274 2064 6174 615b 226b 6572 6e65  sert data["kerne
+00013110: 6c5f 7265 7374 6172 7465 6422 5d5b 2272  l_restarted"]["r
+00013120: 756e 5f61 6c6c 5f63 656c 6c73 225d 2069  un_all_cells"] i
+00013130: 7320 5472 7565 0a20 2020 2020 2020 2020  s True.         
+00013140: 2020 2063 656c 6c73 203d 2064 6174 615b     cells = data[
+00013150: 226b 6572 6e65 6c5f 7265 7374 6172 7465  "kernel_restarte
+00013160: 6422 5d5b 2263 656c 6c73 225d 0a20 2020  d"]["cells"].   
+00013170: 2020 2020 2020 2020 2066 6f72 2063 656c           for cel
+00013180: 6c20 696e 2063 656c 6c73 3a0a 2020 2020  l in cells:.    
+00013190: 2020 2020 2020 2020 2020 2020 6173 7365              asse
+000131a0: 7274 2028 0a20 2020 2020 2020 2020 2020  rt (.           
+000131b0: 2020 2020 2020 2020 2028 226f 7574 7075           ("outpu
+000131c0: 7473 2220 6e6f 7420 696e 2063 656c 6c20  ts" not in cell 
+000131d0: 6f72 206c 656e 2863 656c 6c5b 226f 7574  or len(cell["out
+000131e0: 7075 7473 225d 2920 3d3d 2030 290a 2020  puts"]) == 0).  
+000131f0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00013200: 2020 616e 6420 2265 7865 6375 7469 6f6e    and "execution
+00013210: 5f63 6f75 6e74 2220 6e6f 7420 696e 2063  _count" not in c
+00013220: 656c 6c0a 2020 2020 2020 2020 2020 2020  ell.            
+00013230: 2020 2020 2020 2020 6f72 2063 656c 6c5b          or cell[
+00013240: 2265 7865 6375 7469 6f6e 5f63 6f75 6e74  "execution_count
+00013250: 225d 2069 7320 4e6f 6e65 0a20 2020 2020  "] is None.     
+00013260: 2020 2020 2020 2020 2020 2029 0a0a 2020             )..  
+00013270: 2020 2020 2020 2020 2020 2320 5468 6573            # Thes
+00013280: 6520 7477 6f20 706f 7020 7570 2064 7565  e two pop up due
+00013290: 2074 6f20 7468 6520 7265 7374 6172 740a   to the restart.
+000132a0: 2020 2020 2020 2020 2020 2020 6461 7461              data
+000132b0: 203d 2063 656c 6c5f 7570 6461 7465 5f6d   = cell_update_m
+000132c0: 7367 732e 706f 7028 3029 0a20 2020 2020  sgs.pop(0).     
+000132d0: 2020 2020 2020 2063 656c 6c20 3d20 6461         cell = da
+000132e0: 7461 5b22 6365 6c6c 5f75 7064 6174 6522  ta["cell_update"
+000132f0: 5d5b 305d 0a20 2020 2020 2020 2020 2020  ][0].           
+00013300: 2061 7373 6572 7420 6365 6c6c 5b22 6f75   assert cell["ou
+00013310: 7470 7574 7322 5d5b 305d 5b22 6461 7461  tputs"][0]["data
+00013320: 225d 5b22 7465 7874 2f70 6c61 696e 225d  "]["text/plain"]
+00013330: 203d 3d20 2237 220a 2020 2020 2020 2020   == "7".        
+00013340: 2020 2020 6173 7365 7274 2063 656c 6c5b      assert cell[
+00013350: 2265 7865 6375 7469 6f6e 5f63 6f75 6e74  "execution_count
+00013360: 225d 203d 3d20 310a 2020 2020 2020 2020  "] == 1.        
+00013370: 2020 2020 6173 7365 7274 2063 656c 6c5b      assert cell[
+00013380: 226d 6574 6164 6174 6122 5d5b 226a 7570  "metadata"]["jup
+00013390: 7974 6572 5f64 3122 5d5b 2265 7865 6375  yter_d1"]["execu
+000133a0: 7469 6f6e 5f73 7461 7465 225d 203d 3d20  tion_state"] == 
+000133b0: 2262 7573 7922 0a20 2020 2020 2020 2020  "busy".         
+000133c0: 2020 2064 6174 6120 3d20 6365 6c6c 5f75     data = cell_u
+000133d0: 7064 6174 655f 6d73 6773 2e70 6f70 2830  pdate_msgs.pop(0
+000133e0: 290a 2020 2020 2020 2020 2020 2020 6365  ).            ce
+000133f0: 6c6c 203d 2064 6174 615b 2263 656c 6c5f  ll = data["cell_
+00013400: 7570 6461 7465 225d 5b30 5d0a 2020 2020  update"][0].    
+00013410: 2020 2020 2020 2020 6173 7365 7274 2063          assert c
+00013420: 656c 6c5b 226f 7574 7075 7473 225d 5b30  ell["outputs"][0
+00013430: 5d5b 2264 6174 6122 5d5b 2274 6578 742f  ]["data"]["text/
+00013440: 706c 6169 6e22 5d20 3d3d 2022 3722 0a20  plain"] == "7". 
+00013450: 2020 2020 2020 2020 2020 2061 7373 6572             asser
+00013460: 7420 6365 6c6c 5b22 6578 6563 7574 696f  t cell["executio
+00013470: 6e5f 636f 756e 7422 5d20 3d3d 2031 0a20  n_count"] == 1. 
+00013480: 2020 2020 2020 2020 2020 2061 7373 6572             asser
+00013490: 7420 6365 6c6c 5b22 6d65 7461 6461 7461  t cell["metadata
+000134a0: 225d 5b22 6a75 7079 7465 725f 6431 225d  "]["jupyter_d1"]
+000134b0: 5b22 6578 6563 7574 696f 6e5f 7374 6174  ["execution_stat
+000134c0: 6522 5d20 3d3d 2022 6964 6c65 220a 0a20  e"] == "idle".. 
+000134d0: 2020 2020 2020 2020 2020 2064 6174 6120             data 
+000134e0: 3d20 6365 6c6c 5f75 7064 6174 655f 6d73  = cell_update_ms
+000134f0: 6773 2e70 6f70 2830 290a 2020 2020 2020  gs.pop(0).      
+00013500: 2020 2020 2020 6365 6c6c 203d 2064 6174        cell = dat
+00013510: 615b 2263 656c 6c5f 7570 6461 7465 225d  a["cell_update"]
+00013520: 5b30 5d0a 2020 2020 2020 2020 2020 2020  [0].            
+00013530: 6173 7365 7274 206c 656e 2863 656c 6c5b  assert len(cell[
+00013540: 226f 7574 7075 7473 225d 2920 3d3d 2030  "outputs"]) == 0
+00013550: 0a20 2020 2020 2020 2020 2020 2061 7373  .            ass
+00013560: 6572 7420 6365 6c6c 5b22 6d65 7461 6461  ert cell["metada
+00013570: 7461 225d 5b22 6a75 7079 7465 725f 6431  ta"]["jupyter_d1
+00013580: 225d 5b22 6578 6563 7574 696f 6e5f 7374  "]["execution_st
+00013590: 6174 6522 5d20 3d3d 2022 6275 7379 220a  ate"] == "busy".
+000135a0: 0a20 2020 2020 2020 2020 2020 2023 2054  .            # T
+000135b0: 6869 7320 7573 6564 2074 6f20 6265 2061  his used to be a
+000135c0: 2063 656c 6c5f 7374 7265 616d 206d 7367   cell_stream msg
+000135d0: 0a20 2020 2020 2020 2020 2020 2064 6174  .            dat
+000135e0: 6120 3d20 6365 6c6c 5f75 7064 6174 655f  a = cell_update_
+000135f0: 6d73 6773 2e70 6f70 2830 290a 2020 2020  msgs.pop(0).    
+00013600: 2020 2020 2020 2020 6365 6c6c 203d 2064          cell = d
+00013610: 6174 615b 2263 656c 6c5f 7570 6461 7465  ata["cell_update
+00013620: 225d 5b30 5d0a 2020 2020 2020 2020 2020  "][0].          
+00013630: 2020 6173 7365 7274 2063 656c 6c5b 226f    assert cell["o
+00013640: 7574 7075 7473 225d 5b30 5d5b 2274 6578  utputs"][0]["tex
+00013650: 7422 5d20 3d3d 205b 224c 6172 7279 2074  t"] == ["Larry t
+00013660: 6865 204c 6c61 6d61 5c6e 225d 0a20 2020  he Llama\n"].   
+00013670: 2020 2020 2020 2020 2061 7373 6572 7420           assert 
+00013680: 6365 6c6c 5b22 6d65 7461 6461 7461 225d  cell["metadata"]
+00013690: 5b22 6a75 7079 7465 725f 6431 225d 5b22  ["jupyter_d1"]["
+000136a0: 6578 6563 7574 696f 6e5f 7374 6174 6522  execution_state"
+000136b0: 5d20 3d3d 2022 6275 7379 220a 0a20 2020  ] == "busy"..   
+000136c0: 2020 2020 2020 2020 2064 6174 6120 3d20           data = 
+000136d0: 6365 6c6c 5f75 7064 6174 655f 6d73 6773  cell_update_msgs
+000136e0: 2e70 6f70 2830 290a 2020 2020 2020 2020  .pop(0).        
+000136f0: 2020 2020 6365 6c6c 203d 2064 6174 615b      cell = data[
+00013700: 2263 656c 6c5f 7570 6461 7465 225d 5b30  "cell_update"][0
+00013710: 5d0a 2020 2020 2020 2020 2020 2020 6173  ].            as
+00013720: 7365 7274 2063 656c 6c5b 226f 7574 7075  sert cell["outpu
+00013730: 7473 225d 5b30 5d5b 2274 6578 7422 5d20  ts"][0]["text"] 
+00013740: 3d3d 205b 224c 6172 7279 2074 6865 204c  == ["Larry the L
+00013750: 6c61 6d61 5c6e 225d 0a20 2020 2020 2020  lama\n"].       
+00013760: 2020 2020 2061 7373 6572 7420 6365 6c6c       assert cell
+00013770: 5b22 6578 6563 7574 696f 6e5f 636f 756e  ["execution_coun
+00013780: 7422 5d20 3d3d 2031 0a20 2020 2020 2020  t"] == 1.       
+00013790: 2020 2020 2061 7373 6572 7420 6365 6c6c       assert cell
+000137a0: 5b22 6d65 7461 6461 7461 225d 5b22 6a75  ["metadata"]["ju
+000137b0: 7079 7465 725f 6431 225d 5b22 6578 6563  pyter_d1"]["exec
+000137c0: 7574 696f 6e5f 7374 6174 6522 5d20 3d3d  ution_state"] ==
+000137d0: 2022 6964 6c65 220a 0a20 2020 2020 2020   "idle"..       
+000137e0: 2020 2020 2064 6174 6120 3d20 6365 6c6c       data = cell
+000137f0: 5f75 7064 6174 655f 6d73 6773 2e70 6f70  _update_msgs.pop
+00013800: 2830 290a 2020 2020 2020 2020 2020 2020  (0).            
+00013810: 6365 6c6c 203d 2064 6174 615b 2263 656c  cell = data["cel
+00013820: 6c5f 7570 6461 7465 225d 5b30 5d0a 2020  l_update"][0].  
+00013830: 2020 2020 2020 2020 2020 6173 7365 7274            assert
+00013840: 206c 656e 2863 656c 6c5b 226f 7574 7075   len(cell["outpu
+00013850: 7473 225d 2920 3d3d 2030 0a20 2020 2020  ts"]) == 0.     
+00013860: 2020 2020 2020 2061 7373 6572 7420 6365         assert ce
+00013870: 6c6c 5b22 6d65 7461 6461 7461 225d 5b22  ll["metadata"]["
+00013880: 6a75 7079 7465 725f 6431 225d 5b22 6578  jupyter_d1"]["ex
+00013890: 6563 7574 696f 6e5f 7374 6174 6522 5d20  ecution_state"] 
+000138a0: 3d3d 2022 6275 7379 220a 0a20 2020 2020  == "busy"..     
+000138b0: 2020 2020 2020 2064 6174 6120 3d20 6365         data = ce
+000138c0: 6c6c 5f75 7064 6174 655f 6d73 6773 2e70  ll_update_msgs.p
+000138d0: 6f70 2830 290a 2020 2020 2020 2020 2020  op(0).          
+000138e0: 2020 6365 6c6c 203d 2064 6174 615b 2263    cell = data["c
+000138f0: 656c 6c5f 7570 6461 7465 225d 5b30 5d0a  ell_update"][0].
+00013900: 2020 2020 2020 2020 2020 2020 6173 7365              asse
+00013910: 7274 2063 656c 6c5b 226f 7574 7075 7473  rt cell["outputs
+00013920: 225d 5b30 5d5b 2264 6174 6122 5d5b 2274  "][0]["data"]["t
+00013930: 6578 742f 706c 6169 6e22 5d20 3d3d 2022  ext/plain"] == "
+00013940: 3722 0a20 2020 2020 2020 2020 2020 2061  7".            a
+00013950: 7373 6572 7420 6365 6c6c 5b22 6578 6563  ssert cell["exec
+00013960: 7574 696f 6e5f 636f 756e 7422 5d20 3d3d  ution_count"] ==
+00013970: 2032 0a20 2020 2020 2020 2020 2020 2061   2.            a
+00013980: 7373 6572 7420 6365 6c6c 5b22 6d65 7461  ssert cell["meta
+00013990: 6461 7461 225d 5b22 6a75 7079 7465 725f  data"]["jupyter_
+000139a0: 6431 225d 5b22 6578 6563 7574 696f 6e5f  d1"]["execution_
+000139b0: 7374 6174 6522 5d20 3d3d 2022 6275 7379  state"] == "busy
+000139c0: 220a 0a20 2020 2020 2020 2020 2020 2064  "..            d
+000139d0: 6174 6120 3d20 6365 6c6c 5f75 7064 6174  ata = cell_updat
+000139e0: 655f 6d73 6773 2e70 6f70 2830 290a 2020  e_msgs.pop(0).  
+000139f0: 2020 2020 2020 2020 2020 6365 6c6c 203d            cell =
+00013a00: 2064 6174 615b 2263 656c 6c5f 7570 6461   data["cell_upda
+00013a10: 7465 225d 5b30 5d0a 2020 2020 2020 2020  te"][0].        
+00013a20: 2020 2020 6173 7365 7274 2063 656c 6c5b      assert cell[
+00013a30: 226f 7574 7075 7473 225d 5b30 5d5b 2264  "outputs"][0]["d
+00013a40: 6174 6122 5d5b 2274 6578 742f 706c 6169  ata"]["text/plai
+00013a50: 6e22 5d20 3d3d 2022 3722 0a20 2020 2020  n"] == "7".     
+00013a60: 2020 2020 2020 2061 7373 6572 7420 6365         assert ce
+00013a70: 6c6c 5b22 6578 6563 7574 696f 6e5f 636f  ll["execution_co
+00013a80: 756e 7422 5d20 3d3d 2032 0a20 2020 2020  unt"] == 2.     
+00013a90: 2020 2020 2020 2061 7373 6572 7420 6365         assert ce
+00013aa0: 6c6c 5b22 6d65 7461 6461 7461 225d 5b22  ll["metadata"]["
+00013ab0: 6a75 7079 7465 725f 6431 225d 5b22 6578  jupyter_d1"]["ex
+00013ac0: 6563 7574 696f 6e5f 7374 6174 6522 5d20  ecution_state"] 
+00013ad0: 3d3d 2022 6964 6c65 220a 0a20 2020 2040  == "idle"..    @
+00013ae0: 7079 7465 7374 2e6d 6172 6b2e 6173 796e  pytest.mark.asyn
+00013af0: 6369 6f0a 2020 2020 6173 796e 6320 6465  cio.    async de
+00013b00: 6620 7465 7374 5f69 7079 7468 6f6e 5f6b  f test_ipython_k
+00013b10: 6572 6e65 6c5f 7374 6172 7475 705f 7363  ernel_startup_sc
+00013b20: 7269 7074 280a 2020 2020 2020 2020 7365  ript(.        se
+00013b30: 6c66 2c20 636c 6965 6e74 3a20 5465 7374  lf, client: Test
+00013b40: 436c 6965 6e74 2c20 7375 7065 7275 7365  Client, superuse
+00013b50: 725f 746f 6b65 6e5f 6865 6164 6572 733a  r_token_headers:
+00013b60: 2044 6963 745b 7374 722c 2073 7472 5d0a   Dict[str, str].
+00013b70: 2020 2020 293a 0a20 2020 2020 2020 2022      ):.        "
+00013b80: 2222 0a20 2020 2020 2020 2054 6573 7420  "".        Test 
+00013b90: 7468 6174 2074 6865 2063 616c 6c69 7374  that the callist
+00013ba0: 6f5f 7374 6172 7475 702e 7079 2073 7461  o_startup.py sta
+00013bb0: 7274 7570 2073 6372 6970 7420 6973 2072  rtup script is r
+00013bc0: 756e 2077 6865 6e20 7468 650a 2020 2020  un when the.    
+00013bd0: 2020 2020 6b65 726e 656c 2073 7461 7274      kernel start
+00013be0: 732e 0a20 2020 2020 2020 2022 2222 0a20  s..        """. 
+00013bf0: 2020 2020 2020 2075 7569 6420 3d20 6177         uuid = aw
+00013c00: 6169 7420 7570 6c6f 6164 5f6e 6f74 6562  ait upload_noteb
+00013c10: 6f6f 6b28 0a20 2020 2020 2020 2020 2020  ook(.           
+00013c20: 2063 6c69 656e 742c 2073 7570 6572 7573   client, superus
+00013c30: 6572 5f74 6f6b 656e 5f68 6561 6465 7273  er_token_headers
+00013c40: 2c20 2273 696d 706c 652e 6970 796e 6222  , "simple.ipynb"
+00013c50: 0a20 2020 2020 2020 2029 0a0a 2020 2020  .        )..    
+00013c60: 2020 2020 2320 6765 7420 616e 2065 7869      # get an exi
+00013c70: 7374 696e 6720 6365 6c6c 0a20 2020 2020  sting cell.     
+00013c80: 2020 2072 6573 706f 6e73 6520 3d20 6177     response = aw
+00013c90: 6169 7420 636c 6965 6e74 2e67 6574 280a  ait client.get(.
+00013ca0: 2020 2020 2020 2020 2020 2020 6622 2f6e              f"/n
+00013cb0: 6f74 6562 6f6f 6b73 2f7b 7575 6964 7d2f  otebooks/{uuid}/
+00013cc0: 6365 6c6c 7322 2c20 6865 6164 6572 733d  cells", headers=
+00013cd0: 7375 7065 7275 7365 725f 746f 6b65 6e5f  superuser_token_
+00013ce0: 6865 6164 6572 730a 2020 2020 2020 2020  headers.        
+00013cf0: 290a 2020 2020 2020 2020 6173 7365 7274  ).        assert
+00013d00: 2072 6573 706f 6e73 652e 7374 6174 7573   response.status
+00013d10: 5f63 6f64 6520 3d3d 2032 3030 0a20 2020  _code == 200.   
+00013d20: 2020 2020 2063 656c 6c73 203d 2072 6573       cells = res
+00013d30: 706f 6e73 652e 6a73 6f6e 2829 5b22 6365  ponse.json()["ce
+00013d40: 6c6c 7322 5d0a 2020 2020 2020 2020 6173  lls"].        as
+00013d50: 7365 7274 2063 656c 6c73 5b31 5d5b 2273  sert cells[1]["s
+00013d60: 6f75 7263 6522 5d20 3d3d 2027 7072 696e  ource"] == 'prin
+00013d70: 7428 224c 6172 7279 2074 6865 204c 6c61  t("Larry the Lla
+00013d80: 6d61 2229 270a 0a20 2020 2020 2020 2063  ma")'..        c
+00013d90: 656c 6c5f 7575 6964 203d 2063 656c 6c73  ell_uuid = cells
+00013da0: 5b31 5d5b 226d 6574 6164 6174 6122 5d5b  [1]["metadata"][
+00013db0: 226a 7570 7974 6572 5f64 3122 5d5b 2275  "jupyter_d1"]["u
+00013dc0: 7569 6422 5d0a 0a20 2020 2020 2020 2070  uid"]..        p
+00013dd0: 6172 616d 7320 3d20 7b0a 2020 2020 2020  arams = {.      
+00013de0: 2020 2020 2020 2273 6f75 7263 6522 3a20        "source": 
+00013df0: 2269 6d70 6f72 7420 7061 6e64 6173 2061  "import pandas a
+00013e00: 7320 7064 5c6e 220a 2020 2020 2020 2020  s pd\n".        
+00013e10: 2020 2020 2770 642e 6765 745f 6f70 7469      'pd.get_opti
+00013e20: 6f6e 2822 6469 7370 6c61 792e 6874 6d6c  on("display.html
+00013e30: 2e74 6162 6c65 5f73 6368 656d 6122 2927  .table_schema")'
+00013e40: 0a20 2020 2020 2020 207d 0a20 2020 2020  .        }.     
+00013e50: 2020 2072 6573 706f 6e73 6520 3d20 6177     response = aw
+00013e60: 6169 7420 636c 6965 6e74 2e70 6174 6368  ait client.patch
+00013e70: 280a 2020 2020 2020 2020 2020 2020 6622  (.            f"
+00013e80: 2f6e 6f74 6562 6f6f 6b73 2f7b 7575 6964  /notebooks/{uuid
+00013e90: 7d2f 6365 6c6c 732f 7b63 656c 6c5f 7575  }/cells/{cell_uu
+00013ea0: 6964 7d22 2c0a 2020 2020 2020 2020 2020  id}",.          
+00013eb0: 2020 6a73 6f6e 3d70 6172 616d 732c 0a20    json=params,. 
+00013ec0: 2020 2020 2020 2020 2020 2068 6561 6465             heade
+00013ed0: 7273 3d73 7570 6572 7573 6572 5f74 6f6b  rs=superuser_tok
+00013ee0: 656e 5f68 6561 6465 7273 2c0a 2020 2020  en_headers,.    
+00013ef0: 2020 2020 290a 2020 2020 2020 2020 6173      ).        as
+00013f00: 7365 7274 2072 6573 706f 6e73 652e 7374  sert response.st
+00013f10: 6174 7573 5f63 6f64 6520 3d3d 2032 3030  atus_code == 200
+00013f20: 0a0a 2020 2020 2020 2020 7265 7370 6f6e  ..        respon
+00013f30: 7365 203d 2061 7761 6974 2063 6c69 656e  se = await clien
+00013f40: 742e 6765 7428 0a20 2020 2020 2020 2020  t.get(.         
+00013f50: 2020 2066 222f 6e6f 7465 626f 6f6b 732f     f"/notebooks/
+00013f60: 7b75 7569 647d 2f76 6172 7322 2c20 6865  {uuid}/vars", he
+00013f70: 6164 6572 733d 7375 7065 7275 7365 725f  aders=superuser_
+00013f80: 746f 6b65 6e5f 6865 6164 6572 730a 2020  token_headers.  
+00013f90: 2020 2020 2020 290a 2020 2020 2020 2020        ).        
+00013fa0: 6173 7365 7274 2072 6573 706f 6e73 652e  assert response.
+00013fb0: 7374 6174 7573 5f63 6f64 6520 3d3d 2032  status_code == 2
+00013fc0: 3030 0a20 2020 2020 2020 2061 7373 6572  00.        asser
+00013fd0: 7420 6c65 6e28 7265 7370 6f6e 7365 2e6a  t len(response.j
+00013fe0: 736f 6e28 295b 2276 6172 7322 5d29 203d  son()["vars"]) =
+00013ff0: 3d20 300a 0a20 2020 2020 2020 2061 7379  = 0..        asy
+00014000: 6e63 2077 6974 6820 636c 6965 6e74 2e77  nc with client.w
+00014010: 6562 736f 636b 6574 5f63 6f6e 6e65 6374  ebsocket_connect
+00014020: 280a 2020 2020 2020 2020 2020 2020 6622  (.            f"
+00014030: 2f6e 6f74 6562 6f6f 6b73 2f7b 7575 6964  /notebooks/{uuid
+00014040: 7d2f 7773 2f6e 6f74 6562 6f6f 6b22 2c20  }/ws/notebook", 
+00014050: 6865 6164 6572 733d 7375 7065 7275 7365  headers=superuse
+00014060: 725f 746f 6b65 6e5f 6865 6164 6572 730a  r_token_headers.
+00014070: 2020 2020 2020 2020 2920 6173 2077 6562          ) as web
+00014080: 736f 636b 6574 3a0a 2020 2020 2020 2020  socket:.        
+00014090: 2020 2020 6177 6169 7420 6173 796e 6369      await asynci
+000140a0: 6f2e 736c 6565 7028 5745 4253 4f43 4b45  o.sleep(WEBSOCKE
+000140b0: 545f 534c 4545 505f 5449 4d45 290a 0a20  T_SLEEP_TIME).. 
+000140c0: 2020 2020 2020 2020 2020 2072 6573 706f             respo
+000140d0: 6e73 6520 3d20 6177 6169 7420 636c 6965  nse = await clie
+000140e0: 6e74 2e70 6174 6368 280a 2020 2020 2020  nt.patch(.      
+000140f0: 2020 2020 2020 2020 2020 6622 2f6e 6f74            f"/not
+00014100: 6562 6f6f 6b73 2f7b 7575 6964 7d2f 6365  ebooks/{uuid}/ce
+00014110: 6c6c 732f 7b63 656c 6c5f 7575 6964 7d2f  lls/{cell_uuid}/
+00014120: 6578 6563 7574 6522 2c0a 2020 2020 2020  execute",.      
+00014130: 2020 2020 2020 2020 2020 6a73 6f6e 3d70            json=p
+00014140: 6172 616d 732c 0a20 2020 2020 2020 2020  arams,.         
+00014150: 2020 2020 2020 2068 6561 6465 7273 3d73         headers=s
+00014160: 7570 6572 7573 6572 5f74 6f6b 656e 5f68  uperuser_token_h
+00014170: 6561 6465 7273 2c0a 2020 2020 2020 2020  eaders,.        
+00014180: 2020 2020 290a 2020 2020 2020 2020 2020      ).          
+00014190: 2020 6173 7365 7274 2072 6573 706f 6e73    assert respons
+000141a0: 652e 7374 6174 7573 5f63 6f64 6520 3d3d  e.status_code ==
+000141b0: 2032 3030 0a0a 2020 2020 2020 2020 2020   200..          
+000141c0: 2020 6578 7065 6374 6564 203d 207b 0a20    expected = {. 
+000141d0: 2020 2020 2020 2020 2020 2020 2020 2022                 "
+000141e0: 6365 6c6c 5f75 7064 6174 6522 3a20 5b0a  cell_update": [.
+000141f0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00014200: 2020 2020 7b0a 2020 2020 2020 2020 2020      {.          
+00014210: 2020 2020 2020 2020 2020 2020 2020 2263                "c
+00014220: 656c 6c5f 7479 7065 223a 2022 636f 6465  ell_type": "code
+00014230: 222c 0a20 2020 2020 2020 2020 2020 2020  ",.             
+00014240: 2020 2020 2020 2020 2020 2022 6578 6563             "exec
+00014250: 7574 696f 6e5f 636f 756e 7422 3a20 312c  ution_count": 1,
+00014260: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00014270: 2020 2020 2020 2020 2022 6d65 7461 6461           "metada
+00014280: 7461 223a 207b 0a20 2020 2020 2020 2020  ta": {.         
+00014290: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000142a0: 2020 2022 6a75 7079 7465 725f 6431 223a     "jupyter_d1":
+000142b0: 207b 0a20 2020 2020 2020 2020 2020 2020   {.             
+000142c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000142d0: 2020 2022 706f 7369 7469 6f6e 223a 2031     "position": 1
+000142e0: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
+000142f0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00014300: 2020 2275 7569 6422 3a20 6365 6c6c 5f75    "uuid": cell_u
+00014310: 7569 642c 0a20 2020 2020 2020 2020 2020  uid,.           
+00014320: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00014330: 2020 2020 2022 6e6f 7465 626f 6f6b 5f75       "notebook_u
+00014340: 7569 6422 3a20 7575 6964 2c0a 2020 2020  uid": uuid,.    
+00014350: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00014360: 2020 2020 2020 2020 2020 2020 2265 7865              "exe
+00014370: 6375 7469 6f6e 5f73 7461 7465 223a 2022  cution_state": "
+00014380: 6275 7379 222c 0a20 2020 2020 2020 2020  busy",.         
+00014390: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000143a0: 2020 207d 0a20 2020 2020 2020 2020 2020     }.           
+000143b0: 2020 2020 2020 2020 2020 2020 207d 2c0a               },.
+000143c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000143d0: 2020 2020 2020 2020 226f 7574 7075 7473          "outputs
+000143e0: 223a 205b 0a20 2020 2020 2020 2020 2020  ": [.           
+000143f0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00014400: 207b 0a20 2020 2020 2020 2020 2020 2020   {.             
+00014410: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00014420: 2020 2022 6461 7461 223a 207b 2274 6578     "data": {"tex
+00014430: 742f 706c 6169 6e22 3a20 2254 7275 6522  t/plain": "True"
+00014440: 7d2c 0a20 2020 2020 2020 2020 2020 2020  },.             
+00014450: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00014460: 2020 2022 6578 6563 7574 696f 6e5f 636f     "execution_co
+00014470: 756e 7422 3a20 312c 0a20 2020 2020 2020  unt": 1,.       
+00014480: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00014490: 2020 2020 2020 2020 2022 6d65 7461 6461           "metada
+000144a0: 7461 223a 207b 7d2c 0a20 2020 2020 2020  ta": {},.       
+000144b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000144c0: 2020 2020 2020 2020 2022 6f75 7470 7574           "output
+000144d0: 5f74 7970 6522 3a20 2265 7865 6375 7465  _type": "execute
+000144e0: 5f72 6573 756c 7422 2c0a 2020 2020 2020  _result",.      
+000144f0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00014500: 2020 2020 2020 7d0a 2020 2020 2020 2020        }.        
+00014510: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00014520: 5d2c 0a20 2020 2020 2020 2020 2020 2020  ],.             
+00014530: 2020 2020 2020 2020 2020 2022 736f 7572             "sour
+00014540: 6365 223a 2022 696d 706f 7274 2070 616e  ce": "import pan
+00014550: 6461 7320 6173 2070 645c 6e22 0a20 2020  das as pd\n".   
+00014560: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00014570: 2020 2020 2027 7064 2e67 6574 5f6f 7074       'pd.get_opt
+00014580: 696f 6e28 2264 6973 706c 6179 2e68 746d  ion("display.htm
+00014590: 6c2e 7461 626c 655f 7363 6865 6d61 2229  l.table_schema")
+000145a0: 272c 0a20 2020 2020 2020 2020 2020 2020  ',.             
+000145b0: 2020 2020 2020 207d 0a20 2020 2020 2020         }.       
+000145c0: 2020 2020 2020 2020 205d 0a20 2020 2020           ].     
+000145d0: 2020 2020 2020 207d 0a0a 2020 2020 2020         }..      
+000145e0: 2020 2020 2020 7061 7463 685f 6a73 6f6e        patch_json
+000145f0: 203d 2072 6573 706f 6e73 652e 6a73 6f6e   = response.json
+00014600: 2829 0a20 2020 2020 2020 2020 2020 2023  ().            #
+00014610: 2072 6573 706f 6e73 6520 7368 6f75 6c64   response should
+00014620: 2063 6f6e 7461 696e 2062 6f74 6820 7468   contain both th
+00014630: 6520 2763 656c 6c27 2c27 6b65 726e 656c  e 'cell','kernel
+00014640: 5f6d 6573 7361 6765 2720 7772 6170 7065  _message' wrappe
+00014650: 7273 0a20 2020 2020 2020 2020 2020 2061  rs.            a
+00014660: 7373 6572 7420 2263 656c 6c22 2069 6e20  ssert "cell" in 
+00014670: 7061 7463 685f 6a73 6f6e 2e6b 6579 7328  patch_json.keys(
+00014680: 290a 2020 2020 2020 2020 2020 2020 6d73  ).            ms
+00014690: 675f 6964 203d 2072 6573 706f 6e73 652e  g_id = response.
+000146a0: 6a73 6f6e 2829 5b22 6b65 726e 656c 5f6d  json()["kernel_m
+000146b0: 6573 7361 6765 225d 5b22 6d65 7373 6167  essage"]["messag
+000146c0: 655f 6964 225d 0a20 2020 2020 2020 2020  e_id"].         
+000146d0: 2020 2061 7373 6572 7420 6c65 6e28 6d73     assert len(ms
+000146e0: 675f 6964 2920 696e 206d 7367 5f69 645f  g_id) in msg_id_
+000146f0: 6c65 6e67 7468 730a 0a20 2020 2020 2020  lengths..       
+00014700: 2020 2020 2065 7865 635f 7265 706c 7920       exec_reply 
+00014710: 3d20 6177 6169 7420 7265 6365 6976 655f  = await receive_
+00014720: 6a73 6f6e 280a 2020 2020 2020 2020 2020  json(.          
+00014730: 2020 2020 2020 7765 6273 6f63 6b65 742c        websocket,
+00014740: 206d 7367 5f74 7970 6573 3d5b 2263 656c   msg_types=["cel
+00014750: 6c5f 6578 6563 7574 696f 6e5f 7265 706c  l_execution_repl
+00014760: 7922 5d0a 2020 2020 2020 2020 2020 2020  y"].            
+00014770: 290a 2020 2020 2020 2020 2020 2020 6173  ).            as
+00014780: 7365 7274 2065 7865 635f 7265 706c 795b  sert exec_reply[
+00014790: 2263 656c 6c5f 6578 6563 7574 696f 6e5f  "cell_execution_
+000147a0: 7265 706c 7922 5d5b 2263 656c 6c5f 6964  reply"]["cell_id
+000147b0: 225d 203d 3d20 6365 6c6c 5f75 7569 640a  "] == cell_uuid.
+000147c0: 2020 2020 2020 2020 2020 2020 6173 7365              asse
+000147d0: 7274 2065 7865 635f 7265 706c 795b 2263  rt exec_reply["c
+000147e0: 656c 6c5f 6578 6563 7574 696f 6e5f 7265  ell_execution_re
+000147f0: 706c 7922 5d5b 2270 6172 656e 745f 6964  ply"]["parent_id
+00014800: 225d 203d 3d20 6d73 675f 6964 0a0a 2020  "] == msg_id..  
+00014810: 2020 2020 2020 2020 2020 6461 7461 203d            data =
+00014820: 2061 7761 6974 2072 6563 6569 7665 5f6a   await receive_j
+00014830: 736f 6e28 7765 6273 6f63 6b65 742c 206d  son(websocket, m
+00014840: 7367 5f74 7970 6573 3d5b 2263 656c 6c5f  sg_types=["cell_
+00014850: 7570 6461 7465 225d 290a 2020 2020 2020  update"]).      
+00014860: 2020 2020 2020 6173 7365 7274 2064 6174        assert dat
+00014870: 6120 3d3d 2065 7870 6563 7465 640a 0a20  a == expected.. 
+00014880: 2020 2040 7079 7465 7374 2e6d 6172 6b2e     @pytest.mark.
+00014890: 6173 796e 6369 6f0a 2020 2020 6173 796e  asyncio.    asyn
+000148a0: 6320 6465 6620 7465 7374 5f63 656c 6c5f  c def test_cell_
+000148b0: 7374 7265 616d 5f70 7269 6e74 280a 2020  stream_print(.  
+000148c0: 2020 2020 2020 7365 6c66 2c20 636c 6965        self, clie
+000148d0: 6e74 3a20 5465 7374 436c 6965 6e74 2c20  nt: TestClient, 
+000148e0: 7375 7065 7275 7365 725f 746f 6b65 6e5f  superuser_token_
+000148f0: 6865 6164 6572 733a 2044 6963 745b 7374  headers: Dict[st
+00014900: 722c 2073 7472 5d0a 2020 2020 293a 0a20  r, str].    ):. 
+00014910: 2020 2020 2020 2075 7569 6420 3d20 6177         uuid = aw
+00014920: 6169 7420 7570 6c6f 6164 5f6e 6f74 6562  ait upload_noteb
+00014930: 6f6f 6b28 0a20 2020 2020 2020 2020 2020  ook(.           
+00014940: 2063 6c69 656e 742c 2073 7570 6572 7573   client, superus
+00014950: 6572 5f74 6f6b 656e 5f68 6561 6465 7273  er_token_headers
+00014960: 2c20 2263 6172 7269 6167 655f 7265 7475  , "carriage_retu
+00014970: 726e 5f74 6573 742e 6970 796e 6222 0a20  rn_test.ipynb". 
+00014980: 2020 2020 2020 2029 0a0a 2020 2020 2020         )..      
+00014990: 2020 7265 7370 6f6e 7365 203d 2061 7761    response = awa
+000149a0: 6974 2063 6c69 656e 742e 6765 7428 0a20  it client.get(. 
+000149b0: 2020 2020 2020 2020 2020 2066 222f 6e6f             f"/no
+000149c0: 7465 626f 6f6b 732f 7b75 7569 647d 2f63  tebooks/{uuid}/c
+000149d0: 656c 6c73 222c 2068 6561 6465 7273 3d73  ells", headers=s
+000149e0: 7570 6572 7573 6572 5f74 6f6b 656e 5f68  uperuser_token_h
+000149f0: 6561 6465 7273 0a20 2020 2020 2020 2029  eaders.        )
+00014a00: 0a20 2020 2020 2020 2061 7373 6572 7420  .        assert 
+00014a10: 7265 7370 6f6e 7365 2e73 7461 7475 735f  response.status_
+00014a20: 636f 6465 203d 3d20 3230 300a 2020 2020  code == 200.    
+00014a30: 2020 2020 6365 6c6c 7320 3d20 7265 7370      cells = resp
+00014a40: 6f6e 7365 2e6a 736f 6e28 295b 2263 656c  onse.json()["cel
+00014a50: 6c73 225d 0a20 2020 2020 2020 2069 6d70  ls"].        imp
+00014a60: 6f72 745f 6365 6c6c 5f75 7569 6420 3d20  ort_cell_uuid = 
+00014a70: 6365 6c6c 735b 305d 5b22 6d65 7461 6461  cells[0]["metada
+00014a80: 7461 225d 5b22 6a75 7079 7465 725f 6431  ta"]["jupyter_d1
+00014a90: 225d 5b22 7575 6964 225d 0a20 2020 2020  "]["uuid"].     
+00014aa0: 2020 2074 696d 655f 6c6f 6f70 5f63 656c     time_loop_cel
+00014ab0: 6c5f 7575 6964 203d 2063 656c 6c73 5b31  l_uuid = cells[1
+00014ac0: 5d5b 226d 6574 6164 6174 6122 5d5b 226a  ]["metadata"]["j
+00014ad0: 7570 7974 6572 5f64 3122 5d5b 2275 7569  upyter_d1"]["uui
+00014ae0: 6422 5d0a 0a20 2020 2020 2020 2061 7379  d"]..        asy
+00014af0: 6e63 2077 6974 6820 636c 6965 6e74 2e77  nc with client.w
+00014b00: 6562 736f 636b 6574 5f63 6f6e 6e65 6374  ebsocket_connect
+00014b10: 280a 2020 2020 2020 2020 2020 2020 6622  (.            f"
+00014b20: 2f6e 6f74 6562 6f6f 6b73 2f7b 7575 6964  /notebooks/{uuid
+00014b30: 7d2f 7773 2f6e 6f74 6562 6f6f 6b22 2c20  }/ws/notebook", 
+00014b40: 6865 6164 6572 733d 7375 7065 7275 7365  headers=superuse
+00014b50: 725f 746f 6b65 6e5f 6865 6164 6572 730a  r_token_headers.
+00014b60: 2020 2020 2020 2020 2920 6173 2077 6562          ) as web
+00014b70: 736f 636b 6574 3a0a 0a20 2020 2020 2020  socket:..       
+00014b80: 2020 2020 2061 7761 6974 2061 7379 6e63       await async
+00014b90: 696f 2e73 6c65 6570 2857 4542 534f 434b  io.sleep(WEBSOCK
+00014ba0: 4554 5f53 4c45 4550 5f54 494d 4529 0a0a  ET_SLEEP_TIME)..
+00014bb0: 2020 2020 2020 2020 2020 2020 2320 436c              # Cl
+00014bc0: 6561 7220 7468 6520 7765 6220 736f 636b  ear the web sock
+00014bd0: 6574 2062 6566 6f72 6520 7765 2073 7461  et before we sta
+00014be0: 7274 0a20 2020 2020 2020 2020 2020 2061  rt.            a
+00014bf0: 7761 6974 2063 6f6c 6c65 6374 5f77 6562  wait collect_web
+00014c00: 736f 636b 6574 5f6d 6573 7361 6765 7328  socket_messages(
+00014c10: 7765 6273 6f63 6b65 742c 2074 696d 656f  websocket, timeo
+00014c20: 7574 3d32 290a 0a20 2020 2020 2020 2020  ut=2)..         
+00014c30: 2020 2023 2065 7865 6375 7465 2069 6d70     # execute imp
+00014c40: 6f72 7420 6365 6c6c 2074 6f20 7072 6570  ort cell to prep
+00014c50: 2066 6f72 206f 7468 6572 730a 2020 2020   for others.    
+00014c60: 2020 2020 2020 2020 7265 7370 6f6e 7365          response
+00014c70: 203d 2061 7761 6974 2063 6c69 656e 742e   = await client.
+00014c80: 6765 7428 0a20 2020 2020 2020 2020 2020  get(.           
+00014c90: 2020 2020 2066 222f 6e6f 7465 626f 6f6b       f"/notebook
+00014ca0: 732f 7b75 7569 647d 2f63 656c 6c73 2f7b  s/{uuid}/cells/{
+00014cb0: 696d 706f 7274 5f63 656c 6c5f 7575 6964  import_cell_uuid
+00014cc0: 7d2f 6578 6563 7574 6522 2c0a 2020 2020  }/execute",.    
+00014cd0: 2020 2020 2020 2020 2020 2020 6865 6164              head
+00014ce0: 6572 733d 7375 7065 7275 7365 725f 746f  ers=superuser_to
+00014cf0: 6b65 6e5f 6865 6164 6572 732c 0a20 2020  ken_headers,.   
+00014d00: 2020 2020 2020 2020 2029 0a20 2020 2020           ).     
+00014d10: 2020 2020 2020 2061 7373 6572 7420 7265         assert re
+00014d20: 7370 6f6e 7365 2e73 7461 7475 735f 636f  sponse.status_co
+00014d30: 6465 203d 3d20 3230 300a 0a20 2020 2020  de == 200..     
+00014d40: 2020 2020 2020 2023 2057 6169 7420 666f         # Wait fo
+00014d50: 7220 7468 6520 696d 706f 7274 2074 6f20  r the import to 
+00014d60: 636f 6d70 6c65 7465 2062 7920 6c6f 6f6b  complete by look
+00014d70: 696e 6720 666f 720a 2020 2020 2020 2020  ing for.        
+00014d80: 2020 2020 2320 6578 6563 7574 696f 6e5f      # execution_
+00014d90: 7374 6174 6520 3d3d 2027 6964 6c65 2720  state == 'idle' 
+00014da0: 6f6e 2074 6865 2027 696d 706f 7274 2720  on the 'import' 
+00014db0: 6365 6c6c 0a20 2020 2020 2020 2020 2020  cell.           
+00014dc0: 2074 7279 3a0a 2020 2020 2020 2020 2020   try:.          
+00014dd0: 2020 2020 2020 7768 696c 6520 5472 7565        while True
+00014de0: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
+00014df0: 2020 2020 2020 6d73 6720 3d20 6177 6169        msg = awai
+00014e00: 7420 7265 6365 6976 655f 6a73 6f6e 2877  t receive_json(w
+00014e10: 6562 736f 636b 6574 2c20 7469 6d65 6f75  ebsocket, timeou
+00014e20: 743d 3135 290a 2020 2020 2020 2020 2020  t=15).          
+00014e30: 2020 2020 2020 2020 2020 6966 2022 6365            if "ce
+00014e40: 6c6c 5f75 7064 6174 6522 2069 6e20 6d73  ll_update" in ms
+00014e50: 672e 6b65 7973 2829 3a0a 2020 2020 2020  g.keys():.      
+00014e60: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00014e70: 2020 6431 5f6d 6574 6120 3d20 6d73 675b    d1_meta = msg[
+00014e80: 2263 656c 6c5f 7570 6461 7465 225d 5b30  "cell_update"][0
+00014e90: 5d5b 226d 6574 6164 6174 6122 5d5b 0a20  ]["metadata"][. 
+00014ea0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00014eb0: 2020 2020 2020 2020 2020 2022 6a75 7079             "jupy
+00014ec0: 7465 725f 6431 220a 2020 2020 2020 2020  ter_d1".        
+00014ed0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00014ee0: 5d0a 2020 2020 2020 2020 2020 2020 2020  ].              
+00014ef0: 2020 2020 2020 2020 2020 6966 2028 0a20            if (. 
+00014f00: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00014f10: 2020 2020 2020 2020 2020 2064 315f 6d65             d1_me
+00014f20: 7461 5b22 6578 6563 7574 696f 6e5f 7374  ta["execution_st
+00014f30: 6174 6522 5d20 3d3d 2022 6964 6c65 220a  ate"] == "idle".
+00014f40: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00014f50: 2020 2020 2020 2020 2020 2020 616e 6420              and 
+00014f60: 6431 5f6d 6574 615b 2275 7569 6422 5d20  d1_meta["uuid"] 
+00014f70: 3d3d 2069 6d70 6f72 745f 6365 6c6c 5f75  == import_cell_u
+00014f80: 7569 640a 2020 2020 2020 2020 2020 2020  uid.            
+00014f90: 2020 2020 2020 2020 2020 2020 293a 0a0a              ):..
+00014fa0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00014fb0: 2020 2020 2020 2020 2020 2020 6272 6561              brea
+00014fc0: 6b0a 2020 2020 2020 2020 2020 2020 6578  k.            ex
+00014fd0: 6365 7074 2054 696d 656f 7574 4572 726f  cept TimeoutErro
+00014fe0: 723a 0a20 2020 2020 2020 2020 2020 2020  r:.             
+00014ff0: 2020 2070 6173 730a 0a20 2020 2020 2020     pass..       
+00015000: 2020 2020 2023 2043 6c65 6172 2074 6865       # Clear the
+00015010: 2077 6562 2073 6f63 6b65 7420 6265 666f   web socket befo
+00015020: 7265 2077 6520 7374 6172 740a 2020 2020  re we start.    
+00015030: 2020 2020 2020 2020 6177 6169 7420 636f          await co
+00015040: 6c6c 6563 745f 7765 6273 6f63 6b65 745f  llect_websocket_
+00015050: 6d65 7373 6167 6573 2877 6562 736f 636b  messages(websock
+00015060: 6574 2c20 7469 6d65 6f75 743d 3229 0a0a  et, timeout=2)..
+00015070: 2020 2020 2020 2020 2020 2020 2320 6578              # ex
+00015080: 6563 7574 6520 7469 6d65 206c 6f6f 7020  ecute time loop 
+00015090: 6365 6c6c 2074 6f0a 2020 2020 2020 2020  cell to.        
+000150a0: 2020 2020 7265 7370 6f6e 7365 203d 2061      response = a
+000150b0: 7761 6974 2063 6c69 656e 742e 6765 7428  wait client.get(
+000150c0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+000150d0: 2066 222f 6e6f 7465 626f 6f6b 732f 7b75   f"/notebooks/{u
+000150e0: 7569 647d 2f63 656c 6c73 2f7b 7469 6d65  uid}/cells/{time
+000150f0: 5f6c 6f6f 705f 6365 6c6c 5f75 7569 647d  _loop_cell_uuid}
+00015100: 2f65 7865 6375 7465 222c 0a20 2020 2020  /execute",.     
+00015110: 2020 2020 2020 2020 2020 2068 6561 6465             heade
+00015120: 7273 3d73 7570 6572 7573 6572 5f74 6f6b  rs=superuser_tok
+00015130: 656e 5f68 6561 6465 7273 2c0a 2020 2020  en_headers,.    
+00015140: 2020 2020 2020 2020 290a 2020 2020 2020          ).      
+00015150: 2020 2020 2020 6173 7365 7274 2072 6573        assert res
+00015160: 706f 6e73 652e 7374 6174 7573 5f63 6f64  ponse.status_cod
+00015170: 6520 3d3d 2032 3030 0a0a 2020 2020 2020  e == 200..      
+00015180: 2020 2020 2020 6d73 6773 203d 2061 7761        msgs = awa
+00015190: 6974 2063 6f6c 6c65 6374 5f77 6562 736f  it collect_webso
+000151a0: 636b 6574 5f6d 6573 7361 6765 7328 7765  cket_messages(we
+000151b0: 6273 6f63 6b65 742c 2074 696d 656f 7574  bsocket, timeout
+000151c0: 3d31 3029 0a20 2020 2020 2020 2020 2020  =10).           
+000151d0: 2063 656c 6c5f 7570 6461 7465 5f6d 7367   cell_update_msg
+000151e0: 7320 3d20 6669 6c74 6572 5f77 6562 736f  s = filter_webso
+000151f0: 636b 6574 5f63 6f6c 6c65 6374 696f 6e28  cket_collection(
+00015200: 6d73 6773 2c20 2263 656c 6c5f 7570 6461  msgs, "cell_upda
+00015210: 7465 2229 0a0a 2020 2020 2020 2020 2020  te")..          
+00015220: 2020 6461 7461 203d 2063 656c 6c5f 7570    data = cell_up
+00015230: 6461 7465 5f6d 7367 732e 706f 7028 3029  date_msgs.pop(0)
+00015240: 0a20 2020 2020 2020 2020 2020 2061 7373  .            ass
+00015250: 6572 7420 280a 2020 2020 2020 2020 2020  ert (.          
+00015260: 2020 2020 2020 6461 7461 5b22 6365 6c6c        data["cell
+00015270: 5f75 7064 6174 6522 5d5b 305d 5b22 6d65  _update"][0]["me
+00015280: 7461 6461 7461 225d 5b22 6a75 7079 7465  tadata"]["jupyte
+00015290: 725f 6431 225d 5b22 7575 6964 225d 0a20  r_d1"]["uuid"]. 
+000152a0: 2020 2020 2020 2020 2020 2020 2020 203d                 =
+000152b0: 3d20 7469 6d65 5f6c 6f6f 705f 6365 6c6c  = time_loop_cell
+000152c0: 5f75 7569 640a 2020 2020 2020 2020 2020  _uuid.          
+000152d0: 2020 290a 2020 2020 2020 2020 2020 2020    ).            
+000152e0: 6173 7365 7274 2064 6174 615b 2263 656c  assert data["cel
+000152f0: 6c5f 7570 6461 7465 225d 5b30 5d5b 2265  l_update"][0]["e
+00015300: 7865 6375 7469 6f6e 5f63 6f75 6e74 225d  xecution_count"]
+00015310: 2069 7320 4e6f 6e65 0a20 2020 2020 2020   is None.       
+00015320: 2020 2020 2061 7373 6572 7420 280a 2020       assert (.  
+00015330: 2020 2020 2020 2020 2020 2020 2020 6461                da
+00015340: 7461 5b22 6365 6c6c 5f75 7064 6174 6522  ta["cell_update"
+00015350: 5d5b 305d 5b22 6d65 7461 6461 7461 225d  ][0]["metadata"]
+00015360: 5b22 6a75 7079 7465 725f 6431 225d 5b0a  ["jupyter_d1"][.
+00015370: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00015380: 2020 2020 2265 7865 6375 7469 6f6e 5f73      "execution_s
+00015390: 7461 7465 220a 2020 2020 2020 2020 2020  tate".          
+000153a0: 2020 2020 2020 5d0a 2020 2020 2020 2020        ].        
+000153b0: 2020 2020 2020 2020 3d3d 2022 6275 7379          == "busy
+000153c0: 220a 2020 2020 2020 2020 2020 2020 290a  ".            ).
+000153d0: 2020 2020 2020 2020 2020 2020 6173 7365              asse
+000153e0: 7274 2064 6174 615b 2263 656c 6c5f 7570  rt data["cell_up
+000153f0: 6461 7465 225d 5b30 5d5b 226f 7574 7075  date"][0]["outpu
+00015400: 7473 225d 203d 3d20 5b5d 0a0a 2020 2020  ts"] == []..    
+00015410: 2020 2020 2020 2020 6461 7461 203d 2063          data = c
+00015420: 656c 6c5f 7570 6461 7465 5f6d 7367 732e  ell_update_msgs.
+00015430: 706f 7028 3029 0a20 2020 2020 2020 2020  pop(0).         
+00015440: 2020 2061 7373 6572 7420 280a 2020 2020     assert (.    
+00015450: 2020 2020 2020 2020 2020 2020 6461 7461              data
+00015460: 5b22 6365 6c6c 5f75 7064 6174 6522 5d5b  ["cell_update"][
+00015470: 305d 5b22 6d65 7461 6461 7461 225d 5b22  0]["metadata"]["
+00015480: 6a75 7079 7465 725f 6431 225d 5b22 7575  jupyter_d1"]["uu
+00015490: 6964 225d 0a20 2020 2020 2020 2020 2020  id"].           
+000154a0: 2020 2020 203d 3d20 7469 6d65 5f6c 6f6f       == time_loo
+000154b0: 705f 6365 6c6c 5f75 7569 640a 2020 2020  p_cell_uuid.    
+000154c0: 2020 2020 2020 2020 290a 2020 2020 2020          ).      
+000154d0: 2020 2020 2020 6173 7365 7274 2064 6174        assert dat
+000154e0: 615b 2263 656c 6c5f 7570 6461 7465 225d  a["cell_update"]
+000154f0: 5b30 5d5b 2265 7865 6375 7469 6f6e 5f63  [0]["execution_c
+00015500: 6f75 6e74 225d 2069 7320 4e6f 6e65 0a20  ount"] is None. 
+00015510: 2020 2020 2020 2020 2020 2061 7373 6572             asser
+00015520: 7420 280a 2020 2020 2020 2020 2020 2020  t (.            
+00015530: 2020 2020 6461 7461 5b22 6365 6c6c 5f75      data["cell_u
+00015540: 7064 6174 6522 5d5b 305d 5b22 6d65 7461  pdate"][0]["meta
+00015550: 6461 7461 225d 5b22 6a75 7079 7465 725f  data"]["jupyter_
+00015560: 6431 225d 5b0a 2020 2020 2020 2020 2020  d1"][.          
+00015570: 2020 2020 2020 2020 2020 2265 7865 6375            "execu
+00015580: 7469 6f6e 5f73 7461 7465 220a 2020 2020  tion_state".    
+00015590: 2020 2020 2020 2020 2020 2020 5d0a 2020              ].  
+000155a0: 2020 2020 2020 2020 2020 2020 2020 3d3d                ==
+000155b0: 2022 6275 7379 220a 2020 2020 2020 2020   "busy".        
+000155c0: 2020 2020 290a 2020 2020 2020 2020 2020      ).          
+000155d0: 2020 6173 7365 7274 2064 6174 615b 2263    assert data["c
+000155e0: 656c 6c5f 7570 6461 7465 225d 5b30 5d5b  ell_update"][0][
+000155f0: 226f 7574 7075 7473 225d 203d 3d20 5b0a  "outputs"] == [.
+00015600: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00015610: 7b0a 2020 2020 2020 2020 2020 2020 2020  {.              
+00015620: 2020 2020 2020 226e 616d 6522 3a20 2273        "name": "s
+00015630: 7464 6f75 7422 2c0a 2020 2020 2020 2020  tdout",.        
+00015640: 2020 2020 2020 2020 2020 2020 226f 7574              "out
+00015650: 7075 745f 7479 7065 223a 2022 7374 7265  put_type": "stre
+00015660: 616d 222c 0a20 2020 2020 2020 2020 2020  am",.           
+00015670: 2020 2020 2020 2020 2022 7465 7874 223a           "text":
+00015680: 205b 2253 7461 7274 5c6e 225d 2c0a 2020   ["Start\n"],.  
+00015690: 2020 2020 2020 2020 2020 2020 2020 7d0a                }.
+000156a0: 2020 2020 2020 2020 2020 2020 5d0a 0a20              ].. 
+000156b0: 2020 2020 2020 2020 2020 2066 6f72 2069             for i
+000156c0: 6478 2069 6e20 5b30 2c20 312c 2032 2c20  dx in [0, 1, 2, 
+000156d0: 335d 3a0a 2020 2020 2020 2020 2020 2020  3]:.            
+000156e0: 2020 2020 6461 7461 203d 2063 656c 6c5f      data = cell_
+000156f0: 7570 6461 7465 5f6d 7367 732e 706f 7028  update_msgs.pop(
+00015700: 3029 0a20 2020 2020 2020 2020 2020 2020  0).             
+00015710: 2020 2061 7373 6572 7420 280a 2020 2020     assert (.    
+00015720: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00015730: 6461 7461 5b22 6365 6c6c 5f75 7064 6174  data["cell_updat
+00015740: 6522 5d5b 305d 5b22 6d65 7461 6461 7461  e"][0]["metadata
+00015750: 225d 5b22 6a75 7079 7465 725f 6431 225d  "]["jupyter_d1"]
+00015760: 5b22 7575 6964 225d 0a20 2020 2020 2020  ["uuid"].       
+00015770: 2020 2020 2020 2020 2020 2020 203d 3d20               == 
+00015780: 7469 6d65 5f6c 6f6f 705f 6365 6c6c 5f75  time_loop_cell_u
+00015790: 7569 640a 2020 2020 2020 2020 2020 2020  uid.            
+000157a0: 2020 2020 290a 2020 2020 2020 2020 2020      ).          
+000157b0: 2020 2020 2020 6173 7365 7274 2064 6174        assert dat
+000157c0: 615b 2263 656c 6c5f 7570 6461 7465 225d  a["cell_update"]
+000157d0: 5b30 5d5b 2265 7865 6375 7469 6f6e 5f63  [0]["execution_c
+000157e0: 6f75 6e74 225d 2069 7320 4e6f 6e65 0a20  ount"] is None. 
+000157f0: 2020 2020 2020 2020 2020 2020 2020 2061                 a
+00015800: 7373 6572 7420 280a 2020 2020 2020 2020  ssert (.        
+00015810: 2020 2020 2020 2020 2020 2020 6461 7461              data
+00015820: 5b22 6365 6c6c 5f75 7064 6174 6522 5d5b  ["cell_update"][
+00015830: 305d 5b22 6d65 7461 6461 7461 225d 5b22  0]["metadata"]["
+00015840: 6a75 7079 7465 725f 6431 225d 5b0a 2020  jupyter_d1"][.  
+00015850: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00015860: 2020 2020 2020 2265 7865 6375 7469 6f6e        "execution
+00015870: 5f73 7461 7465 220a 2020 2020 2020 2020  _state".        
+00015880: 2020 2020 2020 2020 2020 2020 5d0a 2020              ].  
+00015890: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000158a0: 2020 3d3d 2022 6275 7379 220a 2020 2020    == "busy".    
+000158b0: 2020 2020 2020 2020 2020 2020 290a 2020              ).  
+000158c0: 2020 2020 2020 2020 2020 2020 2020 6173                as
+000158d0: 7365 7274 2064 6174 615b 2263 656c 6c5f  sert data["cell_
+000158e0: 7570 6461 7465 225d 5b30 5d5b 226f 7574  update"][0]["out
+000158f0: 7075 7473 225d 203d 3d20 5b0a 2020 2020  puts"] == [.    
+00015900: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00015910: 7b0a 2020 2020 2020 2020 2020 2020 2020  {.              
+00015920: 2020 2020 2020 2020 2020 226e 616d 6522            "name"
+00015930: 3a20 2273 7464 6f75 7422 2c0a 2020 2020  : "stdout",.    
+00015940: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00015950: 2020 2020 226f 7574 7075 745f 7479 7065      "output_type
+00015960: 223a 2022 7374 7265 616d 222c 0a20 2020  ": "stream",.   
+00015970: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00015980: 2020 2020 2022 7465 7874 223a 205b 2253       "text": ["S
+00015990: 7461 7274 5c6e 222c 2066 227b 6964 787d  tart\n", f"{idx}
+000159a0: 5c72 225d 2c0a 2020 2020 2020 2020 2020  \r"],.          
+000159b0: 2020 2020 2020 2020 2020 7d0a 2020 2020            }.    
+000159c0: 2020 2020 2020 2020 2020 2020 5d0a 0a20              ].. 
+000159d0: 2020 2020 2020 2020 2020 2064 6174 6120             data 
+000159e0: 3d20 6365 6c6c 5f75 7064 6174 655f 6d73  = cell_update_ms
+000159f0: 6773 2e70 6f70 2830 290a 2020 2020 2020  gs.pop(0).      
+00015a00: 2020 2020 2020 6173 7365 7274 2028 0a20        assert (. 
+00015a10: 2020 2020 2020 2020 2020 2020 2020 2064                 d
+00015a20: 6174 615b 2263 656c 6c5f 7570 6461 7465  ata["cell_update
+00015a30: 225d 5b30 5d5b 226d 6574 6164 6174 6122  "][0]["metadata"
+00015a40: 5d5b 226a 7570 7974 6572 5f64 3122 5d5b  ]["jupyter_d1"][
+00015a50: 2275 7569 6422 5d0a 2020 2020 2020 2020  "uuid"].        
+00015a60: 2020 2020 2020 2020 3d3d 2074 696d 655f          == time_
+00015a70: 6c6f 6f70 5f63 656c 6c5f 7575 6964 0a20  loop_cell_uuid. 
+00015a80: 2020 2020 2020 2020 2020 2029 0a20 2020             ).   
+00015a90: 2020 2020 2020 2020 2061 7373 6572 7420           assert 
+00015aa0: 6461 7461 5b22 6365 6c6c 5f75 7064 6174  data["cell_updat
+00015ab0: 6522 5d5b 305d 5b22 6578 6563 7574 696f  e"][0]["executio
+00015ac0: 6e5f 636f 756e 7422 5d20 6973 204e 6f6e  n_count"] is Non
+00015ad0: 650a 2020 2020 2020 2020 2020 2020 6173  e.            as
+00015ae0: 7365 7274 2028 0a20 2020 2020 2020 2020  sert (.         
+00015af0: 2020 2020 2020 2064 6174 615b 2263 656c         data["cel
+00015b00: 6c5f 7570 6461 7465 225d 5b30 5d5b 226d  l_update"][0]["m
+00015b10: 6574 6164 6174 6122 5d5b 226a 7570 7974  etadata"]["jupyt
+00015b20: 6572 5f64 3122 5d5b 0a20 2020 2020 2020  er_d1"][.       
+00015b30: 2020 2020 2020 2020 2020 2020 2022 6578               "ex
+00015b40: 6563 7574 696f 6e5f 7374 6174 6522 0a20  ecution_state". 
+00015b50: 2020 2020 2020 2020 2020 2020 2020 205d                 ]
+00015b60: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00015b70: 203d 3d20 2262 7573 7922 0a20 2020 2020   == "busy".     
+00015b80: 2020 2020 2020 2029 0a20 2020 2020 2020         ).       
+00015b90: 2020 2020 2061 7373 6572 7420 6461 7461       assert data
+00015ba0: 5b22 6365 6c6c 5f75 7064 6174 6522 5d5b  ["cell_update"][
+00015bb0: 305d 5b22 6f75 7470 7574 7322 5d20 3d3d  0]["outputs"] ==
+00015bc0: 205b 0a20 2020 2020 2020 2020 2020 2020   [.             
+00015bd0: 2020 207b 0a20 2020 2020 2020 2020 2020     {.           
+00015be0: 2020 2020 2020 2020 2022 6e61 6d65 223a           "name":
+00015bf0: 2022 7374 646f 7574 222c 0a20 2020 2020   "stdout",.     
+00015c00: 2020 2020 2020 2020 2020 2020 2020 2022                 "
+00015c10: 6f75 7470 7574 5f74 7970 6522 3a20 2273  output_type": "s
+00015c20: 7472 6561 6d22 2c0a 2020 2020 2020 2020  tream",.        
+00015c30: 2020 2020 2020 2020 2020 2020 2274 6578              "tex
+00015c40: 7422 3a20 5b22 5374 6172 745c 6e22 2c20  t": ["Start\n", 
+00015c50: 2244 6f6e 655c 6e22 5d2c 0a20 2020 2020  "Done\n"],.     
+00015c60: 2020 2020 2020 2020 2020 207d 0a20 2020             }.   
+00015c70: 2020 2020 2020 2020 205d 0a0a 2020 2020           ]..    
+00015c80: 2020 2020 2020 2020 2320 6c61 7374 2063          # last c
+00015c90: 656c 6c5f 7570 6461 7465 2068 6173 2065  ell_update has e
+00015ca0: 7865 6375 7469 6f6e 5f63 6f75 6e74 203d  xecution_count =
+00015cb0: 3d20 3220 616e 6420 6578 6563 7574 696f  = 2 and executio
+00015cc0: 6e5f 7374 6174 6520 6973 2027 6964 6c65  n_state is 'idle
+00015cd0: 270a 2020 2020 2020 2020 2020 2020 6461  '.            da
+00015ce0: 7461 203d 2063 656c 6c5f 7570 6461 7465  ta = cell_update
+00015cf0: 5f6d 7367 732e 706f 7028 3029 0a20 2020  _msgs.pop(0).   
+00015d00: 2020 2020 2020 2020 2061 7373 6572 7420           assert 
+00015d10: 280a 2020 2020 2020 2020 2020 2020 2020  (.              
+00015d20: 2020 6461 7461 5b22 6365 6c6c 5f75 7064    data["cell_upd
+00015d30: 6174 6522 5d5b 305d 5b22 6d65 7461 6461  ate"][0]["metada
+00015d40: 7461 225d 5b22 6a75 7079 7465 725f 6431  ta"]["jupyter_d1
+00015d50: 225d 5b22 7575 6964 225d 0a20 2020 2020  "]["uuid"].     
+00015d60: 2020 2020 2020 2020 2020 203d 3d20 7469             == ti
+00015d70: 6d65 5f6c 6f6f 705f 6365 6c6c 5f75 7569  me_loop_cell_uui
+00015d80: 640a 2020 2020 2020 2020 2020 2020 290a  d.            ).
+00015d90: 2020 2020 2020 2020 2020 2020 6173 7365              asse
+00015da0: 7274 2064 6174 615b 2263 656c 6c5f 7570  rt data["cell_up
+00015db0: 6461 7465 225d 5b30 5d5b 2265 7865 6375  date"][0]["execu
+00015dc0: 7469 6f6e 5f63 6f75 6e74 225d 203d 3d20  tion_count"] == 
+00015dd0: 320a 2020 2020 2020 2020 2020 2020 6173  2.            as
+00015de0: 7365 7274 2028 0a20 2020 2020 2020 2020  sert (.         
+00015df0: 2020 2020 2020 2064 6174 615b 2263 656c         data["cel
+00015e00: 6c5f 7570 6461 7465 225d 5b30 5d5b 226d  l_update"][0]["m
+00015e10: 6574 6164 6174 6122 5d5b 226a 7570 7974  etadata"]["jupyt
+00015e20: 6572 5f64 3122 5d5b 0a20 2020 2020 2020  er_d1"][.       
+00015e30: 2020 2020 2020 2020 2020 2020 2022 6578               "ex
+00015e40: 6563 7574 696f 6e5f 7374 6174 6522 0a20  ecution_state". 
+00015e50: 2020 2020 2020 2020 2020 2020 2020 205d                 ]
+00015e60: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00015e70: 203d 3d20 2269 646c 6522 0a20 2020 2020   == "idle".     
+00015e80: 2020 2020 2020 2029 0a20 2020 2020 2020         ).       
+00015e90: 2020 2020 2061 7373 6572 7420 6461 7461       assert data
+00015ea0: 5b22 6365 6c6c 5f75 7064 6174 6522 5d5b  ["cell_update"][
+00015eb0: 305d 5b22 6f75 7470 7574 7322 5d20 3d3d  0]["outputs"] ==
+00015ec0: 205b 0a20 2020 2020 2020 2020 2020 2020   [.             
+00015ed0: 2020 207b 0a20 2020 2020 2020 2020 2020     {.           
+00015ee0: 2020 2020 2020 2020 2022 6e61 6d65 223a           "name":
+00015ef0: 2022 7374 646f 7574 222c 0a20 2020 2020   "stdout",.     
+00015f00: 2020 2020 2020 2020 2020 2020 2020 2022                 "
+00015f10: 6f75 7470 7574 5f74 7970 6522 3a20 2273  output_type": "s
+00015f20: 7472 6561 6d22 2c0a 2020 2020 2020 2020  tream",.        
+00015f30: 2020 2020 2020 2020 2020 2020 2274 6578              "tex
+00015f40: 7422 3a20 5b22 5374 6172 745c 6e22 2c20  t": ["Start\n", 
+00015f50: 2244 6f6e 655c 6e22 5d2c 0a20 2020 2020  "Done\n"],.     
+00015f60: 2020 2020 2020 2020 2020 207d 0a20 2020             }.   
+00015f70: 2020 2020 2020 2020 205d 0a0a 2020 2020           ]..    
+00015f80: 4070 7974 6573 742e 6d61 726b 2e61 7379  @pytest.mark.asy
+00015f90: 6e63 696f 0a20 2020 2061 7379 6e63 2064  ncio.    async d
+00015fa0: 6566 2074 6573 745f 6365 6c6c 5f73 7472  ef test_cell_str
+00015fb0: 6561 6d5f 7471 646d 280a 2020 2020 2020  eam_tqdm(.      
+00015fc0: 2020 7365 6c66 2c20 636c 6965 6e74 3a20    self, client: 
+00015fd0: 5465 7374 436c 6965 6e74 2c20 7375 7065  TestClient, supe
+00015fe0: 7275 7365 725f 746f 6b65 6e5f 6865 6164  ruser_token_head
+00015ff0: 6572 733a 2044 6963 745b 7374 722c 2073  ers: Dict[str, s
+00016000: 7472 5d0a 2020 2020 293a 0a20 2020 2020  tr].    ):.     
+00016010: 2020 2075 7569 6420 3d20 6177 6169 7420     uuid = await 
+00016020: 7570 6c6f 6164 5f6e 6f74 6562 6f6f 6b28  upload_notebook(
+00016030: 0a20 2020 2020 2020 2020 2020 2063 6c69  .            cli
+00016040: 656e 742c 2073 7570 6572 7573 6572 5f74  ent, superuser_t
+00016050: 6f6b 656e 5f68 6561 6465 7273 2c20 2263  oken_headers, "c
+00016060: 6172 7269 6167 655f 7265 7475 726e 5f74  arriage_return_t
+00016070: 6573 742e 6970 796e 6222 0a20 2020 2020  est.ipynb".     
+00016080: 2020 2029 0a0a 2020 2020 2020 2020 7265     )..        re
+00016090: 7370 6f6e 7365 203d 2061 7761 6974 2063  sponse = await c
+000160a0: 6c69 656e 742e 6765 7428 0a20 2020 2020  lient.get(.     
+000160b0: 2020 2020 2020 2066 222f 6e6f 7465 626f         f"/notebo
+000160c0: 6f6b 732f 7b75 7569 647d 2f63 656c 6c73  oks/{uuid}/cells
+000160d0: 222c 2068 6561 6465 7273 3d73 7570 6572  ", headers=super
+000160e0: 7573 6572 5f74 6f6b 656e 5f68 6561 6465  user_token_heade
+000160f0: 7273 0a20 2020 2020 2020 2029 0a20 2020  rs.        ).   
+00016100: 2020 2020 2061 7373 6572 7420 7265 7370       assert resp
+00016110: 6f6e 7365 2e73 7461 7475 735f 636f 6465  onse.status_code
+00016120: 203d 3d20 3230 300a 2020 2020 2020 2020   == 200.        
+00016130: 6365 6c6c 7320 3d20 7265 7370 6f6e 7365  cells = response
+00016140: 2e6a 736f 6e28 295b 2263 656c 6c73 225d  .json()["cells"]
+00016150: 0a20 2020 2020 2020 2069 6d70 6f72 745f  .        import_
+00016160: 6365 6c6c 5f75 7569 6420 3d20 6365 6c6c  cell_uuid = cell
+00016170: 735b 305d 5b22 6d65 7461 6461 7461 225d  s[0]["metadata"]
+00016180: 5b22 6a75 7079 7465 725f 6431 225d 5b22  ["jupyter_d1"]["
+00016190: 7575 6964 225d 0a20 2020 2020 2020 2074  uuid"].        t
+000161a0: 7164 6d5f 6365 6c6c 5f75 7569 6420 3d20  qdm_cell_uuid = 
+000161b0: 6365 6c6c 735b 335d 5b22 6d65 7461 6461  cells[3]["metada
+000161c0: 7461 225d 5b22 6a75 7079 7465 725f 6431  ta"]["jupyter_d1
+000161d0: 225d 5b22 7575 6964 225d 0a0a 2020 2020  "]["uuid"]..    
+000161e0: 2020 2020 6173 796e 6320 7769 7468 2063      async with c
+000161f0: 6c69 656e 742e 7765 6273 6f63 6b65 745f  lient.websocket_
+00016200: 636f 6e6e 6563 7428 0a20 2020 2020 2020  connect(.       
+00016210: 2020 2020 2066 222f 6e6f 7465 626f 6f6b       f"/notebook
+00016220: 732f 7b75 7569 647d 2f77 732f 6e6f 7465  s/{uuid}/ws/note
+00016230: 626f 6f6b 222c 2068 6561 6465 7273 3d73  book", headers=s
+00016240: 7570 6572 7573 6572 5f74 6f6b 656e 5f68  uperuser_token_h
+00016250: 6561 6465 7273 0a20 2020 2020 2020 2029  eaders.        )
+00016260: 2061 7320 7765 6273 6f63 6b65 743a 0a0a   as websocket:..
+00016270: 2020 2020 2020 2020 2020 2020 6177 6169              awai
+00016280: 7420 6173 796e 6369 6f2e 736c 6565 7028  t asyncio.sleep(
+00016290: 5745 4253 4f43 4b45 545f 534c 4545 505f  WEBSOCKET_SLEEP_
+000162a0: 5449 4d45 290a 0a20 2020 2020 2020 2020  TIME)..         
+000162b0: 2020 2023 2043 6c65 6172 2074 6865 2077     # Clear the w
+000162c0: 6562 2073 6f63 6b65 7420 6265 666f 7265  eb socket before
+000162d0: 2077 6520 7374 6172 740a 2020 2020 2020   we start.      
+000162e0: 2020 2020 2020 6177 6169 7420 636f 6c6c        await coll
+000162f0: 6563 745f 7765 6273 6f63 6b65 745f 6d65  ect_websocket_me
+00016300: 7373 6167 6573 2877 6562 736f 636b 6574  ssages(websocket
+00016310: 2c20 7469 6d65 6f75 743d 3229 0a0a 2020  , timeout=2)..  
+00016320: 2020 2020 2020 2020 2020 2320 6578 6563            # exec
+00016330: 7574 6520 696d 706f 7274 2063 656c 6c20  ute import cell 
+00016340: 746f 2070 7265 7020 666f 7220 6f74 6865  to prep for othe
+00016350: 7273 0a20 2020 2020 2020 2020 2020 2072  rs.            r
+00016360: 6573 706f 6e73 6520 3d20 6177 6169 7420  esponse = await 
+00016370: 636c 6965 6e74 2e67 6574 280a 2020 2020  client.get(.    
+00016380: 2020 2020 2020 2020 2020 2020 6622 2f6e              f"/n
+00016390: 6f74 6562 6f6f 6b73 2f7b 7575 6964 7d2f  otebooks/{uuid}/
+000163a0: 6365 6c6c 732f 7b69 6d70 6f72 745f 6365  cells/{import_ce
+000163b0: 6c6c 5f75 7569 647d 2f65 7865 6375 7465  ll_uuid}/execute
+000163c0: 222c 0a20 2020 2020 2020 2020 2020 2020  ",.             
+000163d0: 2020 2068 6561 6465 7273 3d73 7570 6572     headers=super
+000163e0: 7573 6572 5f74 6f6b 656e 5f68 6561 6465  user_token_heade
+000163f0: 7273 2c0a 2020 2020 2020 2020 2020 2020  rs,.            
+00016400: 290a 2020 2020 2020 2020 2020 2020 6173  ).            as
+00016410: 7365 7274 2072 6573 706f 6e73 652e 7374  sert response.st
+00016420: 6174 7573 5f63 6f64 6520 3d3d 2032 3030  atus_code == 200
+00016430: 0a0a 2020 2020 2020 2020 2020 2020 2320  ..            # 
+00016440: 5761 6974 2066 6f72 2074 6865 2069 6d70  Wait for the imp
+00016450: 6f72 7420 746f 2063 6f6d 706c 6574 6520  ort to complete 
+00016460: 6279 206c 6f6f 6b69 6e67 2066 6f72 0a20  by looking for. 
+00016470: 2020 2020 2020 2020 2020 2023 2065 7865             # exe
+00016480: 6375 7469 6f6e 5f73 7461 7465 203d 3d20  cution_state == 
+00016490: 2769 646c 6527 206f 6e20 7468 6520 2769  'idle' on the 'i
+000164a0: 6d70 6f72 7427 2063 656c 6c0a 2020 2020  mport' cell.    
+000164b0: 2020 2020 2020 2020 7472 793a 0a20 2020          try:.   
+000164c0: 2020 2020 2020 2020 2020 2020 2077 6869               whi
+000164d0: 6c65 2054 7275 653a 0a20 2020 2020 2020  le True:.       
+000164e0: 2020 2020 2020 2020 2020 2020 206d 7367               msg
+000164f0: 203d 2061 7761 6974 2072 6563 6569 7665   = await receive
+00016500: 5f6a 736f 6e28 7765 6273 6f63 6b65 742c  _json(websocket,
+00016510: 2074 696d 656f 7574 3d31 3529 0a20 2020   timeout=15).   
+00016520: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00016530: 2069 6620 2263 656c 6c5f 7570 6461 7465   if "cell_update
+00016540: 2220 696e 206d 7367 2e6b 6579 7328 293a  " in msg.keys():
+00016550: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00016560: 2020 2020 2020 2020 2064 315f 6d65 7461           d1_meta
+00016570: 203d 206d 7367 5b22 6365 6c6c 5f75 7064   = msg["cell_upd
+00016580: 6174 6522 5d5b 305d 5b22 6d65 7461 6461  ate"][0]["metada
+00016590: 7461 225d 5b0a 2020 2020 2020 2020 2020  ta"][.          
+000165a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000165b0: 2020 226a 7570 7974 6572 5f64 3122 0a20    "jupyter_d1". 
+000165c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000165d0: 2020 2020 2020 205d 0a20 2020 2020 2020         ].       
+000165e0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000165f0: 2069 6620 280a 2020 2020 2020 2020 2020   if (.          
+00016600: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00016610: 2020 6431 5f6d 6574 615b 2265 7865 6375    d1_meta["execu
+00016620: 7469 6f6e 5f73 7461 7465 225d 203d 3d20  tion_state"] == 
+00016630: 2269 646c 6522 0a20 2020 2020 2020 2020  "idle".         
+00016640: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00016650: 2020 2061 6e64 2064 315f 6d65 7461 5b22     and d1_meta["
+00016660: 7575 6964 225d 203d 3d20 696d 706f 7274  uuid"] == import
+00016670: 5f63 656c 6c5f 7575 6964 0a20 2020 2020  _cell_uuid.     
+00016680: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00016690: 2020 2029 3a0a 0a20 2020 2020 2020 2020     ):..         
+000166a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000166b0: 2020 2062 7265 616b 0a20 2020 2020 2020     break.       
+000166c0: 2020 2020 2065 7863 6570 7420 5469 6d65       except Time
+000166d0: 6f75 7445 7272 6f72 3a0a 2020 2020 2020  outError:.      
+000166e0: 2020 2020 2020 2020 2020 7061 7373 0a0a            pass..
+000166f0: 2020 2020 2020 2020 2020 2020 2320 436c              # Cl
+00016700: 6561 7220 7468 6520 7765 6220 736f 636b  ear the web sock
+00016710: 6574 2062 6566 6f72 6520 7765 2073 7461  et before we sta
+00016720: 7274 0a20 2020 2020 2020 2020 2020 2061  rt.            a
+00016730: 7761 6974 2063 6f6c 6c65 6374 5f77 6562  wait collect_web
+00016740: 736f 636b 6574 5f6d 6573 7361 6765 7328  socket_messages(
+00016750: 7765 6273 6f63 6b65 742c 2074 696d 656f  websocket, timeo
+00016760: 7574 3d32 290a 0a20 2020 2020 2020 2020  ut=2)..         
+00016770: 2020 2023 2065 7865 6375 7465 2074 696d     # execute tim
+00016780: 6520 6c6f 6f70 2063 656c 6c20 746f 0a20  e loop cell to. 
+00016790: 2020 2020 2020 2020 2020 2072 6573 706f             respo
+000167a0: 6e73 6520 3d20 6177 6169 7420 636c 6965  nse = await clie
+000167b0: 6e74 2e67 6574 280a 2020 2020 2020 2020  nt.get(.        
+000167c0: 2020 2020 2020 2020 6622 2f6e 6f74 6562          f"/noteb
+000167d0: 6f6f 6b73 2f7b 7575 6964 7d2f 6365 6c6c  ooks/{uuid}/cell
+000167e0: 732f 7b74 7164 6d5f 6365 6c6c 5f75 7569  s/{tqdm_cell_uui
+000167f0: 647d 2f65 7865 6375 7465 222c 0a20 2020  d}/execute",.   
+00016800: 2020 2020 2020 2020 2020 2020 2068 6561               hea
+00016810: 6465 7273 3d73 7570 6572 7573 6572 5f74  ders=superuser_t
+00016820: 6f6b 656e 5f68 6561 6465 7273 2c0a 2020  oken_headers,.  
+00016830: 2020 2020 2020 2020 2020 290a 2020 2020            ).    
+00016840: 2020 2020 2020 2020 6173 7365 7274 2072          assert r
+00016850: 6573 706f 6e73 652e 7374 6174 7573 5f63  esponse.status_c
+00016860: 6f64 6520 3d3d 2032 3030 0a0a 2020 2020  ode == 200..    
+00016870: 2020 2020 2020 2020 6d73 6773 203d 2061          msgs = a
+00016880: 7761 6974 2063 6f6c 6c65 6374 5f77 6562  wait collect_web
+00016890: 736f 636b 6574 5f6d 6573 7361 6765 7328  socket_messages(
+000168a0: 7765 6273 6f63 6b65 742c 2074 696d 656f  websocket, timeo
+000168b0: 7574 3d31 3029 0a20 2020 2020 2020 2020  ut=10).         
+000168c0: 2020 2063 656c 6c5f 7570 6461 7465 5f6d     cell_update_m
+000168d0: 7367 7320 3d20 6669 6c74 6572 5f77 6562  sgs = filter_web
+000168e0: 736f 636b 6574 5f63 6f6c 6c65 6374 696f  socket_collectio
+000168f0: 6e28 6d73 6773 2c20 2263 656c 6c5f 7570  n(msgs, "cell_up
+00016900: 6461 7465 2229 0a0a 2020 2020 2020 2020  date")..        
+00016910: 2020 2020 6461 7461 203d 2063 656c 6c5f      data = cell_
+00016920: 7570 6461 7465 5f6d 7367 732e 706f 7028  update_msgs.pop(
+00016930: 3029 0a20 2020 2020 2020 2020 2020 2061  0).            a
+00016940: 7373 6572 7420 280a 2020 2020 2020 2020  ssert (.        
+00016950: 2020 2020 2020 2020 6461 7461 5b22 6365          data["ce
+00016960: 6c6c 5f75 7064 6174 6522 5d5b 305d 5b22  ll_update"][0]["
+00016970: 6d65 7461 6461 7461 225d 5b22 6a75 7079  metadata"]["jupy
+00016980: 7465 725f 6431 225d 5b22 7575 6964 225d  ter_d1"]["uuid"]
+00016990: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+000169a0: 203d 3d20 7471 646d 5f63 656c 6c5f 7575   == tqdm_cell_uu
+000169b0: 6964 0a20 2020 2020 2020 2020 2020 2029  id.            )
+000169c0: 0a20 2020 2020 2020 2020 2020 2061 7373  .            ass
+000169d0: 6572 7420 6461 7461 5b22 6365 6c6c 5f75  ert data["cell_u
+000169e0: 7064 6174 6522 5d5b 305d 5b22 6578 6563  pdate"][0]["exec
+000169f0: 7574 696f 6e5f 636f 756e 7422 5d20 6973  ution_count"] is
+00016a00: 204e 6f6e 650a 2020 2020 2020 2020 2020   None.          
+00016a10: 2020 6173 7365 7274 2028 0a20 2020 2020    assert (.     
+00016a20: 2020 2020 2020 2020 2020 2064 6174 615b             data[
+00016a30: 2263 656c 6c5f 7570 6461 7465 225d 5b30  "cell_update"][0
+00016a40: 5d5b 226d 6574 6164 6174 6122 5d5b 226a  ]["metadata"]["j
+00016a50: 7570 7974 6572 5f64 3122 5d5b 0a20 2020  upyter_d1"][.   
+00016a60: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00016a70: 2022 6578 6563 7574 696f 6e5f 7374 6174   "execution_stat
+00016a80: 6522 0a20 2020 2020 2020 2020 2020 2020  e".             
+00016a90: 2020 205d 0a20 2020 2020 2020 2020 2020     ].           
+00016aa0: 2020 2020 203d 3d20 2262 7573 7922 0a20       == "busy". 
+00016ab0: 2020 2020 2020 2020 2020 2029 0a20 2020             ).   
+00016ac0: 2020 2020 2020 2020 2061 7373 6572 7420           assert 
+00016ad0: 6461 7461 5b22 6365 6c6c 5f75 7064 6174  data["cell_updat
+00016ae0: 6522 5d5b 305d 5b22 6f75 7470 7574 7322  e"][0]["outputs"
+00016af0: 5d20 3d3d 205b 5d0a 0a20 2020 2020 2020  ] == []..       
+00016b00: 2020 2020 2023 2055 7064 6174 6573 2066       # Updates f
+00016b10: 6f72 2065 6163 6820 6f66 2074 6865 2034  or each of the 4
+00016b20: 2063 6875 6e6b 732c 2065 7665 7279 2032   chunks, every 2
+00016b30: 3525 0a20 2020 2020 2020 2020 2020 2066  5%.            f
+00016b40: 6f72 2069 6478 2069 6e20 5b22 2020 3022  or idx in ["  0"
+00016b50: 2c20 2220 3235 222c 2022 2035 3022 2c20  , " 25", " 50", 
+00016b60: 2220 3735 222c 2022 3130 3022 5d3a 0a20  " 75", "100"]:. 
+00016b70: 2020 2020 2020 2020 2020 2020 2020 2064                 d
+00016b80: 6174 6120 3d20 6365 6c6c 5f75 7064 6174  ata = cell_updat
+00016b90: 655f 6d73 6773 2e70 6f70 2830 290a 2020  e_msgs.pop(0).  
+00016ba0: 2020 2020 2020 2020 2020 2020 2020 6173                as
+00016bb0: 7365 7274 2028 0a20 2020 2020 2020 2020  sert (.         
+00016bc0: 2020 2020 2020 2020 2020 2064 6174 615b             data[
+00016bd0: 2263 656c 6c5f 7570 6461 7465 225d 5b30  "cell_update"][0
+00016be0: 5d5b 226d 6574 6164 6174 6122 5d5b 226a  ]["metadata"]["j
+00016bf0: 7570 7974 6572 5f64 3122 5d5b 2275 7569  upyter_d1"]["uui
+00016c00: 6422 5d0a 2020 2020 2020 2020 2020 2020  d"].            
+00016c10: 2020 2020 2020 2020 3d3d 2074 7164 6d5f          == tqdm_
+00016c20: 6365 6c6c 5f75 7569 640a 2020 2020 2020  cell_uuid.      
+00016c30: 2020 2020 2020 2020 2020 290a 2020 2020            ).    
+00016c40: 2020 2020 2020 2020 2020 2020 6173 7365              asse
+00016c50: 7274 2064 6174 615b 2263 656c 6c5f 7570  rt data["cell_up
+00016c60: 6461 7465 225d 5b30 5d5b 2265 7865 6375  date"][0]["execu
+00016c70: 7469 6f6e 5f63 6f75 6e74 225d 2069 7320  tion_count"] is 
+00016c80: 4e6f 6e65 0a20 2020 2020 2020 2020 2020  None.           
+00016c90: 2020 2020 2061 7373 6572 7420 280a 2020       assert (.  
+00016ca0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00016cb0: 2020 6461 7461 5b22 6365 6c6c 5f75 7064    data["cell_upd
+00016cc0: 6174 6522 5d5b 305d 5b22 6d65 7461 6461  ate"][0]["metada
+00016cd0: 7461 225d 5b22 6a75 7079 7465 725f 6431  ta"]["jupyter_d1
+00016ce0: 225d 5b0a 2020 2020 2020 2020 2020 2020  "][.            
+00016cf0: 2020 2020 2020 2020 2020 2020 2265 7865              "exe
+00016d00: 6375 7469 6f6e 5f73 7461 7465 220a 2020  cution_state".  
+00016d10: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00016d20: 2020 5d0a 2020 2020 2020 2020 2020 2020    ].            
+00016d30: 2020 2020 2020 2020 3d3d 2022 6275 7379          == "busy
+00016d40: 220a 2020 2020 2020 2020 2020 2020 2020  ".              
+00016d50: 2020 290a 2020 2020 2020 2020 2020 2020    ).            
+00016d60: 2020 2020 6173 7365 7274 2064 6174 615b      assert data[
+00016d70: 2263 656c 6c5f 7570 6461 7465 225d 5b30  "cell_update"][0
+00016d80: 5d5b 226f 7574 7075 7473 225d 5b30 5d5b  ]["outputs"][0][
+00016d90: 226e 616d 6522 5d20 3d3d 2022 7374 6465  "name"] == "stde
+00016da0: 7272 220a 2020 2020 2020 2020 2020 2020  rr".            
+00016db0: 2020 2020 6173 7365 7274 2028 0a20 2020      assert (.   
+00016dc0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00016dd0: 2064 6174 615b 2263 656c 6c5f 7570 6461   data["cell_upda
+00016de0: 7465 225d 5b30 5d5b 226f 7574 7075 7473  te"][0]["outputs
+00016df0: 225d 5b30 5d5b 226f 7574 7075 745f 7479  "][0]["output_ty
+00016e00: 7065 225d 0a20 2020 2020 2020 2020 2020  pe"].           
+00016e10: 2020 2020 2020 2020 203d 3d20 2273 7472           == "str
+00016e20: 6561 6d22 0a20 2020 2020 2020 2020 2020  eam".           
+00016e30: 2020 2020 2029 0a20 2020 2020 2020 2020       ).         
+00016e40: 2020 2020 2020 2023 2074 6578 7420 3d20         # text = 
+00016e50: 6461 7461 5b27 6365 6c6c 5f75 7064 6174  data['cell_updat
+00016e60: 6527 5d5b 305d 5b27 6f75 7470 7574 7327  e'][0]['outputs'
+00016e70: 5d5b 305d 5b27 7465 7874 275d 5b30 5d0a  ][0]['text'][0].
+00016e80: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00016e90: 2320 7072 696e 7428 223e 3e3e 2074 6578  # print(">>> tex
+00016ea0: 743a 222c 2074 6578 7429 0a20 2020 2020  t:", text).     
+00016eb0: 2020 2020 2020 2020 2020 2023 2070 7269             # pri
+00016ec0: 6e74 2822 3e3e 3e20 7479 7065 2874 6578  nt(">>> type(tex
+00016ed0: 7429 3a22 2c20 7479 7065 2874 6578 7429  t):", type(text)
+00016ee0: 290a 2020 2020 2020 2020 2020 2020 2020  ).              
+00016ef0: 2020 6173 7365 7274 2064 6174 615b 2263    assert data["c
+00016f00: 656c 6c5f 7570 6461 7465 225d 5b30 5d5b  ell_update"][0][
+00016f10: 226f 7574 7075 7473 225d 5b30 5d5b 2274  "outputs"][0]["t
+00016f20: 6578 7422 5d5b 0a20 2020 2020 2020 2020  ext"][.         
+00016f30: 2020 2020 2020 2020 2020 2030 0a20 2020             0.   
+00016f40: 2020 2020 2020 2020 2020 2020 205d 2e73               ].s
+00016f50: 7461 7274 7377 6974 6828 6622 7b69 6478  tartswith(f"{idx
+00016f60: 7d25 7c22 290a 2020 2020 2020 2020 2020  }%|").          
+00016f70: 2020 2020 2020 6173 7365 7274 2064 6174        assert dat
+00016f80: 615b 2263 656c 6c5f 7570 6461 7465 225d  a["cell_update"]
+00016f90: 5b30 5d5b 226f 7574 7075 7473 225d 5b30  [0]["outputs"][0
+00016fa0: 5d5b 2274 6578 7422 5d5b 0a20 2020 2020  ]["text"][.     
+00016fb0: 2020 2020 2020 2020 2020 2020 2020 2030                 0
+00016fc0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00016fd0: 205d 2e65 6e64 7377 6974 6828 2269 742f   ].endswith("it/
+00016fe0: 735d 2229 0a20 2020 2020 2020 2020 2020  s]").           
+00016ff0: 2020 2020 2061 7373 6572 7420 280a 2020       assert (.  
+00017000: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00017010: 2020 6c65 6e28 6461 7461 5b22 6365 6c6c    len(data["cell
+00017020: 5f75 7064 6174 6522 5d5b 305d 5b22 6f75  _update"][0]["ou
+00017030: 7470 7574 7322 5d5b 305d 5b22 7465 7874  tputs"][0]["text
+00017040: 225d 5b30 5d29 203d 3d20 3130 300a 2020  "][0]) == 100.  
+00017050: 2020 2020 2020 2020 2020 2020 2020 290a                ).
+00017060: 0a20 2020 2020 2020 2020 2020 2023 2054  .            # T
+00017070: 6865 6e20 7765 2067 6574 2074 6869 7320  hen we get this 
+00017080: 7477 6963 652e 20c2 af5c 5f28 e383 8429  twice. ..\_(...)
+00017090: 5f2f c2af 2020 4d75 7374 2062 6520 7471  _/..  Must be tq
+000170a0: 646d 2063 6c65 616e 696e 6720 7570 2e0a  dm cleaning up..
+000170b0: 2020 2020 2020 2020 2020 2020 666f 7220              for 
+000170c0: 6475 6d6d 7920 696e 2072 616e 6765 2832  dummy in range(2
+000170d0: 293a 0a20 2020 2020 2020 2020 2020 2020  ):.             
+000170e0: 2020 2064 6174 6120 3d20 6365 6c6c 5f75     data = cell_u
+000170f0: 7064 6174 655f 6d73 6773 2e70 6f70 2830  pdate_msgs.pop(0
+00017100: 290a 2020 2020 2020 2020 2020 2020 2020  ).              
+00017110: 2020 6173 7365 7274 2028 0a20 2020 2020    assert (.     
+00017120: 2020 2020 2020 2020 2020 2020 2020 2064                 d
+00017130: 6174 615b 2263 656c 6c5f 7570 6461 7465  ata["cell_update
+00017140: 225d 5b30 5d5b 226d 6574 6164 6174 6122  "][0]["metadata"
+00017150: 5d5b 226a 7570 7974 6572 5f64 3122 5d5b  ]["jupyter_d1"][
+00017160: 2275 7569 6422 5d0a 2020 2020 2020 2020  "uuid"].        
+00017170: 2020 2020 2020 2020 2020 2020 3d3d 2074              == t
+00017180: 7164 6d5f 6365 6c6c 5f75 7569 640a 2020  qdm_cell_uuid.  
+00017190: 2020 2020 2020 2020 2020 2020 2020 290a                ).
+000171a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000171b0: 6173 7365 7274 2064 6174 615b 2263 656c  assert data["cel
+000171c0: 6c5f 7570 6461 7465 225d 5b30 5d5b 2265  l_update"][0]["e
+000171d0: 7865 6375 7469 6f6e 5f63 6f75 6e74 225d  xecution_count"]
+000171e0: 2069 7320 4e6f 6e65 0a20 2020 2020 2020   is None.       
+000171f0: 2020 2020 2020 2020 2061 7373 6572 7420           assert 
+00017200: 280a 2020 2020 2020 2020 2020 2020 2020  (.              
+00017210: 2020 2020 2020 6461 7461 5b22 6365 6c6c        data["cell
+00017220: 5f75 7064 6174 6522 5d5b 305d 5b22 6d65  _update"][0]["me
+00017230: 7461 6461 7461 225d 5b22 6a75 7079 7465  tadata"]["jupyte
+00017240: 725f 6431 225d 5b0a 2020 2020 2020 2020  r_d1"][.        
+00017250: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00017260: 2265 7865 6375 7469 6f6e 5f73 7461 7465  "execution_state
+00017270: 220a 2020 2020 2020 2020 2020 2020 2020  ".              
+00017280: 2020 2020 2020 5d0a 2020 2020 2020 2020        ].        
+00017290: 2020 2020 2020 2020 2020 2020 3d3d 2022              == "
+000172a0: 6275 7379 220a 2020 2020 2020 2020 2020  busy".          
+000172b0: 2020 2020 2020 290a 2020 2020 2020 2020        ).        
+000172c0: 2020 2020 2020 2020 6173 7365 7274 2064          assert d
+000172d0: 6174 615b 2263 656c 6c5f 7570 6461 7465  ata["cell_update
+000172e0: 225d 5b30 5d5b 226f 7574 7075 7473 225d  "][0]["outputs"]
+000172f0: 5b30 5d5b 226e 616d 6522 5d20 3d3d 2022  [0]["name"] == "
+00017300: 7374 6465 7272 220a 2020 2020 2020 2020  stderr".        
+00017310: 2020 2020 2020 2020 6173 7365 7274 2028          assert (
+00017320: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00017330: 2020 2020 2064 6174 615b 2263 656c 6c5f       data["cell_
+00017340: 7570 6461 7465 225d 5b30 5d5b 226f 7574  update"][0]["out
+00017350: 7075 7473 225d 5b30 5d5b 226f 7574 7075  puts"][0]["outpu
+00017360: 745f 7479 7065 225d 0a20 2020 2020 2020  t_type"].       
+00017370: 2020 2020 2020 2020 2020 2020 203d 3d20               == 
+00017380: 2273 7472 6561 6d22 0a20 2020 2020 2020  "stream".       
+00017390: 2020 2020 2020 2020 2029 0a20 2020 2020           ).     
+000173a0: 2020 2020 2020 2020 2020 2061 7373 6572             asser
+000173b0: 7420 6461 7461 5b22 6365 6c6c 5f75 7064  t data["cell_upd
+000173c0: 6174 6522 5d5b 305d 5b22 6f75 7470 7574  ate"][0]["output
+000173d0: 7322 5d5b 305d 5b22 7465 7874 225d 5b0a  s"][0]["text"][.
+000173e0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000173f0: 2020 2020 300a 2020 2020 2020 2020 2020      0.          
+00017400: 2020 2020 2020 5d2e 7374 6172 7473 7769        ].startswi
+00017410: 7468 2866 2231 3030 257c 2229 0a20 2020  th(f"100%|").   
+00017420: 2020 2020 2020 2020 2020 2020 2061 7373               ass
+00017430: 6572 7420 6461 7461 5b22 6365 6c6c 5f75  ert data["cell_u
+00017440: 7064 6174 6522 5d5b 305d 5b22 6f75 7470  pdate"][0]["outp
+00017450: 7574 7322 5d5b 305d 5b22 7465 7874 225d  uts"][0]["text"]
+00017460: 5b0a 2020 2020 2020 2020 2020 2020 2020  [.              
+00017470: 2020 2020 2020 300a 2020 2020 2020 2020        0.        
+00017480: 2020 2020 2020 2020 5d2e 656e 6473 7769          ].endswi
+00017490: 7468 2822 6974 2f73 5d22 290a 2020 2020  th("it/s]").    
+000174a0: 2020 2020 2020 2020 2020 2020 6173 7365              asse
+000174b0: 7274 2028 0a20 2020 2020 2020 2020 2020  rt (.           
+000174c0: 2020 2020 2020 2020 206c 656e 2864 6174           len(dat
+000174d0: 615b 2263 656c 6c5f 7570 6461 7465 225d  a["cell_update"]
+000174e0: 5b30 5d5b 226f 7574 7075 7473 225d 5b30  [0]["outputs"][0
+000174f0: 5d5b 2274 6578 7422 5d5b 305d 2920 3d3d  ]["text"][0]) ==
+00017500: 2031 3030 0a20 2020 2020 2020 2020 2020   100.           
+00017510: 2020 2020 2029 0a0a 2020 2020 2020 2020       )..        
+00017520: 2020 2020 2320 4669 6e61 6c6c 7920 6765      # Finally ge
+00017530: 7420 6578 6563 7574 696f 6e5f 7374 6174  t execution_stat
+00017540: 6520 3d3d 2027 6964 6c65 270a 2020 2020  e == 'idle'.    
+00017550: 2020 2020 2020 2020 6461 7461 203d 2063          data = c
+00017560: 656c 6c5f 7570 6461 7465 5f6d 7367 732e  ell_update_msgs.
+00017570: 706f 7028 3029 0a20 2020 2020 2020 2020  pop(0).         
+00017580: 2020 2061 7373 6572 7420 280a 2020 2020     assert (.    
+00017590: 2020 2020 2020 2020 2020 2020 6461 7461              data
+000175a0: 5b22 6365 6c6c 5f75 7064 6174 6522 5d5b  ["cell_update"][
+000175b0: 305d 5b22 6d65 7461 6461 7461 225d 5b22  0]["metadata"]["
+000175c0: 6a75 7079 7465 725f 6431 225d 5b22 7575  jupyter_d1"]["uu
+000175d0: 6964 225d 0a20 2020 2020 2020 2020 2020  id"].           
+000175e0: 2020 2020 203d 3d20 7471 646d 5f63 656c       == tqdm_cel
+000175f0: 6c5f 7575 6964 0a20 2020 2020 2020 2020  l_uuid.         
+00017600: 2020 2029 0a20 2020 2020 2020 2020 2020     ).           
+00017610: 2061 7373 6572 7420 6461 7461 5b22 6365   assert data["ce
+00017620: 6c6c 5f75 7064 6174 6522 5d5b 305d 5b22  ll_update"][0]["
+00017630: 6578 6563 7574 696f 6e5f 636f 756e 7422  execution_count"
+00017640: 5d20 3d3d 2032 0a20 2020 2020 2020 2020  ] == 2.         
+00017650: 2020 2061 7373 6572 7420 280a 2020 2020     assert (.    
+00017660: 2020 2020 2020 2020 2020 2020 6461 7461              data
+00017670: 5b22 6365 6c6c 5f75 7064 6174 6522 5d5b  ["cell_update"][
+00017680: 305d 5b22 6d65 7461 6461 7461 225d 5b22  0]["metadata"]["
+00017690: 6a75 7079 7465 725f 6431 225d 5b0a 2020  jupyter_d1"][.  
+000176a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000176b0: 2020 2265 7865 6375 7469 6f6e 5f73 7461    "execution_sta
+000176c0: 7465 220a 2020 2020 2020 2020 2020 2020  te".            
+000176d0: 2020 2020 5d0a 2020 2020 2020 2020 2020      ].          
+000176e0: 2020 2020 2020 3d3d 2022 6964 6c65 220a        == "idle".
+000176f0: 2020 2020 2020 2020 2020 2020 290a 2020              ).  
+00017700: 2020 2020 2020 2020 2020 6173 7365 7274            assert
+00017710: 2064 6174 615b 2263 656c 6c5f 7570 6461   data["cell_upda
+00017720: 7465 225d 5b30 5d5b 226f 7574 7075 7473  te"][0]["outputs
+00017730: 225d 5b30 5d5b 226e 616d 6522 5d20 3d3d  "][0]["name"] ==
+00017740: 2022 7374 6465 7272 220a 2020 2020 2020   "stderr".      
+00017750: 2020 2020 2020 6173 7365 7274 2028 0a20        assert (. 
+00017760: 2020 2020 2020 2020 2020 2020 2020 2064                 d
+00017770: 6174 615b 2263 656c 6c5f 7570 6461 7465  ata["cell_update
+00017780: 225d 5b30 5d5b 226f 7574 7075 7473 225d  "][0]["outputs"]
+00017790: 5b30 5d5b 226f 7574 7075 745f 7479 7065  [0]["output_type
+000177a0: 225d 203d 3d20 2273 7472 6561 6d22 0a20  "] == "stream". 
+000177b0: 2020 2020 2020 2020 2020 2029 0a20 2020             ).   
+000177c0: 2020 2020 2020 2020 2061 7373 6572 7420           assert 
+000177d0: 6461 7461 5b22 6365 6c6c 5f75 7064 6174  data["cell_updat
+000177e0: 6522 5d5b 305d 5b22 6f75 7470 7574 7322  e"][0]["outputs"
+000177f0: 5d5b 305d 5b22 7465 7874 225d 5b30 5d2e  ][0]["text"][0].
+00017800: 7374 6172 7473 7769 7468 280a 2020 2020  startswith(.    
+00017810: 2020 2020 2020 2020 2020 2020 6622 3130              f"10
+00017820: 3025 7c22 0a20 2020 2020 2020 2020 2020  0%|".           
+00017830: 2029 0a20 2020 2020 2020 2020 2020 2061   ).            a
+00017840: 7373 6572 7420 6461 7461 5b22 6365 6c6c  ssert data["cell
+00017850: 5f75 7064 6174 6522 5d5b 305d 5b22 6f75  _update"][0]["ou
+00017860: 7470 7574 7322 5d5b 305d 5b22 7465 7874  tputs"][0]["text
+00017870: 225d 5b30 5d2e 656e 6473 7769 7468 280a  "][0].endswith(.
+00017880: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00017890: 2269 742f 735d 220a 2020 2020 2020 2020  "it/s]".        
+000178a0: 2020 2020 290a 2020 2020 2020 2020 2020      ).          
+000178b0: 2020 6173 7365 7274 206c 656e 2864 6174    assert len(dat
+000178c0: 615b 2263 656c 6c5f 7570 6461 7465 225d  a["cell_update"]
+000178d0: 5b30 5d5b 226f 7574 7075 7473 225d 5b30  [0]["outputs"][0
+000178e0: 5d5b 2274 6578 7422 5d5b 305d 2920 3d3d  ]["text"][0]) ==
+000178f0: 2031 3030 0a0a 0a40 7079 7465 7374 2e6d   100...@pytest.m
+00017900: 6172 6b2e 7573 6566 6978 7475 7265 7328  ark.usefixtures(
+00017910: 2263 6c65 6172 5f6e 6f74 6562 6f6f 6b73  "clear_notebooks
+00017920: 222c 2022 636c 6561 725f 6e6f 7465 626f  ", "clear_notebo
+00017930: 6f6b 5f64 6972 6563 746f 7279 2229 0a63  ok_directory").c
+00017940: 6c61 7373 2054 6573 744b 6572 6e65 6c56  lass TestKernelV
+00017950: 6172 734d 616e 6167 6572 3a0a 2020 2020  arsManager:.    
+00017960: 4070 7974 6573 742e 6d61 726b 2e61 7379  @pytest.mark.asy
+00017970: 6e63 696f 0a20 2020 2061 7379 6e63 2064  ncio.    async d
+00017980: 6566 2074 6573 745f 6765 745f 7369 6e67  ef test_get_sing
+00017990: 6c65 5f76 6172 5f64 6574 6169 6c28 0a20  le_var_detail(. 
+000179a0: 2020 2020 2020 2073 656c 662c 2063 6c69         self, cli
+000179b0: 656e 743a 2054 6573 7443 6c69 656e 742c  ent: TestClient,
+000179c0: 2073 7570 6572 7573 6572 5f74 6f6b 656e   superuser_token
+000179d0: 5f68 6561 6465 7273 3a20 4469 6374 5b73  _headers: Dict[s
+000179e0: 7472 2c20 7374 725d 0a20 2020 2029 3a0a  tr, str].    ):.
+000179f0: 2020 2020 2020 2020 2222 220a 2020 2020          """.    
+00017a00: 2020 2020 4c61 7267 6520 6461 7461 6672      Large datafr
+00017a10: 616d 6520 6973 2061 6262 7265 7669 6174  ame is abbreviat
+00017a20: 6564 2069 6e20 7375 6d6d 6172 792c 206e  ed in summary, n
+00017a30: 6f74 2069 6e20 7661 7269 6162 6c65 0a20  ot in variable. 
+00017a40: 2020 2020 2020 2064 6574 6169 6c73 2072         details r
+00017a50: 6571 7565 7374 2e0a 2020 2020 2020 2020  equest..        
+00017a60: 2222 220a 2020 2020 2020 2020 7575 6964  """.        uuid
+00017a70: 203d 2061 7761 6974 2075 706c 6f61 645f   = await upload_
+00017a80: 6e6f 7465 626f 6f6b 280a 2020 2020 2020  notebook(.      
+00017a90: 2020 2020 2020 636c 6965 6e74 2c20 7375        client, su
+00017aa0: 7065 7275 7365 725f 746f 6b65 6e5f 6865  peruser_token_he
+00017ab0: 6164 6572 732c 2022 7369 6d70 6c65 2e69  aders, "simple.i
+00017ac0: 7079 6e62 220a 2020 2020 2020 2020 290a  pynb".        ).
+00017ad0: 0a20 2020 2020 2020 2023 2067 6574 2061  .        # get a
+00017ae0: 6e20 6578 6973 7469 6e67 2063 656c 6c0a  n existing cell.
+00017af0: 2020 2020 2020 2020 7265 7370 6f6e 7365          response
+00017b00: 203d 2061 7761 6974 2063 6c69 656e 742e   = await client.
+00017b10: 6765 7428 0a20 2020 2020 2020 2020 2020  get(.           
+00017b20: 2066 222f 6e6f 7465 626f 6f6b 732f 7b75   f"/notebooks/{u
+00017b30: 7569 647d 2f63 656c 6c73 222c 2068 6561  uid}/cells", hea
+00017b40: 6465 7273 3d73 7570 6572 7573 6572 5f74  ders=superuser_t
+00017b50: 6f6b 656e 5f68 6561 6465 7273 0a20 2020  oken_headers.   
+00017b60: 2020 2020 2029 0a20 2020 2020 2020 2061       ).        a
+00017b70: 7373 6572 7420 7265 7370 6f6e 7365 2e73  ssert response.s
+00017b80: 7461 7475 735f 636f 6465 203d 3d20 3230  tatus_code == 20
+00017b90: 300a 2020 2020 2020 2020 6365 6c6c 7320  0.        cells 
+00017ba0: 3d20 7265 7370 6f6e 7365 2e6a 736f 6e28  = response.json(
+00017bb0: 295b 2263 656c 6c73 225d 0a20 2020 2020  )["cells"].     
+00017bc0: 2020 2061 7373 6572 7420 6365 6c6c 735b     assert cells[
+00017bd0: 315d 5b22 736f 7572 6365 225d 203d 3d20  1]["source"] == 
+00017be0: 2770 7269 6e74 2822 4c61 7272 7920 7468  'print("Larry th
+00017bf0: 6520 4c6c 616d 6122 2927 0a0a 2020 2020  e Llama")'..    
+00017c00: 2020 2020 6365 6c6c 5f75 7569 6420 3d20      cell_uuid = 
+00017c10: 6365 6c6c 735b 315d 5b22 6d65 7461 6461  cells[1]["metada
+00017c20: 7461 225d 5b22 6a75 7079 7465 725f 6431  ta"]["jupyter_d1
+00017c30: 225d 5b22 7575 6964 225d 0a0a 2020 2020  "]["uuid"]..    
+00017c40: 2020 2020 7061 7261 6d73 203d 207b 0a20      params = {. 
+00017c50: 2020 2020 2020 2020 2020 2022 736f 7572             "sour
+00017c60: 6365 223a 2022 696d 706f 7274 2070 616e  ce": "import pan
+00017c70: 6461 7320 6173 2070 645c 6e64 6633 203d  das as pd\ndf3 =
+00017c80: 2022 0a20 2020 2020 2020 2020 2020 2022   ".            "
+00017c90: 7064 2e44 6174 6146 7261 6d65 285b 7b73  pd.DataFrame([{s
+00017ca0: 7472 2869 293a 2069 202b 206a 2066 6f72  tr(i): i + j for
+00017cb0: 2069 2069 6e20 7261 6e67 6528 3529 7d20   i in range(5)} 
+00017cc0: 666f 7220 6a20 696e 2022 0a20 2020 2020  for j in ".     
+00017cd0: 2020 2020 2020 2022 7261 6e67 6528 3135         "range(15
+00017ce0: 3029 5d29 220a 2020 2020 2020 2020 7d0a  0)])".        }.
+00017cf0: 2020 2020 2020 2020 7265 7370 6f6e 7365          response
+00017d00: 203d 2061 7761 6974 2063 6c69 656e 742e   = await client.
+00017d10: 7061 7463 6828 0a20 2020 2020 2020 2020  patch(.         
+00017d20: 2020 2066 222f 6e6f 7465 626f 6f6b 732f     f"/notebooks/
+00017d30: 7b75 7569 647d 2f63 656c 6c73 2f7b 6365  {uuid}/cells/{ce
+00017d40: 6c6c 5f75 7569 647d 222c 0a20 2020 2020  ll_uuid}",.     
+00017d50: 2020 2020 2020 206a 736f 6e3d 7061 7261         json=para
+00017d60: 6d73 2c0a 2020 2020 2020 2020 2020 2020  ms,.            
+00017d70: 6865 6164 6572 733d 7375 7065 7275 7365  headers=superuse
+00017d80: 725f 746f 6b65 6e5f 6865 6164 6572 732c  r_token_headers,
+00017d90: 0a20 2020 2020 2020 2029 0a20 2020 2020  .        ).     
+00017da0: 2020 2061 7373 6572 7420 7265 7370 6f6e     assert respon
+00017db0: 7365 2e73 7461 7475 735f 636f 6465 203d  se.status_code =
+00017dc0: 3d20 3230 300a 0a20 2020 2020 2020 2072  = 200..        r
+00017dd0: 6573 706f 6e73 6520 3d20 6177 6169 7420  esponse = await 
+00017de0: 636c 6965 6e74 2e67 6574 280a 2020 2020  client.get(.    
+00017df0: 2020 2020 2020 2020 6622 2f6e 6f74 6562          f"/noteb
+00017e00: 6f6f 6b73 2f7b 7575 6964 7d2f 7661 7273  ooks/{uuid}/vars
+00017e10: 222c 2068 6561 6465 7273 3d73 7570 6572  ", headers=super
+00017e20: 7573 6572 5f74 6f6b 656e 5f68 6561 6465  user_token_heade
+00017e30: 7273 0a20 2020 2020 2020 2029 0a20 2020  rs.        ).   
+00017e40: 2020 2020 2061 7373 6572 7420 7265 7370       assert resp
+00017e50: 6f6e 7365 2e73 7461 7475 735f 636f 6465  onse.status_code
+00017e60: 203d 3d20 3230 300a 2020 2020 2020 2020   == 200.        
+00017e70: 6173 7365 7274 206c 656e 2872 6573 706f  assert len(respo
+00017e80: 6e73 652e 6a73 6f6e 2829 5b22 7661 7273  nse.json()["vars
+00017e90: 225d 2920 3d3d 2030 0a0a 2020 2020 2020  "]) == 0..      
+00017ea0: 2020 6173 796e 6320 7769 7468 2063 6c69    async with cli
+00017eb0: 656e 742e 7765 6273 6f63 6b65 745f 636f  ent.websocket_co
+00017ec0: 6e6e 6563 7428 0a20 2020 2020 2020 2020  nnect(.         
+00017ed0: 2020 2066 222f 6e6f 7465 626f 6f6b 732f     f"/notebooks/
+00017ee0: 7b75 7569 647d 2f77 732f 6e6f 7465 626f  {uuid}/ws/notebo
+00017ef0: 6f6b 222c 2068 6561 6465 7273 3d73 7570  ok", headers=sup
+00017f00: 6572 7573 6572 5f74 6f6b 656e 5f68 6561  eruser_token_hea
+00017f10: 6465 7273 0a20 2020 2020 2020 2029 2061  ders.        ) a
+00017f20: 7320 7765 6273 6f63 6b65 743a 0a20 2020  s websocket:.   
+00017f30: 2020 2020 2020 2020 2061 7761 6974 2061           await a
+00017f40: 7379 6e63 696f 2e73 6c65 6570 2857 4542  syncio.sleep(WEB
+00017f50: 534f 434b 4554 5f53 4c45 4550 5f54 494d  SOCKET_SLEEP_TIM
+00017f60: 4529 0a0a 2020 2020 2020 2020 2020 2020  E)..            
+00017f70: 7265 7370 6f6e 7365 203d 2061 7761 6974  response = await
+00017f80: 2063 6c69 656e 742e 6765 7428 0a20 2020   client.get(.   
+00017f90: 2020 2020 2020 2020 2020 2020 2066 222f               f"/
+00017fa0: 6e6f 7465 626f 6f6b 732f 7b75 7569 647d  notebooks/{uuid}
+00017fb0: 2f63 656c 6c73 2f7b 6365 6c6c 5f75 7569  /cells/{cell_uui
+00017fc0: 647d 2f65 7865 6375 7465 222c 0a20 2020  d}/execute",.   
+00017fd0: 2020 2020 2020 2020 2020 2020 2068 6561               hea
+00017fe0: 6465 7273 3d73 7570 6572 7573 6572 5f74  ders=superuser_t
+00017ff0: 6f6b 656e 5f68 6561 6465 7273 2c0a 2020  oken_headers,.  
+00018000: 2020 2020 2020 2020 2020 290a 2020 2020            ).    
+00018010: 2020 2020 2020 2020 6173 7365 7274 2072          assert r
+00018020: 6573 706f 6e73 652e 7374 6174 7573 5f63  esponse.status_c
+00018030: 6f64 6520 3d3d 2032 3030 0a0a 2020 2020  ode == 200..    
+00018040: 2020 2020 2020 2020 2320 4b65 726e 656c          # Kernel
+00018050: 2076 6172 7320 7570 6461 7465 0a20 2020   vars update.   
+00018060: 2020 2020 2020 2020 2064 6174 6120 3d20           data = 
+00018070: 6177 6169 7420 7265 6365 6976 655f 6a73  await receive_js
+00018080: 6f6e 2877 6562 736f 636b 6574 2c20 6d73  on(websocket, ms
+00018090: 675f 7479 7065 733d 5b22 7661 7273 225d  g_types=["vars"]
+000180a0: 290a 2020 2020 2020 2020 2020 2020 7661  ).            va
+000180b0: 7273 203d 207b 0a20 2020 2020 2020 2020  rs = {.         
+000180c0: 2020 2020 2020 2076 6172 5b22 6e61 6d65         var["name
+000180d0: 225d 3a20 7b0a 2020 2020 2020 2020 2020  "]: {.          
+000180e0: 2020 2020 2020 2020 2020 2274 7970 6522            "type"
+000180f0: 3a20 7661 725b 2274 7970 6522 5d2c 0a20  : var["type"],. 
+00018100: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00018110: 2020 2022 7661 6c75 6522 3a20 7661 725b     "value": var[
+00018120: 2276 616c 7565 225d 2c0a 2020 2020 2020  "value"],.      
+00018130: 2020 2020 2020 2020 2020 2020 2020 2273                "s
+00018140: 756d 6d61 7279 223a 2076 6172 5b22 7375  ummary": var["su
+00018150: 6d6d 6172 7922 5d2c 0a20 2020 2020 2020  mmary"],.       
+00018160: 2020 2020 2020 2020 2020 2020 2022 6162               "ab
+00018170: 6272 6576 6961 7465 6422 3a20 7661 725b  breviated": var[
+00018180: 2261 6262 7265 7669 6174 6564 225d 2c0a  "abbreviated"],.
+00018190: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000181a0: 2020 2020 2268 6173 5f6e 6578 745f 7061      "has_next_pa
+000181b0: 6765 223a 2076 6172 5b22 6861 735f 6e65  ge": var["has_ne
+000181c0: 7874 5f70 6167 6522 5d2c 0a20 2020 2020  xt_page"],.     
+000181d0: 2020 2020 2020 2020 2020 207d 0a20 2020             }.   
+000181e0: 2020 2020 2020 2020 2020 2020 2066 6f72               for
+000181f0: 2076 6172 2069 6e20 6461 7461 5b22 7661   var in data["va
+00018200: 7273 225d 0a20 2020 2020 2020 2020 2020  rs"].           
+00018210: 207d 0a0a 2020 2020 2020 2020 2020 2020   }..            
+00018220: 6173 7365 7274 2076 6172 735b 2264 6633  assert vars["df3
+00018230: 225d 5b22 7479 7065 225d 203d 3d20 2244  "]["type"] == "D
+00018240: 6174 6146 7261 6d65 220a 2020 2020 2020  ataFrame".      
+00018250: 2020 2020 2020 6173 7365 7274 2076 6172        assert var
+00018260: 735b 2264 6633 225d 5b22 7661 6c75 6522  s["df3"]["value"
+00018270: 5d20 3d3d 207b 0a20 2020 2020 2020 2020  ] == {.         
+00018280: 2020 2020 2020 2022 6d75 6c74 695f 7661         "multi_va
+00018290: 6c75 6522 3a20 7b0a 2020 2020 2020 2020  lue": {.        
+000182a0: 2020 2020 2020 2020 2020 2020 2272 6f77              "row
+000182b0: 5f63 6f75 6e74 223a 2031 3530 2c0a 2020  _count": 150,.  
+000182c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000182d0: 2020 2263 6f6c 756d 6e5f 636f 756e 7422    "column_count"
+000182e0: 3a20 352c 0a20 2020 2020 2020 2020 2020  : 5,.           
+000182f0: 2020 2020 2020 2020 2022 636f 6c75 6d6e           "column
+00018300: 5f6e 616d 6573 223a 204e 6f6e 652c 0a20  _names": None,. 
+00018310: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00018320: 2020 2022 6461 7461 223a 204e 6f6e 652c     "data": None,
+00018330: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00018340: 2020 2020 2022 726f 775f 6e61 6d65 7322       "row_names"
+00018350: 3a20 4e6f 6e65 2c0a 2020 2020 2020 2020  : None,.        
+00018360: 2020 2020 2020 2020 7d0a 2020 2020 2020          }.      
+00018370: 2020 2020 2020 7d0a 2020 2020 2020 2020        }.        
+00018380: 2020 2020 6173 7365 7274 2076 6172 735b      assert vars[
+00018390: 2264 6633 225d 5b22 7375 6d6d 6172 7922  "df3"]["summary"
+000183a0: 5d20 3d3d 2022 5369 7a65 3a20 3135 3078  ] == "Size: 150x
+000183b0: 3520 4d65 6d6f 7279 3a20 352e 3938 204b  5 Memory: 5.98 K
+000183c0: 4222 0a20 2020 2020 2020 2020 2020 2061  B".            a
+000183d0: 7373 6572 7420 7661 7273 5b22 6466 3322  ssert vars["df3"
+000183e0: 5d5b 2261 6262 7265 7669 6174 6564 225d  ]["abbreviated"]
+000183f0: 2069 7320 4661 6c73 650a 2020 2020 2020   is False.      
+00018400: 2020 2020 2020 6173 7365 7274 2076 6172        assert var
+00018410: 735b 2264 6633 225d 5b22 6861 735f 6e65  s["df3"]["has_ne
+00018420: 7874 5f70 6167 6522 5d20 6973 2046 616c  xt_page"] is Fal
+00018430: 7365 0a0a 2020 2020 2020 2020 2020 2020  se..            
+00018440: 7265 7370 6f6e 7365 203d 2061 7761 6974  response = await
+00018450: 2063 6c69 656e 742e 6765 7428 0a20 2020   client.get(.   
+00018460: 2020 2020 2020 2020 2020 2020 2066 222f               f"/
+00018470: 6e6f 7465 626f 6f6b 732f 7b75 7569 647d  notebooks/{uuid}
+00018480: 2f76 6172 7322 2c20 6865 6164 6572 733d  /vars", headers=
+00018490: 7375 7065 7275 7365 725f 746f 6b65 6e5f  superuser_token_
+000184a0: 6865 6164 6572 730a 2020 2020 2020 2020  headers.        
+000184b0: 2020 2020 290a 2020 2020 2020 2020 2020      ).          
+000184c0: 2020 6173 7365 7274 2072 6573 706f 6e73    assert respons
+000184d0: 652e 7374 6174 7573 5f63 6f64 6520 3d3d  e.status_code ==
+000184e0: 2032 3030 0a20 2020 2020 2020 2020 2020   200.           
+000184f0: 2063 7572 7265 6e74 5f76 6172 7320 3d20   current_vars = 
+00018500: 7265 7370 6f6e 7365 2e6a 736f 6e28 295b  response.json()[
+00018510: 2276 6172 7322 5d0a 2020 2020 2020 2020  "vars"].        
+00018520: 2020 2020 6375 7272 656e 745f 7661 7273      current_vars
+00018530: 203d 2066 696c 7465 7228 0a20 2020 2020   = filter(.     
+00018540: 2020 2020 2020 2020 2020 206c 616d 6264             lambd
+00018550: 6120 783a 2078 5b22 6e61 6d65 225d 2021  a x: x["name"] !
+00018560: 3d20 225f 5f5f 6431 6f73 222c 2063 7572  = "___d1os", cur
+00018570: 7265 6e74 5f76 6172 730a 2020 2020 2020  rent_vars.      
+00018580: 2020 2020 2020 290a 2020 2020 2020 2020        ).        
+00018590: 2020 2020 6173 7365 7274 206c 6973 7428      assert list(
+000185a0: 6375 7272 656e 745f 7661 7273 2920 3d3d  current_vars) ==
+000185b0: 2064 6174 615b 2276 6172 7322 5d0a 0a20   data["vars"].. 
+000185c0: 2020 2020 2020 2020 2020 2072 6573 706f             respo
+000185d0: 6e73 6520 3d20 6177 6169 7420 636c 6965  nse = await clie
+000185e0: 6e74 2e67 6574 280a 2020 2020 2020 2020  nt.get(.        
+000185f0: 2020 2020 2020 2020 6622 2f6e 6f74 6562          f"/noteb
+00018600: 6f6f 6b73 2f7b 7575 6964 7d2f 7661 7273  ooks/{uuid}/vars
+00018610: 2f64 6633 222c 2068 6561 6465 7273 3d73  /df3", headers=s
+00018620: 7570 6572 7573 6572 5f74 6f6b 656e 5f68  uperuser_token_h
+00018630: 6561 6465 7273 0a20 2020 2020 2020 2020  eaders.         
+00018640: 2020 2029 0a20 2020 2020 2020 2020 2020     ).           
+00018650: 2061 7373 6572 7420 7265 7370 6f6e 7365   assert response
+00018660: 2e73 7461 7475 735f 636f 6465 203d 3d20  .status_code == 
+00018670: 3230 300a 2020 2020 2020 2020 2020 2020  200.            
+00018680: 7369 6e67 6c65 5f76 6172 203d 2072 6573  single_var = res
+00018690: 706f 6e73 652e 6a73 6f6e 2829 5b22 7369  ponse.json()["si
+000186a0: 6e67 6c65 5f76 6172 225d 0a20 2020 2020  ngle_var"].     
+000186b0: 2020 2020 2020 2061 7373 6572 7420 7369         assert si
+000186c0: 6e67 6c65 5f76 6172 5b22 6e61 6d65 225d  ngle_var["name"]
+000186d0: 203d 3d20 2264 6633 220a 2020 2020 2020   == "df3".      
+000186e0: 2020 2020 2020 6173 7365 7274 2073 696e        assert sin
+000186f0: 676c 655f 7661 725b 2274 7970 6522 5d20  gle_var["type"] 
+00018700: 3d3d 2022 4461 7461 4672 616d 6522 0a20  == "DataFrame". 
+00018710: 2020 2020 2020 2020 2020 2061 7373 6572             asser
+00018720: 7420 7369 6e67 6c65 5f76 6172 5b22 7661  t single_var["va
+00018730: 6c75 6522 5d5b 226d 756c 7469 5f76 616c  lue"]["multi_val
+00018740: 7565 225d 5b22 636f 6c75 6d6e 5f63 6f75  ue"]["column_cou
+00018750: 6e74 225d 203d 3d20 350a 2020 2020 2020  nt"] == 5.      
+00018760: 2020 2020 2020 6173 7365 7274 2073 696e        assert sin
+00018770: 676c 655f 7661 725b 2276 616c 7565 225d  gle_var["value"]
+00018780: 5b22 6d75 6c74 695f 7661 6c75 6522 5d5b  ["multi_value"][
+00018790: 2272 6f77 5f63 6f75 6e74 225d 203d 3d20  "row_count"] == 
+000187a0: 3135 300a 2020 2020 2020 2020 2020 2020  150.            
+000187b0: 6173 7365 7274 2073 696e 676c 655f 7661  assert single_va
+000187c0: 725b 2276 616c 7565 225d 5b22 6d75 6c74  r["value"]["mult
+000187d0: 695f 7661 6c75 6522 5d5b 2263 6f6c 756d  i_value"]["colum
+000187e0: 6e5f 6e61 6d65 7322 5d20 3d3d 205b 0a20  n_names"] == [. 
+000187f0: 2020 2020 2020 2020 2020 2020 2020 2073                 s
+00018800: 7472 2869 2920 666f 7220 6920 696e 2072  tr(i) for i in r
+00018810: 616e 6765 2835 290a 2020 2020 2020 2020  ange(5).        
+00018820: 2020 2020 5d0a 2020 2020 2020 2020 2020      ].          
+00018830: 2020 6173 7365 7274 2073 696e 676c 655f    assert single_
+00018840: 7661 725b 2276 616c 7565 225d 5b22 6d75  var["value"]["mu
+00018850: 6c74 695f 7661 6c75 6522 5d5b 2264 6174  lti_value"]["dat
+00018860: 6122 5d20 3d3d 205b 0a20 2020 2020 2020  a"] == [.       
+00018870: 2020 2020 2020 2020 205b 7374 7228 6920           [str(i 
+00018880: 2b20 6a29 2066 6f72 2069 2069 6e20 7261  + j) for i in ra
+00018890: 6e67 6528 3529 5d0a 2020 2020 2020 2020  nge(5)].        
+000188a0: 2020 2020 2020 2020 666f 7220 6a20 696e          for j in
+000188b0: 2072 616e 6765 2873 6574 7469 6e67 732e   range(settings.
+000188c0: 5641 525f 4445 4641 554c 545f 5041 4745  VAR_DEFAULT_PAGE
+000188d0: 5f53 495a 4529 0a20 2020 2020 2020 2020  _SIZE).         
+000188e0: 2020 205d 0a20 2020 2020 2020 2020 2020     ].           
+000188f0: 2061 7373 6572 7420 7369 6e67 6c65 5f76   assert single_v
+00018900: 6172 5b22 7375 6d6d 6172 7922 5d20 3d3d  ar["summary"] ==
+00018910: 2022 5369 7a65 3a20 3135 3078 3520 4d65   "Size: 150x5 Me
+00018920: 6d6f 7279 3a20 352e 3938 204b 4222 0a20  mory: 5.98 KB". 
+00018930: 2020 2020 2020 2020 2020 2061 7373 6572             asser
+00018940: 7420 7369 6e67 6c65 5f76 6172 5b22 6162  t single_var["ab
+00018950: 6272 6576 6961 7465 6422 5d20 6973 2054  breviated"] is T
+00018960: 7275 650a 2020 2020 2020 2020 2020 2020  rue.            
+00018970: 6173 7365 7274 2073 696e 676c 655f 7661  assert single_va
+00018980: 725b 2268 6173 5f6e 6578 745f 7061 6765  r["has_next_page
+00018990: 225d 2069 7320 5472 7565 0a0a 2020 2020  "] is True..    
+000189a0: 2020 2020 2020 2020 2320 5368 6f75 6c64          # Should
+000189b0: 6e27 7420 6861 7665 2063 6861 6e67 6564  n't have changed
+000189c0: 2061 6e79 7468 696e 6720 696e 2074 6865   anything in the
+000189d0: 2063 7572 7265 6e74 2076 6172 730a 2020   current vars.  
+000189e0: 2020 2020 2020 2020 2020 7265 7370 6f6e            respon
+000189f0: 7365 203d 2061 7761 6974 2063 6c69 656e  se = await clien
+00018a00: 742e 6765 7428 0a20 2020 2020 2020 2020  t.get(.         
+00018a10: 2020 2020 2020 2066 222f 6e6f 7465 626f         f"/notebo
+00018a20: 6f6b 732f 7b75 7569 647d 2f76 6172 7322  oks/{uuid}/vars"
+00018a30: 2c20 6865 6164 6572 733d 7375 7065 7275  , headers=superu
+00018a40: 7365 725f 746f 6b65 6e5f 6865 6164 6572  ser_token_header
+00018a50: 730a 2020 2020 2020 2020 2020 2020 290a  s.            ).
+00018a60: 2020 2020 2020 2020 2020 2020 6173 7365              asse
+00018a70: 7274 2072 6573 706f 6e73 652e 7374 6174  rt response.stat
+00018a80: 7573 5f63 6f64 6520 3d3d 2032 3030 0a20  us_code == 200. 
+00018a90: 2020 2020 2020 2020 2020 2063 7572 7265             curre
+00018aa0: 6e74 5f76 6172 7320 3d20 7265 7370 6f6e  nt_vars = respon
+00018ab0: 7365 2e6a 736f 6e28 295b 2276 6172 7322  se.json()["vars"
+00018ac0: 5d0a 2020 2020 2020 2020 2020 2020 6375  ].            cu
+00018ad0: 7272 656e 745f 7661 7273 203d 2066 696c  rrent_vars = fil
+00018ae0: 7465 7228 0a20 2020 2020 2020 2020 2020  ter(.           
+00018af0: 2020 2020 206c 616d 6264 6120 783a 2078       lambda x: x
+00018b00: 5b22 6e61 6d65 225d 2021 3d20 225f 5f5f  ["name"] != "___
+00018b10: 6431 6f73 222c 2063 7572 7265 6e74 5f76  d1os", current_v
+00018b20: 6172 730a 2020 2020 2020 2020 2020 2020  ars.            
+00018b30: 290a 2020 2020 2020 2020 2020 2020 6173  ).            as
+00018b40: 7365 7274 206c 6973 7428 6375 7272 656e  sert list(curren
+00018b50: 745f 7661 7273 2920 3d3d 2064 6174 615b  t_vars) == data[
+00018b60: 2276 6172 7322 5d0a 0a20 2020 2020 2020  "vars"]..       
+00018b70: 2020 2020 2023 2056 6172 2074 6861 7420       # Var that 
+00018b80: 646f 6573 6e27 7420 6578 6973 740a 2020  doesn't exist.  
+00018b90: 2020 2020 2020 2020 2020 7265 7370 6f6e            respon
+00018ba0: 7365 203d 2061 7761 6974 2063 6c69 656e  se = await clien
+00018bb0: 742e 6765 7428 0a20 2020 2020 2020 2020  t.get(.         
+00018bc0: 2020 2020 2020 2066 222f 6e6f 7465 626f         f"/notebo
+00018bd0: 6f6b 732f 7b75 7569 647d 2f76 6172 732f  oks/{uuid}/vars/
+00018be0: 6466 3222 2c20 6865 6164 6572 733d 7375  df2", headers=su
+00018bf0: 7065 7275 7365 725f 746f 6b65 6e5f 6865  peruser_token_he
+00018c00: 6164 6572 730a 2020 2020 2020 2020 2020  aders.          
+00018c10: 2020 290a 2020 2020 2020 2020 2020 2020    ).            
+00018c20: 6173 7365 7274 2072 6573 706f 6e73 652e  assert response.
+00018c30: 7374 6174 7573 5f63 6f64 6520 3d3d 2034  status_code == 4
+00018c40: 3034 0a0a 2020 2020 4070 7974 6573 742e  04..    @pytest.
+00018c50: 6d61 726b 2e61 7379 6e63 696f 0a20 2020  mark.asyncio.   
+00018c60: 2061 7379 6e63 2064 6566 2074 6573 745f   async def test_
+00018c70: 6765 745f 7369 6e67 6c65 5f76 6172 5f64  get_single_var_d
+00018c80: 6574 6169 6c5f 7061 6769 6e61 7469 6f6e  etail_pagination
+00018c90: 280a 2020 2020 2020 2020 7365 6c66 2c20  (.        self, 
+00018ca0: 636c 6965 6e74 3a20 5465 7374 436c 6965  client: TestClie
+00018cb0: 6e74 2c20 7375 7065 7275 7365 725f 746f  nt, superuser_to
+00018cc0: 6b65 6e5f 6865 6164 6572 733a 2044 6963  ken_headers: Dic
+00018cd0: 745b 7374 722c 2073 7472 5d0a 2020 2020  t[str, str].    
+00018ce0: 293a 0a20 2020 2020 2020 2022 2222 0a20  ):.        """. 
+00018cf0: 2020 2020 2020 204c 6172 6765 2064 6174         Large dat
+00018d00: 6166 7261 6d65 2069 7320 6162 6272 6576  aframe is abbrev
+00018d10: 6961 7465 6420 696e 2073 756d 6d61 7279  iated in summary
+00018d20: 2c20 6e6f 7420 696e 2076 6172 6961 626c  , not in variabl
+00018d30: 650a 2020 2020 2020 2020 6465 7461 696c  e.        detail
+00018d40: 7320 7265 7175 6573 742e 0a20 2020 2020  s request..     
+00018d50: 2020 2022 2222 0a20 2020 2020 2020 2075     """.        u
+00018d60: 7569 6420 3d20 6177 6169 7420 7570 6c6f  uid = await uplo
+00018d70: 6164 5f6e 6f74 6562 6f6f 6b28 0a20 2020  ad_notebook(.   
+00018d80: 2020 2020 2020 2020 2063 6c69 656e 742c           client,
+00018d90: 2073 7570 6572 7573 6572 5f74 6f6b 656e   superuser_token
+00018da0: 5f68 6561 6465 7273 2c20 2273 696d 706c  _headers, "simpl
+00018db0: 652e 6970 796e 6222 0a20 2020 2020 2020  e.ipynb".       
+00018dc0: 2029 0a0a 2020 2020 2020 2020 2320 6765   )..        # ge
+00018dd0: 7420 616e 2065 7869 7374 696e 6720 6365  t an existing ce
+00018de0: 6c6c 0a20 2020 2020 2020 2072 6573 706f  ll.        respo
+00018df0: 6e73 6520 3d20 6177 6169 7420 636c 6965  nse = await clie
+00018e00: 6e74 2e67 6574 280a 2020 2020 2020 2020  nt.get(.        
+00018e10: 2020 2020 6622 2f6e 6f74 6562 6f6f 6b73      f"/notebooks
+00018e20: 2f7b 7575 6964 7d2f 6365 6c6c 7322 2c20  /{uuid}/cells", 
+00018e30: 6865 6164 6572 733d 7375 7065 7275 7365  headers=superuse
+00018e40: 725f 746f 6b65 6e5f 6865 6164 6572 730a  r_token_headers.
+00018e50: 2020 2020 2020 2020 290a 2020 2020 2020          ).      
+00018e60: 2020 6173 7365 7274 2072 6573 706f 6e73    assert respons
+00018e70: 652e 7374 6174 7573 5f63 6f64 6520 3d3d  e.status_code ==
+00018e80: 2032 3030 0a20 2020 2020 2020 2063 656c   200.        cel
+00018e90: 6c73 203d 2072 6573 706f 6e73 652e 6a73  ls = response.js
+00018ea0: 6f6e 2829 5b22 6365 6c6c 7322 5d0a 2020  on()["cells"].  
+00018eb0: 2020 2020 2020 6173 7365 7274 2063 656c        assert cel
+00018ec0: 6c73 5b31 5d5b 2273 6f75 7263 6522 5d20  ls[1]["source"] 
+00018ed0: 3d3d 2027 7072 696e 7428 224c 6172 7279  == 'print("Larry
+00018ee0: 2074 6865 204c 6c61 6d61 2229 270a 0a20   the Llama")'.. 
+00018ef0: 2020 2020 2020 2063 656c 6c5f 7575 6964         cell_uuid
+00018f00: 203d 2063 656c 6c73 5b31 5d5b 226d 6574   = cells[1]["met
+00018f10: 6164 6174 6122 5d5b 226a 7570 7974 6572  adata"]["jupyter
+00018f20: 5f64 3122 5d5b 2275 7569 6422 5d0a 0a20  _d1"]["uuid"].. 
+00018f30: 2020 2020 2020 2070 6172 616d 7320 3d20         params = 
+00018f40: 7b0a 2020 2020 2020 2020 2020 2020 2273  {.            "s
+00018f50: 6f75 7263 6522 3a20 2269 6d70 6f72 7420  ource": "import 
+00018f60: 7061 6e64 6173 2061 7320 7064 5c6e 6466  pandas as pd\ndf
+00018f70: 3320 3d20 220a 2020 2020 2020 2020 2020  3 = ".          
+00018f80: 2020 2270 642e 4461 7461 4672 616d 6528    "pd.DataFrame(
+00018f90: 5b7b 7374 7228 6929 3a20 6920 2b20 6a20  [{str(i): i + j 
+00018fa0: 666f 7220 6920 696e 2072 616e 6765 2835  for i in range(5
+00018fb0: 297d 2066 6f72 206a 2069 6e20 220a 2020  )} for j in ".  
+00018fc0: 2020 2020 2020 2020 2020 2272 616e 6765            "range
+00018fd0: 2831 3530 295d 2922 0a20 2020 2020 2020  (150)])".       
+00018fe0: 207d 0a20 2020 2020 2020 2072 6573 706f   }.        respo
+00018ff0: 6e73 6520 3d20 6177 6169 7420 636c 6965  nse = await clie
+00019000: 6e74 2e70 6174 6368 280a 2020 2020 2020  nt.patch(.      
+00019010: 2020 2020 2020 6622 2f6e 6f74 6562 6f6f        f"/noteboo
+00019020: 6b73 2f7b 7575 6964 7d2f 6365 6c6c 732f  ks/{uuid}/cells/
+00019030: 7b63 656c 6c5f 7575 6964 7d22 2c0a 2020  {cell_uuid}",.  
+00019040: 2020 2020 2020 2020 2020 6a73 6f6e 3d70            json=p
+00019050: 6172 616d 732c 0a20 2020 2020 2020 2020  arams,.         
+00019060: 2020 2068 6561 6465 7273 3d73 7570 6572     headers=super
+00019070: 7573 6572 5f74 6f6b 656e 5f68 6561 6465  user_token_heade
+00019080: 7273 2c0a 2020 2020 2020 2020 290a 2020  rs,.        ).  
+00019090: 2020 2020 2020 6173 7365 7274 2072 6573        assert res
+000190a0: 706f 6e73 652e 7374 6174 7573 5f63 6f64  ponse.status_cod
+000190b0: 6520 3d3d 2032 3030 0a0a 2020 2020 2020  e == 200..      
+000190c0: 2020 7265 7370 6f6e 7365 203d 2061 7761    response = awa
+000190d0: 6974 2063 6c69 656e 742e 6765 7428 0a20  it client.get(. 
+000190e0: 2020 2020 2020 2020 2020 2066 222f 6e6f             f"/no
+000190f0: 7465 626f 6f6b 732f 7b75 7569 647d 2f76  tebooks/{uuid}/v
+00019100: 6172 7322 2c20 6865 6164 6572 733d 7375  ars", headers=su
+00019110: 7065 7275 7365 725f 746f 6b65 6e5f 6865  peruser_token_he
+00019120: 6164 6572 730a 2020 2020 2020 2020 290a  aders.        ).
+00019130: 2020 2020 2020 2020 6173 7365 7274 2072          assert r
+00019140: 6573 706f 6e73 652e 7374 6174 7573 5f63  esponse.status_c
+00019150: 6f64 6520 3d3d 2032 3030 0a20 2020 2020  ode == 200.     
+00019160: 2020 2061 7373 6572 7420 6c65 6e28 7265     assert len(re
+00019170: 7370 6f6e 7365 2e6a 736f 6e28 295b 2276  sponse.json()["v
+00019180: 6172 7322 5d29 203d 3d20 300a 0a20 2020  ars"]) == 0..   
+00019190: 2020 2020 2061 7379 6e63 2077 6974 6820       async with 
+000191a0: 636c 6965 6e74 2e77 6562 736f 636b 6574  client.websocket
+000191b0: 5f63 6f6e 6e65 6374 280a 2020 2020 2020  _connect(.      
+000191c0: 2020 2020 2020 6622 2f6e 6f74 6562 6f6f        f"/noteboo
+000191d0: 6b73 2f7b 7575 6964 7d2f 7773 2f6e 6f74  ks/{uuid}/ws/not
+000191e0: 6562 6f6f 6b22 2c20 6865 6164 6572 733d  ebook", headers=
+000191f0: 7375 7065 7275 7365 725f 746f 6b65 6e5f  superuser_token_
+00019200: 6865 6164 6572 730a 2020 2020 2020 2020  headers.        
+00019210: 2920 6173 2077 6562 736f 636b 6574 3a0a  ) as websocket:.
+00019220: 2020 2020 2020 2020 2020 2020 6177 6169              awai
+00019230: 7420 6173 796e 6369 6f2e 736c 6565 7028  t asyncio.sleep(
+00019240: 5745 4253 4f43 4b45 545f 534c 4545 505f  WEBSOCKET_SLEEP_
+00019250: 5449 4d45 290a 0a20 2020 2020 2020 2020  TIME)..         
+00019260: 2020 2072 6573 706f 6e73 6520 3d20 6177     response = aw
+00019270: 6169 7420 636c 6965 6e74 2e67 6574 280a  ait client.get(.
+00019280: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00019290: 6622 2f6e 6f74 6562 6f6f 6b73 2f7b 7575  f"/notebooks/{uu
+000192a0: 6964 7d2f 6365 6c6c 732f 7b63 656c 6c5f  id}/cells/{cell_
+000192b0: 7575 6964 7d2f 6578 6563 7574 6522 2c0a  uuid}/execute",.
+000192c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000192d0: 6865 6164 6572 733d 7375 7065 7275 7365  headers=superuse
+000192e0: 725f 746f 6b65 6e5f 6865 6164 6572 732c  r_token_headers,
+000192f0: 0a20 2020 2020 2020 2020 2020 2029 0a20  .            ). 
+00019300: 2020 2020 2020 2020 2020 2061 7373 6572             asser
+00019310: 7420 7265 7370 6f6e 7365 2e73 7461 7475  t response.statu
+00019320: 735f 636f 6465 203d 3d20 3230 300a 0a20  s_code == 200.. 
+00019330: 2020 2020 2020 2020 2020 2023 204b 6572             # Ker
+00019340: 6e65 6c20 7661 7273 2075 7064 6174 650a  nel vars update.
+00019350: 2020 2020 2020 2020 2020 2020 6461 7461              data
+00019360: 203d 2061 7761 6974 2072 6563 6569 7665   = await receive
+00019370: 5f6a 736f 6e28 7765 6273 6f63 6b65 742c  _json(websocket,
+00019380: 206d 7367 5f74 7970 6573 3d5b 2276 6172   msg_types=["var
+00019390: 7322 5d29 0a20 2020 2020 2020 2020 2020  s"]).           
+000193a0: 2076 6172 7320 3d20 7b0a 2020 2020 2020   vars = {.      
+000193b0: 2020 2020 2020 2020 2020 7661 725b 226e            var["n
+000193c0: 616d 6522 5d3a 207b 0a20 2020 2020 2020  ame"]: {.       
+000193d0: 2020 2020 2020 2020 2020 2020 2022 7479               "ty
+000193e0: 7065 223a 2076 6172 5b22 7479 7065 225d  pe": var["type"]
+000193f0: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
+00019400: 2020 2020 2020 2276 616c 7565 223a 2076        "value": v
+00019410: 6172 5b22 7661 6c75 6522 5d2c 0a20 2020  ar["value"],.   
+00019420: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00019430: 2022 7375 6d6d 6172 7922 3a20 7661 725b   "summary": var[
+00019440: 2273 756d 6d61 7279 225d 2c0a 2020 2020  "summary"],.    
+00019450: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00019460: 2261 6262 7265 7669 6174 6564 223a 2076  "abbreviated": v
+00019470: 6172 5b22 6162 6272 6576 6961 7465 6422  ar["abbreviated"
+00019480: 5d2c 0a20 2020 2020 2020 2020 2020 2020  ],.             
+00019490: 2020 2020 2020 2022 6861 735f 6e65 7874         "has_next
+000194a0: 5f70 6167 6522 3a20 7661 725b 2268 6173  _page": var["has
+000194b0: 5f6e 6578 745f 7061 6765 225d 2c0a 2020  _next_page"],.  
+000194c0: 2020 2020 2020 2020 2020 2020 2020 7d0a                }.
+000194d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000194e0: 666f 7220 7661 7220 696e 2064 6174 615b  for var in data[
+000194f0: 2276 6172 7322 5d0a 2020 2020 2020 2020  "vars"].        
+00019500: 2020 2020 7d0a 0a20 2020 2020 2020 2020      }..         
+00019510: 2020 2061 7373 6572 7420 7661 7273 5b22     assert vars["
+00019520: 6466 3322 5d5b 2274 7970 6522 5d20 3d3d  df3"]["type"] ==
+00019530: 2022 4461 7461 4672 616d 6522 0a20 2020   "DataFrame".   
+00019540: 2020 2020 2020 2020 2061 7373 6572 7420           assert 
+00019550: 7661 7273 5b22 6466 3322 5d5b 2276 616c  vars["df3"]["val
+00019560: 7565 225d 203d 3d20 7b0a 2020 2020 2020  ue"] == {.      
+00019570: 2020 2020 2020 2020 2020 226d 756c 7469            "multi
+00019580: 5f76 616c 7565 223a 207b 0a20 2020 2020  _value": {.     
+00019590: 2020 2020 2020 2020 2020 2020 2020 2022                 "
+000195a0: 726f 775f 636f 756e 7422 3a20 3135 302c  row_count": 150,
+000195b0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+000195c0: 2020 2020 2022 636f 6c75 6d6e 5f63 6f75       "column_cou
+000195d0: 6e74 223a 2035 2c0a 2020 2020 2020 2020  nt": 5,.        
+000195e0: 2020 2020 2020 2020 2020 2020 2263 6f6c              "col
+000195f0: 756d 6e5f 6e61 6d65 7322 3a20 4e6f 6e65  umn_names": None
+00019600: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
+00019610: 2020 2020 2020 2264 6174 6122 3a20 4e6f        "data": No
+00019620: 6e65 2c0a 2020 2020 2020 2020 2020 2020  ne,.            
+00019630: 2020 2020 2020 2020 2272 6f77 5f6e 616d          "row_nam
+00019640: 6573 223a 204e 6f6e 652c 0a20 2020 2020  es": None,.     
+00019650: 2020 2020 2020 2020 2020 207d 0a20 2020             }.   
+00019660: 2020 2020 2020 2020 207d 0a20 2020 2020           }.     
+00019670: 2020 2020 2020 2061 7373 6572 7420 7661         assert va
+00019680: 7273 5b22 6466 3322 5d5b 2273 756d 6d61  rs["df3"]["summa
+00019690: 7279 225d 203d 3d20 2253 697a 653a 2031  ry"] == "Size: 1
+000196a0: 3530 7835 204d 656d 6f72 793a 2035 2e39  50x5 Memory: 5.9
+000196b0: 3820 4b42 220a 2020 2020 2020 2020 2020  8 KB".          
+000196c0: 2020 6173 7365 7274 2076 6172 735b 2264    assert vars["d
+000196d0: 6633 225d 5b22 6162 6272 6576 6961 7465  f3"]["abbreviate
+000196e0: 6422 5d20 6973 2046 616c 7365 0a0a 2020  d"] is False..  
+000196f0: 2020 2020 2020 2020 2020 2320 4669 7273            # Firs
+00019700: 7420 7061 6765 0a20 2020 2020 2020 2020  t page.         
+00019710: 2020 2072 6573 706f 6e73 6520 3d20 6177     response = aw
+00019720: 6169 7420 636c 6965 6e74 2e67 6574 280a  ait client.get(.
+00019730: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00019740: 6622 2f6e 6f74 6562 6f6f 6b73 2f7b 7575  f"/notebooks/{uu
+00019750: 6964 7d2f 7661 7273 2f64 6633 222c 0a20  id}/vars/df3",. 
+00019760: 2020 2020 2020 2020 2020 2020 2020 2071                 q
+00019770: 7565 7279 5f73 7472 696e 673d 7b22 7061  uery_string={"pa
+00019780: 6765 5f73 697a 6522 3a20 3131 2c20 2270  ge_size": 11, "p
+00019790: 6167 6522 3a20 307d 2c0a 2020 2020 2020  age": 0},.      
+000197a0: 2020 2020 2020 2020 2020 6865 6164 6572            header
+000197b0: 733d 7375 7065 7275 7365 725f 746f 6b65  s=superuser_toke
+000197c0: 6e5f 6865 6164 6572 732c 0a20 2020 2020  n_headers,.     
+000197d0: 2020 2020 2020 2029 0a20 2020 2020 2020         ).       
+000197e0: 2020 2020 2061 7373 6572 7420 7265 7370       assert resp
+000197f0: 6f6e 7365 2e73 7461 7475 735f 636f 6465  onse.status_code
+00019800: 203d 3d20 3230 300a 2020 2020 2020 2020   == 200.        
+00019810: 2020 2020 7369 6e67 6c65 5f76 6172 203d      single_var =
+00019820: 2072 6573 706f 6e73 652e 6a73 6f6e 2829   response.json()
+00019830: 5b22 7369 6e67 6c65 5f76 6172 225d 0a20  ["single_var"]. 
+00019840: 2020 2020 2020 2020 2020 2061 7373 6572             asser
+00019850: 7420 7369 6e67 6c65 5f76 6172 5b22 6e61  t single_var["na
+00019860: 6d65 225d 203d 3d20 2264 6633 220a 2020  me"] == "df3".  
+00019870: 2020 2020 2020 2020 2020 6173 7365 7274            assert
+00019880: 2073 696e 676c 655f 7661 725b 2274 7970   single_var["typ
+00019890: 6522 5d20 3d3d 2022 4461 7461 4672 616d  e"] == "DataFram
+000198a0: 6522 0a20 2020 2020 2020 2020 2020 2061  e".            a
+000198b0: 7373 6572 7420 7369 6e67 6c65 5f76 6172  ssert single_var
+000198c0: 5b22 7661 6c75 6522 5d5b 226d 756c 7469  ["value"]["multi
+000198d0: 5f76 616c 7565 225d 5b22 636f 6c75 6d6e  _value"]["column
+000198e0: 5f63 6f75 6e74 225d 203d 3d20 350a 2020  _count"] == 5.  
+000198f0: 2020 2020 2020 2020 2020 6173 7365 7274            assert
+00019900: 2073 696e 676c 655f 7661 725b 2276 616c   single_var["val
+00019910: 7565 225d 5b22 6d75 6c74 695f 7661 6c75  ue"]["multi_valu
+00019920: 6522 5d5b 2272 6f77 5f63 6f75 6e74 225d  e"]["row_count"]
+00019930: 203d 3d20 3135 300a 2020 2020 2020 2020   == 150.        
+00019940: 2020 2020 6173 7365 7274 2073 696e 676c      assert singl
+00019950: 655f 7661 725b 2276 616c 7565 225d 5b22  e_var["value"]["
+00019960: 6d75 6c74 695f 7661 6c75 6522 5d5b 2263  multi_value"]["c
+00019970: 6f6c 756d 6e5f 6e61 6d65 7322 5d20 3d3d  olumn_names"] ==
+00019980: 205b 0a20 2020 2020 2020 2020 2020 2020   [.             
+00019990: 2020 2073 7472 2869 2920 666f 7220 6920     str(i) for i 
+000199a0: 696e 2072 616e 6765 2835 290a 2020 2020  in range(5).    
+000199b0: 2020 2020 2020 2020 5d0a 2020 2020 2020          ].      
+000199c0: 2020 2020 2020 6173 7365 7274 2073 696e        assert sin
+000199d0: 676c 655f 7661 725b 2276 616c 7565 225d  gle_var["value"]
+000199e0: 5b22 6d75 6c74 695f 7661 6c75 6522 5d5b  ["multi_value"][
+000199f0: 2264 6174 6122 5d20 3d3d 205b 0a20 2020  "data"] == [.   
+00019a00: 2020 2020 2020 2020 2020 2020 205b 7374               [st
+00019a10: 7228 6920 2b20 6a29 2066 6f72 2069 2069  r(i + j) for i i
+00019a20: 6e20 7261 6e67 6528 3529 5d20 666f 7220  n range(5)] for 
+00019a30: 6a20 696e 2072 616e 6765 2831 3129 0a20  j in range(11). 
+00019a40: 2020 2020 2020 2020 2020 205d 0a20 2020             ].   
+00019a50: 2020 2020 2020 2020 2061 7373 6572 7420           assert 
+00019a60: 7369 6e67 6c65 5f76 6172 5b22 7375 6d6d  single_var["summ
+00019a70: 6172 7922 5d20 3d3d 2022 5369 7a65 3a20  ary"] == "Size: 
+00019a80: 3135 3078 3520 4d65 6d6f 7279 3a20 352e  150x5 Memory: 5.
+00019a90: 3938 204b 4222 0a20 2020 2020 2020 2020  98 KB".         
+00019aa0: 2020 2061 7373 6572 7420 7369 6e67 6c65     assert single
+00019ab0: 5f76 6172 5b22 6162 6272 6576 6961 7465  _var["abbreviate
+00019ac0: 6422 5d20 6973 2054 7275 650a 2020 2020  d"] is True.    
+00019ad0: 2020 2020 2020 2020 6173 7365 7274 2073          assert s
+00019ae0: 696e 676c 655f 7661 725b 2268 6173 5f6e  ingle_var["has_n
+00019af0: 6578 745f 7061 6765 225d 2069 7320 5472  ext_page"] is Tr
+00019b00: 7565 0a0a 2020 2020 2020 2020 2020 2020  ue..            
+00019b10: 2320 5365 636f 6e64 2070 6167 650a 2020  # Second page.  
+00019b20: 2020 2020 2020 2020 2020 7265 7370 6f6e            respon
+00019b30: 7365 203d 2061 7761 6974 2063 6c69 656e  se = await clien
+00019b40: 742e 6765 7428 0a20 2020 2020 2020 2020  t.get(.         
+00019b50: 2020 2020 2020 2066 222f 6e6f 7465 626f         f"/notebo
+00019b60: 6f6b 732f 7b75 7569 647d 2f76 6172 732f  oks/{uuid}/vars/
+00019b70: 6466 3322 2c0a 2020 2020 2020 2020 2020  df3",.          
+00019b80: 2020 2020 2020 7175 6572 795f 7374 7269        query_stri
+00019b90: 6e67 3d7b 2270 6167 655f 7369 7a65 223a  ng={"page_size":
+00019ba0: 2031 312c 2022 7061 6765 223a 2031 7d2c   11, "page": 1},
+00019bb0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00019bc0: 2068 6561 6465 7273 3d73 7570 6572 7573   headers=superus
+00019bd0: 6572 5f74 6f6b 656e 5f68 6561 6465 7273  er_token_headers
+00019be0: 2c0a 2020 2020 2020 2020 2020 2020 290a  ,.            ).
+00019bf0: 2020 2020 2020 2020 2020 2020 6173 7365              asse
+00019c00: 7274 2072 6573 706f 6e73 652e 7374 6174  rt response.stat
+00019c10: 7573 5f63 6f64 6520 3d3d 2032 3030 0a20  us_code == 200. 
+00019c20: 2020 2020 2020 2020 2020 2073 696e 676c             singl
+00019c30: 655f 7661 7220 3d20 7265 7370 6f6e 7365  e_var = response
+00019c40: 2e6a 736f 6e28 295b 2273 696e 676c 655f  .json()["single_
+00019c50: 7661 7222 5d0a 2020 2020 2020 2020 2020  var"].          
+00019c60: 2020 6173 7365 7274 2073 696e 676c 655f    assert single_
+00019c70: 7661 725b 226e 616d 6522 5d20 3d3d 2022  var["name"] == "
+00019c80: 6466 3322 0a20 2020 2020 2020 2020 2020  df3".           
+00019c90: 2061 7373 6572 7420 7369 6e67 6c65 5f76   assert single_v
+00019ca0: 6172 5b22 7479 7065 225d 203d 3d20 2244  ar["type"] == "D
+00019cb0: 6174 6146 7261 6d65 220a 2020 2020 2020  ataFrame".      
+00019cc0: 2020 2020 2020 6173 7365 7274 2073 696e        assert sin
+00019cd0: 676c 655f 7661 725b 2276 616c 7565 225d  gle_var["value"]
+00019ce0: 5b22 6d75 6c74 695f 7661 6c75 6522 5d5b  ["multi_value"][
+00019cf0: 2263 6f6c 756d 6e5f 636f 756e 7422 5d20  "column_count"] 
+00019d00: 3d3d 2035 0a20 2020 2020 2020 2020 2020  == 5.           
+00019d10: 2061 7373 6572 7420 7369 6e67 6c65 5f76   assert single_v
+00019d20: 6172 5b22 7661 6c75 6522 5d5b 226d 756c  ar["value"]["mul
+00019d30: 7469 5f76 616c 7565 225d 5b22 726f 775f  ti_value"]["row_
+00019d40: 636f 756e 7422 5d20 3d3d 2031 3530 0a20  count"] == 150. 
+00019d50: 2020 2020 2020 2020 2020 2061 7373 6572             asser
+00019d60: 7420 7369 6e67 6c65 5f76 6172 5b22 7661  t single_var["va
+00019d70: 6c75 6522 5d5b 226d 756c 7469 5f76 616c  lue"]["multi_val
+00019d80: 7565 225d 5b22 636f 6c75 6d6e 5f6e 616d  ue"]["column_nam
+00019d90: 6573 225d 203d 3d20 5b0a 2020 2020 2020  es"] == [.      
+00019da0: 2020 2020 2020 2020 2020 7374 7228 6929            str(i)
+00019db0: 2066 6f72 2069 2069 6e20 7261 6e67 6528   for i in range(
+00019dc0: 3529 0a20 2020 2020 2020 2020 2020 205d  5).            ]
+00019dd0: 0a20 2020 2020 2020 2020 2020 2061 7373  .            ass
+00019de0: 6572 7420 7369 6e67 6c65 5f76 6172 5b22  ert single_var["
+00019df0: 7661 6c75 6522 5d5b 226d 756c 7469 5f76  value"]["multi_v
+00019e00: 616c 7565 225d 5b22 6461 7461 225d 203d  alue"]["data"] =
+00019e10: 3d20 5b0a 2020 2020 2020 2020 2020 2020  = [.            
+00019e20: 2020 2020 5b73 7472 2869 202b 206a 2920      [str(i + j) 
+00019e30: 666f 7220 6920 696e 2072 616e 6765 2835  for i in range(5
+00019e40: 295d 2066 6f72 206a 2069 6e20 7261 6e67  )] for j in rang
+00019e50: 6528 3131 2c20 3232 290a 2020 2020 2020  e(11, 22).      
+00019e60: 2020 2020 2020 5d0a 2020 2020 2020 2020        ].        
+00019e70: 2020 2020 6173 7365 7274 2073 696e 676c      assert singl
+00019e80: 655f 7661 725b 2273 756d 6d61 7279 225d  e_var["summary"]
+00019e90: 203d 3d20 2253 697a 653a 2031 3530 7835   == "Size: 150x5
+00019ea0: 204d 656d 6f72 793a 2035 2e39 3820 4b42   Memory: 5.98 KB
+00019eb0: 220a 2020 2020 2020 2020 2020 2020 6173  ".            as
+00019ec0: 7365 7274 2073 696e 676c 655f 7661 725b  sert single_var[
+00019ed0: 2261 6262 7265 7669 6174 6564 225d 2069  "abbreviated"] i
+00019ee0: 7320 5472 7565 0a20 2020 2020 2020 2020  s True.         
+00019ef0: 2020 2061 7373 6572 7420 7369 6e67 6c65     assert single
+00019f00: 5f76 6172 5b22 6861 735f 6e65 7874 5f70  _var["has_next_p
+00019f10: 6167 6522 5d20 6973 2054 7275 650a 0a20  age"] is True.. 
+00019f20: 2020 2020 2020 2020 2020 2023 2046 696e             # Fin
+00019f30: 616c 2070 6167 650a 2020 2020 2020 2020  al page.        
+00019f40: 2020 2020 7265 7370 6f6e 7365 203d 2061      response = a
+00019f50: 7761 6974 2063 6c69 656e 742e 6765 7428  wait client.get(
+00019f60: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00019f70: 2066 222f 6e6f 7465 626f 6f6b 732f 7b75   f"/notebooks/{u
+00019f80: 7569 647d 2f76 6172 732f 6466 3322 2c0a  uid}/vars/df3",.
+00019f90: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00019fa0: 7175 6572 795f 7374 7269 6e67 3d7b 2270  query_string={"p
+00019fb0: 6167 655f 7369 7a65 223a 2031 312c 2022  age_size": 11, "
+00019fc0: 7061 6765 223a 2031 337d 2c0a 2020 2020  page": 13},.    
+00019fd0: 2020 2020 2020 2020 2020 2020 6865 6164              head
+00019fe0: 6572 733d 7375 7065 7275 7365 725f 746f  ers=superuser_to
+00019ff0: 6b65 6e5f 6865 6164 6572 732c 0a20 2020  ken_headers,.   
+0001a000: 2020 2020 2020 2020 2029 0a20 2020 2020           ).     
+0001a010: 2020 2020 2020 2061 7373 6572 7420 7265         assert re
+0001a020: 7370 6f6e 7365 2e73 7461 7475 735f 636f  sponse.status_co
+0001a030: 6465 203d 3d20 3230 300a 2020 2020 2020  de == 200.      
+0001a040: 2020 2020 2020 7369 6e67 6c65 5f76 6172        single_var
+0001a050: 203d 2072 6573 706f 6e73 652e 6a73 6f6e   = response.json
+0001a060: 2829 5b22 7369 6e67 6c65 5f76 6172 225d  ()["single_var"]
+0001a070: 0a20 2020 2020 2020 2020 2020 2061 7373  .            ass
+0001a080: 6572 7420 7369 6e67 6c65 5f76 6172 5b22  ert single_var["
+0001a090: 6e61 6d65 225d 203d 3d20 2264 6633 220a  name"] == "df3".
+0001a0a0: 2020 2020 2020 2020 2020 2020 6173 7365              asse
+0001a0b0: 7274 2073 696e 676c 655f 7661 725b 2274  rt single_var["t
+0001a0c0: 7970 6522 5d20 3d3d 2022 4461 7461 4672  ype"] == "DataFr
+0001a0d0: 616d 6522 0a20 2020 2020 2020 2020 2020  ame".           
+0001a0e0: 2061 7373 6572 7420 7369 6e67 6c65 5f76   assert single_v
+0001a0f0: 6172 5b22 7661 6c75 6522 5d5b 226d 756c  ar["value"]["mul
+0001a100: 7469 5f76 616c 7565 225d 5b22 636f 6c75  ti_value"]["colu
+0001a110: 6d6e 5f63 6f75 6e74 225d 203d 3d20 350a  mn_count"] == 5.
+0001a120: 2020 2020 2020 2020 2020 2020 6173 7365              asse
+0001a130: 7274 2073 696e 676c 655f 7661 725b 2276  rt single_var["v
+0001a140: 616c 7565 225d 5b22 6d75 6c74 695f 7661  alue"]["multi_va
+0001a150: 6c75 6522 5d5b 2272 6f77 5f63 6f75 6e74  lue"]["row_count
+0001a160: 225d 203d 3d20 3135 300a 2020 2020 2020  "] == 150.      
+0001a170: 2020 2020 2020 6173 7365 7274 2073 696e        assert sin
+0001a180: 676c 655f 7661 725b 2276 616c 7565 225d  gle_var["value"]
+0001a190: 5b22 6d75 6c74 695f 7661 6c75 6522 5d5b  ["multi_value"][
+0001a1a0: 2263 6f6c 756d 6e5f 6e61 6d65 7322 5d20  "column_names"] 
+0001a1b0: 3d3d 205b 0a20 2020 2020 2020 2020 2020  == [.           
+0001a1c0: 2020 2020 2073 7472 2869 2920 666f 7220       str(i) for 
+0001a1d0: 6920 696e 2072 616e 6765 2835 290a 2020  i in range(5).  
+0001a1e0: 2020 2020 2020 2020 2020 5d0a 2020 2020            ].    
+0001a1f0: 2020 2020 2020 2020 6173 7365 7274 2073          assert s
+0001a200: 696e 676c 655f 7661 725b 2276 616c 7565  ingle_var["value
+0001a210: 225d 5b22 6d75 6c74 695f 7661 6c75 6522  "]["multi_value"
+0001a220: 5d5b 2264 6174 6122 5d20 3d3d 205b 0a20  ]["data"] == [. 
+0001a230: 2020 2020 2020 2020 2020 2020 2020 205b                 [
+0001a240: 7374 7228 6920 2b20 6a29 2066 6f72 2069  str(i + j) for i
+0001a250: 2069 6e20 7261 6e67 6528 3529 5d20 666f   in range(5)] fo
+0001a260: 7220 6a20 696e 2072 616e 6765 2831 3433  r j in range(143
+0001a270: 2c20 3135 3029 0a20 2020 2020 2020 2020  , 150).         
+0001a280: 2020 205d 0a20 2020 2020 2020 2020 2020     ].           
+0001a290: 2061 7373 6572 7420 7369 6e67 6c65 5f76   assert single_v
+0001a2a0: 6172 5b22 7375 6d6d 6172 7922 5d20 3d3d  ar["summary"] ==
+0001a2b0: 2022 5369 7a65 3a20 3135 3078 3520 4d65   "Size: 150x5 Me
+0001a2c0: 6d6f 7279 3a20 352e 3938 204b 4222 0a20  mory: 5.98 KB". 
+0001a2d0: 2020 2020 2020 2020 2020 2061 7373 6572             asser
+0001a2e0: 7420 7369 6e67 6c65 5f76 6172 5b22 6162  t single_var["ab
+0001a2f0: 6272 6576 6961 7465 6422 5d20 6973 2046  breviated"] is F
+0001a300: 616c 7365 0a20 2020 2020 2020 2020 2020  alse.           
+0001a310: 2061 7373 6572 7420 7369 6e67 6c65 5f76   assert single_v
+0001a320: 6172 5b22 6861 735f 6e65 7874 5f70 6167  ar["has_next_pag
+0001a330: 6522 5d20 6973 2046 616c 7365 0a0a 2020  e"] is False..  
+0001a340: 2020 2020 2020 2020 2020 2320 4f75 7420            # Out 
+0001a350: 6f66 2072 616e 6765 0a20 2020 2020 2020  of range.       
+0001a360: 2020 2020 2072 6573 706f 6e73 6520 3d20       response = 
+0001a370: 6177 6169 7420 636c 6965 6e74 2e67 6574  await client.get
+0001a380: 280a 2020 2020 2020 2020 2020 2020 2020  (.              
+0001a390: 2020 6622 2f6e 6f74 6562 6f6f 6b73 2f7b    f"/notebooks/{
+0001a3a0: 7575 6964 7d2f 7661 7273 2f64 6633 222c  uuid}/vars/df3",
+0001a3b0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+0001a3c0: 2071 7565 7279 5f73 7472 696e 673d 7b22   query_string={"
+0001a3d0: 7061 6765 5f73 697a 6522 3a20 3131 2c20  page_size": 11, 
+0001a3e0: 2270 6167 6522 3a20 3134 7d2c 0a20 2020  "page": 14},.   
+0001a3f0: 2020 2020 2020 2020 2020 2020 2068 6561               hea
+0001a400: 6465 7273 3d73 7570 6572 7573 6572 5f74  ders=superuser_t
+0001a410: 6f6b 656e 5f68 6561 6465 7273 2c0a 2020  oken_headers,.  
+0001a420: 2020 2020 2020 2020 2020 290a 2020 2020            ).    
+0001a430: 2020 2020 2020 2020 6173 7365 7274 2072          assert r
+0001a440: 6573 706f 6e73 652e 7374 6174 7573 5f63  esponse.status_c
+0001a450: 6f64 6520 3d3d 2032 3030 0a20 2020 2020  ode == 200.     
+0001a460: 2020 2020 2020 2073 696e 676c 655f 7661         single_va
+0001a470: 7220 3d20 7265 7370 6f6e 7365 2e6a 736f  r = response.jso
+0001a480: 6e28 295b 2273 696e 676c 655f 7661 7222  n()["single_var"
+0001a490: 5d0a 2020 2020 2020 2020 2020 2020 6173  ].            as
+0001a4a0: 7365 7274 2073 696e 676c 655f 7661 725b  sert single_var[
+0001a4b0: 226e 616d 6522 5d20 3d3d 2022 6466 3322  "name"] == "df3"
+0001a4c0: 0a20 2020 2020 2020 2020 2020 2061 7373  .            ass
+0001a4d0: 6572 7420 7369 6e67 6c65 5f76 6172 5b22  ert single_var["
+0001a4e0: 7479 7065 225d 203d 3d20 2244 6174 6146  type"] == "DataF
+0001a4f0: 7261 6d65 220a 2020 2020 2020 2020 2020  rame".          
+0001a500: 2020 6173 7365 7274 2073 696e 676c 655f    assert single_
+0001a510: 7661 725b 2276 616c 7565 225d 5b22 6d75  var["value"]["mu
+0001a520: 6c74 695f 7661 6c75 6522 5d5b 2263 6f6c  lti_value"]["col
+0001a530: 756d 6e5f 636f 756e 7422 5d20 3d3d 2035  umn_count"] == 5
+0001a540: 0a20 2020 2020 2020 2020 2020 2061 7373  .            ass
+0001a550: 6572 7420 7369 6e67 6c65 5f76 6172 5b22  ert single_var["
+0001a560: 7661 6c75 6522 5d5b 226d 756c 7469 5f76  value"]["multi_v
+0001a570: 616c 7565 225d 5b22 726f 775f 636f 756e  alue"]["row_coun
+0001a580: 7422 5d20 3d3d 2031 3530 0a20 2020 2020  t"] == 150.     
+0001a590: 2020 2020 2020 2061 7373 6572 7420 7369         assert si
+0001a5a0: 6e67 6c65 5f76 6172 5b22 7661 6c75 6522  ngle_var["value"
+0001a5b0: 5d5b 226d 756c 7469 5f76 616c 7565 225d  ]["multi_value"]
+0001a5c0: 5b22 636f 6c75 6d6e 5f6e 616d 6573 225d  ["column_names"]
+0001a5d0: 203d 3d20 5b0a 2020 2020 2020 2020 2020   == [.          
+0001a5e0: 2020 2020 2020 7374 7228 6929 2066 6f72        str(i) for
+0001a5f0: 2069 2069 6e20 7261 6e67 6528 3529 0a20   i in range(5). 
+0001a600: 2020 2020 2020 2020 2020 205d 0a20 2020             ].   
+0001a610: 2020 2020 2020 2020 2061 7373 6572 7420           assert 
+0001a620: 7369 6e67 6c65 5f76 6172 5b22 7661 6c75  single_var["valu
+0001a630: 6522 5d5b 226d 756c 7469 5f76 616c 7565  e"]["multi_value
+0001a640: 225d 5b22 6461 7461 225d 203d 3d20 5b5d  "]["data"] == []
+0001a650: 0a20 2020 2020 2020 2020 2020 2061 7373  .            ass
+0001a660: 6572 7420 7369 6e67 6c65 5f76 6172 5b22  ert single_var["
+0001a670: 7375 6d6d 6172 7922 5d20 3d3d 2022 5369  summary"] == "Si
+0001a680: 7a65 3a20 3135 3078 3520 4d65 6d6f 7279  ze: 150x5 Memory
+0001a690: 3a20 352e 3938 204b 4222 0a20 2020 2020  : 5.98 KB".     
+0001a6a0: 2020 2020 2020 2061 7373 6572 7420 7369         assert si
+0001a6b0: 6e67 6c65 5f76 6172 5b22 6162 6272 6576  ngle_var["abbrev
+0001a6c0: 6961 7465 6422 5d20 6973 2046 616c 7365  iated"] is False
+0001a6d0: 0a20 2020 2020 2020 2020 2020 2061 7373  .            ass
+0001a6e0: 6572 7420 7369 6e67 6c65 5f76 6172 5b22  ert single_var["
+0001a6f0: 6861 735f 6e65 7874 5f70 6167 6522 5d20  has_next_page"] 
+0001a700: 6973 2046 616c 7365 0a0a 2020 2020 2020  is False..      
+0001a710: 2020 2020 2020 2320 5368 6f75 6c64 6e27        # Shouldn'
+0001a720: 7420 6861 7665 2063 6861 6e67 6564 2061  t have changed a
+0001a730: 6e79 7468 696e 6720 696e 2074 6865 2063  nything in the c
+0001a740: 7572 7265 6e74 2076 6172 730a 2020 2020  urrent vars.    
+0001a750: 2020 2020 2020 2020 7265 7370 6f6e 7365          response
+0001a760: 203d 2061 7761 6974 2063 6c69 656e 742e   = await client.
+0001a770: 6765 7428 0a20 2020 2020 2020 2020 2020  get(.           
+0001a780: 2020 2020 2066 222f 6e6f 7465 626f 6f6b       f"/notebook
+0001a790: 732f 7b75 7569 647d 2f76 6172 7322 2c20  s/{uuid}/vars", 
+0001a7a0: 6865 6164 6572 733d 7375 7065 7275 7365  headers=superuse
+0001a7b0: 725f 746f 6b65 6e5f 6865 6164 6572 730a  r_token_headers.
+0001a7c0: 2020 2020 2020 2020 2020 2020 290a 2020              ).  
+0001a7d0: 2020 2020 2020 2020 2020 6173 7365 7274            assert
+0001a7e0: 2072 6573 706f 6e73 652e 7374 6174 7573   response.status
+0001a7f0: 5f63 6f64 6520 3d3d 2032 3030 0a20 2020  _code == 200.   
+0001a800: 2020 2020 2020 2020 2063 7572 7265 6e74           current
+0001a810: 5f76 6172 7320 3d20 7265 7370 6f6e 7365  _vars = response
+0001a820: 2e6a 736f 6e28 295b 2276 6172 7322 5d0a  .json()["vars"].
+0001a830: 2020 2020 2020 2020 2020 2020 6375 7272              curr
+0001a840: 656e 745f 7661 7273 203d 2066 696c 7465  ent_vars = filte
+0001a850: 7228 0a20 2020 2020 2020 2020 2020 2020  r(.             
+0001a860: 2020 206c 616d 6264 6120 783a 2078 5b22     lambda x: x["
+0001a870: 6e61 6d65 225d 2021 3d20 225f 5f5f 6431  name"] != "___d1
+0001a880: 6f73 222c 2063 7572 7265 6e74 5f76 6172  os", current_var
+0001a890: 730a 2020 2020 2020 2020 2020 2020 290a  s.            ).
+0001a8a0: 2020 2020 2020 2020 2020 2020 6173 7365              asse
+0001a8b0: 7274 206c 6973 7428 6375 7272 656e 745f  rt list(current_
+0001a8c0: 7661 7273 2920 3d3d 2064 6174 615b 2276  vars) == data["v
+0001a8d0: 6172 7322 5d0a 0a20 2020 2020 2020 2020  ars"]..         
+0001a8e0: 2020 2023 2056 6172 2074 6861 7420 646f     # Var that do
+0001a8f0: 6573 6e27 7420 6578 6973 740a 2020 2020  esn't exist.    
+0001a900: 2020 2020 2020 2020 7265 7370 6f6e 7365          response
+0001a910: 203d 2061 7761 6974 2063 6c69 656e 742e   = await client.
+0001a920: 6765 7428 0a20 2020 2020 2020 2020 2020  get(.           
+0001a930: 2020 2020 2066 222f 6e6f 7465 626f 6f6b       f"/notebook
+0001a940: 732f 7b75 7569 647d 2f76 6172 732f 6466  s/{uuid}/vars/df
+0001a950: 3222 2c20 6865 6164 6572 733d 7375 7065  2", headers=supe
+0001a960: 7275 7365 725f 746f 6b65 6e5f 6865 6164  ruser_token_head
+0001a970: 6572 730a 2020 2020 2020 2020 2020 2020  ers.            
+0001a980: 290a 2020 2020 2020 2020 2020 2020 6173  ).            as
+0001a990: 7365 7274 2072 6573 706f 6e73 652e 7374  sert response.st
+0001a9a0: 6174 7573 5f63 6f64 6520 3d3d 2034 3034  atus_code == 404
+0001a9b0: 0a0a 2020 2020 4070 7974 6573 742e 6d61  ..    @pytest.ma
+0001a9c0: 726b 2e61 7379 6e63 696f 0a20 2020 2061  rk.asyncio.    a
+0001a9d0: 7379 6e63 2064 6566 2074 6573 745f 6765  sync def test_ge
+0001a9e0: 745f 7369 6e67 6c65 5f76 6172 5f64 6574  t_single_var_det
+0001a9f0: 6169 6c5f 725f 6b65 726e 656c 280a 2020  ail_r_kernel(.  
+0001aa00: 2020 2020 2020 7365 6c66 2c20 636c 6965        self, clie
+0001aa10: 6e74 3a20 5465 7374 436c 6965 6e74 2c20  nt: TestClient, 
+0001aa20: 7375 7065 7275 7365 725f 746f 6b65 6e5f  superuser_token_
+0001aa30: 6865 6164 6572 733a 2044 6963 745b 7374  headers: Dict[st
+0001aa40: 722c 2073 7472 5d0a 2020 2020 293a 0a20  r, str].    ):. 
+0001aa50: 2020 2020 2020 2022 2222 0a20 2020 2020         """.     
+0001aa60: 2020 2052 204b 6572 6e65 6c20 6c61 7267     R Kernel larg
+0001aa70: 6520 6461 7461 6672 616d 6520 6973 2061  e dataframe is a
+0001aa80: 6262 7265 7669 6174 6564 2069 6e20 7375  bbreviated in su
+0001aa90: 6d6d 6172 792c 206e 6f74 2069 6e20 7661  mmary, not in va
+0001aaa0: 7269 6162 6c65 0a20 2020 2020 2020 2064  riable.        d
+0001aab0: 6574 6169 6c73 2072 6571 7565 7374 2e0a  etails request..
+0001aac0: 2020 2020 2020 2020 2222 220a 2020 2020          """.    
+0001aad0: 2020 2020 7575 6964 203d 2061 7761 6974      uuid = await
+0001aae0: 2075 706c 6f61 645f 6e6f 7465 626f 6f6b   upload_notebook
+0001aaf0: 280a 2020 2020 2020 2020 2020 2020 636c  (.            cl
+0001ab00: 6965 6e74 2c20 7375 7065 7275 7365 725f  ient, superuser_
+0001ab10: 746f 6b65 6e5f 6865 6164 6572 732c 2022  token_headers, "
+0001ab20: 7369 6d70 6c65 5f72 2e69 7079 6e62 220a  simple_r.ipynb".
+0001ab30: 2020 2020 2020 2020 290a 0a20 2020 2020          )..     
+0001ab40: 2020 2023 2067 6574 2061 6e20 6578 6973     # get an exis
+0001ab50: 7469 6e67 2063 656c 6c0a 2020 2020 2020  ting cell.      
+0001ab60: 2020 7265 7370 6f6e 7365 203d 2061 7761    response = awa
+0001ab70: 6974 2063 6c69 656e 742e 6765 7428 0a20  it client.get(. 
+0001ab80: 2020 2020 2020 2020 2020 2066 222f 6e6f             f"/no
+0001ab90: 7465 626f 6f6b 732f 7b75 7569 647d 2f63  tebooks/{uuid}/c
+0001aba0: 656c 6c73 222c 2068 6561 6465 7273 3d73  ells", headers=s
+0001abb0: 7570 6572 7573 6572 5f74 6f6b 656e 5f68  uperuser_token_h
+0001abc0: 6561 6465 7273 0a20 2020 2020 2020 2029  eaders.        )
+0001abd0: 0a20 2020 2020 2020 2061 7373 6572 7420  .        assert 
+0001abe0: 7265 7370 6f6e 7365 2e73 7461 7475 735f  response.status_
+0001abf0: 636f 6465 203d 3d20 3230 300a 2020 2020  code == 200.    
+0001ac00: 2020 2020 6365 6c6c 7320 3d20 7265 7370      cells = resp
+0001ac10: 6f6e 7365 2e6a 736f 6e28 295b 2263 656c  onse.json()["cel
+0001ac20: 6c73 225d 0a20 2020 2020 2020 2061 7373  ls"].        ass
+0001ac30: 6572 7420 6365 6c6c 735b 315d 5b22 736f  ert cells[1]["so
+0001ac40: 7572 6365 225d 203d 3d20 2266 203c 2d20  urce"] == "f <- 
+0001ac50: 3534 3322 0a0a 2020 2020 2020 2020 6365  543"..        ce
+0001ac60: 6c6c 5f75 7569 6420 3d20 6365 6c6c 735b  ll_uuid = cells[
+0001ac70: 315d 5b22 6d65 7461 6461 7461 225d 5b22  1]["metadata"]["
+0001ac80: 6a75 7079 7465 725f 6431 225d 5b22 7575  jupyter_d1"]["uu
+0001ac90: 6964 225d 0a0a 2020 2020 2020 2020 7061  id"]..        pa
+0001aca0: 7261 6d73 203d 207b 2273 6f75 7263 6522  rams = {"source"
+0001acb0: 3a20 226b 6f6f 6c20 3d20 6461 7461 2e66  : "kool = data.f
+0001acc0: 7261 6d65 2863 6f6c 313d 6328 313a 3135  rame(col1=c(1:15
+0001acd0: 3029 2c20 636f 6c32 3d63 2831 3530 3a31  0), col2=c(150:1
+0001ace0: 2929 227d 0a20 2020 2020 2020 2072 6573  ))"}.        res
+0001acf0: 706f 6e73 6520 3d20 6177 6169 7420 636c  ponse = await cl
+0001ad00: 6965 6e74 2e70 6174 6368 280a 2020 2020  ient.patch(.    
+0001ad10: 2020 2020 2020 2020 6622 2f6e 6f74 6562          f"/noteb
+0001ad20: 6f6f 6b73 2f7b 7575 6964 7d2f 6365 6c6c  ooks/{uuid}/cell
+0001ad30: 732f 7b63 656c 6c5f 7575 6964 7d22 2c0a  s/{cell_uuid}",.
+0001ad40: 2020 2020 2020 2020 2020 2020 6a73 6f6e              json
+0001ad50: 3d70 6172 616d 732c 0a20 2020 2020 2020  =params,.       
+0001ad60: 2020 2020 2068 6561 6465 7273 3d73 7570       headers=sup
+0001ad70: 6572 7573 6572 5f74 6f6b 656e 5f68 6561  eruser_token_hea
+0001ad80: 6465 7273 2c0a 2020 2020 2020 2020 290a  ders,.        ).
+0001ad90: 2020 2020 2020 2020 6173 7365 7274 2072          assert r
+0001ada0: 6573 706f 6e73 652e 7374 6174 7573 5f63  esponse.status_c
+0001adb0: 6f64 6520 3d3d 2032 3030 0a0a 2020 2020  ode == 200..    
+0001adc0: 2020 2020 7265 7370 6f6e 7365 203d 2061      response = a
+0001add0: 7761 6974 2063 6c69 656e 742e 6765 7428  wait client.get(
+0001ade0: 0a20 2020 2020 2020 2020 2020 2066 222f  .            f"/
+0001adf0: 6e6f 7465 626f 6f6b 732f 7b75 7569 647d  notebooks/{uuid}
+0001ae00: 2f76 6172 7322 2c20 6865 6164 6572 733d  /vars", headers=
+0001ae10: 7375 7065 7275 7365 725f 746f 6b65 6e5f  superuser_token_
+0001ae20: 6865 6164 6572 730a 2020 2020 2020 2020  headers.        
+0001ae30: 290a 2020 2020 2020 2020 6173 7365 7274  ).        assert
+0001ae40: 2072 6573 706f 6e73 652e 7374 6174 7573   response.status
+0001ae50: 5f63 6f64 6520 3d3d 2032 3030 0a20 2020  _code == 200.   
+0001ae60: 2020 2020 2061 7373 6572 7420 6c65 6e28       assert len(
+0001ae70: 7265 7370 6f6e 7365 2e6a 736f 6e28 295b  response.json()[
+0001ae80: 2276 6172 7322 5d29 203d 3d20 300a 0a20  "vars"]) == 0.. 
+0001ae90: 2020 2020 2020 2061 7379 6e63 2077 6974         async wit
+0001aea0: 6820 636c 6965 6e74 2e77 6562 736f 636b  h client.websock
+0001aeb0: 6574 5f63 6f6e 6e65 6374 280a 2020 2020  et_connect(.    
+0001aec0: 2020 2020 2020 2020 6622 2f6e 6f74 6562          f"/noteb
+0001aed0: 6f6f 6b73 2f7b 7575 6964 7d2f 7773 2f6e  ooks/{uuid}/ws/n
+0001aee0: 6f74 6562 6f6f 6b22 2c20 6865 6164 6572  otebook", header
+0001aef0: 733d 7375 7065 7275 7365 725f 746f 6b65  s=superuser_toke
+0001af00: 6e5f 6865 6164 6572 730a 2020 2020 2020  n_headers.      
+0001af10: 2020 2920 6173 2077 6562 736f 636b 6574    ) as websocket
+0001af20: 3a0a 2020 2020 2020 2020 2020 2020 6177  :.            aw
+0001af30: 6169 7420 6173 796e 6369 6f2e 736c 6565  ait asyncio.slee
+0001af40: 7028 5745 4253 4f43 4b45 545f 534c 4545  p(WEBSOCKET_SLEE
+0001af50: 505f 5449 4d45 290a 0a20 2020 2020 2020  P_TIME)..       
+0001af60: 2020 2020 2072 6573 706f 6e73 6520 3d20       response = 
+0001af70: 6177 6169 7420 636c 6965 6e74 2e67 6574  await client.get
+0001af80: 280a 2020 2020 2020 2020 2020 2020 2020  (.              
+0001af90: 2020 6622 2f6e 6f74 6562 6f6f 6b73 2f7b    f"/notebooks/{
+0001afa0: 7575 6964 7d2f 6365 6c6c 732f 7b63 656c  uuid}/cells/{cel
+0001afb0: 6c5f 7575 6964 7d2f 6578 6563 7574 6522  l_uuid}/execute"
+0001afc0: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
+0001afd0: 2020 6865 6164 6572 733d 7375 7065 7275    headers=superu
+0001afe0: 7365 725f 746f 6b65 6e5f 6865 6164 6572  ser_token_header
+0001aff0: 732c 0a20 2020 2020 2020 2020 2020 2029  s,.            )
+0001b000: 0a20 2020 2020 2020 2020 2020 2061 7373  .            ass
+0001b010: 6572 7420 7265 7370 6f6e 7365 2e73 7461  ert response.sta
+0001b020: 7475 735f 636f 6465 203d 3d20 3230 300a  tus_code == 200.
+0001b030: 0a20 2020 2020 2020 2020 2020 2023 204b  .            # K
+0001b040: 6572 6e65 6c20 7661 7273 2075 7064 6174  ernel vars updat
+0001b050: 650a 2020 2020 2020 2020 2020 2020 6461  e.            da
+0001b060: 7461 203d 2061 7761 6974 2072 6563 6569  ta = await recei
+0001b070: 7665 5f6a 736f 6e28 7765 6273 6f63 6b65  ve_json(websocke
+0001b080: 742c 206d 7367 5f74 7970 6573 3d5b 2276  t, msg_types=["v
+0001b090: 6172 7322 5d29 0a20 2020 2020 2020 2020  ars"]).         
+0001b0a0: 2020 2076 6172 7320 3d20 7b76 6172 5b22     vars = {var["
+0001b0b0: 6e61 6d65 225d 3a20 7661 7220 666f 7220  name"]: var for 
+0001b0c0: 7661 7220 696e 2064 6174 615b 2276 6172  var in data["var
+0001b0d0: 7322 5d7d 0a0a 2020 2020 2020 2020 2020  s"]}..          
+0001b0e0: 2020 6173 7365 7274 2076 6172 735b 226b    assert vars["k
+0001b0f0: 6f6f 6c22 5d5b 2274 7970 6522 5d20 3d3d  ool"]["type"] ==
+0001b100: 2022 6461 7461 2e66 7261 6d65 220a 2020   "data.frame".  
+0001b110: 2020 2020 2020 2020 2020 6173 7365 7274            assert
+0001b120: 2076 6172 735b 226b 6f6f 6c22 5d5b 2276   vars["kool"]["v
+0001b130: 616c 7565 225d 5b22 6d75 6c74 695f 7661  alue"]["multi_va
+0001b140: 6c75 6522 5d5b 2263 6f6c 756d 6e5f 636f  lue"]["column_co
+0001b150: 756e 7422 5d20 3d3d 2032 0a20 2020 2020  unt"] == 2.     
+0001b160: 2020 2020 2020 2061 7373 6572 7420 7661         assert va
+0001b170: 7273 5b22 6b6f 6f6c 225d 5b22 7661 6c75  rs["kool"]["valu
+0001b180: 6522 5d5b 226d 756c 7469 5f76 616c 7565  e"]["multi_value
+0001b190: 225d 5b22 726f 775f 636f 756e 7422 5d20  "]["row_count"] 
+0001b1a0: 3d3d 2031 3530 0a20 2020 2020 2020 2020  == 150.         
+0001b1b0: 2020 2061 7373 6572 7420 7661 7273 5b22     assert vars["
+0001b1c0: 6b6f 6f6c 225d 5b22 7661 6c75 6522 5d5b  kool"]["value"][
+0001b1d0: 226d 756c 7469 5f76 616c 7565 225d 5b22  "multi_value"]["
+0001b1e0: 636f 6c75 6d6e 5f6e 616d 6573 225d 203d  column_names"] =
+0001b1f0: 3d20 5b0a 2020 2020 2020 2020 2020 2020  = [.            
+0001b200: 2020 2020 2263 6f6c 3120 2869 6e74 6567      "col1 (integ
+0001b210: 6572 2922 2c0a 2020 2020 2020 2020 2020  er)",.          
+0001b220: 2020 2020 2020 2263 6f6c 3220 2869 6e74        "col2 (int
+0001b230: 6567 6572 2922 2c0a 2020 2020 2020 2020  eger)",.        
+0001b240: 2020 2020 5d0a 2020 2020 2020 2020 2020      ].          
+0001b250: 2020 6173 7365 7274 2076 6172 735b 226b    assert vars["k
+0001b260: 6f6f 6c22 5d5b 2276 616c 7565 225d 5b22  ool"]["value"]["
+0001b270: 6d75 6c74 695f 7661 6c75 6522 5d5b 2264  multi_value"]["d
+0001b280: 6174 6122 5d20 3d3d 205b 0a20 2020 2020  ata"] == [.     
+0001b290: 2020 2020 2020 2020 2020 205b 7374 7228             [str(
+0001b2a0: 6920 2b20 3129 2c20 7374 7228 3135 3020  i + 1), str(150 
+0001b2b0: 2d20 6929 5d20 666f 7220 6920 696e 2072  - i)] for i in r
+0001b2c0: 616e 6765 2832 3529 0a20 2020 2020 2020  ange(25).       
+0001b2d0: 2020 2020 205d 0a20 2020 2020 2020 2020       ].         
+0001b2e0: 2020 2061 7373 6572 7420 2253 697a 653a     assert "Size:
+0001b2f0: 2031 3530 7832 204d 656d 6f72 793a 2220   150x2 Memory:" 
+0001b300: 696e 2076 6172 735b 226b 6f6f 6c22 5d5b  in vars["kool"][
+0001b310: 2273 756d 6d61 7279 225d 0a20 2020 2020  "summary"].     
+0001b320: 2020 2020 2020 2061 7373 6572 7420 7661         assert va
+0001b330: 7273 5b22 6b6f 6f6c 225d 5b22 6162 6272  rs["kool"]["abbr
+0001b340: 6576 6961 7465 6422 5d20 6973 2054 7275  eviated"] is Tru
+0001b350: 650a 0a20 2020 2020 2020 2020 2020 2072  e..            r
+0001b360: 6573 706f 6e73 6520 3d20 6177 6169 7420  esponse = await 
+0001b370: 636c 6965 6e74 2e67 6574 280a 2020 2020  client.get(.    
+0001b380: 2020 2020 2020 2020 2020 2020 6622 2f6e              f"/n
+0001b390: 6f74 6562 6f6f 6b73 2f7b 7575 6964 7d2f  otebooks/{uuid}/
+0001b3a0: 7661 7273 222c 2068 6561 6465 7273 3d73  vars", headers=s
+0001b3b0: 7570 6572 7573 6572 5f74 6f6b 656e 5f68  uperuser_token_h
+0001b3c0: 6561 6465 7273 0a20 2020 2020 2020 2020  eaders.         
+0001b3d0: 2020 2029 0a20 2020 2020 2020 2020 2020     ).           
+0001b3e0: 2061 7373 6572 7420 7265 7370 6f6e 7365   assert response
+0001b3f0: 2e73 7461 7475 735f 636f 6465 203d 3d20  .status_code == 
+0001b400: 3230 300a 2020 2020 2020 2020 2020 2020  200.            
+0001b410: 6375 7272 656e 745f 7661 7273 203d 2072  current_vars = r
+0001b420: 6573 706f 6e73 652e 6a73 6f6e 2829 5b22  esponse.json()["
+0001b430: 7661 7273 225d 0a20 2020 2020 2020 2020  vars"].         
+0001b440: 2020 2061 7373 6572 7420 6c69 7374 2863     assert list(c
+0001b450: 7572 7265 6e74 5f76 6172 7329 203d 3d20  urrent_vars) == 
+0001b460: 6461 7461 5b22 7661 7273 225d 0a0a 2020  data["vars"]..  
+0001b470: 2020 2020 2020 2020 2020 7265 7370 6f6e            respon
+0001b480: 7365 203d 2061 7761 6974 2063 6c69 656e  se = await clien
+0001b490: 742e 6765 7428 0a20 2020 2020 2020 2020  t.get(.         
+0001b4a0: 2020 2020 2020 2066 222f 6e6f 7465 626f         f"/notebo
+0001b4b0: 6f6b 732f 7b75 7569 647d 2f76 6172 732f  oks/{uuid}/vars/
+0001b4c0: 6b6f 6f6c 222c 2068 6561 6465 7273 3d73  kool", headers=s
+0001b4d0: 7570 6572 7573 6572 5f74 6f6b 656e 5f68  uperuser_token_h
+0001b4e0: 6561 6465 7273 0a20 2020 2020 2020 2020  eaders.         
+0001b4f0: 2020 2029 0a20 2020 2020 2020 2020 2020     ).           
+0001b500: 2061 7373 6572 7420 7265 7370 6f6e 7365   assert response
+0001b510: 2e73 7461 7475 735f 636f 6465 203d 3d20  .status_code == 
+0001b520: 3230 300a 2020 2020 2020 2020 2020 2020  200.            
+0001b530: 7369 6e67 6c65 5f76 6172 203d 2072 6573  single_var = res
+0001b540: 706f 6e73 652e 6a73 6f6e 2829 5b22 7369  ponse.json()["si
+0001b550: 6e67 6c65 5f76 6172 225d 0a20 2020 2020  ngle_var"].     
+0001b560: 2020 2020 2020 2061 7373 6572 7420 7369         assert si
+0001b570: 6e67 6c65 5f76 6172 5b22 6e61 6d65 225d  ngle_var["name"]
+0001b580: 203d 3d20 226b 6f6f 6c22 0a20 2020 2020   == "kool".     
+0001b590: 2020 2020 2020 2061 7373 6572 7420 7369         assert si
+0001b5a0: 6e67 6c65 5f76 6172 5b22 7479 7065 225d  ngle_var["type"]
+0001b5b0: 203d 3d20 2264 6174 612e 6672 616d 6522   == "data.frame"
+0001b5c0: 0a20 2020 2020 2020 2020 2020 2061 7373  .            ass
+0001b5d0: 6572 7420 7369 6e67 6c65 5f76 6172 5b22  ert single_var["
+0001b5e0: 7661 6c75 6522 5d5b 226d 756c 7469 5f76  value"]["multi_v
+0001b5f0: 616c 7565 225d 5b22 636f 6c75 6d6e 5f63  alue"]["column_c
+0001b600: 6f75 6e74 225d 203d 3d20 320a 2020 2020  ount"] == 2.    
+0001b610: 2020 2020 2020 2020 6173 7365 7274 2073          assert s
+0001b620: 696e 676c 655f 7661 725b 2276 616c 7565  ingle_var["value
+0001b630: 225d 5b22 6d75 6c74 695f 7661 6c75 6522  "]["multi_value"
+0001b640: 5d5b 2272 6f77 5f63 6f75 6e74 225d 203d  ]["row_count"] =
+0001b650: 3d20 3135 300a 2020 2020 2020 2020 2020  = 150.          
+0001b660: 2020 6173 7365 7274 2073 696e 676c 655f    assert single_
+0001b670: 7661 725b 2276 616c 7565 225d 5b22 6d75  var["value"]["mu
+0001b680: 6c74 695f 7661 6c75 6522 5d5b 2263 6f6c  lti_value"]["col
+0001b690: 756d 6e5f 6e61 6d65 7322 5d20 3d3d 205b  umn_names"] == [
+0001b6a0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+0001b6b0: 2022 636f 6c31 2028 696e 7465 6765 7229   "col1 (integer)
+0001b6c0: 222c 0a20 2020 2020 2020 2020 2020 2020  ",.             
+0001b6d0: 2020 2022 636f 6c32 2028 696e 7465 6765     "col2 (intege
+0001b6e0: 7229 222c 0a20 2020 2020 2020 2020 2020  r)",.           
+0001b6f0: 205d 0a20 2020 2020 2020 2020 2020 2061   ].            a
+0001b700: 7373 6572 7420 7369 6e67 6c65 5f76 6172  ssert single_var
+0001b710: 5b22 7661 6c75 6522 5d5b 226d 756c 7469  ["value"]["multi
+0001b720: 5f76 616c 7565 225d 5b22 6461 7461 225d  _value"]["data"]
+0001b730: 203d 3d20 5b0a 2020 2020 2020 2020 2020   == [.          
+0001b740: 2020 2020 2020 5b73 7472 2869 202b 2031        [str(i + 1
+0001b750: 292c 2073 7472 2831 3530 202d 2069 295d  ), str(150 - i)]
+0001b760: 2066 6f72 2069 2069 6e20 7261 6e67 6528   for i in range(
+0001b770: 3135 3029 0a20 2020 2020 2020 2020 2020  150).           
+0001b780: 205d 0a20 2020 2020 2020 2020 2020 2061   ].            a
+0001b790: 7373 6572 7420 2253 697a 653a 2031 3530  ssert "Size: 150
+0001b7a0: 7832 204d 656d 6f72 793a 2220 696e 2073  x2 Memory:" in s
+0001b7b0: 696e 676c 655f 7661 725b 2273 756d 6d61  ingle_var["summa
+0001b7c0: 7279 225d 0a20 2020 2020 2020 2020 2020  ry"].           
+0001b7d0: 2061 7373 6572 7420 7369 6e67 6c65 5f76   assert single_v
+0001b7e0: 6172 5b22 6162 6272 6576 6961 7465 6422  ar["abbreviated"
+0001b7f0: 5d20 6973 2046 616c 7365 0a0a 2020 2020  ] is False..    
+0001b800: 2020 2020 2020 2020 2320 5368 6f75 6c64          # Should
+0001b810: 6e27 7420 6861 7665 2063 6861 6e67 6564  n't have changed
+0001b820: 2061 6e79 7468 696e 6720 696e 2074 6865   anything in the
+0001b830: 2063 7572 7265 6e74 2076 6172 730a 2020   current vars.  
+0001b840: 2020 2020 2020 2020 2020 7265 7370 6f6e            respon
+0001b850: 7365 203d 2061 7761 6974 2063 6c69 656e  se = await clien
+0001b860: 742e 6765 7428 0a20 2020 2020 2020 2020  t.get(.         
+0001b870: 2020 2020 2020 2066 222f 6e6f 7465 626f         f"/notebo
+0001b880: 6f6b 732f 7b75 7569 647d 2f76 6172 7322  oks/{uuid}/vars"
+0001b890: 2c20 6865 6164 6572 733d 7375 7065 7275  , headers=superu
+0001b8a0: 7365 725f 746f 6b65 6e5f 6865 6164 6572  ser_token_header
+0001b8b0: 730a 2020 2020 2020 2020 2020 2020 290a  s.            ).
+0001b8c0: 2020 2020 2020 2020 2020 2020 6173 7365              asse
+0001b8d0: 7274 2072 6573 706f 6e73 652e 7374 6174  rt response.stat
+0001b8e0: 7573 5f63 6f64 6520 3d3d 2032 3030 0a20  us_code == 200. 
+0001b8f0: 2020 2020 2020 2020 2020 2063 7572 7265             curre
+0001b900: 6e74 5f76 6172 7320 3d20 7265 7370 6f6e  nt_vars = respon
+0001b910: 7365 2e6a 736f 6e28 295b 2276 6172 7322  se.json()["vars"
+0001b920: 5d0a 2020 2020 2020 2020 2020 2020 6173  ].            as
+0001b930: 7365 7274 206c 6973 7428 6375 7272 656e  sert list(curren
+0001b940: 745f 7661 7273 2920 3d3d 2064 6174 615b  t_vars) == data[
+0001b950: 2276 6172 7322 5d0a 0a20 2020 2020 2020  "vars"]..       
+0001b960: 2020 2020 2023 2056 6172 2074 6861 7420       # Var that 
+0001b970: 646f 6573 6e27 7420 6578 6973 740a 2020  doesn't exist.  
+0001b980: 2020 2020 2020 2020 2020 7265 7370 6f6e            respon
+0001b990: 7365 203d 2061 7761 6974 2063 6c69 656e  se = await clien
+0001b9a0: 742e 6765 7428 0a20 2020 2020 2020 2020  t.get(.         
+0001b9b0: 2020 2020 2020 2066 222f 6e6f 7465 626f         f"/notebo
+0001b9c0: 6f6b 732f 7b75 7569 647d 2f76 6172 732f  oks/{uuid}/vars/
+0001b9d0: 6466 3222 2c20 6865 6164 6572 733d 7375  df2", headers=su
+0001b9e0: 7065 7275 7365 725f 746f 6b65 6e5f 6865  peruser_token_he
+0001b9f0: 6164 6572 730a 2020 2020 2020 2020 2020  aders.          
+0001ba00: 2020 290a 2020 2020 2020 2020 2020 2020    ).            
+0001ba10: 6173 7365 7274 2072 6573 706f 6e73 652e  assert response.
+0001ba20: 7374 6174 7573 5f63 6f64 6520 3d3d 2034  status_code == 4
+0001ba30: 3034 0a0a 0a40 7079 7465 7374 2e6d 6172  04...@pytest.mar
+0001ba40: 6b2e 7573 6566 6978 7475 7265 7328 2263  k.usefixtures("c
+0001ba50: 6c65 6172 5f6e 6f74 6562 6f6f 6b73 222c  lear_notebooks",
+0001ba60: 2022 636c 6561 725f 6e6f 7465 626f 6f6b   "clear_notebook
+0001ba70: 5f64 6972 6563 746f 7279 2229 0a63 6c61  _directory").cla
+0001ba80: 7373 2054 6573 7457 6f72 6b69 6e67 4469  ss TestWorkingDi
+0001ba90: 7265 6374 6f72 793a 0a20 2020 2061 7379  rectory:.    asy
+0001baa0: 6e63 2064 6566 2061 7373 6572 745f 7079  nc def assert_py
+0001bab0: 7468 6f6e 5f77 6f72 6b69 6e67 5f64 6972  thon_working_dir
+0001bac0: 6563 746f 7279 280a 2020 2020 2020 2020  ectory(.        
+0001bad0: 7365 6c66 2c0a 2020 2020 2020 2020 636c  self,.        cl
+0001bae0: 6965 6e74 3a20 5465 7374 436c 6965 6e74  ient: TestClient
+0001baf0: 2c0a 2020 2020 2020 2020 7375 7065 7275  ,.        superu
+0001bb00: 7365 725f 746f 6b65 6e5f 6865 6164 6572  ser_token_header
+0001bb10: 733a 2044 6963 745b 7374 722c 2073 7472  s: Dict[str, str
+0001bb20: 5d2c 0a20 2020 2020 2020 206f 7065 6e5f  ],.        open_
+0001bb30: 7061 7468 3a20 7374 722c 0a20 2020 2020  path: str,.     
+0001bb40: 2020 2077 6f72 6b69 6e67 5f64 6972 6563     working_direc
+0001bb50: 746f 7279 3a20 7374 722c 0a20 2020 2020  tory: str,.     
+0001bb60: 2020 2071 7565 7279 5f73 7472 696e 673a     query_string:
+0001bb70: 204f 7074 696f 6e61 6c5b 4469 6374 5b73   Optional[Dict[s
+0001bb80: 7472 2c20 416e 795d 5d20 3d20 4e6f 6e65  tr, Any]] = None
+0001bb90: 2c0a 2020 2020 293a 0a20 2020 2020 2020  ,.    ):.       
+0001bba0: 2022 2222 5465 7374 2074 6861 7420 7079   """Test that py
+0001bbb0: 7468 6f6e 206b 6572 6e65 6c20 6973 2073  thon kernel is s
+0001bbc0: 7461 7274 6564 2069 6e20 636f 7272 6563  tarted in correc
+0001bbd0: 7420 6469 7265 6374 6f72 792e 2222 220a  t directory.""".
+0001bbe0: 2020 2020 2020 2020 6966 2071 7565 7279          if query
+0001bbf0: 5f73 7472 696e 6720 6973 204e 6f6e 653a  _string is None:
+0001bc00: 0a20 2020 2020 2020 2020 2020 2071 7565  .            que
+0001bc10: 7279 5f73 7472 696e 6720 3d20 7b7d 0a20  ry_string = {}. 
+0001bc20: 2020 2020 2020 2071 7565 7279 5f73 7472         query_str
+0001bc30: 696e 675b 2266 696c 6570 6174 6822 5d20  ing["filepath"] 
+0001bc40: 3d20 6f70 656e 5f70 6174 680a 2020 2020  = open_path.    
+0001bc50: 2020 2020 7265 7370 6f6e 7365 203d 2061      response = a
+0001bc60: 7761 6974 2063 6c69 656e 742e 6765 7428  wait client.get(
+0001bc70: 0a20 2020 2020 2020 2020 2020 2066 222f  .            f"/
+0001bc80: 6e6f 7465 626f 6f6b 732f 6f70 656e 2f22  notebooks/open/"
+0001bc90: 2c0a 2020 2020 2020 2020 2020 2020 6865  ,.            he
+0001bca0: 6164 6572 733d 7375 7065 7275 7365 725f  aders=superuser_
+0001bcb0: 746f 6b65 6e5f 6865 6164 6572 732c 0a20  token_headers,. 
+0001bcc0: 2020 2020 2020 2020 2020 2071 7565 7279             query
+0001bcd0: 5f73 7472 696e 673d 7175 6572 795f 7374  _string=query_st
+0001bce0: 7269 6e67 2c0a 2020 2020 2020 2020 290a  ring,.        ).
+0001bcf0: 2020 2020 2020 2020 6173 7365 7274 2072          assert r
+0001bd00: 6573 706f 6e73 652e 7374 6174 7573 5f63  esponse.status_c
+0001bd10: 6f64 6520 3d3d 2032 3031 0a20 2020 2020  ode == 201.     
+0001bd20: 2020 2072 6573 705f 6a73 6f6e 203d 2072     resp_json = r
+0001bd30: 6573 706f 6e73 652e 6a73 6f6e 2829 5b22  esponse.json()["
+0001bd40: 6e6f 7465 626f 6f6b 225d 0a20 2020 2020  notebook"].     
+0001bd50: 2020 2075 7569 6420 3d20 7265 7370 5f6a     uuid = resp_j
+0001bd60: 736f 6e5b 226d 6574 6164 6174 6122 5d5b  son["metadata"][
+0001bd70: 226a 7570 7974 6572 5f64 3122 5d5b 2275  "jupyter_d1"]["u
+0001bd80: 7569 6422 5d0a 0a20 2020 2020 2020 2023  uid"]..        #
+0001bd90: 202f 746d 7020 7379 6d6c 696e 6b73 2074   /tmp symlinks t
+0001bda0: 6f20 2f70 7269 7661 7465 2f74 6d70 206f  o /private/tmp o
+0001bdb0: 6e20 6d61 632c 2073 6f20 7765 2072 6573  n mac, so we res
+0001bdc0: 6f6c 7665 0a20 2020 2020 2020 2072 6573  olve.        res
+0001bdd0: 6f6c 7665 645f 776f 726b 5f64 6972 203d  olved_work_dir =
+0001bde0: 2073 7472 2870 6174 686c 6962 2e50 6174   str(pathlib.Pat
+0001bdf0: 6828 776f 726b 696e 675f 6469 7265 6374  h(working_direct
+0001be00: 6f72 7929 2e72 6573 6f6c 7665 2829 290a  ory).resolve()).
+0001be10: 0a20 2020 2020 2020 2061 7373 6572 7420  .        assert 
+0001be20: 280a 2020 2020 2020 2020 2020 2020 7265  (.            re
+0001be30: 7370 5f6a 736f 6e5b 226d 6574 6164 6174  sp_json["metadat
+0001be40: 6122 5d5b 226a 7570 7974 6572 5f64 3122  a"]["jupyter_d1"
+0001be50: 5d5b 2277 6f72 6b69 6e67 5f64 6972 6563  ]["working_direc
+0001be60: 746f 7279 225d 0a20 2020 2020 2020 2020  tory"].         
+0001be70: 2020 203d 3d20 7265 736f 6c76 6564 5f77     == resolved_w
+0001be80: 6f72 6b5f 6469 720a 2020 2020 2020 2020  ork_dir.        
+0001be90: 290a 0a20 2020 2020 2020 2061 7379 6e63  )..        async
+0001bea0: 2077 6974 6820 636c 6965 6e74 2e77 6562   with client.web
+0001beb0: 736f 636b 6574 5f63 6f6e 6e65 6374 280a  socket_connect(.
+0001bec0: 2020 2020 2020 2020 2020 2020 6622 2f6e              f"/n
+0001bed0: 6f74 6562 6f6f 6b73 2f7b 7575 6964 7d2f  otebooks/{uuid}/
+0001bee0: 7773 2f6e 6f74 6562 6f6f 6b22 2c20 6865  ws/notebook", he
+0001bef0: 6164 6572 733d 7375 7065 7275 7365 725f  aders=superuser_
+0001bf00: 746f 6b65 6e5f 6865 6164 6572 730a 2020  token_headers.  
+0001bf10: 2020 2020 2020 2920 6173 2077 6562 736f        ) as webso
+0001bf20: 636b 6574 3a0a 2020 2020 2020 2020 2020  cket:.          
+0001bf30: 2020 6177 6169 7420 6173 796e 6369 6f2e    await asyncio.
+0001bf40: 736c 6565 7028 5745 4253 4f43 4b45 545f  sleep(WEBSOCKET_
+0001bf50: 534c 4545 505f 5449 4d45 290a 0a20 2020  SLEEP_TIME)..   
+0001bf60: 2020 2020 2020 2020 2072 6573 706f 6e73           respons
+0001bf70: 6520 3d20 6177 6169 7420 636c 6965 6e74  e = await client
+0001bf80: 2e70 6f73 7428 0a20 2020 2020 2020 2020  .post(.         
+0001bf90: 2020 2020 2020 2066 222f 6e6f 7465 626f         f"/notebo
+0001bfa0: 6f6b 732f 7b75 7569 647d 2f73 6372 6174  oks/{uuid}/scrat
+0001bfb0: 6368 5f65 7865 6375 7465 222c 0a20 2020  ch_execute",.   
+0001bfc0: 2020 2020 2020 2020 2020 2020 2068 6561               hea
+0001bfd0: 6465 7273 3d73 7570 6572 7573 6572 5f74  ders=superuser_t
+0001bfe0: 6f6b 656e 5f68 6561 6465 7273 2c0a 2020  oken_headers,.  
+0001bff0: 2020 2020 2020 2020 2020 2020 2020 6a73                js
+0001c000: 6f6e 3d7b 2263 6f64 6522 3a20 2269 6d70  on={"code": "imp
+0001c010: 6f72 7420 6f73 5c6e 6f73 2e67 6574 6377  ort os\nos.getcw
+0001c020: 6428 2922 7d2c 0a20 2020 2020 2020 2020  d()"},.         
+0001c030: 2020 2029 0a20 2020 2020 2020 2020 2020     ).           
+0001c040: 2061 7373 6572 7420 7265 7370 6f6e 7365   assert response
+0001c050: 2e73 7461 7475 735f 636f 6465 203d 3d20  .status_code == 
+0001c060: 3230 300a 2020 2020 2020 2020 2020 2020  200.            
+0001c070: 6d65 7373 6167 655f 6964 203d 2072 6573  message_id = res
+0001c080: 706f 6e73 652e 6a73 6f6e 2829 5b22 6b65  ponse.json()["ke
+0001c090: 726e 656c 5f6d 6573 7361 6765 225d 5b22  rnel_message"]["
+0001c0a0: 6d65 7373 6167 655f 6964 225d 0a0a 2020  message_id"]..  
+0001c0b0: 2020 2020 2020 2020 2020 2320 6669 7273            # firs
+0001c0c0: 7420 6368 756e 6b20 7265 6365 6976 6564  t chunk received
+0001c0d0: 2073 686f 756c 6420 6265 2061 2073 6372   should be a scr
+0001c0e0: 6174 6368 5f75 7064 6174 6520 7769 7468  atch_update with
+0001c0f0: 0a20 2020 2020 2020 2020 2020 2023 2061  .            # a
+0001c100: 6e20 6578 6563 7574 696f 6e5f 7374 6174  n execution_stat
+0001c110: 6520 6f66 2027 6275 7379 2720 7768 656e  e of 'busy' when
+0001c120: 2070 726f 6365 7373 696e 6720 7374 6172   processing star
+0001c130: 7473 0a20 2020 2020 2020 2020 2020 2064  ts.            d
+0001c140: 6174 6120 3d20 6177 6169 7420 7265 6365  ata = await rece
+0001c150: 6976 655f 6a73 6f6e 2877 6562 736f 636b  ive_json(websock
+0001c160: 6574 2c20 6d73 675f 7479 7065 733d 5b22  et, msg_types=["
+0001c170: 7363 7261 7463 685f 7570 6461 7465 225d  scratch_update"]
+0001c180: 290a 2020 2020 2020 2020 2020 2020 7363  ).            sc
+0001c190: 7261 7463 685f 7570 6461 7465 203d 2064  ratch_update = d
+0001c1a0: 6174 615b 2273 6372 6174 6368 5f75 7064  ata["scratch_upd
+0001c1b0: 6174 6522 5d0a 2020 2020 2020 2020 2020  ate"].          
+0001c1c0: 2020 6173 7365 7274 2073 6372 6174 6368    assert scratch
+0001c1d0: 5f75 7064 6174 655b 226d 6573 7361 6765  _update["message
+0001c1e0: 5f69 6422 5d20 3d3d 206d 6573 7361 6765  _id"] == message
+0001c1f0: 5f69 640a 2020 2020 2020 2020 2020 2020  _id.            
+0001c200: 6173 7365 7274 2073 6372 6174 6368 5f75  assert scratch_u
+0001c210: 7064 6174 655b 2265 7865 6375 7469 6f6e  pdate["execution
+0001c220: 5f73 7461 7465 225d 203d 3d20 2262 7573  _state"] == "bus
+0001c230: 7922 0a0a 2020 2020 2020 2020 2020 2020  y"..            
+0001c240: 2320 5265 6365 6976 6520 7363 7261 7463  # Receive scratc
+0001c250: 6820 6578 6563 7574 696f 6e20 6f75 7470  h execution outp
+0001c260: 7574 0a20 2020 2020 2020 2020 2020 2064  ut.            d
+0001c270: 6174 6120 3d20 6177 6169 7420 7265 6365  ata = await rece
+0001c280: 6976 655f 6a73 6f6e 2877 6562 736f 636b  ive_json(websock
+0001c290: 6574 2c20 6d73 675f 7479 7065 733d 5b22  et, msg_types=["
+0001c2a0: 7363 7261 7463 685f 7570 6461 7465 225d  scratch_update"]
+0001c2b0: 290a 2020 2020 2020 2020 2020 2020 7363  ).            sc
+0001c2c0: 7261 7463 685f 7570 6461 7465 203d 2064  ratch_update = d
+0001c2d0: 6174 615b 2273 6372 6174 6368 5f75 7064  ata["scratch_upd
+0001c2e0: 6174 6522 5d0a 0a20 2020 2020 2020 2020  ate"]..         
+0001c2f0: 2020 2065 7870 6563 7465 645f 6f75 7470     expected_outp
+0001c300: 7574 203d 207b 0a20 2020 2020 2020 2020  ut = {.         
+0001c310: 2020 2020 2020 2022 6461 7461 223a 207b         "data": {
+0001c320: 2274 6578 742f 706c 6169 6e22 3a20 6622  "text/plain": f"
+0001c330: 277b 7265 736f 6c76 6564 5f77 6f72 6b5f  '{resolved_work_
+0001c340: 6469 727d 2722 7d2c 0a20 2020 2020 2020  dir}'"},.       
+0001c350: 2020 2020 2020 2020 2022 6578 6563 7574           "execut
+0001c360: 696f 6e5f 636f 756e 7422 3a20 312c 0a20  ion_count": 1,. 
+0001c370: 2020 2020 2020 2020 2020 2020 2020 2022                 "
+0001c380: 6d65 7461 6461 7461 223a 207b 7d2c 0a20  metadata": {},. 
+0001c390: 2020 2020 2020 2020 2020 2020 2020 2022                 "
+0001c3a0: 6f75 7470 7574 5f74 7970 6522 3a20 2265  output_type": "e
+0001c3b0: 7865 6375 7465 5f72 6573 756c 7422 2c0a  xecute_result",.
+0001c3c0: 2020 2020 2020 2020 2020 2020 7d0a 2020              }.  
+0001c3d0: 2020 2020 2020 2020 2020 6173 7365 7274            assert
+0001c3e0: 2073 6372 6174 6368 5f75 7064 6174 655b   scratch_update[
+0001c3f0: 226f 7574 7075 7422 5d20 3d3d 2065 7870  "output"] == exp
+0001c400: 6563 7465 645f 6f75 7470 7574 0a0a 2020  ected_output..  
+0001c410: 2020 2020 2020 2020 2020 2320 5363 7261            # Scra
+0001c420: 7463 6820 6578 6563 7574 696f 6e20 7374  tch execution st
+0001c430: 6174 6520 7365 7420 746f 2069 646c 650a  ate set to idle.
+0001c440: 2020 2020 2020 2020 2020 2020 6461 7461              data
+0001c450: 203d 2061 7761 6974 2072 6563 6569 7665   = await receive
+0001c460: 5f6a 736f 6e28 7765 6273 6f63 6b65 742c  _json(websocket,
+0001c470: 206d 7367 5f74 7970 6573 3d5b 2273 6372   msg_types=["scr
+0001c480: 6174 6368 5f75 7064 6174 6522 5d29 0a20  atch_update"]). 
+0001c490: 2020 2020 2020 2020 2020 2073 6372 6174             scrat
+0001c4a0: 6368 5f75 7064 6174 6520 3d20 6461 7461  ch_update = data
+0001c4b0: 5b22 7363 7261 7463 685f 7570 6461 7465  ["scratch_update
+0001c4c0: 225d 0a20 2020 2020 2020 2020 2020 2061  "].            a
+0001c4d0: 7373 6572 7420 7363 7261 7463 685f 7570  ssert scratch_up
+0001c4e0: 6461 7465 5b22 6d65 7373 6167 655f 6964  date["message_id
+0001c4f0: 225d 203d 3d20 6d65 7373 6167 655f 6964  "] == message_id
+0001c500: 0a20 2020 2020 2020 2020 2020 2061 7373  .            ass
+0001c510: 6572 7420 7363 7261 7463 685f 7570 6461  ert scratch_upda
+0001c520: 7465 5b22 6578 6563 7574 696f 6e5f 7374  te["execution_st
+0001c530: 6174 6522 5d20 3d3d 2022 6964 6c65 220a  ate"] == "idle".
+0001c540: 0a20 2020 2020 2020 2020 2020 2074 6f6b  .            tok
+0001c550: 656e 203d 2067 6574 5f73 7570 6572 7573  en = get_superus
+0001c560: 6572 5f74 6f6b 656e 2829 0a20 2020 2020  er_token().     
+0001c570: 2020 2020 2020 2061 7574 6820 3d20 6261         auth = ba
+0001c580: 7365 3634 2e62 3634 656e 636f 6465 2866  se64.b64encode(f
+0001c590: 227b 746f 6b65 6e7d 3a22 2e65 6e63 6f64  "{token}:".encod
+0001c5a0: 6528 2275 7466 2d38 2229 290a 2020 2020  e("utf-8")).    
+0001c5b0: 2020 2020 2020 2020 7265 7370 6f6e 7365          response
+0001c5c0: 203d 2061 7761 6974 2063 6c69 656e 742e   = await client.
+0001c5d0: 6765 7428 0a20 2020 2020 2020 2020 2020  get(.           
+0001c5e0: 2020 2020 2066 222f 6461 767b 7265 736f       f"/dav{reso
+0001c5f0: 6c76 6564 5f77 6f72 6b5f 6469 727d 222c  lved_work_dir}",
+0001c600: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+0001c610: 2068 6561 6465 7273 3d7b 2241 7574 686f   headers={"Autho
+0001c620: 7269 7a61 7469 6f6e 223a 2066 2242 6173  rization": f"Bas
+0001c630: 6963 207b 6175 7468 2e64 6563 6f64 6528  ic {auth.decode(
+0001c640: 2775 7466 2d38 2729 7d22 7d2c 0a20 2020  'utf-8')}"},.   
+0001c650: 2020 2020 2020 2020 2029 0a20 2020 2020           ).     
+0001c660: 2020 2020 2020 2061 7373 6572 7420 7265         assert re
+0001c670: 7370 6f6e 7365 2e73 7461 7475 735f 636f  sponse.status_co
+0001c680: 6465 203d 3d20 3230 300a 0a20 2020 2040  de == 200..    @
+0001c690: 7079 7465 7374 2e6d 6172 6b2e 6173 796e  pytest.mark.asyn
+0001c6a0: 6369 6f0a 2020 2020 6173 796e 6320 6465  cio.    async de
+0001c6b0: 6620 7465 7374 5f77 6f72 6b69 6e67 5f64  f test_working_d
+0001c6c0: 6972 6563 746f 7279 5f70 6173 7365 645f  irectory_passed_
+0001c6d0: 696e 280a 2020 2020 2020 2020 7365 6c66  in(.        self
+0001c6e0: 2c20 636c 6965 6e74 3a20 5465 7374 436c  , client: TestCl
+0001c6f0: 6965 6e74 2c20 7375 7065 7275 7365 725f  ient, superuser_
+0001c700: 746f 6b65 6e5f 6865 6164 6572 733a 2044  token_headers: D
+0001c710: 6963 745b 7374 722c 2073 7472 5d0a 2020  ict[str, str].  
+0001c720: 2020 293a 0a20 2020 2020 2020 2022 2222    ):.        """
+0001c730: 0a20 2020 2020 2020 2049 6620 6e6f 7465  .        If note
+0001c740: 626f 6f6b 2069 7320 6f70 656e 6564 2077  book is opened w
+0001c750: 6974 6820 776f 726b 696e 6720 6469 7265  ith working dire
+0001c760: 6374 6f72 7920 7370 6563 6966 6965 642c  ctory specified,
+0001c770: 206d 616b 6520 7375 7265 0a20 2020 2020   make sure.     
+0001c780: 2020 2074 6865 206b 6572 6e65 6c20 6973     the kernel is
+0001c790: 2072 756e 6e69 6e67 2069 6e20 7468 6174   running in that
+0001c7a0: 2064 6972 6563 746f 7279 2e0a 2020 2020   directory..    
+0001c7b0: 2020 2020 2222 220a 2020 2020 2020 2020      """.        
+0001c7c0: 6669 6c65 6e61 6d65 203d 2022 7369 6d70  filename = "simp
+0001c7d0: 6c65 2e69 7079 6e62 220a 2020 2020 2020  le.ipynb".      
+0001c7e0: 2020 6e62 5f66 696c 656e 616d 6520 3d20    nb_filename = 
+0001c7f0: 6622 6a75 7079 7465 725f 6431 2f74 6573  f"jupyter_d1/tes
+0001c800: 7473 2f6e 6f74 6562 6f6f 6b73 2f7b 6669  ts/notebooks/{fi
+0001c810: 6c65 6e61 6d65 7d22 0a20 2020 2020 2020  lename}".       
+0001c820: 206e 625f 6a73 6f6e 203d 206f 7065 6e28   nb_json = open(
+0001c830: 6e62 5f66 696c 656e 616d 6529 2e72 6561  nb_filename).rea
+0001c840: 6428 290a 2020 2020 2020 2020 7265 7370  d().        resp
+0001c850: 6f6e 7365 203d 2061 7761 6974 2063 6c69  onse = await cli
+0001c860: 656e 742e 706f 7374 280a 2020 2020 2020  ent.post(.      
+0001c870: 2020 2020 2020 222f 6e6f 7465 626f 6f6b        "/notebook
+0001c880: 732f 7570 6c6f 6164 222c 0a20 2020 2020  s/upload",.     
+0001c890: 2020 2020 2020 2071 7565 7279 5f73 7472         query_str
+0001c8a0: 696e 673d 7b22 6669 6c65 6e61 6d65 223a  ing={"filename":
+0001c8b0: 2066 696c 656e 616d 657d 2c0a 2020 2020   filename},.    
+0001c8c0: 2020 2020 2020 2020 6461 7461 3d6e 625f          data=nb_
+0001c8d0: 6a73 6f6e 2c0a 2020 2020 2020 2020 2020  json,.          
+0001c8e0: 2020 6865 6164 6572 733d 7375 7065 7275    headers=superu
+0001c8f0: 7365 725f 746f 6b65 6e5f 6865 6164 6572  ser_token_header
+0001c900: 732c 0a20 2020 2020 2020 2029 0a20 2020  s,.        ).   
+0001c910: 2020 2020 2061 7373 6572 7420 7265 7370       assert resp
+0001c920: 6f6e 7365 2e73 7461 7475 735f 636f 6465  onse.status_code
+0001c930: 203d 3d20 3230 310a 2020 2020 2020 2020   == 201.        
+0001c940: 6177 6169 7420 7365 6c66 2e61 7373 6572  await self.asser
+0001c950: 745f 7079 7468 6f6e 5f77 6f72 6b69 6e67  t_python_working
+0001c960: 5f64 6972 6563 746f 7279 280a 2020 2020  _directory(.    
+0001c970: 2020 2020 2020 2020 636c 6965 6e74 2c0a          client,.
+0001c980: 2020 2020 2020 2020 2020 2020 7375 7065              supe
+0001c990: 7275 7365 725f 746f 6b65 6e5f 6865 6164  ruser_token_head
+0001c9a0: 6572 732c 0a20 2020 2020 2020 2020 2020  ers,.           
+0001c9b0: 206f 7065 6e5f 7061 7468 3d66 696c 656e   open_path=filen
+0001c9c0: 616d 652c 0a20 2020 2020 2020 2020 2020  ame,.           
+0001c9d0: 2077 6f72 6b69 6e67 5f64 6972 6563 746f   working_directo
+0001c9e0: 7279 3d66 227b 6f73 2e67 6574 6377 6428  ry=f"{os.getcwd(
+0001c9f0: 297d 2f6a 7570 7974 6572 5f64 312f 7465  )}/jupyter_d1/te
+0001ca00: 7374 732f 6e6f 7465 626f 6f6b 7322 2c0a  sts/notebooks",.
+0001ca10: 2020 2020 2020 2020 2020 2020 7175 6572              quer
+0001ca20: 795f 7374 7269 6e67 3d7b 0a20 2020 2020  y_string={.     
+0001ca30: 2020 2020 2020 2020 2020 2022 776f 726b             "work
+0001ca40: 696e 675f 6469 7265 6374 6f72 7922 3a20  ing_directory": 
+0001ca50: 6622 7b6f 732e 6765 7463 7764 2829 7d2f  f"{os.getcwd()}/
+0001ca60: 6a75 7079 7465 725f 6431 220a 2020 2020  jupyter_d1".    
+0001ca70: 2020 2020 2020 2020 2020 2020 222f 7465              "/te
+0001ca80: 7374 732f 6e6f 7465 626f 6f6b 7322 0a20  sts/notebooks". 
+0001ca90: 2020 2020 2020 2020 2020 207d 2c0a 2020             },.  
+0001caa0: 2020 2020 2020 290a 0a20 2020 2040 7079        )..    @py
+0001cab0: 7465 7374 2e6d 6172 6b2e 6173 796e 6369  test.mark.asynci
+0001cac0: 6f0a 2020 2020 6173 796e 6320 6465 6620  o.    async def 
+0001cad0: 7465 7374 5f66 696c 655f 696e 5f64 6966  test_file_in_dif
+0001cae0: 6665 7265 6e74 5f77 6f72 6b69 6e67 5f64  ferent_working_d
+0001caf0: 6972 6563 746f 7279 280a 2020 2020 2020  irectory(.      
+0001cb00: 2020 7365 6c66 2c20 636c 6965 6e74 3a20    self, client: 
+0001cb10: 5465 7374 436c 6965 6e74 2c20 7375 7065  TestClient, supe
+0001cb20: 7275 7365 725f 746f 6b65 6e5f 6865 6164  ruser_token_head
+0001cb30: 6572 733a 2044 6963 745b 7374 722c 2073  ers: Dict[str, s
+0001cb40: 7472 5d0a 2020 2020 293a 0a20 2020 2020  tr].    ):.     
+0001cb50: 2020 2022 2222 0a20 2020 2020 2020 2049     """.        I
+0001cb60: 6620 6e6f 7465 626f 6f6b 2069 6e20 6120  f notebook in a 
+0001cb70: 6469 6666 6572 656e 7420 6469 7265 6374  different direct
+0001cb80: 6f72 7920 6973 206f 7065 6e65 642c 206d  ory is opened, m
+0001cb90: 616b 6520 7375 7265 0a20 2020 2020 2020  ake sure.       
+0001cba0: 2074 6865 206b 6572 6e65 6c20 6973 2072   the kernel is r
+0001cbb0: 756e 6e69 6e67 2069 6e20 7468 6174 2064  unning in that d
+0001cbc0: 6972 6563 746f 7279 2e0a 2020 2020 2020  irectory..      
+0001cbd0: 2020 2222 220a 2020 2020 2020 2020 7368    """.        sh
+0001cbe0: 7574 696c 2e63 6f70 7966 696c 6528 0a20  util.copyfile(. 
+0001cbf0: 2020 2020 2020 2020 2020 2022 6a75 7079             "jupy
+0001cc00: 7465 725f 6431 2f74 6573 7473 2f6e 6f74  ter_d1/tests/not
+0001cc10: 6562 6f6f 6b73 2f73 696d 706c 652e 6970  ebooks/simple.ip
+0001cc20: 796e 6222 2c0a 2020 2020 2020 2020 2020  ynb",.          
+0001cc30: 2020 226a 7570 7974 6572 5f64 312f 7465    "jupyter_d1/te
+0001cc40: 7374 732f 6e6f 7465 626f 6f6b 732f 7369  sts/notebooks/si
+0001cc50: 6d70 6c65 5f63 6f70 792e 6970 796e 6222  mple_copy.ipynb"
+0001cc60: 2c0a 2020 2020 2020 2020 290a 2020 2020  ,.        ).    
+0001cc70: 2020 2020 6177 6169 7420 7365 6c66 2e61      await self.a
+0001cc80: 7373 6572 745f 7079 7468 6f6e 5f77 6f72  ssert_python_wor
+0001cc90: 6b69 6e67 5f64 6972 6563 746f 7279 280a  king_directory(.
+0001cca0: 2020 2020 2020 2020 2020 2020 636c 6965              clie
+0001ccb0: 6e74 2c0a 2020 2020 2020 2020 2020 2020  nt,.            
+0001ccc0: 7375 7065 7275 7365 725f 746f 6b65 6e5f  superuser_token_
+0001ccd0: 6865 6164 6572 732c 0a20 2020 2020 2020  headers,.       
+0001cce0: 2020 2020 206f 7065 6e5f 7061 7468 3d66       open_path=f
+0001ccf0: 227b 6f73 2e67 6574 6377 6428 297d 2f6a  "{os.getcwd()}/j
+0001cd00: 7570 7974 6572 5f64 312f 7465 7374 732f  upyter_d1/tests/
+0001cd10: 220a 2020 2020 2020 2020 2020 2020 226e  ".            "n
+0001cd20: 6f74 6562 6f6f 6b73 2f73 696d 706c 655f  otebooks/simple_
+0001cd30: 636f 7079 2e69 7079 6e62 222c 0a20 2020  copy.ipynb",.   
+0001cd40: 2020 2020 2020 2020 2077 6f72 6b69 6e67           working
+0001cd50: 5f64 6972 6563 746f 7279 3d66 227b 6f73  _directory=f"{os
+0001cd60: 2e67 6574 6377 6428 297d 2f6a 7570 7974  .getcwd()}/jupyt
+0001cd70: 6572 5f64 312f 7465 7374 732f 6e6f 7465  er_d1/tests/note
+0001cd80: 626f 6f6b 7322 2c0a 2020 2020 2020 2020  books",.        
+0001cd90: 290a 2020 2020 2020 2020 6f73 2e72 656d  ).        os.rem
+0001cda0: 6f76 6528 226a 7570 7974 6572 5f64 312f  ove("jupyter_d1/
+0001cdb0: 7465 7374 732f 6e6f 7465 626f 6f6b 732f  tests/notebooks/
+0001cdc0: 7369 6d70 6c65 5f63 6f70 792e 6970 796e  simple_copy.ipyn
+0001cdd0: 6222 290a 0a20 2020 2040 7079 7465 7374  b")..    @pytest
+0001cde0: 2e6d 6172 6b2e 6173 796e 6369 6f0a 2020  .mark.asyncio.  
+0001cdf0: 2020 6173 796e 6320 6465 6620 7465 7374    async def test
+0001ce00: 5f66 696c 655f 696e 5f70 6172 656e 745f  _file_in_parent_
+0001ce10: 6469 7265 6374 6f72 795f 6f66 5f77 6f72  directory_of_wor
+0001ce20: 6b69 6e67 5f64 6972 6563 746f 7279 280a  king_directory(.
+0001ce30: 2020 2020 2020 2020 7365 6c66 2c20 636c          self, cl
+0001ce40: 6965 6e74 3a20 5465 7374 436c 6965 6e74  ient: TestClient
+0001ce50: 2c20 7375 7065 7275 7365 725f 746f 6b65  , superuser_toke
+0001ce60: 6e5f 6865 6164 6572 733a 2044 6963 745b  n_headers: Dict[
+0001ce70: 7374 722c 2073 7472 5d0a 2020 2020 293a  str, str].    ):
+0001ce80: 0a20 2020 2020 2020 2022 2222 0a20 2020  .        """.   
+0001ce90: 2020 2020 2049 6620 6e6f 7465 626f 6f6b       If notebook
+0001cea0: 2069 6e20 7468 6520 7061 7265 6e74 2064   in the parent d
+0001ceb0: 6972 6563 746f 7279 206f 6620 7468 6520  irectory of the 
+0001cec0: 7365 7276 6572 2773 2077 6f72 6b69 6e67  server's working
+0001ced0: 2064 6972 6563 746f 7279 0a20 2020 2020   directory.     
+0001cee0: 2020 2069 7320 6f70 656e 6564 2c20 6d61     is opened, ma
+0001cef0: 6b65 2073 7572 6520 7468 6520 6b65 726e  ke sure the kern
+0001cf00: 656c 2069 7320 7275 6e6e 696e 6720 696e  el is running in
+0001cf10: 2074 6861 7420 7061 7265 6e74 2064 6972   that parent dir
+0001cf20: 6563 746f 7279 2e0a 2020 2020 2020 2020  ectory..        
+0001cf30: 2222 220a 2020 2020 2020 2020 7368 7574  """.        shut
+0001cf40: 696c 2e63 6f70 7966 696c 6528 0a20 2020  il.copyfile(.   
+0001cf50: 2020 2020 2020 2020 2022 6a75 7079 7465           "jupyte
+0001cf60: 725f 6431 2f74 6573 7473 2f6e 6f74 6562  r_d1/tests/noteb
+0001cf70: 6f6f 6b73 2f73 696d 706c 652e 6970 796e  ooks/simple.ipyn
+0001cf80: 6222 2c0a 2020 2020 2020 2020 2020 2020  b",.            
+0001cf90: 6622 2f74 6d70 2f73 696d 706c 655f 636f  f"/tmp/simple_co
+0001cfa0: 7079 2e69 7079 6e62 222c 0a20 2020 2020  py.ipynb",.     
+0001cfb0: 2020 2029 0a20 2020 2020 2020 2061 7761     ).        awa
+0001cfc0: 6974 2073 656c 662e 6173 7365 7274 5f70  it self.assert_p
+0001cfd0: 7974 686f 6e5f 776f 726b 696e 675f 6469  ython_working_di
+0001cfe0: 7265 6374 6f72 7928 0a20 2020 2020 2020  rectory(.       
+0001cff0: 2020 2020 2063 6c69 656e 742c 0a20 2020       client,.   
+0001d000: 2020 2020 2020 2020 2073 7570 6572 7573           superus
+0001d010: 6572 5f74 6f6b 656e 5f68 6561 6465 7273  er_token_headers
+0001d020: 2c0a 2020 2020 2020 2020 2020 2020 6f70  ,.            op
+0001d030: 656e 5f70 6174 683d 6622 2f74 6d70 2f73  en_path=f"/tmp/s
+0001d040: 696d 706c 655f 636f 7079 2e69 7079 6e62  imple_copy.ipynb
+0001d050: 222c 0a20 2020 2020 2020 2020 2020 2077  ",.            w
+0001d060: 6f72 6b69 6e67 5f64 6972 6563 746f 7279  orking_directory
+0001d070: 3d66 222f 746d 7022 2c0a 2020 2020 2020  =f"/tmp",.      
+0001d080: 2020 290a 2020 2020 2020 2020 6f73 2e72    ).        os.r
+0001d090: 656d 6f76 6528 222f 746d 702f 7369 6d70  emove("/tmp/simp
+0001d0a0: 6c65 5f63 6f70 792e 6970 796e 6222 290a  le_copy.ipynb").
+0001d0b0: 0a20 2020 2040 7079 7465 7374 2e6d 6172  .    @pytest.mar
+0001d0c0: 6b2e 6173 796e 6369 6f0a 2020 2020 6173  k.asyncio.    as
+0001d0d0: 796e 6320 6465 6620 7465 7374 5f66 696c  ync def test_fil
+0001d0e0: 655f 696e 5f73 7562 5f64 6972 6563 746f  e_in_sub_directo
+0001d0f0: 7279 5f6f 665f 776f 726b 696e 675f 6469  ry_of_working_di
+0001d100: 7265 6374 6f72 7928 0a20 2020 2020 2020  rectory(.       
+0001d110: 2073 656c 662c 2063 6c69 656e 743a 2054   self, client: T
+0001d120: 6573 7443 6c69 656e 742c 2073 7570 6572  estClient, super
+0001d130: 7573 6572 5f74 6f6b 656e 5f68 6561 6465  user_token_heade
+0001d140: 7273 3a20 4469 6374 5b73 7472 2c20 7374  rs: Dict[str, st
+0001d150: 725d 0a20 2020 2029 3a0a 2020 2020 2020  r].    ):.      
+0001d160: 2020 2222 220a 2020 2020 2020 2020 4966    """.        If
+0001d170: 206e 6f74 6562 6f6f 6b20 696e 2061 2073   notebook in a s
+0001d180: 7562 2064 6972 6563 746f 7279 206f 6620  ub directory of 
+0001d190: 7468 6520 7365 7276 6572 2773 2077 6f72  the server's wor
+0001d1a0: 6b69 6e67 2064 6972 6563 746f 7279 0a20  king directory. 
+0001d1b0: 2020 2020 2020 2069 7320 6f70 656e 6564         is opened
+0001d1c0: 2c20 6d61 6b65 2073 7572 6520 7468 6520  , make sure the 
+0001d1d0: 6b65 726e 656c 2069 7320 7275 6e6e 696e  kernel is runnin
+0001d1e0: 6720 696e 2074 6861 7420 7375 6220 6469  g in that sub di
+0001d1f0: 7265 6374 6f72 792e 0a20 2020 2020 2020  rectory..       
+0001d200: 2022 2222 0a20 2020 2020 2020 2070 6174   """.        pat
+0001d210: 686c 6962 2e50 6174 6828 6622 7b73 6574  hlib.Path(f"{set
+0001d220: 7469 6e67 732e 524f 4f54 5f44 4952 7d2f  tings.ROOT_DIR}/
+0001d230: 736f 6d65 5f6e 6273 2229 2e6d 6b64 6972  some_nbs").mkdir
+0001d240: 2865 7869 7374 5f6f 6b3d 5472 7565 290a  (exist_ok=True).
+0001d250: 2020 2020 2020 2020 7368 7574 696c 2e63          shutil.c
+0001d260: 6f70 7966 696c 6528 0a20 2020 2020 2020  opyfile(.       
+0001d270: 2020 2020 2022 6a75 7079 7465 725f 6431       "jupyter_d1
+0001d280: 2f74 6573 7473 2f6e 6f74 6562 6f6f 6b73  /tests/notebooks
+0001d290: 2f73 696d 706c 652e 6970 796e 6222 2c0a  /simple.ipynb",.
+0001d2a0: 2020 2020 2020 2020 2020 2020 6622 7b73              f"{s
+0001d2b0: 6574 7469 6e67 732e 524f 4f54 5f44 4952  ettings.ROOT_DIR
+0001d2c0: 7d2f 736f 6d65 5f6e 6273 2f73 696d 706c  }/some_nbs/simpl
+0001d2d0: 655f 636f 7079 2e69 7079 6e62 222c 0a20  e_copy.ipynb",. 
+0001d2e0: 2020 2020 2020 2029 0a20 2020 2020 2020         ).       
+0001d2f0: 2061 7761 6974 2073 656c 662e 6173 7365   await self.asse
+0001d300: 7274 5f70 7974 686f 6e5f 776f 726b 696e  rt_python_workin
+0001d310: 675f 6469 7265 6374 6f72 7928 0a20 2020  g_directory(.   
+0001d320: 2020 2020 2020 2020 2063 6c69 656e 742c           client,
+0001d330: 0a20 2020 2020 2020 2020 2020 2073 7570  .            sup
+0001d340: 6572 7573 6572 5f74 6f6b 656e 5f68 6561  eruser_token_hea
+0001d350: 6465 7273 2c0a 2020 2020 2020 2020 2020  ders,.          
+0001d360: 2020 6f70 656e 5f70 6174 683d 6622 7b73    open_path=f"{s
+0001d370: 6574 7469 6e67 732e 524f 4f54 5f44 4952  ettings.ROOT_DIR
+0001d380: 7d2f 736f 6d65 5f6e 6273 2f73 696d 706c  }/some_nbs/simpl
+0001d390: 655f 636f 7079 2e69 7079 6e62 222c 0a20  e_copy.ipynb",. 
+0001d3a0: 2020 2020 2020 2020 2020 2077 6f72 6b69             worki
+0001d3b0: 6e67 5f64 6972 6563 746f 7279 3d66 227b  ng_directory=f"{
+0001d3c0: 7365 7474 696e 6773 2e52 4f4f 545f 4449  settings.ROOT_DI
+0001d3d0: 527d 2f73 6f6d 655f 6e62 7322 2c0a 2020  R}/some_nbs",.  
+0001d3e0: 2020 2020 2020 290a 2020 2020 2020 2020        ).        
+0001d3f0: 7368 7574 696c 2e72 6d74 7265 6528 6622  shutil.rmtree(f"
+0001d400: 7b73 6574 7469 6e67 732e 524f 4f54 5f44  {settings.ROOT_D
+0001d410: 4952 7d2f 736f 6d65 5f6e 6273 2229 0a0a  IR}/some_nbs")..
+0001d420: 2020 2020 4070 7974 6573 742e 6d61 726b      @pytest.mark
+0001d430: 2e61 7379 6e63 696f 0a20 2020 2061 7379  .asyncio.    asy
+0001d440: 6e63 2064 6566 2074 6573 745f 725f 6b65  nc def test_r_ke
+0001d450: 726e 656c 5f77 6f72 6b69 6e67 5f64 6972  rnel_working_dir
+0001d460: 6563 746f 7279 5f70 6173 7365 645f 696e  ectory_passed_in
+0001d470: 280a 2020 2020 2020 2020 7365 6c66 2c20  (.        self, 
+0001d480: 636c 6965 6e74 3a20 5465 7374 436c 6965  client: TestClie
+0001d490: 6e74 2c20 7375 7065 7275 7365 725f 746f  nt, superuser_to
+0001d4a0: 6b65 6e5f 6865 6164 6572 733a 2044 6963  ken_headers: Dic
+0001d4b0: 745b 7374 722c 2073 7472 5d0a 2020 2020  t[str, str].    
+0001d4c0: 293a 0a20 2020 2020 2020 2077 6f72 6b69  ):.        worki
+0001d4d0: 6e67 5f64 6972 6563 746f 7279 203d 2022  ng_directory = "
+0001d4e0: 2f74 6d70 220a 2020 2020 2020 2020 7265  /tmp".        re
+0001d4f0: 7370 6f6e 7365 203d 2061 7761 6974 2063  sponse = await c
+0001d500: 6c69 656e 742e 706f 7374 280a 2020 2020  lient.post(.    
+0001d510: 2020 2020 2020 2020 222f 6e6f 7465 626f          "/notebo
+0001d520: 6f6b 732f 6372 6561 7465 222c 0a20 2020  oks/create",.   
+0001d530: 2020 2020 2020 2020 2071 7565 7279 5f73           query_s
+0001d540: 7472 696e 673d 7b0a 2020 2020 2020 2020  tring={.        
+0001d550: 2020 2020 2020 2020 226b 7370 6563 5f6e          "kspec_n
+0001d560: 616d 6522 3a20 2269 7222 2c0a 2020 2020  ame": "ir",.    
+0001d570: 2020 2020 2020 2020 2020 2020 2266 696c              "fil
+0001d580: 656e 616d 6522 3a20 2268 6579 7022 2c0a  ename": "heyp",.
+0001d590: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001d5a0: 2277 6f72 6b69 6e67 5f64 6972 6563 746f  "working_directo
+0001d5b0: 7279 223a 2077 6f72 6b69 6e67 5f64 6972  ry": working_dir
+0001d5c0: 6563 746f 7279 2c0a 2020 2020 2020 2020  ectory,.        
+0001d5d0: 2020 2020 7d2c 0a20 2020 2020 2020 2020      },.         
+0001d5e0: 2020 2068 6561 6465 7273 3d73 7570 6572     headers=super
+0001d5f0: 7573 6572 5f74 6f6b 656e 5f68 6561 6465  user_token_heade
+0001d600: 7273 2c0a 2020 2020 2020 2020 290a 2020  rs,.        ).  
+0001d610: 2020 2020 2020 6173 7365 7274 2072 6573        assert res
+0001d620: 706f 6e73 652e 7374 6174 7573 5f63 6f64  ponse.status_cod
+0001d630: 6520 3d3d 2032 3031 0a20 2020 2020 2020  e == 201.       
+0001d640: 2072 6573 705f 6a73 6f6e 203d 2072 6573   resp_json = res
+0001d650: 706f 6e73 652e 6a73 6f6e 2829 5b22 6e6f  ponse.json()["no
+0001d660: 7465 626f 6f6b 225d 0a20 2020 2020 2020  tebook"].       
+0001d670: 2075 7569 6420 3d20 7265 7370 5f6a 736f   uuid = resp_jso
+0001d680: 6e5b 226d 6574 6164 6174 6122 5d5b 226a  n["metadata"]["j
+0001d690: 7570 7974 6572 5f64 3122 5d5b 2275 7569  upyter_d1"]["uui
+0001d6a0: 6422 5d0a 0a20 2020 2020 2020 2061 7379  d"]..        asy
+0001d6b0: 6e63 2077 6974 6820 636c 6965 6e74 2e77  nc with client.w
+0001d6c0: 6562 736f 636b 6574 5f63 6f6e 6e65 6374  ebsocket_connect
+0001d6d0: 280a 2020 2020 2020 2020 2020 2020 6622  (.            f"
+0001d6e0: 2f6e 6f74 6562 6f6f 6b73 2f7b 7575 6964  /notebooks/{uuid
+0001d6f0: 7d2f 7773 2f6e 6f74 6562 6f6f 6b22 2c20  }/ws/notebook", 
+0001d700: 6865 6164 6572 733d 7375 7065 7275 7365  headers=superuse
+0001d710: 725f 746f 6b65 6e5f 6865 6164 6572 730a  r_token_headers.
+0001d720: 2020 2020 2020 2020 2920 6173 2077 6562          ) as web
+0001d730: 736f 636b 6574 3a0a 2020 2020 2020 2020  socket:.        
+0001d740: 2020 2020 6177 6169 7420 6173 796e 6369      await asynci
+0001d750: 6f2e 736c 6565 7028 5745 4253 4f43 4b45  o.sleep(WEBSOCKE
+0001d760: 545f 534c 4545 505f 5449 4d45 290a 0a20  T_SLEEP_TIME).. 
+0001d770: 2020 2020 2020 2020 2020 2072 6573 706f             respo
+0001d780: 6e73 6520 3d20 6177 6169 7420 636c 6965  nse = await clie
+0001d790: 6e74 2e70 6f73 7428 0a20 2020 2020 2020  nt.post(.       
+0001d7a0: 2020 2020 2020 2020 2066 222f 6e6f 7465           f"/note
+0001d7b0: 626f 6f6b 732f 7b75 7569 647d 2f73 6372  books/{uuid}/scr
+0001d7c0: 6174 6368 5f65 7865 6375 7465 222c 0a20  atch_execute",. 
+0001d7d0: 2020 2020 2020 2020 2020 2020 2020 2068                 h
+0001d7e0: 6561 6465 7273 3d73 7570 6572 7573 6572  eaders=superuser
+0001d7f0: 5f74 6f6b 656e 5f68 6561 6465 7273 2c0a  _token_headers,.
+0001d800: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001d810: 6a73 6f6e 3d7b 2263 6f64 6522 3a20 2267  json={"code": "g
+0001d820: 6574 7764 2829 227d 2c0a 2020 2020 2020  etwd()"},.      
+0001d830: 2020 2020 2020 290a 2020 2020 2020 2020        ).        
+0001d840: 2020 2020 6173 7365 7274 2072 6573 706f      assert respo
+0001d850: 6e73 652e 7374 6174 7573 5f63 6f64 6520  nse.status_code 
+0001d860: 3d3d 2032 3030 0a20 2020 2020 2020 2020  == 200.         
+0001d870: 2020 206d 6573 7361 6765 5f69 6420 3d20     message_id = 
+0001d880: 7265 7370 6f6e 7365 2e6a 736f 6e28 295b  response.json()[
+0001d890: 226b 6572 6e65 6c5f 6d65 7373 6167 6522  "kernel_message"
+0001d8a0: 5d5b 226d 6573 7361 6765 5f69 6422 5d0a  ]["message_id"].
+0001d8b0: 0a20 2020 2020 2020 2020 2020 2023 2066  .            # f
+0001d8c0: 6972 7374 2063 6875 6e6b 2072 6563 6569  irst chunk recei
+0001d8d0: 7665 6420 7368 6f75 6c64 2062 6520 6120  ved should be a 
+0001d8e0: 7363 7261 7463 685f 7570 6461 7465 2077  scratch_update w
+0001d8f0: 6974 680a 2020 2020 2020 2020 2020 2020  ith.            
+0001d900: 2320 616e 2065 7865 6375 7469 6f6e 5f73  # an execution_s
+0001d910: 7461 7465 206f 6620 2762 7573 7927 2077  tate of 'busy' w
+0001d920: 6865 6e20 7072 6f63 6573 7369 6e67 2073  hen processing s
+0001d930: 7461 7274 730a 2020 2020 2020 2020 2020  tarts.          
+0001d940: 2020 6461 7461 203d 2061 7761 6974 2072    data = await r
+0001d950: 6563 6569 7665 5f6a 736f 6e28 7765 6273  eceive_json(webs
+0001d960: 6f63 6b65 742c 206d 7367 5f74 7970 6573  ocket, msg_types
+0001d970: 3d5b 2273 6372 6174 6368 5f75 7064 6174  =["scratch_updat
+0001d980: 6522 5d29 0a20 2020 2020 2020 2020 2020  e"]).           
+0001d990: 2073 6372 6174 6368 5f75 7064 6174 6520   scratch_update 
+0001d9a0: 3d20 6461 7461 5b22 7363 7261 7463 685f  = data["scratch_
+0001d9b0: 7570 6461 7465 225d 0a20 2020 2020 2020  update"].       
+0001d9c0: 2020 2020 2061 7373 6572 7420 7363 7261       assert scra
+0001d9d0: 7463 685f 7570 6461 7465 5b22 6d65 7373  tch_update["mess
+0001d9e0: 6167 655f 6964 225d 203d 3d20 6d65 7373  age_id"] == mess
+0001d9f0: 6167 655f 6964 0a20 2020 2020 2020 2020  age_id.         
+0001da00: 2020 2061 7373 6572 7420 7363 7261 7463     assert scratc
+0001da10: 685f 7570 6461 7465 5b22 6578 6563 7574  h_update["execut
+0001da20: 696f 6e5f 7374 6174 6522 5d20 3d3d 2022  ion_state"] == "
+0001da30: 6275 7379 220a 0a20 2020 2020 2020 2020  busy"..         
+0001da40: 2020 2023 2052 6563 6569 7665 2073 6372     # Receive scr
+0001da50: 6174 6368 2065 7865 6375 7469 6f6e 206f  atch execution o
+0001da60: 7574 7075 740a 2020 2020 2020 2020 2020  utput.          
+0001da70: 2020 6461 7461 203d 2061 7761 6974 2072    data = await r
+0001da80: 6563 6569 7665 5f6a 736f 6e28 7765 6273  eceive_json(webs
+0001da90: 6f63 6b65 742c 206d 7367 5f74 7970 6573  ocket, msg_types
+0001daa0: 3d5b 2273 6372 6174 6368 5f75 7064 6174  =["scratch_updat
+0001dab0: 6522 5d29 0a20 2020 2020 2020 2020 2020  e"]).           
+0001dac0: 2073 6372 6174 6368 5f75 7064 6174 6520   scratch_update 
+0001dad0: 3d20 6461 7461 5b22 7363 7261 7463 685f  = data["scratch_
+0001dae0: 7570 6461 7465 225d 0a20 2020 2020 2020  update"].       
+0001daf0: 2020 2020 2023 202f 746d 7020 7379 6d6c       # /tmp syml
+0001db00: 696e 6b73 2074 6f20 2f70 7269 7661 7465  inks to /private
+0001db10: 2f74 6d70 206f 6e20 6d61 632c 2073 6f20  /tmp on mac, so 
+0001db20: 7765 2072 6573 6f6c 7665 0a20 2020 2020  we resolve.     
+0001db30: 2020 2020 2020 2072 6573 6f6c 7665 645f         resolved_
+0001db40: 776f 726b 5f64 6972 203d 2070 6174 686c  work_dir = pathl
+0001db50: 6962 2e50 6174 6828 776f 726b 696e 675f  ib.Path(working_
+0001db60: 6469 7265 6374 6f72 7929 2e72 6573 6f6c  directory).resol
+0001db70: 7665 2829 0a20 2020 2020 2020 2020 2020  ve().           
+0001db80: 2065 7870 6563 7465 645f 6f75 7470 7574   expected_output
+0001db90: 203d 207b 0a20 2020 2020 2020 2020 2020   = {.           
+0001dba0: 2020 2020 2022 6461 7461 223a 207b 0a20       "data": {. 
+0001dbb0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001dbc0: 2020 2022 7465 7874 2f68 746d 6c22 3a20     "text/html": 
+0001dbd0: 6622 277b 7265 736f 6c76 6564 5f77 6f72  f"'{resolved_wor
+0001dbe0: 6b5f 6469 727d 2722 2c0a 2020 2020 2020  k_dir}'",.      
+0001dbf0: 2020 2020 2020 2020 2020 2020 2020 2274                "t
+0001dc00: 6578 742f 6c61 7465 7822 3a20 6622 277b  ext/latex": f"'{
+0001dc10: 7265 736f 6c76 6564 5f77 6f72 6b5f 6469  resolved_work_di
+0001dc20: 727d 2722 2c0a 2020 2020 2020 2020 2020  r}'",.          
+0001dc30: 2020 2020 2020 2020 2020 2274 6578 742f            "text/
+0001dc40: 6d61 726b 646f 776e 223a 2066 2227 7b72  markdown": f"'{r
+0001dc50: 6573 6f6c 7665 645f 776f 726b 5f64 6972  esolved_work_dir
+0001dc60: 7d27 222c 0a20 2020 2020 2020 2020 2020  }'",.           
+0001dc70: 2020 2020 2020 2020 2022 7465 7874 2f70           "text/p
+0001dc80: 6c61 696e 223a 2066 275b 315d 2022 7b72  lain": f'[1] "{r
+0001dc90: 6573 6f6c 7665 645f 776f 726b 5f64 6972  esolved_work_dir
+0001dca0: 7d22 272c 0a20 2020 2020 2020 2020 2020  }"',.           
+0001dcb0: 2020 2020 207d 2c0a 2020 2020 2020 2020       },.        
+0001dcc0: 2020 2020 2020 2020 226d 6574 6164 6174          "metadat
+0001dcd0: 6122 3a20 7b7d 2c0a 2020 2020 2020 2020  a": {},.        
+0001dce0: 2020 2020 2020 2020 226f 7574 7075 745f          "output_
+0001dcf0: 7479 7065 223a 2022 6469 7370 6c61 795f  type": "display_
+0001dd00: 6461 7461 222c 0a20 2020 2020 2020 2020  data",.         
+0001dd10: 2020 207d 0a20 2020 2020 2020 2020 2020     }.           
+0001dd20: 2061 7373 6572 7420 7363 7261 7463 685f   assert scratch_
+0001dd30: 7570 6461 7465 5b22 6f75 7470 7574 225d  update["output"]
+0001dd40: 203d 3d20 6578 7065 6374 6564 5f6f 7574   == expected_out
+0001dd50: 7075 740a 0a20 2020 2020 2020 2020 2020  put..           
+0001dd60: 2023 2053 6372 6174 6368 2065 7865 6375   # Scratch execu
+0001dd70: 7469 6f6e 2073 7461 7465 2073 6574 2074  tion state set t
+0001dd80: 6f20 6964 6c65 0a20 2020 2020 2020 2020  o idle.         
+0001dd90: 2020 2064 6174 6120 3d20 6177 6169 7420     data = await 
+0001dda0: 7265 6365 6976 655f 6a73 6f6e 2877 6562  receive_json(web
+0001ddb0: 736f 636b 6574 2c20 6d73 675f 7479 7065  socket, msg_type
+0001ddc0: 733d 5b22 7363 7261 7463 685f 7570 6461  s=["scratch_upda
+0001ddd0: 7465 225d 290a 2020 2020 2020 2020 2020  te"]).          
+0001dde0: 2020 7363 7261 7463 685f 7570 6461 7465    scratch_update
+0001ddf0: 203d 2064 6174 615b 2273 6372 6174 6368   = data["scratch
+0001de00: 5f75 7064 6174 6522 5d0a 2020 2020 2020  _update"].      
+0001de10: 2020 2020 2020 6173 7365 7274 2073 6372        assert scr
+0001de20: 6174 6368 5f75 7064 6174 655b 226d 6573  atch_update["mes
+0001de30: 7361 6765 5f69 6422 5d20 3d3d 206d 6573  sage_id"] == mes
+0001de40: 7361 6765 5f69 640a 2020 2020 2020 2020  sage_id.        
+0001de50: 2020 2020 6173 7365 7274 2073 6372 6174      assert scrat
+0001de60: 6368 5f75 7064 6174 655b 2265 7865 6375  ch_update["execu
+0001de70: 7469 6f6e 5f73 7461 7465 225d 203d 3d20  tion_state"] == 
+0001de80: 2269 646c 6522 0a0a 2020 2020 2020 2020  "idle"..        
+0001de90: 2020 2020 746f 6b65 6e20 3d20 6765 745f      token = get_
+0001dea0: 7375 7065 7275 7365 725f 746f 6b65 6e28  superuser_token(
+0001deb0: 290a 2020 2020 2020 2020 2020 2020 6175  ).            au
+0001dec0: 7468 203d 2062 6173 6536 342e 6236 3465  th = base64.b64e
+0001ded0: 6e63 6f64 6528 6622 7b74 6f6b 656e 7d3a  ncode(f"{token}:
+0001dee0: 222e 656e 636f 6465 2822 7574 662d 3822  ".encode("utf-8"
+0001def0: 2929 0a20 2020 2020 2020 2020 2020 2072  )).            r
+0001df00: 6573 706f 6e73 6520 3d20 6177 6169 7420  esponse = await 
+0001df10: 636c 6965 6e74 2e67 6574 280a 2020 2020  client.get(.    
+0001df20: 2020 2020 2020 2020 2020 2020 6622 2f64              f"/d
+0001df30: 6176 7b72 6573 6f6c 7665 645f 776f 726b  av{resolved_work
+0001df40: 5f64 6972 7d22 2c0a 2020 2020 2020 2020  _dir}",.        
+0001df50: 2020 2020 2020 2020 6865 6164 6572 733d          headers=
+0001df60: 7b22 4175 7468 6f72 697a 6174 696f 6e22  {"Authorization"
+0001df70: 3a20 6622 4261 7369 6320 7b61 7574 682e  : f"Basic {auth.
+0001df80: 6465 636f 6465 2827 7574 662d 3827 297d  decode('utf-8')}
+0001df90: 227d 2c0a 2020 2020 2020 2020 2020 2020  "},.            
+0001dfa0: 290a 2020 2020 2020 2020 2020 2020 6173  ).            as
+0001dfb0: 7365 7274 2072 6573 706f 6e73 652e 7374  sert response.st
+0001dfc0: 6174 7573 5f63 6f64 6520 3d3d 2032 3030  atus_code == 200
+0001dfd0: 0a0a 0a40 7079 7465 7374 2e6d 6172 6b2e  ...@pytest.mark.
+0001dfe0: 7573 6566 6978 7475 7265 7328 2263 6c65  usefixtures("cle
+0001dff0: 6172 5f6e 6f74 6562 6f6f 6b73 222c 2022  ar_notebooks", "
+0001e000: 636c 6561 725f 6e6f 7465 626f 6f6b 5f64  clear_notebook_d
+0001e010: 6972 6563 746f 7279 2229 0a63 6c61 7373  irectory").class
+0001e020: 2054 6573 7443 6861 6e67 6557 6f72 6b69   TestChangeWorki
+0001e030: 6e67 4469 7265 6374 6f72 793a 0a20 2020  ngDirectory:.   
+0001e040: 2061 7379 6e63 2064 6566 2064 6f5f 7465   async def do_te
+0001e050: 7374 5f63 6861 6e67 655f 776f 726b 696e  st_change_workin
+0001e060: 675f 6469 7265 6374 6f72 7928 0a20 2020  g_directory(.   
+0001e070: 2020 2020 2073 656c 662c 0a20 2020 2020       self,.     
+0001e080: 2020 2063 6c69 656e 743a 2054 6573 7443     client: TestC
+0001e090: 6c69 656e 742c 0a20 2020 2020 2020 2073  lient,.        s
+0001e0a0: 7570 6572 7573 6572 5f74 6f6b 656e 5f68  uperuser_token_h
+0001e0b0: 6561 6465 7273 3a20 4469 6374 5b73 7472  eaders: Dict[str
+0001e0c0: 2c20 7374 725d 2c0a 2020 2020 2020 2020  , str],.        
+0001e0d0: 6b73 7065 635f 6e61 6d65 3a20 7374 722c  kspec_name: str,
+0001e0e0: 0a20 2020 2029 3a0a 2020 2020 2020 2020  .    ):.        
+0001e0f0: 776f 726b 696e 675f 6469 7265 6374 6f72  working_director
+0001e100: 7920 3d20 222f 746d 7022 0a20 2020 2020  y = "/tmp".     
+0001e110: 2020 2072 6573 6f6c 7665 645f 776f 726b     resolved_work
+0001e120: 5f64 6972 203d 2073 7472 2870 6174 686c  _dir = str(pathl
+0001e130: 6962 2e50 6174 6828 776f 726b 696e 675f  ib.Path(working_
+0001e140: 6469 7265 6374 6f72 7929 2e72 6573 6f6c  directory).resol
+0001e150: 7665 2829 290a 2020 2020 2020 2020 7265  ve()).        re
+0001e160: 7370 6f6e 7365 203d 2061 7761 6974 2063  sponse = await c
+0001e170: 6c69 656e 742e 706f 7374 280a 2020 2020  lient.post(.    
+0001e180: 2020 2020 2020 2020 222f 6e6f 7465 626f          "/notebo
+0001e190: 6f6b 732f 6372 6561 7465 222c 0a20 2020  oks/create",.   
+0001e1a0: 2020 2020 2020 2020 2071 7565 7279 5f73           query_s
+0001e1b0: 7472 696e 673d 7b0a 2020 2020 2020 2020  tring={.        
+0001e1c0: 2020 2020 2020 2020 226b 7370 6563 5f6e          "kspec_n
+0001e1d0: 616d 6522 3a20 6b73 7065 635f 6e61 6d65  ame": kspec_name
+0001e1e0: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
+0001e1f0: 2020 2266 696c 656e 616d 6522 3a20 2268    "filename": "h
+0001e200: 6579 7022 2c0a 2020 2020 2020 2020 2020  eyp",.          
+0001e210: 2020 2020 2020 2277 6f72 6b69 6e67 5f64        "working_d
+0001e220: 6972 6563 746f 7279 223a 2077 6f72 6b69  irectory": worki
+0001e230: 6e67 5f64 6972 6563 746f 7279 2c0a 2020  ng_directory,.  
+0001e240: 2020 2020 2020 2020 2020 7d2c 0a20 2020            },.   
+0001e250: 2020 2020 2020 2020 2068 6561 6465 7273           headers
+0001e260: 3d73 7570 6572 7573 6572 5f74 6f6b 656e  =superuser_token
+0001e270: 5f68 6561 6465 7273 2c0a 2020 2020 2020  _headers,.      
+0001e280: 2020 290a 2020 2020 2020 2020 6173 7365    ).        asse
+0001e290: 7274 2072 6573 706f 6e73 652e 7374 6174  rt response.stat
+0001e2a0: 7573 5f63 6f64 6520 3d3d 2032 3031 0a20  us_code == 201. 
+0001e2b0: 2020 2020 2020 2072 6573 705f 6a73 6f6e         resp_json
+0001e2c0: 203d 2072 6573 706f 6e73 652e 6a73 6f6e   = response.json
+0001e2d0: 2829 5b22 6e6f 7465 626f 6f6b 225d 0a20  ()["notebook"]. 
+0001e2e0: 2020 2020 2020 2075 7569 6420 3d20 7265         uuid = re
+0001e2f0: 7370 5f6a 736f 6e5b 226d 6574 6164 6174  sp_json["metadat
+0001e300: 6122 5d5b 226a 7570 7974 6572 5f64 3122  a"]["jupyter_d1"
+0001e310: 5d5b 2275 7569 6422 5d0a 0a20 2020 2020  ]["uuid"]..     
+0001e320: 2020 2074 6f6b 656e 203d 2067 6574 5f73     token = get_s
+0001e330: 7570 6572 7573 6572 5f74 6f6b 656e 2829  uperuser_token()
+0001e340: 0a20 2020 2020 2020 2061 7574 6820 3d20  .        auth = 
+0001e350: 6261 7365 3634 2e62 3634 656e 636f 6465  base64.b64encode
+0001e360: 2866 227b 746f 6b65 6e7d 3a22 2e65 6e63  (f"{token}:".enc
+0001e370: 6f64 6528 2275 7466 2d38 2229 290a 2020  ode("utf-8")).  
+0001e380: 2020 2020 2020 7265 7370 6f6e 7365 203d        response =
+0001e390: 2061 7761 6974 2063 6c69 656e 742e 6765   await client.ge
+0001e3a0: 7428 0a20 2020 2020 2020 2020 2020 2066  t(.            f
+0001e3b0: 222f 6461 767b 7265 736f 6c76 6564 5f77  "/dav{resolved_w
+0001e3c0: 6f72 6b5f 6469 727d 222c 0a20 2020 2020  ork_dir}",.     
+0001e3d0: 2020 2020 2020 2068 6561 6465 7273 3d7b         headers={
+0001e3e0: 2241 7574 686f 7269 7a61 7469 6f6e 223a  "Authorization":
+0001e3f0: 2066 2242 6173 6963 207b 6175 7468 2e64   f"Basic {auth.d
+0001e400: 6563 6f64 6528 2775 7466 2d38 2729 7d22  ecode('utf-8')}"
+0001e410: 7d2c 0a20 2020 2020 2020 2029 0a20 2020  },.        ).   
+0001e420: 2020 2020 2061 7373 6572 7420 7265 7370       assert resp
+0001e430: 6f6e 7365 2e73 7461 7475 735f 636f 6465  onse.status_code
+0001e440: 203d 3d20 3230 300a 0a20 2020 2020 2020   == 200..       
+0001e450: 2061 7379 6e63 2077 6974 6820 636c 6965   async with clie
+0001e460: 6e74 2e77 6562 736f 636b 6574 5f63 6f6e  nt.websocket_con
+0001e470: 6e65 6374 280a 2020 2020 2020 2020 2020  nect(.          
+0001e480: 2020 6622 2f6e 6f74 6562 6f6f 6b73 2f7b    f"/notebooks/{
+0001e490: 7575 6964 7d2f 7773 2f6e 6f74 6562 6f6f  uuid}/ws/noteboo
+0001e4a0: 6b22 2c20 6865 6164 6572 733d 7375 7065  k", headers=supe
+0001e4b0: 7275 7365 725f 746f 6b65 6e5f 6865 6164  ruser_token_head
+0001e4c0: 6572 730a 2020 2020 2020 2020 2920 6173  ers.        ) as
+0001e4d0: 2077 6562 736f 636b 6574 3a0a 2020 2020   websocket:.    
+0001e4e0: 2020 2020 2020 2020 6177 6169 7420 6173          await as
+0001e4f0: 796e 6369 6f2e 736c 6565 7028 5745 4253  yncio.sleep(WEBS
+0001e500: 4f43 4b45 545f 534c 4545 505f 5449 4d45  OCKET_SLEEP_TIME
+0001e510: 290a 0a20 2020 2020 2020 2020 2020 206e  )..            n
+0001e520: 6577 5f77 6f72 6b64 6972 203d 2066 227b  ew_workdir = f"{
+0001e530: 6f73 2e67 6574 6377 6428 297d 2f6a 7570  os.getcwd()}/jup
+0001e540: 7974 6572 5f64 312f 7465 7374 732f 6e6f  yter_d1/tests/no
+0001e550: 7465 626f 6f6b 7322 0a20 2020 2020 2020  tebooks".       
+0001e560: 2020 2020 2072 6573 706f 6e73 6520 3d20       response = 
+0001e570: 6177 6169 7420 636c 6965 6e74 2e70 6174  await client.pat
+0001e580: 6368 280a 2020 2020 2020 2020 2020 2020  ch(.            
+0001e590: 2020 2020 6622 2f6e 6f74 6562 6f6f 6b73      f"/notebooks
+0001e5a0: 2f7b 7575 6964 7d2f 6368 616e 6765 5f77  /{uuid}/change_w
+0001e5b0: 6f72 6b69 6e67 5f64 6972 6563 746f 7279  orking_directory
+0001e5c0: 222c 0a20 2020 2020 2020 2020 2020 2020  ",.             
+0001e5d0: 2020 2068 6561 6465 7273 3d73 7570 6572     headers=super
+0001e5e0: 7573 6572 5f74 6f6b 656e 5f68 6561 6465  user_token_heade
+0001e5f0: 7273 2c0a 2020 2020 2020 2020 2020 2020  rs,.            
+0001e600: 2020 2020 7175 6572 795f 7374 7269 6e67      query_string
+0001e610: 3d7b 2264 6972 6563 746f 7279 223a 206e  ={"directory": n
+0001e620: 6577 5f77 6f72 6b64 6972 7d2c 0a20 2020  ew_workdir},.   
+0001e630: 2020 2020 2020 2020 2029 0a20 2020 2020           ).     
+0001e640: 2020 2020 2020 2061 7373 6572 7420 7265         assert re
+0001e650: 7370 6f6e 7365 2e73 7461 7475 735f 636f  sponse.status_co
+0001e660: 6465 203d 3d20 3230 300a 0a20 2020 2020  de == 200..     
+0001e670: 2020 2020 2020 2064 6174 6120 3d20 6177         data = aw
+0001e680: 6169 7420 7265 6365 6976 655f 6a73 6f6e  ait receive_json
+0001e690: 2877 6562 736f 636b 6574 2c20 6d73 675f  (websocket, msg_
+0001e6a0: 7479 7065 733d 5b22 6d65 7461 6461 7461  types=["metadata
+0001e6b0: 225d 290a 0a20 2020 2020 2020 2020 2020  "])..           
+0001e6c0: 206d 6574 6164 6174 6120 3d20 6461 7461   metadata = data
+0001e6d0: 5b22 6d65 7461 6461 7461 225d 0a20 2020  ["metadata"].   
+0001e6e0: 2020 2020 2020 2020 2061 7373 6572 7420           assert 
+0001e6f0: 6d65 7461 6461 7461 5b22 6a75 7079 7465  metadata["jupyte
+0001e700: 725f 6431 225d 5b22 776f 726b 696e 675f  r_d1"]["working_
+0001e710: 6469 7265 6374 6f72 7922 5d20 3d3d 206e  directory"] == n
+0001e720: 6577 5f77 6f72 6b64 6972 0a0a 2020 2020  ew_workdir..    
+0001e730: 2020 2020 2020 2020 7265 7370 6f6e 7365          response
+0001e740: 203d 2061 7761 6974 2063 6c69 656e 742e   = await client.
+0001e750: 6765 7428 0a20 2020 2020 2020 2020 2020  get(.           
+0001e760: 2020 2020 2066 222f 6461 767b 6e65 775f       f"/dav{new_
+0001e770: 776f 726b 6469 727d 222c 0a20 2020 2020  workdir}",.     
+0001e780: 2020 2020 2020 2020 2020 2068 6561 6465             heade
+0001e790: 7273 3d7b 2241 7574 686f 7269 7a61 7469  rs={"Authorizati
+0001e7a0: 6f6e 223a 2066 2242 6173 6963 207b 6175  on": f"Basic {au
+0001e7b0: 7468 2e64 6563 6f64 6528 2775 7466 2d38  th.decode('utf-8
+0001e7c0: 2729 7d22 7d2c 0a20 2020 2020 2020 2020  ')}"},.         
+0001e7d0: 2020 2029 0a20 2020 2020 2020 2020 2020     ).           
+0001e7e0: 2061 7373 6572 7420 7265 7370 6f6e 7365   assert response
+0001e7f0: 2e73 7461 7475 735f 636f 6465 203d 3d20  .status_code == 
+0001e800: 3230 300a 0a20 2020 2020 2020 2020 2020  200..           
+0001e810: 2072 6573 706f 6e73 6520 3d20 6177 6169   response = awai
+0001e820: 7420 636c 6965 6e74 2e67 6574 280a 2020  t client.get(.  
+0001e830: 2020 2020 2020 2020 2020 2020 2020 6622                f"
+0001e840: 2f64 6176 7b72 6573 6f6c 7665 645f 776f  /dav{resolved_wo
+0001e850: 726b 5f64 6972 7d22 2c0a 2020 2020 2020  rk_dir}",.      
+0001e860: 2020 2020 2020 2020 2020 6865 6164 6572            header
+0001e870: 733d 7b22 4175 7468 6f72 697a 6174 696f  s={"Authorizatio
+0001e880: 6e22 3a20 6622 4261 7369 6320 7b61 7574  n": f"Basic {aut
+0001e890: 682e 6465 636f 6465 2827 7574 662d 3827  h.decode('utf-8'
+0001e8a0: 297d 227d 2c0a 2020 2020 2020 2020 2020  )}"},.          
+0001e8b0: 2020 290a 2020 2020 2020 2020 2020 2020    ).            
+0001e8c0: 6173 7365 7274 2072 6573 706f 6e73 652e  assert response.
+0001e8d0: 7374 6174 7573 5f63 6f64 6520 3d3d 2034  status_code == 4
+0001e8e0: 3034 0a0a 2020 2020 2020 2020 7265 7370  04..        resp
+0001e8f0: 6f6e 7365 203d 2061 7761 6974 2063 6c69  onse = await cli
+0001e900: 656e 742e 6765 7428 0a20 2020 2020 2020  ent.get(.       
+0001e910: 2020 2020 2066 222f 6e6f 7465 626f 6f6b       f"/notebook
+0001e920: 732f 7b75 7569 647d 222c 2068 6561 6465  s/{uuid}", heade
+0001e930: 7273 3d73 7570 6572 7573 6572 5f74 6f6b  rs=superuser_tok
+0001e940: 656e 5f68 6561 6465 7273 0a20 2020 2020  en_headers.     
+0001e950: 2020 2029 0a20 2020 2020 2020 2072 6573     ).        res
+0001e960: 705f 6a73 6f6e 203d 2072 6573 706f 6e73  p_json = respons
+0001e970: 652e 6a73 6f6e 2829 5b22 6e6f 7465 626f  e.json()["notebo
+0001e980: 6f6b 225d 0a20 2020 2020 2020 2061 7373  ok"].        ass
+0001e990: 6572 7420 280a 2020 2020 2020 2020 2020  ert (.          
+0001e9a0: 2020 7265 7370 5f6a 736f 6e5b 226d 6574    resp_json["met
+0001e9b0: 6164 6174 6122 5d5b 226a 7570 7974 6572  adata"]["jupyter
+0001e9c0: 5f64 3122 5d5b 2277 6f72 6b69 6e67 5f64  _d1"]["working_d
+0001e9d0: 6972 6563 746f 7279 225d 0a20 2020 2020  irectory"].     
+0001e9e0: 2020 2020 2020 203d 3d20 6e65 775f 776f         == new_wo
+0001e9f0: 726b 6469 720a 2020 2020 2020 2020 290a  rkdir.        ).
+0001ea00: 0a20 2020 2061 7379 6e63 2064 6566 2064  .    async def d
+0001ea10: 6f5f 7465 7374 5f63 6861 6e67 655f 776f  o_test_change_wo
+0001ea20: 726b 696e 675f 6469 7265 6374 6f72 795f  rking_directory_
+0001ea30: 696e 5f63 6f64 6528 0a20 2020 2020 2020  in_code(.       
+0001ea40: 2073 656c 662c 0a20 2020 2020 2020 2063   self,.        c
+0001ea50: 6c69 656e 743a 2054 6573 7443 6c69 656e  lient: TestClien
+0001ea60: 742c 0a20 2020 2020 2020 2073 7570 6572  t,.        super
+0001ea70: 7573 6572 5f74 6f6b 656e 5f68 6561 6465  user_token_heade
+0001ea80: 7273 3a20 4469 6374 5b73 7472 2c20 7374  rs: Dict[str, st
+0001ea90: 725d 2c0a 2020 2020 2020 2020 6b73 7065  r],.        kspe
+0001eaa0: 635f 6e61 6d65 3a20 7374 722c 0a20 2020  c_name: str,.   
+0001eab0: 2020 2020 2063 6864 6972 5f63 6f64 653a       chdir_code:
+0001eac0: 2073 7472 2c0a 2020 2020 293a 0a20 2020   str,.    ):.   
+0001ead0: 2020 2020 2077 6f72 6b69 6e67 5f64 6972       working_dir
+0001eae0: 6563 746f 7279 203d 2022 2f74 6d70 220a  ectory = "/tmp".
+0001eaf0: 2020 2020 2020 2020 7265 736f 6c76 6564          resolved
+0001eb00: 5f77 6f72 6b5f 6469 7220 3d20 7374 7228  _work_dir = str(
+0001eb10: 7061 7468 6c69 622e 5061 7468 2877 6f72  pathlib.Path(wor
+0001eb20: 6b69 6e67 5f64 6972 6563 746f 7279 292e  king_directory).
+0001eb30: 7265 736f 6c76 6528 2929 0a20 2020 2020  resolve()).     
+0001eb40: 2020 2072 6573 706f 6e73 6520 3d20 6177     response = aw
+0001eb50: 6169 7420 636c 6965 6e74 2e70 6f73 7428  ait client.post(
+0001eb60: 0a20 2020 2020 2020 2020 2020 2022 2f6e  .            "/n
+0001eb70: 6f74 6562 6f6f 6b73 2f63 7265 6174 6522  otebooks/create"
+0001eb80: 2c0a 2020 2020 2020 2020 2020 2020 7175  ,.            qu
+0001eb90: 6572 795f 7374 7269 6e67 3d7b 0a20 2020  ery_string={.   
+0001eba0: 2020 2020 2020 2020 2020 2020 2022 6b73               "ks
+0001ebb0: 7065 635f 6e61 6d65 223a 206b 7370 6563  pec_name": kspec
+0001ebc0: 5f6e 616d 652c 0a20 2020 2020 2020 2020  _name,.         
+0001ebd0: 2020 2020 2020 2022 6669 6c65 6e61 6d65         "filename
+0001ebe0: 223a 2022 6865 7970 222c 0a20 2020 2020  ": "heyp",.     
+0001ebf0: 2020 2020 2020 2020 2020 2022 776f 726b             "work
+0001ec00: 696e 675f 6469 7265 6374 6f72 7922 3a20  ing_directory": 
+0001ec10: 776f 726b 696e 675f 6469 7265 6374 6f72  working_director
+0001ec20: 792c 0a20 2020 2020 2020 2020 2020 207d  y,.            }
+0001ec30: 2c0a 2020 2020 2020 2020 2020 2020 6865  ,.            he
+0001ec40: 6164 6572 733d 7375 7065 7275 7365 725f  aders=superuser_
+0001ec50: 746f 6b65 6e5f 6865 6164 6572 732c 0a20  token_headers,. 
+0001ec60: 2020 2020 2020 2029 0a20 2020 2020 2020         ).       
+0001ec70: 2061 7373 6572 7420 7265 7370 6f6e 7365   assert response
+0001ec80: 2e73 7461 7475 735f 636f 6465 203d 3d20  .status_code == 
+0001ec90: 3230 310a 2020 2020 2020 2020 7265 7370  201.        resp
+0001eca0: 5f6a 736f 6e20 3d20 7265 7370 6f6e 7365  _json = response
+0001ecb0: 2e6a 736f 6e28 295b 226e 6f74 6562 6f6f  .json()["noteboo
+0001ecc0: 6b22 5d0a 2020 2020 2020 2020 7575 6964  k"].        uuid
+0001ecd0: 203d 2072 6573 705f 6a73 6f6e 5b22 6d65   = resp_json["me
+0001ece0: 7461 6461 7461 225d 5b22 6a75 7079 7465  tadata"]["jupyte
+0001ecf0: 725f 6431 225d 5b22 7575 6964 225d 0a0a  r_d1"]["uuid"]..
+0001ed00: 2020 2020 2020 2020 746f 6b65 6e20 3d20          token = 
+0001ed10: 6765 745f 7375 7065 7275 7365 725f 746f  get_superuser_to
+0001ed20: 6b65 6e28 290a 2020 2020 2020 2020 6175  ken().        au
+0001ed30: 7468 203d 2062 6173 6536 342e 6236 3465  th = base64.b64e
+0001ed40: 6e63 6f64 6528 6622 7b74 6f6b 656e 7d3a  ncode(f"{token}:
+0001ed50: 222e 656e 636f 6465 2822 7574 662d 3822  ".encode("utf-8"
+0001ed60: 2929 0a20 2020 2020 2020 2072 6573 706f  )).        respo
+0001ed70: 6e73 6520 3d20 6177 6169 7420 636c 6965  nse = await clie
+0001ed80: 6e74 2e67 6574 280a 2020 2020 2020 2020  nt.get(.        
+0001ed90: 2020 2020 6622 2f64 6176 7b72 6573 6f6c      f"/dav{resol
+0001eda0: 7665 645f 776f 726b 5f64 6972 7d22 2c0a  ved_work_dir}",.
+0001edb0: 2020 2020 2020 2020 2020 2020 6865 6164              head
+0001edc0: 6572 733d 7b22 4175 7468 6f72 697a 6174  ers={"Authorizat
+0001edd0: 696f 6e22 3a20 6622 4261 7369 6320 7b61  ion": f"Basic {a
+0001ede0: 7574 682e 6465 636f 6465 2827 7574 662d  uth.decode('utf-
+0001edf0: 3827 297d 227d 2c0a 2020 2020 2020 2020  8')}"},.        
+0001ee00: 290a 2020 2020 2020 2020 6173 7365 7274  ).        assert
+0001ee10: 2072 6573 706f 6e73 652e 7374 6174 7573   response.status
+0001ee20: 5f63 6f64 6520 3d3d 2032 3030 0a0a 2020  _code == 200..  
+0001ee30: 2020 2020 2020 6173 796e 6320 7769 7468        async with
+0001ee40: 2063 6c69 656e 742e 7765 6273 6f63 6b65   client.websocke
+0001ee50: 745f 636f 6e6e 6563 7428 0a20 2020 2020  t_connect(.     
+0001ee60: 2020 2020 2020 2066 222f 6e6f 7465 626f         f"/notebo
+0001ee70: 6f6b 732f 7b75 7569 647d 2f77 732f 6e6f  oks/{uuid}/ws/no
+0001ee80: 7465 626f 6f6b 222c 2068 6561 6465 7273  tebook", headers
+0001ee90: 3d73 7570 6572 7573 6572 5f74 6f6b 656e  =superuser_token
+0001eea0: 5f68 6561 6465 7273 0a20 2020 2020 2020  _headers.       
+0001eeb0: 2029 2061 7320 7765 6273 6f63 6b65 743a   ) as websocket:
+0001eec0: 0a20 2020 2020 2020 2020 2020 2061 7761  .            awa
+0001eed0: 6974 2061 7379 6e63 696f 2e73 6c65 6570  it asyncio.sleep
+0001eee0: 2857 4542 534f 434b 4554 5f53 4c45 4550  (WEBSOCKET_SLEEP
+0001eef0: 5f54 494d 4529 0a0a 2020 2020 2020 2020  _TIME)..        
+0001ef00: 2020 2020 6e65 775f 776f 726b 6469 7220      new_workdir 
+0001ef10: 3d20 6622 7b6f 732e 6765 7463 7764 2829  = f"{os.getcwd()
+0001ef20: 7d2f 6a75 7079 7465 725f 6431 2f74 6573  }/jupyter_d1/tes
+0001ef30: 7473 2f6e 6f74 6562 6f6f 6b73 220a 2020  ts/notebooks".  
+0001ef40: 2020 2020 2020 2020 2020 7265 7370 6f6e            respon
+0001ef50: 7365 203d 2061 7761 6974 2063 6c69 656e  se = await clien
+0001ef60: 742e 706f 7374 280a 2020 2020 2020 2020  t.post(.        
+0001ef70: 2020 2020 2020 2020 6622 2f6e 6f74 6562          f"/noteb
+0001ef80: 6f6f 6b73 2f7b 7575 6964 7d2f 7363 7261  ooks/{uuid}/scra
+0001ef90: 7463 685f 6578 6563 7574 6522 2c0a 2020  tch_execute",.  
+0001efa0: 2020 2020 2020 2020 2020 2020 2020 6865                he
+0001efb0: 6164 6572 733d 7375 7065 7275 7365 725f  aders=superuser_
+0001efc0: 746f 6b65 6e5f 6865 6164 6572 732c 0a20  token_headers,. 
+0001efd0: 2020 2020 2020 2020 2020 2020 2020 206a                 j
+0001efe0: 736f 6e3d 7b22 636f 6465 223a 2063 6864  son={"code": chd
+0001eff0: 6972 5f63 6f64 652e 666f 726d 6174 286e  ir_code.format(n
+0001f000: 6577 5f77 6f72 6b64 6972 3d6e 6577 5f77  ew_workdir=new_w
+0001f010: 6f72 6b64 6972 297d 2c0a 2020 2020 2020  orkdir)},.      
+0001f020: 2020 2020 2020 290a 2020 2020 2020 2020        ).        
+0001f030: 2020 2020 6173 7365 7274 2072 6573 706f      assert respo
+0001f040: 6e73 652e 7374 6174 7573 5f63 6f64 6520  nse.status_code 
+0001f050: 3d3d 2032 3030 0a0a 2020 2020 2020 2020  == 200..        
+0001f060: 2020 2020 6461 7461 203d 2061 7761 6974      data = await
+0001f070: 2077 6169 745f 666f 725f 6576 656e 7428   wait_for_event(
+0001f080: 7765 6273 6f63 6b65 742c 2022 6d65 7461  websocket, "meta
+0001f090: 6461 7461 222c 2074 696d 656f 7574 3d31  data", timeout=1
+0001f0a0: 3029 0a0a 2020 2020 2020 2020 2020 2020  0)..            
+0001f0b0: 6d65 7461 6461 7461 203d 2064 6174 615b  metadata = data[
+0001f0c0: 226d 6574 6164 6174 6122 5d0a 2020 2020  "metadata"].    
+0001f0d0: 2020 2020 2020 2020 6173 7365 7274 206d          assert m
+0001f0e0: 6574 6164 6174 615b 226a 7570 7974 6572  etadata["jupyter
+0001f0f0: 5f64 3122 5d5b 2277 6f72 6b69 6e67 5f64  _d1"]["working_d
+0001f100: 6972 6563 746f 7279 225d 203d 3d20 6e65  irectory"] == ne
+0001f110: 775f 776f 726b 6469 720a 0a20 2020 2020  w_workdir..     
+0001f120: 2020 2020 2020 2072 6573 706f 6e73 6520         response 
+0001f130: 3d20 6177 6169 7420 636c 6965 6e74 2e67  = await client.g
+0001f140: 6574 280a 2020 2020 2020 2020 2020 2020  et(.            
+0001f150: 2020 2020 6622 2f64 6176 7b6e 6577 5f77      f"/dav{new_w
+0001f160: 6f72 6b64 6972 7d22 2c0a 2020 2020 2020  orkdir}",.      
+0001f170: 2020 2020 2020 2020 2020 6865 6164 6572            header
+0001f180: 733d 7b22 4175 7468 6f72 697a 6174 696f  s={"Authorizatio
+0001f190: 6e22 3a20 6622 4261 7369 6320 7b61 7574  n": f"Basic {aut
+0001f1a0: 682e 6465 636f 6465 2827 7574 662d 3827  h.decode('utf-8'
+0001f1b0: 297d 227d 2c0a 2020 2020 2020 2020 2020  )}"},.          
+0001f1c0: 2020 290a 2020 2020 2020 2020 2020 2020    ).            
+0001f1d0: 6173 7365 7274 2072 6573 706f 6e73 652e  assert response.
+0001f1e0: 7374 6174 7573 5f63 6f64 6520 3d3d 2032  status_code == 2
+0001f1f0: 3030 0a0a 2020 2020 2020 2020 2020 2020  00..            
+0001f200: 7265 7370 6f6e 7365 203d 2061 7761 6974  response = await
+0001f210: 2063 6c69 656e 742e 6765 7428 0a20 2020   client.get(.   
+0001f220: 2020 2020 2020 2020 2020 2020 2066 222f               f"/
+0001f230: 6461 767b 7265 736f 6c76 6564 5f77 6f72  dav{resolved_wor
+0001f240: 6b5f 6469 727d 222c 0a20 2020 2020 2020  k_dir}",.       
+0001f250: 2020 2020 2020 2020 2068 6561 6465 7273           headers
+0001f260: 3d7b 2241 7574 686f 7269 7a61 7469 6f6e  ={"Authorization
+0001f270: 223a 2066 2242 6173 6963 207b 6175 7468  ": f"Basic {auth
+0001f280: 2e64 6563 6f64 6528 2775 7466 2d38 2729  .decode('utf-8')
+0001f290: 7d22 7d2c 0a20 2020 2020 2020 2020 2020  }"},.           
+0001f2a0: 2029 0a20 2020 2020 2020 2020 2020 2061   ).            a
+0001f2b0: 7373 6572 7420 7265 7370 6f6e 7365 2e73  ssert response.s
+0001f2c0: 7461 7475 735f 636f 6465 203d 3d20 3430  tatus_code == 40
+0001f2d0: 340a 0a20 2020 2020 2020 2072 6573 706f  4..        respo
+0001f2e0: 6e73 6520 3d20 6177 6169 7420 636c 6965  nse = await clie
+0001f2f0: 6e74 2e67 6574 280a 2020 2020 2020 2020  nt.get(.        
+0001f300: 2020 2020 6622 2f6e 6f74 6562 6f6f 6b73      f"/notebooks
+0001f310: 2f7b 7575 6964 7d22 2c20 6865 6164 6572  /{uuid}", header
+0001f320: 733d 7375 7065 7275 7365 725f 746f 6b65  s=superuser_toke
+0001f330: 6e5f 6865 6164 6572 730a 2020 2020 2020  n_headers.      
+0001f340: 2020 290a 2020 2020 2020 2020 7265 7370    ).        resp
+0001f350: 5f6a 736f 6e20 3d20 7265 7370 6f6e 7365  _json = response
+0001f360: 2e6a 736f 6e28 295b 226e 6f74 6562 6f6f  .json()["noteboo
+0001f370: 6b22 5d0a 2020 2020 2020 2020 6173 7365  k"].        asse
+0001f380: 7274 2028 0a20 2020 2020 2020 2020 2020  rt (.           
+0001f390: 2072 6573 705f 6a73 6f6e 5b22 6d65 7461   resp_json["meta
+0001f3a0: 6461 7461 225d 5b22 6a75 7079 7465 725f  data"]["jupyter_
+0001f3b0: 6431 225d 5b22 776f 726b 696e 675f 6469  d1"]["working_di
+0001f3c0: 7265 6374 6f72 7922 5d0a 2020 2020 2020  rectory"].      
+0001f3d0: 2020 2020 2020 3d3d 206e 6577 5f77 6f72        == new_wor
+0001f3e0: 6b64 6972 0a20 2020 2020 2020 2029 0a0a  kdir.        )..
+0001f3f0: 2020 2020 4070 7974 6573 742e 6d61 726b      @pytest.mark
+0001f400: 2e61 7379 6e63 696f 0a20 2020 2061 7379  .asyncio.    asy
+0001f410: 6e63 2064 6566 2074 6573 745f 7079 7468  nc def test_pyth
+0001f420: 6f6e 5f63 6861 6e67 655f 776f 726b 696e  on_change_workin
+0001f430: 675f 6469 7265 6374 6f72 795f 656e 6470  g_directory_endp
+0001f440: 6f69 6e74 280a 2020 2020 2020 2020 7365  oint(.        se
+0001f450: 6c66 2c20 636c 6965 6e74 3a20 5465 7374  lf, client: Test
+0001f460: 436c 6965 6e74 2c20 7375 7065 7275 7365  Client, superuse
+0001f470: 725f 746f 6b65 6e5f 6865 6164 6572 733a  r_token_headers:
+0001f480: 2044 6963 745b 7374 722c 2073 7472 5d0a   Dict[str, str].
+0001f490: 2020 2020 293a 0a20 2020 2020 2020 2061      ):.        a
+0001f4a0: 7761 6974 2073 656c 662e 646f 5f74 6573  wait self.do_tes
+0001f4b0: 745f 6368 616e 6765 5f77 6f72 6b69 6e67  t_change_working
+0001f4c0: 5f64 6972 6563 746f 7279 280a 2020 2020  _directory(.    
+0001f4d0: 2020 2020 2020 2020 636c 6965 6e74 2c20          client, 
+0001f4e0: 7375 7065 7275 7365 725f 746f 6b65 6e5f  superuser_token_
+0001f4f0: 6865 6164 6572 732c 2022 7079 7468 6f6e  headers, "python
+0001f500: 220a 2020 2020 2020 2020 290a 0a20 2020  ".        )..   
+0001f510: 2040 7079 7465 7374 2e6d 6172 6b2e 6173   @pytest.mark.as
+0001f520: 796e 6369 6f0a 2020 2020 6173 796e 6320  yncio.    async 
+0001f530: 6465 6620 7465 7374 5f70 7974 686f 6e5f  def test_python_
+0001f540: 6368 616e 6765 5f77 6f72 6b69 6e67 5f64  change_working_d
+0001f550: 6972 6563 746f 7279 5f69 6e5f 636f 6465  irectory_in_code
+0001f560: 280a 2020 2020 2020 2020 7365 6c66 2c20  (.        self, 
+0001f570: 636c 6965 6e74 3a20 5465 7374 436c 6965  client: TestClie
+0001f580: 6e74 2c20 7375 7065 7275 7365 725f 746f  nt, superuser_to
+0001f590: 6b65 6e5f 6865 6164 6572 733a 2044 6963  ken_headers: Dic
+0001f5a0: 745b 7374 722c 2073 7472 5d0a 2020 2020  t[str, str].    
+0001f5b0: 293a 0a20 2020 2020 2020 2061 7761 6974  ):.        await
+0001f5c0: 2073 656c 662e 646f 5f74 6573 745f 6368   self.do_test_ch
+0001f5d0: 616e 6765 5f77 6f72 6b69 6e67 5f64 6972  ange_working_dir
+0001f5e0: 6563 746f 7279 5f69 6e5f 636f 6465 280a  ectory_in_code(.
+0001f5f0: 2020 2020 2020 2020 2020 2020 636c 6965              clie
+0001f600: 6e74 2c0a 2020 2020 2020 2020 2020 2020  nt,.            
+0001f610: 7375 7065 7275 7365 725f 746f 6b65 6e5f  superuser_token_
+0001f620: 6865 6164 6572 732c 0a20 2020 2020 2020  headers,.       
+0001f630: 2020 2020 2022 7079 7468 6f6e 222c 0a20       "python",. 
+0001f640: 2020 2020 2020 2020 2020 2027 696d 706f             'impo
+0001f650: 7274 206f 735c 6e6f 732e 6368 6469 7228  rt os\nos.chdir(
+0001f660: 227b 6e65 775f 776f 726b 6469 727d 2229  "{new_workdir}")
+0001f670: 272c 0a20 2020 2020 2020 2029 0a0a 2020  ',.        )..  
+0001f680: 2020 4070 7974 6573 742e 6d61 726b 2e61    @pytest.mark.a
+0001f690: 7379 6e63 696f 0a20 2020 2061 7379 6e63  syncio.    async
+0001f6a0: 2064 6566 2074 6573 745f 725f 6368 616e   def test_r_chan
+0001f6b0: 6765 5f77 6f72 6b69 6e67 5f64 6972 6563  ge_working_direc
+0001f6c0: 746f 7279 5f65 6e64 706f 696e 7428 0a20  tory_endpoint(. 
+0001f6d0: 2020 2020 2020 2073 656c 662c 2063 6c69         self, cli
+0001f6e0: 656e 743a 2054 6573 7443 6c69 656e 742c  ent: TestClient,
+0001f6f0: 2073 7570 6572 7573 6572 5f74 6f6b 656e   superuser_token
+0001f700: 5f68 6561 6465 7273 3a20 4469 6374 5b73  _headers: Dict[s
+0001f710: 7472 2c20 7374 725d 0a20 2020 2029 3a0a  tr, str].    ):.
+0001f720: 2020 2020 2020 2020 6177 6169 7420 7365          await se
+0001f730: 6c66 2e64 6f5f 7465 7374 5f63 6861 6e67  lf.do_test_chang
+0001f740: 655f 776f 726b 696e 675f 6469 7265 6374  e_working_direct
+0001f750: 6f72 7928 0a20 2020 2020 2020 2020 2020  ory(.           
+0001f760: 2063 6c69 656e 742c 2073 7570 6572 7573   client, superus
+0001f770: 6572 5f74 6f6b 656e 5f68 6561 6465 7273  er_token_headers
+0001f780: 2c20 2269 7222 0a20 2020 2020 2020 2029  , "ir".        )
+0001f790: 0a0a 2020 2020 4070 7974 6573 742e 6d61  ..    @pytest.ma
+0001f7a0: 726b 2e61 7379 6e63 696f 0a20 2020 2061  rk.asyncio.    a
+0001f7b0: 7379 6e63 2064 6566 2074 6573 745f 725f  sync def test_r_
+0001f7c0: 6368 616e 6765 5f77 6f72 6b69 6e67 5f64  change_working_d
+0001f7d0: 6972 6563 746f 7279 5f69 6e5f 636f 6465  irectory_in_code
+0001f7e0: 280a 2020 2020 2020 2020 7365 6c66 2c20  (.        self, 
+0001f7f0: 636c 6965 6e74 3a20 5465 7374 436c 6965  client: TestClie
+0001f800: 6e74 2c20 7375 7065 7275 7365 725f 746f  nt, superuser_to
+0001f810: 6b65 6e5f 6865 6164 6572 733a 2044 6963  ken_headers: Dic
+0001f820: 745b 7374 722c 2073 7472 5d0a 2020 2020  t[str, str].    
+0001f830: 293a 0a20 2020 2020 2020 2061 7761 6974  ):.        await
+0001f840: 2073 656c 662e 646f 5f74 6573 745f 6368   self.do_test_ch
+0001f850: 616e 6765 5f77 6f72 6b69 6e67 5f64 6972  ange_working_dir
+0001f860: 6563 746f 7279 5f69 6e5f 636f 6465 280a  ectory_in_code(.
+0001f870: 2020 2020 2020 2020 2020 2020 636c 6965              clie
+0001f880: 6e74 2c20 7375 7065 7275 7365 725f 746f  nt, superuser_to
+0001f890: 6b65 6e5f 6865 6164 6572 732c 2022 6972  ken_headers, "ir
+0001f8a0: 222c 2027 7365 7477 6428 227b 6e65 775f  ", 'setwd("{new_
+0001f8b0: 776f 726b 6469 727d 2229 270a 2020 2020  workdir}")'.    
+0001f8c0: 2020 2020 290a 0a20 2020 2040 7079 7465      )..    @pyte
+0001f8d0: 7374 2e6d 6172 6b2e 6173 796e 6369 6f0a  st.mark.asyncio.
+0001f8e0: 2020 2020 6173 796e 6320 6465 6620 7465      async def te
+0001f8f0: 7374 5f62 6173 685f 6368 616e 6765 5f77  st_bash_change_w
+0001f900: 6f72 6b69 6e67 5f64 6972 6563 746f 7279  orking_directory
+0001f910: 5f65 6e64 706f 696e 7428 0a20 2020 2020  _endpoint(.     
+0001f920: 2020 2073 656c 662c 2063 6c69 656e 743a     self, client:
+0001f930: 2054 6573 7443 6c69 656e 742c 2073 7570   TestClient, sup
+0001f940: 6572 7573 6572 5f74 6f6b 656e 5f68 6561  eruser_token_hea
+0001f950: 6465 7273 3a20 4469 6374 5b73 7472 2c20  ders: Dict[str, 
+0001f960: 7374 725d 0a20 2020 2029 3a0a 2020 2020  str].    ):.    
+0001f970: 2020 2020 6177 6169 7420 7365 6c66 2e64      await self.d
+0001f980: 6f5f 7465 7374 5f63 6861 6e67 655f 776f  o_test_change_wo
+0001f990: 726b 696e 675f 6469 7265 6374 6f72 7928  rking_directory(
+0001f9a0: 0a20 2020 2020 2020 2020 2020 2063 6c69  .            cli
+0001f9b0: 656e 742c 2073 7570 6572 7573 6572 5f74  ent, superuser_t
+0001f9c0: 6f6b 656e 5f68 6561 6465 7273 2c20 2262  oken_headers, "b
+0001f9d0: 6173 6822 0a20 2020 2020 2020 2029 0a0a  ash".        )..
+0001f9e0: 2020 2020 4070 7974 6573 742e 6d61 726b      @pytest.mark
+0001f9f0: 2e61 7379 6e63 696f 0a20 2020 2061 7379  .asyncio.    asy
+0001fa00: 6e63 2064 6566 2074 6573 745f 6261 7368  nc def test_bash
+0001fa10: 5f63 6861 6e67 655f 776f 726b 696e 675f  _change_working_
+0001fa20: 6469 7265 6374 6f72 795f 696e 5f63 6f64  directory_in_cod
+0001fa30: 6528 0a20 2020 2020 2020 2073 656c 662c  e(.        self,
+0001fa40: 2063 6c69 656e 743a 2054 6573 7443 6c69   client: TestCli
+0001fa50: 656e 742c 2073 7570 6572 7573 6572 5f74  ent, superuser_t
+0001fa60: 6f6b 656e 5f68 6561 6465 7273 3a20 4469  oken_headers: Di
+0001fa70: 6374 5b73 7472 2c20 7374 725d 0a20 2020  ct[str, str].   
+0001fa80: 2029 3a0a 2020 2020 2020 2020 6177 6169   ):.        awai
+0001fa90: 7420 7365 6c66 2e64 6f5f 7465 7374 5f63  t self.do_test_c
+0001faa0: 6861 6e67 655f 776f 726b 696e 675f 6469  hange_working_di
+0001fab0: 7265 6374 6f72 795f 696e 5f63 6f64 6528  rectory_in_code(
+0001fac0: 0a20 2020 2020 2020 2020 2020 2063 6c69  .            cli
+0001fad0: 656e 742c 2073 7570 6572 7573 6572 5f74  ent, superuser_t
+0001fae0: 6f6b 656e 5f68 6561 6465 7273 2c20 2262  oken_headers, "b
+0001faf0: 6173 6822 2c20 2263 6420 7b6e 6577 5f77  ash", "cd {new_w
+0001fb00: 6f72 6b64 6972 7d22 0a20 2020 2020 2020  orkdir}".       
+0001fb10: 2029 0a0a 2020 2020 4070 7974 6573 742e   )..    @pytest.
+0001fb20: 6d61 726b 2e61 7379 6e63 696f 0a20 2020  mark.asyncio.   
+0001fb30: 2061 7379 6e63 2064 6566 2074 6573 745f   async def test_
+0001fb40: 6368 616e 6765 5f77 6f72 6b69 6e67 5f64  change_working_d
+0001fb50: 6972 6563 746f 7279 5f66 6169 6c5f 696e  irectory_fail_in
+0001fb60: 7661 6c69 645f 6469 7265 6374 6f72 7928  valid_directory(
+0001fb70: 0a20 2020 2020 2020 2073 656c 662c 2063  .        self, c
+0001fb80: 6c69 656e 743a 2054 6573 7443 6c69 656e  lient: TestClien
+0001fb90: 742c 2073 7570 6572 7573 6572 5f74 6f6b  t, superuser_tok
+0001fba0: 656e 5f68 6561 6465 7273 3a20 4469 6374  en_headers: Dict
+0001fbb0: 5b73 7472 2c20 7374 725d 0a20 2020 2029  [str, str].    )
+0001fbc0: 3a0a 2020 2020 2020 2020 776f 726b 696e  :.        workin
+0001fbd0: 675f 6469 7265 6374 6f72 7920 3d20 222f  g_directory = "/
+0001fbe0: 746d 7022 0a20 2020 2020 2020 2072 6573  tmp".        res
+0001fbf0: 6f6c 7665 645f 776f 726b 5f64 6972 203d  olved_work_dir =
+0001fc00: 2073 7472 2870 6174 686c 6962 2e50 6174   str(pathlib.Pat
+0001fc10: 6828 776f 726b 696e 675f 6469 7265 6374  h(working_direct
+0001fc20: 6f72 7929 2e72 6573 6f6c 7665 2829 290a  ory).resolve()).
+0001fc30: 2020 2020 2020 2020 7265 7370 6f6e 7365          response
+0001fc40: 203d 2061 7761 6974 2063 6c69 656e 742e   = await client.
+0001fc50: 706f 7374 280a 2020 2020 2020 2020 2020  post(.          
+0001fc60: 2020 222f 6e6f 7465 626f 6f6b 732f 6372    "/notebooks/cr
+0001fc70: 6561 7465 222c 0a20 2020 2020 2020 2020  eate",.         
+0001fc80: 2020 2071 7565 7279 5f73 7472 696e 673d     query_string=
+0001fc90: 7b0a 2020 2020 2020 2020 2020 2020 2020  {.              
+0001fca0: 2020 226b 7370 6563 5f6e 616d 6522 3a20    "kspec_name": 
+0001fcb0: 2270 7974 686f 6e22 2c0a 2020 2020 2020  "python",.      
+0001fcc0: 2020 2020 2020 2020 2020 2266 696c 656e            "filen
+0001fcd0: 616d 6522 3a20 2268 6579 7022 2c0a 2020  ame": "heyp",.  
+0001fce0: 2020 2020 2020 2020 2020 2020 2020 2277                "w
+0001fcf0: 6f72 6b69 6e67 5f64 6972 6563 746f 7279  orking_directory
+0001fd00: 223a 2077 6f72 6b69 6e67 5f64 6972 6563  ": working_direc
+0001fd10: 746f 7279 2c0a 2020 2020 2020 2020 2020  tory,.          
+0001fd20: 2020 7d2c 0a20 2020 2020 2020 2020 2020    },.           
+0001fd30: 2068 6561 6465 7273 3d73 7570 6572 7573   headers=superus
+0001fd40: 6572 5f74 6f6b 656e 5f68 6561 6465 7273  er_token_headers
+0001fd50: 2c0a 2020 2020 2020 2020 290a 2020 2020  ,.        ).    
+0001fd60: 2020 2020 6173 7365 7274 2072 6573 706f      assert respo
+0001fd70: 6e73 652e 7374 6174 7573 5f63 6f64 6520  nse.status_code 
+0001fd80: 3d3d 2032 3031 0a20 2020 2020 2020 2072  == 201.        r
+0001fd90: 6573 705f 6a73 6f6e 203d 2072 6573 706f  esp_json = respo
+0001fda0: 6e73 652e 6a73 6f6e 2829 5b22 6e6f 7465  nse.json()["note
+0001fdb0: 626f 6f6b 225d 0a20 2020 2020 2020 2075  book"].        u
+0001fdc0: 7569 6420 3d20 7265 7370 5f6a 736f 6e5b  uid = resp_json[
+0001fdd0: 226d 6574 6164 6174 6122 5d5b 226a 7570  "metadata"]["jup
+0001fde0: 7974 6572 5f64 3122 5d5b 2275 7569 6422  yter_d1"]["uuid"
+0001fdf0: 5d0a 0a20 2020 2020 2020 2074 6f6b 656e  ]..        token
+0001fe00: 203d 2067 6574 5f73 7570 6572 7573 6572   = get_superuser
+0001fe10: 5f74 6f6b 656e 2829 0a20 2020 2020 2020  _token().       
+0001fe20: 2061 7574 6820 3d20 6261 7365 3634 2e62   auth = base64.b
+0001fe30: 3634 656e 636f 6465 2866 227b 746f 6b65  64encode(f"{toke
+0001fe40: 6e7d 3a22 2e65 6e63 6f64 6528 2275 7466  n}:".encode("utf
+0001fe50: 2d38 2229 290a 2020 2020 2020 2020 7265  -8")).        re
+0001fe60: 7370 6f6e 7365 203d 2061 7761 6974 2063  sponse = await c
+0001fe70: 6c69 656e 742e 6765 7428 0a20 2020 2020  lient.get(.     
+0001fe80: 2020 2020 2020 2066 222f 6461 767b 7265         f"/dav{re
+0001fe90: 736f 6c76 6564 5f77 6f72 6b5f 6469 727d  solved_work_dir}
+0001fea0: 222c 0a20 2020 2020 2020 2020 2020 2068  ",.            h
+0001feb0: 6561 6465 7273 3d7b 2241 7574 686f 7269  eaders={"Authori
+0001fec0: 7a61 7469 6f6e 223a 2066 2242 6173 6963  zation": f"Basic
+0001fed0: 207b 6175 7468 2e64 6563 6f64 6528 2775   {auth.decode('u
+0001fee0: 7466 2d38 2729 7d22 7d2c 0a20 2020 2020  tf-8')}"},.     
+0001fef0: 2020 2029 0a20 2020 2020 2020 2061 7373     ).        ass
+0001ff00: 6572 7420 7265 7370 6f6e 7365 2e73 7461  ert response.sta
+0001ff10: 7475 735f 636f 6465 203d 3d20 3230 300a  tus_code == 200.
+0001ff20: 0a20 2020 2020 2020 2061 7761 6974 2061  .        await a
+0001ff30: 7379 6e63 696f 2e73 6c65 6570 2857 4542  syncio.sleep(WEB
+0001ff40: 534f 434b 4554 5f53 4c45 4550 5f54 494d  SOCKET_SLEEP_TIM
+0001ff50: 4529 0a0a 2020 2020 2020 2020 6e65 775f  E)..        new_
+0001ff60: 776f 726b 6469 7220 3d20 6622 7b6f 732e  workdir = f"{os.
+0001ff70: 6765 7463 7764 2829 7d2f 7465 7374 732f  getcwd()}/tests/
+0001ff80: 6e6f 7472 6561 6c64 6972 220a 2020 2020  notrealdir".    
+0001ff90: 2020 2020 7265 7370 6f6e 7365 203d 2061      response = a
+0001ffa0: 7761 6974 2063 6c69 656e 742e 7061 7463  wait client.patc
+0001ffb0: 6828 0a20 2020 2020 2020 2020 2020 2066  h(.            f
+0001ffc0: 222f 6e6f 7465 626f 6f6b 732f 7b75 7569  "/notebooks/{uui
+0001ffd0: 647d 2f63 6861 6e67 655f 776f 726b 696e  d}/change_workin
+0001ffe0: 675f 6469 7265 6374 6f72 7922 2c0a 2020  g_directory",.  
+0001fff0: 2020 2020 2020 2020 2020 6865 6164 6572            header
+00020000: 733d 7375 7065 7275 7365 725f 746f 6b65  s=superuser_toke
+00020010: 6e5f 6865 6164 6572 732c 0a20 2020 2020  n_headers,.     
+00020020: 2020 2020 2020 2071 7565 7279 5f73 7472         query_str
+00020030: 696e 673d 7b22 6469 7265 6374 6f72 7922  ing={"directory"
+00020040: 3a20 6e65 775f 776f 726b 6469 727d 2c0a  : new_workdir},.
+00020050: 2020 2020 2020 2020 290a 2020 2020 2020          ).      
+00020060: 2020 6173 7365 7274 2072 6573 706f 6e73    assert respons
+00020070: 652e 7374 6174 7573 5f63 6f64 6520 3d3d  e.status_code ==
+00020080: 2034 3034 0a20 2020 2020 2020 2061 7373   404.        ass
+00020090: 6572 7420 7265 7370 6f6e 7365 2e6a 736f  ert response.jso
+000200a0: 6e28 295b 2264 6574 6169 6c22 5d20 3d3d  n()["detail"] ==
+000200b0: 2022 4469 7265 6374 6f72 7920 646f 6573   "Directory does
+000200c0: 206e 6f74 2065 7869 7374 220a 0a20 2020   not exist"..   
+000200d0: 2020 2020 2061 7761 6974 2061 7379 6e63       await async
+000200e0: 696f 2e73 6c65 6570 2832 290a 0a20 2020  io.sleep(2)..   
+000200f0: 2020 2020 2072 6573 706f 6e73 6520 3d20       response = 
+00020100: 6177 6169 7420 636c 6965 6e74 2e67 6574  await client.get
+00020110: 280a 2020 2020 2020 2020 2020 2020 6622  (.            f"
+00020120: 2f64 6176 7b6e 6577 5f77 6f72 6b64 6972  /dav{new_workdir
+00020130: 7d22 2c0a 2020 2020 2020 2020 2020 2020  }",.            
+00020140: 6865 6164 6572 733d 7b22 4175 7468 6f72  headers={"Author
+00020150: 697a 6174 696f 6e22 3a20 6622 4261 7369  ization": f"Basi
+00020160: 6320 7b61 7574 682e 6465 636f 6465 2827  c {auth.decode('
+00020170: 7574 662d 3827 297d 227d 2c0a 2020 2020  utf-8')}"},.    
+00020180: 2020 2020 290a 2020 2020 2020 2020 6173      ).        as
+00020190: 7365 7274 2072 6573 706f 6e73 652e 7374  sert response.st
+000201a0: 6174 7573 5f63 6f64 6520 3d3d 2034 3034  atus_code == 404
+000201b0: 0a0a 2020 2020 2020 2020 7265 7370 6f6e  ..        respon
+000201c0: 7365 203d 2061 7761 6974 2063 6c69 656e  se = await clien
+000201d0: 742e 6765 7428 0a20 2020 2020 2020 2020  t.get(.         
+000201e0: 2020 2066 222f 6461 767b 7265 736f 6c76     f"/dav{resolv
+000201f0: 6564 5f77 6f72 6b5f 6469 727d 222c 0a20  ed_work_dir}",. 
+00020200: 2020 2020 2020 2020 2020 2068 6561 6465             heade
+00020210: 7273 3d7b 2241 7574 686f 7269 7a61 7469  rs={"Authorizati
+00020220: 6f6e 223a 2066 2242 6173 6963 207b 6175  on": f"Basic {au
+00020230: 7468 2e64 6563 6f64 6528 2775 7466 2d38  th.decode('utf-8
+00020240: 2729 7d22 7d2c 0a20 2020 2020 2020 2029  ')}"},.        )
+00020250: 0a20 2020 2020 2020 2061 7373 6572 7420  .        assert 
+00020260: 7265 7370 6f6e 7365 2e73 7461 7475 735f  response.status_
+00020270: 636f 6465 203d 3d20 3230 300a 0a20 2020  code == 200..   
+00020280: 2020 2020 2072 6573 706f 6e73 6520 3d20       response = 
+00020290: 6177 6169 7420 636c 6965 6e74 2e67 6574  await client.get
+000202a0: 280a 2020 2020 2020 2020 2020 2020 6622  (.            f"
+000202b0: 2f6e 6f74 6562 6f6f 6b73 2f7b 7575 6964  /notebooks/{uuid
+000202c0: 7d22 2c20 6865 6164 6572 733d 7375 7065  }", headers=supe
+000202d0: 7275 7365 725f 746f 6b65 6e5f 6865 6164  ruser_token_head
+000202e0: 6572 730a 2020 2020 2020 2020 290a 2020  ers.        ).  
+000202f0: 2020 2020 2020 7265 7370 5f6a 736f 6e20        resp_json 
+00020300: 3d20 7265 7370 6f6e 7365 2e6a 736f 6e28  = response.json(
+00020310: 295b 226e 6f74 6562 6f6f 6b22 5d0a 2020  )["notebook"].  
+00020320: 2020 2020 2020 6173 7365 7274 2028 0a20        assert (. 
+00020330: 2020 2020 2020 2020 2020 2072 6573 705f             resp_
+00020340: 6a73 6f6e 5b22 6d65 7461 6461 7461 225d  json["metadata"]
+00020350: 5b22 6a75 7079 7465 725f 6431 225d 5b22  ["jupyter_d1"]["
+00020360: 776f 726b 696e 675f 6469 7265 6374 6f72  working_director
+00020370: 7922 5d0a 2020 2020 2020 2020 2020 2020  y"].            
+00020380: 3d3d 2072 6573 6f6c 7665 645f 776f 726b  == resolved_work
+00020390: 5f64 6972 0a20 2020 2020 2020 2029 0a0a  _dir.        )..
+000203a0: 0a40 7079 7465 7374 2e6d 6172 6b2e 7573  .@pytest.mark.us
+000203b0: 6566 6978 7475 7265 7328 0a20 2020 2022  efixtures(.    "
+000203c0: 636c 6561 725f 6e6f 7465 626f 6f6b 7322  clear_notebooks"
+000203d0: 2c20 2263 6c65 6172 5f6e 6f74 6562 6f6f  , "clear_noteboo
+000203e0: 6b5f 6469 7265 6374 6f72 7922 0a29 0a63  k_directory".).c
+000203f0: 6c61 7373 2054 6573 7453 6176 6541 733a  lass TestSaveAs:
+00020400: 0a20 2020 2040 7079 7465 7374 2e6d 6172  .    @pytest.mar
+00020410: 6b2e 6173 796e 6369 6f0a 2020 2020 6173  k.asyncio.    as
+00020420: 796e 6320 6465 6620 7465 7374 5f72 656e  ync def test_ren
+00020430: 616d 6528 0a20 2020 2020 2020 2073 656c  ame(.        sel
+00020440: 662c 2063 6c69 656e 743a 2054 6573 7443  f, client: TestC
+00020450: 6c69 656e 742c 2073 7570 6572 7573 6572  lient, superuser
+00020460: 5f74 6f6b 656e 5f68 6561 6465 7273 3a20  _token_headers: 
+00020470: 4469 6374 5b73 7472 2c20 7374 725d 0a20  Dict[str, str]. 
+00020480: 2020 2029 3a0a 2020 2020 2020 2020 7575     ):.        uu
+00020490: 6964 203d 2061 7761 6974 2075 706c 6f61  id = await uploa
+000204a0: 645f 6e6f 7465 626f 6f6b 280a 2020 2020  d_notebook(.    
+000204b0: 2020 2020 2020 2020 636c 6965 6e74 2c20          client, 
+000204c0: 7375 7065 7275 7365 725f 746f 6b65 6e5f  superuser_token_
+000204d0: 6865 6164 6572 732c 2066 696c 656e 616d  headers, filenam
+000204e0: 653d 2273 696d 706c 652e 6970 796e 6222  e="simple.ipynb"
+000204f0: 0a20 2020 2020 2020 2029 0a0a 2020 2020  .        )..    
+00020500: 2020 2020 6173 7365 7274 206f 732e 7061      assert os.pa
+00020510: 7468 2e65 7869 7374 7328 6622 7b73 6574  th.exists(f"{set
+00020520: 7469 6e67 732e 524f 4f54 5f44 4952 7d2f  tings.ROOT_DIR}/
+00020530: 7369 6d70 6c65 2e69 7079 6e62 2229 0a20  simple.ipynb"). 
+00020540: 2020 2020 2020 2061 7373 6572 7420 6e6f         assert no
+00020550: 7420 6f73 2e70 6174 682e 6578 6973 7473  t os.path.exists
+00020560: 2866 227b 7365 7474 696e 6773 2e52 4f4f  (f"{settings.ROO
+00020570: 545f 4449 527d 2f61 7768 6f6c 656e 6577  T_DIR}/awholenew
+00020580: 6e61 6d65 2e69 7079 6e62 2229 0a0a 2020  name.ipynb")..  
+00020590: 2020 2020 2020 6173 796e 6320 7769 7468        async with
+000205a0: 2063 6c69 656e 742e 7765 6273 6f63 6b65   client.websocke
+000205b0: 745f 636f 6e6e 6563 7428 0a20 2020 2020  t_connect(.     
+000205c0: 2020 2020 2020 2066 222f 6e6f 7465 626f         f"/notebo
+000205d0: 6f6b 732f 7b75 7569 647d 2f77 732f 6e6f  oks/{uuid}/ws/no
+000205e0: 7465 626f 6f6b 222c 2068 6561 6465 7273  tebook", headers
+000205f0: 3d73 7570 6572 7573 6572 5f74 6f6b 656e  =superuser_token
+00020600: 5f68 6561 6465 7273 0a20 2020 2020 2020  _headers.       
+00020610: 2029 2061 7320 7765 6273 6f63 6b65 743a   ) as websocket:
+00020620: 0a20 2020 2020 2020 2020 2020 2072 6573  .            res
+00020630: 706f 6e73 6520 3d20 6177 6169 7420 636c  ponse = await cl
+00020640: 6965 6e74 2e70 6174 6368 280a 2020 2020  ient.patch(.    
+00020650: 2020 2020 2020 2020 2020 2020 6622 2f6e              f"/n
+00020660: 6f74 6562 6f6f 6b73 2f7b 7575 6964 7d2f  otebooks/{uuid}/
+00020670: 7265 6e61 6d65 222c 0a20 2020 2020 2020  rename",.       
+00020680: 2020 2020 2020 2020 2071 7565 7279 5f73           query_s
+00020690: 7472 696e 673d 7b22 6669 6c65 6e61 6d65  tring={"filename
+000206a0: 223a 2022 6177 686f 6c65 6e65 776e 616d  ": "awholenewnam
+000206b0: 6522 7d2c 0a20 2020 2020 2020 2020 2020  e"},.           
+000206c0: 2020 2020 2068 6561 6465 7273 3d73 7570       headers=sup
+000206d0: 6572 7573 6572 5f74 6f6b 656e 5f68 6561  eruser_token_hea
+000206e0: 6465 7273 2c0a 2020 2020 2020 2020 2020  ders,.          
+000206f0: 2020 290a 2020 2020 2020 2020 2020 2020    ).            
+00020700: 6173 7365 7274 2072 6573 706f 6e73 652e  assert response.
+00020710: 7374 6174 7573 5f63 6f64 6520 3d3d 2032  status_code == 2
+00020720: 3030 0a20 2020 2020 2020 2020 2020 2061  00.            a
+00020730: 7373 6572 7420 280a 2020 2020 2020 2020  ssert (.        
+00020740: 2020 2020 2020 2020 7265 7370 6f6e 7365          response
+00020750: 2e6a 736f 6e28 295b 2270 6174 6822 5d0a  .json()["path"].
+00020760: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00020770: 3d3d 2066 227b 7365 7474 696e 6773 2e52  == f"{settings.R
+00020780: 4f4f 545f 4449 527d 2f61 7768 6f6c 656e  OOT_DIR}/awholen
+00020790: 6577 6e61 6d65 2e69 7079 6e62 220a 2020  ewname.ipynb".  
+000207a0: 2020 2020 2020 2020 2020 290a 0a20 2020            )..   
+000207b0: 2020 2020 2020 2020 2064 6174 6120 3d20           data = 
+000207c0: 6177 6169 7420 7265 6365 6976 655f 6a73  await receive_js
+000207d0: 6f6e 2877 6562 736f 636b 6574 2c20 6d73  on(websocket, ms
+000207e0: 675f 7479 7065 733d 5b22 6d65 7461 6461  g_types=["metada
+000207f0: 7461 225d 290a 2020 2020 2020 2020 2020  ta"]).          
+00020800: 2020 6d65 7461 6461 7461 203d 2064 6174    metadata = dat
+00020810: 615b 226d 6574 6164 6174 6122 5d0a 2020  a["metadata"].  
+00020820: 2020 2020 2020 2020 2020 6173 7365 7274            assert
+00020830: 2028 0a20 2020 2020 2020 2020 2020 2020   (.             
+00020840: 2020 206d 6574 6164 6174 615b 226a 7570     metadata["jup
+00020850: 7974 6572 5f64 3122 5d5b 2270 6174 6822  yter_d1"]["path"
+00020860: 5d0a 2020 2020 2020 2020 2020 2020 2020  ].              
+00020870: 2020 3d3d 2066 227b 7365 7474 696e 6773    == f"{settings
+00020880: 2e52 4f4f 545f 4449 527d 2f61 7768 6f6c  .ROOT_DIR}/awhol
+00020890: 656e 6577 6e61 6d65 2e69 7079 6e62 220a  enewname.ipynb".
+000208a0: 2020 2020 2020 2020 2020 2020 290a 2020              ).  
+000208b0: 2020 2020 2020 2020 2020 6173 7365 7274            assert
+000208c0: 206d 6574 6164 6174 615b 226a 7570 7974   metadata["jupyt
+000208d0: 6572 5f64 3122 5d5b 226e 616d 6522 5d20  er_d1"]["name"] 
+000208e0: 3d3d 2022 6177 686f 6c65 6e65 776e 616d  == "awholenewnam
+000208f0: 6522 0a0a 2020 2020 2020 2020 2020 2020  e"..            
+00020900: 6173 7365 7274 206f 732e 7061 7468 2e65  assert os.path.e
+00020910: 7869 7374 7328 6622 7b73 6574 7469 6e67  xists(f"{setting
+00020920: 732e 524f 4f54 5f44 4952 7d2f 6177 686f  s.ROOT_DIR}/awho
+00020930: 6c65 6e65 776e 616d 652e 6970 796e 6222  lenewname.ipynb"
+00020940: 290a 2020 2020 2020 2020 2020 2020 6173  ).            as
+00020950: 7365 7274 206e 6f74 206f 732e 7061 7468  sert not os.path
+00020960: 2e65 7869 7374 7328 6622 7b73 6574 7469  .exists(f"{setti
+00020970: 6e67 732e 524f 4f54 5f44 4952 7d2f 7369  ngs.ROOT_DIR}/si
+00020980: 6d70 6c65 2e69 7079 6e62 2229 0a0a 2020  mple.ipynb")..  
+00020990: 2020 4070 7974 6573 742e 6d61 726b 2e61    @pytest.mark.a
+000209a0: 7379 6e63 696f 0a20 2020 2061 7379 6e63  syncio.    async
+000209b0: 2064 6566 2074 6573 745f 7265 6e61 6d65   def test_rename
+000209c0: 5f64 6966 6665 7265 6e74 5f64 6972 6563  _different_direc
+000209d0: 746f 7279 280a 2020 2020 2020 2020 2020  tory(.          
+000209e0: 2020 7365 6c66 2c20 636c 6965 6e74 3a20    self, client: 
+000209f0: 5465 7374 436c 6965 6e74 2c20 7375 7065  TestClient, supe
+00020a00: 7275 7365 725f 746f 6b65 6e5f 6865 6164  ruser_token_head
+00020a10: 6572 733a 2044 6963 745b 7374 722c 2073  ers: Dict[str, s
+00020a20: 7472 5d2c 0a20 2020 2020 2020 2020 2020  tr],.           
+00020a30: 206f 7468 6572 5f6e 6f74 6562 6f6f 6b5f   other_notebook_
+00020a40: 6469 7265 6374 6f72 793a 2073 7472 0a20  directory: str. 
+00020a50: 2020 2029 3a0a 2020 2020 2020 2020 7575     ):.        uu
+00020a60: 6964 203d 2061 7761 6974 2075 706c 6f61  id = await uploa
+00020a70: 645f 6e6f 7465 626f 6f6b 280a 2020 2020  d_notebook(.    
+00020a80: 2020 2020 2020 2020 636c 6965 6e74 2c20          client, 
+00020a90: 7375 7065 7275 7365 725f 746f 6b65 6e5f  superuser_token_
+00020aa0: 6865 6164 6572 732c 2066 696c 656e 616d  headers, filenam
+00020ab0: 653d 2273 696d 706c 652e 6970 796e 6222  e="simple.ipynb"
+00020ac0: 0a20 2020 2020 2020 2029 0a0a 2020 2020  .        )..    
+00020ad0: 2020 2020 6173 7365 7274 206f 732e 7061      assert os.pa
+00020ae0: 7468 2e65 7869 7374 7328 6622 7b73 6574  th.exists(f"{set
+00020af0: 7469 6e67 732e 524f 4f54 5f44 4952 7d2f  tings.ROOT_DIR}/
+00020b00: 7369 6d70 6c65 2e69 7079 6e62 2229 0a20  simple.ipynb"). 
+00020b10: 2020 2020 2020 2061 7373 6572 7420 6e6f         assert no
+00020b20: 7420 6f73 2e70 6174 682e 6578 6973 7473  t os.path.exists
+00020b30: 2866 227b 6f74 6865 725f 6e6f 7465 626f  (f"{other_notebo
+00020b40: 6f6b 5f64 6972 6563 746f 7279 7d2f 6177  ok_directory}/aw
+00020b50: 686f 6c65 6e65 776e 616d 652e 6970 796e  holenewname.ipyn
+00020b60: 6222 290a 0a20 2020 2020 2020 2061 7379  b")..        asy
+00020b70: 6e63 2077 6974 6820 636c 6965 6e74 2e77  nc with client.w
+00020b80: 6562 736f 636b 6574 5f63 6f6e 6e65 6374  ebsocket_connect
+00020b90: 280a 2020 2020 2020 2020 2020 2020 6622  (.            f"
+00020ba0: 2f6e 6f74 6562 6f6f 6b73 2f7b 7575 6964  /notebooks/{uuid
+00020bb0: 7d2f 7773 2f6e 6f74 6562 6f6f 6b22 2c20  }/ws/notebook", 
+00020bc0: 6865 6164 6572 733d 7375 7065 7275 7365  headers=superuse
+00020bd0: 725f 746f 6b65 6e5f 6865 6164 6572 730a  r_token_headers.
+00020be0: 2020 2020 2020 2020 2920 6173 2077 6562          ) as web
+00020bf0: 736f 636b 6574 3a0a 2020 2020 2020 2020  socket:.        
+00020c00: 2020 2020 7265 7370 6f6e 7365 203d 2061      response = a
+00020c10: 7761 6974 2063 6c69 656e 742e 7061 7463  wait client.patc
+00020c20: 6828 0a20 2020 2020 2020 2020 2020 2020  h(.             
+00020c30: 2020 2066 222f 6e6f 7465 626f 6f6b 732f     f"/notebooks/
+00020c40: 7b75 7569 647d 2f72 656e 616d 6522 2c0a  {uuid}/rename",.
+00020c50: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00020c60: 7175 6572 795f 7374 7269 6e67 3d7b 0a20  query_string={. 
+00020c70: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00020c80: 2020 2022 6669 6c65 6e61 6d65 223a 2022     "filename": "
+00020c90: 6177 686f 6c65 6e65 776e 616d 6522 2c0a  awholenewname",.
+00020ca0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00020cb0: 2020 2020 2264 6972 6563 746f 7279 223a      "directory":
+00020cc0: 206f 7468 6572 5f6e 6f74 6562 6f6f 6b5f   other_notebook_
+00020cd0: 6469 7265 6374 6f72 792c 0a20 2020 2020  directory,.     
+00020ce0: 2020 2020 2020 2020 2020 207d 2c0a 2020             },.  
+00020cf0: 2020 2020 2020 2020 2020 2020 2020 6865                he
+00020d00: 6164 6572 733d 7375 7065 7275 7365 725f  aders=superuser_
+00020d10: 746f 6b65 6e5f 6865 6164 6572 732c 0a20  token_headers,. 
+00020d20: 2020 2020 2020 2020 2020 2029 0a20 2020             ).   
+00020d30: 2020 2020 2020 2020 2061 7373 6572 7420           assert 
+00020d40: 7265 7370 6f6e 7365 2e73 7461 7475 735f  response.status_
+00020d50: 636f 6465 203d 3d20 3230 300a 2020 2020  code == 200.    
+00020d60: 2020 2020 2020 2020 6173 7365 7274 2028          assert (
+00020d70: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00020d80: 2072 6573 706f 6e73 652e 6a73 6f6e 2829   response.json()
+00020d90: 5b22 7061 7468 225d 0a20 2020 2020 2020  ["path"].       
+00020da0: 2020 2020 2020 2020 203d 3d20 6622 7b6f           == f"{o
+00020db0: 7468 6572 5f6e 6f74 6562 6f6f 6b5f 6469  ther_notebook_di
+00020dc0: 7265 6374 6f72 797d 2f61 7768 6f6c 656e  rectory}/awholen
+00020dd0: 6577 6e61 6d65 2e69 7079 6e62 220a 2020  ewname.ipynb".  
+00020de0: 2020 2020 2020 2020 2020 290a 0a20 2020            )..   
+00020df0: 2020 2020 2020 2020 2064 6174 6120 3d20           data = 
+00020e00: 6177 6169 7420 7265 6365 6976 655f 6a73  await receive_js
+00020e10: 6f6e 2877 6562 736f 636b 6574 2c20 6d73  on(websocket, ms
+00020e20: 675f 7479 7065 733d 5b22 6d65 7461 6461  g_types=["metada
+00020e30: 7461 225d 290a 2020 2020 2020 2020 2020  ta"]).          
+00020e40: 2020 6d65 7461 6461 7461 203d 2064 6174    metadata = dat
+00020e50: 615b 226d 6574 6164 6174 6122 5d0a 2020  a["metadata"].  
+00020e60: 2020 2020 2020 2020 2020 6173 7365 7274            assert
+00020e70: 2028 0a20 2020 2020 2020 2020 2020 2020   (.             
+00020e80: 2020 2072 6573 6f6c 7665 286d 6574 6164     resolve(metad
+00020e90: 6174 615b 226a 7570 7974 6572 5f64 3122  ata["jupyter_d1"
+00020ea0: 5d5b 2270 6174 6822 5d29 0a20 2020 2020  ]["path"]).     
+00020eb0: 2020 2020 2020 2020 2020 203d 3d20 7265             == re
+00020ec0: 736f 6c76 6528 6622 7b6f 7468 6572 5f6e  solve(f"{other_n
+00020ed0: 6f74 6562 6f6f 6b5f 6469 7265 6374 6f72  otebook_director
+00020ee0: 797d 2f61 7768 6f6c 656e 6577 6e61 6d65  y}/awholenewname
+00020ef0: 2e69 7079 6e62 2229 0a20 2020 2020 2020  .ipynb").       
+00020f00: 2020 2020 2029 0a20 2020 2020 2020 2020       ).         
+00020f10: 2020 2061 7373 6572 7420 6d65 7461 6461     assert metada
+00020f20: 7461 5b22 6a75 7079 7465 725f 6431 225d  ta["jupyter_d1"]
+00020f30: 5b22 6e61 6d65 225d 203d 3d20 2261 7768  ["name"] == "awh
+00020f40: 6f6c 656e 6577 6e61 6d65 220a 0a20 2020  olenewname"..   
+00020f50: 2020 2020 2020 2020 2061 7373 6572 7420           assert 
+00020f60: 6f73 2e70 6174 682e 6578 6973 7473 2866  os.path.exists(f
+00020f70: 227b 6f74 6865 725f 6e6f 7465 626f 6f6b  "{other_notebook
+00020f80: 5f64 6972 6563 746f 7279 7d2f 6177 686f  _directory}/awho
+00020f90: 6c65 6e65 776e 616d 652e 6970 796e 6222  lenewname.ipynb"
+00020fa0: 290a 2020 2020 2020 2020 2020 2020 6173  ).            as
+00020fb0: 7365 7274 206e 6f74 206f 732e 7061 7468  sert not os.path
+00020fc0: 2e65 7869 7374 7328 6622 7b73 6574 7469  .exists(f"{setti
+00020fd0: 6e67 732e 524f 4f54 5f44 4952 7d2f 7369  ngs.ROOT_DIR}/si
+00020fe0: 6d70 6c65 2e69 7079 6e62 2229 0a0a 2020  mple.ipynb")..  
+00020ff0: 2020 4070 7974 6573 742e 6d61 726b 2e61    @pytest.mark.a
+00021000: 7379 6e63 696f 0a20 2020 2061 7379 6e63  syncio.    async
+00021010: 2064 6566 2074 6573 745f 7265 6e61 6d65   def test_rename
+00021020: 5f66 696c 655f 6578 6973 7473 280a 2020  _file_exists(.  
+00021030: 2020 2020 2020 7365 6c66 2c20 636c 6965        self, clie
+00021040: 6e74 3a20 5465 7374 436c 6965 6e74 2c20  nt: TestClient, 
+00021050: 7375 7065 7275 7365 725f 746f 6b65 6e5f  superuser_token_
+00021060: 6865 6164 6572 733a 2044 6963 745b 7374  headers: Dict[st
+00021070: 722c 2073 7472 5d2c 0a20 2020 2020 2020  r, str],.       
+00021080: 206f 7468 6572 5f6e 6f74 6562 6f6f 6b5f   other_notebook_
+00021090: 6469 7265 6374 6f72 793a 2073 7472 0a20  directory: str. 
+000210a0: 2020 2029 3a0a 2020 2020 2020 2020 2222     ):.        ""
+000210b0: 2246 6169 6c20 6966 2066 696c 6520 6578  "Fail if file ex
+000210c0: 6973 7473 2075 6e6c 6573 7320 6f76 6572  ists unless over
+000210d0: 7772 6974 6520 7061 7261 6d20 6973 2073  write param is s
+000210e0: 6574 2074 6f20 7472 7565 2222 220a 2020  et to true""".  
+000210f0: 2020 2020 2020 7575 6964 203d 2061 7761        uuid = awa
+00021100: 6974 2075 706c 6f61 645f 6e6f 7465 626f  it upload_notebo
+00021110: 6f6b 280a 2020 2020 2020 2020 2020 2020  ok(.            
+00021120: 636c 6965 6e74 2c20 7375 7065 7275 7365  client, superuse
+00021130: 725f 746f 6b65 6e5f 6865 6164 6572 732c  r_token_headers,
+00021140: 2066 696c 656e 616d 653d 2273 696d 706c   filename="simpl
+00021150: 652e 6970 796e 6222 0a20 2020 2020 2020  e.ipynb".       
+00021160: 2029 0a0a 2020 2020 2020 2020 7769 7468   )..        with
+00021170: 206f 7065 6e28 6622 7b6f 7468 6572 5f6e   open(f"{other_n
+00021180: 6f74 6562 6f6f 6b5f 6469 7265 6374 6f72  otebook_director
+00021190: 797d 2f61 7768 6f6c 656e 6577 6e61 6d65  y}/awholenewname
+000211a0: 2e69 7079 6e62 222c 2022 7722 2920 6173  .ipynb", "w") as
+000211b0: 2066 3a0a 2020 2020 2020 2020 2020 2020   f:.            
+000211c0: 662e 7772 6974 6528 2273 6f6d 6520 7465  f.write("some te
+000211d0: 7874 2068 6572 6522 290a 0a20 2020 2020  xt here")..     
+000211e0: 2020 2061 7373 6572 7420 6f73 2e70 6174     assert os.pat
+000211f0: 682e 6578 6973 7473 2866 227b 7365 7474  h.exists(f"{sett
+00021200: 696e 6773 2e52 4f4f 545f 4449 527d 2f73  ings.ROOT_DIR}/s
+00021210: 696d 706c 652e 6970 796e 6222 290a 2020  imple.ipynb").  
+00021220: 2020 2020 2020 6173 7365 7274 206f 732e        assert os.
+00021230: 7061 7468 2e65 7869 7374 7328 6622 7b6f  path.exists(f"{o
+00021240: 7468 6572 5f6e 6f74 6562 6f6f 6b5f 6469  ther_notebook_di
+00021250: 7265 6374 6f72 797d 2f61 7768 6f6c 656e  rectory}/awholen
+00021260: 6577 6e61 6d65 2e69 7079 6e62 2229 0a0a  ewname.ipynb")..
+00021270: 2020 2020 2020 2020 6173 796e 6320 7769          async wi
+00021280: 7468 2063 6c69 656e 742e 7765 6273 6f63  th client.websoc
+00021290: 6b65 745f 636f 6e6e 6563 7428 0a20 2020  ket_connect(.   
+000212a0: 2020 2020 2020 2020 2066 222f 6e6f 7465           f"/note
+000212b0: 626f 6f6b 732f 7b75 7569 647d 2f77 732f  books/{uuid}/ws/
+000212c0: 6e6f 7465 626f 6f6b 222c 2068 6561 6465  notebook", heade
+000212d0: 7273 3d73 7570 6572 7573 6572 5f74 6f6b  rs=superuser_tok
+000212e0: 656e 5f68 6561 6465 7273 0a20 2020 2020  en_headers.     
+000212f0: 2020 2029 2061 7320 7765 6273 6f63 6b65     ) as websocke
+00021300: 743a 0a20 2020 2020 2020 2020 2020 2072  t:.            r
+00021310: 6573 706f 6e73 6520 3d20 6177 6169 7420  esponse = await 
+00021320: 636c 6965 6e74 2e70 6174 6368 280a 2020  client.patch(.  
+00021330: 2020 2020 2020 2020 2020 2020 2020 6622                f"
+00021340: 2f6e 6f74 6562 6f6f 6b73 2f7b 7575 6964  /notebooks/{uuid
+00021350: 7d2f 7265 6e61 6d65 222c 0a20 2020 2020  }/rename",.     
+00021360: 2020 2020 2020 2020 2020 2071 7565 7279             query
+00021370: 5f73 7472 696e 673d 7b0a 2020 2020 2020  _string={.      
+00021380: 2020 2020 2020 2020 2020 2020 2020 2266                "f
+00021390: 696c 656e 616d 6522 3a20 2261 7768 6f6c  ilename": "awhol
+000213a0: 656e 6577 6e61 6d65 222c 0a20 2020 2020  enewname",.     
+000213b0: 2020 2020 2020 2020 2020 2020 2020 2022                 "
+000213c0: 6469 7265 6374 6f72 7922 3a20 6f74 6865  directory": othe
+000213d0: 725f 6e6f 7465 626f 6f6b 5f64 6972 6563  r_notebook_direc
+000213e0: 746f 7279 0a20 2020 2020 2020 2020 2020  tory.           
+000213f0: 2020 2020 207d 2c0a 2020 2020 2020 2020       },.        
+00021400: 2020 2020 2020 2020 6865 6164 6572 733d          headers=
+00021410: 7375 7065 7275 7365 725f 746f 6b65 6e5f  superuser_token_
+00021420: 6865 6164 6572 732c 0a20 2020 2020 2020  headers,.       
+00021430: 2020 2020 2029 0a20 2020 2020 2020 2020       ).         
+00021440: 2020 2061 7373 6572 7420 7265 7370 6f6e     assert respon
+00021450: 7365 2e73 7461 7475 735f 636f 6465 203d  se.status_code =
+00021460: 3d20 3430 300a 2020 2020 2020 2020 2020  = 400.          
+00021470: 2020 6173 7365 7274 2072 6573 706f 6e73    assert respons
+00021480: 652e 6a73 6f6e 2829 5b22 6465 7461 696c  e.json()["detail
+00021490: 225d 203d 3d20 6622 4669 6c65 2061 6c72  "] == f"File alr
+000214a0: 6561 6479 2065 7869 7374 7322 0a0a 2020  eady exists"..  
+000214b0: 2020 2020 2020 2020 2020 7265 7370 6f6e            respon
+000214c0: 7365 203d 2061 7761 6974 2063 6c69 656e  se = await clien
+000214d0: 742e 7061 7463 6828 0a20 2020 2020 2020  t.patch(.       
+000214e0: 2020 2020 2020 2020 2066 222f 6e6f 7465           f"/note
+000214f0: 626f 6f6b 732f 7b75 7569 647d 2f72 656e  books/{uuid}/ren
+00021500: 616d 6522 2c0a 2020 2020 2020 2020 2020  ame",.          
+00021510: 2020 2020 2020 7175 6572 795f 7374 7269        query_stri
+00021520: 6e67 3d7b 0a20 2020 2020 2020 2020 2020  ng={.           
+00021530: 2020 2020 2020 2020 2022 6669 6c65 6e61           "filena
+00021540: 6d65 223a 2022 6177 686f 6c65 6e65 776e  me": "awholenewn
+00021550: 616d 6522 2c0a 2020 2020 2020 2020 2020  ame",.          
+00021560: 2020 2020 2020 2020 2020 2264 6972 6563            "direc
+00021570: 746f 7279 223a 206f 7468 6572 5f6e 6f74  tory": other_not
+00021580: 6562 6f6f 6b5f 6469 7265 6374 6f72 792c  ebook_directory,
+00021590: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+000215a0: 2020 2020 2022 6f76 6572 7772 6974 6522       "overwrite"
+000215b0: 3a20 5472 7565 2c0a 2020 2020 2020 2020  : True,.        
+000215c0: 2020 2020 2020 2020 7d2c 0a20 2020 2020          },.     
+000215d0: 2020 2020 2020 2020 2020 2068 6561 6465             heade
+000215e0: 7273 3d73 7570 6572 7573 6572 5f74 6f6b  rs=superuser_tok
+000215f0: 656e 5f68 6561 6465 7273 2c0a 2020 2020  en_headers,.    
+00021600: 2020 2020 2020 2020 290a 2020 2020 2020          ).      
+00021610: 2020 2020 2020 6173 7365 7274 2072 6573        assert res
+00021620: 706f 6e73 652e 7374 6174 7573 5f63 6f64  ponse.status_cod
+00021630: 6520 3d3d 2032 3030 0a20 2020 2020 2020  e == 200.       
+00021640: 2020 2020 2061 7373 6572 7420 280a 2020       assert (.  
+00021650: 2020 2020 2020 2020 2020 2020 2020 7265                re
+00021660: 7370 6f6e 7365 2e6a 736f 6e28 295b 2270  sponse.json()["p
+00021670: 6174 6822 5d0a 2020 2020 2020 2020 2020  ath"].          
+00021680: 2020 2020 2020 3d3d 2066 227b 6f74 6865        == f"{othe
+00021690: 725f 6e6f 7465 626f 6f6b 5f64 6972 6563  r_notebook_direc
+000216a0: 746f 7279 7d2f 6177 686f 6c65 6e65 776e  tory}/awholenewn
+000216b0: 616d 652e 6970 796e 6222 0a20 2020 2020  ame.ipynb".     
+000216c0: 2020 2020 2020 2029 0a0a 2020 2020 2020         )..      
+000216d0: 2020 2020 2020 6461 7461 203d 2061 7761        data = awa
+000216e0: 6974 2072 6563 6569 7665 5f6a 736f 6e28  it receive_json(
+000216f0: 7765 6273 6f63 6b65 742c 206d 7367 5f74  websocket, msg_t
+00021700: 7970 6573 3d5b 226d 6574 6164 6174 6122  ypes=["metadata"
+00021710: 5d29 0a20 2020 2020 2020 2020 2020 206d  ]).            m
+00021720: 6574 6164 6174 6120 3d20 6461 7461 5b22  etadata = data["
+00021730: 6d65 7461 6461 7461 225d 0a20 2020 2020  metadata"].     
+00021740: 2020 2020 2020 2061 7373 6572 7420 280a         assert (.
+00021750: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00021760: 7265 736f 6c76 6528 6d65 7461 6461 7461  resolve(metadata
+00021770: 5b22 6a75 7079 7465 725f 6431 225d 5b22  ["jupyter_d1"]["
+00021780: 7061 7468 225d 290a 2020 2020 2020 2020  path"]).        
+00021790: 2020 2020 2020 2020 3d3d 2072 6573 6f6c          == resol
+000217a0: 7665 2866 227b 6f74 6865 725f 6e6f 7465  ve(f"{other_note
+000217b0: 626f 6f6b 5f64 6972 6563 746f 7279 7d2f  book_directory}/
+000217c0: 6177 686f 6c65 6e65 776e 616d 652e 6970  awholenewname.ip
+000217d0: 796e 6222 290a 2020 2020 2020 2020 2020  ynb").          
+000217e0: 2020 290a 2020 2020 2020 2020 2020 2020    ).            
+000217f0: 6173 7365 7274 206d 6574 6164 6174 615b  assert metadata[
+00021800: 226a 7570 7974 6572 5f64 3122 5d5b 226e  "jupyter_d1"]["n
+00021810: 616d 6522 5d20 3d3d 2022 6177 686f 6c65  ame"] == "awhole
+00021820: 6e65 776e 616d 6522 0a0a 2020 2020 2020  newname"..      
+00021830: 2020 2020 2020 6173 7365 7274 206f 732e        assert os.
+00021840: 7061 7468 2e65 7869 7374 7328 6622 7b6f  path.exists(f"{o
+00021850: 7468 6572 5f6e 6f74 6562 6f6f 6b5f 6469  ther_notebook_di
+00021860: 7265 6374 6f72 797d 2f61 7768 6f6c 656e  rectory}/awholen
+00021870: 6577 6e61 6d65 2e69 7079 6e62 2229 0a20  ewname.ipynb"). 
+00021880: 2020 2020 2020 2020 2020 2061 7373 6572             asser
+00021890: 7420 6e6f 7420 6f73 2e70 6174 682e 6578  t not os.path.ex
+000218a0: 6973 7473 2866 227b 7365 7474 696e 6773  ists(f"{settings
+000218b0: 2e52 4f4f 545f 4449 527d 2f73 696d 706c  .ROOT_DIR}/simpl
+000218c0: 652e 6970 796e 6222 290a 0a20 2020 2020  e.ipynb")..     
+000218d0: 2020 2077 6974 6820 6f70 656e 2866 227b     with open(f"{
+000218e0: 6f74 6865 725f 6e6f 7465 626f 6f6b 5f64  other_notebook_d
+000218f0: 6972 6563 746f 7279 7d2f 6177 686f 6c65  irectory}/awhole
+00021900: 6e65 776e 616d 652e 6970 796e 6222 2c20  newname.ipynb", 
+00021910: 2272 2229 2061 7320 663a 0a20 2020 2020  "r") as f:.     
+00021920: 2020 2020 2020 2061 7373 6572 7420 662e         assert f.
+00021930: 7265 6164 2829 2021 3d20 2273 6f6d 6520  read() != "some 
+00021940: 7465 7874 2068 6572 6522 0a0a 2020 2020  text here"..    
+00021950: 4070 7974 6573 742e 6d61 726b 2e61 7379  @pytest.mark.asy
+00021960: 6e63 696f 0a20 2020 2061 7379 6e63 2064  ncio.    async d
+00021970: 6566 2074 6573 745f 7265 6e61 6d65 5f6a  ef test_rename_j
+00021980: 7573 745f 6d65 7461 6461 7461 280a 2020  ust_metadata(.  
+00021990: 2020 2020 2020 7365 6c66 2c20 636c 6965        self, clie
+000219a0: 6e74 3a20 5465 7374 436c 6965 6e74 2c20  nt: TestClient, 
+000219b0: 7375 7065 7275 7365 725f 746f 6b65 6e5f  superuser_token_
+000219c0: 6865 6164 6572 733a 2044 6963 745b 7374  headers: Dict[st
+000219d0: 722c 2073 7472 5d2c 0a20 2020 2020 2020  r, str],.       
+000219e0: 206f 7468 6572 5f6e 6f74 6562 6f6f 6b5f   other_notebook_
+000219f0: 6469 7265 6374 6f72 793a 2073 7472 0a20  directory: str. 
+00021a00: 2020 2029 3a0a 2020 2020 2020 2020 7575     ):.        uu
+00021a10: 6964 203d 2061 7761 6974 2075 706c 6f61  id = await uploa
+00021a20: 645f 6e6f 7465 626f 6f6b 280a 2020 2020  d_notebook(.    
+00021a30: 2020 2020 2020 2020 636c 6965 6e74 2c20          client, 
+00021a40: 7375 7065 7275 7365 725f 746f 6b65 6e5f  superuser_token_
+00021a50: 6865 6164 6572 732c 2066 696c 656e 616d  headers, filenam
+00021a60: 653d 2273 696d 706c 652e 6970 796e 6222  e="simple.ipynb"
+00021a70: 0a20 2020 2020 2020 2029 0a0a 2020 2020  .        )..    
+00021a80: 2020 2020 6173 7365 7274 206f 732e 7061      assert os.pa
+00021a90: 7468 2e65 7869 7374 7328 6622 7b73 6574  th.exists(f"{set
+00021aa0: 7469 6e67 732e 524f 4f54 5f44 4952 7d2f  tings.ROOT_DIR}/
+00021ab0: 7369 6d70 6c65 2e69 7079 6e62 2229 0a20  simple.ipynb"). 
+00021ac0: 2020 2020 2020 2061 7373 6572 7420 6e6f         assert no
+00021ad0: 7420 6f73 2e70 6174 682e 6578 6973 7473  t os.path.exists
+00021ae0: 2866 227b 6f74 6865 725f 6e6f 7465 626f  (f"{other_notebo
+00021af0: 6f6b 5f64 6972 6563 746f 7279 7d2f 6177  ok_directory}/aw
+00021b00: 686f 6c65 6e65 776e 616d 652e 6970 796e  holenewname.ipyn
+00021b10: 6222 290a 0a20 2020 2020 2020 2061 7379  b")..        asy
+00021b20: 6e63 2077 6974 6820 636c 6965 6e74 2e77  nc with client.w
+00021b30: 6562 736f 636b 6574 5f63 6f6e 6e65 6374  ebsocket_connect
+00021b40: 280a 2020 2020 2020 2020 2020 2020 6622  (.            f"
+00021b50: 2f6e 6f74 6562 6f6f 6b73 2f7b 7575 6964  /notebooks/{uuid
+00021b60: 7d2f 7773 2f6e 6f74 6562 6f6f 6b22 2c20  }/ws/notebook", 
+00021b70: 6865 6164 6572 733d 7375 7065 7275 7365  headers=superuse
+00021b80: 725f 746f 6b65 6e5f 6865 6164 6572 730a  r_token_headers.
+00021b90: 2020 2020 2020 2020 2920 6173 2077 6562          ) as web
+00021ba0: 736f 636b 6574 3a0a 2020 2020 2020 2020  socket:.        
+00021bb0: 2020 2020 7265 7370 6f6e 7365 203d 2061      response = a
+00021bc0: 7761 6974 2063 6c69 656e 742e 7061 7463  wait client.patc
+00021bd0: 6828 0a20 2020 2020 2020 2020 2020 2020  h(.             
+00021be0: 2020 2066 222f 6e6f 7465 626f 6f6b 732f     f"/notebooks/
+00021bf0: 7b75 7569 647d 2f72 656e 616d 6522 2c0a  {uuid}/rename",.
+00021c00: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00021c10: 7175 6572 795f 7374 7269 6e67 3d7b 0a20  query_string={. 
+00021c20: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00021c30: 2020 2022 6669 6c65 6e61 6d65 223a 2022     "filename": "
+00021c40: 6177 686f 6c65 6e65 776e 616d 6522 2c0a  awholenewname",.
+00021c50: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00021c60: 2020 2020 2264 6972 6563 746f 7279 223a      "directory":
+00021c70: 206f 7468 6572 5f6e 6f74 6562 6f6f 6b5f   other_notebook_
+00021c80: 6469 7265 6374 6f72 792c 0a20 2020 2020  directory,.     
+00021c90: 2020 2020 2020 2020 2020 2020 2020 2022                 "
+00021ca0: 6a75 7374 5f6d 6574 6164 6174 6122 3a20  just_metadata": 
+00021cb0: 5472 7565 2c0a 2020 2020 2020 2020 2020  True,.          
+00021cc0: 2020 2020 2020 7d2c 0a20 2020 2020 2020        },.       
+00021cd0: 2020 2020 2020 2020 2068 6561 6465 7273           headers
+00021ce0: 3d73 7570 6572 7573 6572 5f74 6f6b 656e  =superuser_token
+00021cf0: 5f68 6561 6465 7273 2c0a 2020 2020 2020  _headers,.      
+00021d00: 2020 2020 2020 290a 2020 2020 2020 2020        ).        
+00021d10: 2020 2020 6173 7365 7274 2072 6573 706f      assert respo
+00021d20: 6e73 652e 7374 6174 7573 5f63 6f64 6520  nse.status_code 
+00021d30: 3d3d 2032 3030 0a20 2020 2020 2020 2020  == 200.         
+00021d40: 2020 2061 7373 6572 7420 280a 2020 2020     assert (.    
+00021d50: 2020 2020 2020 2020 2020 2020 7265 7370              resp
+00021d60: 6f6e 7365 2e6a 736f 6e28 295b 2270 6174  onse.json()["pat
+00021d70: 6822 5d0a 2020 2020 2020 2020 2020 2020  h"].            
+00021d80: 2020 2020 3d3d 2066 227b 6f74 6865 725f      == f"{other_
+00021d90: 6e6f 7465 626f 6f6b 5f64 6972 6563 746f  notebook_directo
+00021da0: 7279 7d2f 6177 686f 6c65 6e65 776e 616d  ry}/awholenewnam
+00021db0: 652e 6970 796e 6222 0a20 2020 2020 2020  e.ipynb".       
+00021dc0: 2020 2020 2029 0a0a 2020 2020 2020 2020       )..        
+00021dd0: 2020 2020 6461 7461 203d 2061 7761 6974      data = await
+00021de0: 2072 6563 6569 7665 5f6a 736f 6e28 7765   receive_json(we
+00021df0: 6273 6f63 6b65 742c 206d 7367 5f74 7970  bsocket, msg_typ
+00021e00: 6573 3d5b 226d 6574 6164 6174 6122 5d29  es=["metadata"])
+00021e10: 0a20 2020 2020 2020 2020 2020 206d 6574  .            met
+00021e20: 6164 6174 6120 3d20 6461 7461 5b22 6d65  adata = data["me
+00021e30: 7461 6461 7461 225d 0a20 2020 2020 2020  tadata"].       
+00021e40: 2020 2020 2061 7373 6572 7420 280a 2020       assert (.  
+00021e50: 2020 2020 2020 2020 2020 2020 2020 7265                re
+00021e60: 736f 6c76 6528 6d65 7461 6461 7461 5b22  solve(metadata["
+00021e70: 6a75 7079 7465 725f 6431 225d 5b22 7061  jupyter_d1"]["pa
+00021e80: 7468 225d 290a 2020 2020 2020 2020 2020  th"]).          
+00021e90: 2020 2020 2020 3d3d 2072 6573 6f6c 7665        == resolve
+00021ea0: 2866 227b 6f74 6865 725f 6e6f 7465 626f  (f"{other_notebo
+00021eb0: 6f6b 5f64 6972 6563 746f 7279 7d2f 6177  ok_directory}/aw
+00021ec0: 686f 6c65 6e65 776e 616d 652e 6970 796e  holenewname.ipyn
+00021ed0: 6222 290a 2020 2020 2020 2020 2020 2020  b").            
+00021ee0: 290a 2020 2020 2020 2020 2020 2020 6173  ).            as
+00021ef0: 7365 7274 206d 6574 6164 6174 615b 226a  sert metadata["j
+00021f00: 7570 7974 6572 5f64 3122 5d5b 226e 616d  upyter_d1"]["nam
+00021f10: 6522 5d20 3d3d 2022 6177 686f 6c65 6e65  e"] == "awholene
+00021f20: 776e 616d 6522 0a0a 2020 2020 2020 2020  wname"..        
+00021f30: 2020 2020 6173 7365 7274 206e 6f74 206f      assert not o
+00021f40: 732e 7061 7468 2e65 7869 7374 7328 6622  s.path.exists(f"
+00021f50: 7b6f 7468 6572 5f6e 6f74 6562 6f6f 6b5f  {other_notebook_
+00021f60: 6469 7265 6374 6f72 797d 2f61 7768 6f6c  directory}/awhol
+00021f70: 656e 6577 6e61 6d65 2e69 7079 6e62 2229  enewname.ipynb")
+00021f80: 0a20 2020 2020 2020 2020 2020 2061 7373  .            ass
+00021f90: 6572 7420 6f73 2e70 6174 682e 6578 6973  ert os.path.exis
+00021fa0: 7473 2866 227b 7365 7474 696e 6773 2e52  ts(f"{settings.R
+00021fb0: 4f4f 545f 4449 527d 2f73 696d 706c 652e  OOT_DIR}/simple.
+00021fc0: 6970 796e 6222 290a 0a20 2020 2040 7079  ipynb")..    @py
+00021fd0: 7465 7374 2e6d 6172 6b2e 6173 796e 6369  test.mark.asynci
+00021fe0: 6f0a 2020 2020 6173 796e 6320 6465 6620  o.    async def 
+00021ff0: 7465 7374 5f73 6176 655f 6173 280a 2020  test_save_as(.  
+00022000: 2020 2020 2020 7365 6c66 2c20 636c 6965        self, clie
+00022010: 6e74 3a20 5465 7374 436c 6965 6e74 2c20  nt: TestClient, 
+00022020: 7375 7065 7275 7365 725f 746f 6b65 6e5f  superuser_token_
+00022030: 6865 6164 6572 733a 2044 6963 745b 7374  headers: Dict[st
+00022040: 722c 2073 7472 5d0a 2020 2020 293a 0a20  r, str].    ):. 
+00022050: 2020 2020 2020 2075 7569 6420 3d20 6177         uuid = aw
+00022060: 6169 7420 7570 6c6f 6164 5f6e 6f74 6562  ait upload_noteb
+00022070: 6f6f 6b28 0a20 2020 2020 2020 2020 2020  ook(.           
+00022080: 2063 6c69 656e 742c 2073 7570 6572 7573   client, superus
+00022090: 6572 5f74 6f6b 656e 5f68 6561 6465 7273  er_token_headers
+000220a0: 2c20 6669 6c65 6e61 6d65 3d22 7369 6d70  , filename="simp
+000220b0: 6c65 2e69 7079 6e62 220a 2020 2020 2020  le.ipynb".      
+000220c0: 2020 290a 0a20 2020 2020 2020 2061 7373    )..        ass
+000220d0: 6572 7420 6f73 2e70 6174 682e 6578 6973  ert os.path.exis
+000220e0: 7473 2866 227b 7365 7474 696e 6773 2e52  ts(f"{settings.R
+000220f0: 4f4f 545f 4449 527d 2f73 696d 706c 652e  OOT_DIR}/simple.
+00022100: 6970 796e 6222 290a 2020 2020 2020 2020  ipynb").        
+00022110: 6173 7365 7274 206e 6f74 206f 732e 7061  assert not os.pa
+00022120: 7468 2e65 7869 7374 7328 6622 7b73 6574  th.exists(f"{set
+00022130: 7469 6e67 732e 524f 4f54 5f44 4952 7d2f  tings.ROOT_DIR}/
+00022140: 6177 686f 6c65 6e65 776e 616d 652e 6970  awholenewname.ip
+00022150: 796e 6222 290a 0a20 2020 2020 2020 2061  ynb")..        a
+00022160: 7379 6e63 2077 6974 6820 636c 6965 6e74  sync with client
+00022170: 2e77 6562 736f 636b 6574 5f63 6f6e 6e65  .websocket_conne
+00022180: 6374 280a 2020 2020 2020 2020 2020 2020  ct(.            
+00022190: 6622 2f6e 6f74 6562 6f6f 6b73 2f7b 7575  f"/notebooks/{uu
+000221a0: 6964 7d2f 7773 2f6e 6f74 6562 6f6f 6b22  id}/ws/notebook"
+000221b0: 2c20 6865 6164 6572 733d 7375 7065 7275  , headers=superu
+000221c0: 7365 725f 746f 6b65 6e5f 6865 6164 6572  ser_token_header
+000221d0: 730a 2020 2020 2020 2020 2920 6173 2077  s.        ) as w
+000221e0: 6562 736f 636b 6574 3a0a 2020 2020 2020  ebsocket:.      
+000221f0: 2020 2020 2020 7265 7370 6f6e 7365 203d        response =
+00022200: 2061 7761 6974 2063 6c69 656e 742e 7061   await client.pa
+00022210: 7463 6828 0a20 2020 2020 2020 2020 2020  tch(.           
+00022220: 2020 2020 2066 222f 6e6f 7465 626f 6f6b       f"/notebook
+00022230: 732f 7b75 7569 647d 2f73 6176 655f 6173  s/{uuid}/save_as
+00022240: 222c 0a20 2020 2020 2020 2020 2020 2020  ",.             
+00022250: 2020 2071 7565 7279 5f73 7472 696e 673d     query_string=
+00022260: 7b22 6669 6c65 6e61 6d65 223a 2022 6177  {"filename": "aw
+00022270: 686f 6c65 6e65 776e 616d 6522 7d2c 0a20  holenewname"},. 
+00022280: 2020 2020 2020 2020 2020 2020 2020 2068                 h
+00022290: 6561 6465 7273 3d73 7570 6572 7573 6572  eaders=superuser
+000222a0: 5f74 6f6b 656e 5f68 6561 6465 7273 2c0a  _token_headers,.
+000222b0: 2020 2020 2020 2020 2020 2020 290a 2020              ).  
+000222c0: 2020 2020 2020 2020 2020 6173 7365 7274            assert
+000222d0: 2072 6573 706f 6e73 652e 7374 6174 7573   response.status
+000222e0: 5f63 6f64 6520 3d3d 2032 3030 0a20 2020  _code == 200.   
+000222f0: 2020 2020 2020 2020 2061 7373 6572 7420           assert 
+00022300: 280a 2020 2020 2020 2020 2020 2020 2020  (.              
+00022310: 2020 7265 7370 6f6e 7365 2e6a 736f 6e28    response.json(
+00022320: 295b 2270 6174 6822 5d0a 2020 2020 2020  )["path"].      
+00022330: 2020 2020 2020 2020 2020 3d3d 2066 227b            == f"{
+00022340: 7365 7474 696e 6773 2e52 4f4f 545f 4449  settings.ROOT_DI
+00022350: 527d 2f61 7768 6f6c 656e 6577 6e61 6d65  R}/awholenewname
+00022360: 2e69 7079 6e62 220a 2020 2020 2020 2020  .ipynb".        
+00022370: 2020 2020 290a 0a20 2020 2020 2020 2020      )..         
+00022380: 2020 2064 6174 6120 3d20 6177 6169 7420     data = await 
+00022390: 7265 6365 6976 655f 6a73 6f6e 2877 6562  receive_json(web
+000223a0: 736f 636b 6574 2c20 6d73 675f 7479 7065  socket, msg_type
+000223b0: 733d 5b22 6d65 7461 6461 7461 225d 290a  s=["metadata"]).
+000223c0: 2020 2020 2020 2020 2020 2020 6d65 7461              meta
+000223d0: 6461 7461 203d 2064 6174 615b 226d 6574  data = data["met
+000223e0: 6164 6174 6122 5d0a 2020 2020 2020 2020  adata"].        
+000223f0: 2020 2020 6173 7365 7274 2028 0a20 2020      assert (.   
+00022400: 2020 2020 2020 2020 2020 2020 206d 6574               met
+00022410: 6164 6174 615b 226a 7570 7974 6572 5f64  adata["jupyter_d
+00022420: 3122 5d5b 2270 6174 6822 5d0a 2020 2020  1"]["path"].    
+00022430: 2020 2020 2020 2020 2020 2020 3d3d 2066              == f
+00022440: 227b 7365 7474 696e 6773 2e52 4f4f 545f  "{settings.ROOT_
+00022450: 4449 527d 2f61 7768 6f6c 656e 6577 6e61  DIR}/awholenewna
+00022460: 6d65 2e69 7079 6e62 220a 2020 2020 2020  me.ipynb".      
+00022470: 2020 2020 2020 290a 2020 2020 2020 2020        ).        
+00022480: 2020 2020 6173 7365 7274 206d 6574 6164      assert metad
+00022490: 6174 615b 226a 7570 7974 6572 5f64 3122  ata["jupyter_d1"
+000224a0: 5d5b 226e 616d 6522 5d20 3d3d 2022 6177  ]["name"] == "aw
+000224b0: 686f 6c65 6e65 776e 616d 6522 0a20 2020  holenewname".   
+000224c0: 2020 2020 2020 2020 2061 7373 6572 7420           assert 
+000224d0: 6d65 7461 6461 7461 5b22 6a75 7079 7465  metadata["jupyte
+000224e0: 725f 6431 225d 5b22 7575 6964 225d 203d  r_d1"]["uuid"] =
+000224f0: 3d20 7575 6964 0a0a 2020 2020 2020 2020  = uuid..        
+00022500: 2020 2020 6173 7365 7274 206f 732e 7061      assert os.pa
+00022510: 7468 2e65 7869 7374 7328 6622 7b73 6574  th.exists(f"{set
+00022520: 7469 6e67 732e 524f 4f54 5f44 4952 7d2f  tings.ROOT_DIR}/
+00022530: 6177 686f 6c65 6e65 776e 616d 652e 6970  awholenewname.ip
+00022540: 796e 6222 290a 2020 2020 2020 2020 2020  ynb").          
+00022550: 2020 6173 7365 7274 206f 732e 7061 7468    assert os.path
+00022560: 2e65 7869 7374 7328 6622 7b73 6574 7469  .exists(f"{setti
+00022570: 6e67 732e 524f 4f54 5f44 4952 7d2f 7369  ngs.ROOT_DIR}/si
+00022580: 6d70 6c65 2e69 7079 6e62 2229 0a0a 2020  mple.ipynb")..  
+00022590: 2020 2020 2020 2020 2020 7265 7370 6f6e            respon
+000225a0: 7365 203d 2061 7761 6974 2063 6c69 656e  se = await clien
+000225b0: 742e 6765 7428 0a20 2020 2020 2020 2020  t.get(.         
+000225c0: 2020 2020 2020 2066 222f 6e6f 7465 626f         f"/notebo
+000225d0: 6f6b 732f 7b75 7569 647d 222c 2068 6561  oks/{uuid}", hea
+000225e0: 6465 7273 3d73 7570 6572 7573 6572 5f74  ders=superuser_t
+000225f0: 6f6b 656e 5f68 6561 6465 7273 0a20 2020  oken_headers.   
+00022600: 2020 2020 2020 2020 2029 0a20 2020 2020           ).     
+00022610: 2020 2020 2020 2072 6573 705f 6a73 6f6e         resp_json
+00022620: 203d 2072 6573 706f 6e73 652e 6a73 6f6e   = response.json
+00022630: 2829 5b22 6e6f 7465 626f 6f6b 225d 0a20  ()["notebook"]. 
+00022640: 2020 2020 2020 2020 2020 2061 7373 6572             asser
+00022650: 7420 280a 2020 2020 2020 2020 2020 2020  t (.            
+00022660: 2020 2020 7265 7370 5f6a 736f 6e5b 226d      resp_json["m
+00022670: 6574 6164 6174 6122 5d5b 226a 7570 7974  etadata"]["jupyt
+00022680: 6572 5f64 3122 5d5b 226e 616d 6522 5d20  er_d1"]["name"] 
+00022690: 3d3d 2022 6177 686f 6c65 6e65 776e 616d  == "awholenewnam
+000226a0: 6522 0a20 2020 2020 2020 2020 2020 2029  e".            )
+000226b0: 0a20 2020 2020 2020 2020 2020 2061 7373  .            ass
+000226c0: 6572 7420 7265 7370 5f6a 736f 6e5b 226d  ert resp_json["m
+000226d0: 6574 6164 6174 6122 5d5b 226a 7570 7974  etadata"]["jupyt
+000226e0: 6572 5f64 3122 5d5b 2275 7569 6422 5d20  er_d1"]["uuid"] 
+000226f0: 3d3d 2075 7569 640a 0a20 2020 2040 7079  == uuid..    @py
+00022700: 7465 7374 2e6d 6172 6b2e 6173 796e 6369  test.mark.asynci
+00022710: 6f0a 2020 2020 6173 796e 6320 6465 6620  o.    async def 
+00022720: 7465 7374 5f73 6176 655f 6173 5f64 6966  test_save_as_dif
+00022730: 6665 7265 6e74 5f64 6972 6563 746f 7279  ferent_directory
+00022740: 280a 2020 2020 2020 2020 7365 6c66 2c20  (.        self, 
+00022750: 636c 6965 6e74 3a20 5465 7374 436c 6965  client: TestClie
+00022760: 6e74 2c20 7375 7065 7275 7365 725f 746f  nt, superuser_to
+00022770: 6b65 6e5f 6865 6164 6572 733a 2044 6963  ken_headers: Dic
+00022780: 745b 7374 722c 2073 7472 5d2c 0a20 2020  t[str, str],.   
+00022790: 2020 2020 206f 7468 6572 5f6e 6f74 6562       other_noteb
+000227a0: 6f6f 6b5f 6469 7265 6374 6f72 793a 2073  ook_directory: s
+000227b0: 7472 0a20 2020 2029 3a0a 2020 2020 2020  tr.    ):.      
+000227c0: 2020 7575 6964 203d 2061 7761 6974 2075    uuid = await u
+000227d0: 706c 6f61 645f 6e6f 7465 626f 6f6b 280a  pload_notebook(.
+000227e0: 2020 2020 2020 2020 2020 2020 636c 6965              clie
+000227f0: 6e74 2c20 7375 7065 7275 7365 725f 746f  nt, superuser_to
+00022800: 6b65 6e5f 6865 6164 6572 732c 2066 696c  ken_headers, fil
+00022810: 656e 616d 653d 2273 696d 706c 652e 6970  ename="simple.ip
+00022820: 796e 6222 0a20 2020 2020 2020 2029 0a0a  ynb".        )..
+00022830: 2020 2020 2020 2020 6173 7365 7274 206f          assert o
+00022840: 732e 7061 7468 2e65 7869 7374 7328 6622  s.path.exists(f"
+00022850: 7b73 6574 7469 6e67 732e 524f 4f54 5f44  {settings.ROOT_D
+00022860: 4952 7d2f 7369 6d70 6c65 2e69 7079 6e62  IR}/simple.ipynb
+00022870: 2229 0a20 2020 2020 2020 2061 7373 6572  ").        asser
+00022880: 7420 6e6f 7420 6f73 2e70 6174 682e 6578  t not os.path.ex
+00022890: 6973 7473 2866 227b 6f74 6865 725f 6e6f  ists(f"{other_no
+000228a0: 7465 626f 6f6b 5f64 6972 6563 746f 7279  tebook_directory
+000228b0: 7d2f 6177 686f 6c65 6e65 776e 616d 652e  }/awholenewname.
+000228c0: 6970 796e 6222 290a 0a20 2020 2020 2020  ipynb")..       
+000228d0: 2061 7379 6e63 2077 6974 6820 636c 6965   async with clie
+000228e0: 6e74 2e77 6562 736f 636b 6574 5f63 6f6e  nt.websocket_con
+000228f0: 6e65 6374 280a 2020 2020 2020 2020 2020  nect(.          
+00022900: 2020 6622 2f6e 6f74 6562 6f6f 6b73 2f7b    f"/notebooks/{
+00022910: 7575 6964 7d2f 7773 2f6e 6f74 6562 6f6f  uuid}/ws/noteboo
+00022920: 6b22 2c20 6865 6164 6572 733d 7375 7065  k", headers=supe
+00022930: 7275 7365 725f 746f 6b65 6e5f 6865 6164  ruser_token_head
+00022940: 6572 730a 2020 2020 2020 2020 2920 6173  ers.        ) as
+00022950: 2077 6562 736f 636b 6574 3a0a 2020 2020   websocket:.    
+00022960: 2020 2020 2020 2020 7265 7370 6f6e 7365          response
+00022970: 203d 2061 7761 6974 2063 6c69 656e 742e   = await client.
+00022980: 7061 7463 6828 0a20 2020 2020 2020 2020  patch(.         
+00022990: 2020 2020 2020 2066 222f 6e6f 7465 626f         f"/notebo
+000229a0: 6f6b 732f 7b75 7569 647d 2f73 6176 655f  oks/{uuid}/save_
+000229b0: 6173 222c 0a20 2020 2020 2020 2020 2020  as",.           
+000229c0: 2020 2020 2071 7565 7279 5f73 7472 696e       query_strin
+000229d0: 673d 7b0a 2020 2020 2020 2020 2020 2020  g={.            
+000229e0: 2020 2020 2020 2020 2266 696c 656e 616d          "filenam
+000229f0: 6522 3a20 2261 7768 6f6c 656e 6577 6e61  e": "awholenewna
+00022a00: 6d65 222c 0a20 2020 2020 2020 2020 2020  me",.           
+00022a10: 2020 2020 2020 2020 2022 6469 7265 6374           "direct
+00022a20: 6f72 7922 3a20 6f74 6865 725f 6e6f 7465  ory": other_note
+00022a30: 626f 6f6b 5f64 6972 6563 746f 7279 2c0a  book_directory,.
+00022a40: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00022a50: 7d2c 0a20 2020 2020 2020 2020 2020 2020  },.             
+00022a60: 2020 2068 6561 6465 7273 3d73 7570 6572     headers=super
+00022a70: 7573 6572 5f74 6f6b 656e 5f68 6561 6465  user_token_heade
+00022a80: 7273 2c0a 2020 2020 2020 2020 2020 2020  rs,.            
+00022a90: 290a 2020 2020 2020 2020 2020 2020 6173  ).            as
+00022aa0: 7365 7274 2072 6573 706f 6e73 652e 7374  sert response.st
+00022ab0: 6174 7573 5f63 6f64 6520 3d3d 2032 3030  atus_code == 200
+00022ac0: 0a20 2020 2020 2020 2020 2020 2061 7373  .            ass
+00022ad0: 6572 7420 280a 2020 2020 2020 2020 2020  ert (.          
+00022ae0: 2020 2020 2020 7265 7370 6f6e 7365 2e6a        response.j
+00022af0: 736f 6e28 295b 2270 6174 6822 5d0a 2020  son()["path"].  
+00022b00: 2020 2020 2020 2020 2020 2020 2020 3d3d                ==
+00022b10: 2066 227b 6f74 6865 725f 6e6f 7465 626f   f"{other_notebo
+00022b20: 6f6b 5f64 6972 6563 746f 7279 7d2f 6177  ok_directory}/aw
+00022b30: 686f 6c65 6e65 776e 616d 652e 6970 796e  holenewname.ipyn
+00022b40: 6222 0a20 2020 2020 2020 2020 2020 2029  b".            )
+00022b50: 0a0a 2020 2020 2020 2020 2020 2020 6461  ..            da
+00022b60: 7461 203d 2061 7761 6974 2072 6563 6569  ta = await recei
+00022b70: 7665 5f6a 736f 6e28 7765 6273 6f63 6b65  ve_json(websocke
+00022b80: 742c 206d 7367 5f74 7970 6573 3d5b 226d  t, msg_types=["m
+00022b90: 6574 6164 6174 6122 5d29 0a20 2020 2020  etadata"]).     
+00022ba0: 2020 2020 2020 206d 6574 6164 6174 6120         metadata 
+00022bb0: 3d20 6461 7461 5b22 6d65 7461 6461 7461  = data["metadata
+00022bc0: 225d 0a20 2020 2020 2020 2020 2020 2061  "].            a
+00022bd0: 7373 6572 7420 280a 2020 2020 2020 2020  ssert (.        
+00022be0: 2020 2020 2020 2020 7265 736f 6c76 6528          resolve(
+00022bf0: 6d65 7461 6461 7461 5b22 6a75 7079 7465  metadata["jupyte
+00022c00: 725f 6431 225d 5b22 7061 7468 225d 290a  r_d1"]["path"]).
+00022c10: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00022c20: 3d3d 2072 6573 6f6c 7665 2866 227b 6f74  == resolve(f"{ot
+00022c30: 6865 725f 6e6f 7465 626f 6f6b 5f64 6972  her_notebook_dir
+00022c40: 6563 746f 7279 7d2f 6177 686f 6c65 6e65  ectory}/awholene
+00022c50: 776e 616d 652e 6970 796e 6222 290a 2020  wname.ipynb").  
+00022c60: 2020 2020 2020 2020 2020 290a 2020 2020            ).    
+00022c70: 2020 2020 2020 2020 6173 7365 7274 206d          assert m
+00022c80: 6574 6164 6174 615b 226a 7570 7974 6572  etadata["jupyter
+00022c90: 5f64 3122 5d5b 226e 616d 6522 5d20 3d3d  _d1"]["name"] ==
+00022ca0: 2022 6177 686f 6c65 6e65 776e 616d 6522   "awholenewname"
+00022cb0: 0a0a 2020 2020 2020 2020 2020 2020 6173  ..            as
+00022cc0: 7365 7274 206f 732e 7061 7468 2e65 7869  sert os.path.exi
+00022cd0: 7374 7328 6622 7b6f 7468 6572 5f6e 6f74  sts(f"{other_not
+00022ce0: 6562 6f6f 6b5f 6469 7265 6374 6f72 797d  ebook_directory}
+00022cf0: 2f61 7768 6f6c 656e 6577 6e61 6d65 2e69  /awholenewname.i
+00022d00: 7079 6e62 2229 0a20 2020 2020 2020 2020  pynb").         
+00022d10: 2020 2061 7373 6572 7420 6f73 2e70 6174     assert os.pat
+00022d20: 682e 6578 6973 7473 2866 227b 7365 7474  h.exists(f"{sett
+00022d30: 696e 6773 2e52 4f4f 545f 4449 527d 2f73  ings.ROOT_DIR}/s
+00022d40: 696d 706c 652e 6970 796e 6222 290a 0a20  imple.ipynb").. 
+00022d50: 2020 2040 7079 7465 7374 2e6d 6172 6b2e     @pytest.mark.
+00022d60: 6173 796e 6369 6f0a 2020 2020 6173 796e  asyncio.    asyn
+00022d70: 6320 6465 6620 7465 7374 5f73 6176 655f  c def test_save_
+00022d80: 6173 5f66 696c 655f 6578 6973 7473 280a  as_file_exists(.
+00022d90: 2020 2020 2020 2020 7365 6c66 2c20 636c          self, cl
+00022da0: 6965 6e74 3a20 5465 7374 436c 6965 6e74  ient: TestClient
+00022db0: 2c20 7375 7065 7275 7365 725f 746f 6b65  , superuser_toke
+00022dc0: 6e5f 6865 6164 6572 733a 2044 6963 745b  n_headers: Dict[
+00022dd0: 7374 722c 2073 7472 5d2c 0a20 2020 2020  str, str],.     
+00022de0: 2020 206f 7468 6572 5f6e 6f74 6562 6f6f     other_noteboo
+00022df0: 6b5f 6469 7265 6374 6f72 793a 2073 7472  k_directory: str
+00022e00: 0a20 2020 2029 3a0a 2020 2020 2020 2020  .    ):.        
+00022e10: 2222 2246 6169 6c20 6966 2066 696c 6520  """Fail if file 
+00022e20: 6578 6973 7473 2075 6e6c 6573 7320 6f76  exists unless ov
+00022e30: 6572 7772 6974 6520 7061 7261 6d20 6973  erwrite param is
+00022e40: 2073 6574 2074 6f20 7472 7565 2222 220a   set to true""".
+00022e50: 2020 2020 2020 2020 7575 6964 203d 2061          uuid = a
+00022e60: 7761 6974 2075 706c 6f61 645f 6e6f 7465  wait upload_note
+00022e70: 626f 6f6b 280a 2020 2020 2020 2020 2020  book(.          
+00022e80: 2020 636c 6965 6e74 2c20 7375 7065 7275    client, superu
+00022e90: 7365 725f 746f 6b65 6e5f 6865 6164 6572  ser_token_header
+00022ea0: 732c 2066 696c 656e 616d 653d 2273 696d  s, filename="sim
+00022eb0: 706c 652e 6970 796e 6222 0a20 2020 2020  ple.ipynb".     
+00022ec0: 2020 2029 0a0a 2020 2020 2020 2020 7769     )..        wi
+00022ed0: 7468 206f 7065 6e28 6622 7b6f 7468 6572  th open(f"{other
+00022ee0: 5f6e 6f74 6562 6f6f 6b5f 6469 7265 6374  _notebook_direct
+00022ef0: 6f72 797d 2f61 7768 6f6c 656e 6577 6e61  ory}/awholenewna
+00022f00: 6d65 2e69 7079 6e62 222c 2022 7722 2920  me.ipynb", "w") 
+00022f10: 6173 2066 3a0a 2020 2020 2020 2020 2020  as f:.          
+00022f20: 2020 662e 7772 6974 6528 2273 6f6d 6520    f.write("some 
+00022f30: 7465 7874 2068 6572 6522 290a 0a20 2020  text here")..   
+00022f40: 2020 2020 2061 7373 6572 7420 6f73 2e70       assert os.p
+00022f50: 6174 682e 6578 6973 7473 2866 227b 7365  ath.exists(f"{se
+00022f60: 7474 696e 6773 2e52 4f4f 545f 4449 527d  ttings.ROOT_DIR}
+00022f70: 2f73 696d 706c 652e 6970 796e 6222 290a  /simple.ipynb").
+00022f80: 2020 2020 2020 2020 6173 7365 7274 206f          assert o
+00022f90: 732e 7061 7468 2e65 7869 7374 7328 6622  s.path.exists(f"
+00022fa0: 7b6f 7468 6572 5f6e 6f74 6562 6f6f 6b5f  {other_notebook_
+00022fb0: 6469 7265 6374 6f72 797d 2f61 7768 6f6c  directory}/awhol
+00022fc0: 656e 6577 6e61 6d65 2e69 7079 6e62 2229  enewname.ipynb")
+00022fd0: 0a0a 2020 2020 2020 2020 6173 796e 6320  ..        async 
+00022fe0: 7769 7468 2063 6c69 656e 742e 7765 6273  with client.webs
+00022ff0: 6f63 6b65 745f 636f 6e6e 6563 7428 0a20  ocket_connect(. 
+00023000: 2020 2020 2020 2020 2020 2066 222f 6e6f             f"/no
+00023010: 7465 626f 6f6b 732f 7b75 7569 647d 2f77  tebooks/{uuid}/w
+00023020: 732f 6e6f 7465 626f 6f6b 222c 2068 6561  s/notebook", hea
+00023030: 6465 7273 3d73 7570 6572 7573 6572 5f74  ders=superuser_t
+00023040: 6f6b 656e 5f68 6561 6465 7273 0a20 2020  oken_headers.   
+00023050: 2020 2020 2029 2061 7320 7765 6273 6f63       ) as websoc
+00023060: 6b65 743a 0a20 2020 2020 2020 2020 2020  ket:.           
+00023070: 2072 6573 706f 6e73 6520 3d20 6177 6169   response = awai
+00023080: 7420 636c 6965 6e74 2e70 6174 6368 280a  t client.patch(.
+00023090: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000230a0: 6622 2f6e 6f74 6562 6f6f 6b73 2f7b 7575  f"/notebooks/{uu
+000230b0: 6964 7d2f 7361 7665 5f61 7322 2c0a 2020  id}/save_as",.  
+000230c0: 2020 2020 2020 2020 2020 2020 2020 7175                qu
+000230d0: 6572 795f 7374 7269 6e67 3d7b 0a20 2020  ery_string={.   
+000230e0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000230f0: 2022 6669 6c65 6e61 6d65 223a 2022 6177   "filename": "aw
+00023100: 686f 6c65 6e65 776e 616d 6522 2c0a 2020  holenewname",.  
+00023110: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00023120: 2020 2264 6972 6563 746f 7279 223a 206f    "directory": o
+00023130: 7468 6572 5f6e 6f74 6562 6f6f 6b5f 6469  ther_notebook_di
+00023140: 7265 6374 6f72 792c 0a20 2020 2020 2020  rectory,.       
+00023150: 2020 2020 2020 2020 207d 2c0a 2020 2020           },.    
+00023160: 2020 2020 2020 2020 2020 2020 6865 6164              head
+00023170: 6572 733d 7375 7065 7275 7365 725f 746f  ers=superuser_to
+00023180: 6b65 6e5f 6865 6164 6572 732c 0a20 2020  ken_headers,.   
+00023190: 2020 2020 2020 2020 2029 0a20 2020 2020           ).     
+000231a0: 2020 2020 2020 2061 7373 6572 7420 7265         assert re
+000231b0: 7370 6f6e 7365 2e73 7461 7475 735f 636f  sponse.status_co
+000231c0: 6465 203d 3d20 3430 300a 2020 2020 2020  de == 400.      
+000231d0: 2020 2020 2020 6173 7365 7274 2072 6573        assert res
+000231e0: 706f 6e73 652e 6a73 6f6e 2829 5b22 6465  ponse.json()["de
+000231f0: 7461 696c 225d 203d 3d20 6622 4669 6c65  tail"] == f"File
+00023200: 2061 6c72 6561 6479 2065 7869 7374 7322   already exists"
+00023210: 0a0a 2020 2020 2020 2020 2020 2020 7265  ..            re
+00023220: 7370 6f6e 7365 203d 2061 7761 6974 2063  sponse = await c
+00023230: 6c69 656e 742e 7061 7463 6828 0a20 2020  lient.patch(.   
+00023240: 2020 2020 2020 2020 2020 2020 2066 222f               f"/
+00023250: 6e6f 7465 626f 6f6b 732f 7b75 7569 647d  notebooks/{uuid}
+00023260: 2f73 6176 655f 6173 222c 0a20 2020 2020  /save_as",.     
+00023270: 2020 2020 2020 2020 2020 2071 7565 7279             query
+00023280: 5f73 7472 696e 673d 7b0a 2020 2020 2020  _string={.      
+00023290: 2020 2020 2020 2020 2020 2020 2020 2266                "f
+000232a0: 696c 656e 616d 6522 3a20 2261 7768 6f6c  ilename": "awhol
+000232b0: 656e 6577 6e61 6d65 222c 0a20 2020 2020  enewname",.     
+000232c0: 2020 2020 2020 2020 2020 2020 2020 2022                 "
+000232d0: 6469 7265 6374 6f72 7922 3a20 6f74 6865  directory": othe
+000232e0: 725f 6e6f 7465 626f 6f6b 5f64 6972 6563  r_notebook_direc
+000232f0: 746f 7279 2c0a 2020 2020 2020 2020 2020  tory,.          
+00023300: 2020 2020 2020 2020 2020 226f 7665 7277            "overw
+00023310: 7269 7465 223a 2054 7275 652c 0a20 2020  rite": True,.   
+00023320: 2020 2020 2020 2020 2020 2020 207d 2c0a               },.
+00023330: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00023340: 6865 6164 6572 733d 7375 7065 7275 7365  headers=superuse
+00023350: 725f 746f 6b65 6e5f 6865 6164 6572 732c  r_token_headers,
+00023360: 0a20 2020 2020 2020 2020 2020 2029 0a20  .            ). 
+00023370: 2020 2020 2020 2020 2020 2061 7373 6572             asser
+00023380: 7420 7265 7370 6f6e 7365 2e73 7461 7475  t response.statu
+00023390: 735f 636f 6465 203d 3d20 3230 300a 2020  s_code == 200.  
+000233a0: 2020 2020 2020 2020 2020 6173 7365 7274            assert
+000233b0: 2028 0a20 2020 2020 2020 2020 2020 2020   (.             
+000233c0: 2020 2072 6573 706f 6e73 652e 6a73 6f6e     response.json
+000233d0: 2829 5b22 7061 7468 225d 0a20 2020 2020  ()["path"].     
+000233e0: 2020 2020 2020 2020 2020 203d 3d20 6622             == f"
+000233f0: 7b6f 7468 6572 5f6e 6f74 6562 6f6f 6b5f  {other_notebook_
+00023400: 6469 7265 6374 6f72 797d 2f61 7768 6f6c  directory}/awhol
+00023410: 656e 6577 6e61 6d65 2e69 7079 6e62 220a  enewname.ipynb".
+00023420: 2020 2020 2020 2020 2020 2020 290a 0a20              ).. 
+00023430: 2020 2020 2020 2020 2020 2064 6174 6120             data 
+00023440: 3d20 6177 6169 7420 7265 6365 6976 655f  = await receive_
+00023450: 6a73 6f6e 2877 6562 736f 636b 6574 2c20  json(websocket, 
+00023460: 6d73 675f 7479 7065 733d 5b22 6d65 7461  msg_types=["meta
+00023470: 6461 7461 225d 290a 2020 2020 2020 2020  data"]).        
+00023480: 2020 2020 6d65 7461 6461 7461 203d 2064      metadata = d
+00023490: 6174 615b 226d 6574 6164 6174 6122 5d0a  ata["metadata"].
+000234a0: 2020 2020 2020 2020 2020 2020 6173 7365              asse
+000234b0: 7274 2028 0a20 2020 2020 2020 2020 2020  rt (.           
+000234c0: 2020 2020 2072 6573 6f6c 7665 286d 6574       resolve(met
+000234d0: 6164 6174 615b 226a 7570 7974 6572 5f64  adata["jupyter_d
+000234e0: 3122 5d5b 2270 6174 6822 5d29 0a20 2020  1"]["path"]).   
+000234f0: 2020 2020 2020 2020 2020 2020 203d 3d20               == 
+00023500: 7265 736f 6c76 6528 6622 7b6f 7468 6572  resolve(f"{other
+00023510: 5f6e 6f74 6562 6f6f 6b5f 6469 7265 6374  _notebook_direct
+00023520: 6f72 797d 2f61 7768 6f6c 656e 6577 6e61  ory}/awholenewna
+00023530: 6d65 2e69 7079 6e62 2229 0a20 2020 2020  me.ipynb").     
+00023540: 2020 2020 2020 2029 0a20 2020 2020 2020         ).       
+00023550: 2020 2020 2061 7373 6572 7420 6d65 7461       assert meta
+00023560: 6461 7461 5b22 6a75 7079 7465 725f 6431  data["jupyter_d1
+00023570: 225d 5b22 6e61 6d65 225d 203d 3d20 2261  "]["name"] == "a
+00023580: 7768 6f6c 656e 6577 6e61 6d65 220a 0a20  wholenewname".. 
+00023590: 2020 2020 2020 2020 2020 2061 7373 6572             asser
+000235a0: 7420 6f73 2e70 6174 682e 6578 6973 7473  t os.path.exists
+000235b0: 2866 227b 6f74 6865 725f 6e6f 7465 626f  (f"{other_notebo
+000235c0: 6f6b 5f64 6972 6563 746f 7279 7d2f 6177  ok_directory}/aw
+000235d0: 686f 6c65 6e65 776e 616d 652e 6970 796e  holenewname.ipyn
+000235e0: 6222 290a 2020 2020 2020 2020 2020 2020  b").            
+000235f0: 6173 7365 7274 206f 732e 7061 7468 2e65  assert os.path.e
+00023600: 7869 7374 7328 6622 7b73 6574 7469 6e67  xists(f"{setting
+00023610: 732e 524f 4f54 5f44 4952 7d2f 7369 6d70  s.ROOT_DIR}/simp
+00023620: 6c65 2e69 7079 6e62 2229 0a0a 2020 2020  le.ipynb")..    
+00023630: 2020 2020 7769 7468 206f 7065 6e28 6622      with open(f"
+00023640: 7b6f 7468 6572 5f6e 6f74 6562 6f6f 6b5f  {other_notebook_
+00023650: 6469 7265 6374 6f72 797d 2f61 7768 6f6c  directory}/awhol
+00023660: 656e 6577 6e61 6d65 2e69 7079 6e62 222c  enewname.ipynb",
+00023670: 2022 7222 2920 6173 2066 3a0a 2020 2020   "r") as f:.    
+00023680: 2020 2020 2020 2020 6173 7365 7274 2066          assert f
+00023690: 2e72 6561 6428 2920 213d 2022 736f 6d65  .read() != "some
+000236a0: 2074 6578 7420 6865 7265 220a 0a0a 4070   text here"...@p
+000236b0: 7974 6573 742e 6d61 726b 2e75 7365 6669  ytest.mark.usefi
+000236c0: 7874 7572 6573 2822 636c 6561 725f 6e6f  xtures("clear_no
+000236d0: 7465 626f 6f6b 7322 2c20 2263 6c65 6172  tebooks", "clear
+000236e0: 5f6e 6f74 6562 6f6f 6b5f 6469 7265 6374  _notebook_direct
+000236f0: 6f72 7922 290a 636c 6173 7320 5465 7374  ory").class Test
+00023700: 4431 436f 6d6d 616e 6473 3a0a 2020 2020  D1Commands:.    
+00023710: 6173 796e 6320 6465 6620 646f 5f74 6573  async def do_tes
+00023720: 745f 6431 5f6e 6f74 6966 7928 0a20 2020  t_d1_notify(.   
+00023730: 2020 2020 2073 656c 662c 0a20 2020 2020       self,.     
+00023740: 2020 2063 656c 6c5f 636f 6e74 656e 743a     cell_content:
+00023750: 2073 7472 2c0a 2020 2020 2020 2020 6e6f   str,.        no
+00023760: 7469 6669 6361 7469 6f6e 733a 204c 6973  tifications: Lis
+00023770: 745b 7374 725d 2c0a 2020 2020 2020 2020  t[str],.        
+00023780: 7265 6d61 696e 696e 675f 7374 646f 7574  remaining_stdout
+00023790: 3a20 7374 722c 0a20 2020 2020 2020 2063  : str,.        c
+000237a0: 6c69 656e 743a 2054 6573 7443 6c69 656e  lient: TestClien
+000237b0: 742c 0a20 2020 2020 2020 2073 7570 6572  t,.        super
+000237c0: 7573 6572 5f74 6f6b 656e 5f68 6561 6465  user_token_heade
+000237d0: 7273 3a20 4469 6374 5b73 7472 2c20 7374  rs: Dict[str, st
+000237e0: 725d 2c0a 2020 2020 2020 2020 6d6f 636b  r],.        mock
+000237f0: 6572 3a20 4d6f 636b 4669 7874 7572 652c  er: MockFixture,
+00023800: 0a20 2020 2029 3a0a 2020 2020 2020 2020  .    ):.        
+00023810: 6578 6563 7574 655f 6431 5f63 6f6d 6d61  execute_d1_comma
+00023820: 6e64 203d 206d 6f63 6b65 722e 7061 7463  nd = mocker.patc
+00023830: 6828 0a20 2020 2020 2020 2020 2020 2022  h(.            "
+00023840: 6a75 7079 7465 725f 6431 2e73 746f 7261  jupyter_d1.stora
+00023850: 6765 2e6e 6f74 6562 6f6f 6b5f 6d61 6e61  ge.notebook_mana
+00023860: 6765 722e 6578 6563 7574 655f 6431 5f63  ger.execute_d1_c
+00023870: 6f6d 6d61 6e64 220a 2020 2020 2020 2020  ommand".        
+00023880: 290a 0a20 2020 2020 2020 2075 7569 6420  )..        uuid 
+00023890: 3d20 6177 6169 7420 7570 6c6f 6164 5f6e  = await upload_n
+000238a0: 6f74 6562 6f6f 6b28 0a20 2020 2020 2020  otebook(.       
+000238b0: 2020 2020 2063 6c69 656e 742c 2073 7570       client, sup
+000238c0: 6572 7573 6572 5f74 6f6b 656e 5f68 6561  eruser_token_hea
+000238d0: 6465 7273 2c20 2273 696d 706c 652e 6970  ders, "simple.ip
+000238e0: 796e 6222 0a20 2020 2020 2020 2029 0a0a  ynb".        )..
+000238f0: 2020 2020 2020 2020 2320 6765 7420 616e          # get an
+00023900: 2065 7869 7374 696e 6720 6365 6c6c 0a20   existing cell. 
+00023910: 2020 2020 2020 2072 6573 706f 6e73 6520         response 
+00023920: 3d20 6177 6169 7420 636c 6965 6e74 2e67  = await client.g
+00023930: 6574 280a 2020 2020 2020 2020 2020 2020  et(.            
+00023940: 6622 2f6e 6f74 6562 6f6f 6b73 2f7b 7575  f"/notebooks/{uu
+00023950: 6964 7d2f 6365 6c6c 7322 2c20 6865 6164  id}/cells", head
+00023960: 6572 733d 7375 7065 7275 7365 725f 746f  ers=superuser_to
+00023970: 6b65 6e5f 6865 6164 6572 730a 2020 2020  ken_headers.    
+00023980: 2020 2020 290a 2020 2020 2020 2020 6173      ).        as
+00023990: 7365 7274 2072 6573 706f 6e73 652e 7374  sert response.st
+000239a0: 6174 7573 5f63 6f64 6520 3d3d 2032 3030  atus_code == 200
+000239b0: 0a20 2020 2020 2020 2063 656c 6c73 203d  .        cells =
+000239c0: 2072 6573 706f 6e73 652e 6a73 6f6e 2829   response.json()
+000239d0: 5b22 6365 6c6c 7322 5d0a 2020 2020 2020  ["cells"].      
+000239e0: 2020 6173 7365 7274 2063 656c 6c73 5b31    assert cells[1
+000239f0: 5d5b 2273 6f75 7263 6522 5d20 3d3d 2027  ]["source"] == '
+00023a00: 7072 696e 7428 224c 6172 7279 2074 6865  print("Larry the
+00023a10: 204c 6c61 6d61 2229 270a 0a20 2020 2020   Llama")'..     
+00023a20: 2020 2063 656c 6c5f 7575 6964 203d 2063     cell_uuid = c
+00023a30: 656c 6c73 5b31 5d5b 226d 6574 6164 6174  ells[1]["metadat
+00023a40: 6122 5d5b 226a 7570 7974 6572 5f64 3122  a"]["jupyter_d1"
+00023a50: 5d5b 2275 7569 6422 5d0a 2020 2020 2020  ]["uuid"].      
+00023a60: 2020 6173 7365 7274 2063 656c 6c73 5b31    assert cells[1
+00023a70: 5d5b 2265 7865 6375 7469 6f6e 5f63 6f75  ]["execution_cou
+00023a80: 6e74 225d 2069 7320 4e6f 6e65 0a0a 2020  nt"] is None..  
+00023a90: 2020 2020 2020 626f 6479 203d 207b 2273        body = {"s
+00023aa0: 6f75 7263 6522 3a20 6365 6c6c 5f63 6f6e  ource": cell_con
+00023ab0: 7465 6e74 7d0a 2020 2020 2020 2020 7265  tent}.        re
+00023ac0: 7370 6f6e 7365 203d 2061 7761 6974 2063  sponse = await c
+00023ad0: 6c69 656e 742e 7061 7463 6828 0a20 2020  lient.patch(.   
+00023ae0: 2020 2020 2020 2020 2066 222f 6e6f 7465           f"/note
+00023af0: 626f 6f6b 732f 7b75 7569 647d 2f63 656c  books/{uuid}/cel
+00023b00: 6c73 2f7b 6365 6c6c 5f75 7569 647d 222c  ls/{cell_uuid}",
+00023b10: 0a20 2020 2020 2020 2020 2020 206a 736f  .            jso
+00023b20: 6e3d 626f 6479 2c0a 2020 2020 2020 2020  n=body,.        
+00023b30: 2020 2020 6865 6164 6572 733d 7375 7065      headers=supe
+00023b40: 7275 7365 725f 746f 6b65 6e5f 6865 6164  ruser_token_head
+00023b50: 6572 732c 0a20 2020 2020 2020 2029 0a20  ers,.        ). 
+00023b60: 2020 2020 2020 2061 7373 6572 7420 7265         assert re
+00023b70: 7370 6f6e 7365 2e73 7461 7475 735f 636f  sponse.status_co
+00023b80: 6465 203d 3d20 3230 300a 0a20 2020 2020  de == 200..     
+00023b90: 2020 2061 7379 6e63 2077 6974 6820 636c     async with cl
+00023ba0: 6965 6e74 2e77 6562 736f 636b 6574 5f63  ient.websocket_c
+00023bb0: 6f6e 6e65 6374 280a 2020 2020 2020 2020  onnect(.        
+00023bc0: 2020 2020 6622 2f6e 6f74 6562 6f6f 6b73      f"/notebooks
+00023bd0: 2f7b 7575 6964 7d2f 7773 2f6e 6f74 6562  /{uuid}/ws/noteb
+00023be0: 6f6f 6b22 2c20 6865 6164 6572 733d 7375  ook", headers=su
+00023bf0: 7065 7275 7365 725f 746f 6b65 6e5f 6865  peruser_token_he
+00023c00: 6164 6572 730a 2020 2020 2020 2020 2920  aders.        ) 
+00023c10: 6173 2077 6562 736f 636b 6574 3a0a 2020  as websocket:.  
+00023c20: 2020 2020 2020 2020 2020 6177 6169 7420            await 
+00023c30: 6173 796e 6369 6f2e 736c 6565 7028 5745  asyncio.sleep(WE
+00023c40: 4253 4f43 4b45 545f 534c 4545 505f 5449  BSOCKET_SLEEP_TI
+00023c50: 4d45 290a 0a20 2020 2020 2020 2020 2020  ME)..           
+00023c60: 2072 6573 706f 6e73 6520 3d20 6177 6169   response = awai
+00023c70: 7420 636c 6965 6e74 2e67 6574 280a 2020  t client.get(.  
+00023c80: 2020 2020 2020 2020 2020 2020 2020 6622                f"
+00023c90: 2f6e 6f74 6562 6f6f 6b73 2f7b 7575 6964  /notebooks/{uuid
+00023ca0: 7d2f 6365 6c6c 732f 7b63 656c 6c5f 7575  }/cells/{cell_uu
+00023cb0: 6964 7d2f 6578 6563 7574 6522 2c0a 2020  id}/execute",.  
+00023cc0: 2020 2020 2020 2020 2020 2020 2020 6865                he
+00023cd0: 6164 6572 733d 7375 7065 7275 7365 725f  aders=superuser_
+00023ce0: 746f 6b65 6e5f 6865 6164 6572 732c 0a20  token_headers,. 
+00023cf0: 2020 2020 2020 2020 2020 2029 0a20 2020             ).   
+00023d00: 2020 2020 2020 2020 2061 7373 6572 7420           assert 
+00023d10: 7265 7370 6f6e 7365 2e73 7461 7475 735f  response.status_
+00023d20: 636f 6465 203d 3d20 3230 300a 0a20 2020  code == 200..   
+00023d30: 2020 2020 2020 2020 2072 6563 6569 7665           receive
+00023d40: 645f 696e 666f 203d 207b 0a20 2020 2020  d_info = {.     
+00023d50: 2020 2020 2020 2020 2020 2022 7265 6365             "rece
+00023d60: 6976 6564 5f63 656c 6c5f 7570 6461 7465  ived_cell_update
+00023d70: 5f63 6f75 6e74 223a 2030 2c0a 2020 2020  _count": 0,.    
+00023d80: 2020 2020 2020 2020 2020 2020 2272 6563              "rec
+00023d90: 6569 7665 645f 6365 6c6c 5f65 7865 6375  eived_cell_execu
+00023da0: 7469 6f6e 223a 2046 616c 7365 2c0a 2020  tion": False,.  
+00023db0: 2020 2020 2020 2020 2020 2020 2020 2272                "r
+00023dc0: 6563 6569 7665 645f 7661 7273 223a 2046  eceived_vars": F
+00023dd0: 616c 7365 2c0a 2020 2020 2020 2020 2020  alse,.          
+00023de0: 2020 7d0a 0a20 2020 2020 2020 2020 2020    }..           
+00023df0: 2061 7379 6e63 2064 6566 2072 6563 6569   async def recei
+00023e00: 7665 5f63 656c 6c5f 7570 6461 7465 2864  ve_cell_update(d
+00023e10: 6174 6129 3a0a 2020 2020 2020 2020 2020  ata):.          
+00023e20: 2020 2020 2020 6365 6c6c 5f75 7064 6174        cell_updat
+00023e30: 6520 3d20 6461 7461 5b22 6365 6c6c 5f75  e = data["cell_u
+00023e40: 7064 6174 6522 5d0a 2020 2020 2020 2020  pdate"].        
+00023e50: 2020 2020 2020 2020 6173 7365 7274 206c          assert l
+00023e60: 656e 2863 656c 6c5f 7570 6461 7465 2920  en(cell_update) 
+00023e70: 3d3d 2031 0a20 2020 2020 2020 2020 2020  == 1.           
+00023e80: 2020 2020 2063 656c 6c5f 6431 5f64 6174       cell_d1_dat
+00023e90: 6120 3d20 6365 6c6c 5f75 7064 6174 655b  a = cell_update[
+00023ea0: 305d 5b22 6d65 7461 6461 7461 225d 5b22  0]["metadata"]["
+00023eb0: 6a75 7079 7465 725f 6431 225d 0a20 2020  jupyter_d1"].   
+00023ec0: 2020 2020 2020 2020 2020 2020 2061 7373               ass
+00023ed0: 6572 7420 6365 6c6c 5f64 315f 6461 7461  ert cell_d1_data
+00023ee0: 5b22 7575 6964 225d 203d 3d20 6365 6c6c  ["uuid"] == cell
+00023ef0: 5f75 7569 640a 2020 2020 2020 2020 2020  _uuid.          
+00023f00: 2020 2020 2020 6966 2072 6563 6569 7665        if receive
+00023f10: 645f 696e 666f 5b22 7265 6365 6976 6564  d_info["received
+00023f20: 5f63 656c 6c5f 7570 6461 7465 5f63 6f75  _cell_update_cou
+00023f30: 6e74 225d 203d 3d20 303a 0a20 2020 2020  nt"] == 0:.     
+00023f40: 2020 2020 2020 2020 2020 2020 2020 2061                 a
+00023f50: 7373 6572 7420 6365 6c6c 5f64 315f 6461  ssert cell_d1_da
+00023f60: 7461 5b22 6578 6563 7574 696f 6e5f 7374  ta["execution_st
+00023f70: 6174 6522 5d20 3d3d 2022 6275 7379 220a  ate"] == "busy".
+00023f80: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00023f90: 2020 2020 6173 7365 7274 2028 0a20 2020      assert (.   
+00023fa0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00023fb0: 2020 2020 2063 656c 6c5f 7570 6461 7465       cell_update
+00023fc0: 5b30 5d5b 2265 7865 6375 7469 6f6e 5f63  [0]["execution_c
+00023fd0: 6f75 6e74 225d 2069 7320 4e6f 6e65 0a20  ount"] is None. 
+00023fe0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00023ff0: 2020 2020 2020 206f 7220 6365 6c6c 5f75         or cell_u
+00024000: 7064 6174 655b 305d 5b22 6578 6563 7574  pdate[0]["execut
+00024010: 696f 6e5f 636f 756e 7422 5d20 3d3d 2031  ion_count"] == 1
+00024020: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00024030: 2020 2020 2029 0a20 2020 2020 2020 2020       ).         
+00024040: 2020 2020 2020 2065 6c73 653a 0a20 2020         else:.   
+00024050: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00024060: 2023 2049 6620 6578 6563 7574 696f 6e5f   # If execution_
+00024070: 636f 756e 7420 6973 204e 6f6e 652c 2074  count is None, t
+00024080: 6865 6e20 7468 6973 2073 686f 756c 6420  hen this should 
+00024090: 6265 2074 6865 0a20 2020 2020 2020 2020  be the.         
+000240a0: 2020 2020 2020 2020 2020 2023 2065 7175             # equ
+000240b0: 6976 616c 656e 7420 6f66 2074 6865 206f  ivalent of the o
+000240c0: 6c64 2063 656c 6c5f 7374 7265 616d 206d  ld cell_stream m
+000240d0: 6573 7361 6765 2077 6865 7265 2074 6865  essage where the
+000240e0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+000240f0: 2020 2020 2023 2065 7865 635f 7374 6174       # exec_stat
+00024100: 6520 6973 2073 7469 6c6c 2062 7573 792e  e is still busy.
+00024110: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00024120: 2020 2020 2023 204f 6e63 6520 7468 6520       # Once the 
+00024130: 6578 6563 7574 696f 6e5f 636f 756e 7420  execution_count 
+00024140: 7570 6461 7465 732c 2074 6865 2063 656c  updates, the cel
+00024150: 6c20 7368 6f75 6c64 2062 650a 2020 2020  l should be.    
+00024160: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00024170: 2320 6964 6c65 2e0a 2020 2020 2020 2020  # idle..        
+00024180: 2020 2020 2020 2020 2020 2020 6966 2063              if c
+00024190: 656c 6c5f 7570 6461 7465 5b30 5d5b 2265  ell_update[0]["e
+000241a0: 7865 6375 7469 6f6e 5f63 6f75 6e74 225d  xecution_count"]
+000241b0: 2069 7320 6e6f 7420 4e6f 6e65 3a0a 2020   is not None:.  
+000241c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000241d0: 2020 2020 2020 6173 7365 7274 2063 656c        assert cel
+000241e0: 6c5f 7570 6461 7465 5b30 5d5b 2265 7865  l_update[0]["exe
+000241f0: 6375 7469 6f6e 5f63 6f75 6e74 225d 203d  cution_count"] =
+00024200: 3d20 310a 2020 2020 2020 2020 2020 2020  = 1.            
+00024210: 2020 2020 2020 2020 2020 2020 6173 7365              asse
+00024220: 7274 2063 656c 6c5f 6431 5f64 6174 615b  rt cell_d1_data[
+00024230: 2265 7865 6375 7469 6f6e 5f73 7461 7465  "execution_state
+00024240: 225d 203d 3d20 2269 646c 6522 0a20 2020  "] == "idle".   
+00024250: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00024260: 2065 6c73 653a 0a20 2020 2020 2020 2020   else:.         
+00024270: 2020 2020 2020 2020 2020 2020 2020 2061                 a
+00024280: 7373 6572 7420 6365 6c6c 5f64 315f 6461  ssert cell_d1_da
+00024290: 7461 5b22 6578 6563 7574 696f 6e5f 7374  ta["execution_st
+000242a0: 6174 6522 5d20 3d3d 2022 6275 7379 220a  ate"] == "busy".
+000242b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000242c0: 7265 6365 6976 6564 5f69 6e66 6f5b 2272  received_info["r
+000242d0: 6563 6569 7665 645f 6365 6c6c 5f75 7064  eceived_cell_upd
+000242e0: 6174 655f 636f 756e 7422 5d20 2b3d 2031  ate_count"] += 1
+000242f0: 0a0a 2020 2020 2020 2020 2020 2020 6173  ..            as
+00024300: 796e 6320 6465 6620 7265 6365 6976 655f  ync def receive_
+00024310: 6365 6c6c 5f65 7865 6375 7469 6f6e 2864  cell_execution(d
+00024320: 6174 6129 3a0a 2020 2020 2020 2020 2020  ata):.          
+00024330: 2020 2020 2020 6365 6c6c 5f65 7865 6320        cell_exec 
+00024340: 3d20 6461 7461 5b22 6365 6c6c 5f65 7865  = data["cell_exe
+00024350: 6375 7469 6f6e 5f72 6570 6c79 225d 0a20  cution_reply"]. 
+00024360: 2020 2020 2020 2020 2020 2020 2020 2061                 a
+00024370: 7373 6572 7420 6365 6c6c 5f65 7865 635b  ssert cell_exec[
+00024380: 2263 656c 6c5f 6964 225d 203d 3d20 6365  "cell_id"] == ce
+00024390: 6c6c 5f75 7569 640a 2020 2020 2020 2020  ll_uuid.        
+000243a0: 2020 2020 2020 2020 6173 7365 7274 2063          assert c
+000243b0: 656c 6c5f 6578 6563 5b22 6578 6563 7574  ell_exec["execut
+000243c0: 696f 6e5f 636f 756e 7422 5d20 3d3d 2031  ion_count"] == 1
+000243d0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+000243e0: 2061 7373 6572 7420 6c65 6e28 6365 6c6c   assert len(cell
+000243f0: 5f65 7865 635b 2270 6172 656e 745f 6964  _exec["parent_id
+00024400: 225d 2920 696e 206d 7367 5f69 645f 6c65  "]) in msg_id_le
+00024410: 6e67 7468 730a 2020 2020 2020 2020 2020  ngths.          
+00024420: 2020 2020 2020 7265 6365 6976 6564 5f69        received_i
+00024430: 6e66 6f5b 2272 6563 6569 7665 645f 6365  nfo["received_ce
+00024440: 6c6c 5f65 7865 6375 7469 6f6e 225d 203d  ll_execution"] =
+00024450: 2054 7275 650a 0a20 2020 2020 2020 2020   True..         
+00024460: 2020 206d 7367 5f74 7970 6573 203d 205b     msg_types = [
+00024470: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00024480: 2022 6365 6c6c 5f75 7064 6174 6522 2c0a   "cell_update",.
+00024490: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000244a0: 2263 656c 6c5f 6578 6563 7574 696f 6e5f  "cell_execution_
+000244b0: 7265 706c 7922 2c0a 2020 2020 2020 2020  reply",.        
+000244c0: 2020 2020 2020 2020 2276 6172 7322 2c0a          "vars",.
+000244d0: 2020 2020 2020 2020 2020 2020 5d0a 2020              ].  
+000244e0: 2020 2020 2020 2020 2020 666f 7220 6920            for i 
+000244f0: 696e 2072 616e 6765 2835 293a 0a20 2020  in range(5):.   
+00024500: 2020 2020 2020 2020 2020 2020 2064 6174               dat
+00024510: 6120 3d20 6177 6169 7420 7265 6365 6976  a = await receiv
+00024520: 655f 6a73 6f6e 2877 6562 736f 636b 6574  e_json(websocket
+00024530: 2c20 3230 2c20 6d73 675f 7479 7065 733d  , 20, msg_types=
+00024540: 6d73 675f 7479 7065 7329 0a20 2020 2020  msg_types).     
+00024550: 2020 2020 2020 2020 2020 2069 6620 2263             if "c
+00024560: 656c 6c5f 7570 6461 7465 2220 696e 2064  ell_update" in d
+00024570: 6174 613a 0a20 2020 2020 2020 2020 2020  ata:.           
+00024580: 2020 2020 2020 2020 2061 7761 6974 2072           await r
+00024590: 6563 6569 7665 5f63 656c 6c5f 7570 6461  eceive_cell_upda
+000245a0: 7465 2864 6174 6129 0a20 2020 2020 2020  te(data).       
+000245b0: 2020 2020 2020 2020 2069 6620 2263 656c           if "cel
+000245c0: 6c5f 6578 6563 7574 696f 6e5f 7265 706c  l_execution_repl
+000245d0: 7922 2069 6e20 6461 7461 3a0a 2020 2020  y" in data:.    
+000245e0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000245f0: 6177 6169 7420 7265 6365 6976 655f 6365  await receive_ce
+00024600: 6c6c 5f65 7865 6375 7469 6f6e 2864 6174  ll_execution(dat
+00024610: 6129 0a20 2020 2020 2020 2020 2020 2020  a).             
+00024620: 2020 2069 6620 2276 6172 7322 2069 6e20     if "vars" in 
+00024630: 6461 7461 3a0a 2020 2020 2020 2020 2020  data:.          
+00024640: 2020 2020 2020 2020 2020 7265 6365 6976            receiv
+00024650: 6564 5f69 6e66 6f5b 2272 6563 6569 7665  ed_info["receive
+00024660: 645f 7661 7273 225d 203d 2054 7275 650a  d_vars"] = True.
+00024670: 0a20 2020 2020 2020 2020 2020 2061 7373  .            ass
+00024680: 6572 7420 7265 6365 6976 6564 5f69 6e66  ert received_inf
+00024690: 6f5b 2272 6563 6569 7665 645f 6365 6c6c  o["received_cell
+000246a0: 5f75 7064 6174 655f 636f 756e 7422 5d20  _update_count"] 
+000246b0: 3d3d 2033 0a20 2020 2020 2020 2020 2020  == 3.           
+000246c0: 2061 7373 6572 7420 7265 6365 6976 6564   assert received
+000246d0: 5f69 6e66 6f5b 2272 6563 6569 7665 645f  _info["received_
+000246e0: 6365 6c6c 5f65 7865 6375 7469 6f6e 225d  cell_execution"]
+000246f0: 0a20 2020 2020 2020 2020 2020 2061 7373  .            ass
+00024700: 6572 7420 7265 6365 6976 6564 5f69 6e66  ert received_inf
+00024710: 6f5b 2272 6563 6569 7665 645f 7661 7273  o["received_vars
+00024720: 225d 0a0a 2020 2020 2020 2020 2020 2020  "]..            
+00024730: 6578 6563 7574 655f 6431 5f63 6f6d 6d61  execute_d1_comma
+00024740: 6e64 2e61 7373 6572 745f 6861 735f 6361  nd.assert_has_ca
+00024750: 6c6c 7328 0a20 2020 2020 2020 2020 2020  lls(.           
+00024760: 2020 2020 205b 6361 6c6c 286e 6f74 6529       [call(note)
+00024770: 2066 6f72 206e 6f74 6520 696e 206e 6f74   for note in not
+00024780: 6966 6963 6174 696f 6e73 5d0a 2020 2020  ifications].    
+00024790: 2020 2020 2020 2020 290a 0a20 2020 2040          )..    @
+000247a0: 7079 7465 7374 2e6d 6172 6b2e 6173 796e  pytest.mark.asyn
+000247b0: 6369 6f0a 2020 2020 6173 796e 6320 6465  cio.    async de
+000247c0: 6620 7465 7374 5f64 315f 6e6f 7469 6679  f test_d1_notify
+000247d0: 280a 2020 2020 2020 2020 7365 6c66 2c0a  (.        self,.
+000247e0: 2020 2020 2020 2020 636c 6965 6e74 3a20          client: 
+000247f0: 5465 7374 436c 6965 6e74 2c0a 2020 2020  TestClient,.    
+00024800: 2020 2020 7375 7065 7275 7365 725f 746f      superuser_to
+00024810: 6b65 6e5f 6865 6164 6572 733a 2044 6963  ken_headers: Dic
+00024820: 745b 7374 722c 2073 7472 5d2c 0a20 2020  t[str, str],.   
+00024830: 2020 2020 206d 6f63 6b65 723a 204d 6f63       mocker: Moc
+00024840: 6b46 6978 7475 7265 2c0a 2020 2020 293a  kFixture,.    ):
+00024850: 0a20 2020 2020 2020 2063 656c 6c5f 636f  .        cell_co
+00024860: 6e74 656e 7420 3d20 280a 2020 2020 2020  ntent = (.      
+00024870: 2020 2020 2020 2770 7269 6e74 2822 5f5f        'print("__
+00024880: 5f63 616c 6c69 7374 6f5f 6431 5f63 6f6d  _callisto_d1_com
+00024890: 6d61 6e64 5f5f 5f7b 270a 2020 2020 2020  mand___{'.      
+000248a0: 2020 2020 2020 275c 5c22 636f 6d6d 616e        '\\"comman
+000248b0: 645f 7479 7065 5c5c 223a 5c5c 226e 6f74  d_type\\":\\"not
+000248c0: 6966 795c 5c22 2c27 0a20 2020 2020 2020  ify\\",'.       
+000248d0: 2020 2020 2027 5c5c 2274 6974 6c65 5c5c       '\\"title\\
+000248e0: 223a 5c5c 2261 7469 746c 655c 5c22 2c27  ":\\"atitle\\",'
+000248f0: 0a20 2020 2020 2020 2020 2020 2027 5c5c  .            '\\
+00024900: 226d 6573 7361 6765 5c5c 223a 5c5c 2274  "message\\":\\"t
+00024910: 6573 7436 6534 5c5c 227d 5f5f 5f63 616c  est6e4\\"}___cal
+00024920: 6c69 7374 6f5f 6431 5f63 6f6d 6d61 6e64  listo_d1_command
+00024930: 5f5f 5f22 2c20 270a 2020 2020 2020 2020  ___", '.        
+00024940: 2020 2020 2720 656e 643d 2222 2927 0a20      ' end="")'. 
+00024950: 2020 2020 2020 2029 0a20 2020 2020 2020         ).       
+00024960: 206e 6f74 6966 6963 6174 696f 6e73 203d   notifications =
+00024970: 205b 0a20 2020 2020 2020 2020 2020 2027   [.            '
+00024980: 7b22 636f 6d6d 616e 645f 7479 7065 223a  {"command_type":
+00024990: 226e 6f74 6966 7922 2c27 0a20 2020 2020  "notify",'.     
+000249a0: 2020 2020 2020 2027 2274 6974 6c65 223a         '"title":
+000249b0: 2261 7469 746c 6522 2c27 0a20 2020 2020  "atitle",'.     
+000249c0: 2020 2020 2020 2027 226d 6573 7361 6765         '"message
+000249d0: 223a 2274 6573 7436 6534 227d 270a 2020  ":"test6e4"}'.  
+000249e0: 2020 2020 2020 5d0a 2020 2020 2020 2020        ].        
+000249f0: 6177 6169 7420 7365 6c66 2e64 6f5f 7465  await self.do_te
+00024a00: 7374 5f64 315f 6e6f 7469 6679 280a 2020  st_d1_notify(.  
+00024a10: 2020 2020 2020 2020 2020 6365 6c6c 5f63            cell_c
+00024a20: 6f6e 7465 6e74 2c0a 2020 2020 2020 2020  ontent,.        
+00024a30: 2020 2020 6e6f 7469 6669 6361 7469 6f6e      notification
+00024a40: 732c 0a20 2020 2020 2020 2020 2020 2022  s,.            "
+00024a50: 222c 0a20 2020 2020 2020 2020 2020 2063  ",.            c
+00024a60: 6c69 656e 742c 0a20 2020 2020 2020 2020  lient,.         
+00024a70: 2020 2073 7570 6572 7573 6572 5f74 6f6b     superuser_tok
+00024a80: 656e 5f68 6561 6465 7273 2c0a 2020 2020  en_headers,.    
+00024a90: 2020 2020 2020 2020 6d6f 636b 6572 2c0a          mocker,.
+00024aa0: 2020 2020 2020 2020 290a 0a20 2020 2040          )..    @
+00024ab0: 7079 7465 7374 2e6d 6172 6b2e 6173 796e  pytest.mark.asyn
+00024ac0: 6369 6f0a 2020 2020 6173 796e 6320 6465  cio.    async de
+00024ad0: 6620 7465 7374 5f64 315f 6e6f 7469 6679  f test_d1_notify
+00024ae0: 5f69 6e63 6f6d 706c 6574 6528 0a20 2020  _incomplete(.   
+00024af0: 2020 2020 2073 656c 662c 0a20 2020 2020       self,.     
+00024b00: 2020 2063 6c69 656e 743a 2054 6573 7443     client: TestC
+00024b10: 6c69 656e 742c 0a20 2020 2020 2020 2073  lient,.        s
+00024b20: 7570 6572 7573 6572 5f74 6f6b 656e 5f68  uperuser_token_h
+00024b30: 6561 6465 7273 3a20 4469 6374 5b73 7472  eaders: Dict[str
+00024b40: 2c20 7374 725d 2c0a 2020 2020 2020 2020  , str],.        
+00024b50: 6d6f 636b 6572 3a20 4d6f 636b 4669 7874  mocker: MockFixt
+00024b60: 7572 652c 0a20 2020 2029 3a0a 2020 2020  ure,.    ):.    
+00024b70: 2020 2020 6365 6c6c 5f63 6f6e 7465 6e74      cell_content
+00024b80: 203d 2028 0a20 2020 2020 2020 2020 2020   = (.           
+00024b90: 2027 7072 696e 7428 2272 7568 5f5f 5f63   'print("ruh___c
+00024ba0: 616c 6c69 7374 6f5f 6431 5f63 6f6d 6d61  allisto_d1_comma
+00024bb0: 6e64 5f5f 5f7b 270a 2020 2020 2020 2020  nd___{'.        
+00024bc0: 2020 2020 275c 5c22 636f 6d6d 616e 645f      '\\"command_
+00024bd0: 7479 7065 5c5c 223a 5c5c 226e 6f74 6966  type\\":\\"notif
+00024be0: 795c 5c22 2c27 0a20 2020 2020 2020 2020  y\\",'.         
+00024bf0: 2020 2027 5c5c 2274 6974 6c65 5c5c 223a     '\\"title\\":
+00024c00: 5c5c 2261 7469 746c 655c 5c22 2c27 0a20  \\"atitle\\",'. 
+00024c10: 2020 2020 2020 2020 2020 2027 5c5c 226d             '\\"m
+00024c20: 6573 7361 6765 5c5c 223a 5c5c 2274 6573  essage\\":\\"tes
+00024c30: 7436 6534 5c5c 227d 5f5f 5f63 616c 6c69  t6e4\\"}___calli
+00024c40: 7374 6f5f 6431 5f63 6f6d 6d61 6e64 5f5f  sto_d1_command__
+00024c50: 5f6d 6f72 6927 0a20 2020 2020 2020 2020  _mori'.         
+00024c60: 2020 2027 5f5f 5f63 616c 6c69 7374 6f5f     '___callisto_
+00024c70: 6431 5f63 6f6d 6d61 6e64 5f5f 5f6a 6a75  d1_command___jju
+00024c80: 6f22 2c20 270a 2020 2020 2020 2020 2020  o", '.          
+00024c90: 2020 2720 656e 643d 2222 2927 0a20 2020    ' end="")'.   
+00024ca0: 2020 2020 2029 0a20 2020 2020 2020 206e       ).        n
+00024cb0: 6f74 6966 6963 6174 696f 6e73 203d 205b  otifications = [
+00024cc0: 0a20 2020 2020 2020 2020 2020 2027 7b22  .            '{"
+00024cd0: 636f 6d6d 616e 645f 7479 7065 223a 226e  command_type":"n
+00024ce0: 6f74 6966 7922 2c27 0a20 2020 2020 2020  otify",'.       
+00024cf0: 2020 2020 2027 2274 6974 6c65 223a 2261       '"title":"a
+00024d00: 7469 746c 6522 2c27 0a20 2020 2020 2020  title",'.       
+00024d10: 2020 2020 2027 226d 6573 7361 6765 223a       '"message":
+00024d20: 2274 6573 7436 6534 227d 270a 2020 2020  "test6e4"}'.    
+00024d30: 2020 2020 5d0a 2020 2020 2020 2020 6177      ].        aw
+00024d40: 6169 7420 7365 6c66 2e64 6f5f 7465 7374  ait self.do_test
+00024d50: 5f64 315f 6e6f 7469 6679 280a 2020 2020  _d1_notify(.    
+00024d60: 2020 2020 2020 2020 6365 6c6c 5f63 6f6e          cell_con
+00024d70: 7465 6e74 2c0a 2020 2020 2020 2020 2020  tent,.          
+00024d80: 2020 6e6f 7469 6669 6361 7469 6f6e 732c    notifications,
+00024d90: 0a20 2020 2020 2020 2020 2020 2022 7275  .            "ru
+00024da0: 686d 6f72 696a 6a75 6f22 2c0a 2020 2020  hmorijjuo",.    
+00024db0: 2020 2020 2020 2020 636c 6965 6e74 2c0a          client,.
+00024dc0: 2020 2020 2020 2020 2020 2020 7375 7065              supe
+00024dd0: 7275 7365 725f 746f 6b65 6e5f 6865 6164  ruser_token_head
+00024de0: 6572 732c 0a20 2020 2020 2020 2020 2020  ers,.           
+00024df0: 206d 6f63 6b65 722c 0a20 2020 2020 2020   mocker,.       
+00024e00: 2029 0a0a 2020 2020 4070 7974 6573 742e   )..    @pytest.
+00024e10: 6d61 726b 2e61 7379 6e63 696f 0a20 2020  mark.asyncio.   
+00024e20: 2061 7379 6e63 2064 6566 2074 6573 745f   async def test_
+00024e30: 6431 5f6e 6f74 6966 795f 696e 7661 6c69  d1_notify_invali
+00024e40: 645f 636f 6d6d 616e 6428 0a20 2020 2020  d_command(.     
+00024e50: 2020 2073 656c 662c 0a20 2020 2020 2020     self,.       
+00024e60: 2063 6c69 656e 743a 2054 6573 7443 6c69   client: TestCli
+00024e70: 656e 742c 0a20 2020 2020 2020 2073 7570  ent,.        sup
+00024e80: 6572 7573 6572 5f74 6f6b 656e 5f68 6561  eruser_token_hea
+00024e90: 6465 7273 3a20 4469 6374 5b73 7472 2c20  ders: Dict[str, 
+00024ea0: 7374 725d 2c0a 2020 2020 2020 2020 6d6f  str],.        mo
+00024eb0: 636b 6572 3a20 4d6f 636b 4669 7874 7572  cker: MockFixtur
+00024ec0: 652c 0a20 2020 2029 3a0a 2020 2020 2020  e,.    ):.      
+00024ed0: 2020 6365 6c6c 5f63 6f6e 7465 6e74 203d    cell_content =
+00024ee0: 2028 0a20 2020 2020 2020 2020 2020 2027   (.            '
+00024ef0: 7072 696e 7428 225f 5f5f 6361 6c6c 6973  print("___callis
+00024f00: 746f 5f64 315f 636f 6d6d 616e 645f 5f5f  to_d1_command___
+00024f10: 7b27 0a20 2020 2020 2020 2020 2020 2027  {'.            '
+00024f20: 5c5c 2263 6f6d 6d61 6e64 5f74 7970 655c  \\"command_type\
+00024f30: 5c22 3a5c 5c22 6e6f 7469 6679 5c5c 222c  \":\\"notify\\",
+00024f40: 270a 2020 2020 2020 2020 2020 2020 275c  '.            '\
+00024f50: 5c22 7469 746c 655c 5c22 3a5c 5c22 6174  \"title\\":\\"at
+00024f60: 6974 6c65 5c5c 222c 270a 2020 2020 2020  itle\\",'.      
+00024f70: 2020 2020 2020 275c 5c22 6d65 7373 6167        '\\"messag
+00024f80: 655c 5c22 3a5c 5c22 7465 7374 3665 345c  e\\":\\"test6e4\
+00024f90: 5c22 7d5f 5f5f 6361 6c6c 6973 746f 5f64  \"}___callisto_d
+00024fa0: 315f 636f 6d6d 616e 645f 5f5f 6d6f 7269  1_command___mori
+00024fb0: 270a 2020 2020 2020 2020 2020 2020 225f  '.            "_
+00024fc0: 5f5f 6361 6c6c 6973 746f 5f64 315f 636f  __callisto_d1_co
+00024fd0: 6d6d 616e 645f 5f5f 7b6a 6a75 6f7d 5f5f  mmand___{jjuo}__
+00024fe0: 5f63 616c 6c69 7374 6f5f 6431 5f63 6f6d  _callisto_d1_com
+00024ff0: 6d61 6e64 5f5f 5f22 0a20 2020 2020 2020  mand___".       
+00025000: 2020 2020 2027 7768 6579 222c 2027 0a20       'whey", '. 
+00025010: 2020 2020 2020 2020 2020 2027 2065 6e64             ' end
+00025020: 3d22 2229 270a 2020 2020 2020 2020 290a  ="")'.        ).
+00025030: 2020 2020 2020 2020 6e6f 7469 6669 6361          notifica
+00025040: 7469 6f6e 7320 3d20 5b0a 2020 2020 2020  tions = [.      
+00025050: 2020 2020 2020 277b 2263 6f6d 6d61 6e64        '{"command
+00025060: 5f74 7970 6522 3a22 6e6f 7469 6679 222c  _type":"notify",
+00025070: 270a 2020 2020 2020 2020 2020 2020 2722  '.            '"
+00025080: 7469 746c 6522 3a22 6174 6974 6c65 222c  title":"atitle",
+00025090: 270a 2020 2020 2020 2020 2020 2020 2722  '.            '"
+000250a0: 6d65 7373 6167 6522 3a22 7465 7374 3665  message":"test6e
+000250b0: 3422 7d27 2c0a 2020 2020 2020 2020 2020  4"}',.          
+000250c0: 2020 227b 6a6a 756f 7d22 2c0a 2020 2020    "{jjuo}",.    
+000250d0: 2020 2020 5d0a 2020 2020 2020 2020 6177      ].        aw
+000250e0: 6169 7420 7365 6c66 2e64 6f5f 7465 7374  ait self.do_test
+000250f0: 5f64 315f 6e6f 7469 6679 280a 2020 2020  _d1_notify(.    
+00025100: 2020 2020 2020 2020 6365 6c6c 5f63 6f6e          cell_con
+00025110: 7465 6e74 2c0a 2020 2020 2020 2020 2020  tent,.          
+00025120: 2020 6e6f 7469 6669 6361 7469 6f6e 732c    notifications,
+00025130: 0a20 2020 2020 2020 2020 2020 2022 6d6f  .            "mo
+00025140: 7269 7768 6579 222c 0a20 2020 2020 2020  riwhey",.       
+00025150: 2020 2020 2063 6c69 656e 742c 0a20 2020       client,.   
+00025160: 2020 2020 2020 2020 2073 7570 6572 7573           superus
+00025170: 6572 5f74 6f6b 656e 5f68 6561 6465 7273  er_token_headers
+00025180: 2c0a 2020 2020 2020 2020 2020 2020 6d6f  ,.            mo
+00025190: 636b 6572 2c0a 2020 2020 2020 2020 290a  cker,.        ).
+000251a0: 0a0a 4070 7974 6573 742e 6d61 726b 2e75  ..@pytest.mark.u
+000251b0: 7365 6669 7874 7572 6573 2822 636c 6561  sefixtures("clea
+000251c0: 725f 6e6f 7465 626f 6f6b 7322 2c20 2263  r_notebooks", "c
+000251d0: 6c65 6172 5f6e 6f74 6562 6f6f 6b5f 6469  lear_notebook_di
+000251e0: 7265 6374 6f72 7922 290a 636c 6173 7320  rectory").class 
+000251f0: 5465 7374 4e6f 7465 626f 6f6b 7357 6562  TestNotebooksWeb
+00025200: 536f 636b 6574 3a0a 2020 2020 6173 796e  Socket:.    asyn
+00025210: 6320 6465 6620 6765 745f 6e6f 7465 626f  c def get_notebo
+00025220: 6f6b 735f 6576 656e 7428 7365 6c66 2c20  oks_event(self, 
+00025230: 7765 6273 6f63 6b65 7429 3a0a 2020 2020  websocket):.    
+00025240: 2020 2020 666f 7220 6920 696e 2072 616e      for i in ran
+00025250: 6765 2835 293a 0a20 2020 2020 2020 2020  ge(5):.         
+00025260: 2020 2064 6174 6120 3d20 6177 6169 7420     data = await 
+00025270: 7265 6365 6976 655f 6a73 6f6e 2877 6562  receive_json(web
+00025280: 736f 636b 6574 290a 2020 2020 2020 2020  socket).        
+00025290: 2020 2020 6966 2022 6e6f 7465 626f 6f6b      if "notebook
+000252a0: 7322 2069 6e20 6461 7461 3a0a 2020 2020  s" in data:.    
+000252b0: 2020 2020 2020 2020 2020 2020 6272 6561              brea
+000252c0: 6b0a 2020 2020 2020 2020 7265 7475 726e  k.        return
+000252d0: 2064 6174 610a 0a20 2020 2040 7079 7465   data..    @pyte
+000252e0: 7374 2e6d 6172 6b2e 6173 796e 6369 6f0a  st.mark.asyncio.
+000252f0: 2020 2020 6173 796e 6320 6465 6620 7465      async def te
+00025300: 7374 5f6e 6f74 6562 6f6f 6b73 5f75 7064  st_notebooks_upd
+00025310: 6174 6573 280a 2020 2020 2020 2020 7365  ates(.        se
+00025320: 6c66 2c20 636c 6965 6e74 3a20 5465 7374  lf, client: Test
+00025330: 436c 6965 6e74 2c20 7375 7065 7275 7365  Client, superuse
+00025340: 725f 746f 6b65 6e5f 6865 6164 6572 733a  r_token_headers:
+00025350: 2044 6963 745b 7374 722c 2073 7472 5d0a   Dict[str, str].
+00025360: 2020 2020 293a 0a0a 2020 2020 2020 2020      ):..        
+00025370: 6173 796e 6320 7769 7468 2063 6c69 656e  async with clien
+00025380: 742e 7765 6273 6f63 6b65 745f 636f 6e6e  t.websocket_conn
+00025390: 6563 7428 0a20 2020 2020 2020 2020 2020  ect(.           
+000253a0: 2066 222f 7365 7276 6572 2f77 7322 2c20   f"/server/ws", 
+000253b0: 6865 6164 6572 733d 7375 7065 7275 7365  headers=superuse
+000253c0: 725f 746f 6b65 6e5f 6865 6164 6572 730a  r_token_headers.
+000253d0: 2020 2020 2020 2020 2920 6173 2077 6562          ) as web
+000253e0: 736f 636b 6574 3a0a 0a20 2020 2020 2020  socket:..       
+000253f0: 2020 2020 2061 7761 6974 2061 7379 6e63       await async
+00025400: 696f 2e73 6c65 6570 2857 4542 534f 434b  io.sleep(WEBSOCK
+00025410: 4554 5f53 4c45 4550 5f54 494d 4529 0a0a  ET_SLEEP_TIME)..
+00025420: 2020 2020 2020 2020 2020 2020 7575 6964              uuid
+00025430: 203d 2061 7761 6974 2075 706c 6f61 645f   = await upload_
+00025440: 6e6f 7465 626f 6f6b 2863 6c69 656e 742c  notebook(client,
+00025450: 2073 7570 6572 7573 6572 5f74 6f6b 656e   superuser_token
+00025460: 5f68 6561 6465 7273 290a 0a20 2020 2020  _headers)..     
+00025470: 2020 2020 2020 2064 6174 6120 3d20 6177         data = aw
+00025480: 6169 7420 7761 6974 5f66 6f72 5f65 7665  ait wait_for_eve
+00025490: 6e74 2877 6562 736f 636b 6574 2c20 226e  nt(websocket, "n
+000254a0: 6f74 6562 6f6f 6b73 222c 2074 7269 6573  otebooks", tries
+000254b0: 3d31 3030 290a 2020 2020 2020 2020 2020  =100).          
+000254c0: 2020 6173 7365 7274 206c 656e 2864 6174    assert len(dat
+000254d0: 615b 226e 6f74 6562 6f6f 6b73 225d 2920  a["notebooks"]) 
+000254e0: 3d3d 2031 0a20 2020 2020 2020 2020 2020  == 1.           
+000254f0: 2061 7373 6572 7420 6461 7461 5b22 6e6f   assert data["no
+00025500: 7465 626f 6f6b 7322 5d5b 305d 5b22 7575  tebooks"][0]["uu
+00025510: 6964 225d 203d 3d20 7575 6964 0a20 2020  id"] == uuid.   
+00025520: 2020 2020 2020 2020 2061 7373 6572 7420           assert 
+00025530: 6461 7461 5b22 6e6f 7465 626f 6f6b 7322  data["notebooks"
+00025540: 5d5b 305d 5b22 6e61 6d65 225d 203d 3d20  ][0]["name"] == 
+00025550: 2273 696d 706c 6522 0a0a 2020 2020 2020  "simple"..      
+00025560: 2020 2020 2020 7575 6964 3220 3d20 6177        uuid2 = aw
+00025570: 6169 7420 7570 6c6f 6164 5f6e 6f74 6562  ait upload_noteb
+00025580: 6f6f 6b28 0a20 2020 2020 2020 2020 2020  ook(.           
+00025590: 2020 2020 2063 6c69 656e 742c 0a20 2020       client,.   
+000255a0: 2020 2020 2020 2020 2020 2020 2073 7570               sup
+000255b0: 6572 7573 6572 5f74 6f6b 656e 5f68 6561  eruser_token_hea
+000255c0: 6465 7273 2c0a 2020 2020 2020 2020 2020  ders,.          
+000255d0: 2020 2020 2020 6669 6c65 6e61 6d65 3d22        filename="
+000255e0: 7374 6174 6566 756c 5f73 696d 706c 652e  stateful_simple.
+000255f0: 6970 796e 6222 2c0a 2020 2020 2020 2020  ipynb",.        
+00025600: 2020 2020 290a 2020 2020 2020 2020 2020      ).          
+00025610: 2020 6461 7461 203d 2061 7761 6974 2077    data = await w
+00025620: 6169 745f 666f 725f 6576 656e 7428 7765  ait_for_event(we
+00025630: 6273 6f63 6b65 742c 2022 6e6f 7465 626f  bsocket, "notebo
+00025640: 6f6b 7322 2c20 7472 6965 733d 3130 3029  oks", tries=100)
+00025650: 0a20 2020 2020 2020 2020 2020 2061 7373  .            ass
+00025660: 6572 7420 6c65 6e28 6461 7461 5b22 6e6f  ert len(data["no
+00025670: 7465 626f 6f6b 7322 5d29 203d 3d20 320a  tebooks"]) == 2.
+00025680: 2020 2020 2020 2020 2020 2020 6173 7365              asse
+00025690: 7274 2064 6174 615b 226e 6f74 6562 6f6f  rt data["noteboo
+000256a0: 6b73 225d 5b30 5d5b 2275 7569 6422 5d20  ks"][0]["uuid"] 
+000256b0: 3d3d 2075 7569 640a 2020 2020 2020 2020  == uuid.        
+000256c0: 2020 2020 6173 7365 7274 2064 6174 615b      assert data[
+000256d0: 226e 6f74 6562 6f6f 6b73 225d 5b30 5d5b  "notebooks"][0][
+000256e0: 226e 616d 6522 5d20 3d3d 2022 7369 6d70  "name"] == "simp
+000256f0: 6c65 220a 2020 2020 2020 2020 2020 2020  le".            
+00025700: 6173 7365 7274 2064 6174 615b 226e 6f74  assert data["not
+00025710: 6562 6f6f 6b73 225d 5b31 5d5b 2275 7569  ebooks"][1]["uui
+00025720: 6422 5d20 3d3d 2075 7569 6432 0a20 2020  d"] == uuid2.   
+00025730: 2020 2020 2020 2020 2061 7373 6572 7420           assert 
+00025740: 6461 7461 5b22 6e6f 7465 626f 6f6b 7322  data["notebooks"
+00025750: 5d5b 315d 5b22 6e61 6d65 225d 203d 3d20  ][1]["name"] == 
+00025760: 2273 7461 7465 6675 6c5f 7369 6d70 6c65  "stateful_simple
+00025770: 220a 0a20 2020 2020 2020 2020 2020 2072  "..            r
+00025780: 6573 706f 6e73 6520 3d20 6177 6169 7420  esponse = await 
+00025790: 636c 6965 6e74 2e64 656c 6574 6528 0a20  client.delete(. 
+000257a0: 2020 2020 2020 2020 2020 2020 2020 2066                 f
+000257b0: 222f 6e6f 7465 626f 6f6b 732f 7b75 7569  "/notebooks/{uui
+000257c0: 647d 222c 2068 6561 6465 7273 3d73 7570  d}", headers=sup
+000257d0: 6572 7573 6572 5f74 6f6b 656e 5f68 6561  eruser_token_hea
+000257e0: 6465 7273 0a20 2020 2020 2020 2020 2020  ders.           
+000257f0: 2029 0a20 2020 2020 2020 2020 2020 2061   ).            a
+00025800: 7373 6572 7420 7265 7370 6f6e 7365 2e73  ssert response.s
+00025810: 7461 7475 735f 636f 6465 203d 3d20 3230  tatus_code == 20
+00025820: 340a 2020 2020 2020 2020 2020 2020 6461  4.            da
+00025830: 7461 203d 2061 7761 6974 2077 6169 745f  ta = await wait_
+00025840: 666f 725f 6576 656e 7428 7765 6273 6f63  for_event(websoc
+00025850: 6b65 742c 2022 6e6f 7465 626f 6f6b 7322  ket, "notebooks"
+00025860: 2c20 7472 6965 733d 3130 3029 0a20 2020  , tries=100).   
+00025870: 2020 2020 2020 2020 2061 7373 6572 7420           assert 
+00025880: 6c65 6e28 6461 7461 5b22 6e6f 7465 626f  len(data["notebo
+00025890: 6f6b 7322 5d29 203d 3d20 310a 2020 2020  oks"]) == 1.    
+000258a0: 2020 2020 2020 2020 6173 7365 7274 2064          assert d
+000258b0: 6174 615b 226e 6f74 6562 6f6f 6b73 225d  ata["notebooks"]
+000258c0: 5b30 5d5b 2275 7569 6422 5d20 3d3d 2075  [0]["uuid"] == u
+000258d0: 7569 6432 0a20 2020 2020 2020 2020 2020  uid2.           
+000258e0: 2061 7373 6572 7420 6461 7461 5b22 6e6f   assert data["no
+000258f0: 7465 626f 6f6b 7322 5d5b 305d 5b22 6e61  tebooks"][0]["na
+00025900: 6d65 225d 203d 3d20 2273 7461 7465 6675  me"] == "statefu
+00025910: 6c5f 7369 6d70 6c65 220a 0a20 2020 2020  l_simple"..     
+00025920: 2020 2020 2020 2072 6573 706f 6e73 6520         response 
+00025930: 3d20 6177 6169 7420 636c 6965 6e74 2e64  = await client.d
+00025940: 656c 6574 6528 0a20 2020 2020 2020 2020  elete(.         
+00025950: 2020 2020 2020 2022 2f6e 6f74 6562 6f6f         "/noteboo
+00025960: 6b73 222c 2068 6561 6465 7273 3d73 7570  ks", headers=sup
+00025970: 6572 7573 6572 5f74 6f6b 656e 5f68 6561  eruser_token_hea
+00025980: 6465 7273 0a20 2020 2020 2020 2020 2020  ders.           
+00025990: 2029 0a20 2020 2020 2020 2020 2020 2061   ).            a
+000259a0: 7373 6572 7420 7265 7370 6f6e 7365 2e73  ssert response.s
+000259b0: 7461 7475 735f 636f 6465 203d 3d20 3230  tatus_code == 20
+000259c0: 340a 2020 2020 2020 2020 2020 2020 6461  4.            da
+000259d0: 7461 203d 2061 7761 6974 2077 6169 745f  ta = await wait_
+000259e0: 666f 725f 6576 656e 7428 7765 6273 6f63  for_event(websoc
+000259f0: 6b65 742c 2022 6e6f 7465 626f 6f6b 7322  ket, "notebooks"
+00025a00: 2c20 7472 6965 733d 3130 3029 0a20 2020  , tries=100).   
+00025a10: 2020 2020 2020 2020 2061 7373 6572 7420           assert 
+00025a20: 6c65 6e28 6461 7461 5b22 6e6f 7465 626f  len(data["notebo
+00025a30: 6f6b 7322 5d29 203d 3d20 300a            oks"]) == 0.
```

### Comparing `callisto-jupyter-d1-0.0.7/jupyter_d1/tests/test_rclone.py` & `callisto-jupyter-d1-0.0.9/jupyter_d1/tests/test_rclone.py`

 * *Files 19% similar despite different names*

```diff
@@ -1,48 +1,46 @@
 from datetime import datetime, timedelta
 from typing import Dict
 
 import pytest  # type: ignore
-from async_asgi_testclient import (
-    TestClient as WebSocketTestClient,  # type: ignore
-)
-from fastapi.testclient import TestClient
-import pytest_asyncio
 from pytest_mock import MockFixture  # type: ignore
 
+from .D1TestClient import TestClient
 from .utils import wait_for_event
 
+pytestmark = pytest.mark.asyncio
 
-def test_rclone(
+
+async def test_rclone(
     client: TestClient,
     superuser_token_headers: Dict[str, str],
     mocker: MockFixture,
 ):
     mock_requests = mocker.patch("jupyter_d1.routers.rclone.requests")
     mock_requests.post().json.return_value = {"pldefe": "fj39499"}
-    response = client.post(
+    response = await client.post(
         "/rclone/config/dump", headers=superuser_token_headers
     )
     assert response.status_code == 200
     # print(response.json())
     assert response.json() == {"pldefe": "fj39499"}
     assert (
         mock_requests.post.call_args[0][0]
         == "http://127.0.0.1:5572/config/dump"
     )
 
 
-def test_rclone_query_params(
+async def test_rclone_query_params(
     client: TestClient,
     superuser_token_headers: Dict[str, str],
     mocker: MockFixture,
 ):
     mock_requests = mocker.patch("jupyter_d1.routers.rclone.requests")
     mock_requests.post().json.return_value = {"gg": "754d"}
-    response = client.post(
+    response = await client.post(
         "/rclone/config/get",
         headers=superuser_token_headers,
         params={"name": "gdrive"},
     )
     assert response.status_code == 200
     # print(response.json())
     assert response.json() == {"gg": "754d"}
@@ -51,23 +49,23 @@
         == "http://127.0.0.1:5572/config/get"
     )
     assert dict(mock_requests.post.call_args[1]["params"]) == {
         "name": "gdrive"
     }
 
 
-def test_rclone_post_data(
+async def test_rclone_post_data(
     client: TestClient,
     superuser_token_headers: Dict[str, str],
     mocker: MockFixture,
 ):
     mock_requests = mocker.patch("jupyter_d1.routers.rclone.requests")
     mock_requests.post().json.return_value = {"polnd": "logkj"}
     superuser_token_headers["Content-Type"] = "application/json"
-    response = client.post(
+    response = await client.post(
         "/rclone/options/set",
         headers=superuser_token_headers,
         data='{"vfs": {"CacheMaxSize": 100}}',
     )
     assert response.status_code == 200
     # print(response.json())
     assert response.json() == {"polnd": "logkj"}
@@ -79,29 +77,16 @@
     )
     assert (
         mock_requests.post.call_args[1]["data"]
         == b'{"vfs": {"CacheMaxSize": 100}}'
     )
 
 
-@pytest_asyncio.fixture()
-async def superuser_token_headers(
-    websocket_client: WebSocketTestClient,
-) -> Dict[str, str]:
-    r = await websocket_client.get(
-        "/login/access-token", headers={"Authorization": "test9token_4"}
-    )
-    token = r.json()["token"]["access_token"]
-    headers = {"Authorization": f"Bearer {token}"}
-    return headers
-
-
-@pytest.mark.asyncio
 async def test_rclone_websocket(
-    websocket_client: WebSocketTestClient,
+    websocket_client: TestClient,
     superuser_token_headers: Dict[str, str],
     mocker: MockFixture,
 ):
     mock_requests = mocker.patch("jupyter_d1.routers.rclone.requests")
     mock_requests.post().json.return_value = {"polnd": "logkj"}
 
     async with websocket_client.websocket_connect(
```

### Comparing `callisto-jupyter-d1-0.0.7/jupyter_d1/tests/test_stats.py` & `callisto-jupyter-d1-0.0.9/jupyter_d1/tests/test_stats.py`

 * *Files 4% similar despite different names*

```diff
@@ -1,45 +1,27 @@
 import asyncio
 from datetime import datetime
-from typing import AsyncGenerator, Dict
+from typing import Dict
 
 import pytest  # type: ignore
-from async_asgi_testclient import TestClient
-import pytest_asyncio  # type: ignore
 from pytest_mock import MockFixture  # type: ignore
 
-from jupyter_d1 import app
 from jupyter_d1.models.server_stats import (
     CPUStats,
     DiskStats,
     GPUStats,
     MemoryStats,
     ServerStats,
 )
-from jupyter_d1.settings import settings
+import jupyter_d1.version as version
 
+from .D1TestClient import TestClient
 from .utils import wait_for_event
 
 
-@pytest_asyncio.fixture()
-async def client() -> AsyncGenerator:
-    async with TestClient(app) as c:
-        yield c
-
-
-@pytest_asyncio.fixture()
-async def superuser_token_headers(client: TestClient) -> Dict[str, str]:
-    r = await client.get(
-        "/login/access-token", headers={"Authorization": "test9token_4"}
-    )
-    token = r.json()["token"]["access_token"]
-    headers = {"Authorization": f"Bearer {token}"}
-    return headers
-
-
 class TestStats:
     @pytest.mark.asyncio
     async def test_get_stats(
         self,
         client: TestClient,
         superuser_token_headers: Dict[str, str],
     ):
@@ -161,26 +143,30 @@
         assert environment["process"]["user"] is not None
         assert environment["process"]["pid"] is not None
         assert environment["process"]["environ"] is not None
         assert environment["config"] is not None
         if environment.get("conda", None) is not None:
             assert environment["conda"]["version"] is not None
         assert environment["cores"] is not None
-        assert environment["version"] == settings.VERSION
+        assert environment["version"]["major"] == version.major
+        assert environment["version"]["minor"] == version.minor
+        assert environment["version"]["micro"] == version.micro
 
     @pytest.mark.asyncio
     async def test_get_version(
         self,
         client: TestClient,
         superuser_token_headers: Dict[str, str],
     ):
         response = await client.get(
             f"/server/version", headers=superuser_token_headers
         )
-        assert response.json()["version"] == settings.VERSION
+        assert response.json()["version"]["major"] == version.major
+        assert response.json()["version"]["minor"] == version.minor
+        assert response.json()["version"]["micro"] == version.micro
 
 
 class TestStatsWebSocket:
     @pytest.mark.asyncio
     async def test_stats_websocket(
         self, client: TestClient, superuser_token_headers: Dict[str, str]
     ):
@@ -209,12 +195,12 @@
 
         async with client.websocket_connect(
             f"/server/ws", headers=superuser_token_headers
         ) as websocket:
 
             from jupyter_d1.main import logger
 
-            logger.debug("hi hello jjkolq")
+            logger.warning("hi hello jjkolq")
 
             log = await wait_for_event(websocket, "log")
             assert "hi hello jjkolq" in log["log"]
-            assert "DEBUG" in log["log"]
+            assert "WARNING" in log["log"]
```

### Comparing `callisto-jupyter-d1-0.0.7/jupyter_d1/tests/test_undo.py` & `callisto-jupyter-d1-0.0.9/jupyter_d1/tests/test_undo.py`

 * *Files 12% similar despite different names*

```diff
@@ -1,194 +1,197 @@
 import json
 from typing import Dict
 
 import pytest  # type: ignore
-from fastapi.testclient import TestClient
+from .D1TestClient import TestClient
 
 from jupyter_d1.settings import settings
 
 from .test_notebooks import upload_notebook
 
+pytestmark = pytest.mark.asyncio
+
 
 @pytest.mark.usefixtures("clear_notebooks", "clear_notebook_directory")
 class TestUndo:
     def get_uuids(self, cells):
         def uuid(cell):
             return cell["metadata"]["jupyter_d1"]["uuid"]
 
         return list(map(uuid, cells))
 
-    def test_undo_delete(
+    async def test_undo_delete(
         self, client: TestClient, superuser_token_headers: Dict[str, str]
     ):
-        uuid = upload_notebook(client, superuser_token_headers)
+        uuid = await upload_notebook(client, superuser_token_headers)
 
-        response = client.get(
+        response = await client.get(
             f"/notebooks/{uuid}/cells", headers=superuser_token_headers
         )
+        print(f"response: {response.text}")
         assert response.status_code == 200
         cells = response.json()["cells"]
 
         # Start with 4 cells
         assert len(cells) == 4
         cell = cells[2]
         cell_uuid = cell["metadata"]["jupyter_d1"]["uuid"]
 
         # Delete a cell
-        response = client.delete(
+        response = await client.delete(
             f"/notebooks/{uuid}/cells/{cell_uuid}",
             headers=superuser_token_headers,
         )
         assert response.status_code == 204
 
         # Assert that change was written to disk
         with open(f"{settings.ROOT_DIR}/simple.ipynb") as f:
             file_nb = json.loads(f.read())
         assert len(file_nb["cells"]) == 3
 
         # Now 3 cells
-        response = client.get(
+        response = await client.get(
             f"/notebooks/{uuid}/cells", headers=superuser_token_headers
         )
         assert response.status_code == 200
         cells = response.json()["cells"]
         assert len(cells) == 3
 
         # Undo deletion
-        response = client.get(
+        response = await client.get(
             f"/notebooks/{uuid}/undo", headers=superuser_token_headers
         )
         assert response.status_code == 204
 
         # Assert that change was written to disk
         with open(f"{settings.ROOT_DIR}/simple.ipynb") as f:
             file_nb = json.loads(f.read())
         assert len(file_nb["cells"]) == 4
 
         # Back to original, 4 cells
-        response = client.get(
+        response = await client.get(
             f"/notebooks/{uuid}/cells", headers=superuser_token_headers
         )
         assert response.status_code == 200
         cells = response.json()["cells"]
         assert len(cells) == 4
 
         # Redo the deletion
-        response = client.get(
+        response = await client.get(
             f"/notebooks/{uuid}/redo", headers=superuser_token_headers
         )
         assert response.status_code == 204
 
         # Assert that change was written to disk
         with open(f"{settings.ROOT_DIR}/simple.ipynb") as f:
             file_nb = json.loads(f.read())
         assert len(file_nb["cells"]) == 3
 
         # Back to 3 cells
-        response = client.get(
+        response = await client.get(
             f"/notebooks/{uuid}/cells", headers=superuser_token_headers
         )
         assert response.status_code == 200
         cells = response.json()["cells"]
         assert len(cells) == 3
 
-    def test_undo_create(
+    async def test_undo_create(
         self, client: TestClient, superuser_token_headers: Dict[str, str]
     ):
-        uuid = upload_notebook(client, superuser_token_headers)
+        uuid = await upload_notebook(client, superuser_token_headers)
 
-        response = client.get(
+        response = await client.get(
             f"/notebooks/{uuid}/cells", headers=superuser_token_headers
         )
         assert response.status_code == 200
         cells = response.json()["cells"]
 
         # Start with 4 cells
         assert len(cells) == 4
         cell = cells[2]
         cell_uuid = cell["metadata"]["jupyter_d1"]["uuid"]
 
         # Add a cell
         src = "__**Hello Callisto**__"
         params = {"before": cell_uuid, "cell_type": "markdown", "source": src}
-        response = client.post(
+        response = await client.post(
             f"/notebooks/{uuid}/cells",
             json=params,
             headers=superuser_token_headers,
         )
         assert response.status_code == 201
         new_cell = response.json()["cell"]
         assert new_cell["cell_type"] == "markdown"
         assert new_cell["source"] == "__**Hello Callisto**__"
 
         # Now 5 cells
-        response = client.get(
+        response = await client.get(
             f"/notebooks/{uuid}/cells", headers=superuser_token_headers
         )
         assert response.status_code == 200
         cells = response.json()["cells"]
         assert len(cells) == 5
 
         # Assert that change was written to disk
         with open(f"{settings.ROOT_DIR}/simple.ipynb") as f:
             file_nb = json.loads(f.read())
         assert len(file_nb["cells"]) == 5
 
         # Undo creation
-        response = client.get(
+        response = await client.get(
             f"/notebooks/{uuid}/undo", headers=superuser_token_headers
         )
         assert response.status_code == 204
 
         # Assert that change was written to disk
         with open(f"{settings.ROOT_DIR}/simple.ipynb") as f:
             file_nb = json.loads(f.read())
         assert len(file_nb["cells"]) == 4
 
         # Back to original, 4 cells
-        response = client.get(
+        response = await client.get(
             f"/notebooks/{uuid}/cells", headers=superuser_token_headers
         )
         assert response.status_code == 200
         cells = response.json()["cells"]
         assert len(cells) == 4
 
         # Redo the addition
-        response = client.get(
+        response = await client.get(
             f"/notebooks/{uuid}/redo", headers=superuser_token_headers
         )
         assert response.status_code == 204
 
         # Assert that change was written to disk
         with open(f"{settings.ROOT_DIR}/simple.ipynb") as f:
             file_nb = json.loads(f.read())
         assert len(file_nb["cells"]) == 5
 
         # Back to 5 cells
-        response = client.get(
+        response = await client.get(
             f"/notebooks/{uuid}/cells", headers=superuser_token_headers
         )
         assert response.status_code == 200
         cells = response.json()["cells"]
         assert len(cells) == 5
 
         # check the contents of the new cell are correct
         cell = cells[2]
         assert cell["cell_type"] == "markdown"
         assert cell["source"] == "__**Hello Callisto**__"
         # Same for file on disk
         assert file_nb["cells"][2]["cell_type"] == "markdown"
         assert file_nb["cells"][2]["source"] == ["__**Hello Callisto**__"]
 
-    def test_undo_update(
+    async def test_undo_update(
         self, client: TestClient, superuser_token_headers: Dict[str, str]
     ):
-        uuid = upload_notebook(client, superuser_token_headers)
+        uuid = await upload_notebook(client, superuser_token_headers)
 
-        response = client.get(
+        response = await client.get(
             f"/notebooks/{uuid}/cells", headers=superuser_token_headers
         )
         assert response.status_code == 200
         cells = response.json()["cells"]
 
         # Start with 4 cells
         assert len(cells) == 4
@@ -196,15 +199,15 @@
         cell_uuid = cell["metadata"]["jupyter_d1"]["uuid"]
         assert cell["cell_type"] == "code"
         assert cell["source"] == "2+5"
 
         # Update a cell
         src = "__**Hello Callisto**__"
         params = {"cell_type": "markdown", "source": src}
-        response = client.patch(
+        response = await client.patch(
             f"/notebooks/{uuid}/cells/{cell_uuid}",
             json=params,
             headers=superuser_token_headers,
         )
         assert response.status_code == 200
         cell = response.json()["cell"]
         assert cell["cell_type"] == "markdown"
@@ -213,63 +216,63 @@
         # Assert that change was written to disk
         with open(f"{settings.ROOT_DIR}/simple.ipynb") as f:
             file_nb = json.loads(f.read())
         assert file_nb["cells"][2]["source"] == [src]
         assert file_nb["cells"][2]["cell_type"] == "markdown"
 
         # Undo update
-        response = client.get(
+        response = await client.get(
             f"/notebooks/{uuid}/undo", headers=superuser_token_headers
         )
         assert response.status_code == 204
 
         # Assert that change was written to disk
         with open(f"{settings.ROOT_DIR}/simple.ipynb") as f:
             file_nb = json.loads(f.read())
         assert file_nb["cells"][2]["source"] == ["2+5"]
         assert file_nb["cells"][2]["cell_type"] == "code"
 
         # Back to original content
-        response = client.get(
+        response = await client.get(
             f"/notebooks/{uuid}/cells/{cell_uuid}",
             headers=superuser_token_headers,
         )
         cell = response.json()["cell"]
         assert response.status_code == 200
         assert cell["cell_type"] == "code"
         assert cell["source"] == "2+5"
 
         # Redo update
-        response = client.get(
+        response = await client.get(
             f"/notebooks/{uuid}/redo", headers=superuser_token_headers
         )
         assert response.status_code == 204
 
         # Assert that change was written to disk
         with open(f"{settings.ROOT_DIR}/simple.ipynb") as f:
             file_nb = json.loads(f.read())
         assert file_nb["cells"][2]["source"] == [src]
         assert file_nb["cells"][2]["cell_type"] == "markdown"
 
         # Now updated content
-        response = client.get(
+        response = await client.get(
             f"/notebooks/{uuid}/cells/{cell_uuid}",
             headers=superuser_token_headers,
         )
         cell = response.json()["cell"]
         assert response.status_code == 200
         assert cell["cell_type"] == "markdown"
         assert cell["source"] == src
 
-    def test_undo_move(
+    async def test_undo_move(
         self, client: TestClient, superuser_token_headers: Dict[str, str]
     ):
-        uuid = upload_notebook(client, superuser_token_headers)
+        uuid = await upload_notebook(client, superuser_token_headers)
 
-        response = client.get(
+        response = await client.get(
             f"/notebooks/{uuid}/cells", headers=superuser_token_headers
         )
         assert response.status_code == 200
         cells = response.json()["cells"]
 
         uuids = self.get_uuids(cells)
         assert len(uuids) == 4
@@ -277,15 +280,15 @@
         uuid_a = uuids[0]
         uuid_b = uuids[1]
         uuid_c = uuids[2]
         uuid_d = uuids[3]
 
         # 'move' with no query param should move uuid_b
         # to the end of the list
-        response = client.get(
+        response = await client.get(
             f"/notebooks/{uuid}/cells/{uuid_b}/move",
             headers=superuser_token_headers,
         )
         assert response.status_code == 204
 
         # Assert that change was written to disk
         with open(f"{settings.ROOT_DIR}/simple.ipynb") as f:
@@ -293,22 +296,22 @@
         assert self.get_uuids(file_nb["cells"]) == [
             uuid_a,
             uuid_c,
             uuid_d,
             uuid_b,
         ]
 
-        response = client.get(
+        response = await client.get(
             f"/notebooks/{uuid}/cells", headers=superuser_token_headers
         )
         uuids = self.get_uuids(response.json()["cells"])
         assert uuids == [uuid_a, uuid_c, uuid_d, uuid_b]
 
         # Undo move
-        response = client.get(
+        response = await client.get(
             f"/notebooks/{uuid}/undo", headers=superuser_token_headers
         )
         assert response.status_code == 204
 
         # Assert that change was written to disk
         with open(f"{settings.ROOT_DIR}/simple.ipynb") as f:
             file_nb = json.loads(f.read())
@@ -316,22 +319,22 @@
             uuid_a,
             uuid_b,
             uuid_c,
             uuid_d,
         ]
 
         # Back to original order
-        response = client.get(
+        response = await client.get(
             f"/notebooks/{uuid}/cells", headers=superuser_token_headers
         )
         uuids = self.get_uuids(response.json()["cells"])
         assert uuids == [uuid_a, uuid_b, uuid_c, uuid_d]
 
         # Redo the move
-        response = client.get(
+        response = await client.get(
             f"/notebooks/{uuid}/redo", headers=superuser_token_headers
         )
         assert response.status_code == 204
 
         # Assert that change was written to disk
         with open(f"{settings.ROOT_DIR}/simple.ipynb") as f:
             file_nb = json.loads(f.read())
@@ -339,55 +342,55 @@
             uuid_a,
             uuid_c,
             uuid_d,
             uuid_b,
         ]
 
         # Back to altered order
-        response = client.get(
+        response = await client.get(
             f"/notebooks/{uuid}/cells", headers=superuser_token_headers
         )
         uuids = self.get_uuids(response.json()["cells"])
         assert uuids == [uuid_a, uuid_c, uuid_d, uuid_b]
 
 
 @pytest.mark.usefixtures("clear_notebooks", "clear_notebook_directory")
 class TestUndoPermissions:
     def get_uuids(self, cells):
         def uuid(cell):
             return cell["metadata"]["jupyter_d1"]["uuid"]
 
         return list(map(uuid, cells))
 
-    def test_undo_permission(
+    async def test_undo_permission(
         self,
         client: TestClient,
         readonly_token_headers: Dict[str, str],
         superuser_token_headers: Dict[str, str],
     ):
-        uuid = upload_notebook(client, superuser_token_headers)
+        uuid = await upload_notebook(client, superuser_token_headers)
 
-        response = client.get(
+        response = await client.get(
             f"/notebooks/{uuid}/undo", headers=readonly_token_headers
         )
         assert response.status_code == 403
-        response = client.get(
+        response = await client.get(
             f"/notebooks/{uuid}/undo", headers=superuser_token_headers
         )
         assert response.status_code == 204
 
-    def test_redo_permission(
+    async def test_redo_permission(
         self,
         client: TestClient,
         readonly_token_headers: Dict[str, str],
         superuser_token_headers: Dict[str, str],
     ):
-        uuid = upload_notebook(client, superuser_token_headers)
+        uuid = await upload_notebook(client, superuser_token_headers)
 
-        response = client.get(
+        response = await client.get(
             f"/notebooks/{uuid}/redo", headers=readonly_token_headers
         )
         assert response.status_code == 403
-        response = client.get(
+        response = await client.get(
             f"/notebooks/{uuid}/redo", headers=superuser_token_headers
         )
         assert response.status_code == 204
```

### Comparing `callisto-jupyter-d1-0.0.7/jupyter_d1/tests/test_undo_manager.py` & `callisto-jupyter-d1-0.0.9/jupyter_d1/tests/test_undo_manager.py`

 * *Files identical despite different names*

### Comparing `callisto-jupyter-d1-0.0.7/jupyter_d1/tests/utils.py` & `callisto-jupyter-d1-0.0.9/jupyter_d1/tests/utils.py`

 * *Files 10% similar despite different names*

```diff
@@ -1,34 +1,33 @@
 import asyncio
 import json
 import os
 import pathlib
 from asyncio.exceptions import TimeoutError
 from datetime import timedelta
-from typing import Any, Dict, List
+from typing import Any, Dict, List, Optional
 
 from fastapi import WebSocket
 from fastapi.encoders import jsonable_encoder
-from fastapi.testclient import TestClient
+from .D1TestClient import TestClient
 
 from jupyter_d1 import security
 from jupyter_d1.models.permission import Permission
 from jupyter_d1.settings import settings
 
 WEBSOCKET_RECEIVE_TIMEOUT = float(
     os.environ.get("TEST_WEBSOCKET_RECEIVE_TIMEOUT", 4.0)
 )
-msg_id_lengths = list(range(40, 44))
+msg_id_lengths = list(range(39, 44))
 # Another directory to use during testing, cleared by a test fixture after
 # every test
-workdir_1 = str(pathlib.Path("/tmp/test_nb_2").resolve())
 
 
-def get_superuser_token_headers(client: TestClient) -> Dict[str, str]:
-    r = client.get(
+async def get_superuser_token_headers(client: TestClient) -> Dict[str, str]:
+    r = await client.get(
         "/login/access-token", headers={"Authorization": "test9token_4"}
     )
     tokens = r.json()["token"]
     a_token = tokens["access_token"]
     headers = {"Authorization": f"Bearer {a_token}"}
     return headers
 
@@ -117,40 +116,66 @@
         for msg_type in msg_types:
             if msg_type in keys:
                 return data
         assert count < max_retries, "Too many retries in receive_json"
         count += 1
 
 
+async def receive_next_json(
+    websocket: WebSocket,
+    timeout: float = WEBSOCKET_RECEIVE_TIMEOUT,
+    msg_types: List[str] = [],
+) -> Dict[str, Any]:
+    """
+    Get the next json msg from the websocket, raise an error if its type
+    is not in msg_types
+    """
+    return await receive_json(
+        websocket, timeout, msg_types=msg_types, max_retries=0
+    )
+
+
 async def wait_for_event(
     websocket: WebSocket,
     event_type: str,
     tries: int = 15,
     timeout: float = WEBSOCKET_RECEIVE_TIMEOUT,
 ) -> Dict[str, Any]:
 
     return await receive_json(
         websocket, timeout=timeout, msg_types=[event_type], max_retries=tries
     )
 
 
+async def clear_websocket_queue(websocket, wait_for=WEBSOCKET_RECEIVE_TIMEOUT):
+    while True:
+        try:
+            await asyncio.wait_for(websocket.receive_json(), wait_for)
+        except Exception:
+            break
+
+
 async def collect_websocket_messages(
-    websocket: WebSocket, timeout: float = WEBSOCKET_RECEIVE_TIMEOUT
+    websocket: WebSocket,
+    timeout: float = WEBSOCKET_RECEIVE_TIMEOUT,
+    limit: Optional[int] = None,
 ) -> List[Dict[str, Any]]:
     """
     Start listening to the websocket and collect all messages until the
     timeout is exceeded waiting on the next message.  Return all received
     messages.
     """
 
     msgs = []
     try:
         while True:
             msg = await receive_json(websocket, timeout)
             msgs.append(msg)
+            if limit is not None and len(msgs) >= limit:
+                break
     except TimeoutError:
         pass
 
     return msgs
 
 
 def filter_websocket_collection(
@@ -171,7 +196,14 @@
     # cell id's change (introduced in jupyter notebook spec 4.5?), so
     # compare cells but ignore id
     ignore_keys = ["id"]
     for key in cell.keys():
         if key in ignore_keys:
             continue
         assert cell[key] == expected[key]
+
+
+def resolve(str_path: str) -> str:
+    """
+    For the given path, return a path with the symlinks resolved
+    """
+    return str(pathlib.Path(str_path).resolve())
```

### Comparing `callisto-jupyter-d1-0.0.7/jupyter_d1/undo_manager/undo_manager.py` & `callisto-jupyter-d1-0.0.9/jupyter_d1/undo_manager/undo_manager.py`

 * *Files identical despite different names*

### Comparing `callisto-jupyter-d1-0.0.7/jupyter_d1/utils.py` & `callisto-jupyter-d1-0.0.9/jupyter_d1/utils.py`

 * *Files 5% similar despite different names*

```diff
@@ -7,14 +7,18 @@
 from fastapi.logger import logger
 from websockets.exceptions import ConnectionClosedError
 
 from .signals import APP_SHUTDOWN
 
 NotebookNode = nbformat.notebooknode.NotebookNode
 
+# The Connection object could really be any object, WebSocket is convenient at
+# the moment, could add more with typing.Union
+Connection = WebSocket
+
 
 def add_to_node_metadata(node: NotebookNode, **kwargs):
     if node.metadata.hasattr("jupyter_d1") is False:
         node.metadata.jupyter_d1 = {}
     node.metadata.jupyter_d1.update(kwargs)
```

### Comparing `callisto-jupyter-d1-0.0.7/setup.py` & `callisto-jupyter-d1-0.0.9/setup.py`

 * *Files 23% similar despite different names*

```diff
@@ -1,15 +1,21 @@
+from distutils.util import convert_path
 import setuptools
 
+main_ns = {}
+ver_path = convert_path('jupyter_d1/version.py')
+with open(ver_path) as ver_file:
+    exec(ver_file.read(), main_ns)
+
 with open("README.md", "r") as fh:
     long_description = fh.read()
 
 setuptools.setup(
     name="callisto-jupyter-d1",
-    version="0.0.7",
+    version=main_ns.get('version', '0.0.1'),
     author="Oak City Labs",
     author_email="team@oakcity.io",
     description="Jupyter D1 Server for Callisto",
     long_description=long_description,
     long_description_content_type="text/markdown",
     url="https://callistoapp.com",
     packages=setuptools.find_packages(),
@@ -19,27 +25,29 @@
         "Operating System :: OS Independent",
     ],
     python_requires=">=3.6",
     install_requires=[
         "wsgidav>=4.0.1,<5",
         "fastapi>=0.52.0,<1",
         "asyncblink>=0.3.2,<1",
-        "uvicorn[standard]>=0.11.3,<1",
+        "uvicorn>=0.11.3,<1",
+        "websockets>=10.0",
+        "httptools>=0.4.0",
         "python-dotenv>=0.13.0,<1",
         "nbformat>=5.0.4,<6",
         "python-jose>=3.1.0,<4",
         "jupyter>=1.0.0,<2",
         "jupyter_client>=7,<8",
         "jupyter_console>=6.1.0,<7",
         "jupyter_core>=4.6.3,<5",
         "jupyter_kernel_gateway>=2.4.0,<3",
         "zsh-jupyter-kernel>=3.2",
         "bash_kernel>=0.7.2",
         "pynvml>=8.0.4,<9",
-        "callisto-python>=0.0.2,<1",
+        "callisto-python>=0.0.4,<1",
         "jupytext>=1.13.8,<2",
         "python-multipart>=0.0.5,<1",
     ],
     extras_require={
         "full": ["psutil>=5.7.2,<6"],
         "watchdog": ["callisto-watchdog>=0.0.1,<1"],
     },
```

### Comparing `callisto-jupyter-d1-0.0.7/start_jupyter_d1` & `callisto-jupyter-d1-0.0.9/start_jupyter_d1`

 * *Files 7% similar despite different names*

```diff
@@ -1,15 +1,20 @@
 #!/usr/bin/env python
-
+import asyncio
 import argparse
 import os
 import sys
 
 import uvicorn  # type: ignore
 from uvicorn.config import LOGGING_CONFIG  # type: ignore
+import nest_asyncio
+try:
+    nest_asyncio.apply()
+except Exception:
+    pass
 
 
 def get_args(args):
     desc = "Start Jupyter D1 server"
 
     parser = argparse.ArgumentParser(description=desc)
     parser.add_argument(
@@ -49,23 +54,29 @@
         required=False,
         default="info",
         help="Log level -- debug/info/warning/error/critical",
     )
     return parser.parse_args(args)
 
 
-def main(args):
+async def main(args):
+    # Fixes the error mentioned in this thread
+    # https://github.com/jupyter/notebook/issues/6164
+    # Patch the loop at the earliest opportunity
+    nest_asyncio.apply()
+
     args = get_args(args)
-    os.environ["CALLISTO_ENV"] = "local"
+    if "CALLISTO_ENV" not in os.environ:
+        os.environ["CALLISTO_ENV"] = "local"
     os.environ["CALLISTO_OAUTH_TOKEN_URL"] = "/login/access-token"
     if args.secret_token is not None:
         os.environ["CALLISTO_LOGIN_TOKEN"] = args.secret_token
     if args.root_dir is not None:
         os.environ["CALLISTO_ROOT_DIR"] = args.root_dir
-    log_config = None
+    log_config = LOGGING_CONFIG
     if args.log_file is not None:
         log_config = LOGGING_CONFIG
         log_config["handlers"] = {
             "default": {
                 "formatter": "default",
                 "class": "logging.FileHandler",
                 "filename": args.log_file,
@@ -75,19 +86,17 @@
                 "class": "logging.FileHandler",
                 "filename": args.log_file,
             },
         }
     protocol = "http"
     host = "127.0.0.1"
     print(f"Jupyter D1 running at {protocol}://{host}:{args.port}")
-    uvicorn.run(
-        "jupyter_d1:app",
-        host=host,
-        port=args.port,
-        log_level=args.log_level,
-        log_config=log_config,
-        loop="asyncio",
-    )
+
+    config = uvicorn.Config("jupyter_d1:app", host=host, port=args.port, log_level=args.log_level, log_config=log_config, loop="asyncio")
+    server = uvicorn.Server(config)
+    await server.serve()
+
     return 0
 
+
 if __name__ == "__main__":
-    sys.exit(main(sys.argv[1:]))
+    sys.exit(asyncio.run(main(sys.argv[1:])))
```

